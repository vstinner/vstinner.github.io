<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Python 3.6 now uses UTF-8 on Windows â€” Victor Stinner blog 3</title>
	<meta name="description" content="Title: Python 3.6 now uses UTF-8 on Windows; Date: 2018-03-22; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">Python 3.6 now uses UTF-8 on Windows</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2018-03-22T17:00:00+01:00" itemprop="datePublished">Thu 22 March 2018</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/python.html" rel="category">python</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/cpython.html" rel="tag">cpython</a>
		</span>
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/unicode.html" rel="tag">unicode</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>September 2016, a few days before the CPython core dev sprint, <strong>Steve Dower</strong>
proposed two major backward incompatible changes for Python 3.6 on Windows:
<a class="reference external" href="https://www.python.org/dev/peps/pep-0528/">PEP 528: Change Windows console encoding to UTF-8</a> and <a class="reference external" href="https://www.python.org/dev/peps/pep-0529/">PEP 529: Change Windows
filesystem encoding to UTF-8</a>.
At the first read, I was sure that the PEP 529 will break all applications on
Windows. This article tells the story behind the PEPs approval.</p>
<p><strong>This article is the fourth in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:</strong></p>
<ul class="simple">
<li><ol class="first arabic">
<li><a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html">Python 3.0 listdir() Bug on Undecodable Filenames</a></li>
</ol>
</li>
<li><ol class="first arabic" start="2">
<li><a class="reference external" href="https://vstinner.github.io/pep-383.html">Python 3.1 surrogateescape error handler (PEP 383)</a></li>
</ol>
</li>
<li><ol class="first arabic" start="3">
<li><a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html">Python 3.2 Painful History of the Filesystem Encoding</a></li>
</ol>
</li>
<li><ol class="first arabic" start="4">
<li><a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html">Python 3.6 now uses UTF-8 on Windows</a></li>
</ol>
</li>
<li><ol class="first arabic" start="5">
<li><a class="reference external" href="https://vstinner.github.io/posix-locale.html">Python 3.7 and the POSIX locale</a></li>
</ol>
</li>
<li><ol class="first arabic" start="6">
<li><a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html">Python 3.7 UTF-8 Mode</a></li>
</ol>
</li>
</ul>
<div class="section" id="pep-529">
<h2>PEP 529</h2>
<p>September 2016, <strong>Steve Dower</strong>, who works for Microsoft, wrote the <a class="reference external" href="https://www.python.org/dev/peps/pep-0529/">PEP 529:
Change Windows filesystem encoding to UTF-8</a> and <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-September/146051.html">posted it to python-dev</a> for
comments.</p>
<a class="reference external image-reference" href="http://stevedower.id.au/blog/"><img alt="Steve Dower" src="https://vstinner.github.io/images/steve_dower.jpg" /></a>
<p>Abstract:</p>
<blockquote>
<p><strong>Historically, Python uses the ANSI APIs</strong> for interacting with the
Windows operating system, often via C Runtime functions. However, these
have been long discouraged in favor of the UTF-16 APIs. Within the
operating system, all text is represented as UTF-16, and the ANSI APIs
perform encoding and decoding using the active code page. See Naming Files,
Paths, and Namespaces for more details.</p>
<p>This PEP proposes <strong>changing the default filesystem encoding on Windows to
utf-8</strong>, and changing all filesystem functions to use the Unicode APIs for
filesystem paths. This will not affect code that uses strings to represent
paths, however those that use bytes for paths will now be able to correctly
round-trip all valid paths in Windows filesystems. <strong>Currently, the
conversions between Unicode (in the OS) and bytes (in Python) were lossy</strong>
and would fail to round-trip characters outside of the user's active code
page.</p>
<p>Notably, this does not impact the encoding of the contents of files. These
will continue to default to <tt class="docutils literal">locale.getpreferredencoding()</tt> (for text
files) or plain bytes (for binary files). This only affects the encoding
used when users pass a bytes object to Python where it is then passed to
the operating system as a path name.</p>
</blockquote>
</div>
<div class="section" id="my-analysis">
<h2>My analysis</h2>
<p>Here is my analysis on the rationale for the PEP 529 change.</p>
<p><strong>On Unix, the native type for filenames is bytes</strong>. A filename is seen by the
Linux kernel as an opaque object. The ext4 filesystem stores filenames as
bytes. If a Python 2 application uses Unicode for filenames, filesystem
operations can fail with a Unicode error (encoding or decoding error) depending
on the locale encoding. If the locale encoding is ASCII, Unicode errors are
likely to occur at the first non-ASCII filename. For example, Mercurial handles
filenames as bytes.</p>
<p>On Python 3, handling filenames as Unicode works thanks to the
<tt class="docutils literal">surrogateescape</tt> error handler. <strong>Most Python 2 applications ported to
Python 3 keep their Python 2 support, and so still handle filenames bytes.</strong></p>
<p>Problems arise when such software is used on Windows.</p>
<p><strong>On Windows, the native type for filenames is Unicode</strong>. Many functions come
in two flavors: &quot;ANSI&quot; (bytes) and &quot;Wide&quot; (Unicode) versions. In my opinion,
the ANSI flavor mostly exists for backward compatibility. In Python 3.5,
passing a filename as bytes uses the ANSI flavor, whereas the Wide flavor is
used for Unicode filenames. The ANSI flavor uses the ANSI code page which is
very limited compared to Unicode, usually only 256 code points or less. Some
filenames not encodable to the ANSI code page simply cannot be opened, renamed,
etc. using the ANSI API.</p>
<p>The other issue is that <strong>some developers only develop on Unix</strong> (ex: Linux or
macOS) <strong>and never test their application on Windows</strong>.</p>
<p>For a better rationale, read the <a class="reference external" href="https://www.python.org/dev/peps/pep-0529/#background">Background section</a> of Steve Dower's PEP
:-)</p>
</div>
<div class="section" id="discussion-at-the-cpython-sprint-and-guido-s-approval">
<h2>Discussion at the CPython sprint and Guido's approval</h2>
<p>Honestly, <strong>at the first read, I was sure that the PEP 529 will break all
applications on Windows</strong>.</p>
<p>Hopefully, thanks to the PSF and Instagram, I was able to attend my first
CPython sprint at Instagram headquarters: <a class="reference external" href="https://vstinner.github.io/cpython-sprint-2016.html">CPython sprint, september 2016</a>. I discussed there with <strong>Steve who
reassured me and explained me his PEP</strong>. Later, we talked with <strong>Guido van
Rossum</strong>.</p>
<p>Even if I liked the idea of using UTF-8, I was still not fully confident that the
change will not break the world. <strong>We agreed to try the change during Python
3.6 beta phase</strong>, but revert it if something bad happens.</p>
<a class="reference external image-reference" href="http://blog.python.org/2016/09/python-core-development-sprint-2016-36.html"><img alt="CPython developers at the Facebook sprint" src="https://vstinner.github.io/images/cpython_sprint_2016_photo.jpg" /></a>
<p>Following this talk, <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-September/146277.html">Guido accepted the PEP under conditions</a></p>
<blockquote>
<p>I'm hijacking this thread to <strong>provisionally accept PEP 529</strong>. (I'll also
do this for PEP 528, in its own thread.)</p>
<p><strong>I've talked things over with Steve and Victor and we're going to do an
experiment</strong> (as <a class="reference external" href="https://www.python.org/dev/peps/pep-0529/#beta-experiment">now written up in the PEP</a>) to tease out
any issues with this change during the beta. <strong>If serious problems crop up
we may have to roll back the changes and reject the PEP</strong> -- we won't get
another chance at getting this right. (That would also mean that using the
binary filesystem APIs will remain deprecated and will eventually be
disallowed; as long as the PEP remains accepted they are undeprecated.)</p>
<p>Congrats Steve! Thanks for the massive amount of work on the
implementation and the thinking that went into the design. Thanks
everyone else for their feedback.</p>
<p class="attribution">&mdash;Guido</p>
</blockquote>
<p><strong>I was honoured that Guido listened to my Unicode experience</strong> to take a
decision on the PEP ;-)</p>
<p>Steve chose the right timing to get his PEP accepted. Thanks to the sprint
which helped to quickly discussed such backward incompatible change, <strong>the PEP
has been approved in just 12 days</strong>! For comparison, some of my PEPs like my
<a class="reference external" href="https://www.python.org/dev/peps/pep-0446/">PEP 446: Make newly created file descriptors non-inheritable</a> (another backward incompatible
change) took 8 months to get accepted.</p>
</div>
<div class="section" id="pep-528-windows-console">
<h2>PEP 528: Windows console</h2>
<p>Just before the PEP 529, Steve Dower also wrote <a class="reference external" href="https://www.python.org/dev/peps/pep-0528/">PEP 528: Change Windows
console encoding to UTF-8</a>.  This
change only impacts the Windows console, so there is a lower risk of breaking
the world.</p>
<p>This PEP was also <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-September/146278.html">quickly approved by Guido</a>
during the CPython sprint.  Steve implemented it in Python 3.6.</p>
<p>Even if it's smaller change, it is <strong>yet another change towards using UTF-8
everywhere</strong>.</p>
</div>
<div class="section" id="great-success">
<h2>Great success!</h2>
<p>Hopefully, I was wrong about the risk of breaking the world. <strong>No user
complained about these two backward incompatible changes: Python 3.6 on Windows
is a success!</strong></p>
<p>Python 3.6 now has a <strong>better Unicode support</strong> on Windows thanks to the PEP
528 and PEP 529!</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>September 2016: Steve Dower proposed two major backward incompatible changes
for Python 3.6 on Windows: <a class="reference external" href="https://www.python.org/dev/peps/pep-0528/">PEP 528: Change Windows console encoding to UTF-8</a> and <a class="reference external" href="https://www.python.org/dev/peps/pep-0529/">PEP 529: Change Windows
filesystem encoding to UTF-8</a>.</p>
<p>At the first read, I was sure that the PEP 529 (filesystem encoding) will break
all applications on Windows.</p>
<p>Thanks to the CPython core dev sprint, I was able to discuss with Steve who
reassured me and explained me his PEP 529. We agreed with Guido van Rossum to
try the change during Python 3.6 beta phase, but revert it if something bad
happens. I was honoured that Guido listened to my Unicode experience to take a
decision on the PEP.</p>
<p>The <a class="reference external" href="https://www.python.org/dev/peps/pep-0528/">PEP 528: Change Windows console encoding to UTF-8</a> was also quickly approved,
another change towards using UTF-8 everywhere.</p>
<p>No user complained about these two backward incompatible changes: Python 3.6 on
Windows is a success!</p>
<p>Python 3.6 now has a better Unicode support thanks on Windows to the PEP 528
and PEP 529!</p>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (20)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>
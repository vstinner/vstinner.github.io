<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Debug Hybrid Graphics issues on Linux â€” Victor Stinner blog 3</title>
	<meta name="description" content="Title: Debug Hybrid Graphics issues on Linux; Date: 2019-09-11; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">Debug Hybrid Graphics issues on Linux</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2019-09-11T15:50:00+02:00" itemprop="datePublished">Wed 11 September 2019</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/linux.html" rel="category">linux</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/linux.html" rel="tag">linux</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p><a class="reference external" href="https://wiki.archlinux.org/index.php/Hybrid_graphics">Hybrid Graphics</a> is a
complex hardware and software solution to achieve longer laptop battery life:
an <strong>integrated</strong> graphics device is used by default, and a <strong>discrete</strong>
graphics device with higher graphics performances is enabled on demand.</p>
<a class="reference external image-reference" href="https://www.theregister.co.uk/2010/02/09/inside_nvidia_optimus/"><img alt="Hybrid Graphics" src="https://vstinner.github.io/images/hybrid_graphics.jpg" /></a>
<p>If it is designed and implemented carefully, users should not notice that a
laptop has two graphical devices.</p>
<p>Sadly, the Linux implementation is not perfect yet. I had to debug different
graphics issues on GNOME last months, so I decided to write down an article
about this technology.</p>
<p>This article is about the <strong>GNOME</strong> desktop environment with <strong>Wayland</strong>
running on <strong>Fedora</strong> 30, with Linux kernel <strong>vgaswitcheroo</strong> in muxless mode
(more about that above).</p>
<div class="section" id="hybrid-graphics-1">
<h2>Hybrid Graphics</h2>
<p>Hybrid Graphics are known under different names:</p>
<ul class="simple">
<li>Linux kernel <a class="reference external" href="https://www.kernel.org/doc/html/latest/gpu/vga-switcheroo.html">vgaswitcheroo</a></li>
<li><a class="reference external" href="https://wiki.archlinux.org/index.php/PRIME">PRIME</a> in Linux open source
GPU drivers (nouveau, ati, amdgpu and intel), the &quot;muxless&quot; flavor of hybrid graphics</li>
<li><a class="reference external" href="https://wiki.archlinux.org/index.php/bumblebee">Bumblebee</a>:
<a class="reference external" href="https://wiki.archlinux.org/index.php/NVIDIA_Optimus">NVIDIA Optimus</a>
for Linux</li>
<li>&quot;AMD Dynamic Switchable Graphics&quot; for Radeon</li>
<li>&quot;Dual GPUs&quot;</li>
<li>etc.</li>
</ul>
<p>Nowadays, most manufacturers utilizes the <strong>muxless</strong> model:</p>
<blockquote>
Dual GPUs but <strong>only one of them is connected to outputs</strong>. The other one
is merely used to <strong>offload rendering</strong>, its results are copied over PCIe
into the framebuffer. On Linux this is supported with DRI PRIME.</blockquote>
<p>In 2010, the first generation hybrid model used the <strong>muxed</strong> model:</p>
<blockquote>
Dual GPUs with a hardware multiplexer chip to switch outputs between GPUs.
This model makes the user choose (at boot time or at login time) between
the two power/graphics profiles and is almost fixed throughout the user
session.</blockquote>
<p>Note: The development to support hybrid graphics in Linux started in 2010.</p>
</div>
<div class="section" id="does-my-linux-have-hybrid-graphics">
<h2>Does my Linux have Hybrid Graphics?</h2>
<p>On Linux, Hybrid Graphics is used if the <tt class="docutils literal">/sys/kernel/debug/vgaswitcheroo/</tt>
directory exists.</p>
<p>No Hybrid Graphics, single graphics device:</p>
<pre class="literal-block">
$ sudo cat /sys/kernel/debug/vgaswitcheroo/switch
cat: /sys/kernel/debug/vgaswitcheroo/switch: No such file or directory
</pre>
<p>Hybrid Graphics with two graphics devices:</p>
<pre class="literal-block">
$ sudo cat /sys/kernel/debug/vgaswitcheroo/switch
0:IGD:+:Pwr:0000:00:02.0
1:DIS: :DynOff:0000:01:00.0
</pre>
<p>Command to list graphics devices:</p>
<pre class="literal-block">
$ lspci|grep VGA
00:02.0 VGA compatible controller: Intel Corporation HD Graphics 530 (rev 06)
01:00.0 VGA compatible controller: NVIDIA Corporation GM107GLM [Quadro M1000M] (rev a2)
</pre>
</div>
<div class="section" id="hardware">
<h2>Hardware</h2>
<p>My employer gave me a Lenovo P50 laptop to work in December 2017. It is my only
computer at home, so I needed a powerful laptop (even if it's heavy for
traveling to conferences). The CPU, RAM and battery are great, but the hybrid
graphics caused me some headaches.</p>
<p>My Lenovo P50 has two GPUs:</p>
<pre class="literal-block">
$ lspci|grep VGA
00:02.0 VGA compatible controller: Intel Corporation HD Graphics 530 (rev 06)
01:00.0 VGA compatible controller: NVIDIA Corporation GM107GLM [Quadro M1000M] (rev a2)
</pre>
<ul class="simple">
<li>The <strong>Integrated Graphics Device</strong> is a <strong>Intel</strong> IGP (Intel HD Graphics 530)</li>
<li>The <strong>Discrete Graphics Device</strong> is a <strong>NVIDIA</strong> GPU (NVIDIA Quadro M1000M)</li>
</ul>
<p>I didn't know that that the laptop had two graphics device when I chose the
laptop model. I discovered hybrid graphics when I started to debug graphics
issues.</p>
</div>
<div class="section" id="bios">
<h2>BIOS</h2>
<p>Hybrid graphics can be configured in the BIOS:</p>
<ul class="simple">
<li><strong>Discrete Graphics mode</strong> will achieve higher graphics performances.</li>
<li><strong>Hybrid Graphics mode</strong> (default) runs as Integrated Graphics mode to
achieve longer battery life, and Discrete Graphics is enabled on demand.</li>
</ul>
<p>On my Lenovo P50, using the <strong>Discrete Graphics mode</strong> removes &quot;00:02.0 VGA
compatible controller: Intel Corporation HD Graphics 530&quot; from <tt class="docutils literal">lspci</tt>
command output: the <strong>Intel IGP is fully disabled</strong>. The Linux kernel only
sees the NVIDIA GPU.</p>
</div>
<div class="section" id="linux-kernel">
<h2>Linux kernel</h2>
<p>On Linux, hybrid graphics is handled by <strong>vgaswitcheroo</strong>:</p>
<pre class="literal-block">
$ sudo cat /sys/kernel/debug/vgaswitcheroo/switch
0:IGD:+:Pwr:0000:00:02.0
1:DIS: :DynPwr:0000:01:00.0
</pre>
<ul class="simple">
<li><tt class="docutils literal">IGD</tt> stands for <strong>Integrated</strong> Graphics Device</li>
<li><tt class="docutils literal">DIS</tt> stands for <strong>DIScrete</strong> Graphics Device</li>
<li>&quot;+&quot; marks the <strong>active</strong> card</li>
<li><tt class="docutils literal">Pwr</tt>: the graphics device is <strong>always active</strong></li>
<li><tt class="docutils literal">DynPwr</tt>: the graphics device is actived <strong>on demand</strong></li>
</ul>
<p>The last field (ex: <tt class="docutils literal">0000:00:02.0</tt>) is based on the PCI identifier:</p>
<pre class="literal-block">
$ lspci|grep VGA
00:02.0 VGA compatible controller: Intel Corporation HD Graphics 530 (rev 06)
01:00.0 VGA compatible controller: NVIDIA Corporation GM107GLM [Quadro M1000M] (rev a2)
</pre>
<p>On my laptop, hybrid graphics is detected by an <a class="reference external" href="https://en.wikipedia.org/wiki/Advanced_Configuration_and_Power_Interface">ACPI</a>
&quot;Device-Specific Method&quot; (DSM):</p>
<pre class="literal-block">
$ journalctl -b -k|grep 'VGA switcheroo'
Sep 11 02:29:54 apu kernel: VGA switcheroo: detected Optimus DSM method \_SB_.PCI0.PEG0.PEGP handle
</pre>
<p>See: <a class="reference external" href="https://www.kernel.org/doc/html/latest/gpu/vga-switcheroo.html">VGA Switcheroo (Linux kernel documentation)</a>.</p>
</div>
<div class="section" id="opengl">
<h2>OpenGL</h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Mesa_(computer_graphics)">Mesa</a> provides
<tt class="docutils literal">glxinfo</tt> utility to get information about the OpenGL driver currently used:</p>
<pre class="literal-block">
$ glxinfo|grep -E 'Device|direct rendering'
direct rendering: Yes
    Device: Mesa DRI Intel(R) HD Graphics 530 (Skylake GT2)  (0x191b)
</pre>
<p>On this example, the discrete Intel IGP is used.</p>
<p>In Firefox, go to <strong>about:support</strong> page and search for the <tt class="docutils literal">Graphics</tt>
section to get information about compositing, WebGL, GPU, etc.</p>
</div>
<div class="section" id="dri-prime-environment-variable">
<h2>DRI_PRIME environment variable</h2>
<p>Set DRI_PRIME=1 environment variable to run an application with the
<strong>discrete</strong> GPU.</p>
<p>Example:</p>
<pre class="literal-block">
$ DRI_PRIME=1 glxinfo|grep -E 'Device|rendering'
direct rendering: Yes
    Device: NV117 (0x13b1)
</pre>
</div>
<div class="section" id="switcheroo-control">
<h2>switcheroo-control</h2>
<p><a class="reference external" href="https://github.com/hadess/switcheroo-control">switcheroo-control</a> is a
deamon controlling <tt class="docutils literal">/sys/kernel/debug/vgaswitcheroo/switch</tt> (Linux kernel).
It can be accessed by DBus.</p>
<p>When the daemon starts, it looks for <tt class="docutils literal">xdg.force_integrated=VALUE</tt> parameter
in the Linux command line. If <em>VALUE</em> is <tt class="docutils literal">1</tt>, <tt class="docutils literal">true</tt> or <tt class="docutils literal">on</tt>, or if
<tt class="docutils literal">xdg.force_integrated=VALUE</tt> is not found in the command line, the daemon
writes <tt class="docutils literal">DIGD</tt> into <tt class="docutils literal">/sys/kernel/debug/vgaswitcheroo/switch</tt> (delayed
<strong>switch to the integrated graphics device</strong>: my Intel IGP)</p>
<p>If <tt class="docutils literal">xdg.force_integrated=0</tt> is found in the command line, the daemon leaves
<tt class="docutils literal">/sys/kernel/debug/vgaswitcheroo/switch</tt> unchanged.</p>
<p>systemd:</p>
<ul class="simple">
<li>Check if the service is running: <tt class="docutils literal">sudo systemctl status <span class="pre">switcheroo-control.service</span></tt></li>
<li>Disable the service: <tt class="docutils literal">sudo systemctl disable <span class="pre">switcheroo-control.service</span></tt>
and <tt class="docutils literal">sudo systemctl stop <span class="pre">switcheroo-control.service</span></tt></li>
</ul>
<p>On Fedora, switcheroo-control is installed by default.</p>
<p>It is unclear to me if this daemon is still useful for my setup. It seems like
the the Linux kernel switcheroo uses the integrated Intel IGP by default
anyway.</p>
</div>
<div class="section" id="disable-the-discrete-gpu-by-blacklisting-its-driver">
<h2>Disable the discrete GPU by blacklisting its driver</h2>
<p>To debug graphical bugs, I wanted to ensure that the discrete NVIDIA GPU is
never used.</p>
<p>I found the solution of fully disabling the nouveau driver in the Linux kernel:
add <tt class="docutils literal">modprobe.blacklist=nouveau</tt> to the Linux kernel command line. On Fedora,
you can use:</p>
<pre class="literal-block">
sudo grubby --update-kernel=ALL --args=&quot;modprobe.blacklist=nouveau&quot;
</pre>
<p>To reenable nouveau, remove the parameter. On Fedora:</p>
<pre class="literal-block">
sudo grubby --update-kernel=ALL --remove-args=&quot;modprobe.blacklist=nouveau&quot;
</pre>
</div>
<div class="section" id="demo">
<h2>Demo!</h2>
<p>For this test, my laptop is not connected to anything (no power cable, no
external monitor, no dock).</p>
<p>When my laptop is idle (no 3D application is running), the NVIDIA GPU is
<strong>suspended</strong>:</p>
<pre class="literal-block">
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/enable
0
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/power/runtime_status
suspended
</pre>
<p>I explicitly run a 3D application on it:</p>
<pre class="literal-block">
DRI_PRIME=1 glxgears
</pre>
<p>The NVIDIA GPU becomes <strong>active</strong>:</p>
<pre class="literal-block">
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/enable
2
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/power/runtime_status
active
</pre>
<p>I stop the 3D application. A few seconds later, the NVIDIA GPU is <strong>suspended</strong>
again:</p>
<pre class="literal-block">
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/enable
0
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/power/runtime_status
suspended
</pre>
</div>
<div class="section" id="graphics-devices-and-monitors">
<h2>Graphics devices and monitors</h2>
<p>When I disabled the nouveau driver using <tt class="docutils literal">modprobe.blacklist=nouveau</tt> kernel
command line parameter, I was no longer able to use external monitors. I
understood that:</p>
<ul class="simple">
<li>The <strong>Intel</strong> IGP is connected to the <strong>internal</strong> laptop screen</li>
<li>The <strong>NVIDIA</strong> GPU is connected to the <strong>external</strong> monitors (DisplayPort
and HDMI ports)</li>
</ul>
<p>When my laptop has <strong>no external monitor</strong> connected, the <strong>discrete</strong> NVIDIA
GPU is <strong>actived on demand</strong> (suspended when idle)</p>
<p>When I connect my laptop to <strong>two external monitors</strong> (using my dock), the
<strong>discrete</strong> NVIDIA GPU is <strong>always active</strong>:</p>
<pre class="literal-block">
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/power/runtime_status
active
</pre>
</div>
<div class="section" id="links">
<h2>Links</h2>
<ul class="simple">
<li><a class="reference external" href="https://wiki.archlinux.org/index.php/Hybrid_graphics">https://wiki.archlinux.org/index.php/Hybrid_graphics</a></li>
<li><a class="reference external" href="https://www.kernel.org/doc/html/latest/gpu/vga-switcheroo.html">https://www.kernel.org/doc/html/latest/gpu/vga-switcheroo.html</a></li>
<li><a class="reference external" href="https://wiki.archlinux.org/index.php/PRIME">https://wiki.archlinux.org/index.php/PRIME</a></li>
<li><a class="reference external" href="https://help.ubuntu.com/community/HybridGraphics">https://help.ubuntu.com/community/HybridGraphics</a></li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Nvidia_Optimus">https://en.wikipedia.org/wiki/Nvidia_Optimus</a></li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/AMD_Hybrid_Graphics">https://en.wikipedia.org/wiki/AMD_Hybrid_Graphics</a></li>
<li><a class="reference external" href="https://nouveau.freedesktop.org/wiki/Optimus">https://nouveau.freedesktop.org/wiki/Optimus</a></li>
</ul>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (23)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>
<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Victor Stinner blog 3</title><link href="https://vstinner.github.io/" rel="alternate"></link><link href="https://vstinner.github.io/feeds/all.atom.xml" rel="self"></link><id>https://vstinner.github.io/</id><updated>2021-03-26T12:00:00+01:00</updated><entry><title>Make structures opaque in the Python C API</title><link href="https://vstinner.github.io/c-api-opaque-structures.html" rel="alternate"></link><published>2021-03-26T12:00:00+01:00</published><updated>2021-03-26T12:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2021-03-26:/c-api-opaque-structures.html</id><summary type="html">&lt;p&gt;This article is about changes that I made, with the help other developers, in
the Python C API in Python 3.8, 3.9 and 3.10 to avoid accessing structures
members: prepare the C API to &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Opaque_data_type"&gt;make structures opaque&lt;/a&gt;. These changes are related
to my &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0620/"&gt;PEP 620 &amp;quot;Hide implementation …&lt;/a&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;This article is about changes that I made, with the help other developers, in
the Python C API in Python 3.8, 3.9 and 3.10 to avoid accessing structures
members: prepare the C API to &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Opaque_data_type"&gt;make structures opaque&lt;/a&gt;. These changes are related
to my &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0620/"&gt;PEP 620 &amp;quot;Hide implementation details from the C API&amp;quot;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;One change had &lt;strong&gt;negative impact on performance&lt;/strong&gt; and had to be
reverted. Making Python slower just to make structures opaque would first
require to get the PEP 620 accepted.&lt;/p&gt;
&lt;p&gt;While compatible changes merged in Python 3.8 and Python 3.9 went fine, one
Python 3.10 &lt;strong&gt;incompatible change caused more troubles&lt;/strong&gt; and had to be
reverted.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://fr.wikipedia.org/wiki/Incendie_du_centre_de_donn%C3%A9es_d%27OVHcloud_%C3%A0_Strasbourg"&gt;&lt;img alt="OVHcloud datacenter fire in Strasbourg" src="https://vstinner.github.io/images/incendie-ovh.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Photo: OVHcloud data center fire in Strasbourg.&lt;/p&gt;
&lt;div class="section" id="rationale"&gt;
&lt;h2&gt;Rationale&lt;/h2&gt;
&lt;p&gt;The C API currently exposes most object structures, C extensions indirectly
access structures members through the API, but can also access them directly.
It causes different issues:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Modifying a structure can break an unknown number of C extensions. To prevent
any risk, CPython core developers avoid modifying structures. Once most
structures will be opaque, it will be possible to experiment &lt;strong&gt;optimizations&lt;/strong&gt;
which require deep structures changes without breaking C extensions. The
irony is that we first have to break the backward compatibility and C
extensions for that.&lt;/li&gt;
&lt;li&gt;Any structure change breaks the ABI. The &lt;strong&gt;stable ABI&lt;/strong&gt; solved this issue by
not exposing structures into its limited C API. The idea is to bend the
default C API towards the limited C API to provide a stable ABI for everyone
in the long term.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="issues"&gt;
&lt;h2&gt;Issues&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue39573"&gt;PyObject: bpo-39573&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue40170"&gt;PyTypeObject: bpo-40170&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue39947"&gt;PyThreadState: bpo-39947&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue40421"&gt;PyFrameObject: bpo-40421&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="opaque-structures"&gt;
&lt;h2&gt;Opaque structures&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Python 3.8 made the PyInterpreterState structure opaque.&lt;/li&gt;
&lt;li&gt;Python 3.9 made the PyGC_Head structure opaque.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="add-getter-functions-to-python-3-9"&gt;
&lt;h2&gt;Add getter functions to Python 3.9&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;PyObject, PyVarObject:&lt;ul&gt;
&lt;li&gt;Py_SET_REFCNT()&lt;/li&gt;
&lt;li&gt;Py_SET_TYPE()&lt;/li&gt;
&lt;li&gt;Py_SET_SIZE()&lt;/li&gt;
&lt;li&gt;Py_IS_TYPE()&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;PyFrameObject:&lt;ul&gt;
&lt;li&gt;PyFrame_GetCode()&lt;/li&gt;
&lt;li&gt;PyFrame_GetBack()&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;PyThreadState:&lt;ul&gt;
&lt;li&gt;PyThreadState_GetInterpreter()&lt;/li&gt;
&lt;li&gt;PyThreadState_GetFrame()&lt;/li&gt;
&lt;li&gt;PyThreadState_GetID()&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;PyInterpreterState:&lt;ul&gt;
&lt;li&gt;PyInterpreterState_Get()&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;PyInterpreterState_Get() can be used to replace &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;PyThreadState_Get()-&amp;gt;interp&lt;/span&gt;&lt;/tt&gt;
and &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;PyThreadState_GetInterpreter(PyThreadState_Get())&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="convert-macros-to-static-inline-functions-in-python-3-8"&gt;
&lt;h2&gt;Convert macros to static inline functions in Python 3.8&lt;/h2&gt;
&lt;div class="section" id="macro-pitfalls"&gt;
&lt;h3&gt;Macro pitfalls&lt;/h3&gt;
&lt;p&gt;Macros are convenient but have &lt;a class="reference external" href="https://gcc.gnu.org/onlinedocs/cpp/Macro-Pitfalls.html"&gt;multiple pitfalls&lt;/a&gt;. Some macros
can be abused in surprising ways. For example, the following code is valid with
Python 3.9:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if (obj == NULL || PyList_SET_ITEM (l, i, obj) &amp;lt; 0) { ... }
&lt;/pre&gt;
&lt;p&gt;In Python 3.9, PyList_SET_ITEM() returns &lt;em&gt;obj&lt;/em&gt; in this case, &lt;em&gt;obj&lt;/em&gt; is a
pointer, and so the test checks if a pointer is negative which makes no sense
(but is accepted by C compilers by default). This code is likely a confusion
with PyList_SetItem() which returns a int, negative in case of an error.&lt;/p&gt;
&lt;p&gt;Zackery Spytz and me modified &lt;a class="reference external" href="https://github.com/python/cpython/commit/556d97f473fa538cef780f84bd29239ecf57d9c5"&gt;PyList_SET_ITEM()&lt;/a&gt;
and &lt;a class="reference external" href="https://github.com/python/cpython/commit/0ef96c2b2a291c9d2d9c0ba42bbc1900a21e65f3"&gt;PyCell_SET()&lt;/a&gt;
macros in Python 3.10 to return void.&lt;/p&gt;
&lt;p&gt;This change broke alsa-python: I proposed a &lt;a class="reference external" href="https://github.com/alsa-project/alsa-python/commit/5ea2f8709b4d091700750661231f8a3ddce0fc7c"&gt;fix which was merged&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;One nice side effect of converting macros to static inline functions is that
debuggers and profilers are able to retrieve the name of the function.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="converted-macros"&gt;
&lt;h3&gt;Converted macros&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Py_INCREF(), Py_XINCREF()&lt;/li&gt;
&lt;li&gt;Py_DECREF(), Py_XDECREF()&lt;/li&gt;
&lt;li&gt;PyObject_INIT(), PyObject_INIT_VAR()&lt;/li&gt;
&lt;li&gt;_PyObject_GC_TRACK(), _PyObject_GC_UNTRACK(), _Py_Dealloc()&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="performance"&gt;
&lt;h3&gt;Performance&lt;/h3&gt;
&lt;p&gt;Since &lt;tt class="docutils literal"&gt;Py_INCREF()&lt;/tt&gt; is criticial for general Python performance, the impact
of the change was analyzed in depth before &lt;a class="reference external" href="https://github.com/python/cpython/commit/2aaf0c12041bcaadd7f2cc5a54450eefd7a6ff12"&gt;being merged&lt;/a&gt;
in &lt;a class="reference external" href="https://bugs.python.org/issue35059"&gt;bpo-35059&lt;/a&gt;. The usage of
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;__attribute__((always_inline))&lt;/span&gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;__forceinline&lt;/tt&gt; to force inlining was
rejected.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="cast-to-pyobject"&gt;
&lt;h3&gt;Cast to PyObject*&lt;/h3&gt;
&lt;p&gt;Old Py_INCREF() implementation in Python 3.7:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#define Py_INCREF(op) (                   \
    _Py_INC_REFTOTAL  _Py_REF_DEBUG_COMMA \
    ((PyObject *)(op))-&amp;gt;ob_refcnt++)
&lt;/pre&gt;
&lt;p&gt;where &lt;tt class="docutils literal"&gt;_Py_INC_REFTOTAL _Py_REF_DEBUG_COMMA&lt;/tt&gt; becomes &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;_Py_RefTotal++,&lt;/span&gt;&lt;/tt&gt; if
the &lt;tt class="docutils literal"&gt;Py_REF_DEBUG&lt;/tt&gt; macro is defined, or nothing otherwise. Current
Py_INCREF() implementation in Python 3.10:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
static inline void _Py_INCREF(PyObject *op)
{
#ifdef Py_REF_DEBUG
    _Py_RefTotal++;
#endif
    op-&amp;gt;ob_refcnt++;
}
#define Py_INCREF(op) _Py_INCREF(_PyObject_CAST(op))
&lt;/pre&gt;
&lt;p&gt;Most static inline functions go through a macro to cast their argument to
&lt;tt class="docutils literal"&gt;PyObject*&lt;/tt&gt; using the macro:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#define _PyObject_CAST(op) ((PyObject*)(op))
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="convert-macros-to-regular-functions-in-python-3-9"&gt;
&lt;h2&gt;Convert macros to regular functions in Python 3.9&lt;/h2&gt;
&lt;div class="section" id="id1"&gt;
&lt;h3&gt;Converted macros&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;PyIndex_Check()&lt;/li&gt;
&lt;li&gt;PyObject_CheckBuffer()&lt;/li&gt;
&lt;li&gt;PyObject_GET_WEAKREFS_LISTPTR()&lt;/li&gt;
&lt;li&gt;PyObject_IS_GC()&lt;/li&gt;
&lt;li&gt;PyObject_NEW(): alias to PyObject_New()&lt;/li&gt;
&lt;li&gt;PyObject_NEW_VAR(): alias to PyObjectVar_New()&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h3&gt;Performance&lt;/h3&gt;
&lt;p&gt;PyType_HasFeature() was modified to always call PyType_GetFlags() function,
rather than accessing directly &lt;tt class="docutils literal"&gt;PyTypeObject.tp_flags&lt;/tt&gt;. The problem is that
on macOS, Python is built without LTO, the PyType_GetFlags() call is not
inlined, making functions like tuplegetter_descr_get() &lt;strong&gt;slower&lt;/strong&gt;: see
&lt;a class="reference external" href="https://bugs.python.org/issue39542#msg372962"&gt;bpo-39542&lt;/a&gt;. I &lt;strong&gt;reverted the
PyType_HasFeature() change&lt;/strong&gt; until the PEP 620 is accepted. macOS does not
use LTO to keep support support for macOS 10.6 (Snow Leopard): see &lt;a class="reference external" href="https://bugs.python.org/issue41181"&gt;bpo-41181&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fast-static-inline-functions"&gt;
&lt;h3&gt;Fast static inline functions&lt;/h3&gt;
&lt;p&gt;To keep best performances on Python built without LTO, fast private variants
were added as static inline functions to the internal C API:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;_PyIndex_Check()&lt;/li&gt;
&lt;li&gt;_PyObject_IS_GC()&lt;/li&gt;
&lt;li&gt;_PyType_HasFeature()&lt;/li&gt;
&lt;li&gt;_PyType_IS_GC()&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For example, PyObject_IS_GC() is defined as a function, whereas
_PyObject_IS_GC() is defined as an internal static inline function. Header
file:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/* Test if an object implements the garbage collector protocol */
PyAPI_FUNC(int) PyObject_IS_GC(PyObject *obj);

// Fast inlined version of PyObject_IS_GC()
static inline int _PyObject_IS_GC(PyObject *obj)
{
    return (PyType_IS_GC(Py_TYPE(obj))
            &amp;amp;&amp;amp; (Py_TYPE(obj)-&amp;gt;tp_is_gc == NULL
                || Py_TYPE(obj)-&amp;gt;tp_is_gc(obj)));
}
&lt;/pre&gt;
&lt;p&gt;C code:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
int
PyObject_IS_GC(PyObject *obj)
{
    return _PyObject_IS_GC(obj);
}
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-10-incompatible-c-api-change"&gt;
&lt;h2&gt;Python 3.10 incompatible C API change&lt;/h2&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;Py_REFCNT()&lt;/tt&gt; macro was converted to a static inline function:
&lt;tt class="docutils literal"&gt;Py_REFCNT(obj) = refcnt;&lt;/tt&gt; now fails with a compiler error. It must be
replaced with &lt;tt class="docutils literal"&gt;Py_SET_REFCNT(obj, refcnt)&lt;/tt&gt;: Py_SET_REFCNT() was added to
Python 3.9.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-complex-case-of-py-type-and-py-size-macros"&gt;
&lt;h2&gt;The complex case of Py_TYPE() and Py_SIZE() macros&lt;/h2&gt;
&lt;div class="section" id="macros-converted-and-then-reverted"&gt;
&lt;h3&gt;Macros converted and then reverted&lt;/h3&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;Py_TYPE()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;Py_SIZE()&lt;/tt&gt; macros were also converted to static inline
functions in Python 3.10, but the change &lt;a class="reference external" href="https://bugs.python.org/issue39573#msg370303"&gt;broke 17 C extensions&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Since the change broke too many C extensions, I reverted the change: I
&lt;a class="reference external" href="https://github.com/python/cpython/commit/0e2ac21dd4960574e89561243763eabba685296a"&gt;converted Py_TYPE() and Py_SIZE() back to macros&lt;/a&gt;
to have more time to fix fix C extensions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="i-fixed-6-extensions"&gt;
&lt;h3&gt;I fixed 6 extensions&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Cython: &lt;a class="reference external" href="https://github.com/cython/cython/commit/d8e93b332fe7d15459433ea74cd29178c03186bd"&gt;my fix adding __Pyx_SET_SIZE() and __Pyx_SET_REFCNT()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;immutables: &lt;a class="reference external" href="https://github.com/MagicStack/immutables/commit/45105ecd8b56a4d88dbcb380fcb8ff4b9cc7b19c"&gt;my fix adding pythoncapi_compat.h for Py_SET_SIZE()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;breezy: &lt;a class="reference external" href="https://bazaar.launchpad.net/~brz/brz/3.1/revision/7647"&gt;my fix adding Py_SET_REFCNT() macro&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;bitarray: &lt;a class="reference external" href="https://github.com/ilanschnell/bitarray/commit/a0cca9f2986ec796df74ca8f42aff56c4c7103ba"&gt;my fix adding pythoncapi_compat.h&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;python-zstandard: &lt;a class="reference external" href="https://github.com/indygreg/python-zstandard/commit/e5a3baf61b65f3075f250f504ddad9f8612bfedf"&gt;my fix adding pythoncapi_compat.h&lt;/a&gt;
followed by &lt;a class="reference external" href="https://github.com/indygreg/python-zstandard/commit/477776e6019478ca1c0b5777b073afbec70975f5"&gt;a pythoncapi_compat.h update for Python 2.7&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;mercurial: &lt;a class="reference external" href="https://www.mercurial-scm.org/repo/hg/rev/e92ca942ddca"&gt;my fix adding pythoncapi_compat.h&lt;/a&gt;
followed by a &lt;a class="reference external" href="https://www.mercurial-scm.org/repo/hg/rev/38b9a63d3a13"&gt;fix for Python 2.7&lt;/a&gt;
(then &lt;a class="reference external" href="https://github.com/pythoncapi/pythoncapi_compat/commit/3e0bde93954ea8df328d36900c7060a3f3433eb0"&gt;fixed into upstream pythoncapi_compat.h&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="extensions-fixed-by-others"&gt;
&lt;h3&gt;Extensions fixed by others&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;numpy: &lt;a class="reference external" href="https://github.com/numpy/numpy/commit/a96b18e3d4d11be31a321999cda4b795ea9eccaa"&gt;fix defining Py_SET_TYPE() and Py_SET_SIZE()&lt;/a&gt;,
followed by a &lt;a class="reference external" href="https://github.com/numpy/numpy/commit/f1671076c80bd972421751f2d48186ee9ac808aa"&gt;cleanup commit&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;pycurl: &lt;a class="reference external" href="https://github.com/pycurl/pycurl/commit/e633f9a1ac4df5e249e78c218d5fbbd848219042"&gt;fix defining Py_SET_TYPE()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;boost: &lt;a class="reference external" href="https://github.com/boostorg/python/commit/500194edb7833d0627ce7a2595fec49d0aae2484#diff-b06ac66c98951b48056826c904be75263cdf56ec9b79d3274ea493e7d27cbac4"&gt;fix adding Py_SET_TYPE() and Py_SET_SIZE() macros&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;duplicity:
&lt;a class="reference external" href="https://git.launchpad.net/duplicity/commit/?id=9c63dcb83e922e0afac206188203891e203b4e66"&gt;fix 1&lt;/a&gt;,
&lt;a class="reference external" href="https://git.launchpad.net/duplicity/commit/?id=bbaae91b5ac6ef7e295968e508522884609fbf84"&gt;fix 2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;pylibacl: &lt;a class="reference external" href="https://github.com/iustin/pylibacl/commit/26712b8fd92f1146102248cac1c92cb344620eff"&gt;fixed&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;gobject-introspection: &lt;a class="reference external" href="https://gitlab.gnome.org/GNOME/gobject-introspection/-/commit/c4d7d21a2ad838077c6310532fdf7505321f0ae7"&gt;fix adding Py_SET_TYPE() macro&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="extensions-still-not-fixed"&gt;
&lt;h3&gt;Extensions still not fixed&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;pyside2:&lt;ul&gt;
&lt;li&gt;My patch is not merged upstream yet&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugreports.qt.io/browse/PYSIDE-1436"&gt;https://bugreports.qt.io/browse/PYSIDE-1436&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://src.fedoraproject.org/rpms/python-pyside2/pull-request/7"&gt;https://src.fedoraproject.org/rpms/python-pyside2/pull-request/7&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1898974"&gt;https://bugzilla.redhat.com/show_bug.cgi?id=1898974&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1902618"&gt;https://bugzilla.redhat.com/show_bug.cgi?id=1902618&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;pybluez: &lt;a class="reference external" href="https://github.com/pybluez/pybluez/pull/371"&gt;closed PR (not merged)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;PyPAM&lt;/li&gt;
&lt;li&gt;pygobject3&lt;/li&gt;
&lt;li&gt;rdiff-backup&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="what-s-next"&gt;
&lt;h2&gt;What's Next?&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Convert again Py_TYPE() and Py_SIZE() macros to static inline functions.&lt;/li&gt;
&lt;li&gt;Add &amp;quot;%T&amp;quot; formatter for &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Py_TYPE(obj)-&amp;gt;tp_name&lt;/span&gt;&lt;/tt&gt;:
see &lt;a class="reference external" href="https://bugs.python.org/issue34595"&gt;rejected bpo-34595&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Modify Cython to use getter functions.&lt;/li&gt;
&lt;li&gt;Attempt to make some structures opaque, like PyThreadState.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="c-api"></category><category term="cpython"></category></entry><entry><title>Isolate Python Subinterpreters</title><link href="https://vstinner.github.io/isolate-subinterpreters.html" rel="alternate"></link><published>2020-12-27T22:00:00+01:00</published><updated>2020-12-27T22:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2020-12-27:/isolate-subinterpreters.html</id><summary type="html">&lt;img alt="Christmas gift." src="https://vstinner.github.io/images/christmas-gift.jpg" /&gt;
&lt;p&gt;This article is about the work done in Python in 2019 and 2020 to better
isolate subinterpreters. Static types are converted to heap types, extension
modules are converted to use the new multiphase initialization API (PEP 489),
caches, states, singletons and free lists are made per-interpreter, many bugs
have been …&lt;/p&gt;</summary><content type="html">&lt;img alt="Christmas gift." src="https://vstinner.github.io/images/christmas-gift.jpg" /&gt;
&lt;p&gt;This article is about the work done in Python in 2019 and 2020 to better
isolate subinterpreters. Static types are converted to heap types, extension
modules are converted to use the new multiphase initialization API (PEP 489),
caches, states, singletons and free lists are made per-interpreter, many bugs
have been fixed, etc.&lt;/p&gt;
&lt;p&gt;Running multiple interpreters in parallel with one &amp;quot;GIL&amp;quot; per interpreter cannot
be done yet, but a lot of complex technical challenges have been solved.&lt;/p&gt;
&lt;div class="section" id="why-isolating-subinterpreters"&gt;
&lt;h2&gt;Why isolating subinterpreters?&lt;/h2&gt;
&lt;p&gt;The final goal is to be able run multiple interpreters in parallel in the same
process, like one interpreter per CPU, each interpreter would run in its own
thread. The principle is the same than the multiprocessing module and has the
same limitations: no Python object can be shared directly between two
interpreters. Later, we can imagine helpers to share Python mutable objects
using proxies which would prevent race conditions.&lt;/p&gt;
&lt;p&gt;The work on subinterpreter requires to modify many functions and extension
modules. It will benefit to Python in different ways.&lt;/p&gt;
&lt;p&gt;Converting static types to heap types and convert extension modules to the
multiphase initialization API (PEP 489) makes extension modules implemented in
C to behave closer to modules implemented in Python, which is good for the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0399/"&gt;PEP
399 -- Pure Python/C Accelerator Module Compatibility Requirements&lt;/a&gt;. So &lt;strong&gt;this work also helps
Python implementations other than CPython, like PyPy&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;These changes also destroy more Python objects and release more memory at
Python exit which matters &lt;strong&gt;when Python is embedded in an application&lt;/strong&gt;. Python
should be &amp;quot;state less&amp;quot;, especially release all memory at exit. This work slowly
fix the &lt;a class="reference external" href="https://bugs.python.org/issue1635741"&gt;bpo-163574: Py_Finalize() doesn't clear all Python objects at exit&lt;/a&gt;. Python leaks less and less Python
objects at exit.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="proof-of-concept-in-may-2020"&gt;
&lt;h2&gt;Proof-of-concept in May 2020&lt;/h2&gt;
&lt;p&gt;In May 2020, I wrote a proof-of-concept to prove the feasability of the project
and to prove that it is faster than sequential execution: &lt;a class="reference external" href="https://mail.python.org/archives/list/python-dev&amp;#64;python.org/thread/S5GZZCEREZLA2PEMTVFBCDM52H4JSENR/#RIK75U3ROEHWZL4VENQSQECB4F4GDELV"&gt;PoC: Subinterpreters
4x faster than sequential execution or threads on CPU-bound workaround&lt;/a&gt;.
Benchmark on 4 CPUs:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Sequential: 1.99 sec +- 0.01 sec&lt;/li&gt;
&lt;li&gt;Threads: 3.15 sec +- 0.97 sec (1.5x &lt;strong&gt;slower&lt;/strong&gt;)&lt;/li&gt;
&lt;li&gt;Multiprocessing: 560 ms +- 12 ms (3.6x &lt;strong&gt;faster&lt;/strong&gt;)&lt;/li&gt;
&lt;li&gt;Subinterpreters: 583 ms +- 7 ms (3.4x &lt;strong&gt;faster&lt;/strong&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The performance of subintepreters is basically the same speed than
multiprocessing on this benchmark which is promising.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="experimental-isolated-subintepreters"&gt;
&lt;h2&gt;Experimental isolated subintepreters&lt;/h2&gt;
&lt;p&gt;To write this PoC, I added a &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--with-experimental-isolated-subinterpreters&lt;/span&gt;&lt;/tt&gt;
option to &lt;tt class="docutils literal"&gt;./configure&lt;/tt&gt; in &lt;a class="reference external" href="https://bugs.python.org/issue40514"&gt;bpo-40514&lt;/a&gt;
which defines the &lt;tt class="docutils literal"&gt;EXPERIMENTAL_ISOLATED_SUBINTERPRETERS&lt;/tt&gt; macro. Effects of
this special build:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Make the GIL per-interpreter.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;_xxsubinterpreters.run_string()&lt;/tt&gt; releases the GIL when running the
subinterpreter.&lt;/li&gt;
&lt;li&gt;Add a thread local storage for the Python thread state (&amp;quot;tstate&amp;quot;).&lt;/li&gt;
&lt;li&gt;Disable the garbage collector in subinterpreters.&lt;/li&gt;
&lt;li&gt;Disable the type attribute lookup cache.&lt;/li&gt;
&lt;li&gt;Disable free lists: frame, list, tuple, type attribute lookup cache.&lt;/li&gt;
&lt;li&gt;Disable singletons: latin1 characters.&lt;/li&gt;
&lt;li&gt;Disable interned strings.&lt;/li&gt;
&lt;li&gt;Disable the fast pymalloc memory allocator (force libc malloc memory
allocator).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Features are disabled because their implementation is currently not compatible
with multiple interpreters running in parallel.&lt;/p&gt;
&lt;p&gt;This special build is designed to be temporary. It should ease the development
of isolated subinterpreters. It will be removed once subinterpreters will be
fully isolated (once each interpreter will have its own GIL).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="convert-static-types-to-heap-types"&gt;
&lt;h2&gt;Convert static types to heap types&lt;/h2&gt;
&lt;p&gt;Types declared in Python (&lt;tt class="docutils literal"&gt;class MyType: ...&lt;/tt&gt;) are always &amp;quot;heap types&amp;quot;:
types dynamically allocated on the heap memory. Historically, all types
declared in C were declared as &amp;quot;static types&amp;quot;: defined statically at build
time.&lt;/p&gt;
&lt;p&gt;In C, static types are referenced directly using the using &lt;tt class="docutils literal"&gt;&amp;amp;&lt;/tt&gt; operator to
get their address, they are not copied. For example, the Python &lt;tt class="docutils literal"&gt;str&lt;/tt&gt; type is
referenced as &lt;tt class="docutils literal"&gt;&amp;amp;PyUnicode_Type&lt;/tt&gt; in C.&lt;/p&gt;
&lt;p&gt;Types are also regular objects (&lt;tt class="docutils literal"&gt;PyTypeObject&lt;/tt&gt; inherits from &lt;tt class="docutils literal"&gt;PyObject&lt;/tt&gt;)
and have a reference count, whereas the &lt;tt class="docutils literal"&gt;PyObject.ob_refcnt&lt;/tt&gt; member is not
atomic and so must not be modified in parallel. Problem: all interpreters share
the same static types.  Static types have other problems:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;A type &lt;tt class="docutils literal"&gt;__mro__&lt;/tt&gt; tuple (&lt;tt class="docutils literal"&gt;PyTypeObject.tp_mro&lt;/tt&gt; member) has the same
problem of non-atomic reference count.&lt;/li&gt;
&lt;li&gt;When a subtype is created, it is stored in the &lt;tt class="docutils literal"&gt;PyTypeObject.tp_subclasses&lt;/tt&gt;
dictionary member (accessible in Python with the &lt;tt class="docutils literal"&gt;__subclasses__()&lt;/tt&gt;
method), whereas Python dictionaries are not thread-safe.&lt;/li&gt;
&lt;li&gt;Static types behave differently than regular Python types. For example,
usually it is not possible to add an arbitrary attribute or override
an attribute. It goes against the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0399/"&gt;PEP 399 -- Pure Python/C Accelerator
Module Compatibility Requirements&lt;/a&gt; principles.&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Right now, &lt;strong&gt;43% (89/206)&lt;/strong&gt; of types are declared as heap types on a total of
206 types. For comparison, in Python 3.8, only 9% (15/172) of types were
declared as heap types: &lt;strong&gt;74 types&lt;/strong&gt; have been converted in the meanwhile.&lt;/p&gt;
&lt;p&gt;TODO: convert the remaining 117 static types: see &lt;a class="reference external" href="https://bugs.python.org/issue40077"&gt;bpo-40077&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="multiphase-initialization-api"&gt;
&lt;h2&gt;Multiphase initialization API&lt;/h2&gt;
&lt;p&gt;Historically, extension modules are declared with the &lt;tt class="docutils literal"&gt;PyModule_Create()&lt;/tt&gt;
function. Usually, such extension can be instanciated exactly once. It is
stored in an internal &lt;tt class="docutils literal"&gt;PyInterpreterState.modules_by_index&lt;/tt&gt; list; an unique
index is assigned to the module and stored in &lt;tt class="docutils literal"&gt;PyModuleDef.m_base.m_index&lt;/tt&gt;.
Usually, such extension use static global variables.&lt;/p&gt;
&lt;p&gt;Such &amp;quot;static&amp;quot; extension has multiple issues:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The extension cannot be unloaded: its memory is not released at Python exit.
It is an issue when Python is embedded in an application.&lt;/li&gt;
&lt;li&gt;The extension behaves differently than modules defined in Python. When an
extension is reimported, its namespace (&lt;tt class="docutils literal"&gt;module.__dict__&lt;/tt&gt;) is duplicated,
but mutable objects and static global variables are still shared. It goes
against the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0399/"&gt;PEP 399 -- Pure Python/C Accelerator Module Compatibility
Requirements&lt;/a&gt; principles.&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In 2013, &lt;strong&gt;Petr Viktorin&lt;/strong&gt;, &lt;strong&gt;Stefan Behnel&lt;/strong&gt; and &lt;strong&gt;Nick Coghlan&lt;/strong&gt; wrote the
&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0489/"&gt;PEP 489 -- Multi-phase extension module initialization&lt;/a&gt; which has been approved and
implemented in Python 3.5. For example, the &lt;tt class="docutils literal"&gt;_abc&lt;/tt&gt; module initialization
function is now just a call to the new &lt;tt class="docutils literal"&gt;PyModuleDef_Init()&lt;/tt&gt; function:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PyMODINIT_FUNC
PyInit__abc(void)
{
    return PyModuleDef_Init(&amp;amp;_abcmodule);
}
&lt;/pre&gt;
&lt;p&gt;An extension module can have a module state, if &lt;tt class="docutils literal"&gt;PyModuleDef.m_size&lt;/tt&gt; is
greater than zero. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
typedef struct {
    PyTypeObject *_abc_data_type;
    unsigned long long abc_invalidation_counter;
} _abcmodule_state;

static struct PyModuleDef _abcmodule = {
    ...
    .m_size = sizeof(_abcmodule_state),  // &amp;lt;=== HERE ===
};
&lt;/pre&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;PyModule_GetState()&lt;/tt&gt; can be used to retrieve the module state. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
static inline _abcmodule_state*
get_abc_state(PyObject *module)
{
    void *state = PyModule_GetState(module);
    assert(state != NULL);
    return (_abcmodule_state *)state;
}

static PyObject *
_abc__abc_init(PyObject *module, PyObject *self)
{
    _abcmodule_state *state = get_abc_state(module);
    ...
    data = abc_data_new(state-&amp;gt;_abc_data_type, NULL, NULL);
    ...
}
&lt;/pre&gt;
&lt;p&gt;Right now, &lt;strong&gt;77% (102/132)&lt;/strong&gt; of extension modules use the new multiphase
initialization API (PEP 489) on a total of 132 extension modules.  For
comparison, in Python 3.8, only 23% (27/118) of extensions used the new
multiphase initialization API: &lt;strong&gt;75 extensions&lt;/strong&gt; have been converted in the
meanwhile.&lt;/p&gt;
&lt;p&gt;TODO: convert the remaining 30 extension modules (&lt;a class="reference external" href="https://bugs.python.org/issue1635741"&gt;bpo-163574&lt;/a&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="module-states"&gt;
&lt;h2&gt;Module states&lt;/h2&gt;
&lt;p&gt;Some modules have a state which should be stored in the interpreter to share
its state between multiple instances of the module, and also to give access to
the state in functions of the public C API (ex: &lt;tt class="docutils literal"&gt;PyAST_Check()&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;States made per-interpreter:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2019-05-10: &lt;strong&gt;warnings&lt;/strong&gt;
(&lt;a class="reference external" href="https://bugs.python.org/issue36737"&gt;bpo-36737&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/86ea58149c3e83f402cecd17e6a536865fb06ce1"&gt;commit&lt;/a&gt; by &lt;strong&gt;Eric Snow&lt;/strong&gt;)&lt;/li&gt;
&lt;li&gt;2019-11-07: &lt;strong&gt;parser&lt;/strong&gt;
(&lt;a class="reference external" href="https://bugs.python.org/issue36876"&gt;bpo-36876&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/9def81aa52adc3cc89554156e40742cf17312825"&gt;commit&lt;/a&gt; by &lt;strong&gt;Vinay Sajip&lt;/strong&gt;)&lt;/li&gt;
&lt;li&gt;2019-11-20: &lt;strong&gt;gc&lt;/strong&gt;
(&lt;a class="reference external" href="https://bugs.python.org/issue36854"&gt;bpo-36854&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/7247407c35330f3f6292f1d40606b7ba6afd5700"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-11-02: &lt;strong&gt;ast&lt;/strong&gt;
(&lt;a class="reference external" href="https://bugs.python.org/issue41796"&gt;bpo-41796&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/5cf4782a2630629d0978bf4cf6b6340365f449b2"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-12-15: &lt;strong&gt;atexit&lt;/strong&gt;
(&lt;a class="reference external" href="https://bugs.python.org/issue42639"&gt;bpo-42639&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/b8fa135908d294b350cdad04e2f512327a538dee"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="singletons"&gt;
&lt;h2&gt;Singletons&lt;/h2&gt;
&lt;p&gt;Singletons must not be shared between interpreters.&lt;/p&gt;
&lt;p&gt;Singletons made per-interpreter.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue38858"&gt;bpo-38858&lt;/a&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2019-12-17: small &lt;strong&gt;integer&lt;/strong&gt;, the [-5; 256] range
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/630c8df5cf126594f8c1c4579c1888ca80a29d59"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue40521"&gt;bpo-40521&lt;/a&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2020-06-04: empty &lt;strong&gt;tuple&lt;/strong&gt; singleton
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/69ac6e58fd98de339c013fe64cd1cf763e4f9bca"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-23: empty &lt;strong&gt;bytes&lt;/strong&gt; string singleton and single byte character
(&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;b'\x00'&lt;/span&gt;&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;b'\xFF'&lt;/span&gt;&lt;/tt&gt;) singletons
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/c41eed1a874e2f22bde45c3c89418414b7a37f46"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-23: empty &lt;strong&gt;Unicode&lt;/strong&gt; string singleton
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/f363d0a6e9cfa50677a6de203735fbc0d06c2f49"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-23: empty &lt;strong&gt;frozenset&lt;/strong&gt; singleton
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/261cfedf7657a515e04428bba58eba2a9bb88208"&gt;commit&lt;/a&gt; by me);
later removed.&lt;/li&gt;
&lt;li&gt;2020-06-24: single &lt;strong&gt;Unicode&lt;/strong&gt; character (U+0000-U+00FF range)
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/2f9ada96e0d420fed0d09a032b37197f08ef167a"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I also micro-optimized the code: most singletons are now always created at
startup, it's no longer needed to check if it is created at each function call.
Moreover, an assertion now ensures that singletons are no longer used after
they are deleted.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="free-lists"&gt;
&lt;h2&gt;Free lists&lt;/h2&gt;
&lt;p&gt;A free list is a micro-optimization on memory allocations. The memory of
recently destroyed objects is not freed to be able to reuse it for new objects.
Free lists must not be shared between interpreters.&lt;/p&gt;
&lt;p&gt;Free lists made per-interpreter (&lt;a class="reference external" href="https://bugs.python.org/issue40521"&gt;bpo-40521&lt;/a&gt;):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2020-06-04: &lt;strong&gt;slice&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/7daba6f221e713f7f60c613b246459b07d179f91"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-04: &lt;strong&gt;tuple&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/69ac6e58fd98de339c013fe64cd1cf763e4f9bca"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-04: &lt;strong&gt;float&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/2ba59370c3dda2ac229c14510e53a05074b133d1"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-04: &lt;strong&gt;frame&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/3744ed2c9c0b3905947602fc375de49533790cb9"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-05: &lt;strong&gt;async generator&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/78a02c2568714562e23e885b6dc5730601f35226"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-05: &lt;strong&gt;context&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/e005ead49b1ee2b1507ceea94e6f89c28ecf1f81"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-05: &lt;strong&gt;list&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/88ec9190105c9b03f49aaef601ce02b242a75273"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-23: &lt;strong&gt;dict&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/b4e85cadfbc2b1b24ec5f3159e351dbacedaa5e0"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-06-23: &lt;strong&gt;MemoryError&lt;/strong&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/281cce1106568ef9fec17e3c72d289416fac02a5"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="caches"&gt;
&lt;h2&gt;Caches&lt;/h2&gt;
&lt;p&gt;Caches made per interpreter:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2020-06-04: &lt;strong&gt;slice&lt;/strong&gt; cache
(&lt;a class="reference external" href="https://bugs.python.org/issue40521"&gt;bpo-40521&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/7daba6f221e713f7f60c613b246459b07d179f91"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-12-26: &lt;strong&gt;type&lt;/strong&gt; attribute lookup cache
(&lt;a class="reference external" href="https://bugs.python.org/issue42745"&gt;bpo-42745&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/41010184880151d6ae02a226dbacc796e5c90d11"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="interned-strings-and-identifiers"&gt;
&lt;h2&gt;Interned strings and identifiers&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2020-12-25: Per-interpreter identifiers: &lt;tt class="docutils literal"&gt;_PyUnicode_FromId()&lt;/tt&gt;
(&lt;a class="reference external" href="https://bugs.python.org/issue39465"&gt;bpo-39465&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/ba3d67c2fb04a7842741b1b6da5d67f22c579f33"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;li&gt;2020-12-26: Per-interpreter interned strings: &lt;tt class="docutils literal"&gt;PyUnicode_InternInPlace()&lt;/tt&gt;
(&lt;a class="reference external" href="https://bugs.python.org/issue40521"&gt;bpo-40521&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/ea251806b8dffff11b30d2182af1e589caf88acf"&gt;commit&lt;/a&gt; by me)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For &lt;tt class="docutils literal"&gt;_PyUnicode_FromId()&lt;/tt&gt;, I added the &lt;tt class="docutils literal"&gt;pycore_atomic_funcs.h&lt;/tt&gt; header file
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/52a327c1cbb86c7f2f5c460645889b23615261bf"&gt;commit&lt;/a&gt;)
which adds functions for atomic memory accesses (to variables of type
&lt;tt class="docutils literal"&gt;Py_ssize_t&lt;/tt&gt;). It uses &lt;tt class="docutils literal"&gt;__atomic_load_n()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;__atomic_store_n()&lt;/tt&gt; on GCC
and clang, or &lt;tt class="docutils literal"&gt;_InterlockedCompareExchange64()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;_InterlockedExchange64()&lt;/tt&gt; on MSC (Windows).&lt;/p&gt;
&lt;p&gt;First, I tried to use the &lt;tt class="docutils literal"&gt;_Py_hashtable&lt;/tt&gt; type: &lt;a class="reference external" href="https://github.com/python/cpython/pull/20048"&gt;PR 20048&lt;/a&gt;. Using &lt;tt class="docutils literal"&gt;_Py_hashtable&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;_PyUnicode_FromId()&lt;/tt&gt; took 15.5 ns +- 0.1 ns.  I optimized &lt;tt class="docutils literal"&gt;_Py_hashtable&lt;/tt&gt;:
&lt;tt class="docutils literal"&gt;_PyUnicode_FromId()&lt;/tt&gt; took 6.65 ns +- 0.09 ns. But it was still slower than
the reference code: 2.38 ns +- 0.00 ns.&lt;/p&gt;
&lt;p&gt;The merged implementation uses an array. An unique index is assigned, index in
this array. The array is made larger on demand. The final change adds 1 ns
per function call:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
[ref] 2.42 ns +- 0.00 ns -&amp;gt; [atomic] 3.39 ns +- 0.00 ns: 1.40x slower
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="misc"&gt;
&lt;h2&gt;Misc&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2020-03-19: Per-interpreter pending calls
(&lt;a class="reference external" href="https://bugs.python.org/issue39984"&gt;bpo-39984&lt;/a&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/50e6e991781db761c496561a995541ca8d83ff87"&gt;commit&lt;/a&gt; by me).&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="bugfixes"&gt;
&lt;h2&gt;Bugfixes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/gil-bugfixes-daemon-threads-python39.html"&gt;GIL bugfixes for daemon threads in Python 3.9&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Fix many &lt;a class="reference external" href="https://vstinner.github.io/subinterpreter-leaks.html"&gt;leaks discovered by subinterpreters&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Fix pickling heap types implemented in C with protocols 0 and 1
(&lt;a class="reference external" href="https://bugs.python.org/issue41052"&gt;bpo-41052&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-630-isolating-extension-modules"&gt;
&lt;h2&gt;PEP 630: Isolating Extension Modules&lt;/h2&gt;
&lt;p&gt;In August 2020, &lt;strong&gt;Petr Viktorin&lt;/strong&gt; wrote &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0630/"&gt;PEP 630 -- Isolating Extension Modules&lt;/a&gt; which gives practical advices on
how to update an extension module to make it stateless using previous PEPs
(heap types, multi-phase init, etc.). Once a module is stateless, it becomes
safe to use it subinterpreters running in parallel.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="thanks"&gt;
&lt;h2&gt;Thanks&lt;/h2&gt;
&lt;p&gt;The work on subintepreters, multiphase init and heap types is a collaborative
work on-going for 2 years. I would like to thank the following developers for
helping on this large task:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;strong&gt;Christian Heimes&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Dong-hee Na&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Eric Snow&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Erlend Egeberg Aasland&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Hai Shi&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Mohamed Koubaa&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Nick Coghlan&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Paulo Henrique Silva&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Petr Viktorin&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Vinay Sajip&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note: Since the work is scattered in many issues and pull requests, it's hard
to track who helped: sorry if I forgot someone! (Please contact me and I
will complete the list.)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="what-s-next"&gt;
&lt;h2&gt;What's Next?&lt;/h2&gt;
&lt;p&gt;There are still multiple interesting technical challenges:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue39511"&gt;bpo-39511: Per-interpreter singletons (None, True, False, etc.)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue40601"&gt;bpo-40601: Hide static types from the C API&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Make pymalloc allocator compatible with subinterpreters.&lt;/li&gt;
&lt;li&gt;Make the GIL per interpreter. Maybe even give the choice to share or not
the GIL when a subinterpreter is created.&lt;/li&gt;
&lt;li&gt;Make the &lt;tt class="docutils literal"&gt;_PyArg_Parser&lt;/tt&gt; (&lt;tt class="docutils literal"&gt;parser_init()&lt;/tt&gt;) function compatible with
subinterpreters. Maybe use a per-interpreter array, similar solution than
&lt;tt class="docutils literal"&gt;_PyUnicode_FromId()&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue15751"&gt;bpo-15751: Make the PyGILState API compatible with subinterpreters&lt;/a&gt; (issue created in 2012!)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue40522"&gt;bpo-40522: Get the current Python interpreter state from Thread Local
Storage (autoTSSkey)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Also, there are still many static types to convert to heap types (&lt;a class="reference external" href="https://bugs.python.org/issue40077"&gt;bpo-40077&lt;/a&gt;) and many extension modules to convert
to the multiphase initialization API (&lt;a class="reference external" href="https://bugs.python.org/issue1635741"&gt;bpo-163574&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;I'm tracking the work in my &lt;a class="reference external" href="https://pythondev.readthedocs.io/subinterpreters.html"&gt;Python Subinterpreters&lt;/a&gt; page
and in the &lt;a class="reference external" href="https://bugs.python.org/issue40512"&gt;bpo-40512: Meta issue: per-interpreter GIL&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="cpython"></category><category term="subinterpreters"></category></entry><entry><title>Hide implementation details from the Python C API</title><link href="https://vstinner.github.io/hide-implementation-details-python-c-api.html" rel="alternate"></link><published>2020-12-25T22:00:00+01:00</published><updated>2020-12-25T22:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2020-12-25:/hide-implementation-details-python-c-api.html</id><summary type="html">&lt;img alt="My cat attacking the Python C API" src="https://vstinner.github.io/images/pepsie.jpg" /&gt;
&lt;p&gt;This article is the history of Python C API discussions over the last 4 years,
and the creation of C API projects: &lt;a class="reference external" href="https://pythoncapi.readthedocs.io/"&gt;pythoncapi website&lt;/a&gt;, &lt;a class="reference external" href="https://github.com/pythoncapi/pythoncapi_compat"&gt;pythoncapi_compat.h header file&lt;/a&gt; and &lt;a class="reference external" href="https://hpy.readthedocs.io/"&gt;HPy (new clean C API)&lt;/a&gt;. More and more people are aware of issues
caused by the C API and are working …&lt;/p&gt;</summary><content type="html">&lt;img alt="My cat attacking the Python C API" src="https://vstinner.github.io/images/pepsie.jpg" /&gt;
&lt;p&gt;This article is the history of Python C API discussions over the last 4 years,
and the creation of C API projects: &lt;a class="reference external" href="https://pythoncapi.readthedocs.io/"&gt;pythoncapi website&lt;/a&gt;, &lt;a class="reference external" href="https://github.com/pythoncapi/pythoncapi_compat"&gt;pythoncapi_compat.h header file&lt;/a&gt; and &lt;a class="reference external" href="https://hpy.readthedocs.io/"&gt;HPy (new clean C API)&lt;/a&gt;. More and more people are aware of issues
caused by the C API and are working on solutions.&lt;/p&gt;
&lt;p&gt;It took me a lot of iterations to find the right approach to evolve the C API
without breaking too many third-party extension modules. My first ideas were
based on two APIs with an opt-in option somehow. At the end, I decided to fix
directly the default API, and helped maintainers of extension modules to update
their projects for incompatible C API changes.&lt;/p&gt;
&lt;p&gt;I wrote a &lt;tt class="docutils literal"&gt;pythoncapi_compat.h&lt;/tt&gt; header file which adds C API functions of
newer Python to old Python versions up to Python 2.7. I also wrote a
&lt;tt class="docutils literal"&gt;upgrade_pythoncapi.py&lt;/tt&gt; script to add Python 3.10 support to an extension
module without losing Python 2.7 support: the tool adds &lt;tt class="docutils literal"&gt;#include
&amp;quot;pythoncapi_compat.h&amp;quot;&lt;/tt&gt;. For example, it replaces &lt;tt class="docutils literal"&gt;Py_TYPE(obj) = type&lt;/tt&gt;
with &lt;tt class="docutils literal"&gt;Py_SET_SIZE(obj, type)&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;The photo: my cat attacking the Python C API.&lt;/p&gt;
&lt;div class="section" id="year-2016"&gt;
&lt;h2&gt;Year 2016&lt;/h2&gt;
&lt;p&gt;Between 2016 and 2017, Larry Hastings worked on removing the GIL in a CPython
fork called &amp;quot;The Gilectomy&amp;quot;. He pushed the first commit in April 2016: &lt;a class="reference external" href="https://github.com/larryhastings/gilectomy/commit/4a1a4ff49e34b9705608cad968f467af161dcf02"&gt;Removed
the GIL. Don't merge this!&lt;/a&gt;
(&amp;quot;Few programs work now&amp;quot;). At EuroPython 2016, he gave the talk &lt;a class="reference external" href="https://www.youtube.com/watch?v=fgWUwQVoLHo"&gt;Larry Hastings
- The Gilectomy&lt;/a&gt; where he
explains that the current parallelism bottleneck is the CPython reference
counting which doesn't scale with the number of threads.&lt;/p&gt;
&lt;p&gt;It was just another hint telling me that &amp;quot;something&amp;quot; should be done to make the
C API more abstract, move away from implementation details like reference
counting. PyPy also has performance issues with the C API for many years.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="year-2017"&gt;
&lt;h2&gt;Year 2017&lt;/h2&gt;
&lt;div class="section" id="may"&gt;
&lt;h3&gt;May&lt;/h3&gt;
&lt;p&gt;In 2017, I discussed with Eric Snow who was working on subinterpreters. He had
to modify public structures, especially the &lt;tt class="docutils literal"&gt;PyInterpreterState&lt;/tt&gt; structure.
He created &lt;tt class="docutils literal"&gt;Include/internal/&lt;/tt&gt; subdirectory to create a new &amp;quot;internal C API&amp;quot;
which should not be exported. (Later, he moved the &lt;tt class="docutils literal"&gt;PyInterpreterState&lt;/tt&gt;
structure to the internal C API in Python 3.8.)&lt;/p&gt;
&lt;p&gt;I started the discuss C API changes during the Python Language Summit
(PyCon US 2017): &lt;a class="reference external" href="https://github.com/vstinner/conf/raw/master/2017-PyconUS/summit.pdf"&gt;&amp;quot;Python performance&amp;quot; slides (PDF)&lt;/a&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Split Include in sub-directories&lt;/li&gt;
&lt;li&gt;Move towards a stable ABI by default&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;See also the LWN article: &lt;a class="reference external" href="https://lwn.net/Articles/723752/#723949"&gt;Keeping Python competitive&lt;/a&gt; by Jake Edge.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="july-first-pep-draft"&gt;
&lt;h3&gt;July: first PEP draft&lt;/h3&gt;
&lt;p&gt;I proposed the first PEP draft to python-ideas:
&lt;a class="reference external" href="https://mail.python.org/archives/list/python-ideas&amp;#64;python.org/thread/6XATDGWK4VBUQPRHCRLKQECTJIPBVNJQ/"&gt;PEP: Hide implementation details in the C API&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The idea is to add an opt-in option to distutils to build an extension module
with a new C API, remove implementation details from the new C API, and maybe
later switch to the new C API by default.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="september"&gt;
&lt;h3&gt;September&lt;/h3&gt;
&lt;p&gt;I discussed my C API change ideas at the CPython core dev sprint (at Instagram,
California).  The ideas were liked by most (if not all) core developers who are
fine with a minor performance slowdown (caused by replacing macros with
function calls). I wrote &lt;a class="reference external" href="https://vstinner.github.io/new-python-c-api.html"&gt;A New C API for CPython&lt;/a&gt; blog post about these
discussions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="november"&gt;
&lt;h3&gt;November&lt;/h3&gt;
&lt;p&gt;I proposed &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-November/150607.html"&gt;Make the stable API-ABI usable&lt;/a&gt; on
the python-dev list. The idea is to add &lt;tt class="docutils literal"&gt;PyTuple_GET_ITEM()&lt;/tt&gt; (for example) to
the limited C API but declared as a function call. Later, if enough extension
modules are compatible with the extended limited C API, make it the default.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="year-2018"&gt;
&lt;h2&gt;Year 2018&lt;/h2&gt;
&lt;p&gt;In July, I created the &lt;a class="reference external" href="https://pythoncapi.readthedocs.io/"&gt;pythoncapi website&lt;/a&gt; to collect issues of the current C
API, list things to avoid in new functions like borrowed references, and start
to design a new better C API.&lt;/p&gt;
&lt;p&gt;In September, Antonio Cuni wrote &lt;a class="reference external" href="https://morepypy.blogspot.com/2018/09/inside-cpyext-why-emulating-cpython-c.html"&gt;Inside cpyext: Why emulating CPython C API is
so Hard&lt;/a&gt;
article.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="year-2019"&gt;
&lt;h2&gt;Year 2019&lt;/h2&gt;
&lt;p&gt;In February, I sent &lt;a class="reference external" href="https://mail.python.org/archives/list/capi-sig&amp;#64;python.org/thread/WS6ATJWRUQZESGGYP3CCSVPF7OMPMNM6/"&gt;Update on CPython header files reorganization&lt;/a&gt;
to the capi-sig list.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Include/&lt;/tt&gt;: limited C API&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Include/cpython/&lt;/tt&gt;: CPython C API&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Include/internal/&lt;/tt&gt;: CPython internal C API&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In March, I modified the Python debug build to make its ABI compatible with the
release build ABI:
&lt;a class="reference external" href="https://docs.python.org/dev/whatsnew/3.8.html#debug-build-uses-the-same-abi-as-release-build"&gt;What’s New In Python 3.8: Debug build uses the same ABI as release build&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In May, I gave a lightning talk &lt;a class="reference external" href="https://github.com/vstinner/conf/blob/master/2019-Pycon/status_stable_api_abi.pdf"&gt;Status of the stable API and ABI in Python 3.8&lt;/a&gt;,
at the Language Summit (during Pycon US 2019):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Convert macros to static inline functions&lt;/li&gt;
&lt;li&gt;Install the internal C API&lt;/li&gt;
&lt;li&gt;Debug build now ABI compatible with the release build ABI&lt;/li&gt;
&lt;li&gt;Getting rid of global variables&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;By the way, see my &lt;a class="reference external" href="https://vstinner.github.io/split-include-directory-python38.html"&gt;Split Include/ directory in Python 3.8&lt;/a&gt; article: I converted many macros in
Python 3.8.&lt;/p&gt;
&lt;p&gt;In July, the &lt;a class="reference external" href="https://hpy.readthedocs.io/"&gt;HPy project&lt;/a&gt; was created during
EuroPython at Basel. There was an informal meeting which included core
developers of PyPy (Antonio, Armin and Ronan), CPython (Victor Stinner and Mark
Shannon) and Cython (Stefan Behnel).&lt;/p&gt;
&lt;p&gt;In December, Antonio, Armin and Ronan had a small internal sprint to kick-off
the development of HPy: &lt;a class="reference external" href="https://morepypy.blogspot.com/2019/12/hpy-kick-off-sprint-report.html"&gt;HPy kick-off sprint report&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="year-2020"&gt;
&lt;h2&gt;Year 2020&lt;/h2&gt;
&lt;div class="section" id="april"&gt;
&lt;h3&gt;April&lt;/h3&gt;
&lt;p&gt;I proposed &lt;a class="reference external" href="https://mail.python.org/archives/list/python-dev&amp;#64;python.org/thread/HKM774XKU7DPJNLUTYHUB5U6VR6EQMJF/#TKHNENOXP6H34E73XGFOL2KKXSM4Z6T2"&gt;PEP: Modify the C API to hide implementation details&lt;/a&gt;
on the python-dev list. The main idea is to provide a new optimized Python
runtime which is backward incompatible on purpose, and continue to ship the
regular runtime which is fully backward compatible.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="june"&gt;
&lt;h3&gt;June&lt;/h3&gt;
&lt;p&gt;I wrote &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0620/"&gt;PEP 620 -- Hide implementation details from the C API&lt;/a&gt; and &lt;a class="reference external" href="https://mail.python.org/archives/list/python-dev&amp;#64;python.org/thread/HKM774XKU7DPJNLUTYHUB5U6VR6EQMJF/"&gt;proposed the PEP to
python-dev&lt;/a&gt;.
This PEP is my 3rd attempt to fix the C API: I rewrote it from scratch. Python
now distributes a new &lt;tt class="docutils literal"&gt;pythoncapi_compat.h&lt;/tt&gt; header and a process is defined
to reduce the number of broken C extensions when introducing C API incompatible
changes listed in this PEP.&lt;/p&gt;
&lt;p&gt;I created the &lt;a class="reference external" href="https://github.com/pythoncapi/pythoncapi_compat"&gt;pythoncapi_compat project&lt;/a&gt;: header file providing new
C API functions to old Python versions using static inline functions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="december"&gt;
&lt;h3&gt;December&lt;/h3&gt;
&lt;p&gt;I wrote a new &lt;tt class="docutils literal"&gt;upgrade_pythoncapi.py&lt;/tt&gt; script to add Python 3.10
support to an extension module without losing support with Python 2.7.  I sent
&lt;a class="reference external" href="https://mail.python.org/archives/list/capi-sig&amp;#64;python.org/thread/LFLXFMKMZ77UCDUFD5EQCONSAFFWJWOZ/"&gt;New script: add Python 3.10 support to your C extensions without losing Python
3.6 support&lt;/a&gt;
to the capi-sig list.&lt;/p&gt;
&lt;p&gt;The pythoncapi_compat project got its first users (bitarray, immutables,
python-zstandard)! It proves that the project is useful and needed.&lt;/p&gt;
&lt;p&gt;I collaborated with the HPy project to create a manifesto explaining how the C
API prevents to optimize CPython and makes the CPython C API inefficient on
PyPy. It is still a draft.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="optimization"></category><category term="cpython"></category><category term="c-api"></category></entry><entry><title>Leaks discovered by subinterpreters</title><link href="https://vstinner.github.io/subinterpreter-leaks.html" rel="alternate"></link><published>2020-12-23T14:00:00+01:00</published><updated>2020-12-23T14:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2020-12-23:/subinterpreter-leaks.html</id><summary type="html">&lt;p&gt;This article is about old reference leaks discovered or caused by the work on
isolating subinterpreters: leaks in 6 different modules (gc, _weakref, _abc,
_signal, _ast and _thread).&lt;/p&gt;
&lt;img alt="_thread GC bug" src="https://vstinner.github.io/images/thread_gc_bug.jpg" /&gt;
&lt;div class="section" id="refleaks-buildbot-failures"&gt;
&lt;h2&gt;Refleaks buildbot failures&lt;/h2&gt;
&lt;p&gt;With my work on isolating subinterpreters, old bugs about Python objects leaked
at Python exit are suddenly becoming blocker …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;This article is about old reference leaks discovered or caused by the work on
isolating subinterpreters: leaks in 6 different modules (gc, _weakref, _abc,
_signal, _ast and _thread).&lt;/p&gt;
&lt;img alt="_thread GC bug" src="https://vstinner.github.io/images/thread_gc_bug.jpg" /&gt;
&lt;div class="section" id="refleaks-buildbot-failures"&gt;
&lt;h2&gt;Refleaks buildbot failures&lt;/h2&gt;
&lt;p&gt;With my work on isolating subinterpreters, old bugs about Python objects leaked
at Python exit are suddenly becoming blocker issues on buildbots.&lt;/p&gt;
&lt;p&gt;When subinterpreters still share Python objects with the main interpreter, it
is ok-ish to leak these objects at Python exit. Right now (current master
branch), there are still more than 18 000 Python objects which are not
destroyed at Python exit:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -X showrefcount -c pass
[18411 refs, 6097 blocks]
&lt;/pre&gt;
&lt;p&gt;This issue is being solved in the &lt;a class="reference external" href="https://bugs.python.org/issue1635741"&gt;bpo-1635741: Py_Finalize() doesn't clear all
Python objects at exit&lt;/a&gt; which was
opened almost 14 years ago (2007).&lt;/p&gt;
&lt;p&gt;When subinterpreters are better isolated, objects are no longer shared, and
suddenly these leaks make subinterpreters tests failing on Refleak buildbots.
For example, when an extension module is converted to the multiphase
initialization API (PEP 489) or when static types are converted to heap types,
these issues pop up.&lt;/p&gt;
&lt;p&gt;It is a blocker issue for me, since I care of having only &amp;quot;green&amp;quot; buildbots (no
test failure), otherwise more serious regressions can be easily missed.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="per-interpreter-gc-state"&gt;
&lt;h2&gt;Per-interpreter GC state&lt;/h2&gt;
&lt;p&gt;In November 2019, I made the state of the GC module per-interpreter in
&lt;a class="reference external" href="https://bugs.python.org/issue36854"&gt;bpo-36854&lt;/a&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/7247407c35330f3f6292f1d40606b7ba6afd5700"&gt;commit&lt;/a&gt;)
and test_atexit started to leak:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test -R 3:3 test_atexit -m test.test_atexit.SubinterpreterTest.test_callbacks_leak
test_atexit leaked [3988, 3986, 3988] references, sum=11962
&lt;/pre&gt;
&lt;p&gt;I fixed the usage of the &lt;tt class="docutils literal"&gt;PyModule_AddObject()&lt;/tt&gt; function in the &lt;tt class="docutils literal"&gt;_testcapi&lt;/tt&gt;
module (&lt;a class="reference external" href="https://github.com/python/cpython/commit/310e2d25170a88ef03f6fd31efcc899fe062da2c"&gt;commit&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;I also pushed a &lt;strong&gt;workaround&lt;/strong&gt; in &lt;tt class="docutils literal"&gt;finalize_interp_clear()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
+    /* bpo-36854: Explicitly clear the codec registry
+       and trigger a GC collection */
+    PyInterpreterState *interp = tstate-&amp;gt;interp;
+    Py_CLEAR(interp-&amp;gt;codec_search_path);
+    Py_CLEAR(interp-&amp;gt;codec_search_cache);
+    Py_CLEAR(interp-&amp;gt;codec_error_registry);
+    _PyGC_CollectNoFail();
&lt;/pre&gt;
&lt;p&gt;I dislike having to push a &amp;quot;temporary&amp;quot; workaround, but the Python finalization
is really complex and fragile. Fixing the root issues would require too much
work, whereas I wanted to repair the Refleak buildbots as soon as possible.&lt;/p&gt;
&lt;p&gt;In December 2019, the workaround was partially removed (&lt;a class="reference external" href="https://github.com/python/cpython/commit/ac0e1c2694bc199dbd073312145e3c09bee52cc4"&gt;commit&lt;/a&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-    Py_CLEAR(interp-&amp;gt;codec_search_path);
-    Py_CLEAR(interp-&amp;gt;codec_search_cache);
-    Py_CLEAR(interp-&amp;gt;codec_error_registry);
&lt;/pre&gt;
&lt;p&gt;The year after (December 2020), the last GC collection was moved into
&lt;tt class="docutils literal"&gt;PyInterpreterState_Clear()&lt;/tt&gt;, before finalizating the GC (&lt;a class="reference external" href="https://github.com/python/cpython/commit/eba5bf2f5672bf4861c626937597b85ac0c242b9"&gt;commit&lt;/a&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="port-weakref-to-multiphase-init"&gt;
&lt;h2&gt;Port _weakref to multiphase init&lt;/h2&gt;
&lt;p&gt;In March 2020, the &lt;tt class="docutils literal"&gt;_weakref&lt;/tt&gt; module was ported to the multiphase
initialization API (PEP 489) in &lt;a class="reference external" href="https://bugs.python.org/issue40050"&gt;bpo-40050&lt;/a&gt; and test_importlib started to leak:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test -R 3:3 test_importlib
test_importlib leaked [6303, 6299, 6303] references, sum=18905
&lt;/pre&gt;
&lt;p&gt;The analysis was quite long and complicated. The importlib imported some
extension modules twice and it has to inject frozen modules to &amp;quot;bootstrap&amp;quot; the
code.&lt;/p&gt;
&lt;p&gt;At the end, I fixed the issue by removing the now unused &lt;tt class="docutils literal"&gt;_weakref&lt;/tt&gt; import in
&lt;tt class="docutils literal"&gt;importlib._bootstrap_external&lt;/tt&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/83d46e0622d2efdf5f3bf8bf8904d0dcb55fc322"&gt;commit&lt;/a&gt;).
The fix also avoids importing an extension module twice.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="convert-abc-static-types-to-heap-types"&gt;
&lt;h2&gt;Convert _abc static types to heap types&lt;/h2&gt;
&lt;p&gt;In April 2020, the static types of the &lt;tt class="docutils literal"&gt;_abc&lt;/tt&gt; extension module were converted
to heap types in &lt;a class="reference external" href="https://bugs.python.org/issue40077"&gt;bpo-40077&lt;/a&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/53e4c91725083975598350877e2ed8e2d0194114"&gt;commit&lt;/a&gt;) and
test_threading started to leak:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test -R 3:3 test_threading
test_threading leaked [19, 19, 19] references, sum=57
&lt;/pre&gt;
&lt;p&gt;I created &lt;a class="reference external" href="https://bugs.python.org/issue40149"&gt;bpo-40149&lt;/a&gt; to track the leak.&lt;/p&gt;
&lt;div class="section" id="objects-hold-a-reference-to-heap-types"&gt;
&lt;h3&gt;Objects hold a reference to heap types&lt;/h3&gt;
&lt;p&gt;In March 2019, the &lt;tt class="docutils literal"&gt;PyObject_Init()&lt;/tt&gt; function was modified in &lt;a class="reference external" href="https://bugs.python.org/issue35810"&gt;bpo-35810&lt;/a&gt; to keep a strong reference (&lt;tt class="docutils literal"&gt;INCREF&lt;/tt&gt;)
to the type if the type is a heap type
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/364f0b0f19cc3f0d5e63f571ec9163cf41c62958"&gt;commit&lt;/a&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
+    if (PyType_GetFlags(tp) &amp;amp; Py_TPFLAGS_HEAPTYPE) {
+        Py_INCREF(tp);
+    }
&lt;/pre&gt;
&lt;p&gt;I opened &lt;a class="reference external" href="https://bugs.python.org/issue40217"&gt;bpo-40217: The garbage collector doesn't take in account that objects
of heap allocated types hold a strong reference to their type&lt;/a&gt; to discuss the regression
(the test_threading leak).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="first-workaround-not-merged-force-a-second-garbage-collection"&gt;
&lt;h3&gt;First workaround (not merged): force a second garbage collection&lt;/h3&gt;
&lt;p&gt;While analysing test_threading regression leak, I identified a first
workaround: add a second &lt;tt class="docutils literal"&gt;_PyGC_CollectNoFail()&lt;/tt&gt; call in
&lt;tt class="docutils literal"&gt;finalize_interp_clear()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;It was only a workaround which helped to understand the issue, it was not
merged.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="first-fix-merged-abc-data-traverse"&gt;
&lt;h3&gt;First fix (merged): abc_data_traverse()&lt;/h3&gt;
&lt;p&gt;I merged a first fix: add a traverse function to the &lt;tt class="docutils literal"&gt;_abc._abc_data&lt;/tt&gt; type
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/9cc3ebd7e04cb645ac7b2f372eaafa7464e16b9c"&gt;commit&lt;/a&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
+static int
+abc_data_traverse(_abc_data *self, visitproc visit, void *arg)
+{
+    Py_VISIT(self-&amp;gt;_abc_registry);
+    Py_VISIT(self-&amp;gt;_abc_cache);
+    Py_VISIT(self-&amp;gt;_abc_negative_cache);
+    return 0;
+}
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="second-workaround-not-merged-visit-the-type-in-abc-data-traverse"&gt;
&lt;h3&gt;Second workaround (not merged): visit the type in abc_data_traverse()&lt;/h3&gt;
&lt;p&gt;A second workaround was identified: add &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Py_VISIT(Py_TYPE(self));&lt;/span&gt;&lt;/tt&gt; to
the new &lt;tt class="docutils literal"&gt;abc_data_traverse()&lt;/tt&gt; function.&lt;/p&gt;
&lt;p&gt;Again, it was only a workaround which helped to understand the issue, but it
was not merged.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="second-fix-merged-call-py-visit-py-type-self-automatically"&gt;
&lt;h3&gt;Second fix (merged): call Py_VISIT(Py_TYPE(self)) automatically&lt;/h3&gt;
&lt;p&gt;20 days after I opened &lt;a class="reference external" href="https://bugs.python.org/issue40217"&gt;bpo-40217&lt;/a&gt;,
&lt;strong&gt;Pablo Galindo&lt;/strong&gt; modified &lt;tt class="docutils literal"&gt;PyType_FromSpec()&lt;/tt&gt; to add a wrapper around the
traverse function of heap types to ensure that &lt;tt class="docutils literal"&gt;Py_VISIT(Py_TYPE(self))&lt;/tt&gt; is
always called (&lt;a class="reference external" href="https://github.com/python/cpython/commit/0169d3003be3d072751dd14a5c84748ab63a249f"&gt;commit&lt;/a&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="last-fix-merged-fix-every-traverse-function"&gt;
&lt;h3&gt;Last fix (merged): fix every traverse function&lt;/h3&gt;
&lt;p&gt;In May 2020, &lt;strong&gt;Pablo Galindo&lt;/strong&gt; changed his mind. He reverted his
&lt;tt class="docutils literal"&gt;PyType_FromSpec()&lt;/tt&gt; change and instead fixed traverse function of heap types
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/1cf15af9a6f28750f37b08c028ada31d38e818dd"&gt;commit&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;At the end, &lt;tt class="docutils literal"&gt;abc_data_traverse()&lt;/tt&gt; calls &lt;tt class="docutils literal"&gt;Py_VISIT(Py_TYPE(self))&lt;/tt&gt;. The
second &amp;quot;workaround&amp;quot; was the correct fix!&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="convert-signal-to-multiphase-init"&gt;
&lt;h2&gt;Convert _signal to multiphase init&lt;/h2&gt;
&lt;p&gt;In September 2020, &lt;strong&gt;Mohamed Koubaa&lt;/strong&gt; ported the &lt;tt class="docutils literal"&gt;_signal&lt;/tt&gt; module to the
multiphase initialization API (PEP 489) in &lt;a class="reference external" href="https://bugs.python.org/issue1635741"&gt;bpo-1635741&lt;/a&gt; (&lt;a class="reference external" href="https://github.com/python/cpython/commit/71d1bd9569c8a497e279f2fea6fe47cd70a87ea3"&gt;commit 71d1bd95&lt;/a&gt;)
and test_interpreters started to leak:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test -R 3:3 test_interpreters
test_interpreters leaked [237, 237, 237] references, sum=711
&lt;/pre&gt;
&lt;p&gt;I created &lt;a class="reference external" href="https://bugs.python.org/issue41713"&gt;bpo-41713&lt;/a&gt; to track the
regression. Since I failed to find a simple fix, I started by reverting the
change which caused Refleak buildbots to fail (&lt;a class="reference external" href="https://github.com/python/cpython/commit/4b8032e5a4994a7902076efa72fca1e2c85d8b7f"&gt;commit&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;I had to refactor the &lt;tt class="docutils literal"&gt;_signal&lt;/tt&gt; extension module code with multiple commits
to fix all bugs.&lt;/p&gt;
&lt;p&gt;The first fix was to remove the &lt;tt class="docutils literal"&gt;IntHandler&lt;/tt&gt; variable: there was no need to
keep it alive, it was only needed once in &lt;tt class="docutils literal"&gt;signal_module_exec()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;The second fix is to close the Windows event at exit:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
+ #ifdef MS_WINDOWS
+     if (sigint_event != NULL) {
+         CloseHandle(sigint_event);
+         sigint_event = NULL;
+     }
+ #endif
&lt;/pre&gt;
&lt;p&gt;The last fix, the most important, is to clear the strong reference to old
Python signal handlers when &lt;tt class="docutils literal"&gt;signal_module_exec()&lt;/tt&gt; is called more than once:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
// If signal_module_exec() is called more than one, we must
// clear the strong reference to the previous function.
Py_XSETREF(Handlers[signum].func, Py_NewRef(func));
&lt;/pre&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;_signal&lt;/tt&gt; module is not well isolated for subinterpreters yet, but at
least it no longer leaks.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="per-interpreter-ast-state"&gt;
&lt;h2&gt;Per-interpreter _ast state&lt;/h2&gt;
&lt;p&gt;In September 2019, the &lt;tt class="docutils literal"&gt;_ast&lt;/tt&gt; extension module was converted to PEP 384
(stable ABI) in &lt;a class="reference external" href="https://bugs.python.org/issue38113"&gt;bpo-38113&lt;/a&gt; (&lt;a class="reference external" href="https://github.com/python/cpython/commit/ac46eb4ad6662cf6d771b20d8963658b2186c48c"&gt;commit&lt;/a&gt;):
the AST state moves into a module state.&lt;/p&gt;
&lt;p&gt;This change caused 3 different bugs including crashes (&lt;a class="reference external" href="https://bugs.python.org/issue41194"&gt;bpo-41194&lt;/a&gt;, &lt;a class="reference external" href="https://bugs.python.org/issue41261"&gt;bpo-41261&lt;/a&gt;, &lt;a class="reference external" href="https://bugs.python.org/issue41631"&gt;bpo-41631&lt;/a&gt;). The issue is complex since there are
public C APIs which require to access AST types, whereas it became possible to
have multiple &lt;tt class="docutils literal"&gt;_ast&lt;/tt&gt; extension module instances.&lt;/p&gt;
&lt;p&gt;In July 2020, I fixed the root issue in &lt;a class="reference external" href="https://bugs.python.org/issue41194"&gt;bpo-41194&lt;/a&gt; by replacing the module state with a
global state (&lt;a class="reference external" href="https://github.com/python/cpython/commit/91e1bc18bd467a13bceb62e16fbc435b33381c82"&gt;commit&lt;/a&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
static astmodulestate global_ast_state;
&lt;/pre&gt;
&lt;p&gt;A global state is bad for subinterpreters. In November 2020, I made the AST
state per-interpreter in &lt;a class="reference external" href="https://bugs.python.org/issue41796"&gt;bpo-41796&lt;/a&gt;
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/5cf4782a2630629d0978bf4cf6b6340365f449b2"&gt;commit&lt;/a&gt;
and test_ast started to leak:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test -R 3:3 test_ast
test_ast leaked [23640, 23636, 23640] references, sum=70916
&lt;/pre&gt;
&lt;p&gt;The fix is to call &lt;tt class="docutils literal"&gt;_PyAST_Fini()&lt;/tt&gt; earlier (&lt;a class="reference external" href="https://github.com/python/cpython/commit/fd957c124c44441d9c5eaf61f7af8cf266bafcb1"&gt;commit&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;Python types contain a reference to themselves in in their
&lt;tt class="docutils literal"&gt;PyTypeObject.tp_mro&lt;/tt&gt; member (the MRO tuple: Method Resolution Order).
&lt;tt class="docutils literal"&gt;_PyAST_Fini()&lt;/tt&gt; must called before the last GC collection to destroy AST
types.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;_PyInterpreterState_Clear()&lt;/tt&gt; now calls &lt;tt class="docutils literal"&gt;_PyAST_Fini()&lt;/tt&gt;. It now also
calls &lt;tt class="docutils literal"&gt;_PyWarnings_Fini()&lt;/tt&gt; on subinterpeters, not only on the main
interpreter.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="thread-lock-traverse"&gt;
&lt;h2&gt;_thread lock traverse&lt;/h2&gt;
&lt;p&gt;In December 2020, while I tried to port the &lt;tt class="docutils literal"&gt;_thread&lt;/tt&gt; extesnion module to the multiphase initialization API
(PEP 489), test_threading started to leak:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test -R 3:3 test_threading
test_threading leaked [56, 56, 56] references, sum=168
&lt;/pre&gt;
&lt;p&gt;As usual, the workaround was to force a second GC collection in &lt;tt class="docutils literal"&gt;interpreter_clear()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
     /* Last garbage collection on this interpreter */
     _PyGC_CollectNoFail(tstate);
+    _PyGC_CollectNoFail(tstate);
     _PyGC_Fini(tstate);
&lt;/pre&gt;
&lt;p&gt;It took me two days to full understand the problem. I drew reference cycles
on paper to help me to understand the problem:&lt;/p&gt;
&lt;img alt="_thread GC bug" src="https://vstinner.github.io/images/thread_gc_bug.jpg" /&gt;
&lt;p&gt;There are two cycles:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Cycle 1:&lt;ul&gt;
&lt;li&gt;at fork function&lt;/li&gt;
&lt;li&gt;-&amp;gt; __main__ module dict&lt;/li&gt;
&lt;li&gt;-&amp;gt; at fork function&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Cycle 2:&lt;ul&gt;
&lt;li&gt;_thread lock type&lt;/li&gt;
&lt;li&gt;-&amp;gt; lock type methods&lt;/li&gt;
&lt;li&gt;-&amp;gt; _thread module dict&lt;/li&gt;
&lt;li&gt;-&amp;gt; _thread local type&lt;/li&gt;
&lt;li&gt;-&amp;gt; _thread module&lt;/li&gt;
&lt;li&gt;-&amp;gt; _thread module state&lt;/li&gt;
&lt;li&gt;-&amp;gt; _thread lock type&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Moreover, there is a link between these two reference cycles: an instance of
the lock type.&lt;/p&gt;
&lt;p&gt;I fixed the issue by adding a traverse function to the lock type and add
&lt;tt class="docutils literal"&gt;Py_TPFLAGS_HAVE_GC&lt;/tt&gt; flag to the type (&lt;a class="reference external" href="https://github.com/python/cpython/commit/6104013838e181e3c698cb07316f449a0c31ea96"&gt;commit&lt;/a&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
+static int
+lock_traverse(lockobject *self, visitproc visit, void *arg)
+{
+    Py_VISIT(Py_TYPE(self));
+    return 0;
+}
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="notes-on-weird-gc-bugs"&gt;
&lt;h2&gt;Notes on weird GC bugs&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;gc.get_referents()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;gc.get_referrers()&lt;/tt&gt; can be used to check
traverse functions.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;gc.is_tracked()&lt;/tt&gt; can be used to check if the GC tracks an object.&lt;/li&gt;
&lt;li&gt;Using the &lt;tt class="docutils literal"&gt;gdb&lt;/tt&gt; debugger on &lt;tt class="docutils literal"&gt;gc_collect_main()&lt;/tt&gt; helps to see which
objects are collected. See for example the &lt;tt class="docutils literal"&gt;finalize_garbage()&lt;/tt&gt; functions
which calls finalizers on unreachable objects.&lt;/li&gt;
&lt;li&gt;The solution is usually a missing traverse functions or a missing
&lt;tt class="docutils literal"&gt;Py_VISIT()&lt;/tt&gt; in an existing traverse function.&lt;/li&gt;
&lt;li&gt;GC bugs are hard to debug :-)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Thanks &lt;strong&gt;Pablo Galindo&lt;/strong&gt; for helping me to debug all these tricky GC bugs!&lt;/p&gt;
&lt;p&gt;Thanks to everybody who are helping to better isolate subintrepreters by
converting extension modules to the multiphase initialization API (PEP 489) and
by converting dozens of static types to heap types. We made huge progresses
last months!&lt;/p&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="cpython"></category><category term="subinterpreters"></category></entry><entry><title>GIL bugfixes for daemon threads in Python 3.9</title><link href="https://vstinner.github.io/gil-bugfixes-daemon-threads-python39.html" rel="alternate"></link><published>2020-04-04T22:00:00+02:00</published><updated>2020-04-04T22:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2020-04-04:/gil-bugfixes-daemon-threads-python39.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://twitter.com/Bouletcorp/status/1241018332112998401"&gt;&lt;img alt="`#CoronaMaison by Boulet" src="https://vstinner.github.io/images/coronamaison_boulet.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;My previous article &lt;a class="reference external" href="https://vstinner.github.io/daemon-threads-python-finalization-python32.html"&gt;Daemon threads and the Python finalization in Python 3.2 and 3.3&lt;/a&gt; introduces
issues caused by daemon threads in the Python finalization and past changes to
make them work.&lt;/p&gt;
&lt;p&gt;This article is about bugfixes of the infamous GIL (Global Interpreter Lock) in
Python 3.9, between …&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://twitter.com/Bouletcorp/status/1241018332112998401"&gt;&lt;img alt="`#CoronaMaison by Boulet" src="https://vstinner.github.io/images/coronamaison_boulet.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;My previous article &lt;a class="reference external" href="https://vstinner.github.io/daemon-threads-python-finalization-python32.html"&gt;Daemon threads and the Python finalization in Python 3.2 and 3.3&lt;/a&gt; introduces
issues caused by daemon threads in the Python finalization and past changes to
make them work.&lt;/p&gt;
&lt;p&gt;This article is about bugfixes of the infamous GIL (Global Interpreter Lock) in
Python 3.9, between March 2019 and March 2020, for daemon threads during Python
finalization. Some bugs were old: up to 6 years old. Some bugs were triggered
by the on-going work on isolating subinterpreters in Python 3.9.&lt;/p&gt;
&lt;p&gt;Drawing: &lt;a class="reference external" href="https://twitter.com/Bouletcorp/status/1241018332112998401"&gt;#CoronaMaison by Boulet&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="fix-1-exit-pyeval-acquirethread-if-finalizing"&gt;
&lt;h2&gt;Fix 1: Exit PyEval_AcquireThread() if finalizing&lt;/h2&gt;
&lt;p&gt;In March 2019, &lt;strong&gt;Remy Noel&lt;/strong&gt; created &lt;a class="reference external" href="https://bugs.python.org/issue36469"&gt;bpo-36469&lt;/a&gt;: a multithreaded Python application
using 20 daemon threads hangs randomly at exit on Python 3.5:&lt;/p&gt;
&lt;blockquote&gt;
The bug happens about once every two weeks on a script that is fired more
than 10K times a day.&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Eric Snow&lt;/strong&gt; analyzed the bug and understood that it is related to daemon
threads and Python finalization. He identified that &lt;tt class="docutils literal"&gt;PyEval_AcquireLock()&lt;/tt&gt;
and &lt;tt class="docutils literal"&gt;PyEval_AcquireThread()&lt;/tt&gt; function take the GIL but don't exit the thread
if Python is finalizing.&lt;/p&gt;
&lt;p&gt;When Python is finalizing and a daemon thread takes the GIL, Python can hang
randomly.&lt;/p&gt;
&lt;p&gt;Eric created &lt;a class="reference external" href="https://bugs.python.org/issue36475"&gt;bpo-36475&lt;/a&gt; to propose to
modify &lt;tt class="docutils literal"&gt;PyEval_AcquireLock()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;PyEval_AcquireThread()&lt;/tt&gt; to also exit
the thread in this case. In April 2019, &lt;strong&gt;Joannah Nanjekye&lt;/strong&gt; fixed the issue
with &lt;a class="reference external" href="https://github.com/python/cpython/commit/f781d202a2382731b43bade845a58d28a02e9ea1"&gt;commit f781d202&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-36475: Finalize PyEval_AcquireLock() and PyEval_AcquireThread() properly (GH-12667)

PyEval_AcquireLock() and PyEval_AcquireThread() now
terminate the current thread if called while the interpreter is
finalizing, making them consistent with PyEval_RestoreThread(),
Py_END_ALLOW_THREADS, and PyGILState_Ensure().
&lt;/pre&gt;
&lt;p&gt;The fix adds &lt;tt class="docutils literal"&gt;exit_thread_if_finalizing()&lt;/tt&gt; function which exit the thread if
Python is finalizing. This function is called after each &lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; call.&lt;/p&gt;
&lt;p&gt;The fix is very similar to &lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt; fix made in 2013 (&lt;a class="reference external" href="https://github.com/python/cpython/commit/0d5e52d3469a310001afe50689f77ddba6d554d1"&gt;commit
0d5e52d3&lt;/a&gt;)
to fix &lt;a class="reference external" href="https://bugs.python.org/issue1856#msg60014"&gt;bpo-1856&lt;/a&gt; (Python crash
involving daemon threads during Python exit).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-2-pyeval-restorethread-on-freed-tstate"&gt;
&lt;h2&gt;Fix 2: PyEval_RestoreThread() on freed tstate&lt;/h2&gt;
&lt;div class="section" id="concurrent-futures-crash-on-freebsd"&gt;
&lt;h3&gt;concurrent.futures crash on FreeBSD&lt;/h3&gt;
&lt;p&gt;In December 2019, I reported &lt;a class="reference external" href="https://bugs.python.org/issue39088"&gt;bpo-39088&lt;/a&gt;:
test_concurrent_futures &lt;strong&gt;crashed randomly&lt;/strong&gt; with a coredump on AMD64 FreeBSD
Shared 3.x buildbot. In March 2020, I succeeded to reproduce the bug on FreeBSD
and I was able to debug the coredump in gdb:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
(gdb) frame
#0  0x00000000003b518c in PyEval_RestoreThread (tstate=0x801f23790) at Python/ceval.c:387
387         _PyRuntimeState *runtime = tstate-&amp;gt;interp-&amp;gt;runtime;

(gdb) p tstate-&amp;gt;interp
$3 = (PyInterpreterState *) 0xdddddddddddddddd
&lt;/pre&gt;
&lt;p&gt;The Python thread state (&lt;tt class="docutils literal"&gt;tstate&lt;/tt&gt;) was freed. In debug mode, the &amp;quot;free()&amp;quot;
function of the Python memory allocator fills the freed memory block with
&lt;tt class="docutils literal"&gt;0xDD&lt;/tt&gt; byte pattern (&lt;tt class="docutils literal"&gt;D&lt;/tt&gt; stands for dead byte) to detect usage of freed
memory.&lt;/p&gt;
&lt;p&gt;The problem is that Python finalization already freed the memory of all
PyThreadState structures, when &lt;tt class="docutils literal"&gt;PyEval_RestoreThread(tstate)&lt;/tt&gt; is called by a
daemon thread. &lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt; dereferences &lt;tt class="docutils literal"&gt;tstate&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
_PyRuntimeState *runtime = tstate-&amp;gt;interp-&amp;gt;runtime;
&lt;/pre&gt;
&lt;p&gt;This bug is a regression caused by my change:
&lt;a class="reference external" href="https://github.com/python/cpython/commit/01b1cc12e7c6a3d6a3d27ba7c731687d57aae92a"&gt;Add PyInterpreterState.runtime field&lt;/a&gt;
of &lt;a class="reference external" href="https://bugs.python.org/issue36710"&gt;bpo-36710&lt;/a&gt;. I replaced:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
void PyEval_RestoreThread(PyThreadState *tstate) {
    _PyRuntimeState *runtime = &amp;amp;_PyRuntime;
    ...
}
&lt;/pre&gt;
&lt;p&gt;with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
void PyEval_RestoreThread(PyThreadState *tstate) {
    _PyRuntimeState *runtime = tstate-&amp;gt;interp-&amp;gt;runtime;
    ...
}
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-pyeval-restorethread-for-daemon-threads"&gt;
&lt;h3&gt;Fix PyEval_RestoreThread() for daemon threads&lt;/h3&gt;
&lt;p&gt;I created &lt;a class="reference external" href="https://bugs.python.org/issue39877"&gt;bpo-39877&lt;/a&gt; to investigate
this bug. I managed to reproduce the crash on Linux with a script spawning
daemon threads which sleep randomly between 0.0 and 1.0 second, and by adding
&lt;tt class="docutils literal"&gt;sleep(1);&lt;/tt&gt; call at &lt;tt class="docutils literal"&gt;Py_RunMain()&lt;/tt&gt; exit.&lt;/p&gt;
&lt;p&gt;I wrote a &lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt; fix which access to
&lt;tt class="docutils literal"&gt;_PyRuntimeState.finalizing&lt;/tt&gt; without the GIL.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Antoine Pitrou&lt;/strong&gt; asked me to convert &lt;tt class="docutils literal"&gt;_PyRuntimeState.finalizing&lt;/tt&gt; to an
atomic variable to avoid inconsistencies in case of parallel accesses. At March
7, 2020, I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/7b3c252dc7f44d4bdc4c7c82d225ebd09c78f520"&gt;commit 7b3c252d&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-39877: _PyRuntimeState.finalizing becomes atomic (GH-18816)

Convert _PyRuntimeState.finalizing field to an atomic variable:

* Rename it to _finalizing
* Change its type to _Py_atomic_address
* Add _PyRuntimeState_GetFinalizing() and _PyRuntimeState_SetFinalizing()
  functions
* Remove _Py_CURRENTLY_FINALIZING() function: replace it with testing
  directly _PyRuntimeState_GetFinalizing() value

Convert _PyRuntimeState_GetThreadState() to static inline function.
&lt;/pre&gt;
&lt;p&gt;The day after, I pushed my fix, &lt;a class="reference external" href="https://github.com/python/cpython/commit/eb4e2ae2b8486e8ee4249218b95d94a9f0cc513e"&gt;commit eb4e2ae2&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-39877: Fix PyEval_RestoreThread() for daemon threads (GH-18811)

* exit_thread_if_finalizing() does now access directly _PyRuntime
  variable, rather than using tstate-&amp;gt;interp-&amp;gt;runtime since tstate
  can be a dangling pointer after Py_Finalize() has been called.
* exit_thread_if_finalizing() is now called *before* calling
  take_gil(). _PyRuntime.finalizing is an atomic variable,
  we don't need to hold the GIL to access it.
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;exit_thread_if_finalizing()&lt;/tt&gt; is now called &lt;strong&gt;before&lt;/strong&gt; &lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; to
ensure that &lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; cannot be called with an invalid Python thread state
(&lt;tt class="docutils literal"&gt;tstate&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;I commented &lt;em&gt;naively&lt;/em&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Ok, it should now be fixed.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="clear-python-thread-states-earlier-my-first-failed-attempt-in-2013"&gt;
&lt;h2&gt;Clear Python thread states earlier: my first failed attempt in 2013&lt;/h2&gt;
&lt;p&gt;In 2013, I opened &lt;a class="reference external" href="https://bugs.python.org/issue19466"&gt;bpo-19466&lt;/a&gt; to clear
earlier the Python thread state of threads during Python finalization. My
intent was to display &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; warnings of daemon threads as well.
In November 2013, I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/45956b9a33af634a2919ade64c1dd223ab2d5235"&gt;commit 45956b9a&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Close #19466: Clear the frames of daemon threads earlier during the Python
shutdown to call objects destructors. So &amp;quot;unclosed file&amp;quot; resource warnings
are now correctly emitted for daemon threads.
&lt;/pre&gt;
&lt;p&gt;Later, I discovered a crash in the the garbage collector while trying to
reproduce a race condition in asyncio: I created &lt;a class="reference external" href="https://bugs.python.org/issue20526"&gt;bpo-20526&lt;/a&gt;. Sadly, this bug was trigger by my
previous change. I decided that it's safer to revert my change.&lt;/p&gt;
&lt;p&gt;By the way, when I looked again at &lt;a class="reference external" href="https://bugs.python.org/issue20526"&gt;bpo-20526&lt;/a&gt;, I was able to reproduce again the
garbage collector bug, likely because of recent changes. With the help of
&lt;strong&gt;Pablo Galindo Salgado&lt;/strong&gt;, Pablo and me &lt;a class="reference external" href="https://bugs.python.org/issue20526#msg364851"&gt;understood the root issue&lt;/a&gt;.  At March 24, 2020, I pushed
a fix (&lt;a class="reference external" href="https://github.com/python/cpython/commit/5804f878e779712e803be927ca8a6df389d82cdf"&gt;commit&lt;/a&gt;)
to finally fix this 6 years old bug! The fix removes the following line from
&lt;tt class="docutils literal"&gt;PyThreadState_Clear()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Py_CLEAR(tstate-&amp;gt;frame);
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-3-exit-also-take-gil-at-exit-point-if-finalizing"&gt;
&lt;h2&gt;Fix 3: Exit also take_gil() at exit point if finalizing&lt;/h2&gt;
&lt;p&gt;After fixing &lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt;, I decided to attempt again to fix
&lt;a class="reference external" href="https://bugs.python.org/issue19466"&gt;bpo-19466&lt;/a&gt; (clear earlier Python thread
states). Sadly, I discovered that my &lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt; fix
&lt;strong&gt;introduced a race condition&lt;/strong&gt;!&lt;/p&gt;
&lt;p&gt;While the main thread finalizes Python, daemon threads can be waiting for the
GIL: they block in &lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt;. When the main thread releases the GIL during
finalization, a daemon thread take the GIL instead of exiting. Daemon threads
only check if they must exit &lt;strong&gt;before&lt;/strong&gt; trying to take the GIL.&lt;/p&gt;
&lt;p&gt;The solution is to call &lt;tt class="docutils literal"&gt;exit_thread_if_finalizing()&lt;/tt&gt; twice in
&lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt;: before &lt;strong&gt;and&lt;/strong&gt; after taking the GIL.&lt;/p&gt;
&lt;p&gt;In March 2020, I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/9229eeee105f19705f72e553cf066751ac47c7b7"&gt;commit 9229eeee&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-39877: take_gil() checks tstate_must_exit() twice (GH-18890)

take_gil() now also checks tstate_must_exit() after acquiring
the GIL: exit the thread if Py_Finalize() has been called.
&lt;/pre&gt;
&lt;p&gt;I commented:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I ran multiple times &lt;tt class="docutils literal"&gt;daemon_threads_exit.py&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;slow_exit.patch&lt;/tt&gt;:
no crash.&lt;/p&gt;
&lt;p&gt;I also ran multiple times &lt;tt class="docutils literal"&gt;stress.py&lt;/tt&gt; + &lt;tt class="docutils literal"&gt;sleep_at_exit.patch&lt;/tt&gt; of
bpo-37135: no crash.&lt;/p&gt;
&lt;p&gt;And I tested &lt;tt class="docutils literal"&gt;asyncio_gc.py&lt;/tt&gt; of bpo-19466: no crash neither.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Python finalization now looks reliable.&lt;/strong&gt; I'm not sure if it's &amp;quot;more&amp;quot;
reliable than previously, but at least, I cannot get a crash anymore, even
after bpo-19466 has been fixed (clear Python thread states of daemon
threads earlier).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Funny fact, in June 2019, &lt;strong&gt;Eric Snow&lt;/strong&gt; added a very similar bug in &lt;a class="reference external" href="https://bugs.python.org/issue36818"&gt;bpo-36818&lt;/a&gt; with &lt;a class="reference external" href="https://github.com/python/cpython/commit/396e0a8d9dc65453cb9d53500d0a620602656cfe"&gt;commit 396e0a8d&lt;/a&gt;:
test_multiprocessing_spawn segfault on FreeBSD (&lt;a class="reference external" href="https://bugs.python.org/issue37135"&gt;bpo-37135&lt;/a&gt;). I reverted his change to fix the
issue. At this time, I didn't have the bandwidth to investigate the root cause.
I just reverted Eric's change.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-4-exit-take-gil-while-waiting-for-the-gil-if-finalizing"&gt;
&lt;h2&gt;Fix 4: Exit take_gil() while waiting for the GIL if finalizing&lt;/h2&gt;
&lt;p&gt;While I was working on moving pending calls from &lt;tt class="docutils literal"&gt;_PyRuntime&lt;/tt&gt; to
&lt;tt class="docutils literal"&gt;PyInterpreterState&lt;/tt&gt;, &lt;a class="reference external" href="https://bugs.python.org/issue39984"&gt;bpo-3998&lt;/a&gt;, I had
another bug.&lt;/p&gt;
&lt;p&gt;At March 18, 2020, I pushed a &lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; fix to avoid accessing &lt;tt class="docutils literal"&gt;tstate&lt;/tt&gt;
if Python is finalizing, &lt;a class="reference external" href="https://github.com/python/cpython/commit/29356e03d4f8800b04f799efe7a10e3ce8b16f61"&gt;commit 29356e03&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-39877: Fix take_gil() for daemon threads (GH-19054)

bpo-39877, bpo-39984: If the thread must exit, don't access tstate to
prevent a potential crash: tstate memory has been freed.
&lt;/pre&gt;
&lt;p&gt;And while working on the inefficient signal handling in multithreaded
applications (&lt;a class="reference external" href="https://bugs.python.org/issue40010"&gt;bpo-40010&lt;/a&gt;), I discovered
that the previous fix was not enough!&lt;/p&gt;
&lt;p&gt;At March 19, 2020, I pushed a &lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; fix to exit while &lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt;
is waiting for the GIL if Python is finalizing, &lt;a class="reference external" href="https://github.com/python/cpython/commit/a36adfa6bbf5e612a4d4639124502135690899b8"&gt;commit a36adfa6&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-39877: 4th take_gil() fix for daemon threads (GH-19080)

bpo-39877, bpo-40010: Add a third tstate_must_exit() check in
take_gil() to prevent using tstate which has been freed.
&lt;/pre&gt;
&lt;p&gt;I can only hope that this fix is the last one to fix all corner cases with
daemon threads in &lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; (&lt;a class="reference external" href="https://bugs.python.org/issue39877"&gt;bpo-39877&lt;/a&gt;)!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="summary-of-gil-bugfixes"&gt;
&lt;h2&gt;Summary of GIL bugfixes&lt;/h2&gt;
&lt;p&gt;The GIL got 5 main bugfixes for daemon threads and Python finalization:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;May 2011, &lt;strong&gt;Antoine Pitrou&lt;/strong&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/0d5e52d3469a310001afe50689f77ddba6d554d1"&gt;commit 0d5e52d3&lt;/a&gt;:
&lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; exits if finalizing &lt;strong&gt;after&lt;/strong&gt; taking the GIL (1 check)&lt;/li&gt;
&lt;li&gt;April 2019, &lt;strong&gt;Joannah Nanjekye&lt;/strong&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/f781d202a2382731b43bade845a58d28a02e9ea1"&gt;commit f781d202&lt;/a&gt;:
PyEval_AcquireLock() and PyEval_AcquireThread() also exit if Python is finalizing&lt;/li&gt;
&lt;li&gt;March 8, 2020, &lt;strong&gt;Victor Stinner&lt;/strong&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/eb4e2ae2b8486e8ee4249218b95d94a9f0cc513e"&gt;commit eb4e2ae2&lt;/a&gt;:
&lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; exits if finalizing &lt;strong&gt;before&lt;/strong&gt; taking the GIL (1 check)&lt;/li&gt;
&lt;li&gt;March 9, 2020, &lt;strong&gt;Victor Stinner&lt;/strong&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/9229eeee105f19705f72e553cf066751ac47c7b7"&gt;commit 9229eeee&lt;/a&gt;:
&lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; exits if finalizing &lt;strong&gt;before and after&lt;/strong&gt; taking the GIL (2 checks)&lt;/li&gt;
&lt;li&gt;March 19, 2020, &lt;strong&gt;Victor Stinner&lt;/strong&gt;,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/a36adfa6bbf5e612a4d4639124502135690899b8"&gt;commit a36adfa6&lt;/a&gt;:
&lt;tt class="docutils literal"&gt;take_gil()&lt;/tt&gt; exits if finalizing &lt;strong&gt;before, while, and after&lt;/strong&gt; taking the GIL (3 checks)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="cpython"></category><category term="subinterpreters"></category></entry><entry><title>Threading shutdown race condition</title><link href="https://vstinner.github.io/threading-shutdown-race-condition.html" rel="alternate"></link><published>2020-04-03T20:00:00+02:00</published><updated>2020-04-03T20:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2020-04-03:/threading-shutdown-race-condition.html</id><summary type="html">&lt;p&gt;This article is about a race condition in threading shutdown that I fixed in
Python 3.9 in March 2019. I also forbid spawning daemon threads in
subinterpreters to fix another related bug.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://twitter.com/neeljulien/status/1240292383369150464"&gt;&lt;img alt="#CoronaMaison by Julien Neel" src="https://vstinner.github.io/images/coronamaison_jneel.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Drawing: &lt;a class="reference external" href="https://twitter.com/neeljulien/status/1240292383369150464"&gt;#CoronaMaison by Julien Neel&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="race-condition-in-threading-shutdown"&gt;
&lt;h2&gt;Race condition in threading shutdown&lt;/h2&gt;
&lt;div class="section" id="random-test-failure-noticed-on-freebsd-buildbot"&gt;
&lt;h3&gt;Random test failure noticed on FreeBSD buildbot …&lt;/h3&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;This article is about a race condition in threading shutdown that I fixed in
Python 3.9 in March 2019. I also forbid spawning daemon threads in
subinterpreters to fix another related bug.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://twitter.com/neeljulien/status/1240292383369150464"&gt;&lt;img alt="#CoronaMaison by Julien Neel" src="https://vstinner.github.io/images/coronamaison_jneel.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Drawing: &lt;a class="reference external" href="https://twitter.com/neeljulien/status/1240292383369150464"&gt;#CoronaMaison by Julien Neel&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="race-condition-in-threading-shutdown"&gt;
&lt;h2&gt;Race condition in threading shutdown&lt;/h2&gt;
&lt;div class="section" id="random-test-failure-noticed-on-freebsd-buildbot"&gt;
&lt;h3&gt;Random test failure noticed on FreeBSD buildbot&lt;/h3&gt;
&lt;p&gt;In March 2019, I noticed that &lt;tt class="docutils literal"&gt;test_threading.test_threads_join_2()&lt;/tt&gt; was
killed by SIGABRT on the FreeBSD CURRENT buildbot, &lt;a class="reference external" href="https://bugs.python.org/issue36402"&gt;bpo-36402&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Fatal Python error: Py_EndInterpreter: not the last thread
&lt;/pre&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;test_threads_join_2()&lt;/tt&gt; test &lt;strong&gt;failed randomly&lt;/strong&gt; on buildbots when tests
were &lt;strong&gt;run in parallel&lt;/strong&gt;, but test_threading &lt;strong&gt;passed&lt;/strong&gt; when it was &lt;strong&gt;re-run
sequentially&lt;/strong&gt;.  Such failure was silently ignored, since the build was seen
overall as a success.&lt;/p&gt;
&lt;p&gt;The test &lt;tt class="docutils literal"&gt;test_threading.test_threads_join_2()&lt;/tt&gt; was added by in 2013 &lt;a class="reference external" href="https://github.com/python/cpython/commit/7b4769937fb612d576b6829c3b834f3dd31752f1"&gt;commit
7b476993&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In 2016, I already reported the same test failure: &lt;a class="reference external" href="https://bugs.python.org/issue27791"&gt;bpo-27791&lt;/a&gt; (same test, also on FreeBSD). And
Christian Heimes reported a similar issue: &lt;a class="reference external" href="https://bugs.python.org/issue28084"&gt;bpo-28084&lt;/a&gt;. I simply closed these issues because I
only saw the failure once in 4 months and &lt;strong&gt;I didn't have access to FreeBSD to
attempt to reproduce the crash&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="reproduce-the-race-condition"&gt;
&lt;h3&gt;Reproduce the race condition&lt;/h3&gt;
&lt;p&gt;In 2019, I had a FreeBSD VM to attempt to reproduce the bug locally.&lt;/p&gt;
&lt;p&gt;In June 2019, I found a reliable way to reproduce the bug by &lt;a class="reference external" href="https://github.com/python/cpython/pull/13889/files"&gt;adding random
sleeps to the test&lt;/a&gt;. With
this patch, I was also able to reproduce the bug on Linux. &lt;strong&gt;I am way more
comfortable to debug an issue on Linux&lt;/strong&gt; with my favorite debugging tools!&lt;/p&gt;
&lt;p&gt;I identified a race condition in the Python finalization. I also understood
that the bug was not specific to subinterpreters:&lt;/p&gt;
&lt;blockquote&gt;
The test shows the bug using subinterpreters (Py_EndInterpreter), but
&lt;strong&gt;the bug also exists in Py_Finalize()&lt;/strong&gt; which has the same race condition.&lt;/blockquote&gt;
&lt;p&gt;I wrote a patch for &lt;tt class="docutils literal"&gt;Py_Finalize()&lt;/tt&gt; to help me to reproduce the bug without
subinterpreters:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
+    if (tstate != interp-&amp;gt;tstate_head || tstate-&amp;gt;next != NULL) {
+        Py_FatalError(&amp;quot;Py_EndInterpreter: not the last thread&amp;quot;);
+    }
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h3&gt;threading._shutdown() race condition&lt;/h3&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;threading._shutdown()&lt;/tt&gt; uses &lt;tt class="docutils literal"&gt;threading.enumerate()&lt;/tt&gt; which iterates on
&lt;tt class="docutils literal"&gt;threading._active&lt;/tt&gt; dictionary.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;threading.Thread&lt;/tt&gt; registers itself into &lt;tt class="docutils literal"&gt;threading._active&lt;/tt&gt; when the
thread starts. It unregisters itself from &lt;tt class="docutils literal"&gt;threading._active&lt;/tt&gt; when it
completes.&lt;/p&gt;
&lt;p&gt;The bug occurs when the thread is unregistered whereas the underlying native
thread is still running and &lt;strong&gt;the Python thread state is not deleted yet&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;_thread._set_sentinel()&lt;/tt&gt; creates a lock and registers a
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tstate-&amp;gt;on_delete&lt;/span&gt;&lt;/tt&gt; callback to release this lock. It's called by
&lt;tt class="docutils literal"&gt;threading.Thread&lt;/tt&gt; when the thread starts to set
&lt;tt class="docutils literal"&gt;threading.Thread._tstate_lock&lt;/tt&gt;.  This lock is used by
&lt;tt class="docutils literal"&gt;threading.Thread.join()&lt;/tt&gt; method to wait until the thread completes.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;_thread.start_new_thread()&lt;/tt&gt; calls the C function &lt;tt class="docutils literal"&gt;t_bootstrap()&lt;/tt&gt; which
ends with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
tstate-&amp;gt;interp-&amp;gt;num_threads--;
PyThreadState_Clear(tstate);
PyThreadState_DeleteCurrent();
PyThread_exit_thread();
&lt;/pre&gt;
&lt;p&gt;When the native thread completes, &lt;tt class="docutils literal"&gt;_PyThreadState_DeleteCurrent()&lt;/tt&gt; is called:
it calls &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tstate-&amp;gt;on_delete()&lt;/span&gt;&lt;/tt&gt; callback which releases
&lt;tt class="docutils literal"&gt;threading.Thread._tstate_lock&lt;/tt&gt; lock.&lt;/p&gt;
&lt;p&gt;The root issue is that:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;threading._shutdown()&lt;/tt&gt; rely on &lt;tt class="docutils literal"&gt;threading._alive&lt;/tt&gt; dictionary&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_EndInterpreter()&lt;/tt&gt; rely on the interpreter linked list of Python thread
states of the interpreter (&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;interp-&amp;gt;tstate_head&lt;/span&gt;&lt;/tt&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The lock on Python thread states (&lt;tt class="docutils literal"&gt;threading.Thread._tstate_lock&lt;/tt&gt;) and
&lt;tt class="docutils literal"&gt;PyThreadState.on_delete&lt;/tt&gt; callback were added in 2013 by &lt;strong&gt;Antoine Pitrou&lt;/strong&gt;
to Python 3.4, &lt;a class="reference external" href="https://github.com/python/cpython/commit/7b4769937fb612d576b6829c3b834f3dd31752f1"&gt;commit 7b476993&lt;/a&gt;
of &lt;a class="reference external" href="https://bugs.python.org/issue18808"&gt;bpo-18808&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Issue #18808: Thread.join() now waits for the underlying thread state
to be destroyed before returning. This prevents unpredictable aborts
in Py_EndInterpreter() when some non-daemon threads are still running.
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-threading-shutdown"&gt;
&lt;h3&gt;Fix threading._shutdown()&lt;/h3&gt;
&lt;p&gt;Finally in June 2019, I fixed the race condition in &lt;tt class="docutils literal"&gt;threading._shutdown()&lt;/tt&gt;
with &lt;a class="reference external" href="https://github.com/python/cpython/commit/468e5fec8a2f534f1685d59da3ca4fad425c38dd"&gt;commit 468e5fec&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-36402: Fix threading._shutdown() race condition (GH-13948)

Fix a race condition at Python shutdown when waiting for threads.  Wait
until the Python thread state of all non-daemon threads get deleted
(join all non-daemon threads), rather than just wait until Python
threads complete.
&lt;/pre&gt;
&lt;p&gt;The fix is to modify &lt;tt class="docutils literal"&gt;threading._shutdown()&lt;/tt&gt; to wait until the Python thread
state of all non-daemon threads get deleted, rather than calling the &lt;tt class="docutils literal"&gt;join()&lt;/tt&gt;
method of all non-daemon threads. The &lt;tt class="docutils literal"&gt;join()&lt;/tt&gt; does not ensure that the
Python thread state is deleted.&lt;/p&gt;
&lt;p&gt;The Python finalization calls &lt;tt class="docutils literal"&gt;threading._shutdown()&lt;/tt&gt; to wait until all
threads complete. Only non-daemon threads are awaited: daemon threads can
continue to run after &lt;tt class="docutils literal"&gt;threading._shutdown()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;Py_EndInterpreter()&lt;/tt&gt; requires that the Python thread states of all threads
have been deleted. &lt;strong&gt;What about daemon threads?&lt;/strong&gt; More about that in the next
section ;-)&lt;/p&gt;
&lt;p&gt;Note: This change introduced a regression (memory leak) which is not fixed yet:
&lt;a class="reference external" href="https://bugs.python.org/issue37788"&gt;bpo-37788&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="forbid-daemon-threads-in-subinterpreters"&gt;
&lt;h2&gt;Forbid daemon threads in subinterpreters&lt;/h2&gt;
&lt;p&gt;In June 2019, while fixing the threading shutdown, I found a reliable way to
trigger a bug with daemon threads when a subinterpreter is finalized:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Fatal Python error: Py_EndInterpreter: not the last thread
&lt;/pre&gt;
&lt;p&gt;By design, daemon threads can run after a Python interpreter is finalized,
whereas &lt;tt class="docutils literal"&gt;Py_EndInterpreter()&lt;/tt&gt; requires that all threads completed.&lt;/p&gt;
&lt;p&gt;I reported &lt;a class="reference external" href="https://bugs.python.org/issue37266"&gt;bpo-37266&lt;/a&gt; to propose to
forbid the creation of daemon threads in subinterpreters. I fixed the issue
with &lt;a class="reference external" href="https://github.com/python/cpython/commit/066e5b1a917ec2134e8997d2cadd815724314252"&gt;commit 066e5b1a&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-37266: Daemon threads are now denied in subinterpreters (GH-14049)

In a subinterpreter, spawning a daemon thread now raises an
exception. Daemon threads were never supported in subinterpreters.
Previously, the subinterpreter finalization crashed with a Pyton
fatal error if a daemon thread was still running.
&lt;/pre&gt;
&lt;p&gt;The change adds this check to &lt;tt class="docutils literal"&gt;Thread.start()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if self.daemon and not _is_main_interpreter():
    raise RuntimeError(&amp;quot;daemon thread are not supported &amp;quot;
                       &amp;quot;in subinterpreters&amp;quot;)
&lt;/pre&gt;
&lt;p&gt;I commented:&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;Daemon threads must die.&lt;/strong&gt; That's a first step towards their death!&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Antoine Pitrou&lt;/strong&gt; created &lt;a class="reference external" href="https://bugs.python.org/issue39812"&gt;bpo-39812: Avoid daemon threads in
concurrent.futures&lt;/a&gt; as a follow-up.&lt;/p&gt;
&lt;p&gt;In February 2020, when rebuilding Fedora Rawhide with Python 3.9, &lt;strong&gt;Miro
Hrončok&lt;/strong&gt; of my team noticed that my change &lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1792062"&gt;broke the python-jep project&lt;/a&gt;. I &lt;a class="reference external" href="https://github.com/ninia/jep/issues/229"&gt;reported the bug
upstream&lt;/a&gt;. It has been fixed by
using regular threads, rather than daemon threads: &lt;a class="reference external" href="https://github.com/ninia/jep/commit/a31d461c6cacc96de68d68320eaa83e19a45d0cc"&gt;commit&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;A random failure on a FreeBSD buildbot was hiding a severe race condition in
the threading shutdown. The bug existed since 2013, but was silently ignored
since the test passed when re-run.&lt;/p&gt;
&lt;p&gt;The race condition was that that the threading shutdown didn't ensure that the
Python thread state of all non-daemon threads are deleted, whereas it is a
&lt;tt class="docutils literal"&gt;Py_EndInterpreter()&lt;/tt&gt; requirement.&lt;/p&gt;
&lt;p&gt;I fixed the threading shutdown by waiting until the Python thread state of all
non-daemon threads is deleted.&lt;/p&gt;
&lt;p&gt;I also modified &lt;tt class="docutils literal"&gt;Thread.start()&lt;/tt&gt; to forbid spawning daemon threads in Python
subinterpreters to fix a related issue.&lt;/p&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="cpython"></category><category term="subinterpreters"></category></entry><entry><title>Daemon threads and the Python finalization in Python 3.2 and 3.3</title><link href="https://vstinner.github.io/daemon-threads-python-finalization-python32.html" rel="alternate"></link><published>2020-03-26T22:00:00+01:00</published><updated>2020-03-26T22:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2020-03-26:/daemon-threads-python-finalization-python32.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://twitter.com/LuppiChan/status/1240346448606171136"&gt;&lt;img alt="#CoronaMaison by Luppi" src="https://vstinner.github.io/images/coronamaison_luppi.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;At exit, the Python finalization calls Python objects finalizers (the
&lt;tt class="docutils literal"&gt;__del__()&lt;/tt&gt; method) and deallocates memory.  The daemon threads are a special
kind of threads which continue to run during and after the Python finalization.
They are causing race conditions and tricky bugs in the Python finalization.&lt;/p&gt;
&lt;p&gt;This article covers bugs …&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://twitter.com/LuppiChan/status/1240346448606171136"&gt;&lt;img alt="#CoronaMaison by Luppi" src="https://vstinner.github.io/images/coronamaison_luppi.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;At exit, the Python finalization calls Python objects finalizers (the
&lt;tt class="docutils literal"&gt;__del__()&lt;/tt&gt; method) and deallocates memory.  The daemon threads are a special
kind of threads which continue to run during and after the Python finalization.
They are causing race conditions and tricky bugs in the Python finalization.&lt;/p&gt;
&lt;p&gt;This article covers bugs fixed in the Python finalization in Python 3.2 and
Python 3.3 (2009 to 2011), and a backport in Python 2.7.8 (2014).&lt;/p&gt;
&lt;p&gt;Drawing: &lt;a class="reference external" href="https://twitter.com/LuppiChan/status/1240346448606171136"&gt;#CoronaMaison by Luppi&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="daemon-threads"&gt;
&lt;h2&gt;Daemon threads&lt;/h2&gt;
&lt;p&gt;Python has a special kind of thread: &amp;quot;daemon&amp;quot; threads. The difference with
regular threads is that Python doesn't wait until daemon threads complete at
exit, whereas it waits until all regular (&amp;quot;non-daemon&amp;quot;) threads complete.
Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
import threading, time
thread = threading.Thread(target=time.sleep, args=(5.0,), daemon=False)
thread.start()
&lt;/pre&gt;
&lt;p&gt;This Python program spawns a regular thread which sleeps for 5 seconds. Python
takes 5 seconds to exit:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ time python3 sleep.py

real   0m5,047s
&lt;/pre&gt;
&lt;p&gt;If &lt;tt class="docutils literal"&gt;daemon=False&lt;/tt&gt; is replaced with &lt;tt class="docutils literal"&gt;daemon=True&lt;/tt&gt; to spawn a daemon thread
instead, Python exits immediately (57 ms):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ time python3 sleep.py

real   0m0,057s
&lt;/pre&gt;
&lt;p&gt;Note: The &lt;tt class="docutils literal"&gt;Thread.join()&lt;/tt&gt; method can be called explicitly to wait until a
daemon thread completes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="don-t-destroy-the-gil-at-exit"&gt;
&lt;h2&gt;Don't destroy the GIL at exit&lt;/h2&gt;
&lt;p&gt;In November 2009, &lt;strong&gt;Antoine Pitrou&lt;/strong&gt; implemented a new GIL (Global Interpreter
Lock) in Python 3.2: &lt;a class="reference external" href="https://github.com/python/cpython/commit/074e5ed974be65fbcfe75a4c0529dbc53f13446f"&gt;commit 074e5ed9&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In September 2010, he found a crash with daemon threads while stressing
&lt;tt class="docutils literal"&gt;test_threading&lt;/tt&gt;: &lt;a class="reference external" href="https://bugs.python.org/issue9901"&gt;bpo-9901: GIL destruction can fail&lt;/a&gt;. &lt;tt class="docutils literal"&gt;test_finalize_with_trace()&lt;/tt&gt; failed
with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Fatal Python error: pthread_mutex_destroy(gil_mutex) failed
&lt;/pre&gt;
&lt;p&gt;He pushed a fix for this crash in Python 3.2, &lt;a class="reference external" href="https://github.com/python/cpython/commit/b0b384b7c0333bf1183cd6f90c0a3f9edaadd6b9"&gt;commit b0b384b7&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Issue #9901: Destroying the GIL in Py_Finalize() can fail if some other
threads are still running.  Instead, reinitialize the GIL on a second
call to Py_Initialize().
&lt;/pre&gt;
&lt;p&gt;The Python GIL internally uses a lock. If the lock is destroyed while a daemon
thread is waiting for it, the thread can crash. The fix is to &lt;strong&gt;no longer
destroy the GIL at exit&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="exit-the-thread-in-pyeval-restorethread"&gt;
&lt;h2&gt;Exit the thread in PyEval_RestoreThread()&lt;/h2&gt;
&lt;p&gt;The Python finalization clears and deallocates the &amp;quot;Python thread state&amp;quot; of all
threads (in &lt;tt class="docutils literal"&gt;PyInterpreterState_Delete()&lt;/tt&gt;) which calls Python object
finalizers of these threads. Calling a finalizer can drop the GIL to call a
system call. For example, closing a file drops the GIL. When the GIL is
dropped, a daemon thread is awaken to take the GIL. Since the Python thread
state was just deallocated, the daemon thread crash.&lt;/p&gt;
&lt;p&gt;This bug is a race condition. It depends on which order threads are executed,
on which order objects are finalized, on which order memory is deallocated,
etc.&lt;/p&gt;
&lt;p&gt;The crash was first reported in April 2005: &lt;a class="reference external" href="https://bugs.python.org/issue1193099"&gt;bpo-1193099: Embedded python thread
crashes&lt;/a&gt;. In January 2008, &lt;strong&gt;Gregory P.
Smith&lt;/strong&gt; reported &lt;a class="reference external" href="https://bugs.python.org/issue1856#msg60014"&gt;bpo-1856: shutdown (exit) can hang or segfault with daemon
threads running&lt;/a&gt;. He wrote a
short Python program reproducing the bug: spawn 40 daemon threads which do some
I/O operations and sleep randomly between 0 ms and 5 ms in a loop.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Adam Olsen&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue1856#msg60059"&gt;proposed a solution&lt;/a&gt; (with a patch):&lt;/p&gt;
&lt;blockquote&gt;
I think &lt;strong&gt;non-main threads should kill themselves off&lt;/strong&gt; if they grab the
interpreter lock and the interpreter is tearing down. They're about to get
killed off anyway, when the process exits.&lt;/blockquote&gt;
&lt;p&gt;In May 2011, &lt;strong&gt;Antoine Pitrou&lt;/strong&gt; pushed a fix to Python 3.3 (6 years after the
first bug report) which implements this solution, &lt;a class="reference external" href="https://github.com/python/cpython/commit/0d5e52d3469a310001afe50689f77ddba6d554d1"&gt;commit 0d5e52d3&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Issue #1856: Avoid crashes and lockups when daemon threads run while the
interpreter is shutting down; instead, these threads are now killed when
they try to take the GIL.
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="pyeval-restorethread-fix-explanation"&gt;
&lt;h2&gt;PyEval_RestoreThread() fix explanation&lt;/h2&gt;
&lt;p&gt;The fix adds a new &lt;tt class="docutils literal"&gt;_Py_Finalizing&lt;/tt&gt; variable which is set by
&lt;tt class="docutils literal"&gt;Py_Finalize()&lt;/tt&gt; to the (Python thread state of the) thread which runs the
finalization.&lt;/p&gt;
&lt;p&gt;Simplified patch of the &lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt; fix:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;#64;&amp;#64; -440,6 +440,12 &amp;#64;&amp;#64; PyEval_RestoreThread()
         take_gil(tstate);
+        if (_Py_Finalizing &amp;amp;&amp;amp; tstate != _Py_Finalizing) {
+            drop_gil(tstate);
+            PyThread_exit_thread();
+        }
&lt;/pre&gt;
&lt;p&gt;If Python is finalizing (&lt;tt class="docutils literal"&gt;_Py_Finalizing&lt;/tt&gt; is not NULL) and
&lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt; is called by a thread which is not thread running
the finalization, the thread exits immediately (call
&lt;tt class="docutils literal"&gt;PyThread_exit_thread()&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt; is called when a thread takes the GIL.  Typical
example of code which drops the GIL to call a system call (close a file
descriptor, &lt;tt class="docutils literal"&gt;io.FileIO()&lt;/tt&gt; finalizer) and then takes again the GIL:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Py_BEGIN_ALLOW_THREADS
close(fd);
Py_END_ALLOW_THREADS
&lt;/pre&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;Py_BEGIN_ALLOW_THREADS&lt;/tt&gt; macro calls &lt;tt class="docutils literal"&gt;PyEval_SaveThread()&lt;/tt&gt; to drop the
GIL, and the &lt;tt class="docutils literal"&gt;Py_END_ALLOW_THREADS&lt;/tt&gt; macro calls &lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt; to
take the GIL.  Pseudo-code:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PyEval_SaveThread();     // drop the GIL
close(fd);
PyEval_RestoreThread();  // take the GIL
&lt;/pre&gt;
&lt;p&gt;With Antoine's fix, if Python is finalizing, a thread now exits immediately
when calling &lt;tt class="docutils literal"&gt;PyEval_RestoreThread()&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="revert-take-gil-backport-to-2-7"&gt;
&lt;h2&gt;Revert take_gil() backport to 2.7&lt;/h2&gt;
&lt;p&gt;In June 2014, &lt;strong&gt;Benjamin Peterson&lt;/strong&gt; (Python 2.7 release manager) backported
Antoine's change to Python 2.7: fix included in 2.7.8.&lt;/p&gt;
&lt;p&gt;Problem: the Ceph project &lt;a class="reference external" href="https://tracker.ceph.com/issues/8797"&gt;started to crash with Python 2.7.8&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In November 2014, the change was reverted in Python 2.7.9: see
&lt;a class="reference external" href="https://bugs.python.org/issue21963"&gt;bpo-21963 discussion&lt;/a&gt; for the rationale.&lt;/p&gt;
&lt;p&gt;In 2014, I already wrote:&lt;/p&gt;
&lt;blockquote&gt;
Anyway, &lt;strong&gt;daemon threads are evil&lt;/strong&gt; :-( Expecting them to exit cleanly
automatically is not good. Last time I tried to improve code to cleanup
Python at exit in Python 3.4, I also had a regression (just before the
release of Python 3.4.0): see the &lt;a class="reference external" href="https://bugs.python.org/issue21788"&gt;issue #21788&lt;/a&gt;.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Daemon threads caused crashes in the Python finalization, first noticed in
2005.&lt;/p&gt;
&lt;p&gt;Python 3.2 (released in February 2011) got a new GIL and also a bugfix for
daemon thread. Python 3.3 (released in September 2012) also got a bugfix for
daemon threads. The Python finalization became more reliable.&lt;/p&gt;
&lt;p&gt;Changing Python finalization is risky. A backport of a bugfix into Python 2.7.8
caused a regression which required to revert the bugfix in Python 2.7.9.&lt;/p&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="cpython"></category><category term="subinterpreters"></category></entry><entry><title>Python 3.7 Development Mode</title><link href="https://vstinner.github.io/python37-dev-mode.html" rel="alternate"></link><published>2020-01-16T12:00:00+01:00</published><updated>2020-01-16T12:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2020-01-16:/python37-dev-mode.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://twitter.com/guinoir/status/1217146968029331456"&gt;&lt;img alt="Ready to race" src="https://vstinner.github.io/images/ready_to_race.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;This article describes the discussion on the design of the &lt;a class="reference external" href="https://docs.python.org/dev/using/cmdline.html#id5"&gt;development mode
(-X dev)&lt;/a&gt; that I &lt;strong&gt;added
to Python 3.7&lt;/strong&gt; and how it has been implemented.&lt;/p&gt;
&lt;p&gt;The development mode enables runtime checks which are too expensive to be
enabled by default. It can be enabled by &lt;tt class="docutils literal"&gt;python3 &lt;span class="pre"&gt;-X&lt;/span&gt; dev …&lt;/tt&gt;&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://twitter.com/guinoir/status/1217146968029331456"&gt;&lt;img alt="Ready to race" src="https://vstinner.github.io/images/ready_to_race.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;This article describes the discussion on the design of the &lt;a class="reference external" href="https://docs.python.org/dev/using/cmdline.html#id5"&gt;development mode
(-X dev)&lt;/a&gt; that I &lt;strong&gt;added
to Python 3.7&lt;/strong&gt; and how it has been implemented.&lt;/p&gt;
&lt;p&gt;The development mode enables runtime checks which are too expensive to be
enabled by default. It can be enabled by &lt;tt class="docutils literal"&gt;python3 &lt;span class="pre"&gt;-X&lt;/span&gt; dev&lt;/tt&gt; command line option
or by &lt;tt class="docutils literal"&gt;PYTHONDEVMODE=1&lt;/tt&gt; environment variable.  It helps developers to spot
bugs in their code and helps them to be prepared for future Python changes.&lt;/p&gt;
&lt;p&gt;Drawing: &lt;em&gt;Ready to race, by Guillaume Singelin.&lt;/em&gt;&lt;/p&gt;
&lt;div class="section" id="email-sent-to-python-ideas"&gt;
&lt;h2&gt;Email sent to python-ideas&lt;/h2&gt;
&lt;p&gt;In March 2016, I proposed &lt;a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2016-March/039314.html"&gt;Add a developer mode to Python: -X dev command line
option&lt;/a&gt; on
the python-ideas list:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;When I develop on CPython, I'm always building Python in debug mode
using &lt;tt class="docutils literal"&gt;./configure &lt;span class="pre"&gt;--with-pydebug&lt;/span&gt;&lt;/tt&gt;. This mode enables a &lt;strong&gt;lot&lt;/strong&gt; of extra
checks which helps me to detect bugs earlier. The debug mode makes Python
much slower and so is not enabled by default.&lt;/p&gt;
&lt;p&gt;I propose to add a &amp;quot;development mode&amp;quot; to Python, to get a few checks
to detect bugs earlier: a new &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; dev&lt;/tt&gt; command line option. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
python3.6 -X dev script.py
&lt;/pre&gt;
&lt;p&gt;I propose to enable:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Show &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;ResourceWarning warnings&lt;/tt&gt;: &lt;tt class="docutils literal"&gt;python &lt;span class="pre"&gt;-Wd&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Show &lt;tt class="docutils literal"&gt;BytesWarning&lt;/tt&gt; warning: &lt;tt class="docutils literal"&gt;python &lt;span class="pre"&gt;-b&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Enable Python assertions (&lt;tt class="docutils literal"&gt;assert&lt;/tt&gt;) and set &lt;tt class="docutils literal"&gt;__debug__&lt;/tt&gt; to True:
remove (or just ignore) &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-O&lt;/span&gt;&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-OO&lt;/span&gt;&lt;/tt&gt; command line arguments&lt;/li&gt;
&lt;li&gt;faulthandler to get a Python traceback on segfault and fatal errors:
&lt;tt class="docutils literal"&gt;python &lt;span class="pre"&gt;-X&lt;/span&gt; faulthandler&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Debug hooks on Python memory allocators: &lt;tt class="docutils literal"&gt;PYTHONMALLOC=debug&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;I wrote an implementation of this development mode using &lt;tt class="docutils literal"&gt;exec()&lt;/tt&gt;. &lt;strong&gt;Ronald
Oussoren&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue26670#msg262659"&gt;commented my patch&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Why does this patch execv() the interpreter to set options? I'd expect it
to be possible to get the same result by updating the argument parsing code
in Py_Main.&lt;/blockquote&gt;
&lt;p&gt;More on that later :-) &lt;strong&gt;Marc-Andre Lemburg&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2016-March/039325.html"&gt;didn't buy the idea&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;I'm not sure whether this would make things easier for the
majority of developers&lt;/strong&gt;, e.g. someone not writing C extensions
would likely not be interested in debugging memory allocations
or segfaults, someone spending more time on numerics wouldn't
bother with bytes warnings, etc.&lt;/blockquote&gt;
&lt;p&gt;Opinion shared by &lt;strong&gt;Ethan Furman&lt;/strong&gt;, so I gave up at this point, closed my issue
and my PR.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="async-keyword-deprecationwarning-and-pep-565"&gt;
&lt;h2&gt;async keyword, DeprecationWarning and PEP 565&lt;/h2&gt;
&lt;p&gt;At November 1, 2017, Ned Deily, the Python 3.7 release release,
sent an email to python-dev: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-November/150061.html"&gt;Reminder: 12 weeks to 3.7 feature code cutoff&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;A discussion started on &lt;tt class="docutils literal"&gt;async&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;await&lt;/tt&gt; becoming keywords and how this
incompatible change was conducted. Read LWN article &lt;a class="reference external" href="https://lwn.net/Articles/740804/"&gt;Who should see Python
deprecation warnings?&lt;/a&gt; (December 2017) by
Jonathan Corbet for the whole story:&lt;/p&gt;
&lt;blockquote&gt;
In early November, one sub-thread of a big discussion on preparing for the
Python 3.7 release focused on the await and async identifiers. They will
become keywords in 3.7, meaning that any code using those names for any
other purpose will break. Nick Coghlan observed that &lt;strong&gt;Python 3.6 does not
warn&lt;/strong&gt; about the use of those names, calling it &amp;quot;a fairly major
oversight/bug&amp;quot;. &lt;strong&gt;In truth, though, Python 3.6 does emit warnings in that
case — but users rarely see them.&lt;/strong&gt;&lt;/blockquote&gt;
&lt;p&gt;The question is who should see &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt;. Long time ago, it has
been decided to hide them by default to not bother users. Users are not able to
fix them, and so it is only a source of annoyance.&lt;/p&gt;
&lt;p&gt;If the warning is displayed by default, developers can be annoyed by warnings
coming from code that they cannot easily fix, like third-party dependencies.&lt;/p&gt;
&lt;p&gt;At November 12, 2017, Nick Coghlan proposed &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0565/"&gt;PEP 565: Show DeprecationWarning
in __main__&lt;/a&gt; as a compromise:&lt;/p&gt;
&lt;blockquote&gt;
This change will mean that code entered at the interactive prompt and code
in single file scripts will revert to reporting these warnings by default,
while they will &lt;strong&gt;continue to be silenced by default for packaged code&lt;/strong&gt;
distributed as part of an importable module.&lt;/blockquote&gt;
&lt;p&gt;The PEP has been approved and implemented in Python 3.7. For example,
&lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt; is now displayed by default when running a script and in
the REPL:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat example.py
import imp

$ python3 example.py
example.py:1: DeprecationWarning: the imp module is deprecated ...
  import imp

$ python3
Python 3.7.6 (default, Dec 19 2019, 22:52:49)
&amp;gt;&amp;gt;&amp;gt; import imp
__main__:1: DeprecationWarning: the imp module is deprecated ...
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="development-mode-proposed-on-python-dev"&gt;
&lt;h2&gt;Development mode proposed on python-dev&lt;/h2&gt;
&lt;p&gt;I was not convinced that only displaying warnings in the &lt;tt class="docutils literal"&gt;__main__&lt;/tt&gt; module is
enough to help developers to fix issues in their code. A project is way larger
than just this module.&lt;/p&gt;
&lt;p&gt;I came back with my idea, now on the python-dev list: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-November/150514.html"&gt;Add a developer mode to
Python: -X dev command line option&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This mode shows &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; is all modules,
not only in the &lt;tt class="docutils literal"&gt;__main__&lt;/tt&gt; module.  In my opinion, having an opt-in mode for
developers is the best option. Python should not spam users with warnings which
are targeting developers.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;In the context of Python 3.7 incompatible changes, the feedback was way better
this time.&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="issues-with-the-python-initialization"&gt;
&lt;h2&gt;Issues with the Python initialization&lt;/h2&gt;
&lt;p&gt;When I proposed the idea, my plan was to call exec() to replace the current
process with a new process. But when I tried to implement it, it was more
tricky than expected. My first blocker issue was to remove &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-O&lt;/span&gt;&lt;/tt&gt; option from
the command line. I hate having to parse the command line: it is very fragile
and it's too easy to make mistake.&lt;/p&gt;
&lt;p&gt;So I tried to write a clean implementation: configure Python properly in
&amp;quot;development mode&amp;quot;. The first blocker issue was to implement
&lt;tt class="docutils literal"&gt;PYTHONMALLOC=debug&lt;/tt&gt;.  The C code to read and apply the Python configuration
used Python objects before the Python initialization even started. For example,
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-W&lt;/span&gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt;&lt;/tt&gt; options were stored as Python lists. It means that the Python
memory allocator was used before Python would be able to parse &lt;tt class="docutils literal"&gt;PYTHONMALLOC&lt;/tt&gt;
environment variable.&lt;/p&gt;
&lt;p&gt;Moreover, the Python configuration is quite complex. Many options are
inter-dependent. For example, the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-E&lt;/span&gt;&lt;/tt&gt; command line option ignores
environment variables with a name staring with &lt;tt class="docutils literal"&gt;PYTHON&lt;/tt&gt;: like
&lt;tt class="docutils literal"&gt;PYTHONMALLOC&lt;/tt&gt;! Python has to parse the command line before being able to
handle &lt;tt class="docutils literal"&gt;PYTHONMALLOC&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Python lists depends on the memory allocator which depends on &lt;tt class="docutils literal"&gt;PYTHONMALLOC&lt;/tt&gt;
environment variable which depends on the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-E&lt;/span&gt;&lt;/tt&gt; command line option which
depends on Python lists...&lt;/p&gt;
&lt;p&gt;In short, &lt;strong&gt;it wasn't possible to write a clean implementation of the
development mode without refactoring the Python initialization code&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="refactoring-main-c"&gt;
&lt;h2&gt;Refactoring main.c&lt;/h2&gt;
&lt;p&gt;For all these reasons, I refactored Python initialization code in &lt;tt class="docutils literal"&gt;main.c&lt;/tt&gt;,
with &lt;a class="reference external" href="https://bugs.python.org/issue32030"&gt;bpo-32030&lt;/a&gt; with two &lt;strong&gt;large&lt;/strong&gt;
changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/f7e5b56c37eb859e225e886c79c5d742c567ee95"&gt;commit f7e5b56c&lt;/a&gt;:
bpo-32030: Split Py_Main() into subfunctions&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/a7368ac6360246b1ef7f8f152963c2362d272183"&gt;commit a7368ac6&lt;/a&gt;:
bpo-32030: Enhance Py_Main()&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="add-x-dev-option"&gt;
&lt;h2&gt;Add -X dev option&lt;/h2&gt;
&lt;p&gt;Since I got enough approval by my peers (core developers), I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/ccb0442a338066bf40fe417455e5a374e5238afb"&gt;commit
ccb0442a&lt;/a&gt;
of &lt;a class="reference external" href="https://bugs.python.org/issue32043"&gt;bpo-32043&lt;/a&gt; to add the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; dev&lt;/tt&gt;
command line option. Thanks to the previous refactoring, the implementation is
less intrusive.&lt;/p&gt;
&lt;p&gt;Effects of the development mode:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Add &lt;tt class="docutils literal"&gt;default&lt;/tt&gt; warnings option. For example, display &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt;
and &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; warnings.&lt;/li&gt;
&lt;li&gt;Install &lt;a class="reference external" href="https://docs.python.org/dev/c-api/memory.html#c.PyMem_SetupDebugHooks"&gt;debug hooks on memory allocators&lt;/a&gt; as if
&lt;tt class="docutils literal"&gt;PYTHONMALLOC&lt;/tt&gt; is set to &lt;tt class="docutils literal"&gt;debug&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Enable my &lt;a class="reference external" href="https://docs.python.org/dev/library/faulthandler.html"&gt;faulthandler&lt;/a&gt; module to dump the
Python traceback on a crash.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="add-pythondevmode-environment-variable"&gt;
&lt;h2&gt;Add PYTHONDEVMODE environment variable&lt;/h2&gt;
&lt;p&gt;In a PR review, Antoine Pitrou &lt;a class="reference external" href="https://github.com/python/cpython/pull/4478#pullrequestreview-77874230"&gt;proposed&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Speaking of which, perhaps it would be nice to set those environment
variables so that child processes launched using subprocess inherit them?&lt;/blockquote&gt;
&lt;p&gt;I created &lt;a class="reference external" href="https://bugs.python.org/issue32101"&gt;bpo-32101&lt;/a&gt; to add
&lt;tt class="docutils literal"&gt;PYTHONDEVMODE&lt;/tt&gt; environment variable: &lt;a class="reference external" href="https://github.com/python/cpython/commit/5e3806f8cfd84722fc55d4299dc018ad9b0f8401"&gt;commit 5e3806f8&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Setting &lt;tt class="docutils literal"&gt;PYTHONDEVMODE=1&lt;/tt&gt; allows to also enable the development mode in
Python child processes, without having to touch their command line.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="enable-asyncio-debug-mode"&gt;
&lt;h2&gt;Enable asyncio debug mode&lt;/h2&gt;
&lt;p&gt;I created &lt;a class="reference external" href="https://bugs.python.org/issue32047"&gt;bpo-32047: asyncio: enable debug mode when -X dev is used&lt;/a&gt; and &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-November/150572.html"&gt;asked in the -X dev thread on
python-dev&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
What do you think? Is it ok to include asyncio in the global &amp;quot;developer mode&amp;quot;?&lt;/blockquote&gt;
&lt;p&gt;Antoine Pitrou didn't like the idea because asyncio debug mode was &amp;quot;quite
expensive&amp;quot;, but Yury Selivanov (one of the asyncio maintainers) and Barry
Warsaw liked the idea, so I merged my PR: &lt;a class="reference external" href="https://github.com/python/cpython/commit/44862df2eeec62adea20672b0fe2a5d3e160569e"&gt;commit 44862df2&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Antoine Pitrou created &lt;a class="reference external" href="https://bugs.python.org/issue31970"&gt;bpo-31970: asyncio debug mode is very slow&lt;/a&gt;. Hopefully, he found a way to make
asyncio debug mode more efficient by truncating tracebacks to 10 frames
(&lt;a class="reference external" href="https://github.com/python/cpython/commit/921e9432a1461bbf312c9c6dcc2b916be6c05fa0"&gt;commit 921e9432&lt;/a&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-warnings-filters"&gt;
&lt;h2&gt;Fix warnings filters&lt;/h2&gt;
&lt;p&gt;While checking warnings filters, I noticed that the development mode was hiding
some ResourceWarning warnings. I completed the documentation and fixed warnings
filters in &lt;a class="reference external" href="https://bugs.python.org/issue32089"&gt;bpo-32089&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-8-logs-close-exception"&gt;
&lt;h2&gt;Python 3.8 logs close() exception&lt;/h2&gt;
&lt;p&gt;By default, Python ignores silently &lt;tt class="docutils literal"&gt;EBADF&lt;/tt&gt; error (bad file descriptor) which
can lead to a &lt;strong&gt;severe crash&lt;/strong&gt; , &lt;a class="reference external" href="https://bugs.python.org/issue18748"&gt;bpo-18748&lt;/a&gt; (simplified gdb traceback):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Program received signal SIGABRT, Aborted.
[Switching to Thread 0xb7b0eb70 (LWP 17152)]
0xb7fe1424 in __kernel_vsyscall ()
(gdb) bt
#0  0xb7fe1424 in __kernel_vsyscall ()
#1  0xb7e4e941 in *__GI_raise (sig=6)
#2  0xb7e51d72 in *__GI_abort ()
#3  0xb7e8ae15 in __libc_message (do_abort=1, fmt=0xb7f606f5 &amp;quot;%s&amp;quot;)
#4  0xb7e8af44 in *__GI___libc_fatal (message=0xb7fc75ec
    &amp;quot;libgcc_s.so.1 must be installed for pthread_cancel to work\n&amp;quot;)
#5  0xb7fc4ffa in pthread_cancel_init ()
#6  0xb7fc509d in _Unwind_ForcedUnwind (...)
#7  0xb7fc2b98 in *__GI___pthread_unwind (buf=&amp;lt;optimized out&amp;gt;)
#8  0xb7fbcce0 in __do_cancel () at pthreadP.h:265
#9  __pthread_exit (value=0x0) at pthread_exit.c:30
...
&lt;/pre&gt;
&lt;p&gt;Notice the &lt;tt class="docutils literal"&gt;&amp;quot;libgcc_s.so.1 must be installed for pthread_cancel to work&amp;quot;&lt;/tt&gt; error
message: the glibc loads dynamically &lt;tt class="docutils literal"&gt;libgcc_s.so.1&lt;/tt&gt; library when a thread
completes, but another thread closed its file descriptor!&lt;/p&gt;
&lt;p&gt;The worst is that &lt;strong&gt;the crash is not deterministic&lt;/strong&gt;: it's a &lt;strong&gt;race condition&lt;/strong&gt;
which requires to try many times, even with an example designed to trigger the
crash!&lt;/p&gt;
&lt;p&gt;Since the &lt;tt class="docutils literal"&gt;EBADF&lt;/tt&gt; error is silently ignored, it is hard to notice or to debug
such issue. I modified the development mode in Python 3.8 to &lt;strong&gt;log close()
exceptions in io.IOBase destructor&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;It was not accepted to always log the &lt;tt class="docutils literal"&gt;close()&lt;/tt&gt; exception. So having an
opt-in development mode is a good practical compromise!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-9-checks-encoding-and-errors"&gt;
&lt;h2&gt;Python 3.9 checks encoding and errors&lt;/h2&gt;
&lt;p&gt;In June 2019, my colleague &lt;strong&gt;Miro Hrončok&lt;/strong&gt; reported &lt;a class="reference external" href="https://bugs.python.org/issue37388"&gt;bpo-37388&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I was just bit by specifying an nonexisitng error handler for
bytes.decode() without noticing.&lt;/p&gt;
&lt;p&gt;Consider this code:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;gt;&amp;gt;&amp;gt; 'a'.encode('cp1250').decode('utf-8', errors='Boom, Shaka Laka, Boom!')
'a'
&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;I modified the development mode in Python 3.9, to also check &lt;em&gt;encoding&lt;/em&gt; and
&lt;em&gt;errors&lt;/em&gt; arguments on string encoding and decoding operations, like
&lt;tt class="docutils literal"&gt;bytes.decode()&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;str.encode()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;By default, for best performance, the &lt;em&gt;errors&lt;/em&gt; argument is only checked at the
first encoding/decoding error and the &lt;em&gt;encoding&lt;/em&gt; argument is sometimes ignored
for empty strings.&lt;/p&gt;
&lt;p&gt;Having an opt-in development mode allows to enable additional debug checks at
runtime, without having to care too much about the performance overhead.&lt;/p&gt;
&lt;p&gt;Note: I love the choice of the example, &amp;quot;Boom, Shaka Laka, Boom!&amp;quot;
from the game Gruntz :-D&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="development-mode-example"&gt;
&lt;h2&gt;Development Mode Example&lt;/h2&gt;
&lt;p&gt;Even in the &lt;tt class="docutils literal"&gt;__main__&lt;/tt&gt; module with PEP 565, &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; is still not
displayed by default (PEP 565 only shows &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -c 'print(len(open(&amp;quot;README.rst&amp;quot;).readlines()))'
39
&lt;/pre&gt;
&lt;p&gt;The development mode shows the warning:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -X dev -c 'print(len(open(&amp;quot;README.rst&amp;quot;).readlines()))'
-c:1: ResourceWarning: unclosed file &amp;lt;_io.TextIOWrapper name='README.rst' mode='r' encoding='UTF-8'&amp;gt;
ResourceWarning: Enable tracemalloc to get the object allocation traceback
39
&lt;/pre&gt;
&lt;p&gt;Not closing a resource explicitly can leave a resource open for way longer than
expected. It can cause severe issues at Python exit. It is bad in CPython, but
it is even worse in PyPy. &lt;strong&gt;Closing resources explicitly makes an application
more deterministic and more reliable.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;If one of the development mode effect causes an issue, it is still possible to
override most options. For example,
&lt;tt class="docutils literal"&gt;PYTHONMALLOC=default python3 &lt;span class="pre"&gt;-X&lt;/span&gt; dev ...&lt;/tt&gt; command enables the development
mode without installing debug hooks on memory allocators.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>Pass the Python thread state explicitly</title><link href="https://vstinner.github.io/cpython-pass-tstate.html" rel="alternate"></link><published>2020-01-08T15:00:00+01:00</published><updated>2020-01-08T15:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2020-01-08:/cpython-pass-tstate.html</id><summary type="html">&lt;img alt="Python C API" src="https://vstinner.github.io/images/capi.jpg" /&gt;
&lt;div class="section" id="keeping-python-competitive"&gt;
&lt;h2&gt;Keeping Python competitive&lt;/h2&gt;
&lt;p&gt;I'm trying to find ways to make Python more efficient for many years, see for
example my discussion at the Language Summit during Pycon US 2017: &lt;a class="reference external" href="https://lwn.net/Articles/723949/"&gt;Keeping
Python competitive&lt;/a&gt; (LWN article); &lt;a class="reference external" href="https://github.com/vstinner/talks/blob/master/2017-PyconUS/summit.pdf"&gt;slides&lt;/a&gt;.
At EuroPython 2019 (Basel), I gave the keynote &amp;quot;Python Performance: Past,
Present and Future&amp;quot;: &lt;a class="reference external" href="https://github.com/vstinner/talks/blob/master/2019-EuroPython/python_performance.pdf"&gt;slides …&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;img alt="Python C API" src="https://vstinner.github.io/images/capi.jpg" /&gt;
&lt;div class="section" id="keeping-python-competitive"&gt;
&lt;h2&gt;Keeping Python competitive&lt;/h2&gt;
&lt;p&gt;I'm trying to find ways to make Python more efficient for many years, see for
example my discussion at the Language Summit during Pycon US 2017: &lt;a class="reference external" href="https://lwn.net/Articles/723949/"&gt;Keeping
Python competitive&lt;/a&gt; (LWN article); &lt;a class="reference external" href="https://github.com/vstinner/talks/blob/master/2017-PyconUS/summit.pdf"&gt;slides&lt;/a&gt;.
At EuroPython 2019 (Basel), I gave the keynote &amp;quot;Python Performance: Past,
Present and Future&amp;quot;: &lt;a class="reference external" href="https://github.com/vstinner/talks/blob/master/2019-EuroPython/python_performance.pdf"&gt;slides&lt;/a&gt;
and &lt;a class="reference external" href="https://www.youtube.com/watch?v=T6vC_LOHBJ4&amp;amp;feature=youtu.be&amp;amp;t=1875"&gt;video&lt;/a&gt;.  I
gave my vision on the Python performance and listed 3 projects to speedup
Python that I consider as realistic:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;subinterpreters: see Eric Snow's &lt;a class="reference external" href="https://github.com/ericsnowcurrently/multi-core-python/"&gt;multi-core-python&lt;/a&gt; project&lt;/li&gt;
&lt;li&gt;better C API: see &lt;a class="reference external" href="https://github.com/pyhandle/hpy"&gt;HPy (new C API)&lt;/a&gt;
and &lt;a class="reference external" href="https://pythoncapi.readthedocs.io/"&gt;pythoncapi.readthedocs.io&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;tracing garbage collector for CPython&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This article is about &lt;strong&gt;subinterpreters&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="subinterpreters"&gt;
&lt;h2&gt;Subinterpreters&lt;/h2&gt;
&lt;p&gt;Eric Snow is working on subinterpreters since 2015, see his first blog post
published in September 2016: &lt;a class="reference external" href="http://ericsnowcurrently.blogspot.com/2016/09/solving-mutli-core-python.html"&gt;Solving Multi-Core Python&lt;/a&gt;.
See Eric Snow's &lt;a class="reference external" href="https://github.com/ericsnowcurrently/multi-core-python/wiki"&gt;multi-core-python project wiki&lt;/a&gt; for the whole
history.&lt;/p&gt;
&lt;p&gt;In September 2017, he wrote a concrete proposal: &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0554/"&gt;PEP 554: Multiple
Interpreters in the Stdlib&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Eric mentions the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0432/"&gt;PEP 432: Simplifying the CPython startup sequence&lt;/a&gt; as one blocker issue. I fixed
this issue (at least for the subinterpreters case) with my &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0587/"&gt;PEP 587: Python
Initialization Configuration&lt;/a&gt; that
I implemented in Python 3.8.&lt;/p&gt;
&lt;p&gt;Sadly, implementing subinterpreters in the 30 years old CPython project is hard
since a lot of code has to be updated. CPython is made of not less than &lt;strong&gt;603K
lines of C code&lt;/strong&gt; (and 815K lines of Python code)!&lt;/p&gt;
&lt;p&gt;In May 2018, at CPython sprint during Pycon US, I discussed subinterpreters
with Eric Snow and Nick Coghlan. I draw an overview of Python internals and the
different &amp;quot;states&amp;quot; on a whiteboard:&lt;/p&gt;
&lt;img alt="Python states" src="https://vstinner.github.io/images/subinterpreters2.jpg" /&gt;
&lt;p&gt;Python and Python subinterpreter lifecycles (creation and finalization):&lt;/p&gt;
&lt;img alt="Python subinterpreter lifecycle" src="https://vstinner.github.io/images/subinterpreters1.jpg" /&gt;
&lt;p&gt;As a follow-up of this meeting, I wrote down the current state and what should
be done: &lt;a class="reference external" href="https://pythoncapi.readthedocs.io/runtime.html"&gt;Reorganize Python “runtime”&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="getting-the-current-python-thread-state"&gt;
&lt;h2&gt;Getting the current Python thread state&lt;/h2&gt;
&lt;p&gt;In the current master branch of Python, getting the current Python thread state
is done using these two macros:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#define _PyRuntimeState_GetThreadState(runtime) \
    ((PyThreadState*)_Py_atomic_load_relaxed(&amp;amp;(runtime)-&amp;gt;gilstate.tstate_current))

#define _PyThreadState_GET() _PyRuntimeState_GetThreadState(&amp;amp;_PyRuntime)
&lt;/pre&gt;
&lt;p&gt;These macros depend on the global &lt;tt class="docutils literal"&gt;_PyRuntime&lt;/tt&gt; variable: instance of the
&lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt; structure. There is exactly one instance of
&lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt;: data shared by all interpreters on purpose (more info
about &lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt; below).&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;_Py_atomic_load_relaxed()&lt;/tt&gt; uses an atomic operation which may become an
performance issue if Python is modified to get the Python thread state in more
places. I tried to check if it uses a slow atomic read instruction, but it
seems like only a write uses an explicit memory fence operation: read seems to
be &amp;quot;free&amp;quot; (it's a regular efficient &lt;tt class="docutils literal"&gt;MOV&lt;/tt&gt; instruction). I only checked the
x86-64 machine code, it may be different on other architectures.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="gil-state"&gt;
&lt;h2&gt;GIL state&lt;/h2&gt;
&lt;p&gt;Currently, the &lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt; structure has a &lt;tt class="docutils literal"&gt;gilstate&lt;/tt&gt; field which is
shared between all subinterpreters. The long term goal of the PEP 554
(subinterpreters) is to &lt;strong&gt;have one GIL per subinterpeters&lt;/strong&gt; to &lt;strong&gt;execute
multiple interpreters in parallel&lt;/strong&gt;. Currently, only one interpreter can be
executed at the same time: there is no parallelism, except if a thread releases
the GIL which is not the common case.&lt;/p&gt;
&lt;p&gt;It's tracked by these two issues:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue10915"&gt;Make the PyGILState API compatible with multiple interpreters&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue15751"&gt;Support subinterpreters in the GIL state API&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I expect that fixing this issue may require to add a lock somewhere which &lt;strong&gt;can
hurt performances&lt;/strong&gt;, depending on how the GIL state is accessed.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="passing-a-state-to-internal-function-calls"&gt;
&lt;h2&gt;Passing a state to internal function calls&lt;/h2&gt;
&lt;p&gt;To avoid any risk of performance penality with incoming Python internal changes
for subinterpreters, but also to make things more explicit, I proposed to
&lt;strong&gt;pass explicitly &amp;quot;a state&amp;quot; to internal C function calls&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;First, it wasn't obvious which &amp;quot;state&amp;quot; should be passed: &lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;PyThreadState&lt;/tt&gt;, a structure containing both, or something else?&lt;/p&gt;
&lt;p&gt;Moreover, it was unclear how to get the runtime from &lt;tt class="docutils literal"&gt;PyThreadState&lt;/tt&gt;, and how
to get &lt;tt class="docutils literal"&gt;PyThreadState&lt;/tt&gt; from runtime?&lt;/p&gt;
&lt;p&gt;I started to &lt;strong&gt;pass runtime to some functions&lt;/strong&gt; (&lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt;): &lt;a class="reference external" href="https://bugs.python.org/issue36710"&gt;Pass
_PyRuntimeState as an argument rather than using the _PyRuntime global variable&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Then I pushed more changes to &lt;strong&gt;pass tstate to some other functions&lt;/strong&gt;
(&lt;tt class="docutils literal"&gt;PyThreadState&lt;/tt&gt;): &lt;a class="reference external" href="https://bugs.python.org/issue38644"&gt;Pass explicitly tstate to function calls&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I added &lt;tt class="docutils literal"&gt;PyInterpreterState.runtime&lt;/tt&gt; so getting &lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt; from
&lt;tt class="docutils literal"&gt;PyThreadState&lt;/tt&gt; is now done using: &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;tstate-&amp;gt;interp-&amp;gt;runtime&lt;/span&gt;&lt;/tt&gt;. It's no
longer needed to pass &lt;tt class="docutils literal"&gt;runtime&lt;/tt&gt; &lt;strong&gt;and&lt;/strong&gt; &lt;tt class="docutils literal"&gt;tstate&lt;/tt&gt; to internal functions:
&lt;tt class="docutils literal"&gt;tstate&lt;/tt&gt; is enough.&lt;/p&gt;
&lt;p&gt;Slowly, I modified the internals to only pass &lt;tt class="docutils literal"&gt;tstate&lt;/tt&gt; to internal functions:
&lt;strong&gt;tstate should become the root object to access all Python states&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;I ended with a thread on the python-dev mailing list to summarize this work:
&lt;a class="reference external" href="https://mail.python.org/archives/list/python-dev&amp;#64;python.org/thread/PQBGECVGVYFTVDLBYURLCXA3T7IPEHHO/#Q4IPXMQIM5YRLZLHADUGSUT4ZLXQ6MYY"&gt;Pass the Python thread state to internal C functions&lt;/a&gt;.
The feedback was quite positive, most core developers agreed that passing
explicitly tstate is a good practice and the work should be continued.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pyruntimestate-and-pyinterpreterstate"&gt;
&lt;h2&gt;_PyRuntimeState and PyInterpreterState&lt;/h2&gt;
&lt;p&gt;Currently, some &lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt; fields are shared by all interperters,
whereas they should be moved into &lt;tt class="docutils literal"&gt;PyInterpreterState&lt;/tt&gt;: it's still a work in
progress.&lt;/p&gt;
&lt;p&gt;For example, I continued the work started by Eric Snow to move the garbage
collector state from &lt;tt class="docutils literal"&gt;_PyRuntimeState&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;PyInterpreterState&lt;/tt&gt;: &lt;a class="reference external" href="https://bugs.python.org/issue36854"&gt;GC
operates out of global runtime state.&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;As explained above, another example is &lt;tt class="docutils literal"&gt;gilstate&lt;/tt&gt; that should also be moved
to &lt;tt class="docutils literal"&gt;PyInterpreterState&lt;/tt&gt;, but that's a complex change that should be well
prepared to not break anything.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="more-subinterpreter-work"&gt;
&lt;h2&gt;More subinterpreter work&lt;/h2&gt;
&lt;p&gt;Implementing subinterpreters also requires to cleanup various parts of Python
internals.&lt;/p&gt;
&lt;p&gt;For example, I modified Python so Py_NewInterpreter() and Py_EndInterpreter()
(create and finalize a subinterpreter) share more code with Py_Initialize()
and Py_Finalize() (create and finalize the &lt;strong&gt;main&lt;/strong&gt; interpreter):
&lt;a class="reference external" href="https://bugs.python.org/issue38858"&gt;new_interpreter() should reuse more Py_InitializeFromConfig() code&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;They are still many issues to be fixed: &lt;strong&gt;it's moving slowly but steadily!&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>Graphics bugs in Firefox and GNOME</title><link href="https://vstinner.github.io/graphics-bugs-firefox-gnome.html" rel="alternate"></link><published>2019-10-10T17:00:00+02:00</published><updated>2019-10-10T17:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-10-10:/graphics-bugs-firefox-gnome.html</id><summary type="html">&lt;p&gt;After explaining how to &lt;a class="reference external" href="https://vstinner.github.io/debug-hybrid-graphics-issues-linux.html"&gt;Debug Hybrid Graphics issues on Linux&lt;/a&gt;, here is the story of four graphics bugs
that I had in GNOME and Firefox on my Fedora 30 between May 2018 and September
2019: bugs in gnome-shell, Gtk, Firefox and mutter.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/34298393&amp;#64;N06/14488759356/"&gt;&lt;img alt="Glitch" src="https://vstinner.github.io/images/glitch.jpg" /&gt;&lt;/a&gt;
&lt;div class="section" id="gnome-shell-freezes"&gt;
&lt;h2&gt;gnome-shell freezes&lt;/h2&gt;
&lt;p&gt;In May 2018, six months after …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;After explaining how to &lt;a class="reference external" href="https://vstinner.github.io/debug-hybrid-graphics-issues-linux.html"&gt;Debug Hybrid Graphics issues on Linux&lt;/a&gt;, here is the story of four graphics bugs
that I had in GNOME and Firefox on my Fedora 30 between May 2018 and September
2019: bugs in gnome-shell, Gtk, Firefox and mutter.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/34298393&amp;#64;N06/14488759356/"&gt;&lt;img alt="Glitch" src="https://vstinner.github.io/images/glitch.jpg" /&gt;&lt;/a&gt;
&lt;div class="section" id="gnome-shell-freezes"&gt;
&lt;h2&gt;gnome-shell freezes&lt;/h2&gt;
&lt;p&gt;In May 2018, six months after I got my Lenovo P50 laptop, gnome-shell was
&amp;quot;sometimes&amp;quot; freezing between 1 and 5 seconds. It was annoying because key
stokes created repeated keys writing &amp;quot;helloooooooooooooooooooooo&amp;quot; instead of
&amp;quot;hello&amp;quot; for example.&lt;/p&gt;
&lt;p&gt;My colleagues led my to &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;#fedora-desktop&lt;/span&gt;&lt;/tt&gt; of the GIMP IRC server where I met
my colleague &lt;strong&gt;Jonas Ådahl&lt;/strong&gt; (jadahl) who almost immediately identified my
issue! Extract of the IRC chat:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
15:03 &amp;lt;vstinner&amp;gt; hello. i upgraded from F27 to F28, and it seems like I
    switched from Xorg to Wayland. sometimes, the desktop hangs a few
    milliseconds (less than 2 secondes)
15:03 &amp;lt;vstinner&amp;gt; bentiss told me that  &amp;quot;libinput error: client bug: timer
    event7 keyboard: offset negative (-39ms)&amp;quot; can occur when shell is too
    slow
15:04 &amp;lt;vstinner&amp;gt; journalctl shows me frenquently the bug
    https://gitlab.gnome.org/GNOME/gnome-shell/issues/1 &amp;quot;Object
    Shell.GenericContainer (0x559e6bfddc60), has been already finalized.
    Impossible to get any property from it.&amp;quot;
15:04 &amp;lt;vstinner&amp;gt; i also get &amp;quot;Window manager warning: last_user_time
    (3093467) is greater than comparison timestamp (3093466).  This most
    likely represents a buggy client sending inaccurate timestamps in
    messages such as _NET_ACTIVE_WINDOW.  Trying to work around...&amp;quot; errors
    in logs (from shell)
15:05 &amp;lt;vstinner&amp;gt; bentiss: ah, i also get &amp;quot;libinput error: client bug: timer
    event7 trackpoint: offset negative (-352ms)&amp;quot; errors
15:06 &amp;lt;vstinner&amp;gt; it's a recent laptop, Lenovo P50: 32 GB of RAM, 4 physical
    CPUs (8 threads) Intel(R) Core(TM) i7-6820HQ CPU &amp;#64; 2.70GHz
15:06 &amp;lt;vstinner&amp;gt; so. what can i do to debug such performance issue? may it
    come from shell? what does it mean if shell is slow? can it be a GPU
    issue?  a javascript issue?
...
15:13 &amp;lt;jadahl&amp;gt; vstinner: whats your hardware? Do you have a hybrid gpu
    system?
15:13 &amp;lt;jadahl&amp;gt; ah, yes P50
15:14 &amp;lt;jadahl&amp;gt; vstinner: there is a branch on mutter upstream that fixes
    that issue. want to compile it to test?
&lt;/pre&gt;
&lt;p&gt;Ten minutes after I asked my question, Jonas asked the right question: &lt;strong&gt;Do you
have a hybrid gpu system?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I was able to workaround the issue by connecting my laptop to my TV using the
HDMI port:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
15:22 &amp;lt; jadahl&amp;gt; for example, IIRC if you have a monitor connected to the
    HDMI, the issue will go away since the secondary GPU is always awake
    anyway
...
15:31 &amp;lt; vstinner&amp;gt; jadahl: i plugged a HDMI cable to my TV and it seems like
    the issue is gone
15:31 &amp;lt; vstinner&amp;gt; jadahl: impressive
&lt;/pre&gt;
&lt;p&gt;When an external monitor is used (like a TV plugged on the HDMI port), my
NVIDIA GPU is always active which works around the bug I had in gnome-shell.&lt;/p&gt;
&lt;p&gt;Jonas provided me a RPM package for Fedora including his work-in-progress fix:
&lt;a class="reference external" href="https://gitlab.gnome.org/GNOME/mutter/merge_requests/106"&gt;Upload HW cursor sprite on-demand&lt;/a&gt;. I confirmed that
this change fixed my bug. His mutter change has been merged upstream.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="firefox-crash-when-selecting-text"&gt;
&lt;h2&gt;Firefox crash when selecting text&lt;/h2&gt;
&lt;p&gt;In March 2019, Firefox with Wayland crashed on &lt;tt class="docutils literal"&gt;wl_abort()&lt;/tt&gt; when selecting
more than 4000 characters in a &lt;tt class="docutils literal"&gt;&amp;lt;textarea&amp;gt;&lt;/tt&gt;. I found the bug in Gmail when
selecting the whole email text to remove it. Pressing &lt;strong&gt;CTRL + A&lt;/strong&gt; or
Right-click + Select All &lt;strong&gt;crashed the whole Firefox process!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I reported the bug to Firefox: &lt;a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1539773"&gt;Firefox with Wayland crash on wl_abort() when
selecting more than 4000 characters in a &amp;lt;textarea&amp;gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Running gdb in Firefox caused me some troubles since it's a very large binary with
many libraries. I also read &lt;a class="reference external" href="https://cgit.freedesktop.org/wayland/wayland-protocols/tree/unstable/text-input/text-input-unstable-v3.xml#n138"&gt;Wayland protocol specifications&lt;/a&gt;.
I managed to analyze the bug and so I reported the bug to Gtk as well, &lt;a class="reference external" href="https://gitlab.gnome.org/GNOME/gtk/issues/1783"&gt;On
Wayland, notify_surrounding_text() crash on wl_abort() if text is longer than
4000 bytes&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
According to gdb, &lt;tt class="docutils literal"&gt;wl_proxy_marshal_array_constructor_versioned()&lt;/tt&gt; calls
&lt;tt class="docutils literal"&gt;wl_abort()&lt;/tt&gt; because the buffer is too short. It seems like
&lt;tt class="docutils literal"&gt;wl_buffer_put()&lt;/tt&gt; fails with &lt;tt class="docutils literal"&gt;E2BIG&lt;/tt&gt;.&lt;/blockquote&gt;
&lt;p&gt;Quickly, I identified that &lt;strong&gt;my Gtk bug has already been fixed 3 months before
by Carlos Garnacho&lt;/strong&gt; (&lt;a class="reference external" href="https://gitlab.gnome.org/GNOME/gtk/merge_requests/438"&gt;imwayland: Respect maximum length of 4000 Bytes on
strings being sent&lt;/a&gt;)
and &lt;strong&gt;the fix is part of gtk-3.24.3&lt;/strong&gt; (&amp;quot;wayland: Respect length limits in text
protocol&amp;quot; says &amp;quot;Overview of Changes in GTK+ 3.24.3&amp;quot;).&lt;/p&gt;
&lt;p&gt;I requested to upgrade Gtk in Fedora. But it was not possible since the newer
version changed the theme. I was asked to cherry-pick the fix and that's what I
did: &lt;a class="reference external" href="https://src.fedoraproject.org/rpms/gtk3/pull-request/5"&gt;imwayland: Respect maximum length of 4000 Bytes on strings&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;My PR was merged and a new package was built. I tested it and confirmed that it
fixed the crash: &lt;a class="reference external" href="ttps://bodhi.fedoraproject.org/updates/FEDORA-2019-d67ec97b0b"&gt;FEDORA-2019-d67ec97b0b&lt;/a&gt;. Soon, the
package was pushed to the public Fedora package repository.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;That's the cool part about open source: if you have the skills to hack the
code, you can fix an annoying which is affecting you!&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="firefox-wayland-window-partially-or-not-updated-when-switching-between-two-tabs"&gt;
&lt;h2&gt;Firefox: [Wayland] Window partially or not updated when switching between two tabs&lt;/h2&gt;
&lt;div class="section" id="analyze-the-bug"&gt;
&lt;h3&gt;Analyze the bug&lt;/h3&gt;
&lt;p&gt;In September 2019, after a large system upgrade (install 6 packages, upgrade
234 packages, remove 5 packages), Firefox started to not update the window
content sometimes when I switched from one tab to another. Example:&lt;/p&gt;
&lt;img alt="Firefox bug of window partially updated" src="https://vstinner.github.io/images/firefox_bug_1.jpg" /&gt;
&lt;p&gt;It took me a few hours to analyze the bug to be able to produce an useful bug
report.&lt;/p&gt;
&lt;p&gt;I followed Fedora's guide &lt;a class="reference external" href="https://fedoraproject.org/wiki/How_to_debug_Firefox_problems"&gt;How to debug Firefox problems&lt;/a&gt; advices.&lt;/p&gt;
&lt;p&gt;First, I tried to &lt;strong&gt;understand which GPU driver is used&lt;/strong&gt;. I finished by
blacklisting the nouveau driver in the Linux kernel, to ensure that Firefox was
using my Intel IGP. I still reproduced the bug.&lt;/p&gt;
&lt;p&gt;I &lt;strong&gt;disabled all Firefox extensions&lt;/strong&gt;: bug reproduced.&lt;/p&gt;
&lt;p&gt;Then I created a new Firefox profile and started Firefox in &lt;strong&gt;safe mode&lt;/strong&gt;: bug
reproduced.&lt;/p&gt;
&lt;p&gt;I tested the latest Firefox binary from mozilla.org (Firefox 69.0): bug
reproduced.&lt;/p&gt;
&lt;p&gt;Finally, &lt;strong&gt;I tested Firefox Nightly&lt;/strong&gt; from mozilla.org (Firefox 71.0a1): bug
reproduced.&lt;/p&gt;
&lt;p&gt;Ok, it was enough data to produce an interesting bug report. I reported
&lt;a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1580152"&gt;[Wayland] Window partially or not updated when switching between two tabs&lt;/a&gt; to Firefox.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="identify-the-regression-using-fedora-packages"&gt;
&lt;h3&gt;Identify the regression using Fedora packages&lt;/h3&gt;
&lt;p&gt;Then I looked at &lt;tt class="docutils literal"&gt;/var/log/dnf.log&lt;/tt&gt; and I tried to identify which package
update could explain the regression.&lt;/p&gt;
&lt;p&gt;I downgraded &lt;strong&gt;gtk3&lt;/strong&gt;-3.24.11-1.fc30.x86_64 to gtk3.x86_64 3.24.10-1.fc30: bug
reproduced.&lt;/p&gt;
&lt;p&gt;I rebooted on oldest available &lt;strong&gt;Linux kernel&lt;/strong&gt;, version 5.2.8-200.fc30.x86_64:
bug reproduced. I checked journalctl logs to check which Linux version I was
running whhen the bug was first seen: Linux 5.2.9-200.fc30.x86_64.&lt;/p&gt;
&lt;p&gt;I don't know why, but &lt;strong&gt;downgrading Firefox was only my 3rd test&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;I downgraded firefox-69.0-2.fc30.x86_64 to firefox-68.0.2-1.fc30.x86_64: the
bug is gone! Ok, so &lt;strong&gt;the regression comes from the Firefox package&lt;/strong&gt;, and it
was introduced between package versions 68.0.2-1.fc30 and 69.0-2.fc30.&lt;/p&gt;
&lt;p&gt;On IRC, I met my colleague &lt;strong&gt;Martin Stránský&lt;/strong&gt; who package Firefox for Fedora.
He told me that he is aware of my bug and may have a fix for my bug. Great!&lt;/p&gt;
&lt;p&gt;Only 9 days later, &lt;strong&gt;Martin Stránský&lt;/strong&gt; fix has been merged in Firefox upstream,
released in Firefox Nightly, and a new package has been shipped in Fedora 30!
Thanks Martin for your efficiency!&lt;/p&gt;
&lt;p&gt;The final Firefox change is quite large and intrusive: &lt;a class="reference external" href="https://hg.mozilla.org/releases/mozilla-beta/rev/3281a617f22b"&gt;[Wayland] Fix rendering
glitches on wayland&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="xwayland-crash-in-xwl-glamor-gbm-create-pixmap"&gt;
&lt;h2&gt;Xwayland crash in xwl_glamor_gbm_create_pixmap()&lt;/h2&gt;
&lt;p&gt;In September 2019, while I was debugging the previous Firefox bug, I started my
IRC client hexchat.  Suddently, &lt;strong&gt;Xwayland crashed which closed my whole Gnome
session&lt;/strong&gt;!  I was testing various GPU configurations to analyze the Firefox
bug.&lt;/p&gt;
&lt;p&gt;ABRT managed to rebuild an useless traceback and identified an existing bug
report. It added my coment to &lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1729200#c20"&gt;[abrt] xorg-x11-server-Xwayland:
OsLookupColor(): Segmentation fault at address 0x28&lt;/a&gt; report.&lt;/p&gt;
&lt;p&gt;At July 26, 2019 (1 month before I got the bug), &lt;strong&gt;Olivier Fourdan&lt;/strong&gt; added &lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1729200#c9"&gt;an
interesting comment&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;tt class="docutils literal"&gt;glamor_get_modifiers+0x767&lt;/tt&gt; is &lt;tt class="docutils literal"&gt;xwl_glamor_gbm_create_pixmap()&lt;/tt&gt; so this
is the same as &lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1729925"&gt;bug 1729925&lt;/a&gt; fixed upstream with
&lt;a class="reference external" href="https://gitlab.freedesktop.org/xorg/xserver/merge_requests/242"&gt;xwayland: Do not free a NULL GBM bo&lt;/a&gt;.&lt;/blockquote&gt;
&lt;p&gt;So in fact, my bug was already fixed by &lt;strong&gt;Olivier Fourdan&lt;/strong&gt; in Xwayland
upstream, but the fix didn't land into Fedora yet.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="thanks"&gt;
&lt;h2&gt;Thanks!&lt;/h2&gt;
&lt;p&gt;I would like to thank the following developers who fixed my Fedora 30. What a
coincidence, all four are my collagues! It seems like Red Hat is investing in
the Linux desktop :-)&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://blogs.gnome.org/carlosg/"&gt;Carlos Garnacho&lt;/a&gt; (Red Hat).&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/183829480&amp;#64;N06/48623543091/in/pool-14662216&amp;#64;N23/"&gt;&lt;img alt="Carlos Garnacho" src="https://vstinner.github.io/images/carlos_garnacho.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;&lt;a class="reference external" href="https://gitlab.gnome.org/jadahl"&gt;Jonas Ådahl&lt;/a&gt; (Red Hat).&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/183829480&amp;#64;N06/48623189663/in/pool-14662216&amp;#64;N23/"&gt;&lt;img alt="Jonas Ådahl" src="https://vstinner.github.io/images/jonas_adahl.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;&lt;a class="reference external" href="http://people.redhat.com/stransky/"&gt;Martin Stránský&lt;/a&gt; (Red Hat).&lt;/p&gt;
&lt;a class="reference external image-reference" href="http://people.redhat.com/stransky/"&gt;&lt;img alt="Martin Stránský" src="https://vstinner.github.io/images/mstransky.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Olivier_Fourdan"&gt;Olivier Fourdan&lt;/a&gt; (Red Hat).&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://en.wikipedia.org/wiki/Olivier_Fourdan"&gt;&lt;img alt="Olivier Fourdan" src="https://vstinner.github.io/images/olivier_fourdan.jpg" /&gt;&lt;/a&gt;
&lt;/div&gt;
</content><category term="linux"></category><category term="linux"></category></entry><entry><title>Debug Hybrid Graphics issues on Linux</title><link href="https://vstinner.github.io/debug-hybrid-graphics-issues-linux.html" rel="alternate"></link><published>2019-09-11T15:50:00+02:00</published><updated>2019-09-11T15:50:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-09-11:/debug-hybrid-graphics-issues-linux.html</id><summary type="html">&lt;p&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/index.php/Hybrid_graphics"&gt;Hybrid Graphics&lt;/a&gt; is a
complex hardware and software solution to achieve longer laptop battery life:
an &lt;strong&gt;integrated&lt;/strong&gt; graphics device is used by default, and a &lt;strong&gt;discrete&lt;/strong&gt;
graphics device with higher graphics performances is enabled on demand.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://www.theregister.co.uk/2010/02/09/inside_nvidia_optimus/"&gt;&lt;img alt="Hybrid Graphics" src="https://vstinner.github.io/images/hybrid_graphics.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;If it is designed and implemented carefully, users should not notice that a
laptop …&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/index.php/Hybrid_graphics"&gt;Hybrid Graphics&lt;/a&gt; is a
complex hardware and software solution to achieve longer laptop battery life:
an &lt;strong&gt;integrated&lt;/strong&gt; graphics device is used by default, and a &lt;strong&gt;discrete&lt;/strong&gt;
graphics device with higher graphics performances is enabled on demand.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://www.theregister.co.uk/2010/02/09/inside_nvidia_optimus/"&gt;&lt;img alt="Hybrid Graphics" src="https://vstinner.github.io/images/hybrid_graphics.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;If it is designed and implemented carefully, users should not notice that a
laptop has two graphical devices.&lt;/p&gt;
&lt;p&gt;Sadly, the Linux implementation is not perfect yet. I had to debug different
graphics issues on GNOME last months, so I decided to write down an article
about this technology.&lt;/p&gt;
&lt;p&gt;This article is about the &lt;strong&gt;GNOME&lt;/strong&gt; desktop environment with &lt;strong&gt;Wayland&lt;/strong&gt;
running on &lt;strong&gt;Fedora&lt;/strong&gt; 30, with Linux kernel &lt;strong&gt;vgaswitcheroo&lt;/strong&gt; in muxless mode
(more about that above).&lt;/p&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;Hybrid Graphics&lt;/h2&gt;
&lt;p&gt;Hybrid Graphics are known under different names:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Linux kernel &lt;a class="reference external" href="https://www.kernel.org/doc/html/latest/gpu/vga-switcheroo.html"&gt;vgaswitcheroo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/index.php/PRIME"&gt;PRIME&lt;/a&gt; in Linux open source
GPU drivers (nouveau, ati, amdgpu and intel), the &amp;quot;muxless&amp;quot; flavor of hybrid graphics&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/index.php/bumblebee"&gt;Bumblebee&lt;/a&gt;:
&lt;a class="reference external" href="https://wiki.archlinux.org/index.php/NVIDIA_Optimus"&gt;NVIDIA Optimus&lt;/a&gt;
for Linux&lt;/li&gt;
&lt;li&gt;&amp;quot;AMD Dynamic Switchable Graphics&amp;quot; for Radeon&lt;/li&gt;
&lt;li&gt;&amp;quot;Dual GPUs&amp;quot;&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Nowadays, most manufacturers utilizes the &lt;strong&gt;muxless&lt;/strong&gt; model:&lt;/p&gt;
&lt;blockquote&gt;
Dual GPUs but &lt;strong&gt;only one of them is connected to outputs&lt;/strong&gt;. The other one
is merely used to &lt;strong&gt;offload rendering&lt;/strong&gt;, its results are copied over PCIe
into the framebuffer. On Linux this is supported with DRI PRIME.&lt;/blockquote&gt;
&lt;p&gt;In 2010, the first generation hybrid model used the &lt;strong&gt;muxed&lt;/strong&gt; model:&lt;/p&gt;
&lt;blockquote&gt;
Dual GPUs with a hardware multiplexer chip to switch outputs between GPUs.
This model makes the user choose (at boot time or at login time) between
the two power/graphics profiles and is almost fixed throughout the user
session.&lt;/blockquote&gt;
&lt;p&gt;Note: The development to support hybrid graphics in Linux started in 2010.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="does-my-linux-have-hybrid-graphics"&gt;
&lt;h2&gt;Does my Linux have Hybrid Graphics?&lt;/h2&gt;
&lt;p&gt;On Linux, Hybrid Graphics is used if the &lt;tt class="docutils literal"&gt;/sys/kernel/debug/vgaswitcheroo/&lt;/tt&gt;
directory exists.&lt;/p&gt;
&lt;p&gt;No Hybrid Graphics, single graphics device:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo cat /sys/kernel/debug/vgaswitcheroo/switch
cat: /sys/kernel/debug/vgaswitcheroo/switch: No such file or directory
&lt;/pre&gt;
&lt;p&gt;Hybrid Graphics with two graphics devices:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo cat /sys/kernel/debug/vgaswitcheroo/switch
0:IGD:+:Pwr:0000:00:02.0
1:DIS: :DynOff:0000:01:00.0
&lt;/pre&gt;
&lt;p&gt;Command to list graphics devices:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ lspci|grep VGA
00:02.0 VGA compatible controller: Intel Corporation HD Graphics 530 (rev 06)
01:00.0 VGA compatible controller: NVIDIA Corporation GM107GLM [Quadro M1000M] (rev a2)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="hardware"&gt;
&lt;h2&gt;Hardware&lt;/h2&gt;
&lt;p&gt;My employer gave me a Lenovo P50 laptop to work in December 2017. It is my only
computer at home, so I needed a powerful laptop (even if it's heavy for
traveling to conferences). The CPU, RAM and battery are great, but the hybrid
graphics caused me some headaches.&lt;/p&gt;
&lt;p&gt;My Lenovo P50 has two GPUs:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ lspci|grep VGA
00:02.0 VGA compatible controller: Intel Corporation HD Graphics 530 (rev 06)
01:00.0 VGA compatible controller: NVIDIA Corporation GM107GLM [Quadro M1000M] (rev a2)
&lt;/pre&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The &lt;strong&gt;Integrated Graphics Device&lt;/strong&gt; is a &lt;strong&gt;Intel&lt;/strong&gt; IGP (Intel HD Graphics 530)&lt;/li&gt;
&lt;li&gt;The &lt;strong&gt;Discrete Graphics Device&lt;/strong&gt; is a &lt;strong&gt;NVIDIA&lt;/strong&gt; GPU (NVIDIA Quadro M1000M)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I didn't know that that the laptop had two graphics device when I chose the
laptop model. I discovered hybrid graphics when I started to debug graphics
issues.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="bios"&gt;
&lt;h2&gt;BIOS&lt;/h2&gt;
&lt;p&gt;Hybrid graphics can be configured in the BIOS:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;strong&gt;Discrete Graphics mode&lt;/strong&gt; will achieve higher graphics performances.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Hybrid Graphics mode&lt;/strong&gt; (default) runs as Integrated Graphics mode to
achieve longer battery life, and Discrete Graphics is enabled on demand.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;On my Lenovo P50, using the &lt;strong&gt;Discrete Graphics mode&lt;/strong&gt; removes &amp;quot;00:02.0 VGA
compatible controller: Intel Corporation HD Graphics 530&amp;quot; from &lt;tt class="docutils literal"&gt;lspci&lt;/tt&gt;
command output: the &lt;strong&gt;Intel IGP is fully disabled&lt;/strong&gt;. The Linux kernel only
sees the NVIDIA GPU.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="linux-kernel"&gt;
&lt;h2&gt;Linux kernel&lt;/h2&gt;
&lt;p&gt;On Linux, hybrid graphics is handled by &lt;strong&gt;vgaswitcheroo&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo cat /sys/kernel/debug/vgaswitcheroo/switch
0:IGD:+:Pwr:0000:00:02.0
1:DIS: :DynPwr:0000:01:00.0
&lt;/pre&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;IGD&lt;/tt&gt; stands for &lt;strong&gt;Integrated&lt;/strong&gt; Graphics Device&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;DIS&lt;/tt&gt; stands for &lt;strong&gt;DIScrete&lt;/strong&gt; Graphics Device&lt;/li&gt;
&lt;li&gt;&amp;quot;+&amp;quot; marks the &lt;strong&gt;active&lt;/strong&gt; card&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Pwr&lt;/tt&gt;: the graphics device is &lt;strong&gt;always active&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;DynPwr&lt;/tt&gt;: the graphics device is actived &lt;strong&gt;on demand&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The last field (ex: &lt;tt class="docutils literal"&gt;0000:00:02.0&lt;/tt&gt;) is based on the PCI identifier:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ lspci|grep VGA
00:02.0 VGA compatible controller: Intel Corporation HD Graphics 530 (rev 06)
01:00.0 VGA compatible controller: NVIDIA Corporation GM107GLM [Quadro M1000M] (rev a2)
&lt;/pre&gt;
&lt;p&gt;On my laptop, hybrid graphics is detected by an &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Advanced_Configuration_and_Power_Interface"&gt;ACPI&lt;/a&gt;
&amp;quot;Device-Specific Method&amp;quot; (DSM):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ journalctl -b -k|grep 'VGA switcheroo'
Sep 11 02:29:54 apu kernel: VGA switcheroo: detected Optimus DSM method \_SB_.PCI0.PEG0.PEGP handle
&lt;/pre&gt;
&lt;p&gt;See: &lt;a class="reference external" href="https://www.kernel.org/doc/html/latest/gpu/vga-switcheroo.html"&gt;VGA Switcheroo (Linux kernel documentation)&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="opengl"&gt;
&lt;h2&gt;OpenGL&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Mesa_(computer_graphics)"&gt;Mesa&lt;/a&gt; provides
&lt;tt class="docutils literal"&gt;glxinfo&lt;/tt&gt; utility to get information about the OpenGL driver currently used:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ glxinfo|grep -E 'Device|direct rendering'
direct rendering: Yes
    Device: Mesa DRI Intel(R) HD Graphics 530 (Skylake GT2)  (0x191b)
&lt;/pre&gt;
&lt;p&gt;On this example, the discrete Intel IGP is used.&lt;/p&gt;
&lt;p&gt;In Firefox, go to &lt;strong&gt;about:support&lt;/strong&gt; page and search for the &lt;tt class="docutils literal"&gt;Graphics&lt;/tt&gt;
section to get information about compositing, WebGL, GPU, etc.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="dri-prime-environment-variable"&gt;
&lt;h2&gt;DRI_PRIME environment variable&lt;/h2&gt;
&lt;p&gt;Set DRI_PRIME=1 environment variable to run an application with the
&lt;strong&gt;discrete&lt;/strong&gt; GPU.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ DRI_PRIME=1 glxinfo|grep -E 'Device|rendering'
direct rendering: Yes
    Device: NV117 (0x13b1)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="switcheroo-control"&gt;
&lt;h2&gt;switcheroo-control&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/hadess/switcheroo-control"&gt;switcheroo-control&lt;/a&gt; is a
deamon controlling &lt;tt class="docutils literal"&gt;/sys/kernel/debug/vgaswitcheroo/switch&lt;/tt&gt; (Linux kernel).
It can be accessed by DBus.&lt;/p&gt;
&lt;p&gt;When the daemon starts, it looks for &lt;tt class="docutils literal"&gt;xdg.force_integrated=VALUE&lt;/tt&gt; parameter
in the Linux command line. If &lt;em&gt;VALUE&lt;/em&gt; is &lt;tt class="docutils literal"&gt;1&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;true&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;on&lt;/tt&gt;, or if
&lt;tt class="docutils literal"&gt;xdg.force_integrated=VALUE&lt;/tt&gt; is not found in the command line, the daemon
writes &lt;tt class="docutils literal"&gt;DIGD&lt;/tt&gt; into &lt;tt class="docutils literal"&gt;/sys/kernel/debug/vgaswitcheroo/switch&lt;/tt&gt; (delayed
&lt;strong&gt;switch to the integrated graphics device&lt;/strong&gt;: my Intel IGP)&lt;/p&gt;
&lt;p&gt;If &lt;tt class="docutils literal"&gt;xdg.force_integrated=0&lt;/tt&gt; is found in the command line, the daemon leaves
&lt;tt class="docutils literal"&gt;/sys/kernel/debug/vgaswitcheroo/switch&lt;/tt&gt; unchanged.&lt;/p&gt;
&lt;p&gt;systemd:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Check if the service is running: &lt;tt class="docutils literal"&gt;sudo systemctl status &lt;span class="pre"&gt;switcheroo-control.service&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Disable the service: &lt;tt class="docutils literal"&gt;sudo systemctl disable &lt;span class="pre"&gt;switcheroo-control.service&lt;/span&gt;&lt;/tt&gt;
and &lt;tt class="docutils literal"&gt;sudo systemctl stop &lt;span class="pre"&gt;switcheroo-control.service&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;On Fedora, switcheroo-control is installed by default.&lt;/p&gt;
&lt;p&gt;It is unclear to me if this daemon is still useful for my setup. It seems like
the the Linux kernel switcheroo uses the integrated Intel IGP by default
anyway.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="disable-the-discrete-gpu-by-blacklisting-its-driver"&gt;
&lt;h2&gt;Disable the discrete GPU by blacklisting its driver&lt;/h2&gt;
&lt;p&gt;To debug graphical bugs, I wanted to ensure that the discrete NVIDIA GPU is
never used.&lt;/p&gt;
&lt;p&gt;I found the solution of fully disabling the nouveau driver in the Linux kernel:
add &lt;tt class="docutils literal"&gt;modprobe.blacklist=nouveau&lt;/tt&gt; to the Linux kernel command line. On Fedora,
you can use:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo grubby --update-kernel=ALL --args=&amp;quot;modprobe.blacklist=nouveau&amp;quot;
&lt;/pre&gt;
&lt;p&gt;To reenable nouveau, remove the parameter. On Fedora:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo grubby --update-kernel=ALL --remove-args=&amp;quot;modprobe.blacklist=nouveau&amp;quot;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="demo"&gt;
&lt;h2&gt;Demo!&lt;/h2&gt;
&lt;p&gt;For this test, my laptop is not connected to anything (no power cable, no
external monitor, no dock).&lt;/p&gt;
&lt;p&gt;When my laptop is idle (no 3D application is running), the NVIDIA GPU is
&lt;strong&gt;suspended&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/enable
0
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/power/runtime_status
suspended
&lt;/pre&gt;
&lt;p&gt;I explicitly run a 3D application on it:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
DRI_PRIME=1 glxgears
&lt;/pre&gt;
&lt;p&gt;The NVIDIA GPU becomes &lt;strong&gt;active&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/enable
2
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/power/runtime_status
active
&lt;/pre&gt;
&lt;p&gt;I stop the 3D application. A few seconds later, the NVIDIA GPU is &lt;strong&gt;suspended&lt;/strong&gt;
again:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/enable
0
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/power/runtime_status
suspended
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="graphics-devices-and-monitors"&gt;
&lt;h2&gt;Graphics devices and monitors&lt;/h2&gt;
&lt;p&gt;When I disabled the nouveau driver using &lt;tt class="docutils literal"&gt;modprobe.blacklist=nouveau&lt;/tt&gt; kernel
command line parameter, I was no longer able to use external monitors. I
understood that:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The &lt;strong&gt;Intel&lt;/strong&gt; IGP is connected to the &lt;strong&gt;internal&lt;/strong&gt; laptop screen&lt;/li&gt;
&lt;li&gt;The &lt;strong&gt;NVIDIA&lt;/strong&gt; GPU is connected to the &lt;strong&gt;external&lt;/strong&gt; monitors (DisplayPort
and HDMI ports)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;When my laptop has &lt;strong&gt;no external monitor&lt;/strong&gt; connected, the &lt;strong&gt;discrete&lt;/strong&gt; NVIDIA
GPU is &lt;strong&gt;actived on demand&lt;/strong&gt; (suspended when idle)&lt;/p&gt;
&lt;p&gt;When I connect my laptop to &lt;strong&gt;two external monitors&lt;/strong&gt; (using my dock), the
&lt;strong&gt;discrete&lt;/strong&gt; NVIDIA GPU is &lt;strong&gt;always active&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/bus/pci/drivers/nouveau/0000\:01\:00.0/power/runtime_status
active
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="links"&gt;
&lt;h2&gt;Links&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/index.php/Hybrid_graphics"&gt;https://wiki.archlinux.org/index.php/Hybrid_graphics&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.kernel.org/doc/html/latest/gpu/vga-switcheroo.html"&gt;https://www.kernel.org/doc/html/latest/gpu/vga-switcheroo.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.archlinux.org/index.php/PRIME"&gt;https://wiki.archlinux.org/index.php/PRIME&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://help.ubuntu.com/community/HybridGraphics"&gt;https://help.ubuntu.com/community/HybridGraphics&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Nvidia_Optimus"&gt;https://en.wikipedia.org/wiki/Nvidia_Optimus&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/AMD_Hybrid_Graphics"&gt;https://en.wikipedia.org/wiki/AMD_Hybrid_Graphics&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://nouveau.freedesktop.org/wiki/Optimus"&gt;https://nouveau.freedesktop.org/wiki/Optimus&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="linux"></category><category term="linux"></category></entry><entry><title>Split Include/ directory in Python 3.8</title><link href="https://vstinner.github.io/split-include-directory-python38.html" rel="alternate"></link><published>2019-06-19T12:00:00+02:00</published><updated>2019-06-19T12:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-06-19:/split-include-directory-python38.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/mortengade/2747989334/"&gt;&lt;img alt="Private way. Trespassers and those disposing rubbish will be prosecuted." src="https://vstinner.github.io/images/private_way.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;In September 2017, during the CPython sprint at Facebook, I proposed my
idea to create &lt;a class="reference external" href="https://vstinner.github.io/new-python-c-api.html"&gt;A New C API for CPython&lt;/a&gt;.
I'm still working on the Python C API at: &lt;a class="reference external" href="http://pythoncapi.readthedocs.io/"&gt;pythoncapi.readthedocs.io&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;My analysis is that the C API leaks too many implementation details which
prevent to optimize Python …&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/mortengade/2747989334/"&gt;&lt;img alt="Private way. Trespassers and those disposing rubbish will be prosecuted." src="https://vstinner.github.io/images/private_way.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;In September 2017, during the CPython sprint at Facebook, I proposed my
idea to create &lt;a class="reference external" href="https://vstinner.github.io/new-python-c-api.html"&gt;A New C API for CPython&lt;/a&gt;.
I'm still working on the Python C API at: &lt;a class="reference external" href="http://pythoncapi.readthedocs.io/"&gt;pythoncapi.readthedocs.io&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;My analysis is that the C API leaks too many implementation details which
prevent to optimize Python and make the implementation of PyPy (cpyext) more
painful.&lt;/p&gt;
&lt;p&gt;In Python 3.8, I created &lt;tt class="docutils literal"&gt;Include/cpython/&lt;/tt&gt; sub-directory to stop adding new
APIs to the stable API by mistake.&lt;/p&gt;
&lt;p&gt;I moved more private functions into the internal C API: &lt;tt class="docutils literal"&gt;Include/internal/&lt;/tt&gt;
directory.&lt;/p&gt;
&lt;p&gt;I also converted some macros like &lt;tt class="docutils literal"&gt;Py_INCREF()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;Py_DECREF()&lt;/tt&gt; to static
inline functions to have well defined parameter and return type, and to avoid
macro pitfals.&lt;/p&gt;
&lt;p&gt;Finally, I removed 3 functions from the C API.&lt;/p&gt;
&lt;div class="section" id="include-internal"&gt;
&lt;h2&gt;Include/internal/&lt;/h2&gt;
&lt;p&gt;In Python 3.7, &lt;strong&gt;Eric Snow&lt;/strong&gt; created &lt;tt class="docutils literal"&gt;Include/internal/&lt;/tt&gt; sub-directory for
the CPython &amp;quot;internal C API&amp;quot;: API which should not be used outside CPython code
base. In Python 3.6, these APIs were surrounded by:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#ifdef Py_BUILD_CORE
...
#endif
&lt;/pre&gt;
&lt;p&gt;In Python 3.8, I continued this work by moving more private functions into
this directory: see &lt;a class="reference external" href="https://bugs.python.org/issue35081"&gt;bpo-35081&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I started a thread on python-dev: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2018-October/155587.html"&gt;[Python-Dev] Rename Include/internal/ to
Include/pycore/&lt;/a&gt;. But
it was decided to keep &lt;tt class="docutils literal"&gt;Include/internal/&lt;/tt&gt; name. It was decided that internal
header files must not be included implicitly by the generic &lt;tt class="docutils literal"&gt;#include
&amp;lt;Python.h&amp;gt;&lt;/tt&gt;, but included explicitly. For example, when I moved
&lt;tt class="docutils literal"&gt;_PyObject_GC_TRACK()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;_PyObject_GC_UNTRACK()&lt;/tt&gt; to the internal C API,
I had to add &lt;tt class="docutils literal"&gt;#include &amp;quot;pycore_object.h&amp;quot;&lt;/tt&gt; to 32 C files!&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue35296"&gt;I also modified make install&lt;/a&gt; to install
this internal C API, so it can be used for specific needs like debuggers or
profilers which have to access CPython internals (access structure fields) but
cannot call functions. For example, &lt;strong&gt;Eric Snow&lt;/strong&gt; moved the &lt;tt class="docutils literal"&gt;PyInterpreterState&lt;/tt&gt;
structure to the internal C API.&lt;/p&gt;
&lt;p&gt;Installing the internal C API ease the migration of APIs to internal: if an API
is still needed after it's moved, it's now possible to opt-in to use it.&lt;/p&gt;
&lt;p&gt;Using the internal C API requires to define &lt;tt class="docutils literal"&gt;Py_BUILD_CORE_MODULE&lt;/tt&gt; macro and
use a different include, like &lt;tt class="docutils literal"&gt;#include &amp;quot;internal/pycore_pystate.h&amp;quot;&lt;/tt&gt;. It's
more complicated on purpose: ensure that it's not used by mistake.&lt;/p&gt;
&lt;p&gt;Python 3.8 now provides 21 internal header files:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
pycore_accu.h       pycore_getopt.h      pycore_pyhash.h
pycore_atomic.h     pycore_gil.h         pycore_pylifecycle.h
pycore_ceval.h      pycore_hamt.h        pycore_pymem.h
pycore_code.h       pycore_initconfig.h  pycore_pystate.h
pycore_condvar.h    pycore_object.h      pycore_traceback.h
pycore_context.h    pycore_pathconfig.h  pycore_tupleobject.h
pycore_fileutils.h  pycore_pyerrors.h    pycore_warnings.h
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="include-cpython"&gt;
&lt;h2&gt;Include/cpython/&lt;/h2&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0384/"&gt;PEP 384 &amp;quot;Defining a Stable ABI&amp;quot;&lt;/a&gt; introduced &lt;tt class="docutils literal"&gt;Py_LIMITED_API&lt;/tt&gt;
macro to exclude functions from the Python C API. The problem is when a new API
is added, it has to explicitly be excluded using &lt;tt class="docutils literal"&gt;#ifndef Py_LIMITED_API&lt;/tt&gt;.
If the author forgets it, the function is added to be stable API by mistake.&lt;/p&gt;
&lt;p&gt;I proposed to move the API which should be excluded from the stable ABI to a
new subdirectory. I created a &lt;a class="reference external" href="https://discuss.python.org/t/poll-what-is-your-favorite-name-for-the-new-include-subdirectory/477"&gt;poll on the sub-directory name&lt;/a&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Include/cpython/&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Include/board/&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Include/impl/&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Include/pycapi/&lt;/tt&gt; (the name that I proposed initially)&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Include/unstable/&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;other (add comment)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;Include/cpython/&lt;/tt&gt; name won with 100% of the 3 votes (and a few more
supports in the python-dev discussion and in the bug tracker) :-)&lt;/p&gt;
&lt;p&gt;I created &lt;a class="reference external" href="https://bugs.python.org/issue35134"&gt;bpo-35134: Add a new Include/cpython/ subdirectory for the &amp;quot;CPython
API&amp;quot; with implementation details&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;My initial description of the directory content:&lt;/p&gt;
&lt;blockquote&gt;
The new subdirectory will contain &lt;tt class="docutils literal"&gt;#ifndef Py_LIMITED_API&lt;/tt&gt; code, not the
“Stable ABI” of &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0384/"&gt;PEP 384&lt;/a&gt;, but
more “implementation details” of CPython.&lt;/blockquote&gt;
&lt;p&gt;The change is backward compatible: &lt;tt class="docutils literal"&gt;#include &amp;lt;Python.h&amp;gt;&lt;/tt&gt; will still provide
exactly the same API. For example, &lt;tt class="docutils literal"&gt;object.h&lt;/tt&gt; automatically includes
&lt;tt class="docutils literal"&gt;cpython/object.h&lt;/tt&gt;. But &lt;tt class="docutils literal"&gt;Include/cpython/&lt;/tt&gt; headers must not be included
directly (it would fail with a compilation error).&lt;/p&gt;
&lt;p&gt;For example, &lt;tt class="docutils literal"&gt;Include/object.h&lt;/tt&gt; now ends with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#ifndef Py_LIMITED_API
#  define Py_CPYTHON_OBJECT_H
#  include  &amp;quot;cpython/object.h&amp;quot;
#  undef Py_CPYTHON_OBJECT_H
#endif
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;Include/cpython/object.h&lt;/tt&gt; structure (content replaced with &lt;tt class="docutils literal"&gt;...&lt;/tt&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#ifndef Py_CPYTHON_OBJECT_H
#  error &amp;quot;this header file must not be included directly&amp;quot;
#endif

#ifdef __cplusplus
extern &amp;quot;C&amp;quot; {
#endif

...

#ifdef __cplusplus
}
#endif
&lt;/pre&gt;
&lt;p&gt;In Python 3.8, the work is not complete. I tried to double- or even
triple-check my changes to ensure that I don't remove an API by mistake. This
work is still on-going in Python 3.9.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="summary-of-include-directories"&gt;
&lt;h2&gt;Summary of Include/ directories&lt;/h2&gt;
&lt;p&gt;The header files have been reorganized to better separate the different kinds
of APIs:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Include/*.h&lt;/span&gt;&lt;/tt&gt; should be the portable public stable C API.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Include/cpython/*.h&lt;/span&gt;&lt;/tt&gt; should be the unstable C API specific to CPython;
public API, with some private API prefixed by &lt;tt class="docutils literal"&gt;_Py&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;_PY&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Include/internal/*.h&lt;/span&gt;&lt;/tt&gt; is the private internal C API very specific to
CPython. This API comes with no backward compatibility warranty and should
not be used outside CPython. It is only exposed for very specific needs
like debuggers and profiles which has to access to CPython internals
without calling functions. This API is now installed by &lt;tt class="docutils literal"&gt;make install&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="convert-macros-to-static-inline-functions"&gt;
&lt;h2&gt;Convert macros to static inline functions&lt;/h2&gt;
&lt;p&gt;In &lt;a class="reference external" href="https://bugs.python.org/issue35059"&gt;bpo-35059&lt;/a&gt;, I converted some macros
to static inline functions:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_INCREF()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;Py_DECREF()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_XINCREF()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;Py_XDECREF()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PyObject_INIT()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;PyObject_INIT_VAR()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Private functions: &lt;tt class="docutils literal"&gt;_PyObject_GC_TRACK()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;_PyObject_GC_UNTRACK()&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;_Py_Dealloc()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Compared to macros, static inline functions have multiple advantages:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Parameter types and return type are well defined;&lt;/li&gt;
&lt;li&gt;They don't have issues specific to macros: see &lt;a class="reference external" href="https://gcc.gnu.org/onlinedocs/cpp/Macro-Pitfalls.html"&gt;GCC Macro Pitfals&lt;/a&gt;;&lt;/li&gt;
&lt;li&gt;Variables have a well defined local scope.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Python 3.7 uses ugly macros with comma and semicolon. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#define _Py_REF_DEBUG_COMMA ,
#define _Py_CHECK_REFCNT(OP) /* a semicolon */;

#define _Py_NewReference(op) (                          \
    _Py_INC_TPALLOCS(op) _Py_COUNT_ALLOCS_COMMA         \
    _Py_INC_REFTOTAL  _Py_REF_DEBUG_COMMA               \
    Py_REFCNT(op) = 1)
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0007/#c-dialect"&gt;Python 3.6 requires C99 standard of the C dialect&lt;/a&gt;. It was time to start
to use it :-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="removed-functions"&gt;
&lt;h2&gt;Removed functions&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue35713"&gt;bpo-35713&lt;/a&gt;: I removed
&lt;tt class="docutils literal"&gt;PyByteArray_Init()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;PyByteArray_Fini()&lt;/tt&gt; functions. They did nothing
since Python 2.7.4 and Python 3.2.0, were excluded from the limited API (stable
ABI), and were not documented.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue36728"&gt;bpo-36728&lt;/a&gt;: I also removed
&lt;tt class="docutils literal"&gt;PyEval_ReInitThreads()&lt;/tt&gt; function. It should not be called explicitly: use
&lt;tt class="docutils literal"&gt;PyOS_AfterFork_Child()&lt;/tt&gt; instead.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="python"></category><category term="c-api"></category></entry><entry><title>Python 3.8 sys.unraisablehook</title><link href="https://vstinner.github.io/sys-unraisablehook-python38.html" rel="alternate"></link><published>2019-06-15T01:00:00+02:00</published><updated>2019-06-15T01:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-06-15:/sys-unraisablehook-python38.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/dawnmanser/8046201692/"&gt;&lt;img alt="Hidden kitten" src="https://vstinner.github.io/images/hidden_kitten.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;I added a new &lt;a class="reference external" href="https://docs.python.org/dev/library/sys.html#sys.unraisablehook"&gt;sys.unraisablehook&lt;/a&gt; function to
allow to set a custom hook to control how &amp;quot;unraisable exceptions&amp;quot; are handled.
It is already testable in &lt;a class="reference external" href="https://pythoninsider.blogspot.com/2019/06/python-380b1-is-now-available-for.html"&gt;Python 3.8 beta1&lt;/a&gt;,
released last week!&lt;/p&gt;
&lt;p&gt;An &amp;quot;unraisable exception&amp;quot; is an error which happens when Python cannot report
it to the caller. Examples …&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/dawnmanser/8046201692/"&gt;&lt;img alt="Hidden kitten" src="https://vstinner.github.io/images/hidden_kitten.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;I added a new &lt;a class="reference external" href="https://docs.python.org/dev/library/sys.html#sys.unraisablehook"&gt;sys.unraisablehook&lt;/a&gt; function to
allow to set a custom hook to control how &amp;quot;unraisable exceptions&amp;quot; are handled.
It is already testable in &lt;a class="reference external" href="https://pythoninsider.blogspot.com/2019/06/python-380b1-is-now-available-for.html"&gt;Python 3.8 beta1&lt;/a&gt;,
released last week!&lt;/p&gt;
&lt;p&gt;An &amp;quot;unraisable exception&amp;quot; is an error which happens when Python cannot report
it to the caller. Examples: object finalizer error (&lt;tt class="docutils literal"&gt;__del__()&lt;/tt&gt;), weak
reference callback failure, error during a GC collection. At the C level, the
&lt;tt class="docutils literal"&gt;PyErr_WriteUnraisable()&lt;/tt&gt; function is called to handle such exception.&lt;/p&gt;
&lt;p&gt;Design the new hook was tricky, as its implementation.&lt;/p&gt;
&lt;p&gt;The photo shows an exception awaiting to catch you ;-)&lt;/p&gt;
&lt;div class="section" id="kill-python-at-the-first-unraisable-exception"&gt;
&lt;h2&gt;Kill Python at the first unraisable exception&lt;/h2&gt;
&lt;p&gt;One month ago, &lt;strong&gt;Thomas Grainger&lt;/strong&gt; opened &lt;a class="reference external" href="https://bugs.python.org/issue36829"&gt;bpo-36829&lt;/a&gt;: &amp;quot;CLI option to make
PyErr_WriteUnraisable abort the current process&amp;quot;. He wrote:&lt;/p&gt;
&lt;blockquote&gt;
Currently it's quite easy for these &lt;strong&gt;errors&lt;/strong&gt; to go &lt;strong&gt;unnoticed&lt;/strong&gt;. (...)
The point for me is that CI will fail if it happens, then &lt;strong&gt;I can use gdb&lt;/strong&gt;
to find out the cause&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Zackery Spytz&lt;/strong&gt; wrote the &lt;a class="reference external" href="https://github.com/python/cpython/pull/13175"&gt;PR 13175&lt;/a&gt; to add &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; abortunraisable&lt;/tt&gt;
command line option. When this option is used, &lt;tt class="docutils literal"&gt;PyErr_WriteUnraisable()&lt;/tt&gt;
calls &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Py_FatalError(&amp;quot;Unraisable&lt;/span&gt; exception&amp;quot;)&lt;/tt&gt; which calls &lt;tt class="docutils literal"&gt;abort()&lt;/tt&gt;: it
raises &lt;tt class="docutils literal"&gt;SIGABRT&lt;/tt&gt; signal which kills the process by default.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="handle-unraisable-exception-in-python-sys-unraisablehook"&gt;
&lt;h2&gt;Handle unraisable exception in Python: sys.unraisablehook&lt;/h2&gt;
&lt;p&gt;I concur with Thomas that it's easy to miss such exception, but I dislike
killing the process. It's not practical to have to use a low-level debugger
like gdb to handle such bug.&lt;/p&gt;
&lt;p&gt;I proposed a different design: add a new &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt; hook allowing
to use arbitrary Python code to handle an &amp;quot;unraisable exception&amp;quot;.&lt;/p&gt;
&lt;p&gt;I wrote a &lt;a class="reference external" href="https://bugs.python.org/issue36829#msg341868"&gt;hook example&lt;/a&gt; which
displays the Python stack where the exception occurred using the &lt;tt class="docutils literal"&gt;traceback&lt;/tt&gt;
module.&lt;/p&gt;
&lt;p&gt;I chose to pass an single object as argument to &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt;. The
object has 4 attributes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;exc_type: Exception type.&lt;/li&gt;
&lt;li&gt;exc_value: Exception value, can be None.&lt;/li&gt;
&lt;li&gt;exc_traceback: Exception traceback, can be None.&lt;/li&gt;
&lt;li&gt;object: Object causing the exception, can be None.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I wanted to design an &lt;strong&gt;extensible API&lt;/strong&gt;: keep the backward compatibility even
if tomorrow we want to add a new attribute to the object to pass more
information.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-source-parameter-to-the-warnings-module"&gt;
&lt;h2&gt;Adding source parameter to the warnings module&lt;/h2&gt;
&lt;p&gt;To explain the rationale of my proposed &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt; design (single
objeect with attributes), let me tell you my bad experience with the
&lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; module.&lt;/p&gt;
&lt;div class="section" id="use-tracemalloc-for-resourcewarning"&gt;
&lt;h3&gt;Use tracemalloc for ResourceWarning&lt;/h3&gt;
&lt;p&gt;In March 2016, I was tired how debugging &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; warnings: it's
hard to guess where the bug comes from. The warning is logged where the
resource is released, but I was interested by where the resource was allocated.&lt;/p&gt;
&lt;p&gt;My &lt;a class="reference external" href="https://docs.python.org/dev/library/tracemalloc.html"&gt;tracemalloc&lt;/a&gt; module
provides a convenient &lt;a class="reference external" href="https://docs.python.org/dev/library/tracemalloc.html#tracemalloc.get_object_traceback"&gt;get_object_traceback()&lt;/a&gt;
function which provides the traceback where any Python has been allocated.&lt;/p&gt;
&lt;p&gt;I opened &lt;a class="reference external" href="https://bugs.python.org/issue26604"&gt;bpo-26604&lt;/a&gt;: &amp;quot;ResourceWarning:
Use tracemalloc to display the traceback where an object was allocated when a
ResourceWarning is emitted&amp;quot;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="warnings-hooks-cannot-be-extended"&gt;
&lt;h3&gt;warnings hooks cannot be extended&lt;/h3&gt;
&lt;p&gt;The problem is that the &lt;tt class="docutils literal"&gt;showwarning()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;formatwarning()&lt;/tt&gt; functions of
&lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; can be overriden. They use a fixed number of positional
parameters:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def showwarning(message, category, filename, lineno, file=None, line=None): ...
def formatwarning(message, category, filename, lineno, line=None): ...
&lt;/pre&gt;
&lt;p&gt;If they are called with an additional parameter, they fail with a
&lt;tt class="docutils literal"&gt;TypeError&lt;/tt&gt;. I wanted to add a new &lt;tt class="docutils literal"&gt;source&lt;/tt&gt; parameter to these functions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="reuse-existing-warningmessage-class"&gt;
&lt;h3&gt;Reuse existing WarningMessage class&lt;/h3&gt;
&lt;p&gt;To extend the warnings module, I chose to rely on the existing
&lt;tt class="docutils literal"&gt;WarningMessage&lt;/tt&gt; class which can be used to &amp;quot;pack&amp;quot; all parameters as a single
object. This class was used by &lt;tt class="docutils literal"&gt;catch_warnings&lt;/tt&gt; context manager.&lt;/p&gt;
&lt;p&gt;I had to add new private &lt;tt class="docutils literal"&gt;_showwarnmsg()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;_formatwarnmsg()&lt;/tt&gt; functions.
They are called with a &lt;tt class="docutils literal"&gt;WarningMessage&lt;/tt&gt; instance. The implementation has to
detect when &lt;tt class="docutils literal"&gt;showwarning()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;formatwarning()&lt;/tt&gt; is overriden: the
overriden function must be called with the legacy API in this case. The
backward compatibility requirement makes the implementation complex.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="regression"&gt;
&lt;h3&gt;Regression&lt;/h3&gt;
&lt;p&gt;After Python 3.6 was released with my new feature, &lt;a class="reference external" href="https://bugs.python.org/issue35178"&gt;bpo-35178&lt;/a&gt; was reported. The &lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; module
called a custom &lt;tt class="docutils literal"&gt;formatwarning()&lt;/tt&gt; with the &lt;tt class="docutils literal"&gt;line&lt;/tt&gt; argument passed as a
keyword argument, whereas other arguments are passed as positional arguments.
The &lt;a class="reference external" href="https://github.com/python/cpython/commit/be7c460fb50efe3b88a00281025d76acc62ad2fd"&gt;fix was trivial&lt;/a&gt;,
but it shows that backward compatibility is hard.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="example"&gt;
&lt;h3&gt;Example&lt;/h3&gt;
&lt;p&gt;By the way, example of the feature using a &lt;tt class="docutils literal"&gt;filebug.py&lt;/tt&gt; script:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def func():
    f = open(__file__)
    f = None

func()
&lt;/pre&gt;
&lt;p&gt;The feature adds the &amp;quot;Object allocated at&amp;quot; traceback, whereas existing &lt;tt class="docutils literal"&gt;f =
None&lt;/tt&gt; output is worthless.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -Wd -X tracemalloc=5 filebug.py
filebug.py:3: ResourceWarning: unclosed file &amp;lt;_io.TextIOWrapper name='filebug.py' mode='r' encoding='UTF-8'&amp;gt;
  f = None
Object allocated at (most recent call first):
  File &amp;quot;filebug.py&amp;quot;, lineno 2
    f = open(__file__)
  File &amp;quot;filebug.py&amp;quot;, lineno 5
    func()
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="limitations-of-my-unraisablehook-idea"&gt;
&lt;h2&gt;Limitations of my unraisablehook idea&lt;/h2&gt;
&lt;p&gt;To come back to &lt;a class="reference external" href="https://bugs.python.org/issue36829"&gt;bpo-36829&lt;/a&gt;, I identified
a limitation in my &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt; idea: unraisable exceptions which
occurs very late during Python finalization cannot be handled by a custom hook.&lt;/p&gt;
&lt;p&gt;Thomas said that he is fine with having to use &lt;tt class="docutils literal"&gt;gdb&lt;/tt&gt; to debug an issue
during Python finalization.&lt;/p&gt;
&lt;p&gt;In my experience, using &lt;tt class="docutils literal"&gt;gdb&lt;/tt&gt; on system Python is unpleasant, since it's
usually deeply optimized (PGO + LTO optimizations). gdb fails to read variables
which are only displayed as &lt;tt class="docutils literal"&gt;&amp;lt;optimized out&amp;gt;&lt;/tt&gt;. By the way, that's why I fixed
the &lt;a class="reference external" href="https://docs.python.org/dev/whatsnew/3.8.html#debug-build-uses-the-same-abi-as-release-build"&gt;debug build of Python to be ABI compatible with a release build&lt;/a&gt;,
but that's a different story.&lt;/p&gt;
&lt;p&gt;Thomas's idea of killing the process allows to detect unraisable exceptions
whenever they occur.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="api-discussed-on-python-dev"&gt;
&lt;h2&gt;API discussed on python-dev&lt;/h2&gt;
&lt;p&gt;I started a discussion on python-dev to get more feedback: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157436.html"&gt;bpo-36829: Add
sys.unraisablehook()&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="new-exception-while-handling-an-exception"&gt;
&lt;h3&gt;New exception while handling an exception&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Nathaniel Smith&lt;/strong&gt; asked what happens if a custom hook raises a new exception?&lt;/p&gt;
&lt;p&gt;This problem is easy to fix: &lt;tt class="docutils literal"&gt;PyErr_WriteUnraisable()&lt;/tt&gt; calls the default
hook to handle the new exception (I already implemented this solution).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="positional-arguments"&gt;
&lt;h3&gt;Positional arguments&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Serhiy Storchaka&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157439.html"&gt;preferred&lt;/a&gt; passing 5
positional arguments (exc_type, exc_value, exc_tb, obj and msg):&lt;/p&gt;
&lt;blockquote&gt;
Currently we have no plans for adding more details, and I do not think that
we will need to do this in future.&lt;/blockquote&gt;
&lt;p&gt;Later, he added:&lt;/p&gt;
&lt;blockquote&gt;
If you have plans for adding new details in future, I propose to add a 6th
parameter &amp;quot;context&amp;quot; or &amp;quot;extra&amp;quot; (always None currently). It is as extensible
as packing all arguments into a single structure, but you do not need to
introduce the structure type and create its instance until you need to pass
additional info.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="reuse-sys-excepthook"&gt;
&lt;h3&gt;Reuse sys.excepthook&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Steve Dower&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157453.html"&gt;proposed to reuse sys.excepthook&lt;/a&gt;, rather
than adding a new hook, and &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157465.html"&gt;create a new exception to pass extra info&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Nathaniel&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157460.html"&gt;explained&lt;/a&gt; that
&lt;tt class="docutils literal"&gt;sys.excepthook&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt; have different behavior and so
require to be different.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="object-resurrection"&gt;
&lt;h3&gt;Object resurrection&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Steve Dower&lt;/strong&gt; was &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157452.html"&gt;concerned by object resurrection&lt;/a&gt; and
proposed to only pass &lt;tt class="docutils literal"&gt;repr(obj)&lt;/tt&gt; to the hook.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157463.html"&gt;I explained&lt;/a&gt; that an
object can only be resurrected after its finalization, which is different than
deallocation. Accessing a finalized object should not crash Python. The
deallocation makes an object unsable, except that deallocation only happens
once the last references to an object is gone, and so the object is no longer
accessible.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157467.html"&gt;Nathaniel added&lt;/a&gt; that
&lt;tt class="docutils literal"&gt;repr()&lt;/tt&gt; would limit features of the hook:&lt;/p&gt;
&lt;blockquote&gt;
A clever hook might want the actual object, so it can pretty-print it, or
open an interactive debugger and let it you examine it, or something.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="naming"&gt;
&lt;h3&gt;Naming&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Gregory P. Smith&lt;/strong&gt; proposed the term &amp;quot;uncatchable&amp;quot; rather than &amp;quot;unraisable&amp;quot;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="keyword-only-arguments"&gt;
&lt;h3&gt;Keyword-only arguments&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Barry Warsaw&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157457.html"&gt;suggested&lt;/a&gt; to
consider keyword-only arguments to help future proof the call signature.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="avoid-redundant-exc-type-and-exc-traceback-parameters"&gt;
&lt;h3&gt;Avoid redundant exc_type and exc_traceback parameters&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Petr Viktorin&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157459.html"&gt;asked&lt;/a&gt; why
&lt;tt class="docutils literal"&gt;(exc_type, exc_value, exc_traceback)&lt;/tt&gt; triple is needed, wheras &lt;em&gt;exc_type&lt;/em&gt;
could be get from &lt;tt class="docutils literal"&gt;type(exc_type)&lt;/tt&gt; and &lt;em&gt;exc_traceback&lt;/em&gt; from
&lt;tt class="docutils literal"&gt;exc_value.__traceback__&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2019-May/157462.html"&gt;I made some tests&lt;/a&gt;.
&lt;em&gt;exc_value&lt;/em&gt; can be &lt;tt class="docutils literal"&gt;NULL&lt;/tt&gt; sometimes. In some cases, &lt;em&gt;exc_traceback&lt;/em&gt; can be
set, whereas &lt;tt class="docutils literal"&gt;exc_value.__traceback__&lt;/tt&gt; is not set (&lt;tt class="docutils literal"&gt;None&lt;/tt&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="productive-discussion"&gt;
&lt;h2&gt;Productive discussion!&lt;/h2&gt;
&lt;p&gt;As usual, the python-dev discussion was very productive. Each corner case has
been discussed and the API has been challenged.&lt;/p&gt;
&lt;p&gt;Thanks to Petr's remark, I enhanced the existing hook to instanciate an
exception if &lt;em&gt;exc_value&lt;/em&gt; is &lt;tt class="docutils literal"&gt;NULL&lt;/tt&gt;, create a traceback if &lt;em&gt;exc_traceback&lt;/em&gt; is
&lt;tt class="docutils literal"&gt;NULL&lt;/tt&gt;, and set &lt;tt class="docutils literal"&gt;exc_value.__traceback__&lt;/tt&gt; to the traceback. If one of these
actions fail, the failure is silently ignored.&lt;/p&gt;
&lt;p&gt;I also paid more attention to object resurrection.&lt;/p&gt;
&lt;p&gt;After one week of discussion, I was not convinced by other alternative
propositions, whereas multiple core devs wrote that they like my API.&lt;/p&gt;
&lt;p&gt;I decided to push my &lt;a class="reference external" href="https://github.com/python/cpython/commit/ef9d9b63129a2f243591db70e9a2dd53fab95d86"&gt;commit ef9d9b63&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit ef9d9b63129a2f243591db70e9a2dd53fab95d86
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Wed May 22 11:28:22 2019 +0200

    bpo-36829: Add sys.unraisablehook() (GH-13187)

    Add new sys.unraisablehook() function which can be overridden to
    control how &amp;quot;unraisable exceptions&amp;quot; are handled. It is called when an
    exception has occurred but there is no way for Python to handle it.
    For example, when a destructor raises an exception or during garbage
    collection (gc.collect()).
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="new-err-msg-attribute"&gt;
&lt;h2&gt;New err_msg attribute&lt;/h2&gt;
&lt;p&gt;Unraisable exception were logged with no context, only an hardcoded
&amp;quot;Exception ignored in:&amp;quot; error message.&lt;/p&gt;
&lt;p&gt;Early in &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt; discussion, &lt;strong&gt;Serhiy&lt;/strong&gt; proposed to add a new
&lt;em&gt;err_msg&lt;/em&gt; parameter to pass an optional error message.&lt;/p&gt;
&lt;p&gt;I implemented this idea in &lt;a class="reference external" href="https://bugs.python.org/issue36829"&gt;bpo-36829&lt;/a&gt;
with &lt;a class="reference external" href="https://github.com/python/cpython/commit/71c52e3048dd07567f0c690eab4e5d57be66f534"&gt;commit 71c52e30&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 71c52e3048dd07567f0c690eab4e5d57be66f534
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Mon May 27 08:57:14 2019 +0200

    bpo-36829: Add _PyErr_WriteUnraisableMsg() (GH-13488)
&lt;/pre&gt;
&lt;p&gt;I was able to add a new parameter as a new &lt;em&gt;err_msg&lt;/em&gt; attribute without breaking the
backward compatibility!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="test-support-catch-unraisable-exception"&gt;
&lt;h2&gt;test.support.catch_unraisable_exception()&lt;/h2&gt;
&lt;p&gt;I wrote a new context manager catching unraisable exceptions:
&lt;tt class="docutils literal"&gt;test.support.catch_unraisable_exception()&lt;/tt&gt;. The exception is stored and so
can be used for tests in the context manager, but cleared at context manager
exit.&lt;/p&gt;
&lt;p&gt;I modified tests to use this new context manager:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;test_coroutines&lt;/li&gt;
&lt;li&gt;test_cprofile&lt;/li&gt;
&lt;li&gt;test_exceptions&lt;/li&gt;
&lt;li&gt;test_generators&lt;/li&gt;
&lt;li&gt;test_io&lt;/li&gt;
&lt;li&gt;test_raise&lt;/li&gt;
&lt;li&gt;test_ssl&lt;/li&gt;
&lt;li&gt;test_thread&lt;/li&gt;
&lt;li&gt;test_yield_from&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
class BrokenDel:
    def __del__(self):
        raise ValueError(&amp;quot;del is broken&amp;quot;)

obj = BrokenDel()
with support.catch_unraisable_exception() as cm:
    del obj
    self.assertEqual(cm.unraisable.object, BrokenDel.__del__)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="test-io-memory-leak-regression"&gt;
&lt;h2&gt;test_io memory leak regression&lt;/h2&gt;
&lt;p&gt;I modified test_io to ignore expected unraisable exceptions:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit c15a682603a47f5aef5025f6a2e3babb699273d6
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Thu Jun 13 00:23:49 2019 +0200

    bpo-37223: test_io: silence destructor errors (GH-14031)
&lt;/pre&gt;
&lt;p&gt;This change introduced a memory leak, &lt;a class="reference external" href="https://bugs.python.org/issue37261"&gt;bpo-37261&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
test_io leaked [23208, 23204, 23208] references, sum=69620
test_io leaked [7657, 7655, 7657] memory blocks, sum=22969
&lt;/pre&gt;
&lt;p&gt;The problem was this &lt;tt class="docutils literal"&gt;catch_unraisable_exception&lt;/tt&gt; method:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def __exit__(self, *exc_info):
    del self.unraisable
    sys.unraisablehook = self._old_hook
&lt;/pre&gt;
&lt;p&gt;Sometimes, &lt;tt class="docutils literal"&gt;del self.unraisable&lt;/tt&gt; triggered a new unraisable exception.  At
this point, &lt;tt class="docutils literal"&gt;catch_unraisable_exception&lt;/tt&gt; hook was still registered:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def _hook(self, unraisable):
    self.unraisable = unraisable
&lt;/pre&gt;
&lt;p&gt;At the end, &lt;tt class="docutils literal"&gt;del self.unraisable&lt;/tt&gt; instruction &lt;em&gt;indirectly&lt;/em&gt; sets again the
&lt;tt class="docutils literal"&gt;self.unraisable&lt;/tt&gt; attribute.&lt;/p&gt;
&lt;div class="section" id="first-fix"&gt;
&lt;h3&gt;First fix&lt;/h3&gt;
&lt;p&gt;First, I suspected that the  &lt;tt class="docutils literal"&gt;io.BufferedRWPair&lt;/tt&gt; object which triggered the
first unraisable exception was &lt;strong&gt;resurrected&lt;/strong&gt;, and that &lt;tt class="docutils literal"&gt;del
self.unraisable&lt;/tt&gt; called again its finalizer or deallocator, which triggered
the &lt;em&gt;same&lt;/em&gt; unraisable exception again.&lt;/p&gt;
&lt;p&gt;My first attempt to fix the issue was to clear the &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt; by
setting it to &lt;tt class="docutils literal"&gt;None&lt;/tt&gt;, and only later delete the attribute:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def __exit__(self, *exc_info):
    self.unraisablehook = None
    sys.unraisablehook = self._old_hook
    del self.unraisable
&lt;/pre&gt;
&lt;p&gt;If &lt;tt class="docutils literal"&gt;self.unraisablehook = None&lt;/tt&gt; triggers a new unraisable exception, it is
silently ignored.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="second-correct-fix"&gt;
&lt;h3&gt;Second correct fix&lt;/h3&gt;
&lt;p&gt;But when I chatted with &lt;strong&gt;Pablo Galindo&lt;/strong&gt;, he told me that an object cannot be
finalized twice thanks to &lt;strong&gt;Antoine Pitrou&lt;/strong&gt;'s &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0442/"&gt;PEP 442: Safe object finalization&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I looked again into gdb. Oh. In fact, it's more subtle. &lt;tt class="docutils literal"&gt;del self.unraisable&lt;/tt&gt;
clears the last reference to &lt;tt class="docutils literal"&gt;BufferedRWPair&lt;/tt&gt; which calls its
&lt;strong&gt;deallocator&lt;/strong&gt;. The dealloactor indirectly calls the &lt;tt class="docutils literal"&gt;BufferedWriter&lt;/tt&gt;
finalizer; the &lt;tt class="docutils literal"&gt;BufferedWriter&lt;/tt&gt; was stored in the &lt;tt class="docutils literal"&gt;BufferedRWPair&lt;/tt&gt;. This
finalizer triggers a new unraisable exception.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;BufferedRWPair&lt;/tt&gt; does not trigger two unraisable exception. It's a different
object (&lt;tt class="docutils literal"&gt;BufferedWriter&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;My final fix is to restore the old hook before deleting the &lt;tt class="docutils literal"&gt;unraisable&lt;/tt&gt;
attribute:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def __exit__(self, *exc_info):
    sys.unraisablehook = self._old_hook
    del self.unraisable
&lt;/pre&gt;
&lt;p&gt;And fix test_io using two nested context managers:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# Ignore BufferedWriter (of the BufferedRWPair) unraisable exception
with support.catch_unraisable_exception():
    # Ignore BufferedRWPair unraisable exception
    with support.catch_unraisable_exception():
        pair = None
        support.gc_collect()
    support.gc_collect()
&lt;/pre&gt;
&lt;p&gt;I also documented corner cases in &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt; documentation:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt; can be overridden to control how unraisable
exceptions are handled.&lt;/p&gt;
&lt;p&gt;Storing &lt;em&gt;exc_value&lt;/em&gt; using a custom hook can create a &lt;strong&gt;reference cycle&lt;/strong&gt;. It
should be cleared explicitly to break the reference cycle when the exception
is no longer needed.&lt;/p&gt;
&lt;p&gt;Storing &lt;em&gt;object&lt;/em&gt; using a custom hook &lt;strong&gt;can resurrect&lt;/strong&gt; it if it is set to an
object which is being finalized. Avoid storing &lt;em&gt;object&lt;/em&gt; after the custom
hook completes to avoid resurrecting objects.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="regrtest-now-detects-unraisable-exceptions"&gt;
&lt;h2&gt;regrtest now detects unraisable exceptions&lt;/h2&gt;
&lt;p&gt;Once I fixed tests to silence all expected unraisable exceptions, I created
&lt;a class="reference external" href="https://bugs.python.org/issue37069"&gt;bpo-37069&lt;/a&gt; to modify regrtest to install
a custom hook. I merged my &lt;a class="reference external" href="https://github.com/python/cpython/commit/95f61c8b1619e736bd5e29a0da0183234634b6e8"&gt;commit 95f61c8b&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 95f61c8b1619e736bd5e29a0da0183234634b6e8
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Thu Jun 13 01:09:04 2019 +0200

    bpo-37069: regrtest uses sys.unraisablehook (GH-13759)

    regrtest now uses sys.unraisablehook() to mark a test as &amp;quot;environment
    altered&amp;quot; (ENV_CHANGED) if it emits an &amp;quot;unraisable exception&amp;quot;.
    Moreover, regrtest logs a warning in this case.

    Use &amp;quot;python3 -m test --fail-env-changed&amp;quot; to catch unraisable
    exceptions in tests.
&lt;/pre&gt;
&lt;p&gt;A test is marked as &amp;quot;environment altered&amp;quot; (ENV_CHANGED) if the test triggers an
unraisable exception. Using &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--fail-env-changed&lt;/span&gt;&lt;/tt&gt; option (option used by
default on all Python CIs), a test is marked as failed in this case.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="hook-features"&gt;
&lt;h2&gt;Hook features&lt;/h2&gt;
&lt;p&gt;sys.unraisablehook allows to set a custom hook to handle unraisable exceptions.
It opens many interesting features:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Log the exception into system logs, over the network, or open a popup.&lt;/li&gt;
&lt;li&gt;Inspect the Python stack: &lt;tt class="docutils literal"&gt;traceback.print_stack()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Inspect &lt;em&gt;object&lt;/em&gt; content (object which caused the exception)&lt;/li&gt;
&lt;li&gt;Get the traceback where &lt;em&gt;object&lt;/em&gt; has been allocated:
&lt;tt class="docutils literal"&gt;tracemalloc.get_object_traceback()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;By the way, reimplementing Thomas's initial idea became trivial:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
import signal, sys

def abort_hook(unraisable):
    signal.raise_signal(signal.SIGABRT)

sys.unraisablehook = abort_hook
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="threading-excepthook"&gt;
&lt;h2&gt;threading.excepthook&lt;/h2&gt;
&lt;p&gt;Since I was happy of &lt;tt class="docutils literal"&gt;sys.unraisablehook&lt;/tt&gt;, I decided to work on the 14-years
old issue &lt;a class="reference external" href="https://bugs.python.org/issue1230540"&gt;bpo-1230540&lt;/a&gt;: I proposed to
add &lt;a class="reference external" href="https://docs.python.org/dev/library/threading.html#threading.excepthook"&gt;threading.excepthook()&lt;/a&gt;,
but that's a different story!&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="python"></category></entry><entry><title>asyncio WSASend() memory leak</title><link href="https://vstinner.github.io/asyncio-proactor-wsasend-memory-leak.html" rel="alternate"></link><published>2019-03-06T20:00:00+01:00</published><updated>2019-03-06T20:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-03-06:/asyncio-proactor-wsasend-memory-leak.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/jronaldlee/5996590138/"&gt;&lt;img alt="Leaking tap" src="https://vstinner.github.io/images/leaking_tap.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;I fixed multiple bugs in asyncio &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt; previously. But test_asyncio
still failed sometimes. I noticed a memory leak in &lt;tt class="docutils literal"&gt;test_asyncio&lt;/tt&gt; which will
haunt me for 1 year in 2018...&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Yet another example of a test failure which looks harmless but hides a
critical bug.&lt;/strong&gt; The bug is that sending a …&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/jronaldlee/5996590138/"&gt;&lt;img alt="Leaking tap" src="https://vstinner.github.io/images/leaking_tap.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;I fixed multiple bugs in asyncio &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt; previously. But test_asyncio
still failed sometimes. I noticed a memory leak in &lt;tt class="docutils literal"&gt;test_asyncio&lt;/tt&gt; which will
haunt me for 1 year in 2018...&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Yet another example of a test failure which looks harmless but hides a
critical bug.&lt;/strong&gt; The bug is that sending a network packet on Windows using
asyncio &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt; can leak the packet. With such bug, it is easy to
imagine a very quick increase of the memory footprint of a network server...&lt;/p&gt;
&lt;p&gt;I'm curious why nobody noticed it before me? For me, the only explanation is
that nobody was running a server using &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt;. Before Python
3.8, &lt;tt class="docutils literal"&gt;SelectorEventLoop&lt;/tt&gt; was the default asyncio event loop on Windows.
&lt;a class="reference external" href="https://bugs.python.org/issue34687"&gt;bpo-34687&lt;/a&gt;: Andrew Svetlov, Yury
Selivanov and me agreed to make &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt; the default in Python
3.8! &lt;tt class="docutils literal"&gt;Lib/asyncio/windows_events.py&lt;/tt&gt; change of my &lt;a class="reference external" href="https://github.com/python/cpython/commit/6ea29c5e90dde6c240bd8e0815614b52ac307ea1"&gt;commit 6ea29c5e&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-DefaultEventLoopPolicy = WindowsSelectorEventLoopPolicy
+DefaultEventLoopPolicy = WindowsProactorEventLoopPolicy
&lt;/pre&gt;
&lt;p&gt;The bug wasn't a regression. It was only discovered 5 years after the code has
been written thanks to new tests.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;UPDATE:&lt;/strong&gt; I updated the article to add the &amp;quot;Regression? Nope&amp;quot; section and
elaborate the Conclusion.&lt;/p&gt;
&lt;p&gt;Previous article:
&lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-wsarecv-cancellation-data-loss.html"&gt;asyncio: WSARecv() cancellation causing data loss&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="yet-another-random-buildbot-failure"&gt;
&lt;h2&gt;Yet another random buildbot failure&lt;/h2&gt;
&lt;p&gt;One day at the end of January 2018, I noticed a new failure on the AMD64
Windows8.1 Refleaks 3.x&amp;quot; buildbot worker. I reported &lt;a class="reference external" href="https://bugs.python.org/issue32710"&gt;bpo-32710&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;AMD64 Windows8.1 Refleaks 3.x:
&lt;a class="reference external" href="http://buildbot.python.org/all/#/builders/80/builds/118"&gt;http://buildbot.python.org/all/#/builders/80/builds/118&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;test_asyncio leaked [4, 4, 3] memory blocks, sum=11&lt;/p&gt;
&lt;p&gt;I reproduced the issue. I'm running test.bisect to try to isolate this bug.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Only 15 minutes later thanks to my &lt;tt class="docutils literal"&gt;test.bisect&lt;/tt&gt; tool, I identified the
leaking test, &lt;strong&gt;test_sendfile_close_peer_in_middle_of_receiving()&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
It seems to be related to sendfile():

C:\vstinner\python\master&amp;gt;python -m test -R 3:3 test_asyncio \
    -m test.test_asyncio.test_events.ProactorEventLoopTests.test_sendfile_close_peer_in_middle_of_receiving
...
test_asyncio leaked [1, 2, 1] memory blocks, sum=4
&lt;/pre&gt;
&lt;p&gt;The test is identified, so it should take a few hours, maximum, to fix the bug,
no? We will see...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="april"&gt;
&lt;h2&gt;April&lt;/h2&gt;
&lt;p&gt;3 months later, I asked:&lt;/p&gt;
&lt;blockquote&gt;
The test is still leaking memory blocks. Any progress on investigating the
issue?&lt;/blockquote&gt;
&lt;p&gt;Nobody replied.&lt;/p&gt;
&lt;p&gt;At that time, I was busy to fix a bunch of various other bugs reported by
buildbots which were easier to fix and I was kind of exhausted by asyncio, I
didn't want to touch it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="june"&gt;
&lt;h2&gt;June&lt;/h2&gt;
&lt;p&gt;Oh, I found again this bug while working on my &lt;a class="reference external" href="https://github.com/python/cpython/pull/7827"&gt;PR 7827&lt;/a&gt; (detect handle leaks on Windows
in regrtest).&lt;/p&gt;
&lt;p&gt;In 2018, I was very busy with fixing dozens of multiprocessing bugs (fix tests
but also fix some bugs in multiprocessing).&lt;/p&gt;
&lt;p&gt;For example, I noticed another memory leak on AMD64 Windows8.1 Refleaks
3.7, &lt;a class="reference external" href="https://bugs.python.org/issue33735#msg318425"&gt;bpo-33735&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="http://buildbot.python.org/all/#/builders/132/builds/154"&gt;http://buildbot.python.org/all/#/builders/132/builds/154&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;test_multiprocessing_spawn leaked [1, 2, 1] memory blocks, sum=4&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This test_multiprocessing_spawn leak and the test_asyncio leak on Windows
Refleaks haunted me in 2018...&lt;/p&gt;
&lt;p&gt;In fact, it wasn't a real leak. After a few runs, &lt;a class="reference external" href="https://bugs.python.org/issue33735#msg320948"&gt;the test stopped to leak&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test test_multiprocessing_spawn \
    -m test.test_multiprocessing_spawn.WithProcessesTestPool.test_imap_unordered \
    -R 1:30
...
test_multiprocessing_spawn leaked [4, 5, 1, 5, 1, 2, 0, 0, 0, ..., 0, 0, 0] memory blocks, sum=18
test_multiprocessing_spawn failed in 42 sec 470 ms
&lt;/pre&gt;
&lt;p&gt;I fixed the test with &lt;a class="reference external" href="https://github.com/python/cpython/commit/23401fb960bb94e6ea62d2999527968d53d3fc65"&gt;commit
23401fb9&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I fixed other multiprocessing bugs like &lt;a class="reference external" href="https://bugs.python.org/issue33929"&gt;bpo-33929&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;These multiprocessing bugs kept me busy.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="july-december"&gt;
&lt;h2&gt;July-December&lt;/h2&gt;
&lt;p&gt;Nothing. Nobody looked at the issue.&lt;/p&gt;
&lt;p&gt;Again, I was busy fixing various test failures reported by buildbots.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="update-in-january-2019"&gt;
&lt;h2&gt;Update in January 2019&lt;/h2&gt;
&lt;p&gt;In January 2019, after months of hard work on fixing every single buildbot
failure, I realized &lt;strong&gt;suddenly&lt;/strong&gt; that the &lt;tt class="docutils literal"&gt;test_asyncio&lt;/tt&gt; leak, &lt;a class="reference external" href="https://bugs.python.org/issue32710"&gt;bpo-32710&lt;/a&gt;, was one of the last unfixed known test
failure! So I decided to have a new look at it.&lt;/p&gt;
&lt;p&gt;Update on &lt;tt class="docutils literal"&gt;test_asyncio.test_sendfile.ProactorEventLoopTests&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;test_sendfile_close_peer_in_the_middle_of_receiving()&lt;/tt&gt; leaks 1 reference per
run: this leak was the obvious bug &lt;a class="reference external" href="https://bugs.python.org/issue35682"&gt;bpo-35682&lt;/a&gt;, I already fixed it with &lt;a class="reference external" href="https://github.com/python/cpython/commit/80fda712c83f5dd9560d42bf2aa65a72b18b7759"&gt;commit
80fda712&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;test_sendfile_fallback_close_peer_in_the_middle_of_receiving()&lt;/tt&gt; leaks 1
reference per run: &lt;strong&gt;I don't understand why&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note: I had to copy/paste these test names a lot of times. Pleeease, for my
comfort, use shorter test names! :-) (I had to copy/paste them, I don't think
that a regular human is able to type these very long names!)&lt;/p&gt;
&lt;p&gt;I spent a lot of time to investigate
&lt;tt class="docutils literal"&gt;test_sendfile_fallback_close_peer_in_the_middle_of_receiving()&lt;/tt&gt; leak and I don't
understand the issue.&lt;/p&gt;
&lt;p&gt;The main loop is &lt;tt class="docutils literal"&gt;BaseEventLoop._sendfile_fallback()&lt;/tt&gt;. For
the specific case of this test, the loop can be simplified to:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
proto = _SendfileFallbackProtocol(transp)
try:
    while True:
        data = b'x' * (1024 * 64)
        await proto.drain()
        transp.write(data)
finally:
    await proto.restore()
&lt;/pre&gt;
&lt;p&gt;The server closes the connection after it gets 1024 bytes. The client socket
gets a &lt;tt class="docutils literal"&gt;ConnectionAbortedError&lt;/tt&gt; exception in
&lt;tt class="docutils literal"&gt;_ProactorBaseWritePipeTransport._loop_writing()&lt;/tt&gt; which calls &lt;tt class="docutils literal"&gt;_fatal_error()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
except OSError as exc:
    self._fatal_error(exc, 'Fatal write error on pipe transport')
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;_fatal_error()&lt;/tt&gt; calls &lt;tt class="docutils literal"&gt;_force_close()&lt;/tt&gt; which sets &lt;tt class="docutils literal"&gt;_closing&lt;/tt&gt; to
&lt;tt class="docutils literal"&gt;True&lt;/tt&gt;, and calls &lt;tt class="docutils literal"&gt;protocol.connection_lost()&lt;/tt&gt;. In the meanwhile,
&lt;tt class="docutils literal"&gt;drain()&lt;/tt&gt; raises &lt;tt class="docutils literal"&gt;ConnectionError&lt;/tt&gt; because &lt;tt class="docutils literal"&gt;is_closing()&lt;/tt&gt; is true:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
async def drain(self):
    if self._transport.is_closing():
        raise ConnectionError(&amp;quot;Connection closed by peer&amp;quot;)
    ...
&lt;/pre&gt;
&lt;p&gt;Said differently: &lt;strong&gt;everything works as expected&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="regression-caused-by-my-previous-proactor-fix"&gt;
&lt;h2&gt;Regression caused by my previous proactor fix?&lt;/h2&gt;
&lt;p&gt;I suspected my own &lt;a class="reference external" href="https://github.com/python/cpython/commit/79790bc35fe722a49977b52647f9b5fe1deda2b7"&gt;commit 79790bc3&lt;/a&gt;
pushed 7 months ago to fix a race condition in WSARecv() causing data loss
(that's my previous article: &lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-wsarecv-cancellation-data-loss.html"&gt;asyncio: WSARecv() cancellation causing data loss&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;Hint: nah, it's unrelated. Moreover, this change has been pushed in May,
whereas I reported &lt;a class="reference external" href="https://bugs.python.org/issue32710"&gt;bpo-32710 leak&lt;/a&gt; in
January.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="short-script-reproducing-the-leak"&gt;
&lt;h2&gt;Short script reproducing the leak&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Identifying a leak of a single reference is really hard&lt;/strong&gt; since the test uses
hundreds of Python objects! My blocker issue was to repeat the test enough
times to trigger the leak N times rather than getting a leak of exactly a
single Python reference. The problem was that the test failed when ran more
than once.&lt;/p&gt;
&lt;p&gt;All my previous attempts to identify the bug failed:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Use &lt;tt class="docutils literal"&gt;gc.get_referrers()&lt;/tt&gt; to track references between Python objects.&lt;/li&gt;
&lt;li&gt;Use &lt;tt class="docutils literal"&gt;tracemalloc&lt;/tt&gt; to track memory usage: the leak is too small, it's lost
in the results &amp;quot;noise&amp;quot;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I decided to do what I should have done first: &lt;strong&gt;remove as much code as
possible&lt;/strong&gt; to reduce the code that I have to audit. I removed most Python
imports, I inlined manually function calls, I removed a lot of code which was
unused in the test, etc.&lt;/p&gt;
&lt;p&gt;After a few hours, I managed to reduce the giant pile of code used by the test
into a very short script of only 159 lines of Python code: &lt;a class="reference external" href="https://bugs.python.org/file48030/test_aiosend.py"&gt;test_aiosend.py&lt;/a&gt;. The script doesn't call
the asyncio &lt;tt class="docutils literal"&gt;sendfile()&lt;/tt&gt; implementation, but uses its own copy of the code,
simplified to do exactly what the test needs:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
async def sendfile(transp):
    proto = _SendfileFallbackProtocol(transp)
    try:
        data = b'x' * (1024 * 24)
        while True:
            await proto.drain()
            transp.write(data)
    finally:
        await proto.restore()
&lt;/pre&gt;
&lt;p&gt;with a local copy of the code of &lt;tt class="docutils literal"&gt;_SendfileFallbackProtocol&lt;/tt&gt; class.&lt;/p&gt;
&lt;p&gt;Having all code involved in the bug in a single file is way more efficient to
follow the control flow and understands what happens.&lt;/p&gt;
&lt;p&gt;The original code is waaaaay more complex, scattered across multiple Python
files in &lt;tt class="docutils literal"&gt;Lib/asyncio&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;Lib/test/test_asyncio/&lt;/tt&gt; directories.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="root-bug-identified-wsasend"&gt;
&lt;h2&gt;Root bug identified: WSASend()&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;It took me 1 year, a few sleepless nights, multiple attempts to understand
the leak, but I eventually found it!&lt;/strong&gt; WSASend() doesn't release the memory if
it fails immediately. I expected something way more complex, but it's that
simple...&lt;/p&gt;
&lt;p&gt;Using the &lt;tt class="docutils literal"&gt;test_aiosend.py&lt;/tt&gt; script that I created, I was finally able to
repeat the test in a loop. Thanks to that, it became obvious using
&lt;tt class="docutils literal"&gt;tracemalloc&lt;/tt&gt; that the leaked memory was the memory passed to &lt;tt class="docutils literal"&gt;WSASend()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/a234e148394c2c7419372ab65b773d53a57f3625"&gt;commit a234e148&lt;/a&gt;
to fix &lt;tt class="docutils literal"&gt;WSASend()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit a234e148394c2c7419372ab65b773d53a57f3625
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Tue Jan 8 14:23:09 2019 +0100

    bpo-32710: Fix leak in Overlapped_WSASend() (GH-11469)

    Fix a memory leak in asyncio in the ProactorEventLoop when ReadFile()
    or WSASend() overlapped operation fail immediately: release the
    internal buffer.
&lt;/pre&gt;
&lt;p&gt;I was very disappointed by the simplicity of the fix, &lt;strong&gt;it only adds a single
line&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
diff --git a/Modules/overlapped.c b/Modules/overlapped.c
index 69875a7f37da..bbaa4fb3008f 100644
--- a/Modules/overlapped.c
+++ b/Modules/overlapped.c
&amp;#64;&amp;#64; -1011,6 +1012,7 &amp;#64;&amp;#64; Overlapped_WSASend(OverlappedObject *self, PyObject *args)
         case ERROR_IO_PENDING:
             Py_RETURN_NONE;
         default:
+            PyBuffer_Release(&amp;amp;self-&amp;gt;user_buffer);
             self-&amp;gt;type = TYPE_NOT_STARTED;
             return SetFromWindowsErr(err);
     }
&lt;/pre&gt;
&lt;p&gt;So what? One year to add a single line? That's unfair!&lt;/p&gt;
&lt;p&gt;My commit contains a very similar fix for &lt;tt class="docutils literal"&gt;do_ReadFile()&lt;/tt&gt; used by
&lt;tt class="docutils literal"&gt;Overlapped_ReadFile()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;Overlapped_ReadFileInto()&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fixing-more-memory-leaks"&gt;
&lt;h2&gt;Fixing more memory leaks&lt;/h2&gt;
&lt;p&gt;By the way, the &lt;tt class="docutils literal"&gt;_overlapped.Overlapped&lt;/tt&gt; type has no traverse function: it may
help the garbage collector to add one. Asyncio is famous for building reference
cycles by design in &lt;tt class="docutils literal"&gt;Future.set_exception()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I wrote &lt;a class="reference external" href="https://github.com/python/cpython/pull/11489"&gt;PR 11489&lt;/a&gt; to implement
&lt;tt class="docutils literal"&gt;tp_traverse&lt;/tt&gt; for the &lt;tt class="docutils literal"&gt;_overlapped.Overlapped&lt;/tt&gt; type. &lt;a class="reference external" href="https://github.com/python/cpython/pull/11489#pullrequestreview-191093765"&gt;Serhiy Storchaka
added&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I suspect that there are leaks when self-&amp;gt;type is set to TYPE_NOT_STARTED.&lt;/blockquote&gt;
&lt;p&gt;And he was right! I modified my PR to fix all memory leaks. After my PR has
been reviewed, I merged it, &lt;a class="reference external" href="https://github.com/python/cpython/commit/5485085b324a45307c1ff4ec7d85b5998d7d5e0d"&gt;commit 5485085b&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 5485085b324a45307c1ff4ec7d85b5998d7d5e0d
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Fri Jan 11 14:35:14 2019 +0100

    bpo-32710: Fix _overlapped.Overlapped memory leaks (GH-11489)

    Fix memory leaks in asyncio ProactorEventLoop on overlapped operation
    failures.

    Changes:

    * Implement the tp_traverse slot in the _overlapped.Overlapped type
      to help to break reference cycles and identify referrers in the
      garbage collector.
    * Always clear overlapped on failure: not only set type to
      TYPE_NOT_STARTED, but release also resources.
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="regression-nope"&gt;
&lt;h2&gt;Regression? Nope&lt;/h2&gt;
&lt;p&gt;Was the memory leak a regression? Nope. The bug existed since the creation of
the &lt;tt class="docutils literal"&gt;overlapped.c&lt;/tt&gt; file in the &amp;quot;Tulip&amp;quot; project in 2013, &lt;a class="reference external" href="https://github.com/python/asyncio/commit/27c403531670f52cad8388aaa2a13a658f753fd5"&gt;commit 27c40353&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 27c403531670f52cad8388aaa2a13a658f753fd5
Author: Richard Oudkerk &amp;lt;shibturn&amp;#64;gmail.com&amp;gt;
Date:   Mon Jan 21 20:34:38 2013 +0000

    New experimental iocp branch.
&lt;/pre&gt;
&lt;p&gt;Tulip was the old name of the asyncio project, when it was still an external
project on &lt;tt class="docutils literal"&gt;code.google.com&lt;/tt&gt;. In the meanwhile, &lt;tt class="docutils literal"&gt;code.google.com&lt;/tt&gt; has been
closed and the project moved to &lt;a class="reference external" href="https://github.com/python/asyncio/"&gt;https://github.com/python/asyncio/&lt;/a&gt; (now
read-only).&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/asyncio/blob/27c403531670f52cad8388aaa2a13a658f753fd5/overlapped.c#L632-L658"&gt;Extract of the original Overlapped_WSASend() implementation&lt;/a&gt;,
I added a comment to show the location of the bug:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if (!PyArg_Parse(bufobj, &amp;quot;y*&amp;quot;, &amp;amp;self-&amp;gt;write_buffer))
    return NULL;

#if SIZEOF_SIZE_T &amp;gt; SIZEOF_LONG
if (self-&amp;gt;write_buffer.len &amp;gt; (Py_ssize_t)PY_ULONG_MAX) {
    PyBuffer_Release(&amp;amp;self-&amp;gt;write_buffer);
    PyErr_SetString(PyExc_ValueError, &amp;quot;buffer to large&amp;quot;);
    return NULL;
}
#endif
...
self-&amp;gt;error = err = (ret &amp;lt; 0 ? WSAGetLastError() : ERROR_SUCCESS);
switch (err) {
    case ERROR_SUCCESS:
    case ERROR_MORE_DATA:
    case ERROR_IO_PENDING:
        /********* !!! BUG HERE, BUFFER NOT RELEASED !!! ***********/
        Py_RETURN_NONE;
    ...
}
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;I fixed the memory leak 6 years after the code has been written!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;So... why was this bug only discovered in 2018? Multiple very asyncio old bugs
were discovered only recently thanks to more realistic and more advanced
&lt;strong&gt;functional tests&lt;/strong&gt;. First tests of asyncio were mostly tiny unit tests
mocking most part of the code. It made sense in the early days of asyncio, when
the code was not mature.&lt;/p&gt;
&lt;p&gt;By the way, the &lt;a class="reference external" href="https://github.com/python/cpython/blob/1f58f4fa6a0e3c60cee8df4a35c8dcf3903acde8/Lib/test/test_asyncio/test_sendfile.py#L446-L457"&gt;code of the test&lt;/a&gt;
which helped to discovered the bug is:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def test_sendfile_close_peer_in_the_middle_of_receiving(self):
    srv_proto, cli_proto = self.prepare_sendfile(close_after=1024)
    with self.assertRaises(ConnectionError):
        self.run_loop(
            self.loop.sendfile(cli_proto.transport, self.file))
    self.run_loop(srv_proto.done)

    self.assertTrue(1024 &amp;lt;= srv_proto.nbytes &amp;lt; len(self.DATA),
                    srv_proto.nbytes)
    self.assertTrue(1024 &amp;lt;= self.file.tell() &amp;lt; len(self.DATA),
                    self.file.tell())
    self.assertTrue(cli_proto.transport.is_closing())
&lt;/pre&gt;
&lt;p&gt;Note: The test name has been made even longer in the meanwhile (add &amp;quot;the&amp;quot;) :-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;For such complex bugs, &lt;strong&gt;a reliable debugging method is to remove as much code as
possible&lt;/strong&gt; to reduce the number of lines of code that should be read.
&lt;tt class="docutils literal"&gt;tracemalloc&lt;/tt&gt; remains efficient to identify a memory leak when a test can be
run in a loop to make the leak more obvious (I was blocked at the beginning
because the test failed when run a second time in a loop).&lt;/p&gt;
&lt;p&gt;Lessons learned? You should try to &lt;strong&gt;investigate every single failure of your
CI&lt;/strong&gt;.  It is important to have a test suite with functional tests. &amp;quot;Mock tests&amp;quot;
are fine to quickly write reliable tests, but there are not enough: functional
tests make the difference.&lt;/p&gt;
&lt;p&gt;Thanks &lt;strong&gt;Richard Oudkerk&lt;/strong&gt; for your great code to use Windows native APIs in
&lt;strong&gt;asyncio&lt;/strong&gt; and &lt;strong&gt;multiprocessing&lt;/strong&gt;! I like &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Input/output_completion_port"&gt;Windows IOCP&lt;/a&gt;, even if the
asyncio implementation is quite complex :-)&lt;/p&gt;
&lt;p&gt;Ok, &lt;tt class="docutils literal"&gt;_overlapped.Overlapped&lt;/tt&gt; should now have a few less memory leaks :-)&lt;/p&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="asyncio"></category></entry><entry><title>asyncio: WSARecv() cancellation causing data loss</title><link href="https://vstinner.github.io/asyncio-proactor-wsarecv-cancellation-data-loss.html" rel="alternate"></link><published>2019-01-31T15:20:00+01:00</published><updated>2019-01-31T15:20:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-01-31:/asyncio-proactor-wsarecv-cancellation-data-loss.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/joybot/6026542856/"&gt;&lt;img alt="Unlocked lock" src="https://vstinner.github.io/images/lock.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;In December 2017, &lt;strong&gt;Yury Selivanov&lt;/strong&gt; pushed the long awaited &lt;tt class="docutils literal"&gt;start_tls()&lt;/tt&gt;
function.&lt;/p&gt;
&lt;p&gt;A newly added test failed on Windows. Later, the test started to fail
randomly on Linux as well. In fact, it was a well hidden race condition in the
asynchronous handshake of &lt;tt class="docutils literal"&gt;SSLProtocol&lt;/tt&gt; which will take 5 months of …&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/joybot/6026542856/"&gt;&lt;img alt="Unlocked lock" src="https://vstinner.github.io/images/lock.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;In December 2017, &lt;strong&gt;Yury Selivanov&lt;/strong&gt; pushed the long awaited &lt;tt class="docutils literal"&gt;start_tls()&lt;/tt&gt;
function.&lt;/p&gt;
&lt;p&gt;A newly added test failed on Windows. Later, the test started to fail
randomly on Linux as well. In fact, it was a well hidden race condition in the
asynchronous handshake of &lt;tt class="docutils literal"&gt;SSLProtocol&lt;/tt&gt; which will take 5 months of work to
be identified and fixed. The bug wasn't a recent regression, but only spotted
thanks to newly added tests.&lt;/p&gt;
&lt;p&gt;Even after this bug has been fixed, the same test still failed randomly on
Windows! Once I found how to reproduce the bug, I understood that it's a &lt;strong&gt;very
scary bug&lt;/strong&gt;: &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt; cancellation randomly caused &lt;strong&gt;data loss&lt;/strong&gt;! Again,
it was a very well hidden bug which likely existing since the early days of the
&lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt; implementation.&lt;/p&gt;
&lt;p&gt;Previous article: &lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-connect-pipe-race-condition.html"&gt;Asyncio: Proactor ConnectPipe() Race Condition&lt;/a&gt;.
Next article: &lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-wsasend-memory-leak.html"&gt;asyncio: WSASend() memory leak&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="new-start-tls-function"&gt;
&lt;h2&gt;New start_tls() function&lt;/h2&gt;
&lt;p&gt;The &amp;quot;starttls&amp;quot; feature have been requested since creation of asyncio. At
October 24, 2013, &lt;strong&gt;Guido van Rossum&lt;/strong&gt; created &lt;a class="reference external" href="https://github.com/python/asyncio/issues/79"&gt;asyncio issue #79&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;Glyph [Lefkowitz]&lt;/strong&gt; and &lt;strong&gt;Antoine [Pitrou]&lt;/strong&gt; really want a API to upgrade an
existing Transport/Protocol pair to SSL/TLS, without having to create a new
protocol.&lt;/blockquote&gt;
&lt;p&gt;At March 23, 2015, &lt;strong&gt;Giovanni Cannata&lt;/strong&gt; created &lt;a class="reference external" href="https://bugs.python.org/issue23749"&gt;bpo-23749&lt;/a&gt; which is basically the same feature
request. I &lt;a class="reference external" href="https://bugs.python.org/issue23749#msg239022"&gt;replied&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
asyncio got a new SSL implementation which makes possible to implement
STARTTLS. Are you interested to implement it?&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Elizabeth Myers&lt;/strong&gt;, &lt;strong&gt;Antoine Pitrou&lt;/strong&gt;, &lt;strong&gt;Guido van Rossum&lt;/strong&gt; and
&lt;strong&gt;Yury Selivanov&lt;/strong&gt; designed the feature. Yury &lt;a class="reference external" href="https://bugs.python.org/issue23749#msg253495"&gt;wrote a prototype&lt;/a&gt; in 2015 for PostgreSQL.  In
2017, &lt;strong&gt;Barry Warsaw&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue23749#msg293912"&gt;wrote his own implementation for SMTP&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;At the end of 2017, &lt;strong&gt;four year&lt;/strong&gt; after Guido van Rossum created the feature
request, &lt;strong&gt;Yury Selivanov&lt;/strong&gt; implemented the feature and pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/f111b3dcb414093a4efb9d74b69925e535ddc470"&gt;commit
f111b3dc&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit f111b3dcb414093a4efb9d74b69925e535ddc470
Author: Yury Selivanov &amp;lt;yury&amp;#64;magic.io&amp;gt;
Date:   Sat Dec 30 00:35:36 2017 -0500

    bpo-23749: Implement loop.start_tls() (#5039)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="sslprotocol-race-condition"&gt;
&lt;h2&gt;SSLProtocol Race Condition&lt;/h2&gt;
&lt;div class="section" id="test-fails-on-appveyor-windows-temporary-fix"&gt;
&lt;h3&gt;Test fails on AppVeyor (Windows): temporary fix&lt;/h3&gt;
&lt;p&gt;At December 30, 2017, just after Yury pushed his implementation of
&lt;tt class="docutils literal"&gt;start_tls()&lt;/tt&gt; (the same day), &lt;strong&gt;Antoine Pitrou&lt;/strong&gt; reported &lt;a class="reference external" href="https://bugs.python.org/issue32458"&gt;bpo-32458&lt;/a&gt;: it seems test_asyncio fails
sporadically on AppVeyor:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ERROR: test_start_tls_server_1 (test.test_asyncio.test_sslproto.ProactorStartTLS)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &amp;quot;C:\projects\cpython\lib\test\test_asyncio\test_sslproto.py&amp;quot;, line 284, in test_start_tls_server_1
    asyncio.wait_for(main(), loop=self.loop, timeout=10))
  File &amp;quot;C:\projects\cpython\lib\asyncio\base_events.py&amp;quot;, line 440, in run_until_complete
    return future.result()
  File &amp;quot;C:\projects\cpython\lib\asyncio\tasks.py&amp;quot;, line 398, in wait_for
    raise futures.TimeoutError()
concurrent.futures._base.TimeoutError
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Yury Selivanov&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue32458#msg309254"&gt;wrote&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I'm leaving on a two-weeks vacation today.  To avoid risking breaking the workflow, I'll mask this tests on AppVeyor.  I'll investigate this when I get back.&lt;/blockquote&gt;
&lt;p&gt;and skipped the test as a &lt;strong&gt;temporary fix&lt;/strong&gt;, &lt;a class="reference external" href="https://github.com/python/cpython/commit/0c36bed1c46d07ef91d3e02e69e974e4f3ecd31a"&gt;commit 0c36bed1&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 0c36bed1c46d07ef91d3e02e69e974e4f3ecd31a
Author: Yury Selivanov &amp;lt;yury&amp;#64;magic.io&amp;gt;
Date:   Sat Dec 30 15:40:20 2017 -0500

    bpo-32458: Temporarily mask start-tls proactor test on Windows (#5054)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="bug-reproduced-on-linux"&gt;
&lt;h3&gt;Bug reproduced on Linux&lt;/h3&gt;
&lt;p&gt;At May 23, 2018, five month after the bug have been reported, &lt;a class="reference external" href="https://bugs.python.org/issue32458#msg317468"&gt;I wrote&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
test_start_tls_server_1() just failed on my Linux. It likely depends on the system load.&lt;/blockquote&gt;
&lt;p&gt;Christian Heimes &lt;a class="reference external" href="https://bugs.python.org/issue32458#msg317760"&gt;added&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
[On Linux,] It's failing reproducible with OpenSSL 1.1.1 and TLS 1.3
enabled. I haven't seen it failing with TLS 1.2 yet.&lt;/blockquote&gt;
&lt;p&gt;At May 28, 2018, I found a reliable way to &lt;a class="reference external" href="https://bugs.python.org/issue32458#msg317833"&gt;reproduce the issue on Linux&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Open 3 terminals and run these commands in parallel:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;./python &lt;span class="pre"&gt;-m&lt;/span&gt; test test_asyncio &lt;span class="pre"&gt;-m&lt;/span&gt; test_start_tls_server_1 &lt;span class="pre"&gt;-F&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;./python &lt;span class="pre"&gt;-m&lt;/span&gt; test &lt;span class="pre"&gt;-j16&lt;/span&gt; &lt;span class="pre"&gt;-r&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;./python &lt;span class="pre"&gt;-m&lt;/span&gt; test &lt;span class="pre"&gt;-j16&lt;/span&gt; &lt;span class="pre"&gt;-r&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;It's a &lt;strong&gt;race condition&lt;/strong&gt; which doesn't depend on the OS, but on the system
load.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="root-issue-identified"&gt;
&lt;h3&gt;Root issue identified&lt;/h3&gt;
&lt;p&gt;Once I found how to reproduce the bug, I was able to investigate it. I created
&lt;a class="reference external" href="https://bugs.python.org/issue33674"&gt;bpo-33674&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I found a race condition in &lt;tt class="docutils literal"&gt;SSLProtocol&lt;/tt&gt; of &lt;tt class="docutils literal"&gt;asyncio/sslproto.py&lt;/tt&gt;.
Sometimes, &lt;tt class="docutils literal"&gt;_sslpipe.feed_ssldata()&lt;/tt&gt; is called before
&lt;tt class="docutils literal"&gt;_sslpipe.shutdown()&lt;/tt&gt;.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;SSLProtocol.connection_made()&lt;/tt&gt; -&amp;gt; &lt;tt class="docutils literal"&gt;SSLProtocol._start_handshake()&lt;/tt&gt;: &lt;tt class="docutils literal"&gt;self._loop.call_soon(self._process_write_backlog)&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;SSLProtoco.data_received()&lt;/tt&gt;: direct call to &lt;tt class="docutils literal"&gt;self._sslpipe.feed_ssldata(data)&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Later, &lt;tt class="docutils literal"&gt;self._process_write_backlog()&lt;/tt&gt; calls &lt;tt class="docutils literal"&gt;self._sslpipe.do_handshake()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The first &lt;strong&gt;write&lt;/strong&gt; is &lt;strong&gt;delayed&lt;/strong&gt; by &lt;tt class="docutils literal"&gt;call_soon()&lt;/tt&gt;, whereas the first
&lt;strong&gt;read&lt;/strong&gt; is a &lt;strong&gt;direct call&lt;/strong&gt; to the SSL pipe.&lt;/p&gt;
&lt;p&gt;Workaround:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
diff --git a/Lib/asyncio/sslproto.py b/Lib/asyncio/sslproto.py
index 2bfa45dd15..4a5dbb38a1 100644
--- a/Lib/asyncio/sslproto.py
+++ b/Lib/asyncio/sslproto.py
&amp;#64;&amp;#64; -592,7 +592,7 &amp;#64;&amp;#64; class SSLProtocol(protocols.Protocol):
         # (b'', 1) is a special value in _process_write_backlog() to do
         # the SSL handshake
         self._write_backlog.append((b'', 1))
-        self._loop.call_soon(self._process_write_backlog)
+        self._process_write_backlog()
         self._handshake_timeout_handle = \
             self._loop.call_later(self._ssl_handshake_timeout,
                                   self._check_handshake_timeout)
&lt;/pre&gt;
&lt;p&gt;Yury Selivanov wrote:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;The fix is correct and the bug is now obvious&lt;/strong&gt;: &lt;tt class="docutils literal"&gt;data_received()&lt;/tt&gt; occurs
pretty much any time after &lt;tt class="docutils literal"&gt;connection_made()&lt;/tt&gt; call; if &lt;tt class="docutils literal"&gt;call_soon()&lt;/tt&gt; is
used in &lt;tt class="docutils literal"&gt;connection_made()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;data_received()&lt;/tt&gt; may find the protocol in
an incorrect state.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Kudos Victor for debugging this.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/be00a5583a2cb696335c527b921d1868266a42c6"&gt;commit be00a558&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit be00a5583a2cb696335c527b921d1868266a42c6
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Tue May 29 01:33:35 2018 +0200

    bpo-33674: asyncio: Fix SSLProtocol race (GH-7175)

    Fix a race condition in SSLProtocol.connection_made() of
    asyncio.sslproto: start immediately the handshake instead of using
    call_soon(). Previously, data_received() could be called before the
    handshake started, causing the handshake to hang or fail.
&lt;/pre&gt;
&lt;p&gt;... the change is basically a single line change:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
- self._loop.call_soon(self._process_write_backlog)
+ self._process_write_backlog()
&lt;/pre&gt;
&lt;p&gt;I closed &lt;a class="reference external" href="https://bugs.python.org/issue32458"&gt;bpo-32458&lt;/a&gt; and &lt;strong&gt;Yury
Selivanov&lt;/strong&gt; closed &lt;a class="reference external" href="https://bugs.python.org/issue33674"&gt;bpo-33674&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="not-a-regression"&gt;
&lt;h3&gt;Not a regression&lt;/h3&gt;
&lt;p&gt;The SSLProtocol race condition wasn't new: it existed since January 2015,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/231b404cb026649d4b7172e75ac394ef558efe60"&gt;commit 231b404c&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 231b404cb026649d4b7172e75ac394ef558efe60
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Wed Jan 14 00:19:09 2015 +0100

    Issue #22560: New SSL implementation based on ssl.MemoryBIO

    The new SSL implementation is based on the new ssl.MemoryBIO which is only
    available on Python 3.5. On Python 3.4 and older, the legacy SSL implementation
    (using SSL_write, SSL_read, etc.) is used. The proactor event loop only
    supports the new implementation.

    The new asyncio.sslproto module adds _SSLPipe, SSLProtocol and
    _SSLProtocolTransport classes. _SSLPipe allows to &amp;quot;wrap&amp;quot; or &amp;quot;unwrap&amp;quot; a socket
    (switch between cleartext and SSL/TLS).

    Patch written by Antoine Pitrou. sslproto.py is based on gruvi/ssl.py of the
    gruvi project written by Geert Jansen.

    This change adds SSL support to ProactorEventLoop on Python 3.5 and newer!

    It becomes also possible to implement STARTTTLS: switch a cleartext socket to
    SSL.
&lt;/pre&gt;
&lt;p&gt;This is the new cool asynchronous SSL implementation written by &lt;strong&gt;Antoine
Pitrou&lt;/strong&gt; and &lt;strong&gt;Geert Jansen&lt;/strong&gt;. It took &lt;strong&gt;3 years&lt;/strong&gt; and &lt;strong&gt;new functional tests&lt;/strong&gt;
to discover the race condition.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="wsarecv-cancellation-causing-data-loss"&gt;
&lt;h2&gt;WSARecv() cancellation causing data loss&lt;/h2&gt;
&lt;div class="section" id="yet-another-very-boring-buildbot-test-failure"&gt;
&lt;h3&gt;Yet another very boring buildbot test failure&lt;/h3&gt;
&lt;p&gt;At May 30, 2018, the day after I fixed SSLProtocol race condition, I created
&lt;a class="reference external" href="https://bugs.python.org/issue33694"&gt;bpo-33694&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;test_asyncio.test_start_tls_server_1() got multiple fixes recently (see
&lt;a class="reference external" href="https://bugs.python.org/issue32458"&gt;bpo-32458&lt;/a&gt; and &lt;a class="reference external" href="https://bugs.python.org/issue33674"&gt;bpo-33674&lt;/a&gt;)... but it still fails on Python on x86
Windows7 3.x at revision bb9474f1fb2fc7c7ed9f826b78262d6a12b5f9e8 which
contains all these fixes.&lt;/p&gt;
&lt;p&gt;The test fails even when test_asyncio is re-run alone (not when other tests run
in parallel).&lt;/p&gt;
&lt;p&gt;Example of failure:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ERROR: test_start_tls_server_1 (test.test_asyncio.test_sslproto.ProactorStartTLSTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &amp;quot;...\lib\test\test_asyncio\test_sslproto.py&amp;quot;, line 467, in test_start_tls_server_1
    self.loop.run_until_complete(run_main())
  File &amp;quot;...\lib\asyncio\base_events.py&amp;quot;, line 566, in run_until_complete
    raise RuntimeError('Event loop stopped before Future completed.')
RuntimeError: Event loop stopped before Future completed.
&lt;/pre&gt;
&lt;p&gt;The test fails also on x86 Windows7 3.7. Moreover, 3.7 got an additional failure:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ERROR: test_pipe_handle (test.test_asyncio.test_windows_utils.PipeTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &amp;quot;...\lib\test\test_asyncio\test_windows_utils.py&amp;quot;, line 73, in test_pipe_handle
    raise RuntimeError('expected ERROR_INVALID_HANDLE')
RuntimeError: expected ERROR_INVALID_HANDLE
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="unable-to-reproduce-the-bug"&gt;
&lt;h3&gt;Unable to reproduce the bug&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Yury Selivanov&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue33694#msg318193"&gt;failed to reproduce the issue&lt;/a&gt; in Windows 7 VM (on macOS) using:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;run &lt;tt class="docutils literal"&gt;test_asyncio&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;run &lt;tt class="docutils literal"&gt;test_asyncio.test_sslproto&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;run &lt;tt class="docutils literal"&gt;test_asyncio.test_sslproto &lt;span class="pre"&gt;-m&lt;/span&gt; test_start_tls_server_1&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Andrew Svetlov&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue33694#msg318194"&gt;added&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I used &lt;tt class="docutils literal"&gt;SNDBUF&lt;/tt&gt; to enforce send buffer overloading. It is not required by
sendfile tests but I thought that better to have non-mocked way to test such
situations. We can remove the socket buffers size manipulation at all
without any problem.&lt;/blockquote&gt;
&lt;p&gt;But Yury Selivanov &lt;a class="reference external" href="https://bugs.python.org/issue33694#msg318195"&gt;replied&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
When I tried to do that I think &lt;strong&gt;I was having more failures&lt;/strong&gt; with that
test. But really up to you.&lt;/blockquote&gt;
&lt;p&gt;Next days, I reported more and more similar failures on Windows buildbots and
AppVeyor (our Windows CI).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="root-issue-identified-pause-reading"&gt;
&lt;h3&gt;Root issue identified: pause_reading()&lt;/h3&gt;
&lt;p&gt;Since this bug became more and more frequent, I decided to work on it. Yury and
Andrew failed to reproduce it.&lt;/p&gt;
&lt;p&gt;At June 7, 2018, I managed to &lt;strong&gt;reproduce the bug on Linux&lt;/strong&gt; by &lt;a class="reference external" href="https://bugs.python.org/issue33694#msg318869"&gt;inserting a
sleep at the right place&lt;/a&gt;...
I understood one hour later that my patch is wrong: &amp;quot;it introduces a bug in
the test&amp;quot;.&lt;/p&gt;
&lt;p&gt;On the other hand, I found the root cause: calling &lt;tt class="docutils literal"&gt;pause_reading()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;resume_reading()&lt;/tt&gt; on the transport is not safe. Sometimes, we loose data.
See the &lt;strong&gt;ugly hack&lt;/strong&gt; described in the TODO comment below:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
class _ProactorReadPipeTransport(_ProactorBasePipeTransport,
                                 transports.ReadTransport):
    &amp;quot;&amp;quot;&amp;quot;Transport for read pipes.&amp;quot;&amp;quot;&amp;quot;
    (...)
    def pause_reading(self):
        if self._closing or self._paused:
            return
        self._paused = True

        if self._read_fut is not None and not self._read_fut.done():
            # TODO: This is an ugly hack to cancel the current read future
            # *and* avoid potential race conditions, as read cancellation
            # goes through `future.cancel()` and `loop.call_soon()`.
            # We then use this special attribute in the reader callback to
            # exit *immediately* without doing any cleanup/rescheduling.
            self._read_fut.__asyncio_cancelled_on_pause__ = True

            self._read_fut.cancel()
            self._read_fut = None
            self._reschedule_on_resume = True

        if self._loop.get_debug():
            logger.debug(&amp;quot;%r pauses reading&amp;quot;, self)
&lt;/pre&gt;
&lt;p&gt;If you remove the &amp;quot;ugly hack&amp;quot;, the test no longer hangs...&lt;/p&gt;
&lt;p&gt;Extract of &lt;tt class="docutils literal"&gt;_ProactorReadPipeTransport.set_transport()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if self.is_reading():
    # reset reading callback / buffers / self._read_fut
    self.pause_reading()
    self.resume_reading()
&lt;/pre&gt;
&lt;p&gt;This method &lt;strong&gt;cancels the pending overlapped&lt;/strong&gt; &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;, and then creates
a new overlapped &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Even after &lt;tt class="docutils literal"&gt;CancelIoEx(old overlapped)&lt;/tt&gt;, the IOCP loop still gets an event
for the completion of the cancelled overlapped &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;. Problem: &lt;strong&gt;since
the Python future is cancelled, the event is ignored and so 176 bytes of data
are lost&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;I'm surprised that an overlapped &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt; &lt;strong&gt;cancelled&lt;/strong&gt; by
&lt;tt class="docutils literal"&gt;CancelIoEx()&lt;/tt&gt; still returns data when IOCP polls for events.&lt;/p&gt;
&lt;p&gt;Something else. The bug occurs when &lt;tt class="docutils literal"&gt;CancelIoEx()&lt;/tt&gt; (on the current overlapped
&lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;) fails internally with &lt;tt class="docutils literal"&gt;ERROR_NOT_FOUND&lt;/tt&gt;. According to
overlapped.c, it means:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/* CancelIoEx returns ERROR_NOT_FOUND if the I/O completed in-between */
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;HasOverlappedIoCompleted()&lt;/tt&gt; returns 0 in that case.&lt;/p&gt;
&lt;p&gt;The problem is that currently, &lt;tt class="docutils literal"&gt;Overlapped.cancel()&lt;/tt&gt; also returns &lt;tt class="docutils literal"&gt;None&lt;/tt&gt; in
that case, and later the asyncio IOCP loop ignores the completion event and so
&lt;strong&gt;drops incoming received data&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="release-blocker-bug"&gt;
&lt;h3&gt;Release blocker bug?&lt;/h3&gt;
&lt;p&gt;Yury, Andrew, Ned: I set the priority to release blocker because I'm scared by
what I saw. The START TLS has a race condition in its ProactorEventLoop
implementation. But the bug doesn't see to be specific to START TLS, but rather
to &lt;tt class="docutils literal"&gt;transport.set_transport()&lt;/tt&gt;, and even more generally to
&lt;tt class="docutils literal"&gt;transport.pause_reading()&lt;/tt&gt; / &lt;tt class="docutils literal"&gt;transport.resume_reading()&lt;/tt&gt;. The bug is quite
severe: we loose data and it's really hard to know why (I spent a few hours to
add many many print and try to reproduce on a very tiny reliable unit test). As
an asyncio user, I expect that transports are 100% reliable, and I would first
look into my code (like looking into &lt;tt class="docutils literal"&gt;start_tls()&lt;/tt&gt; implementation in my case).&lt;/p&gt;
&lt;p&gt;If the bug was very specific to &lt;tt class="docutils literal"&gt;start_tls()&lt;/tt&gt;, I would suggest to &amp;quot;just&amp;quot;
&amp;quot;disable&amp;quot; start_tls() on ProactorEventLoop (sorry, Windows!). But since the
data loss seems to concern basically any application using
&lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt;, I don't see any simple workaround.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;My hope is that a fix can be written shortly&lt;/strong&gt; to not block the 3.7.0 final
release for too long :-(&lt;/p&gt;
&lt;p&gt;Yury, Andrew: Can you please just confirm that it's a regression and that a
release blocker is justified?&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="functional-test-reproducing-the-bug"&gt;
&lt;h3&gt;Functional test reproducing the bug&lt;/h3&gt;
&lt;p&gt;I wrote &lt;a class="reference external" href="https://bugs.python.org/file47632/race.py"&gt;race.py script&lt;/a&gt;: simple
echo client and server sending packets in both directions.  Pause/resume
reading the client transport every 100 ms to trigger the bug.&lt;/p&gt;
&lt;p&gt;Using &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt; and 2000 packets of 16 KiB, I easily reproduce the
bug.&lt;/p&gt;
&lt;p&gt;So again, it's nothing related to &lt;tt class="docutils literal"&gt;start_tls()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;start_tls()&lt;/tt&gt; was just one
way to spot the bug.&lt;/p&gt;
&lt;p&gt;The bug is in Proactor transport: the cancellation of overlapped &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;
sometime drops packets. The bug occurs when &lt;tt class="docutils literal"&gt;CancelIoEx()&lt;/tt&gt; fails with
&lt;tt class="docutils literal"&gt;ERROR_NOT_FOUND&lt;/tt&gt; which means that the I/O (&lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;) completed.&lt;/p&gt;
&lt;p&gt;One solution would be to not cancel &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt; on pause_reading(): wait
until the current &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt; completes, store data somewhere but don't pass
it to &lt;tt class="docutils literal"&gt;protocol.data_received()&lt;/tt&gt;, and don't schedule a new &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;.
Once reading is resumed: call &lt;tt class="docutils literal"&gt;protocol.data_received()&lt;/tt&gt; and schedule a new
&lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;That would be a workaround. I don't know how to really fix &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt;
cancellation without loosing data. A good start would be to modify
&lt;tt class="docutils literal"&gt;Overlapped.cancel()&lt;/tt&gt; to return a boolean to notice if the overlapped I/O
completed even if we just cancelled it. Currently, the corner case
(&lt;tt class="docutils literal"&gt;CancelIoEx()&lt;/tt&gt; fails with &lt;tt class="docutils literal"&gt;ERROR_NOT_FOUND&lt;/tt&gt;) is silently ignored, and then
the IOCP loop silently ignores the event of completed I/O...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-the-bug-no-longer-cancel-wsarecv"&gt;
&lt;h3&gt;Fix the bug: no longer cancel WSARecv()&lt;/h3&gt;
&lt;p&gt;At June 8, 2018, I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/79790bc35fe722a49977b52647f9b5fe1deda2b7"&gt;commit 79790bc3&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 79790bc35fe722a49977b52647f9b5fe1deda2b7
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Fri Jun 8 00:25:52 2018 +0200

    bpo-33694: Fix race condition in asyncio proactor (GH-7498)

    The cancellation of an overlapped WSARecv() has a race condition
    which causes data loss because of the current implementation of
    proactor in asyncio.

    No longer cancel overlapped WSARecv() in _ProactorReadPipeTransport
    to work around the race condition.

    Remove the optimized recv_into() implementation to get simple
    implementation of pause_reading() using the single _pending_data
    attribute.

    Move _feed_data_to_bufferred_proto() to protocols.py.

    Remove set_protocol() method which became useless.
&lt;/pre&gt;
&lt;p&gt;I fixed the root issue (in Python 3.7 and future Python 3.8).&lt;/p&gt;
&lt;p&gt;I used my &lt;tt class="docutils literal"&gt;race.py&lt;/tt&gt; script to validate that the issue is fixed for real.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I fixed one race condition in the asynchronous handshake of &lt;tt class="docutils literal"&gt;SSLProtocol&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I found and fixed a data loss bug caused by &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt; cancellation.&lt;/p&gt;
&lt;p&gt;Lessons learnt from these two bugs:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;You should &lt;strong&gt;write an extensive test suite&lt;/strong&gt; for your code.&lt;/li&gt;
&lt;li&gt;You should &lt;strong&gt;keep an eye on your continuous integration (CI)&lt;/strong&gt;: any tiny test
failure can hide a very severe bug.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="asyncio"></category></entry><entry><title>Asyncio: Proactor ConnectPipe() Race Condition</title><link href="https://vstinner.github.io/asyncio-proactor-connect-pipe-race-condition.html" rel="alternate"></link><published>2019-01-30T18:00:00+01:00</published><updated>2019-01-30T18:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-01-30:/asyncio-proactor-connect-pipe-race-condition.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/phrawr/7612947262/"&gt;&lt;img alt="Pipes" src="https://vstinner.github.io/images/pipes.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Between December 2014 and January 2015, once I succeeded to fix the root issue
of the random asyncio crashes on Windows (&lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-cancellation-from-hell.html"&gt;Proactor Cancellation From Hell&lt;/a&gt;), I fixed more race conditions
and bugs in &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;ConnectPipe()&lt;/tt&gt; Race Condition&lt;/li&gt;
&lt;li&gt;Race Condition in &lt;tt class="docutils literal"&gt;BaseSubprocessTransport._try_finish()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Close the transport on failure: ResourceWarning&lt;/li&gt;
&lt;li&gt;Cleanup code …&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/phrawr/7612947262/"&gt;&lt;img alt="Pipes" src="https://vstinner.github.io/images/pipes.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Between December 2014 and January 2015, once I succeeded to fix the root issue
of the random asyncio crashes on Windows (&lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-cancellation-from-hell.html"&gt;Proactor Cancellation From Hell&lt;/a&gt;), I fixed more race conditions
and bugs in &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;ConnectPipe()&lt;/tt&gt; Race Condition&lt;/li&gt;
&lt;li&gt;Race Condition in &lt;tt class="docutils literal"&gt;BaseSubprocessTransport._try_finish()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Close the transport on failure: ResourceWarning&lt;/li&gt;
&lt;li&gt;Cleanup code handling pipes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous article: &lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-cancellation-from-hell.html"&gt;Proactor Cancellation From Hell&lt;/a&gt;. Next article:
&lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-wsarecv-cancellation-data-loss.html"&gt;asyncio: WSARecv() cancellation causing data loss&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="connectpipe-race-condition"&gt;
&lt;h2&gt;ConnectPipe() Race Condition&lt;/h2&gt;
&lt;p&gt;Once I succeeded to fix the root issue of the random asyncio crashes on Windows
(&lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-cancellation-from-hell.html"&gt;Proactor Cancellation From Hell&lt;/a&gt;), I started to look at the
ConnectPipe special case: &lt;a class="reference external" href="https://github.com/python/asyncio/issues/204"&gt;asyncio issue #204: Investigate
IocpProactor.accept_pipe() special case (don't register overlapped)&lt;/a&gt; (issue created at 25 Aug
2014).&lt;/p&gt;
&lt;p&gt;At January 21, 2015, I opened &lt;a class="reference external" href="https://bugs.python.org/issue23293"&gt;bpo-23293: race condition related to
IocpProactor.connect_pipe()&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;While fixing &lt;a class="reference external" href="https://bugs.python.org/issue23095"&gt;bpo-23095 (race condition when cancelling a _WaitHandleFuture)&lt;/a&gt;, I saw that
&lt;tt class="docutils literal"&gt;IocpProactor.connect_pipe()&lt;/tt&gt; causes &amp;quot;GetQueuedCompletionStatus() returned an
unexpected event&amp;quot; messages to be logged, but also to hang the test suite.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;IocpProactor._register()&lt;/tt&gt; contains the comment:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# Even if GetOverlappedResult() was called, we have to wait for the
# notification of the completion in GetQueuedCompletionStatus().
# Register the overlapped operation to keep a reference to the
# OVERLAPPED object, otherwise the memory is freed and Windows may
# read uninitialized memory.
#
# For an unknown reason, ConnectNamedPipe() behaves differently:
# the completion is not notified by GetOverlappedResult() if we
# already called GetOverlappedResult(). For this specific case, we
# don't expect notification (register is set to False).
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;IocpProactor.close()&lt;/tt&gt; contains this comment:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# The operation was started with connect_pipe() which
# queues a task to Windows' thread pool.  This cannot
# be cancelled, so just forget it.
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;IocpProactor.connect_pipe()&lt;/tt&gt; is implemented with &lt;tt class="docutils literal"&gt;QueueUserWorkItem()&lt;/tt&gt;
which &lt;strong&gt;starts a thread that cannot be interrupted&lt;/strong&gt;. Because of that, this
function requires special cases in &lt;tt class="docutils literal"&gt;_register()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;close()&lt;/tt&gt; methods of
&lt;tt class="docutils literal"&gt;IocpProactor&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I proposed a solution to reimplement &lt;tt class="docutils literal"&gt;IocpProactor.connect_pipe()&lt;/tt&gt; &lt;strong&gt;without
a thread&lt;/strong&gt;: &lt;a class="reference external" href="https://code.google.com/p/tulip/issues/detail?id=197"&gt;asyncio issue #197: Rewrite IocpProactor.connect_pipe() with
non-blocking calls to avoid non interruptible QueueUserWorkItem()&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;At January 22, 2015, I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/7ffa2c5fdda8a9cc254edf67c4458b15db1252fa"&gt;commit 7ffa2c5f&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 7ffa2c5fdda8a9cc254edf67c4458b15db1252fa
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Thu Jan 22 22:55:08 2015 +0100

    Issue #23293, asyncio: Rewrite IocpProactor.connect_pipe()
&lt;/pre&gt;
&lt;p&gt;The change adds &lt;tt class="docutils literal"&gt;_overlapped.ConnectPipe()&lt;/tt&gt; which tries to connect to the
pipe for asynchronous I/O (overlapped): &lt;strong&gt;call CreateFile() in a loop until
it doesn't fail with ERROR_PIPE_BUSY&lt;/strong&gt;. Use an increasing delay between 1 ms
and 100 ms.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="race-condition-in-basesubprocesstransport-try-finish"&gt;
&lt;h2&gt;Race Condition in BaseSubprocessTransport._try_finish()&lt;/h2&gt;
&lt;p&gt;If the process exited before the &lt;tt class="docutils literal"&gt;_post_init()&lt;/tt&gt; method was called, scheduling
the call to &lt;tt class="docutils literal"&gt;_call_connection_lost()&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;call_soon()&lt;/tt&gt; is wrong:
&lt;tt class="docutils literal"&gt;connection_made()&lt;/tt&gt; must be called before &lt;tt class="docutils literal"&gt;connection_lost()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Reuse the &lt;tt class="docutils literal"&gt;BaseSubprocessTransport._call()&lt;/tt&gt; method to schedule the call to
&lt;tt class="docutils literal"&gt;_call_connection_lost()&lt;/tt&gt; to ensure that &lt;tt class="docutils literal"&gt;connection_made()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;connection_lost()&lt;/tt&gt; are called in the correct order.&lt;/p&gt;
&lt;p&gt;At Dec 18, 2014, I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/1b9763d0a9c62c13dc2a06770032e5906b610c96"&gt;commit 1b9763d0&lt;/a&gt;.
The explanation is long, but the change is basically a single line change,
extract:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
- self._loop.call_soon(self._call_connection_lost, None)
+ self._call(self._call_connection_lost, None)
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Ordering properly callbacks in asyncio is challenging!&lt;/strong&gt; The order matters
for the semantics of asyncio: it is part of the design of the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-3156/"&gt;PEP 3156 --
Asynchronous IO Support Rebooted: the &amp;quot;asyncio&amp;quot; Module&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="close-the-transport-on-failure-resourcewarning"&gt;
&lt;h2&gt;Close the transport on failure: ResourceWarning&lt;/h2&gt;
&lt;p&gt;At January 15, 2015, I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/4bf22e033e975f61c33752db5a3764dc0f7d0b03"&gt;commit 4bf22e03&lt;/a&gt;,
extract:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-  yield from transp._post_init()
+  try:
+      yield from transp._post_init()
+  except:
+      transp.close()
+      raise
&lt;/pre&gt;
&lt;p&gt;Later, I will spend a lot of time (push many more changes) to ensure that
resources are properly released (especially close transports on failure,
similar to this change).&lt;/p&gt;
&lt;p&gt;I will add many &lt;strong&gt;ResourceWarnings&lt;/strong&gt; warnings in destructors when a transport,
subprocess or event loop is not closed explicitly.&lt;/p&gt;
&lt;p&gt;For example, notice the &lt;tt class="docutils literal"&gt;ResourceWarnings&lt;/tt&gt; in the current destructor of
&lt;tt class="docutils literal"&gt;_SelectorTransport&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
class _SelectorTransport(transports._FlowControlMixin,
                         transports.Transport):

    def __del__(self, _warn=warnings.warn):
        if self._sock is not None:
            _warn(f&amp;quot;unclosed transport {self!r}&amp;quot;, ResourceWarning, source=self)
            self._sock.close()
&lt;/pre&gt;
&lt;p&gt;I even enhanced Python 3.6 to be able to provide the &lt;strong&gt;traceback where the
leaked resource has been allocated&lt;/strong&gt; thanks to my &lt;tt class="docutils literal"&gt;tracemalloc&lt;/tt&gt; module.
Example with &lt;tt class="docutils literal"&gt;filebug.py&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def func():
    f = open(__file__)
    f = None

func()
&lt;/pre&gt;
&lt;p&gt;Output with Python 3.6:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -Wd -X tracemalloc=5 filebug.py
filebug.py:3: ResourceWarning: unclosed file &amp;lt;_io.TextIOWrapper name='filebug.py' mode='r' encoding='UTF-8'&amp;gt;
  f = None
Object allocated at (most recent call first):
  File &amp;quot;filebug.py&amp;quot;, lineno 2
    f = open(__file__)
  File &amp;quot;filebug.py&amp;quot;, lineno 5
    func()
&lt;/pre&gt;
&lt;p&gt;The line where the warning is emitted is usually useless to understand the bug,
whereas the traceback is very useful to identify the leaked resource.&lt;/p&gt;
&lt;p&gt;See &lt;a class="reference external" href="https://pythondev.readthedocs.io/debug_tools.html#resourcewarning"&gt;my ResourceWarning documentation&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="cleanup-code-handling-pipes"&gt;
&lt;h2&gt;Cleanup code handling pipes&lt;/h2&gt;
&lt;p&gt;Thanks to the new implementation of &lt;tt class="docutils literal"&gt;connect_pipe()&lt;/tt&gt;, I was able to push
changes to simplify the code and remove various hacks in code handling pipes.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/2b77c5467f376257ae22cbfbcb3a0e5e6349e92d"&gt;commit 2b77c546&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 2b77c5467f376257ae22cbfbcb3a0e5e6349e92d
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Thu Jan 22 23:50:03 2015 +0100

    asyncio, Tulip issue 204: Fix IocpProactor.accept_pipe()

    Overlapped.ConnectNamedPipe() now returns a boolean: True if the pipe is
    connected (if ConnectNamedPipe() failed with ERROR_PIPE_CONNECTED), False if
    the connection is in progress.

    This change removes multiple hacks in IocpProactor.
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/3d2256f671b7ed5c769dd34b27ae597cbc69047c"&gt;commit 3d2256f6&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 3d2256f671b7ed5c769dd34b27ae597cbc69047c
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Mon Jan 26 11:02:59 2015 +0100

    Issue #23293, asyncio: Cleanup IocpProactor.close()

    The special case for connect_pipe() is not more needed. connect_pipe() doesn't
    use overlapped operations anymore.
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/a19b7b3fcafe52b98245e14466ffc4d6750ca4f1"&gt;commit a19b7b3f&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit a19b7b3fcafe52b98245e14466ffc4d6750ca4f1
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Mon Jan 26 15:03:20 2015 +0100

    asyncio: Fix ProactorEventLoop.start_serving_pipe()

    If a client connected before the server was closed: drop the client (close the
    pipe) and exit.
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/e0fd157ba0cc92e435e7520b4ff641ca68d72244"&gt;commit e0fd157b&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit e0fd157ba0cc92e435e7520b4ff641ca68d72244
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Mon Jan 26 15:04:03 2015 +0100

    Issue #23293, asyncio: Rewrite IocpProactor.connect_pipe() as a coroutine

    Use a coroutine with asyncio.sleep() instead of call_later() to ensure that the
    schedule call is cancelled.

    Add also a unit test cancelling connect_pipe().
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/41063d2a59a24e257cd9ce62137e36c862e3ab1e"&gt;commit 41063d2a&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 41063d2a59a24e257cd9ce62137e36c862e3ab1e
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Mon Jan 26 22:30:49 2015 +0100

    asyncio, Tulip issue 204: Fix IocpProactor.recv()

    If ReadFile() fails with ERROR_BROKEN_PIPE, the operation is not pending: don't
    register the overlapped.

    I don't know if WSARecv() can fail with ERROR_BROKEN_PIPE. Since
    Overlapped.WSARecv() already handled ERROR_BROKEN_PIPE, let me guess that it
    has the same behaviour than ReadFile().
&lt;/pre&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="asyncio"></category></entry><entry><title>Asyncio: Proactor Cancellation From Hell</title><link href="https://vstinner.github.io/asyncio-proactor-cancellation-from-hell.html" rel="alternate"></link><published>2019-01-28T20:20:00+01:00</published><updated>2019-01-28T20:20:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-01-28:/asyncio-proactor-cancellation-from-hell.html</id><summary type="html">&lt;img alt="South Park Hell" src="https://vstinner.github.io/images/south_park_hell.jpg" /&gt;
&lt;p&gt;Between 2014 and 2015, I was working on the new shiny &lt;tt class="docutils literal"&gt;asyncio&lt;/tt&gt; module
(module added to Python 3.4 released in March 2014). I helped to stabilize the
Windows implementation because... well, nobody else was paying attention to it,
and I was worried that test_asyncio &lt;strong&gt;randomly crashed&lt;/strong&gt; on Windows.&lt;/p&gt;
&lt;p&gt;One …&lt;/p&gt;</summary><content type="html">&lt;img alt="South Park Hell" src="https://vstinner.github.io/images/south_park_hell.jpg" /&gt;
&lt;p&gt;Between 2014 and 2015, I was working on the new shiny &lt;tt class="docutils literal"&gt;asyncio&lt;/tt&gt; module
(module added to Python 3.4 released in March 2014). I helped to stabilize the
Windows implementation because... well, nobody else was paying attention to it,
and I was worried that test_asyncio &lt;strong&gt;randomly crashed&lt;/strong&gt; on Windows.&lt;/p&gt;
&lt;p&gt;One bug really annoyed me, I started to fix it in July 2014, but I only
succeeded to &lt;strong&gt;fix the root issue&lt;/strong&gt; in January 2015: &lt;strong&gt;six months later&lt;/strong&gt;!&lt;/p&gt;
&lt;p&gt;It was really difficult to find documentation on IOCP and asynchronous
programming on Windows. &lt;strong&gt;I had to ask for help to someone who had access to
the Windows source code&lt;/strong&gt; to understand the bug...&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Spoiler:&lt;/strong&gt; cancelling an overlapped &lt;tt class="docutils literal"&gt;RegisterWaitForSingleObject()&lt;/tt&gt; with
&lt;tt class="docutils literal"&gt;UnregisterWait()&lt;/tt&gt; is asynchronous. The asynchronous part is not well
documented and it took me months of debug to understand it. Moreover, the bug
was well hidden for various reasons that we will see below.&lt;/p&gt;
&lt;p&gt;Next article: &lt;a class="reference external" href="https://vstinner.github.io/asyncio-proactor-connect-pipe-race-condition.html"&gt;Asyncio: Proactor ConnectPipe() Race Condition&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="fix-cancel-when-called-twice"&gt;
&lt;h2&gt;Fix cancel() when called twice&lt;/h2&gt;
&lt;p&gt;July 2014, &lt;a class="reference external" href="https://github.com/python/asyncio/issues/195"&gt;asyncio issue #195&lt;/a&gt;: while working on a
&lt;tt class="docutils literal"&gt;SIGINT&lt;/tt&gt; signal handler for the &lt;tt class="docutils literal"&gt;ProactorEventLoop&lt;/tt&gt; on Windows (&lt;a class="reference external" href="https://github.com/python/asyncio/issues/195"&gt;asyncio
issue #191&lt;/a&gt;), I hit a bug on
Windows: &lt;tt class="docutils literal"&gt;_WaitHandleFuture.cancel()&lt;/tt&gt; crash if the wait event was already
unregistered by &lt;tt class="docutils literal"&gt;finish_wait_for_handle()&lt;/tt&gt;. The bug was that
&lt;tt class="docutils literal"&gt;UnregisterWait()&lt;/tt&gt; was called twice.&lt;/p&gt;
&lt;p&gt;I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/fea6a100dc51012cb0187374ad31de330ebc0035"&gt;commit fea6a100&lt;/a&gt;
to fix this crash:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit fea6a100dc51012cb0187374ad31de330ebc0035
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Fri Jul 25 00:54:53 2014 +0200

    Improve stability of the proactor event loop, especially operations on
    overlapped objects (...)
&lt;/pre&gt;
&lt;p&gt;Main changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Fix a crash: &lt;strong&gt;don't call UnregisterWait() twice if a _WaitHandleFuture
is cancelled twice&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Fix another crash: &lt;tt class="docutils literal"&gt;_OverlappedFuture.cancel()&lt;/tt&gt; doesn't cancel the
overlapped anymore if it is already cancelled or completed. Log also an error
if the cancellation failed.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;IocpProactor.close()&lt;/tt&gt; now cancels futures rather than cancelling directly
underlaying overlapped objects.&lt;/li&gt;
&lt;li&gt;Add a destructor to the &lt;tt class="docutils literal"&gt;IocpProactor&lt;/tt&gt; class which closes it&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="clear-reference-from-overlappedfuture-to-overlapped"&gt;
&lt;h2&gt;Clear reference from _OverlappedFuture to overlapped&lt;/h2&gt;
&lt;p&gt;July 2014, I created &lt;a class="reference external" href="https://github.com/python/asyncio/issues/196"&gt;asyncio issue #196&lt;/a&gt;:
&lt;tt class="docutils literal"&gt;_OverlappedFuture.set_result()&lt;/tt&gt; should clear the its reference to the
overlapped object.&lt;/p&gt;
&lt;p&gt;It is important to explicitly clear references to Python objects as soon as
possible to release resources. Otherwise, an object can remain alive
longer than expected.&lt;/p&gt;
&lt;p&gt;I noticed that _OverlappedFuture kept a reference to the undelying overlapped
object even after the asynchronous operation completed. I started to work on a
fix but I had many issues to fix completely this bug... it is just the
beginning of a long journey.&lt;/p&gt;
&lt;div class="section" id="clear-the-reference-on-cancellation-and-error"&gt;
&lt;h3&gt;Clear the reference on cancellation and error&lt;/h3&gt;
&lt;p&gt;I pushed a first fix: &lt;a class="reference external" href="https://github.com/python/cpython/commit/18a28dc5c28ae9a953f537486780159ddb768702"&gt;commit 18a28dc5&lt;/a&gt;
clears the reference to the overlapped in &lt;tt class="docutils literal"&gt;cancel()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;set_exception()&lt;/tt&gt;
methods of &lt;tt class="docutils literal"&gt;_OverlappedFuture&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 18a28dc5c28ae9a953f537486780159ddb768702
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Fri Jul 25 13:05:20 2014 +0200

    * _OverlappedFuture.cancel() now clears its reference to the overlapped object.
      Make also the _OverlappedFuture.ov attribute private.
    * _OverlappedFuture.set_exception() now cancels the overlapped operation.
    * (...)
&lt;/pre&gt;
&lt;p&gt;I started by this change because it didn't make the tests less stable.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="clear-the-reference-in-poll"&gt;
&lt;h3&gt;Clear the reference in poll()&lt;/h3&gt;
&lt;p&gt;Clearing the reference to the overlapped in &lt;tt class="docutils literal"&gt;cancel()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;set_exception()&lt;/tt&gt; &lt;strong&gt;works well&lt;/strong&gt;. But when I try to do the same on success (in
&lt;tt class="docutils literal"&gt;set_result()&lt;/tt&gt;), &lt;strong&gt;I get random errors&lt;/strong&gt;. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
C:\haypo\tulip&amp;gt;\python33\python.exe runtests.py test_pipe
...
Exception RuntimeError: '&amp;lt;_overlapped.Overlapped object at 0x00000000035E7660&amp;gt; s
till has pending operation at deallocation, the process may crash' ignored
...
Fatal read error on pipe transport
protocol: &amp;lt;asyncio.streams.StreamReaderProtocol object at 0x00000000035EE668&amp;gt;
transport: &amp;lt;_ProactorDuplexPipeTransport fd=348&amp;gt;
Traceback (most recent call last):
  File &amp;quot;C:\haypo\tulip\asyncio\proactor_events.py&amp;quot;, line 159, in _loop_reading
    data = fut.result()  # deliver data later in &amp;quot;finally&amp;quot; clause
  File &amp;quot;C:\haypo\tulip\asyncio\futures.py&amp;quot;, line 271, in result
    raise self._exception
  File &amp;quot;C:\haypo\tulip\asyncio\windows_events.py&amp;quot;, line 488, in _poll
    value = callback(transferred, key, ov)
  File &amp;quot;C:\haypo\tulip\asyncio\windows_events.py&amp;quot;, line 279, in finish_recv
    return ov.getresult()
OSError: [WinError 996] Overlapped I/O event is not in a signaled state
...
&lt;/pre&gt;
&lt;p&gt;It seems that the problem only occurs in the fast-path of
&lt;tt class="docutils literal"&gt;IocpProactor._register()&lt;/tt&gt;, when the overlapped is not added to &lt;tt class="docutils literal"&gt;_cache&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Clearing the reference in &lt;tt class="docutils literal"&gt;_poll()&lt;/tt&gt;, when &lt;tt class="docutils literal"&gt;GetQueuedCompletionStatus()&lt;/tt&gt; read
the status, &lt;strong&gt;works&lt;/strong&gt;! I pushed a second fix, &lt;a class="reference external" href="https://github.com/python/cpython/commit/65dd69a3da16257bd86b92900e5ec5a8dd26f1d9"&gt;commit 65dd69a3&lt;/a&gt;
changes &lt;tt class="docutils literal"&gt;_poll()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 65dd69a3da16257bd86b92900e5ec5a8dd26f1d9
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Fri Jul 25 22:36:05 2014 +0200

    IocpProactor._poll() clears the reference to the overlapped operation
    when the operation is done. (...)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="ignore-false-alarms"&gt;
&lt;h3&gt;Ignore false alarms&lt;/h3&gt;
&lt;p&gt;I tried to add the overlapped into &lt;tt class="docutils literal"&gt;_cache&lt;/tt&gt; but &lt;strong&gt;then the event loop started
to hang or to fail with new errors&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;I analyzed an overlapped &lt;tt class="docutils literal"&gt;WSARecv()&lt;/tt&gt; which has been cancelled. Just after
calling &lt;tt class="docutils literal"&gt;CancelIoEx()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;HasOverlappedIoCompleted()&lt;/tt&gt; returns 0.&lt;/p&gt;
&lt;p&gt;Even after &lt;tt class="docutils literal"&gt;GetQueuedCompletionStatus()&lt;/tt&gt; read the status,
&lt;tt class="docutils literal"&gt;HasOverlappedIoCompleted()&lt;/tt&gt; still returns 0.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;After hours of debug, I eventually found the main issue!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Sometimes &lt;tt class="docutils literal"&gt;GetQueuedCompletionStatus()&lt;/tt&gt; returns an overlapped operation which
has not completed yet. I modified &lt;tt class="docutils literal"&gt;IocpProactor._poll()&lt;/tt&gt; to ignore the false
alarm, &lt;a class="reference external" href="https://github.com/python/cpython/commit/51e44ea66aefb4229e506263acf40d35596d279c"&gt;commit 51e44ea6&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 51e44ea66aefb4229e506263acf40d35596d279c
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Sat Jul 26 00:58:34 2014 +0200

    _OverlappedFuture.set_result() now clears its reference to the
    overlapped object.

    IocpProactor._poll() now also ignores false alarms:
    GetQueuedCompletionStatus() returns the overlapped but it is still
    pending.
&lt;/pre&gt;
&lt;p&gt;The fix adds this comment:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# FIXME: why do we get false alarms?
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="keep-a-reference-of-overlapped"&gt;
&lt;h3&gt;Keep a reference of overlapped&lt;/h3&gt;
&lt;p&gt;To stabilize the code, I modified &lt;tt class="docutils literal"&gt;ProactorIocp&lt;/tt&gt; to keep a reference to the
overlapped object (it already kept a reference previously but not in all cases).
&lt;strong&gt;Otherwise the memory may be reused and GetQueuedCompletionStatus() may use
random bytes and behaves badly&lt;/strong&gt;. I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/42d3bdeed6e34117b787d61a471563a0dba6a894"&gt;commit 42d3bdee&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 42d3bdeed6e34117b787d61a471563a0dba6a894
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Mon Jul 28 00:18:43 2014 +0200

    ProactorIocp._register() now registers the overlapped
    in the _cache dictionary, even if we already got the result. We need to keep a
    reference to the overlapped object, otherwise the memory may be reused and
    GetQueuedCompletionStatus() may use random bytes and behaves badly.

    There is still a hack for ConnectNamedPipe(): the overlapped object is not
    registered into _cache if the overlapped object completed directly.

    Log also an error in debug mode in ProactorIocp._loop() if we get an unexpected
    event.

    Add a protection in ProactorIocp.close() to avoid blocking, even if it should
    not happen. I still don't understand exactly why some the completion of some
    overlapped objects are not notified.
&lt;/pre&gt;
&lt;p&gt;The change adds a long comment:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# Even if GetOverlappedResult() was called, we have to wait for the
# notification of the completion in GetQueuedCompletionStatus().
# Register the overlapped operation to keep a reference to the
# OVERLAPPED object, otherwise the memory is freed and Windows may
# read uninitialized memory.
#
# For an unknown reason, ConnectNamedPipe() behaves differently:
# the completion is not notified by GetOverlappedResult() if we
# already called GetOverlappedResult(). For this specific case, we
# don't expect notification (register is set to False).
&lt;/pre&gt;
&lt;p&gt;I pushed another change to attempt to stabilize the code, &lt;a class="reference external" href="https://github.com/python/cpython/commit/313a9809043ed2ed1ad25282af7169e08cdc92a3"&gt;commit 313a9809&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 313a9809043ed2ed1ad25282af7169e08cdc92a3
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Tue Jul 29 12:58:23 2014 +0200

    * _WaitHandleFuture.cancel() now notify IocpProactor through the overlapped
      object that the wait was cancelled.
    * Optimize IocpProactor.wait_for_handle() gets the result if the wait is
      signaled immediatly.
    (...)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="asyncio-issue-196-closed"&gt;
&lt;h3&gt;asyncio issue #196 closed&lt;/h3&gt;
&lt;p&gt;The initial issue &amp;quot;_OverlappedFuture.set_result() should clear its reference to
the overlapped object&amp;quot; has been fixed, so &lt;strong&gt;I closed this issue&lt;/strong&gt;. I didn't
know at this point that all bugs were not fixed yet...&lt;/p&gt;
&lt;p&gt;I also opened the new &lt;a class="reference external" href="https://github.com/python/asyncio/issues/204"&gt;asyncio issue #204&lt;/a&gt; to investigate
&lt;tt class="docutils literal"&gt;accept_pipe()&lt;/tt&gt; special case. We will analyze this funny bug in another article.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="bpo-23095-race-condition-when-cancelling-a-waithandlefuture"&gt;
&lt;h2&gt;bpo-23095: race condition when cancelling a _WaitHandleFuture&lt;/h2&gt;
&lt;p&gt;At December 21, 2014, five months after a long serie of changes to stabilize
asyncio...  &lt;strong&gt;asyncio was still crashing randomly on Windows&lt;/strong&gt;! I created
&lt;a class="reference external" href="https://bugs.python.org/issue23095"&gt;bpo-23095: race condition when cancelling a _WaitHandleFuture&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;On Windows using the IOCP (proactor) event loop, I noticed race conditions when
running the test suite of Trollius (my old deprecated asyncio port to Python
2). For example, sometimes the return code of a process was &lt;tt class="docutils literal"&gt;None&lt;/tt&gt;, whereas
this case &lt;strong&gt;must never happen&lt;/strong&gt;. It looks like the &lt;tt class="docutils literal"&gt;wait_for_handle()&lt;/tt&gt; method
doesn't behave properly.&lt;/p&gt;
&lt;p&gt;When I run the test suite of asyncio in debug mode (PYTHONASYNCIODEBUG=1),
sometimes I see the message &amp;quot;GetQueuedCompletionStatus() returned an unexpected
event&amp;quot; which &lt;strong&gt;should never occur neither&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;I added debug traces. I saw that the &lt;tt class="docutils literal"&gt;IocpProactor.wait_for_handle()&lt;/tt&gt; calls
later &lt;tt class="docutils literal"&gt;PostQueuedCompletionStatus()&lt;/tt&gt; through its internal C callback
(&lt;tt class="docutils literal"&gt;PostToQueueCallback&lt;/tt&gt;). It looks like &lt;strong&gt;sometimes the callback is called
whereas the wait was cancelled/acked&lt;/strong&gt; by &lt;tt class="docutils literal"&gt;UnregisterWait()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;... I didn't understand the logic between &lt;tt class="docutils literal"&gt;RegisterWaitForSingleObject()&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;UnregisterWait()&lt;/tt&gt; and the callback ....&lt;/p&gt;
&lt;p&gt;It looks like sometimes the overlapped object created in Python
(&lt;tt class="docutils literal"&gt;ov = _overlapped.Overlapped(NULL)&lt;/tt&gt;) is destroyed, before
&lt;tt class="docutils literal"&gt;PostToQueueCallback()&lt;/tt&gt; is called. In the unit tests, &lt;strong&gt;it doesn't crash
because a different overlapped object is created and it gets the same memory
address&lt;/strong&gt; (the memory allocator reuses a just freed memory block).&lt;/p&gt;
&lt;p&gt;The implementation of &lt;tt class="docutils literal"&gt;wait_for_handle()&lt;/tt&gt; had an optimization: it polls
immediatly the wait to check if it already completed. I tried to remove it, but
I got some different issues. If I understood correctly, &lt;strong&gt;this optimization
hides other bugs and reduce the probability of getting the race condition&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;wait_for_handle()&lt;/tt&gt; is used to wait for the completion of a subprocess, so by
all unit tests running subprocesses, but also in &lt;tt class="docutils literal"&gt;test_wait_for_handle()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;test_wait_for_handle_cancel()&lt;/tt&gt; tests. I suspect that running
&lt;tt class="docutils literal"&gt;test_wait_for_handle()&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;test_wait_for_handle_cancel()&lt;/tt&gt; triggers the
bug.&lt;/p&gt;
&lt;p&gt;Removing &lt;tt class="docutils literal"&gt;_winapi.CloseHandle(self._iocp)&lt;/tt&gt; in &lt;tt class="docutils literal"&gt;IocpProactor.close()&lt;/tt&gt;
works around the bug. The bug looks to be an expected call to
&lt;tt class="docutils literal"&gt;PostToQueueCallback()&lt;/tt&gt; which calls &lt;tt class="docutils literal"&gt;PostQueuedCompletionStatus()&lt;/tt&gt; on an
IOCP. Not closing the IOCP means using a different IOCP for each test, so the
unexpected call to &lt;tt class="docutils literal"&gt;PostQueuedCompletionStatus()&lt;/tt&gt; has no effect on following
tests.&lt;/p&gt;
&lt;p&gt;I rewrote some parts of the IOCP code in asyncio. Maybe I introduced this issue
during the refactoring. Maybe &lt;strong&gt;it already existed before but nobody noticed
it, asyncio had fewer unit tests before&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fixing-the-root-issue-overlapped-cancellation-from-hell"&gt;
&lt;h2&gt;Fixing the root issue: Overlapped Cancellation From Hell&lt;/h2&gt;
&lt;p&gt;I looked into Twisted implemented of proactor, but it didn't support
subprocesses.&lt;/p&gt;
&lt;p&gt;I looked at libuv: it supported processes but not cancelling a wait on a
process handle...&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I had to ask for help to someone who had access to the Windows source code&lt;/strong&gt;
to understand the bug...&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;After six months of intense debugging, I eventually identified the root
issue&lt;/strong&gt; (I pushed the first fix at July 25, 2014). I pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/d0a28dee78d099fcadc71147cba4affb6efa0c97"&gt;commit
d0a28dee&lt;/a&gt;
(&lt;a class="reference external" href="https://bugs.python.org/issue23095"&gt;bpo-23095&lt;/a&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit d0a28dee78d099fcadc71147cba4affb6efa0c97
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Wed Jan 21 23:39:51 2015 +0100

    Issue #23095, asyncio: Rewrite _WaitHandleFuture.cancel()
&lt;/pre&gt;
&lt;p&gt;This change fixes a race conditon related to &lt;tt class="docutils literal"&gt;_WaitHandleFuture.cancel()&lt;/tt&gt;
leading to a Python crash or &amp;quot;GetQueuedCompletionStatus() returned an
unexpected event&amp;quot; logs. Previously, &lt;strong&gt;it was possible that the cancelled wait
completes whereas the overlapped object was already destroyed&lt;/strong&gt;. Sometimes, a
different overlapped was allocated at the same address, emitting a log about
unexpected completition (but no crash).&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;_WaitHandleFuture.cancel()&lt;/tt&gt; now &lt;strong&gt;waits until the handle wait is cancelled&lt;/strong&gt;
(until the cancellation completes) before clearing its reference to the
overlapped object. To wait until the cancellation completes,
&lt;tt class="docutils literal"&gt;UnregisterWaitEx()&lt;/tt&gt; is used with an event (instead of using
&lt;tt class="docutils literal"&gt;UnregisterWait()&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;To wait for this event, a new &lt;tt class="docutils literal"&gt;_WaitCancelFuture&lt;/tt&gt; class was added. It's a
simplified version of &lt;tt class="docutils literal"&gt;_WaitCancelFuture&lt;/tt&gt;. For example, its &lt;tt class="docutils literal"&gt;cancel()&lt;/tt&gt;
method calls &lt;tt class="docutils literal"&gt;UnregisterWait()&lt;/tt&gt;, not &lt;tt class="docutils literal"&gt;UnregisterWaitEx()&lt;/tt&gt;.
&lt;tt class="docutils literal"&gt;_WaitCancelFuture&lt;/tt&gt; should not be cancelled.&lt;/p&gt;
&lt;p&gt;The overlapped object is &lt;strong&gt;kept alive&lt;/strong&gt; in &lt;tt class="docutils literal"&gt;_WaitHandleFuture&lt;/tt&gt; &lt;strong&gt;until the
wait is unregistered&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Later, I pushed a few more changes to fix corner cases.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/1ca9392c7083972c1953c02e6f2cca54934ce0a6"&gt;commit 1ca9392c&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 1ca9392c7083972c1953c02e6f2cca54934ce0a6
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Thu Jan 22 00:17:54 2015 +0100

    Issue #23095, asyncio: IocpProactor.close() must not cancel pending
    _WaitCancelFuture futures
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/752aba7f999b08c833979464a36840de8be0baf0"&gt;commit 752aba7f&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 752aba7f999b08c833979464a36840de8be0baf0
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Thu Jan 22 22:47:13 2015 +0100

    asyncio: IocpProactor.close() doesn't cancel anymore futures which are already
    cancelled
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/24dfa3c1d6b21e731bd167a13153968bba8fa5ce"&gt;commit 24dfa3c1&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 24dfa3c1d6b21e731bd167a13153968bba8fa5ce
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Mon Jan 26 22:30:28 2015 +0100

    Issue #23095, asyncio: Fix _WaitHandleFuture.cancel()

    If UnregisterWaitEx() fais with ERROR_IO_PENDING, it doesn't mean that the wait
    is unregistered yet. We still have to wait until the wait is cancelled.
&lt;/pre&gt;
&lt;p&gt;I think that &lt;em&gt;this&lt;/em&gt; issue can now be closed: &lt;tt class="docutils literal"&gt;UnregisterWaitEx()&lt;/tt&gt; really do
what we need in asyncio.&lt;/p&gt;
&lt;p&gt;I don't like the complexity of the IocpProactor._unregister() method and of the
_WaitCancelFuture class, but it looks that it's how we are supposed to wait
until a wait for a handle is cancelled...&lt;/p&gt;
&lt;p&gt;Windows IOCP API is much more complex that what I expected. It's probably
because some parts (especially &lt;tt class="docutils literal"&gt;RegisterWaitForSingleObject()&lt;/tt&gt;) are
implemented with threads in user land, not in the kernel.&lt;/p&gt;
&lt;p&gt;In short, I'm very happy that have fixed this very complex but also very
annoying IOCP bug in asyncio.&lt;/p&gt;
&lt;p&gt;I got a nice comment from &lt;a class="reference external" href="https://bugs.python.org/issue23095#msg234453"&gt;Guido van Rossum&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;Congrats with the fix, and thanks for your perseverance!&lt;/strong&gt;&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="summary-of-the-race-condition"&gt;
&lt;h2&gt;Summary of the race condition&lt;/h2&gt;
&lt;p&gt;Events of the crashing unit test:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The loop (ProactorEventLoop) spawns a subprocess.&lt;/li&gt;
&lt;li&gt;The loop creates a _WaitHandleFuture object which creates an overlapped to
wait until the process completes (call &lt;tt class="docutils literal"&gt;RegisterWaitForSingleObject()&lt;/tt&gt;):
&lt;strong&gt;allocate&lt;/strong&gt; memory for the overlapped.&lt;/li&gt;
&lt;li&gt;The wait future is cancelled (call &lt;tt class="docutils literal"&gt;UnregisterWait()&lt;/tt&gt;).&lt;/li&gt;
&lt;li&gt;The overlapped is destroyed: &lt;strong&gt;free&lt;/strong&gt; overlapped memory.&lt;/li&gt;
&lt;li&gt;The overlapped completes: &lt;strong&gt;write&lt;/strong&gt; into the overlapped memory.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The main issue is the order of the two last events.&lt;/p&gt;
&lt;p&gt;Sometimes, the overlapped completed before the memory was freed: everything is
fine.&lt;/p&gt;
&lt;p&gt;Sometimes, the overlapped completed after the memory was freed: Python crashed
(segmentation fault).&lt;/p&gt;
&lt;p&gt;Sometimes, another _WaitHandleFuture was created in the meanwhile and created a
second overlapped which was allocated at the same memory address than the freed
memory of the previous overlapped. In this case, when the first overlapped
completes, Python didn't crash but logged an unexpected completion message.&lt;/p&gt;
&lt;p&gt;Sometimes, the write was done in freed memory: the write didn't crash Python,
but caused bugs which didn't make sense.&lt;/p&gt;
&lt;p&gt;There were even more cases causing even more surprising behaviors.&lt;/p&gt;
&lt;p&gt;Summary of the fix:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;(... similar steps for the beginning ...)&lt;/li&gt;
&lt;li&gt;The wait future is cancelled: &lt;strong&gt;create an event&lt;/strong&gt; to wait until the
cancellation completes (call &lt;tt class="docutils literal"&gt;UnregisterWaitEx()&lt;/tt&gt;).&lt;/li&gt;
&lt;li&gt;Wait for the event.&lt;/li&gt;
&lt;li&gt;The event is signalled which means that the cancellation completed: &lt;strong&gt;write&lt;/strong&gt;
into the overlapped memory.&lt;/li&gt;
&lt;li&gt;The overlapped is destroyed: &lt;strong&gt;free&lt;/strong&gt; overlapped memory.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="asyncio"></category></entry><entry><title>Locale Bugfixes in Python 3</title><link href="https://vstinner.github.io/locale-bugfixes-python3.html" rel="alternate"></link><published>2019-01-09T00:30:00+01:00</published><updated>2019-01-09T00:30:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2019-01-09:/locale-bugfixes-python3.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/svensson/40467591/"&gt;&lt;img alt="Unicode Mixed Bag" src="https://vstinner.github.io/images/unicode_bag.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;This article describes a few locales bugs that I fixed in Python 3 between 2012
(Python 3.3) and 2018 (Python 3.7):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Support non-ASCII decimal point and thousands separator&lt;/li&gt;
&lt;li&gt;Crash with non-ASCII decimal point&lt;/li&gt;
&lt;li&gt;LC_NUMERIC encoding different than LC_CTYPE encoding&lt;/li&gt;
&lt;li&gt;LC_MONETARY encoding different than LC_CTYPE encoding&lt;/li&gt;
&lt;li&gt;Tests non-ASCII locales …&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/svensson/40467591/"&gt;&lt;img alt="Unicode Mixed Bag" src="https://vstinner.github.io/images/unicode_bag.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;This article describes a few locales bugs that I fixed in Python 3 between 2012
(Python 3.3) and 2018 (Python 3.7):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Support non-ASCII decimal point and thousands separator&lt;/li&gt;
&lt;li&gt;Crash with non-ASCII decimal point&lt;/li&gt;
&lt;li&gt;LC_NUMERIC encoding different than LC_CTYPE encoding&lt;/li&gt;
&lt;li&gt;LC_MONETARY encoding different than LC_CTYPE encoding&lt;/li&gt;
&lt;li&gt;Tests non-ASCII locales&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;See also my previous locale bugfixes: &lt;a class="reference external" href="https://vstinner.github.io/python3-locales-encodings.html"&gt;Python 3, locales and encodings&lt;/a&gt;&lt;/p&gt;
&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Each language and each country has different ways to represent dates, monetary
values, numbers, etc. Unix has &amp;quot;locales&amp;quot; to configure applications for a
specific language and a specific country. For example, there are &lt;tt class="docutils literal"&gt;fr_BE&lt;/tt&gt; for
Belgium (french) and &lt;tt class="docutils literal"&gt;fr_FR&lt;/tt&gt; for France (french).&lt;/p&gt;
&lt;p&gt;In practice, each locale uses its own encoding and problems arise when an
application uses a different encoding than the locale. There are LC_NUMERIC
locale for numbers, LC_MONETARY locale for monetary and LC_CTYPE for the
encoding. Not only it's possible to configure an application to use LC_NUMERIC
with a different encoding than LC_CTYPE, but some users use such configuration!&lt;/p&gt;
&lt;p&gt;In an application which only uses bytes for text, as Python 2 does mostly, it's
mostly fine: in the worst case, users see &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Mojibake"&gt;mojibake&lt;/a&gt;, but the application doesn't
&amp;quot;crash&amp;quot; (exit and/or data loss). On the other side, &lt;strong&gt;Python 3 is designed to
use Unicode for text and fail with hard Unicode errors if it fails to decode
bytes and fails to encode text&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="support-non-ascii-decimal-point-and-thousands-separator"&gt;
&lt;h2&gt;Support non-ASCII decimal point and thousands separator&lt;/h2&gt;
&lt;p&gt;The Unicode type has been reimplemented in Python 3.3 to use &amp;quot;compact string&amp;quot;:
&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0393/"&gt;PEP 393 &amp;quot;Flexible String Representation&amp;quot;&lt;/a&gt;. The new implementation is more
complex and the format() function has been limited to ASCII for the decimal
point and thousands separator (format a number using the &amp;quot;n&amp;quot; type).&lt;/p&gt;
&lt;p&gt;In January 2012, Stefan Krah noticed the regression (compared to Python 3.2)
and reported &lt;a class="reference external" href="https://bugs.python.org/issue13706"&gt;bpo-13706&lt;/a&gt;. I fixed the
code to support non-ASCII in format (&lt;a class="reference external" href="https://github.com/python/cpython/commit/a4ac600d6f9c5b74b97b99888b7cf3a7973cadc8"&gt;commit a4ac600d&lt;/a&gt;).
But when I did more tests, I noticed that the &amp;quot;n&amp;quot; type doesn't decode properly
the decimal point and thousands seprator which come from the &lt;tt class="docutils literal"&gt;localeconv()&lt;/tt&gt;
function which uses byte strings.&lt;/p&gt;
&lt;p&gt;I fixed &lt;tt class="docutils literal"&gt;format(int, &amp;quot;n&amp;quot;)&lt;/tt&gt; with &lt;a class="reference external" href="https://github.com/python/cpython/commit/41a863cb81608c779d60b49e7be8a115816734fc"&gt;commit 41a863cb&lt;/a&gt;,
decode decimal point and the thousands separator (&lt;tt class="docutils literal"&gt;localeconv()&lt;/tt&gt; fields) from
the locale encoding, rather than latin1, using &lt;tt class="docutils literal"&gt;PyUnicode_DecodeLocale()&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 41a863cb81608c779d60b49e7be8a115816734fc
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;haypocalc.com&amp;gt;
Date:   Fri Feb 24 00:37:51 2012 +0100

    Issue #13706: Fix format(int, &amp;quot;n&amp;quot;) for locale with non-ASCII thousands separator

     * Decode thousands separator and decimal point using PyUnicode_DecodeLocale()
       (from the locale encoding), instead of decoding them implicitly from latin1
     * Remove _PyUnicode_InsertThousandsGroupingLocale(), it was not used
     * Change _PyUnicode_InsertThousandsGrouping() API to return the maximum
       character if unicode is NULL
     * (...)
&lt;/pre&gt;
&lt;p&gt;Note: I decided to not fix Python 3.2:&lt;/p&gt;
&lt;blockquote&gt;
Hum, &lt;strong&gt;it is not trivial to redo the work on Python 3.2&lt;/strong&gt;. I prefer to leave
the code unchanged to not introduce a regression, and I wait until a Python
3.2 user complains (the bug exists since Python 3.0 and nobody complained).&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="crash-with-non-ascii-decimal-point"&gt;
&lt;h2&gt;Crash with non-ASCII decimal point&lt;/h2&gt;
&lt;p&gt;Six years later, in June 2018, I noticed that Python does crash when running
tests on locales:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python
Python 3.8.0a0 (heads/master-dirty:bcd3a1a18d, Jun 23 2018, 10:31:03)
[GCC 8.1.1 20180502 (Red Hat 8.1.1-1)] on linux
&amp;gt;&amp;gt;&amp;gt; import locale
&amp;gt;&amp;gt;&amp;gt; locale.str(2.5)
'2.5'
&amp;gt;&amp;gt;&amp;gt; '{:n}'.format(2.5)
'2.5'

&amp;gt;&amp;gt;&amp;gt; locale.setlocale(locale.LC_ALL, '')
'fr_FR.UTF-8'
&amp;gt;&amp;gt;&amp;gt; locale.str(2.5)
'2,5'
&amp;gt;&amp;gt;&amp;gt; '{:n}'.format(2.5)
python: Objects/unicodeobject.c:474: _PyUnicode_CheckConsistency: Assertion `maxchar &amp;lt; 128' failed.
Aborted (core dumped)
&lt;/pre&gt;
&lt;p&gt;I reported the issue as &lt;a class="reference external" href="https://bugs.python.org/issue33954"&gt;bpo-33954&lt;/a&gt;. The
bug only occurrs for decimal point larger than U+00FF (code point greater than
255). It was a bug in my &lt;a class="reference external" href="https://bugs.python.org/issue13706"&gt;bpo-13706&lt;/a&gt;
fix: &lt;a class="reference external" href="https://github.com/python/cpython/commit/a4ac600d6f9c5b74b97b99888b7cf3a7973cadc8"&gt;commit a4ac600d&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I pushed a second fix to properly support all cases, &lt;a class="reference external" href="https://github.com/python/cpython/commit/59423e3ddd736387cef8f7632c71954c1859bed0"&gt;commit 59423e3d&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 59423e3ddd736387cef8f7632c71954c1859bed0
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Mon Nov 26 13:40:01 2018 +0100

    bpo-33954: Fix _PyUnicode_InsertThousandsGrouping() (GH-10623)

    Fix str.format(), float.__format__() and complex.__format__() methods
    for non-ASCII decimal point when using the &amp;quot;n&amp;quot; formatter.

    Changes:

    * Rewrite _PyUnicode_InsertThousandsGrouping(): it now requires
      a _PyUnicodeWriter object for the buffer and a Python str object
      for digits.
    * Rename FILL() macro to unicode_fill(), convert it to static inline function,
      add &amp;quot;assert(0 &amp;lt;= start);&amp;quot; and rework its code.
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="lc-numeric-encoding-different-than-lc-ctype-encoding"&gt;
&lt;h2&gt;LC_NUMERIC encoding different than LC_CTYPE encoding&lt;/h2&gt;
&lt;p&gt;In August 2017, Petr Viktorin identified a bug in Koji (server building Fedora
packages): &lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1484497"&gt;UnicodeDecodeError in localeconv() makes test_float fail in Koji&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&amp;quot;This is tripped by Python's test suite, namely
test_float.GeneralFloatCases.test_float_with_comma&amp;quot;&lt;/blockquote&gt;
&lt;p&gt;He wrote a short reproducer script:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
import locale
locale.setlocale(locale.LC_ALL, 'C.UTF-8')
locale.setlocale(locale.LC_NUMERIC, 'fr_FR.ISO8859-1')
print(locale.localeconv())
&lt;/pre&gt;
&lt;p&gt;Two months later, Charalampos Stratakis reported the bug upstream: &lt;a class="reference external" href="https://bugs.python.org/issue31900"&gt;bpo-31900&lt;/a&gt;.  The problem arises when &lt;strong&gt;the
LC_NUMERIC locale uses a different encoding than the LC_CTYPE encoding&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;The bug was already known:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2015-12-05: Serhiy Storchaka reported &lt;a class="reference external" href="https://bugs.python.org/issue25812"&gt;bpo-25812&lt;/a&gt; with uk_UA locale&lt;/li&gt;
&lt;li&gt;2016-11-03: Guillaume Pasquet reported &lt;a class="reference external" href="https://bugs.python.org/issue28604"&gt;bpo-28604&lt;/a&gt; with en_GB locale&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Moreover, &lt;strong&gt;the bug was known since 2009&lt;/strong&gt;, Stefan Krah reported a very similar
bug: &lt;a class="reference external" href="https://bugs.python.org/issue7442"&gt;bpo-7442&lt;/a&gt;. I was even involved in
this issue in 2013, but then I forgot about it (as usual, I am working on too
many issues in parallel :-)).&lt;/p&gt;
&lt;p&gt;In 2010, PostgreSQL &lt;a class="reference external" href="https://www.postgresql.org/message-id/20100422015552.4B7E07541D0&amp;#64;cvs.postgresql.org"&gt;had the same issue&lt;/a&gt;
and &lt;a class="reference external" href="https://anoncvs.postgresql.org/cvsweb.cgi/pgsql/src/backend/utils/adt/pg_locale.c?r1=1.53&amp;amp;r2=1.54"&gt;fixed the bug by changing temporarily the LC_CTYPE locale to the
LC_NUMERIC locale&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In January 2018, I came back to this 9 years old bug. I was fixing bugs in the
implementation of my &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0540/"&gt;PEP 540 &amp;quot;Add a new UTF-8 Mode&amp;quot;&lt;/a&gt;. I pushed a large change to fix
locale encodings in &lt;a class="reference external" href="https://bugs.python.org/issue29240"&gt;bpo-29240&lt;/a&gt;, &lt;a class="reference external" href="https://github.com/python/cpython/commit/7ed7aead9503102d2ed316175f198104e0cd674c"&gt;commit
7ed7aead&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 7ed7aead9503102d2ed316175f198104e0cd674c
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Mon Jan 15 10:45:49 2018 +0100

    bpo-29240: Fix locale encodings in UTF-8 Mode (#5170)

    Modify locale.localeconv(), time.tzname, os.strerror() and other
    functions to ignore the UTF-8 Mode: always use the current locale
    encoding.

    Changes: (...)
&lt;/pre&gt;
&lt;p&gt;Stefan Krah asked:&lt;/p&gt;
&lt;blockquote&gt;
I have the exact same questions as Marc-Andre.  This is one of the reasons
why I blocked the _decimal change.  I don't fully understand the role of the
new glibc, since #7442 has existed for ages -- and &lt;strong&gt;it is a open question
whether it is a bug or not&lt;/strong&gt;.&lt;/blockquote&gt;
&lt;p&gt;I replied:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Past 10 years, I repeated to every single user I met that &amp;quot;Python 3 is
right, your system setup is wrong&amp;quot;. But that's a waste of time. People
continue to associate Python3 and Unicode to annoying bugs, because they
don't understand how locales work.&lt;/p&gt;
&lt;p&gt;Instead of having to repeat to each user that &amp;quot;hum, maybe your config is
wrong&amp;quot;, &lt;strong&gt;I prefer to support this non convential setup and work as expected
(&amp;quot;it just works&amp;quot;)&lt;/strong&gt;. With my latest implementation, setlocale() is only done
when LC_CTYPE and LC_NUMERIC are different, which is the corner case which
&amp;quot;shouldn't occur in practice&amp;quot;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Marc-Andre Lemburg added:&lt;/p&gt;
&lt;blockquote&gt;
Sounds like a good compromise :-)&lt;/blockquote&gt;
&lt;p&gt;After doing more tests on FreeBSD, Linux and macOS, I pushed &lt;a class="reference external" href="https://github.com/python/cpython/commit/cb064fc2321ce8673fe365e9ef60445a27657f54"&gt;commit cb064fc2&lt;/a&gt;
to fix &lt;a class="reference external" href="https://bugs.python.org/issue31900"&gt;bpo-31900&lt;/a&gt; by changing
temporarily the LC_CTYPE locale to the LC_NUMERIC locale:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit cb064fc2321ce8673fe365e9ef60445a27657f54
Author: Victor Stinner &amp;lt;victor.stinner&amp;#64;gmail.com&amp;gt;
Date:   Mon Jan 15 15:58:02 2018 +0100

    bpo-31900: Fix localeconv() encoding for LC_NUMERIC (#4174)

    * Add _Py_GetLocaleconvNumeric() function: decode decimal_point and
      thousands_sep fields of localeconv() from the LC_NUMERIC encoding,
      rather than decoding from the LC_CTYPE encoding.
    * Modify locale.localeconv() and &amp;quot;n&amp;quot; formatter of str.format() (for
      int, float and complex to use _Py_GetLocaleconvNumeric()
      internally.
&lt;/pre&gt;
&lt;p&gt;I dislike my own fix because changing temporarily the LC_CTYPE locale impacts
all threads, not only the current thread. But we failed to find another
solution. &lt;strong&gt;The LC_CTYPE locale is only changed if the LC_NUMERIC locale is
different than the LC_CTYPE locale and if the decimal point or the thousands
separator is non-ASCII.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Note: I proposed a change to fix the same bug in the &lt;tt class="docutils literal"&gt;decimal&lt;/tt&gt; module: &lt;a class="reference external" href="https://github.com/python/cpython/pull/5191"&gt;PR
#5191&lt;/a&gt;, but I abandonned my
patch.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="lc-monetary-encoding-different-than-lc-ctype-encoding"&gt;
&lt;h2&gt;LC_MONETARY encoding different than LC_CTYPE encoding&lt;/h2&gt;
&lt;p&gt;Fixing &lt;a class="reference external" href="https://bugs.python.org/issue31900"&gt;bpo-31900&lt;/a&gt; drained all my
energy, but sadly... there was a similar bug with LC_MONETARY!&lt;/p&gt;
&lt;p&gt;At 2016-11-03, Guillaume Pasquet reported &lt;a class="reference external" href="https://bugs.python.org/issue28604"&gt;bpo-28604: Exception raised by
python3.5 when using en_GB locale&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The fix is similar to the LC_NUMERIC fix: change temporarily the LC_CTYPE
locale to the LC_MONETARY locale, &lt;a class="reference external" href="https://github.com/python/cpython/commit/02e6bf7f2025cddcbde6432f6b6396198ab313f4"&gt;commit 02e6bf7f&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 02e6bf7f2025cddcbde6432f6b6396198ab313f4
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Tue Nov 20 16:20:16 2018 +0100

    bpo-28604: Fix localeconv() for different LC_MONETARY (GH-10606)

    locale.localeconv() now sets temporarily the LC_CTYPE locale to the
    LC_MONETARY locale if the two locales are different and monetary
    strings are non-ASCII. This temporary change affects other threads.

    Changes:

    * locale.localeconv() can now set LC_CTYPE to LC_MONETARY to decode
      monetary fields.
    * (...)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="tests-non-ascii-locales"&gt;
&lt;h2&gt;Tests non-ASCII locales&lt;/h2&gt;
&lt;p&gt;To test my bugfixes, I used manual tests. The first issue was to identify
locales with problematic characters: non-ASCII decimal point or thousands
separator for example. I wrote my own &amp;quot;test suite&amp;quot; for Windows, Linux, macOS
and FreeBSD on my website: &lt;a class="reference external" href="https://vstinner.readthedocs.io/unicode.html#test-non-ascii-characters-with-locales"&gt;Test non-ASCII characters with locales&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Example with localeconv() on Fedora 27:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="15%" /&gt;
&lt;col width="8%" /&gt;
&lt;col width="16%" /&gt;
&lt;col width="25%" /&gt;
&lt;col width="36%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;LC_ALL locale&lt;/th&gt;
&lt;th class="head"&gt;Encoding&lt;/th&gt;
&lt;th class="head"&gt;Field&lt;/th&gt;
&lt;th class="head"&gt;Bytes&lt;/th&gt;
&lt;th class="head"&gt;Text&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;es_MX.utf8&lt;/td&gt;
&lt;td&gt;UTF-8&lt;/td&gt;
&lt;td&gt;thousands_sep&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;0xE2 0x80 0x89&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;U+2009&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;fr_FR.UTF-8&lt;/td&gt;
&lt;td&gt;UTF-8&lt;/td&gt;
&lt;td&gt;currency_symbol&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;0xE2 0x82 0xAC&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;U+20AC (€)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;ps_AF.utf8&lt;/td&gt;
&lt;td&gt;UTF-8&lt;/td&gt;
&lt;td&gt;thousands_sep&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;0xD9 0xAC&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;U+066C (٬)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;uk_UA.koi8u&lt;/td&gt;
&lt;td&gt;KOI8-U&lt;/td&gt;
&lt;td&gt;currency_symbol&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;0xC7 0xD2 0xCE 0x2E&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;U+0433 U+0440 U+043d U+002E (грн.)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;uk_UA.koi8u&lt;/td&gt;
&lt;td&gt;KOI8-U&lt;/td&gt;
&lt;td&gt;thousands_sep&lt;/td&gt;
&lt;td&gt;&lt;tt class="docutils literal"&gt;0x9A&lt;/tt&gt;&lt;/td&gt;
&lt;td&gt;U+00A0&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Manual tests became more and more complex, since there are so many cases: each
operating system use different locale names and the result depends on the libc
version. After months of manual tests, I wrote my small personal &lt;strong&gt;portable&lt;/strong&gt;
locale test suite: &lt;a class="reference external" href="https://github.com/vstinner/misc/blob/master/python/test_all_locales.py"&gt;test_all_locales.py&lt;/a&gt;.
It supports:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;FreeBSD 11&lt;/li&gt;
&lt;li&gt;macOS&lt;/li&gt;
&lt;li&gt;Fedora (Linux)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def test_zh_TW_Big5(self):
    loc = &amp;quot;zh_TW.Big5&amp;quot; if BSD else &amp;quot;zh_TW.big5&amp;quot;
    if FREEBSD:
        currency_symbol = u'\uff2e\uff34\uff04'
        decimal_point = u'\uff0e'
        thousands_sep = u'\uff0c'
        date_str = u'\u661f\u671f\u56db 2\u6708'
    else:
        currency_symbol = u'NT$'
        decimal_point = u'.'
        thousands_sep = u','
        if MACOS:
            date_str =  u'\u9031\u56db 2\u6708'
        else:
            date_str = u'\u9031\u56db \u4e8c\u6708'

    self.set_locale(loc, &amp;quot;Big5&amp;quot;)

    lc = locale.localeconv()
    self.assertLocaleEqual(lc['currency_symbol'], currency_symbol)
    self.assertLocaleEqual(lc['decimal_point'], decimal_point)
    self.assertLocaleEqual(lc['thousands_sep'], thousands_sep)

    self.assertLocaleEqual(time.strftime('%A %B', FEBRUARY), date_str)
&lt;/pre&gt;
&lt;p&gt;The best would be to integrate directly these tests into the Python test suite,
but it's not portable nor future-proof, since most constants are hardcoded and
depends on the operating sytem and the libc version.&lt;/p&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="unicode"></category><category term="locales"></category></entry><entry><title>Python 3, locales and encodings</title><link href="https://vstinner.github.io/python3-locales-encodings.html" rel="alternate"></link><published>2018-09-06T16:00:00+02:00</published><updated>2018-09-06T16:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-09-06:/python3-locales-encodings.html</id><summary type="html">&lt;img alt="I □ Unicode" src="https://vstinner.github.io/images/i-square-unicode.jpg" /&gt;
&lt;p&gt;Recently, I worked on a change which looked simple: move the code to initialize
the &lt;tt class="docutils literal"&gt;sys.stdout&lt;/tt&gt; encoding before &lt;tt class="docutils literal"&gt;Py_Initialize()&lt;/tt&gt;. While I was on it,
I also decided to move the code which selects the Python &amp;quot;filesystem encoding&amp;quot;.
I didn't expect that I would spend 2 weeks on these issues …&lt;/p&gt;</summary><content type="html">&lt;img alt="I □ Unicode" src="https://vstinner.github.io/images/i-square-unicode.jpg" /&gt;
&lt;p&gt;Recently, I worked on a change which looked simple: move the code to initialize
the &lt;tt class="docutils literal"&gt;sys.stdout&lt;/tt&gt; encoding before &lt;tt class="docutils literal"&gt;Py_Initialize()&lt;/tt&gt;. While I was on it,
I also decided to move the code which selects the Python &amp;quot;filesystem encoding&amp;quot;.
I didn't expect that I would spend 2 weeks on these issues... This article
tells me about my recent journey in locales and encodings on AIX, HP-UX,
Windows, Linux, macOS, Solaris and FreeBSD.&lt;/p&gt;
&lt;p&gt;Table of Contents:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Lying HP-UX&lt;/li&gt;
&lt;li&gt;Standard streams and filesystem encodings&lt;/li&gt;
&lt;li&gt;POSIX locale on FreeBSD&lt;/li&gt;
&lt;li&gt;C locale on Windows&lt;/li&gt;
&lt;li&gt;Back to stdio encoding&lt;/li&gt;
&lt;li&gt;Back to filesystem encoding&lt;/li&gt;
&lt;li&gt;Use surrogatepass on Windows&lt;/li&gt;
&lt;li&gt;Filesystem encoding documentation&lt;/li&gt;
&lt;li&gt;Final FreeBSD 10 issue&lt;/li&gt;
&lt;li&gt;Configuration of locales and encodings&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="lying-hp-ux"&gt;
&lt;h2&gt;Lying HP-UX&lt;/h2&gt;
&lt;p&gt;At 2018-08-14, Michael Osipov reported &lt;a class="reference external" href="https://bugs.python.org/issue34403"&gt;bpo-34403&lt;/a&gt;:
&amp;quot;test_utf8_mode.test_cmd_line() fails on HP-UX due to false assumptions&amp;quot;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
======================================================================
FAIL: test_cmd_line (test.test_utf8_mode.UTF8ModeTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  (...)
AssertionError: &amp;quot;['h\\xc3\\xa9\\xe2\\x82\\xac']&amp;quot; != &amp;quot;['h\\udcc3\\udca9\\udce2\\udc82\\udcac']&amp;quot;
- ['h\xc3\xa9\xe2\x82\xac']
+ ['h\udcc3\udca9\udce2\udc82\udcac']
 : roman8:['h\xc3\xa9\xe2\x82\xac']
&lt;/pre&gt;
&lt;p&gt;Interesting, HP-UX uses &amp;quot;roman8&amp;quot; as its locale encoding. What is this &amp;quot;new&amp;quot;
encoding? Wikipedia: &lt;a class="reference external" href="https://en.wikipedia.org/wiki/HP_Roman#Roman-8"&gt;HP Roman-8&lt;/a&gt;. Oh, that's even older than
the common ISO 8859 encodings like Latin1!&lt;/p&gt;
&lt;p&gt;Michael Felt was working on a similar test_utf8_mode failure on AIX, so they
tried to debug the issue together, but failed to understand the issue. Osipov
proposed to give up and just skip the test on HP-UX...&lt;/p&gt;
&lt;p&gt;I showed up and proposed a fix for the unit test: &lt;a class="reference external" href="https://github.com/python/cpython/pull/8967/files"&gt;PR 8967&lt;/a&gt;. The test was hardcoding
the expected locale encoding. I modified the test to query the locale encoding
at runtime instead.&lt;/p&gt;
&lt;p&gt;Bad surprise, the test still fails, oh. &lt;a class="reference external" href="https://bugs.python.org/issue34403#msg324219"&gt;I commented&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Hum, it looks like a bug in the C library of HP-UX.&lt;/blockquote&gt;
&lt;p&gt;I wrote a C program calling mbstowcs() to check what is the actual encoding
used by the C library: &lt;a class="reference external" href="https://bugs.python.org/file47767/c_locale.c"&gt;c_locale.c&lt;/a&gt;. &lt;a class="reference external" href="https://bugs.python.org/issue34403#msg324225"&gt;Result&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Well, it confirms what I expected: &lt;tt class="docutils literal"&gt;nl_langinfo(CODESET)&lt;/tt&gt; announces
&lt;tt class="docutils literal"&gt;&amp;quot;roman8&amp;quot;&lt;/tt&gt;, but &lt;tt class="docutils literal"&gt;mbstowcs()&lt;/tt&gt; uses Latin1 encoding in practice.&lt;/blockquote&gt;
&lt;p&gt;So I wrote a workaround similar to the one used on FreeBSD and Solaris: check
if the libc is announcing an encoding different than the real encoding, and if
it's the case: force the usage of the ASCII encoding in Python. See
my &lt;a class="reference external" href="https://github.com/python/cpython/commit/d500e5307aec9c5d535f66d567fadb9c587a9a36"&gt;commit d500e530&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Tue Aug 28 17:27:36 2018 +0200

    bpo-34403: On HP-UX, force ASCII for C locale (GH-8969)

    On HP-UX with C or POSIX locale, sys.getfilesystemencoding() now returns
    &amp;quot;ascii&amp;quot; instead of &amp;quot;roman8&amp;quot; (when the UTF-8 Mode is disabled and the C locale
    is not coerced).

    nl_langinfo(CODESET) announces &amp;quot;roman8&amp;quot; whereas it uses the Latin1
    encoding in practice.
&lt;/pre&gt;
&lt;p&gt;Extract of the heuristic code:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if (strcmp(encoding, &amp;quot;roman8&amp;quot;) == 0) {
    unsigned char ch = (unsigned char)0xA7;
    wchar_t wch;
    size_t res = mbstowcs(&amp;amp;wch, (char*)&amp;amp;ch, 1);
    if (res != (size_t)-1 &amp;amp;&amp;amp; wch == L'\xA7') {
        /* On HP-UX withe C locale or the POSIX locale,
           nl_langinfo(CODESET) announces &amp;quot;roman8&amp;quot;,
           whereas mbstowcs() uses Latin1 encoding in practice.
           Force ASCII in this case.  Roman8 decodes 0xA7
           to U+00CF. Latin1 decodes 0xA7 to U+00A7. */
        return 1;
    }
}
&lt;/pre&gt;
&lt;p&gt;Python 3.8 will handle better Unicode support on HP-UX. The test_utf8_mode
failure was just a hint for a real underlying bug!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="standard-streams-and-filesystem-encodings"&gt;
&lt;h2&gt;Standard streams and filesystem encodings&lt;/h2&gt;
&lt;p&gt;While reworking the Python initialization, I tried to move &lt;strong&gt;all&lt;/strong&gt;
configuration parameters to a new &lt;tt class="docutils literal"&gt;_PyCoreConfig&lt;/tt&gt; structure. But I know that
I missed at least the standard streams encoding (ex: &lt;tt class="docutils literal"&gt;sys.stdout.encoding&lt;/tt&gt;).
My first attempt failed to move the code, it broke many tests. I created
&lt;a class="reference external" href="https://bugs.python.org/issue34485"&gt;bpo-34485&lt;/a&gt;: &amp;quot;_PyCoreConfig: add
stdio_encoding and stdio_errors&amp;quot;.&lt;/p&gt;
&lt;p&gt;While I was working on stdio encoding, I also recalled that the Python
filesystem encoding is also initialized &amp;quot;late&amp;quot;. I also created &lt;a class="reference external" href="https://bugs.python.org/issue34523"&gt;bpo-34523&lt;/a&gt;: &amp;quot;Choose the filesystem encoding before
Python initialization (add _PyCoreConfig.filesystem_encoding)&amp;quot; to move this
code as well.&lt;/p&gt;
&lt;p&gt;I quickly had an implementation, but it didn't go as well as expected...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="posix-locale-on-freebsd"&gt;
&lt;h2&gt;POSIX locale on FreeBSD&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue34485"&gt;bpo-34485&lt;/a&gt;: For me, the &amp;quot;C&amp;quot; and &amp;quot;POSIX&amp;quot;
locales were the same locale: C is an alias to POSIX, or the opposite, it
didn't really matter for me. But Python handles them differently in some corner
cases. For example, Nick Coghlan's PEP 538 (C locale coercion) is only enabled
if the LC_CTYPE locale is equal to &amp;quot;C&amp;quot;, not if it's equal to &amp;quot;POSIX&amp;quot;.&lt;/p&gt;
&lt;p&gt;In Python 3.5, I changed stdin and stdout error handlers from strict to
surrogateescape if the LC_CTYPE locale is &amp;quot;C&amp;quot;: &lt;a class="reference external" href="https://bugs.python.org/issue19977"&gt;bpo-19977&lt;/a&gt;. But when I tested my
stdio and filesystem changes on Linux, FreeBSD and Windows, I noticed that
I forgot to handle the &amp;quot;POSIX&amp;quot; locale. On FreeBSD, &lt;tt class="docutils literal"&gt;LC_ALL=POSIX&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;LC_ALL=C&lt;/tt&gt;
behave differently:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;With &lt;tt class="docutils literal"&gt;LC_ALL=POSIX&lt;/tt&gt; environment, &lt;tt class="docutils literal"&gt;setlocale(LC_CTYPE, &amp;quot;&amp;quot;)&lt;/tt&gt; returns &lt;tt class="docutils literal"&gt;&amp;quot;POSIX&amp;quot;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;With &lt;tt class="docutils literal"&gt;LC_ALL=C&lt;/tt&gt; environment, &lt;tt class="docutils literal"&gt;setlocale(LC_CTYPE, &amp;quot;&amp;quot;)&lt;/tt&gt; returns &lt;tt class="docutils literal"&gt;&amp;quot;C&amp;quot;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I fixed that to also use the &amp;quot;surrogateescape&amp;quot; error handler for the POSIX
locale on FreeBSD. &lt;a class="reference external" href="https://github.com/python/cpython/commit/315877dc361d554bec34b4b62c270479ad36a1be"&gt;Commit 315877dc&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Wed Aug 29 09:58:12 2018 +0200

    bpo-34485: stdout uses surrogateescape on POSIX locale (GH-8986)

    Standard streams like sys.stdout now use the &amp;quot;surrogateescape&amp;quot; error
    handler, instead of &amp;quot;strict&amp;quot;, on the POSIX locale (when the C locale is not
    coerced and the UTF-8 Mode is disabled).

    Add tests on sys.stdout.errors with LC_ALL=POSIX.
&lt;/pre&gt;
&lt;p&gt;The most important change is just one line:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-        if (strcmp(ctype_loc, &amp;quot;C&amp;quot;) == 0) {
+        if (strcmp(ctype_loc, &amp;quot;C&amp;quot;) == 0 || strcmp(ctype_loc, &amp;quot;POSIX&amp;quot;) == 0) {
             return &amp;quot;surrogateescape&amp;quot;;
         }
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue34527"&gt;bpo-34527&lt;/a&gt;: Since I was testing
various configurations, I also noticed that my UTF-8 Mode (PEP 540) had the
same bug. Python 3.7 enables it if the LC_CTYPE locale is equal to &amp;quot;C&amp;quot;,
but not if it's equal to &amp;quot;POSIX&amp;quot;. I also changed that (&lt;a class="reference external" href="https://github.com/python/cpython/commit/5cb258950ce9b69b1f65646431c464c0c17b1510"&gt;commit 5cb25895&lt;/a&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="c-locale-on-windows"&gt;
&lt;h2&gt;C locale on Windows&lt;/h2&gt;
&lt;p&gt;While testing my changes on Windows, I noticed that Python starts with the
LC_CTYPE locale equal to &amp;quot;C&amp;quot;, whereas &lt;tt class="docutils literal"&gt;locale.setlocale(locale.LC_CTYPE, &amp;quot;&amp;quot;)&lt;/tt&gt;
changes the LC_CTYPE locale to something like &lt;tt class="docutils literal"&gt;English_United States.1252&lt;/tt&gt;
(English with the code page 1252). Example with Python 3.6:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
C:\&amp;gt; python
Python 3.6.4 (v3.6.4:d48eceb, Dec 19 2017, 06:54:40) [MSC v.1900 64 bit (AMD64)] on win32
&amp;gt;&amp;gt;&amp;gt; import locale
&amp;gt;&amp;gt;&amp;gt; locale.setlocale(locale.LC_CTYPE, None)
'C'
&amp;gt;&amp;gt;&amp;gt; locale.setlocale(locale.LC_CTYPE, &amp;quot;&amp;quot;)
'English_United States.1252'
&amp;gt;&amp;gt;&amp;gt; locale.setlocale(locale.LC_CTYPE, None)
'English_United States.1252'
&lt;/pre&gt;
&lt;p&gt;On UNIX, Python 2 starts with the default C locale, whereas Python 3 always
sets the LC_CTYPE locale to my preference. Example on Fedora 28 with
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;LANG=fr_FR.UTF-8&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python2 -c 'import locale; print(locale.setlocale(locale.LC_CTYPE, None))'
C
$ python3 -c 'import locale; print(locale.setlocale(locale.LC_CTYPE, None))'
fr_FR.UTF-8
&lt;/pre&gt;
&lt;p&gt;I modified Windows to behave as UNIX, &lt;a class="reference external" href="https://github.com/python/cpython/commit/177d921c8c03d30daa32994362023f777624b10d"&gt;commit 177d921c&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Wed Aug 29 11:25:15 2018 +0200

    bpo-34485, Windows: LC_CTYPE set to user preference (GH-8988)

    On Windows, the LC_CTYPE is now set to the user preferred locale at
    startup: _Py_SetLocaleFromEnv(LC_CTYPE) is now called during the
    Python initialization. Previously, the LC_CTYPE locale was &amp;quot;C&amp;quot; at
    startup, but changed when calling setlocale(LC_CTYPE, &amp;quot;&amp;quot;) or
    setlocale(LC_ALL, &amp;quot;&amp;quot;).

    pymain_read_conf() now also calls _Py_SetLocaleFromEnv(LC_CTYPE) to
    behave as _Py_InitializeCore(). Moreover, it doesn't save/restore the
    LC_ALL anymore.

    On Windows, standard streams like sys.stdout now always use
    surrogateescape error handler by default (ignore the locale).
&lt;/pre&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
C:\&amp;gt; python3.6 -c &amp;quot;import locale; print(locale.setlocale(locale.LC_CTYPE, None))&amp;quot;
C
C:\&amp;gt; python3.8 -c &amp;quot;import locale; print(locale.setlocale(locale.LC_CTYPE, None))&amp;quot;
English_United States.1252
&lt;/pre&gt;
&lt;p&gt;On Windows, Python 3.8 now starts with the LC_CTYPE locale set to my
preference, as it was already previously done on UNIX.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="back-to-stdio-encoding"&gt;
&lt;h2&gt;Back to stdio encoding&lt;/h2&gt;
&lt;p&gt;After all previous changes and fixes, I was able to push my &lt;a class="reference external" href="https://github.com/python/cpython/commit/dfe0dc74536dfb6f331131d9b2b49557675bb6b7"&gt;commit dfe0dc74&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Wed Aug 29 11:47:29 2018 +0200

    bpo-34485: Add _PyCoreConfig.stdio_encoding (GH-8881)

    * Add stdio_encoding and stdio_errors fields to _PyCoreConfig.
    * Add unit tests on stdio_encoding and stdio_errors.
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="back-to-filesystem-encoding"&gt;
&lt;h2&gt;Back to filesystem encoding&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/commit/b2457efc78b74a1d6d1b77d11a939e886b8a4e2c"&gt;Commit b2457efc&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Wed Aug 29 13:25:36 2018 +0200

    bpo-34523: Add _PyCoreConfig.filesystem_encoding (GH-8963)

    _PyCoreConfig_Read() is now responsible to choose the filesystem
    encoding and error handler. Using Py_Main(), the encoding is now
    chosen even before calling Py_Initialize().

    _PyCoreConfig.filesystem_encoding is now the reference, instead of
    Py_FileSystemDefaultEncoding, for the Python filesystem encoding.

    Changes:

    * Add filesystem_encoding and filesystem_errors to _PyCoreConfig
    * _PyCoreConfig_Read() now reads the locale encoding for the file
      system encoding.
    * PyUnicode_EncodeFSDefault() and PyUnicode_DecodeFSDefaultAndSize()
      now use the interpreter configuration rather than
      Py_FileSystemDefaultEncoding and Py_FileSystemDefaultEncodeErrors
      global configuration variables.
    * Add _Py_SetFileSystemEncoding() and _Py_ClearFileSystemEncoding()
      private functions to only modify Py_FileSystemDefaultEncoding and
      Py_FileSystemDefaultEncodeErrors in coreconfig.c.
    * _Py_CoerceLegacyLocale() now takes an int rather than
      _PyCoreConfig for the warning.
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="use-surrogatepass-on-windows"&gt;
&lt;h2&gt;Use surrogatepass on Windows&lt;/h2&gt;
&lt;p&gt;While working on the filesystem encoding change, I had a bug in
_freeze_importlib.exe which failed at startup:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ValueError: only 'strict' and 'surrogateescape' error handlers are supported, not 'surrogatepass'
&lt;/pre&gt;
&lt;p&gt;I used the following workaround in &lt;tt class="docutils literal"&gt;_freeze_importlib.c&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#ifdef MS_WINDOWS
    /* bpo-34523: initfsencoding() is not called if _install_importlib=0,
       so interp-&amp;gt;fscodec_initialized value remains 0.
       PyUnicode_EncodeFSDefault() doesn't support the &amp;quot;surrogatepass&amp;quot; error
       handler in such case, whereas it's the default error handler on Windows.
       Force the &amp;quot;strict&amp;quot; error handler to work around this bootstrap issue. */
    config.filesystem_errors = &amp;quot;strict&amp;quot;;
#endif
&lt;/pre&gt;
&lt;p&gt;But I wasn't fully happy with the workaround. When running more manual tests, I
found that the &lt;tt class="docutils literal"&gt;PYTHONLEGACYWINDOWSFSENCODING&lt;/tt&gt; environment variable wasn't
handled properly. I pushed a first fix,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/c5989cd87659acbfd4d19dc00dbe99c3a0fc9bd2"&gt;commit c5989cd8&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Wed Aug 29 19:32:47 2018 +0200

    bpo-34523: Py_DecodeLocale() use UTF-8 on Windows (GH-8998)

    Py_DecodeLocale() and Py_EncodeLocale() now use the UTF-8 encoding on
    Windows if Py_LegacyWindowsFSEncodingFlag is zero.

    pymain_read_conf() now sets Py_LegacyWindowsFSEncodingFlag in its
    loop, but restore its value at exit.
&lt;/pre&gt;
&lt;p&gt;My intent was to be able to use the &lt;tt class="docutils literal"&gt;surrogatepass&lt;/tt&gt; error handler. If
&lt;tt class="docutils literal"&gt;Py_DecodeLocale()&lt;/tt&gt; is hardcoded to use UTF-8 on Windows, we should get
access to the &lt;tt class="docutils literal"&gt;surrogatepass&lt;/tt&gt; error handler. Previously, &lt;tt class="docutils literal"&gt;mbstowcs()&lt;/tt&gt;
function was used and this function only support &lt;tt class="docutils literal"&gt;strict&lt;/tt&gt; or
&lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handlers.&lt;/p&gt;
&lt;p&gt;I pushed a second big change to add support for the &lt;tt class="docutils literal"&gt;surrogatepass&lt;/tt&gt; error
handler in locale codecs, &lt;a class="reference external" href="https://github.com/python/cpython/commit/3d4226a832cabc630402589cc671cc4035d504e5"&gt;commit 3d4226a8&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Wed Aug 29 22:21:32 2018 +0200

    bpo-34523: Support surrogatepass in locale codecs (GH-8995)

    Add support for the &amp;quot;surrogatepass&amp;quot; error handler in
    PyUnicode_DecodeFSDefault() and PyUnicode_EncodeFSDefault()
    for the UTF-8 encoding.

    Changes:

    * _Py_DecodeUTF8Ex() and _Py_EncodeUTF8Ex() now support the
      surrogatepass error handler (_Py_ERROR_SURROGATEPASS).
    * _Py_DecodeLocaleEx() and _Py_EncodeLocaleEx() now use
      the _Py_error_handler enum instead of &amp;quot;int surrogateescape&amp;quot; to pass
      the error handler. These functions now return -3 if the error
      handler is unknown.
    * Add unit tests on _Py_DecodeLocaleEx() and _Py_EncodeLocaleEx()
      in test_codecs.
    * Rename get_error_handler() to _Py_GetErrorHandler() and expose it
      as a private function.
    * _freeze_importlib doesn't need config.filesystem_errors=&amp;quot;strict&amp;quot;
      workaround anymore.
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;PyUnicode_DecodeFSDefault()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;PyUnicode_EncodeFSDefault()&lt;/tt&gt; functions
use &lt;tt class="docutils literal"&gt;Py_DecodeLocale()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;Py_EncodeLocale()&lt;/tt&gt; before the Python codec of
the filesystem encoding is loaded. With this big change, &lt;tt class="docutils literal"&gt;Py_DecodeLocale()&lt;/tt&gt;
and &lt;tt class="docutils literal"&gt;Py_EncodeLocale()&lt;/tt&gt; now really behave as the Python codec.&lt;/p&gt;
&lt;p&gt;Previously, Python started with the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler, and
switched to the &lt;tt class="docutils literal"&gt;surrogatepass&lt;/tt&gt; error handler once the Python codec was
loaded.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="filesystem-encoding-documentation"&gt;
&lt;h2&gt;Filesystem encoding documentation&lt;/h2&gt;
&lt;p&gt;One &amp;quot;last&amp;quot; change, I documented how Python selects the filesystem encoding,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/de427556746aa41a8b5198924ce423021bc0c718"&gt;commit de427556&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Wed Aug 29 23:26:55 2018 +0200

    bpo-34523: Py_FileSystemDefaultEncoding NULL by default (GH-9003)

    * Py_FileSystemDefaultEncoding and Py_FileSystemDefaultEncodeErrors
      default value is now NULL: initfsencoding() set them
      during Python initialization.
    * Document how Python chooses the filesystem encoding and error
      handler.
    * Add an assertion to _PyCoreConfig_Read().
&lt;/pre&gt;
&lt;p&gt;Documentation:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/* Python filesystem encoding and error handler:
   sys.getfilesystemencoding() and sys.getfilesystemencodeerrors().

   Default encoding and error handler:

   * if Py_SetStandardStreamEncoding() has been called: they have the
     highest priority;
   * PYTHONIOENCODING environment variable;
   * The UTF-8 Mode uses UTF-8/surrogateescape;
   * locale encoding: ANSI code page on Windows, UTF-8 on Android,
     LC_CTYPE locale encoding on other platforms;
   * On Windows, &amp;quot;surrogateescape&amp;quot; error handler;
   * &amp;quot;surrogateescape&amp;quot; error handler if the LC_CTYPE locale is &amp;quot;C&amp;quot; or &amp;quot;POSIX&amp;quot;;
   * &amp;quot;surrogateescape&amp;quot; error handler if the LC_CTYPE locale has been coerced
     (PEP 538);
   * &amp;quot;strict&amp;quot; error handler.

   Supported error handlers: &amp;quot;strict&amp;quot;, &amp;quot;surrogateescape&amp;quot; and
   &amp;quot;surrogatepass&amp;quot;. The surrogatepass error handler is only supported
   if Py_DecodeLocale() and Py_EncodeLocale() use directly the UTF-8 codec;
   it's only used on Windows.

   initfsencoding() updates the encoding to the Python codec name.
   For example, &amp;quot;ANSI_X3.4-1968&amp;quot; is replaced with &amp;quot;ascii&amp;quot;.

   On Windows, sys._enablelegacywindowsfsencoding() sets the
   encoding/errors to mbcs/replace at runtime.


   See Py_FileSystemDefaultEncoding and Py_FileSystemDefaultEncodeErrors.
   */
char *filesystem_encoding;
char *filesystem_errors;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="final-freebsd-10-issue"&gt;
&lt;h2&gt;Final FreeBSD 10 issue&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue34544"&gt;bpo-34544&lt;/a&gt;: The stdio and filesystem
encodings are now properly selected before Py_Initialize(), the LC_CTYPE locale
should be properly initialized, the &amp;quot;POSIX&amp;quot; locale is now properly handled, but
the FreeBSD 10 buildbot still complained about my recent changes... Many
&lt;tt class="docutils literal"&gt;test_c_locale_coerce&lt;/tt&gt; tests started to fail with:&lt;/p&gt;
&lt;blockquote&gt;
Fatal Python error: get_locale_encoding: failed to get the locale encoding: nl_langinfo(CODESET) failed&lt;/blockquote&gt;
&lt;p&gt;Sadly, I wasn't able to reproduce the issue on my FreeBSD 11 VM. I also got
access to the FreeBSD CURRENT buildbot, but I also failed to reproduce the bug
there. I was supposed to get access to the FreeBSD 10 buildbot, but there was a
DNS issue.&lt;/p&gt;
&lt;p&gt;I had to &lt;em&gt;guess&lt;/em&gt; the origin of the bug and I attempted a fix, &lt;a class="reference external" href="https://github.com/python/cpython/commit/f01b2a1b84ee08df73a78cf1017eecf15e3cb995"&gt;commit f01b2a1b&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Mon Sep 3 14:38:21 2018 +0200

    bpo-34544: Fix setlocale() in pymain_read_conf() (GH-9041)

    bpo-34485, bpo-34544: On some FreeBSD, nl_langinfo(CODESET) fails if
    LC_ALL or LC_CTYPE is set to an invalid locale name. Replace
    _Py_SetLocaleFromEnv(LC_CTYPE) with _Py_SetLocaleFromEnv(LC_ALL) to
    initialize properly locales.

    Partially revert commit 177d921c8c03d30daa32994362023f777624b10d.
&lt;/pre&gt;
&lt;p&gt;... but it didn't work.&lt;/p&gt;
&lt;p&gt;I decided to install a FreeBSD 10 VM and one week later... I finally succeded
to reproduce the issue!&lt;/p&gt;
&lt;p&gt;The bug was that the &lt;tt class="docutils literal"&gt;_Py_CoerceLegacyLocale()&lt;/tt&gt; function doesn't restore the
LC_CTYPE to its previous value if it attempted to coerce the LC_CTYPE locale
but no locale worked.&lt;/p&gt;
&lt;p&gt;Previously, it didn't matter, since the LC_CTYPE locale was initialized again
later, or it was saved/restored indirectly. But with my latest changes, the
LC_CTYPE was left unchanged.&lt;/p&gt;
&lt;p&gt;The fix is just to restore LC_CTYPE if &lt;tt class="docutils literal"&gt;_Py_CoerceLegacyLocale()&lt;/tt&gt; fails,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/8ea09110d413829f71d979d8c7073008cb87fb03"&gt;commit 8ea09110&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Author: Victor Stinner &amp;lt;vstinner&amp;#64;redhat.com&amp;gt;
Date:   Mon Sep 3 17:05:18 2018 +0200

    _Py_CoerceLegacyLocale() restores LC_CTYPE on fail (GH-9044)

    bpo-34544: If _Py_CoerceLegacyLocale() fails to coerce the C locale,
    restore the LC_CTYPE locale to the its previous value.
&lt;/pre&gt;
&lt;p&gt;Finally, I succeded to do what I wanted to do initially, remove the code which
saved/restored the LC_ALL locale: &lt;tt class="docutils literal"&gt;pymain_read_conf()&lt;/tt&gt; is now really
responsible to set the LC_CTYPE locale, and it doesn't modify the LC_ALL locale
anymore.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration-of-locales-and-encodings"&gt;
&lt;h2&gt;Configuration of locales and encodings&lt;/h2&gt;
&lt;p&gt;Python has &lt;strong&gt;many&lt;/strong&gt; options to configure the locales and encodings.&lt;/p&gt;
&lt;p&gt;Main options of Python 3.7:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Legacy Windows stdio (PEP 528)&lt;/li&gt;
&lt;li&gt;Legacy Windows filesystem encoding (PEP 529)&lt;/li&gt;
&lt;li&gt;C locale coercion (PEP 538)&lt;/li&gt;
&lt;li&gt;UTF-8 mode (PEP 540)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The combination of C locale coercion and UTF-8 mode is non-obvious and should
be carefully tested!&lt;/p&gt;
&lt;p&gt;Environment variables:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PYTHONCOERCECLOCALE=0&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PYTHONCOERCECLOCALE=1&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PYTHONCOERCECLOCALE=warn&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;PYTHONIOENCODING=:&amp;lt;errors&amp;gt;&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;PYTHONIOENCODING=&amp;lt;encoding&amp;gt;:&amp;lt;errors&amp;gt;&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;PYTHONIOENCODING=&amp;lt;encoding&amp;gt;&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PYTHONLEGACYWINDOWSFSENCODING=1&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PYTHONLEGACYWINDOWSSTDIO=1&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PYTHONUTF8=0&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PYTHONUTF8=1&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Command line options:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8=0&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8=1&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-E&lt;/span&gt;&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-I&lt;/span&gt;&lt;/tt&gt; (ignore &lt;tt class="docutils literal"&gt;PYTHON*&lt;/tt&gt; environment variables)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Global configuration variables:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_FileSystemDefaultEncodeErrors&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_FileSystemDefaultEncoding&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_LegacyWindowsFSEncodingFlag&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_LegacyWindowsStdioFlag&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_UTF8Mode&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;_PyCoreConfig:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;coerce_c_locale&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;coerce_c_locale_warn&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;filesystem_encoding&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;filesystem_errors&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;stdio_encoding&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;stdio_errors&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The LC_CTYPE locale depends on 3 environment variables:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;LC_ALL&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;LC_CTYPE&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;LANG&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Depending on the platform, the following configuration gives a different
LC_CTYPE locale:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;LC_ALL= LC_CTYPE= LANG=&lt;/tt&gt; (no variable set)&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;LC_ALL= LC_CTYPE=C LANG=&lt;/tt&gt; (C locale)&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;LC_ALL= LC_CTYPE=POSIX LANG=&lt;/tt&gt; (POSIX locale)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In case of doubt, I also tested:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;LC_ALL=C LC_CTYPE= LANG=&lt;/tt&gt; (C locale)&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;LC_ALL=POSIX LC_CTYPE= LANG=&lt;/tt&gt; (POSIX locale)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The LC_CTYPE encoding (locale encoding) can be queried using
&lt;tt class="docutils literal"&gt;nl_langinfo(CODESET)&lt;/tt&gt;. On FreeBSD, Solaris, HP-UX and maybe other platforms,
&lt;tt class="docutils literal"&gt;nl_langinfo(CODESET)&lt;/tt&gt; announces an encoding which is different than the
codec used by &lt;tt class="docutils literal"&gt;mbstowcs()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;wcstombs()&lt;/tt&gt; functions, and so Python forces
the usage of the ASCII encoding.&lt;/p&gt;
&lt;p&gt;The test matrix of all these configurations and all platforms is quite big.
Honestly, I would not bet that Python 3.8 will behave properly in all possible
cases. At least, I tried to fix all issues that I spotted! Moreover, I added
many tests which should help to detect bugs and prevent regressions.&lt;/p&gt;
&lt;/div&gt;
</content><category term="cpython"></category><category term="unicode"></category><category term="locales"></category></entry><entry><title>Python 3.7 UTF-8 Mode</title><link href="https://vstinner.github.io/python37-new-utf8-mode.html" rel="alternate"></link><published>2018-03-27T20:00:00+02:00</published><updated>2018-03-27T20:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-27:/python37-new-utf8-mode.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/99444752&amp;#64;N06/9368903367/"&gt;&lt;img alt="Sunrise" src="https://vstinner.github.io/images/sunrise.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Since Python 3.0 was released in 2008, each time an user reported an encoding
issue, someone showed up and asked why Python does not &amp;quot;simply&amp;quot; always use UTF-8.
Well, it's not that easy. &lt;strong&gt;UTF-8 is the best encoding in most cases, but it is
still not the best encoding …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/99444752&amp;#64;N06/9368903367/"&gt;&lt;img alt="Sunrise" src="https://vstinner.github.io/images/sunrise.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Since Python 3.0 was released in 2008, each time an user reported an encoding
issue, someone showed up and asked why Python does not &amp;quot;simply&amp;quot; always use UTF-8.
Well, it's not that easy. &lt;strong&gt;UTF-8 is the best encoding in most cases, but it is
still not the best encoding in all cases&lt;/strong&gt;, even in 2018. The locale encoding
remains the best default filesystem encoding for Python. I would say that &lt;strong&gt;the
locale encoding is the least bad filesystem encoding&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This article tells the story of my &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0540/"&gt;PEP 540: Add a new UTF-8 Mode&lt;/a&gt; which adds an opt-in option to
&lt;strong&gt;&amp;quot;use UTF-8&amp;quot; everywhere&amp;quot;&lt;/strong&gt;. Moreover, the UTF-8 Mode is enabled by the POSIX
locale: &lt;strong&gt;Python 3.7 now uses UTF-8 for the POSIX locale&lt;/strong&gt;. My
PEP 540 is complementary to Nick Coghlan's PEP 538.&lt;/p&gt;
&lt;p&gt;When I started to write this article, I wrote something like: &amp;quot;Hey! I added a
new option to use UTF-8, enjoy!&amp;quot;. Written like that, it seems like using UTF-8
was an obvious choice and that it was really easy to write such PEP. No.
&lt;strong&gt;Nothing was obvious, nothing was simple.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;It took me one year to design and implement my PEP 540, and to get it accepted.
I wrote five articles before this one to show that the PEP 540 only came after
a long painful journey, starting with Python 3.0, to choose the best Python
encoding.  My PEP rely on the all the great work done previously.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This article is the sixth and last in a series of articles telling the
history and rationale of the Python 3 Unicode model for the operating system:&lt;/strong&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;ol class="first arabic"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html"&gt;Python 3.0 listdir() Bug on Undecodable Filenames&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="2"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/pep-383.html"&gt;Python 3.1 surrogateescape error handler (PEP 383)&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="3"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html"&gt;Python 3.2 Painful History of the Filesystem Encoding&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="4"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html"&gt;Python 3.6 now uses UTF-8 on Windows&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="5"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/posix-locale.html"&gt;Python 3.7 and the POSIX locale&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="6"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html"&gt;Python 3.7 UTF-8 Mode&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="fallback-to-utf-8-if-getting-the-locale-encoding-fails"&gt;
&lt;h2&gt;Fallback to UTF-8 if getting the locale encoding fails?&lt;/h2&gt;
&lt;p&gt;May 2010, I reported &lt;a class="reference external" href="https://bugs.python.org/issue8610"&gt;bpo-8610&lt;/a&gt;:
&amp;quot;Python3/POSIX:  errors if file system encoding is None&amp;quot;. I asked what should
be the default encoding when getting the locale encoding fails. I proposed
to fallback to UTF-8. &lt;a class="reference external" href="https://bugs.python.org/issue8610#msg105008"&gt;I wrote&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;UTF-8 is also an optimist choice&lt;/strong&gt;: I bet that more and more operating
systems will move to UTF-8.&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8610#msg105010"&gt;Marc-Andre commented&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Ouch, that was a poor choice. &lt;strong&gt;In Python we have a tradition to avoid
guessing&lt;/strong&gt;, if possible. Since we cannot guarantee that the file system
will indeed use UTF-8, it would have been safer to use ASCII. Not sure why
this reasoning wasn't applied for the file system encoding.&lt;/blockquote&gt;
&lt;p&gt;In practice, Python already used UTF-8 when the filesystem encoding was set to
&lt;tt class="docutils literal"&gt;None&lt;/tt&gt;. I pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/b744ba1d14c5487576c95d0311e357b707600b47"&gt;commit b744ba1d&lt;/a&gt;
into the Python 3.2 development branch to make the default encoding (UTF-8)
more obvious. But before Python 3.2 was released, I removed the fallback with
my &lt;a class="reference external" href="https://github.com/python/cpython/commit/e474309bb7f0ba6e6ae824c215c45f00db691889"&gt;commit e474309b&lt;/a&gt;
(Oct 2010):&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;initfsencoding()&lt;/tt&gt;: &lt;tt class="docutils literal"&gt;get_codeset()&lt;/tt&gt; failure is now a fatal error&lt;/p&gt;
&lt;p&gt;Don't fallback to UTF-8 anymore to avoid mojibake. I never got any error
from his function.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="the-utf8-option-proposed-for-windows"&gt;
&lt;h2&gt;The utf8 option proposed for Windows&lt;/h2&gt;
&lt;p&gt;August 2016, &lt;a class="reference external" href="https://bugs.python.org/issue27781"&gt;bpo-27781&lt;/a&gt;: when &lt;strong&gt;Steve
Dower&lt;/strong&gt; &lt;a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html"&gt;was working on changing the filesystem encoding to UTF-8&lt;/a&gt;, I was not sure that Windows should use UTF-8
by default. I was more in favor on &lt;strong&gt;making the backward incompatible change an
opt-in option&lt;/strong&gt;. &lt;a class="reference external" href="https://bugs.python.org/issue27781#msg272950"&gt;I wrote&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;If you go in this direction, I would like to follow you for the UNIX/BSD
side to make the switch portable. I was thinking about &amp;quot;-X utf8&amp;quot; which
avoids to change the command line parser.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;If we agree on a plan, &lt;strong&gt;I would like to write it down as a PEP since I
expect a lot of complains and questions which I would prefer to only answer
once&lt;/strong&gt; (see for example the length of your thread on python-ideas where
each people repeated the same things multiple times ;-))&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue27781#msg272962"&gt;I added&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I mean that &lt;tt class="docutils literal"&gt;python3 &lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; should force
&lt;tt class="docutils literal"&gt;sys.getfilesystemencoding()&lt;/tt&gt; to UTF-8 on UNIX/BSD, it would ignore the
current locale setting.&lt;/blockquote&gt;
&lt;p&gt;Since Steve chose to &lt;strong&gt;change the default to UTF-8&lt;/strong&gt; on Windows, my &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt;
option idea was ignored in this issue.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-utf8-option-proposed-for-the-posix-locale"&gt;
&lt;h2&gt;The utf8 option proposed for the POSIX locale&lt;/h2&gt;
&lt;p&gt;September 2016: &lt;strong&gt;Jan Niklas Hasse&lt;/strong&gt; opened &lt;a class="reference external" href="https://bugs.python.org/issue28180"&gt;bpo-28180&lt;/a&gt; about Docker images,
&lt;strong&gt;&amp;quot;sys.getfilesystemencoding() should default to utf-8&amp;quot;&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue28180#msg276707"&gt;I proposed again my option&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I proposed to add &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; command line option for UNIX to force utf8
encoding. Would it work for you?&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Jan Niklas Hasse&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue28180#msg276709"&gt;answered&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Unfortunately no, as this would mean I'll have to change all my python
invocations in my scripts and it wouldn't work for executable files with&lt;/blockquote&gt;
&lt;p&gt;December 2016, &lt;a class="reference external" href="https://bugs.python.org/issue28180#msg283408"&gt;I added&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Usually, when a new option is added to Python, we add a command line option
(-X utf8) but also an environment variable: &lt;strong&gt;I propose PYTHONUTF8=1&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Use your favorite method to define the env var &amp;quot;system wide&amp;quot; in your docker
containers.&lt;/p&gt;
&lt;p&gt;Note: Technically, I'm not sure that it's possible to support -E option
with PYTHONUTF8, since -E comes from the command line, and we first need to
decode command line arguments with an encoding to parse these options....
Chicken-and-egg issue ;-)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Nick Coghlan&lt;/strong&gt; &lt;a class="reference external" href="https://vstinner.github.io/posix-locale.html"&gt;wrote his PEP 538 &amp;quot;Coercing the C locale to a UTF-8 based
locale&amp;quot;&lt;/a&gt; which has been approved in May 2017
and finally implemented in June 2017.&lt;/p&gt;
&lt;p&gt;Again, my utf8 idea was ignored in this issue.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="first-version-of-my-pep-540-add-a-new-utf-8-mode"&gt;
&lt;h2&gt;First version of my PEP 540: Add a new UTF-8 Mode&lt;/h2&gt;
&lt;p&gt;January 2017, as a follow-up of &lt;a class="reference external" href="https://bugs.python.org/issue27781"&gt;bpo-27781&lt;/a&gt; and &lt;a class="reference external" href="https://bugs.python.org/issue28180"&gt;bpo-28180&lt;/a&gt;, I wrote the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0540/"&gt;PEP 540: Add a new UTF-8
Mode&lt;/a&gt; and &lt;a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2017-January/044089.html"&gt;I posted it to
python-ideas for comments&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Abstract:&lt;/p&gt;
&lt;blockquote&gt;
Add a new UTF-8 mode, opt-in option to use UTF-8 for operating system
data instead of the locale encoding. Add &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; command line option
and &lt;tt class="docutils literal"&gt;PYTHONUTF8&lt;/tt&gt; environment variable.&lt;/blockquote&gt;
&lt;p&gt;After ten hours after and a few messages, I &lt;a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2017-January/044099.html"&gt;wrote a second version&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I modified my PEP: &lt;strong&gt;the POSIX locale now enables the UTF-8 mode&lt;/strong&gt;.&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;INADA Naoki&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2017-January/044112.html"&gt;wrote&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I want UTF-8 mode is &lt;strong&gt;enabled by default (opt-out option) even if locale
is not POSIX&lt;/strong&gt;, like &lt;cite&gt;PYTHONLEGACYWINDOWSFSENCODING&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;Users depends on locale know what locale is and how to configure it.  They
can understand difference between locale mode and UTF-8 mode and they can
opt-out UTF-8 mode.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;But many people lives in &amp;quot;UTF-8 everywhere&amp;quot; world&lt;/strong&gt;, and don't know about
locale.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Always ignoring the locale to &lt;strong&gt;always use UTF-8 would be a backward
incompatible change&lt;/strong&gt;. I wasn't brave enough to propose it, I only
wanted to propose an opt-in option, except of the specific case of the POSIX
locale.&lt;/p&gt;
&lt;p&gt;Not only people had different opinons, but most people had strong opinions on
how to handle Unicode and were not ready for compromises.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="third-version-of-my-pep-540"&gt;
&lt;h2&gt;Third version of my PEP 540&lt;/h2&gt;
&lt;p&gt;One week and 59 emails later, I &lt;a class="reference external" href="https://bugs.python.org/issue29240"&gt;implemented my PEP 540&lt;/a&gt; and &lt;a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2017-January/044197.html"&gt;I wrote a third version of my PEP&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I made multiple changes since the first version of my PEP:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The &lt;strong&gt;UTF-8 Strict mode now only uses strict for inputs and outputs&lt;/strong&gt;:
it keeps surrogateescape for operating system data. Read the &amp;quot;Use the
strict error handler for operating system data&amp;quot; alternative for the
rationale.&lt;/li&gt;
&lt;li&gt;The POSIX locale now enables the UTF-8 mode. See the &amp;quot;Don't modify
the encoding of the POSIX locale&amp;quot; alternative for the rationale.&lt;/li&gt;
&lt;li&gt;Specify the priority between -X utf8, PYTHONUTF8, PYTHONIOENCODING, etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The PEP version 3 has a longer rationale with more example. (...)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The new thread also got 19 emails, total: &lt;strong&gt;78 emails in one month&lt;/strong&gt;. The same
month, Nick Coghlan's PEP 538 was also under discussion.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="silence-during-one-year"&gt;
&lt;h2&gt;Silence during one year&lt;/h2&gt;
&lt;p&gt;Because of the tone of the python-ideas threads and because I didn't know how
to deal with Nick Coghlan's PEP 538, &lt;strong&gt;I decided to do nothing during one
year&lt;/strong&gt; (January to December 2017).&lt;/p&gt;
&lt;p&gt;April 2017, Nick &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-April/147795.html"&gt;proposed&lt;/a&gt;
&lt;strong&gt;INADA Naoki&lt;/strong&gt; as the BDFL Delegate for his PEP 538 and my PEP 540. Guido
&lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-April/147796.html"&gt;accepted to delegate&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;May 2017, Naoki approved Nick's PEP 538, and Nick implemented it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-540-version-3-posted-to-python-dev"&gt;
&lt;h2&gt;PEP 540 version 3 posted to python-dev&lt;/h2&gt;
&lt;p&gt;At the end of 2017, when I looked at my contributions in Python 3.7 in the
&lt;a class="reference external" href="https://docs.python.org/dev/whatsnew/3.7.html"&gt;What’s New In Python 3.7&lt;/a&gt;
document, I didn't see any significant contribution. I wanted to propose
something. Moreover, the deadline for the Python 3.7 feature freeze (first beta
version) was getting close, end of January 2018: see the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0537/"&gt;PEP 537: Python 3.7
Release Schedule&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;December 2017, I decided to move to the next step: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151054.html"&gt;I sent my PEP to the
python-dev mailing list&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Guido van Rossum &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151069.html"&gt;complained about the length of the PEP&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I've been discussing this PEP offline with Victor, but he suggested we
should discuss it in public instead.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I am very worried about this long and rambling PEP, and I propose that it
not be accepted without a major rewrite to focus on clarity of the
specification. The &amp;quot;Unicode just works&amp;quot; summary is more a wish than a
proper summary of the PEP.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;(...)&lt;/p&gt;
&lt;p&gt;So I guess PEP acceptance week is over. :-(&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-rewritten-from-scratch"&gt;
&lt;h2&gt;PEP rewritten from scratch&lt;/h2&gt;
&lt;p&gt;Even if &lt;strong&gt;I was not fully convinced myself that my PEP was a good idea&lt;/strong&gt;, I
wanted to get an official vote, to know if my idea should be implemented or
abandonned. I decided to rewrite my PEP from scratch:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/python/peps/blob/f92b5fbdc2bcd9b182c1541da5a0f4ce32195fb6/pep-0540.txt"&gt;PEP version 3 (before rewrite)&lt;/a&gt;:
1,017 lines&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/python/peps/blob/0bb19ff93af9855db327e9a02f3e86b6f932a25a/pep-0540.txt"&gt;PEP version 4 (after rewrite)&lt;/a&gt;:
263 lines (26% of the previous version)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I reduced the rationale to the strict minimum, to explain &lt;strong&gt;key points&lt;/strong&gt; of the
PEP:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Locale encoding and UTF-8&lt;/li&gt;
&lt;li&gt;Passthough undecodable bytes: surrogateescape&lt;/li&gt;
&lt;li&gt;Strict UTF-8 for correctness&lt;/li&gt;
&lt;li&gt;No change by default for best backward compatibility&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="reading-jpeg-pictures-with-surrogateescape"&gt;
&lt;h2&gt;Reading JPEG pictures with surrogateescape&lt;/h2&gt;
&lt;p&gt;December 2017, I sent the &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151074.html"&gt;shorter PEP version 4 to python-dev&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;INADA Naoki, the BDFL-delegate, &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151081.html"&gt;spotted a design issue&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;And I have one worrying point. With UTF-8 mode, &lt;strong&gt;open()'s default&lt;/strong&gt;
encoding/error handler &lt;strong&gt;is UTF-8/surrogateescape&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;(...)&lt;/p&gt;
&lt;p&gt;And &lt;strong&gt;opening binary file without &amp;quot;b&amp;quot; option is very common mistake&lt;/strong&gt; of
new developers.  If default error handler is surrogateescape, &lt;strong&gt;they lose a
chance to notice their bug&lt;/strong&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;He &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151101.html"&gt;gave a concrete example&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;With PEP 538 (C.UTF-8 locale), &lt;tt class="docutils literal"&gt;open()&lt;/tt&gt; uses UTF-8/strict, not
UTF-8/surrogateescape.&lt;/p&gt;
&lt;p&gt;For example, this code raises &lt;tt class="docutils literal"&gt;UnicodeDecodeError&lt;/tt&gt; with PEP 538 if the
file is JPEG file.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
with open(fn) as f:
    f.read()
&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151132.html"&gt;I replied&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;While I'm not strongly convinced that &lt;tt class="docutils literal"&gt;open()&lt;/tt&gt; error handler must be
changed for &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt;, first &lt;strong&gt;I would like to make sure that
it's really a very bad idea&lt;/strong&gt; before changing it :-)&lt;/p&gt;
&lt;p&gt;(...)&lt;/p&gt;
&lt;p&gt;Using a JPEG image, the example is obviously wrong.&lt;/p&gt;
&lt;p&gt;But using surrogateescape on open() has been chosen to &lt;strong&gt;read text files
which are mostly correctly encoded to UTF-8, except a few bytes&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;I'm not sure how to explain the issue. The Mercurial wiki page has a good
example of this issue that they call the &lt;a class="reference external" href="https://www.mercurial-scm.org/wiki/EncodingStrategy#The_.22makefile_problem.22"&gt;&amp;quot;Makefile problem&amp;quot;&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Guido van Rossum&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151134.html"&gt;finished to convinced me&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
You will quickly get decoding errors, and that is &lt;strong&gt;INADA&lt;/strong&gt;'s point.
(Unless you use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;encoding='Latin-1'&lt;/span&gt;&lt;/tt&gt;.) His worry is that the
surrogateescape error handler makes it so that you won't get decoding
errors, and then &lt;strong&gt;the failure mode is much harder to debug&lt;/strong&gt;.&lt;/blockquote&gt;
&lt;p&gt;I &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151136.html"&gt;wrote a 5th version of my PEP&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I made the following two changes to the PEP 540:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;open() error handler remains &lt;tt class="docutils literal"&gt;&amp;quot;strict&amp;quot;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Remove the &amp;quot;Strict UTF8 mode&amp;quot; which doesn't make much sense anymore&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="last-question-on-locale-getpreferredencoding"&gt;
&lt;h2&gt;Last question on locale.getpreferredencoding()&lt;/h2&gt;
&lt;p&gt;December 2017, &lt;strong&gt;INADA Naoki&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151144.html"&gt;asked&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Or &lt;tt class="docutils literal"&gt;locale.getpreferredencoding()&lt;/tt&gt; returns &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;'UTF-8'&lt;/span&gt;&lt;/tt&gt; in UTF-8 mode too?&lt;/blockquote&gt;
&lt;p&gt;Oh, that's a good question! I &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151148.html"&gt;looked at the code&lt;/a&gt; and
agreed to return UTF-8:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I checked the stdlib, and I found many places where
&lt;tt class="docutils literal"&gt;locale.getpreferredencoding()&lt;/tt&gt; is used to get the user preferred
encoding:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;builtin &lt;tt class="docutils literal"&gt;open()&lt;/tt&gt;: default encoding&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;cgi.FieldStorage&lt;/tt&gt;: encode the query string&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;encoding._alias_mbcs()&lt;/tt&gt;: check if the requested encoding is the ANSI
code page&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;gettext.GNUTranslations&lt;/tt&gt;: &lt;tt class="docutils literal"&gt;lgettext()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;lngettext()&lt;/tt&gt; methods&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;xml.etree.ElementTree&lt;/tt&gt;: &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;ElementTree.write(encoding='unicode')&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In the UTF-8 mode, I would expect that cgi, gettext and xml.etree all use
the UTF-8 encoding by default. So &lt;strong&gt;locale.getpreferredencoding() should
return UTF-8 if the UTF-8 mode is enabled&lt;/strong&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151151.html"&gt;sent a 6th version of my PEP&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
locale.getpreferredencoding() now returns 'UTF-8' in the UTF-8 Mode.&lt;/blockquote&gt;
&lt;p&gt;Moreover, I also wrote a new much better written &amp;quot;Relationship with the locale
coercion (PEP 538)&amp;quot; section replacing the &amp;quot;Annex: Differences between
PEP 538 and PEP 540&amp;quot; section. The new section was asked by many people who were
confused by the relationship between PEP 538 and PEP 540.&lt;/p&gt;
&lt;p&gt;Finally, one year after the first PEP version, INADA Naoki &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-December/151193.html"&gt;approved my PEP&lt;/a&gt;!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="first-incomplete-implementation"&gt;
&lt;h2&gt;First incomplete implementation&lt;/h2&gt;
&lt;p&gt;I started to work on the implementation of my PEP 540 in March 2017. Once the
PEP has been approved, I asked INADA Naoki for a review. &lt;a class="reference external" href="https://github.com/python/cpython/pull/855#issuecomment-351089573"&gt;He asked me to fix the
command line parsing&lt;/a&gt; to handle
properly the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; option:&lt;/p&gt;
&lt;blockquote&gt;
And when &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; option is found, we can decode from &lt;tt class="docutils literal"&gt;char **argv&lt;/tt&gt;
again.  Since &lt;tt class="docutils literal"&gt;mbstowcs()&lt;/tt&gt; doesn't guarantee round tripping, it is better
than re-encode &lt;tt class="docutils literal"&gt;wchar_t **argv&lt;/tt&gt;.&lt;/blockquote&gt;
&lt;p&gt;Implementing properly the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; option was tricky. Parsing the command line
was done on &lt;tt class="docutils literal"&gt;wchar_t*&lt;/tt&gt; C strings (Unicode), which requires to decode the
&lt;tt class="docutils literal"&gt;char** argv&lt;/tt&gt; C array of byte strings (bytes). Python starts by decoding byte
strings from the locale encoding. If the utf8 option is detected, &lt;tt class="docutils literal"&gt;argv&lt;/tt&gt; byte
strings must be decoded again, but now from UTF-8. The problem was that the
code was not designed for that, and it required to refactor a lot of code in
&lt;tt class="docutils literal"&gt;Py_Main()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/python/cpython/pull/855#issuecomment-351252873"&gt;I replied&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;main()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;Py_Main()&lt;/tt&gt; are very complex. With the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0432/"&gt;PEP 432&lt;/a&gt;, &lt;strong&gt;Nick Coghlan&lt;/strong&gt;, &lt;strong&gt;Eric
Snow&lt;/strong&gt; and me are working on making this code better. See for example
&lt;a class="reference external" href="https://bugs.python.org/issue32030"&gt;bpo-32030&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;(...)&lt;/p&gt;
&lt;p&gt;For all these reasons, &lt;strong&gt;I propose to merge this uncomplete PR and write a
different PR for the most complex part&lt;/strong&gt;, re-encode wchar_t* command line
arguments, implement Py_UnixMain() or another even better option?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I wanted to get my code merged as soon as possible to make sure that it will
get into the first Python 3.7 beta, to get a longer testing period before
Python 3.7 final.&lt;/p&gt;
&lt;p&gt;December 2017, &lt;a class="reference external" href="https://bugs.python.org/issue29240"&gt;bpo-29240&lt;/a&gt;, I pushed my
&lt;a class="reference external" href="https://github.com/python/cpython/commit/91106cd9ff2f321c0f60fbaa09fd46c80aa5c266"&gt;commit 91106cd9&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;PEP 540: Add a new UTF-8 Mode&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Add &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; command line option, &lt;tt class="docutils literal"&gt;PYTHONUTF8&lt;/tt&gt; environment variable
and a new &lt;tt class="docutils literal"&gt;sys.flags.utf8_mode&lt;/tt&gt; flag.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;locale.getpreferredencoding()&lt;/tt&gt; now returns 'UTF-8' in the UTF-8
mode. As a side effect, open() now uses the UTF-8 encoding by
default in this mode.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="split-py-main-into-subfunctions"&gt;
&lt;h2&gt;Split Py_Main() into subfunctions&lt;/h2&gt;
&lt;p&gt;November 2017, I created &lt;a class="reference external" href="https://bugs.python.org/issue32030"&gt;bpo-32030&lt;/a&gt; to
split the big &lt;tt class="docutils literal"&gt;Py_Main()&lt;/tt&gt; function into smaller subfunctions. My motivation
was to be able to properly implement my PEP 540.&lt;/p&gt;
&lt;p&gt;It will take me &lt;strong&gt;3 months of work and 45 commits&lt;/strong&gt; to completely cleanup
&lt;tt class="docutils literal"&gt;Py_Main()&lt;/tt&gt; and put almost all Python configuration options into the private
C &lt;tt class="docutils literal"&gt;_PyCoreConfig&lt;/tt&gt; structure.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="parse-again-the-command-line-when-x-utf8-is-used"&gt;
&lt;h2&gt;Parse again the command line when -X utf8 is used&lt;/h2&gt;
&lt;p&gt;December 2017, &lt;a class="reference external" href="https://bugs.python.org/issue32030"&gt;bpo-32030&lt;/a&gt;, thanks to
the &lt;tt class="docutils literal"&gt;Py_Main()&lt;/tt&gt; refactoring, I was able to finish the implementation of my
PEP.&lt;/p&gt;
&lt;p&gt;I pushed my &lt;a class="reference external" href="https://github.com/python/cpython/commit/9454060e84a669dde63824d9e2fcaf295e34f687"&gt;commit 9454060e&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;Py_Main()&lt;/tt&gt; re-reads config if encoding changes&lt;/p&gt;
&lt;p&gt;If the encoding change (C locale coerced or UTF-8 Mode changed),
&lt;tt class="docutils literal"&gt;Py_Main()&lt;/tt&gt; now reads again the configuration with the new encoding.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;If the encoding changed after reading the Python configuration, cleanup the
configuration and &lt;strong&gt;read again the configuration with the new encoding.&lt;/strong&gt; The
key feature here allowed by the refactoring is to be able to cleanup properly
all the configuration.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="utf-8-mode-and-the-locale-encoding"&gt;
&lt;h2&gt;UTF-8 Mode and the locale encoding&lt;/h2&gt;
&lt;p&gt;January 2018, while working on &lt;a class="reference external" href="https://bugs.python.org/issue31900"&gt;bpo-31900&lt;/a&gt; &amp;quot;localeconv() should decode numeric
fields from LC_NUMERIC encoding, not from LC_CTYPE encoding&amp;quot;, I tested various
combinations of locales and encodings. &lt;strong&gt;I found bugs with the UTF-8 mode.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;When the UTF-8 mode is enabled explicitly by &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt;, the intent is to use
UTF-8 &amp;quot;everywhere&amp;quot;. Right. But &lt;strong&gt;there are some places, where the current
locale encoding is really the correct encoding&lt;/strong&gt;, like the &lt;tt class="docutils literal"&gt;time.strftime()&lt;/tt&gt;
function.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue29240"&gt;bpo-29240&lt;/a&gt;: I pushed a first fix,
&lt;a class="reference external" href="https://github.com/python/cpython/commit/cb3ae5588bd7733e76dc09277bb7626652d9bb64"&gt;commit cb3ae558&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Ignore UTF-8 Mode in the &lt;tt class="docutils literal"&gt;time&lt;/tt&gt; module&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;time.strftime()&lt;/tt&gt; must use the current &lt;tt class="docutils literal"&gt;LC_CTYPE&lt;/tt&gt; encoding, not UTF-8
if the UTF-8 mode is enabled.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I tested more cases and found... &lt;strong&gt;more bugs&lt;/strong&gt;. More functions must really use the
current locale encoding, rather than UTF-8 if the UTF-8 Mode is enabled.&lt;/p&gt;
&lt;p&gt;I pushed a second fix, &lt;a class="reference external" href="https://github.com/python/cpython/commit/7ed7aead9503102d2ed316175f198104e0cd674c"&gt;commit 7ed7aead&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Fix locale encodings in UTF-8 Mode&lt;/p&gt;
&lt;p&gt;Modify &lt;tt class="docutils literal"&gt;locale.localeconv()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;time.tzname&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;os.strerror()&lt;/tt&gt; and
other functions to ignore the UTF-8 Mode: always use the current locale
encoding.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The second fix documented the encoding used by the public C functions
&lt;a class="reference external" href="https://docs.python.org/dev/c-api/sys.html#c.Py_DecodeLocale"&gt;Py_DecodeLocale()&lt;/a&gt; and
&lt;a class="reference external" href="https://docs.python.org/dev/c-api/sys.html#c.Py_EncodeLocale"&gt;Py_EncodeLocale()&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Encoding, highest priority to lowest priority:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;UTF-8&lt;/span&gt;&lt;/tt&gt; on macOS and Android;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;UTF-8&lt;/span&gt;&lt;/tt&gt; if the Python UTF-8 mode is enabled;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;ASCII&lt;/tt&gt; if the &lt;tt class="docutils literal"&gt;LC_CTYPE&lt;/tt&gt; locale is &lt;tt class="docutils literal"&gt;&amp;quot;C&amp;quot;&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;nl_langinfo(CODESET)&lt;/tt&gt; returns the &lt;tt class="docutils literal"&gt;ASCII&lt;/tt&gt; encoding (or an alias),
and &lt;tt class="docutils literal"&gt;mbstowcs()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;wcstombs()&lt;/tt&gt; functions uses the
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;ISO-8859-1&lt;/span&gt;&lt;/tt&gt; encoding.&lt;/li&gt;
&lt;li&gt;the current locale encoding.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;The fix was complex to be written because I had to extend Py_DecodeLocale() and
Py_EncodeLocale() to support internally the &lt;tt class="docutils literal"&gt;strict&lt;/tt&gt; error handler. I also
extended to API to report an error message (called &amp;quot;reason&amp;quot;) on failure.&lt;/p&gt;
&lt;p&gt;For example, &lt;tt class="docutils literal"&gt;Py_DecodeLocale()&lt;/tt&gt; has the prototype:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
wchar_t*
Py_DecodeLocale(const char* arg, size_t *wlen)
&lt;/pre&gt;
&lt;p&gt;whereas the new extended and more generic &lt;tt class="docutils literal"&gt;_Py_DecodeLocaleEx()&lt;/tt&gt; has a much
more complex prototype:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
int
_Py_DecodeLocaleEx(const char* arg, wchar_t **wstr, size_t *wlen,
                   const char **reason,
                   int current_locale, int surrogateescape)
&lt;/pre&gt;
&lt;p&gt;To decode, there are two main use cases:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;(FILENAME) Use UTF-8 if the UTF-8 Mode is enabled, or the locale encoding
otherwise. See &lt;tt class="docutils literal"&gt;Py_DecodeLocale()&lt;/tt&gt; documentation for the exact used
encoding, the truth is more complex.&lt;/li&gt;
&lt;li&gt;(LOCALE) Always use the current locale encoding&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(FILENAME) examples:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Py_DecodeLocale()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;PyUnicode_DecodeFSDefaultAndSize()&lt;/tt&gt;: use the
&lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.fsdecode()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.listdir()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.environ&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;sys.argv&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(LOCALE) examples:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PyUnicode_DecodeLocale()&lt;/tt&gt;: the error handler is passed as an argument and
must be &lt;tt class="docutils literal"&gt;strict&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;time.strftime()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;locale.localeconv()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;time.tzname&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.strerror()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;readline&lt;/tt&gt; module: internal &lt;tt class="docutils literal"&gt;decode()&lt;/tt&gt; function&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="summary-of-pep-540-history"&gt;
&lt;h2&gt;Summary of PEP 540 history&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Version 1: first version sent to python-ideas&lt;/li&gt;
&lt;li&gt;Version 2: the POSIX locale now enables the UTF-8 mode&lt;/li&gt;
&lt;li&gt;Version 3: the UTF-8 Strict mode now only uses the &lt;tt class="docutils literal"&gt;strict&lt;/tt&gt; error handler
for inputs and outputs&lt;/li&gt;
&lt;li&gt;Version 4: PEP rewritten from scratch to be shorter&lt;/li&gt;
&lt;li&gt;Version 5: open() error handler remains &lt;tt class="docutils literal"&gt;strict&lt;/tt&gt;, and the &amp;quot;Strict UTF8
mode&amp;quot; has been removed&lt;/li&gt;
&lt;li&gt;Version 6: locale.getpreferredencoding() now returns 'UTF-8' in the UTF-8
Mode.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Abstract of the final approved PEP:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Add a new &amp;quot;UTF-8 Mode&amp;quot; to enhance Python's use of UTF-8.  When UTF-8 Mode
is active, Python will:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;use the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;utf-8&lt;/span&gt;&lt;/tt&gt; encoding, irregardless of the locale currently set by
the current platform, and&lt;/li&gt;
&lt;li&gt;change the &lt;tt class="docutils literal"&gt;stdin&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;stdout&lt;/tt&gt; error handlers to
&lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This mode is off by default, but is automatically activated when using
the &amp;quot;POSIX&amp;quot; locale.&lt;/p&gt;
&lt;p&gt;Add the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-X&lt;/span&gt; utf8&lt;/tt&gt; command line option and &lt;tt class="docutils literal"&gt;PYTHONUTF8&lt;/tt&gt; environment
variable to control UTF-8 Mode.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;It's now time for a well deserved nap... until the next major Unicode issue in Python.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/manager_2000/2911858714/"&gt;&lt;img alt="Tiger nap" src="https://vstinner.github.io/images/tiger_nap.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;(I love tigers: my favorite animals!)&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category><category term="unicode"></category></entry><entry><title>Python 3.7 and the POSIX locale</title><link href="https://vstinner.github.io/posix-locale.html" rel="alternate"></link><published>2018-03-23T13:00:00+01:00</published><updated>2018-03-23T13:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-23:/posix-locale.html</id><summary type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/rj65/15010849568/"&gt;&lt;img alt="Bee" src="https://vstinner.github.io/images/bee.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;During the childhood of Python 3, encodings issues were common, even on well
configured systems. Python used UTF-8 rather than the locale encoding, and so
commonly produced &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Mojibake"&gt;mojibake&lt;/a&gt;. For
these reasons, when users complained about the Python behaviour with the POSIX
locale, bug reports were closed with a message like …&lt;/p&gt;</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/rj65/15010849568/"&gt;&lt;img alt="Bee" src="https://vstinner.github.io/images/bee.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;During the childhood of Python 3, encodings issues were common, even on well
configured systems. Python used UTF-8 rather than the locale encoding, and so
commonly produced &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Mojibake"&gt;mojibake&lt;/a&gt;. For
these reasons, when users complained about the Python behaviour with the POSIX
locale, bug reports were closed with a message like: &amp;quot;your system is not
properly configured, please fix your locale&amp;quot;.&lt;/p&gt;
&lt;p&gt;I only started to make a shy change for the POSIX locale in Python 3.5 at the
end of 2013: use &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; for stdin and stdout. We will have to wait
for Nick Coghlan in 2017 for significant changes in Python 3.7.&lt;/p&gt;
&lt;p&gt;This article explains the slow transition, &lt;strong&gt;six years&lt;/strong&gt; since the first bug
report (2011) to the significant change (2017), from &amp;quot;you must fix your locale&amp;quot;
to &amp;quot;maybe Python can do something for you&amp;quot;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This article is the fifth in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:&lt;/strong&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;ol class="first arabic"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html"&gt;Python 3.0 listdir() Bug on Undecodable Filenames&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="2"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/pep-383.html"&gt;Python 3.1 surrogateescape error handler (PEP 383)&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="3"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html"&gt;Python 3.2 Painful History of the Filesystem Encoding&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="4"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html"&gt;Python 3.6 now uses UTF-8 on Windows&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="5"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/posix-locale.html"&gt;Python 3.7 and the POSIX locale&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="6"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html"&gt;Python 3.7 UTF-8 Mode&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="first-rejected-attempt-2011"&gt;
&lt;h2&gt;First rejected attempt, 2011&lt;/h2&gt;
&lt;p&gt;December 2011, &lt;strong&gt;Martin Packman&lt;/strong&gt;, a Bazaar developer, reported &lt;a class="reference external" href="https://bugs.python.org/issue13643"&gt;bpo-13643&lt;/a&gt; to propose to use UTF-8 in Python if the
locale encoding is ASCII:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Currently when running Python on a non-OSX posix environment under either
the &lt;strong&gt;C locale&lt;/strong&gt;, or with an invalid or missing locale, it's &lt;strong&gt;not possible
to operate using unicode filenames outside the ascii range&lt;/strong&gt;. Using bytes
works, as does reading expecting unicode, using the surrogates hack.&lt;/p&gt;
&lt;p&gt;This makes robustly working with non-ascii filenames on different platforms
needlessly annoying, given &lt;strong&gt;no modern nix should have problems just using
UTF-8 in these cases&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;See the &lt;a class="reference external" href="https://bugs.launchpad.net/bzr/+bug/794353"&gt;downstream bzr bug for more&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;One option is to &lt;strong&gt;just use UTF-8&lt;/strong&gt; for encoding and decoding filenames
&lt;strong&gt;when otherwise ascii would be used&lt;/strong&gt;. As a strict superset, this
shouldn't break too many existing assumptions, and &lt;strong&gt;it's unlikely that
non-UTF-8 filenames will accidentally be mangled due to a locale setting
blip.&lt;/strong&gt; See the attached patch for this behaviour change. It does not
include a test currently, but it's possible to write one using subprocess
and overriden &lt;tt class="docutils literal"&gt;LANG&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;LC_ALL&lt;/tt&gt; vars.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue13643#msg149928"&gt;He added&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This is more about &lt;strong&gt;un-encodable filenames&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;At the moment work with non-ascii filenames in Python robustly requires two
branches, one using unicode and one that encodes to bytestrings and deals
with the case where the name can't be represented in the declared
filesystem encoding.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;That may be something that just had to be lived with&lt;/strong&gt;, but it's a little
annoying when even without a UTF-8 locale for a particular process, that's
what most systems will want on disk.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;At this time, I was still traumatised by the &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt; mess: using a
filesystem encoding different than the locale encoding caused many issues (see
&lt;a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html"&gt;Python 3.2 Painful History of the Filesystem Encoding&lt;/a&gt;). &lt;a class="reference external" href="https://bugs.python.org/issue13643#msg149926"&gt;I wrote&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
It was already discussed: using a different encoding for filenames and for
other things is really not a good idea. (...)&lt;/blockquote&gt;
&lt;p&gt;and &lt;a class="reference external" href="https://bugs.python.org/issue13643#msg149927"&gt;I added&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
The right fix is to &lt;strong&gt;fix your locale, not Python&lt;/strong&gt;.&lt;/blockquote&gt;
&lt;p&gt;Antoine Pitrou &lt;a class="reference external" href="https://bugs.python.org/issue13643#msg149949"&gt;suggested to fix the operating system, not Python&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;So &lt;strong&gt;why don't these supposedly &amp;quot;modern&amp;quot; systems at least set the
appropriate environment variables&lt;/strong&gt; for Python to infer the proper
character encoding?  (since these &amp;quot;modern&amp;quot; systems don't have a
well-defined encoding...)&lt;/p&gt;
&lt;p&gt;Answer: because they are not modern at all, &lt;strong&gt;they are antiquated,
inadapted and obsolete pieces of software designed and written by clueless
Anglo-American people&lt;/strong&gt;. Please report bugs against these systems. &lt;strong&gt;The
culprit is not Python, it's the Unix crap&lt;/strong&gt; and the utterly clueless
attitude of its maintainers (&amp;quot;filesystems are just bytes&amp;quot;, yeah,
whatever...).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Martin Pool&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue13643#msg149951"&gt;wrote&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
The standard encoding is UTF-8. Python shouldn't need to have a variable
set to tell it this.&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue13643#msg149952"&gt;Antoine replied&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
How so? I don't know of any Linux or Unix spec which says so.&lt;/blockquote&gt;
&lt;p&gt;Four days and 34 messages later, &lt;strong&gt;Terry J. Reedy&lt;/strong&gt;
&lt;a class="reference external" href="https://bugs.python.org/issue13643#msg150204"&gt;closed the issue&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Martin, after reading most all of the &lt;strong&gt;unusually large sequence of
messages&lt;/strong&gt;, I am closing this because &lt;strong&gt;three of the core developers&lt;/strong&gt; with
the most experience in this area are &lt;strong&gt;dead-set against your proposal&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;That does not make it 'wrong', but does mean that it will not be approved
and implemented without new data and more persuasive arguments than those
presented so far. I do not see that continued repetition of what has been
said so far will change anything.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Getting many messages in short time is common when discussing Unicode issues
:-)&lt;/p&gt;
&lt;p&gt;March 2011, &lt;strong&gt;Armin Ronacher&lt;/strong&gt; and &lt;strong&gt;Carl Meyer&lt;/strong&gt; reported a similar issue:
&lt;a class="reference external" href="https://bugs.python.org/issue11574"&gt;bpo-11574&lt;/a&gt; and &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2011-March/109361.html"&gt;[Python-Dev] Low-Level Encoding Behavior on Python 3&lt;/a&gt;.  I
closed the issue as &amp;quot;wont fixed&amp;quot; in April 2012.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="second-attempt-2013"&gt;
&lt;h2&gt;Second attempt, 2013&lt;/h2&gt;
&lt;p&gt;November 2013, &lt;strong&gt;Sworddragon&lt;/strong&gt; reported &lt;a class="reference external" href="https://bugs.python.org/issue19846"&gt;bpo-19846&lt;/a&gt;: &lt;tt class="docutils literal"&gt;LANG=C python3 &lt;span class="pre"&gt;-c&lt;/span&gt; &lt;span class="pre"&gt;'print(&amp;quot;\xe4&amp;quot;)'&lt;/span&gt;&lt;/tt&gt;
fails with an &lt;tt class="docutils literal"&gt;UnicodeEncodeError&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Antoine Pitrou&lt;/strong&gt; wrote a patch to use UTF-8 when the locale encoding is
ASCII, same approach than the first attempt &lt;a class="reference external" href="https://bugs.python.org/issue13643"&gt;bpo-13643&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The patch was incomplete and so caused many issues.&lt;/strong&gt; Python used the C codec
of the locale encoding during Python initialization, and so Python had to use
the locale encoding as its filesystem encoding.&lt;/p&gt;
&lt;p&gt;I listed all functions that should be modified to fix issues and get a fully
working solution. Nobody came up with a full implementation, likely because
&lt;strong&gt;too many changes were required&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;One month and 66 messages (almost the double of the previous attempt) later,
again, &lt;a class="reference external" href="https://bugs.python.org/issue19846#msg205675"&gt;I closed the issue&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I'm closing the issue as invalid, because &lt;strong&gt;Python 3 behaviour is correct&lt;/strong&gt;
and must not be changed.&lt;/p&gt;
&lt;p&gt;Standard streams (sys.stdin, sys.stdout, sys.stderr) uses the locale
encoding. (...) These encodings and error handlers can be overriden by the
&lt;strong&gt;PYTHONIOENCODING&lt;/strong&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;My &lt;a class="reference external" href="https://bugs.python.org/issue19846#msg205675"&gt;full long comment&lt;/a&gt;
describes encodings used on each platform.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="use-surrogateescape-for-stdin-and-stdout-in-python-3-5"&gt;
&lt;h2&gt;Use surrogateescape for stdin and stdout in Python 3.5&lt;/h2&gt;
&lt;p&gt;December 2013: Just after closing the second attempt &lt;a class="reference external" href="https://bugs.python.org/issue19846"&gt;bpo-19846&lt;/a&gt;, I created &lt;a class="reference external" href="https://bugs.python.org/issue19977"&gt;bpo-19977&lt;/a&gt; to propose to use the
&lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler in &lt;tt class="docutils literal"&gt;sys.stdin&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;sys.stdout&lt;/tt&gt; for the
POSIX locale.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;R. David Murray&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue19977#msg206131"&gt;disliked my idea&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Reintroducing moji-bake intentionally doesn't sound like a particularly
good idea&lt;/strong&gt;, wasn't that what python3 was supposed to help prevent?&lt;/p&gt;
&lt;p&gt;It does seem like a &lt;strong&gt;utf-8 default is the Way of the Future&lt;/strong&gt;. Or even the
present, most places.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;March 2014, since &lt;strong&gt;Serhiy Storchaka&lt;/strong&gt; and &lt;strong&gt;Nick Coghlan&lt;/strong&gt; supported my idea,
I pushed my &lt;a class="reference external" href="https://github.com/python/cpython/commit/7143029d4360637aadbd7ddf386ea5c64fb83095"&gt;commit 7143029d&lt;/a&gt;
in Python 3.5:&lt;/p&gt;
&lt;blockquote&gt;
Issue #19977: When the &lt;tt class="docutils literal"&gt;LC_TYPE&lt;/tt&gt; locale is the POSIX locale (&lt;tt class="docutils literal"&gt;C&lt;/tt&gt;
locale), &lt;tt class="docutils literal"&gt;sys.stdin&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;sys.stdout&lt;/tt&gt; are now using the
&lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler, instead of the &lt;tt class="docutils literal"&gt;strict&lt;/tt&gt; error handler.&lt;/blockquote&gt;
&lt;p&gt;Previously, &lt;strong&gt;Python 3 was very strict on encodings&lt;/strong&gt;, all core developers were
convinced to be able to force developers to fix their applications. This change
is one the &lt;strong&gt;first Python 3 change which can produce &amp;quot;mojibake&amp;quot; on purpose&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Six years after the Python 3.0 release, we started to understand that while
developers can fix their code, we cannot ask users to fix their configuration
(&amp;quot;fix their locale&amp;quot;).&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="read-etc-locale-conf"&gt;
&lt;h2&gt;Read /etc/locale.conf?&lt;/h2&gt;
&lt;p&gt;April 2014, &lt;strong&gt;Nick Coghlan&lt;/strong&gt; created &lt;a class="reference external" href="https://bugs.python.org/issue21368"&gt;bpo-21368&lt;/a&gt;: &amp;quot;Check for systemd locale on
startup if current locale is set to POSIX&amp;quot;.&lt;/p&gt;
&lt;blockquote&gt;
If a modern Linux system is using systemd as the process manager, then
there will likely be &lt;strong&gt;a &amp;quot;/etc/locale.conf&amp;quot; file&lt;/strong&gt; providing settings like
LANG - due to problematic requirements in the POSIX specification, &lt;strong&gt;this
file&lt;/strong&gt; (when available) is &lt;strong&gt;likely to be a better &amp;quot;source of truth&amp;quot;
regarding the system encoding&lt;/strong&gt; than the environment where the interpreter
process is started, at least when the latter is claiming ASCII as the
default encoding.&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue21368#msg217328"&gt;I disliked the idea&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I don't think that Python should read such configuration file. If you
consider that something is wrong here, &lt;strong&gt;please report the issue to the C
library&lt;/strong&gt;.&lt;/blockquote&gt;
&lt;p&gt;Since no consensus was found, no action was taken.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="misconfigured-locales-in-docker-images"&gt;
&lt;h2&gt;Misconfigured locales in Docker images&lt;/h2&gt;
&lt;p&gt;September 2016: &lt;strong&gt;Jan Niklas Hasse&lt;/strong&gt; opened &lt;a class="reference external" href="https://bugs.python.org/issue28180"&gt;bpo-28180&lt;/a&gt;, &lt;strong&gt;&amp;quot;sys.getfilesystemencoding() should
default to utf-8&amp;quot;&lt;/strong&gt;.&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;Working with Docker I often end up with an environment where the locale
isn't correctly set.&lt;/strong&gt; In these cases &lt;strong&gt;it would be great if
sys.getfilesystemencoding() could default to 'utf-8'&lt;/strong&gt; instead of
&lt;tt class="docutils literal"&gt;'ascii'&lt;/tt&gt;, as it's the encoding of the future and ascii is a subset of it
anyway.&lt;/blockquote&gt;
&lt;p&gt;December 2016, &lt;strong&gt;Jan Niklas Hasse&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue28180#msg282972"&gt;mentioned&lt;/a&gt; the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;C.UTF-8&lt;/span&gt;&lt;/tt&gt; locale:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://sourceware.org/glibc/wiki/Proposals/C.UTF-8#Defaults"&gt;glibc C.UTF-8 article&lt;/a&gt; mentions
that &lt;strong&gt;C.UTF-8 should be glibc's default&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;This bug report &lt;a class="reference external" href="https://sourceware.org/bugzilla/show_bug.cgi?id=17318"&gt;also mentions Python&lt;/a&gt;. It &lt;strong&gt;hasn't been
fixed yet&lt;/strong&gt;, though :/&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Marc-Andre Lemburg&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue28180#msg282977"&gt;added&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;If we just restrict this to the file system encoding (and not the whole
LANG setting), how about:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;default the file system encoding to 'utf-8' and use the surrogate escape
handler as default error handler&lt;/li&gt;
&lt;li&gt;add a &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt; env var to set the file system encoding to
something else (*)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(*) I believe we discussed this at some point already, but don't remember the outcome.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The removed &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt; environment variable, using a filesystem
encoding different than the locale encoding, caused many issues: see &lt;a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html"&gt;Python
3.2 Painful History of the Filesystem Encoding&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Nick Coghlan&lt;/strong&gt; &lt;cite&gt;proposed to experiment using the C.UTF-8 locale&lt;/cite&gt; in Fedora
26:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;For Fedora 26,&lt;/strong&gt; I'm going to explore the feasibility of patching our system
3.6 installation such that the python3 command itself (rather than the
shared library) &lt;strong&gt;checks for &amp;quot;LC_CTYPE=C&amp;quot;&lt;/strong&gt; as almost the first thing it
does, and forcibly &lt;strong&gt;sets LANG and LC_ALL to C.UTF-8&lt;/strong&gt; if it gets an answer
it doesn't like. If we're able to do that successfully in the more
constrained environment of a specific recent Fedora release, then I think
it will bode well for doing something similar by default in CPython 3.7&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1404918"&gt;Downstream Fedora issue proposing the above idea for F26&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Fedora 26 integrated a downstream change in Python 3.6:
see &lt;a class="reference external" href="https://fedoraproject.org/wiki/Releases/26/ChangeSet#Python_3_C.UTF-8_locale"&gt;Python 3 C.UTF-8 locale&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-538-coercing-the-c-locale-to-a-utf-8-based-locale"&gt;
&lt;h2&gt;PEP 538: Coercing the C locale to a UTF-8 based locale&lt;/h2&gt;
&lt;a class="reference external image-reference" href="http://www.curiousefficiency.org/"&gt;&lt;img alt="Nick Coghlan" src="https://vstinner.github.io/images/nick_coghlan.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;December 2016, as a follow-up of &lt;a class="reference external" href="https://bugs.python.org/issue28180"&gt;bpo-28180&lt;/a&gt;, &lt;strong&gt;Nick Coghlan&lt;/strong&gt; wrote the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0538/"&gt;PEP
538: Coercing the legacy C locale to a UTF-8 based locale&lt;/a&gt; and &lt;a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2017-January/044130.html"&gt;posted it to python-ideas
list&lt;/a&gt;
and &lt;a class="reference external" href="https://mail.python.org/pipermail/linux-sig/2017-January/000014.html"&gt;to the linux-sig list&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;April 2017, Nick &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-April/147795.html"&gt;proposed&lt;/a&gt;
&lt;strong&gt;INADA Naoki&lt;/strong&gt; as the BDFL Delegate for his PEP. Guido &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-April/147796.html"&gt;accepted to delegate&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;May 2017, after 5 months of discussions and changes, INADA Naoki &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-May/148035.html"&gt;approved the
PEP&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;June 2017, &lt;a class="reference external" href="https://bugs.python.org/issue28180"&gt;bpo-28180&lt;/a&gt;: Nick Coghlan
pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/6ea4186de32d65b1f1dc1533b6312b798d300466"&gt;commit 6ea4186d&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
bpo-28180: Implementation for PEP 538 (#659)&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;A first attempt to use a different encoding for the POSIX locale was rejected
in 2011. A second attempt was also rejected in 2013.&lt;/p&gt;
&lt;p&gt;I modified Python 3.5 in 2014 to use the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler in
&lt;tt class="docutils literal"&gt;stdin&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;stdout&lt;/tt&gt; for the POSIX locale. Six years after the Python 3.0
release, we started to understand that while developers can fix their code, we
cannot ask users to &amp;quot;fix their locale&amp;quot; (configure properly their locale).&lt;/p&gt;
&lt;p&gt;In 2016, the problem occurred again with misconfigured locales in Docker
images.  In 2017, Nick Coghlan wrote the PEP 538 &amp;quot;Coercing the legacy C locale
to a UTF-8 based locale&amp;quot; which has been approved by INADA Naoki and implemented
in Python 3.7.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category><category term="unicode"></category></entry><entry><title>Python 3.6 now uses UTF-8 on Windows</title><link href="https://vstinner.github.io/python36-utf8-windows.html" rel="alternate"></link><published>2018-03-22T17:00:00+01:00</published><updated>2018-03-22T17:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-22:/python36-utf8-windows.html</id><summary type="html">&lt;p&gt;September 2016, a few days before the CPython core dev sprint, &lt;strong&gt;Steve Dower&lt;/strong&gt;
proposed two major backward incompatible changes for Python 3.6 on Windows:
&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0528/"&gt;PEP 528: Change Windows console encoding to UTF-8&lt;/a&gt; and &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0529/"&gt;PEP 529: Change Windows
filesystem encoding to UTF-8&lt;/a&gt;.
At the first read, I was sure that …&lt;/p&gt;</summary><content type="html">&lt;p&gt;September 2016, a few days before the CPython core dev sprint, &lt;strong&gt;Steve Dower&lt;/strong&gt;
proposed two major backward incompatible changes for Python 3.6 on Windows:
&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0528/"&gt;PEP 528: Change Windows console encoding to UTF-8&lt;/a&gt; and &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0529/"&gt;PEP 529: Change Windows
filesystem encoding to UTF-8&lt;/a&gt;.
At the first read, I was sure that the PEP 529 will break all applications on
Windows. This article tells the story behind the PEPs approval.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This article is the fourth in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:&lt;/strong&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;ol class="first arabic"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html"&gt;Python 3.0 listdir() Bug on Undecodable Filenames&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="2"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/pep-383.html"&gt;Python 3.1 surrogateescape error handler (PEP 383)&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="3"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html"&gt;Python 3.2 Painful History of the Filesystem Encoding&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="4"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html"&gt;Python 3.6 now uses UTF-8 on Windows&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="5"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/posix-locale.html"&gt;Python 3.7 and the POSIX locale&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="6"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html"&gt;Python 3.7 UTF-8 Mode&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="pep-529"&gt;
&lt;h2&gt;PEP 529&lt;/h2&gt;
&lt;p&gt;September 2016, &lt;strong&gt;Steve Dower&lt;/strong&gt;, who works for Microsoft, wrote the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0529/"&gt;PEP 529:
Change Windows filesystem encoding to UTF-8&lt;/a&gt; and &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-September/146051.html"&gt;posted it to python-dev&lt;/a&gt; for
comments.&lt;/p&gt;
&lt;a class="reference external image-reference" href="http://stevedower.id.au/blog/"&gt;&lt;img alt="Steve Dower" src="https://vstinner.github.io/images/steve_dower.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Abstract:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Historically, Python uses the ANSI APIs&lt;/strong&gt; for interacting with the
Windows operating system, often via C Runtime functions. However, these
have been long discouraged in favor of the UTF-16 APIs. Within the
operating system, all text is represented as UTF-16, and the ANSI APIs
perform encoding and decoding using the active code page. See Naming Files,
Paths, and Namespaces for more details.&lt;/p&gt;
&lt;p&gt;This PEP proposes &lt;strong&gt;changing the default filesystem encoding on Windows to
utf-8&lt;/strong&gt;, and changing all filesystem functions to use the Unicode APIs for
filesystem paths. This will not affect code that uses strings to represent
paths, however those that use bytes for paths will now be able to correctly
round-trip all valid paths in Windows filesystems. &lt;strong&gt;Currently, the
conversions between Unicode (in the OS) and bytes (in Python) were lossy&lt;/strong&gt;
and would fail to round-trip characters outside of the user's active code
page.&lt;/p&gt;
&lt;p&gt;Notably, this does not impact the encoding of the contents of files. These
will continue to default to &lt;tt class="docutils literal"&gt;locale.getpreferredencoding()&lt;/tt&gt; (for text
files) or plain bytes (for binary files). This only affects the encoding
used when users pass a bytes object to Python where it is then passed to
the operating system as a path name.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="my-analysis"&gt;
&lt;h2&gt;My analysis&lt;/h2&gt;
&lt;p&gt;Here is my analysis on the rationale for the PEP 529 change.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;On Unix, the native type for filenames is bytes&lt;/strong&gt;. A filename is seen by the
Linux kernel as an opaque object. The ext4 filesystem stores filenames as
bytes. If a Python 2 application uses Unicode for filenames, filesystem
operations can fail with a Unicode error (encoding or decoding error) depending
on the locale encoding. If the locale encoding is ASCII, Unicode errors are
likely to occur at the first non-ASCII filename. For example, Mercurial handles
filenames as bytes.&lt;/p&gt;
&lt;p&gt;On Python 3, handling filenames as Unicode works thanks to the
&lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler. &lt;strong&gt;Most Python 2 applications ported to
Python 3 keep their Python 2 support, and so still handle filenames bytes.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Problems arise when such software is used on Windows.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;On Windows, the native type for filenames is Unicode&lt;/strong&gt;. Many functions come
in two flavors: &amp;quot;ANSI&amp;quot; (bytes) and &amp;quot;Wide&amp;quot; (Unicode) versions. In my opinion,
the ANSI flavor mostly exists for backward compatibility. In Python 3.5,
passing a filename as bytes uses the ANSI flavor, whereas the Wide flavor is
used for Unicode filenames. The ANSI flavor uses the ANSI code page which is
very limited compared to Unicode, usually only 256 code points or less. Some
filenames not encodable to the ANSI code page simply cannot be opened, renamed,
etc. using the ANSI API.&lt;/p&gt;
&lt;p&gt;The other issue is that &lt;strong&gt;some developers only develop on Unix&lt;/strong&gt; (ex: Linux or
macOS) &lt;strong&gt;and never test their application on Windows&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;For a better rationale, read the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0529/#background"&gt;Background section&lt;/a&gt; of Steve Dower's PEP
:-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="discussion-at-the-cpython-sprint-and-guido-s-approval"&gt;
&lt;h2&gt;Discussion at the CPython sprint and Guido's approval&lt;/h2&gt;
&lt;p&gt;Honestly, &lt;strong&gt;at the first read, I was sure that the PEP 529 will break all
applications on Windows&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Hopefully, thanks to the PSF and Instagram, I was able to attend my first
CPython sprint at Instagram headquarters: &lt;a class="reference external" href="https://vstinner.github.io/cpython-sprint-2016.html"&gt;CPython sprint, september 2016&lt;/a&gt;. I discussed there with &lt;strong&gt;Steve who
reassured me and explained me his PEP&lt;/strong&gt;. Later, we talked with &lt;strong&gt;Guido van
Rossum&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Even if I liked the idea of using UTF-8, I was still not fully confident that the
change will not break the world. &lt;strong&gt;We agreed to try the change during Python
3.6 beta phase&lt;/strong&gt;, but revert it if something bad happens.&lt;/p&gt;
&lt;a class="reference external image-reference" href="http://blog.python.org/2016/09/python-core-development-sprint-2016-36.html"&gt;&lt;img alt="CPython developers at the Facebook sprint" src="https://vstinner.github.io/images/cpython_sprint_2016_photo.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Following this talk, &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-September/146277.html"&gt;Guido accepted the PEP under conditions&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I'm hijacking this thread to &lt;strong&gt;provisionally accept PEP 529&lt;/strong&gt;. (I'll also
do this for PEP 528, in its own thread.)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I've talked things over with Steve and Victor and we're going to do an
experiment&lt;/strong&gt; (as &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0529/#beta-experiment"&gt;now written up in the PEP&lt;/a&gt;) to tease out
any issues with this change during the beta. &lt;strong&gt;If serious problems crop up
we may have to roll back the changes and reject the PEP&lt;/strong&gt; -- we won't get
another chance at getting this right. (That would also mean that using the
binary filesystem APIs will remain deprecated and will eventually be
disallowed; as long as the PEP remains accepted they are undeprecated.)&lt;/p&gt;
&lt;p&gt;Congrats Steve! Thanks for the massive amount of work on the
implementation and the thinking that went into the design. Thanks
everyone else for their feedback.&lt;/p&gt;
&lt;p class="attribution"&gt;&amp;mdash;Guido&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;I was honoured that Guido listened to my Unicode experience&lt;/strong&gt; to take a
decision on the PEP ;-)&lt;/p&gt;
&lt;p&gt;Steve chose the right timing to get his PEP accepted. Thanks to the sprint
which helped to quickly discussed such backward incompatible change, &lt;strong&gt;the PEP
has been approved in just 12 days&lt;/strong&gt;! For comparison, some of my PEPs like my
&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0446/"&gt;PEP 446: Make newly created file descriptors non-inheritable&lt;/a&gt; (another backward incompatible
change) took 8 months to get accepted.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-528-windows-console"&gt;
&lt;h2&gt;PEP 528: Windows console&lt;/h2&gt;
&lt;p&gt;Just before the PEP 529, Steve Dower also wrote &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0528/"&gt;PEP 528: Change Windows
console encoding to UTF-8&lt;/a&gt;.  This
change only impacts the Windows console, so there is a lower risk of breaking
the world.&lt;/p&gt;
&lt;p&gt;This PEP was also &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-September/146278.html"&gt;quickly approved by Guido&lt;/a&gt;
during the CPython sprint.  Steve implemented it in Python 3.6.&lt;/p&gt;
&lt;p&gt;Even if it's smaller change, it is &lt;strong&gt;yet another change towards using UTF-8
everywhere&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="great-success"&gt;
&lt;h2&gt;Great success!&lt;/h2&gt;
&lt;p&gt;Hopefully, I was wrong about the risk of breaking the world. &lt;strong&gt;No user
complained about these two backward incompatible changes: Python 3.6 on Windows
is a success!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Python 3.6 now has a &lt;strong&gt;better Unicode support&lt;/strong&gt; on Windows thanks to the PEP
528 and PEP 529!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;September 2016: Steve Dower proposed two major backward incompatible changes
for Python 3.6 on Windows: &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0528/"&gt;PEP 528: Change Windows console encoding to UTF-8&lt;/a&gt; and &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0529/"&gt;PEP 529: Change Windows
filesystem encoding to UTF-8&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;At the first read, I was sure that the PEP 529 (filesystem encoding) will break
all applications on Windows.&lt;/p&gt;
&lt;p&gt;Thanks to the CPython core dev sprint, I was able to discuss with Steve who
reassured me and explained me his PEP 529. We agreed with Guido van Rossum to
try the change during Python 3.6 beta phase, but revert it if something bad
happens. I was honoured that Guido listened to my Unicode experience to take a
decision on the PEP.&lt;/p&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0528/"&gt;PEP 528: Change Windows console encoding to UTF-8&lt;/a&gt; was also quickly approved,
another change towards using UTF-8 everywhere.&lt;/p&gt;
&lt;p&gt;No user complained about these two backward incompatible changes: Python 3.6 on
Windows is a success!&lt;/p&gt;
&lt;p&gt;Python 3.6 now has a better Unicode support thanks on Windows to the PEP 528
and PEP 529!&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category><category term="unicode"></category></entry><entry><title>Python 3.2 Painful History of the Filesystem Encoding</title><link href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html" rel="alternate"></link><published>2018-03-15T23:00:00+01:00</published><updated>2018-03-15T23:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-15:/painful-history-python-filesystem-encoding.html</id><summary type="html">&lt;p&gt;Between Python 3.0 released in 2008 and Python 3.4 released in 2014, the Python
filesystem encoding changed multiple times. &lt;strong&gt;It took 6 years to choose the best
Python filesystem encoding on each platform.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I have been officially promoted as a core developer&lt;/strong&gt; in January 2010 by
&lt;strong&gt;Martin von …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;Between Python 3.0 released in 2008 and Python 3.4 released in 2014, the Python
filesystem encoding changed multiple times. &lt;strong&gt;It took 6 years to choose the best
Python filesystem encoding on each platform.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I have been officially promoted as a core developer&lt;/strong&gt; in January 2010 by
&lt;strong&gt;Martin von Loewis&lt;/strong&gt;. I spent the whole year of 2010 to fix dozens of encoding
issues during the development of Python 3.2, following my Unicode work started
in 2008.&lt;/p&gt;
&lt;p&gt;This article is focused on the long discussions to choose the best Python
filesystem encoding on each platform in 2010 for Python 3.2.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This article is the third in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:&lt;/strong&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;ol class="first arabic"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html"&gt;Python 3.0 listdir() Bug on Undecodable Filenames&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="2"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/pep-383.html"&gt;Python 3.1 surrogateescape error handler (PEP 383)&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="3"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html"&gt;Python 3.2 Painful History of the Filesystem Encoding&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="4"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html"&gt;Python 3.6 now uses UTF-8 on Windows&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="5"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/posix-locale.html"&gt;Python 3.7 and the POSIX locale&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="6"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html"&gt;Python 3.7 UTF-8 Mode&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;a class="reference external image-reference" href="https://commons.wikimedia.org/wiki/File:Longleat-maze.jpg"&gt;&lt;img alt="Maze" src="https://vstinner.github.io/images/maze.jpg" /&gt;&lt;/a&gt;
&lt;div class="section" id="python-3-0-loves-utf-8"&gt;
&lt;h2&gt;Python 3.0 loves UTF-8&lt;/h2&gt;
&lt;p&gt;When Python 3.0 was released, it was unclear which encodings should be used
for:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;File content: &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;open().read()&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Filenames: &lt;tt class="docutils literal"&gt;os.listdir()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;open()&lt;/tt&gt;, etc.&lt;/li&gt;
&lt;li&gt;Command line arguments: &lt;tt class="docutils literal"&gt;sys.argv&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;subprocess.Popen&lt;/tt&gt; arguments&lt;/li&gt;
&lt;li&gt;Environment variables: &lt;tt class="docutils literal"&gt;os.environ&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Python 3.0 was forked from Python 2.6 and functions were modified to use
Unicode. Many Python 3 functions only used UTF-8 because the implementation
were modified to use the default encoding which is UTF-8: it was not a
deliberate choice.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;While UTF-8 is a good choice in most cases, it is not the best choice in
all cases.&lt;/strong&gt; Almost everything worked well in Python 3.0 when all data used
UTF-8, but Python 3.0 failed badly if the locale encoding was not UTF-8.&lt;/p&gt;
&lt;p&gt;Python 3.1, 3.2 and 3.3 will get a lot of changes to adjust encodings in all
corners of the standard library.&lt;/p&gt;
&lt;p&gt;Python 3.1 got the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler (PEP 383) which reduced
Unicode errors: read my previous article &lt;a class="reference external" href="https://vstinner.github.io/pep-383.html"&gt;Python 3.1 surrogateescape error
handler (PEP 383)&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="add-sys-setfilesystemencoding"&gt;
&lt;h2&gt;Add sys.setfilesystemencoding()&lt;/h2&gt;
&lt;p&gt;September 2008, &lt;a class="reference external" href="https://bugs.python.org/issue3187"&gt;bpo-3187&lt;/a&gt;: To fix
&lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; to support undecodable filenames, &lt;strong&gt;Martin v.  Löwis&lt;/strong&gt;
&lt;a class="reference external" href="https://bugs.python.org/issue3187#msg74080"&gt;proposed a new function to change the filesystem encoding&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Here is a patch that solves the issue in a different way: it introduces
sys.setfilesystemencoding. &lt;strong&gt;If applications invoke
sys.setfilesystemencoding(&amp;quot;iso-8859-1&amp;quot;), all file names can be successfully
converted into a character string.&lt;/strong&gt;&lt;/blockquote&gt;
&lt;p&gt;The ISO-8859-1 encoding has a very interesting property for bytes: it maps
exactly the &lt;tt class="docutils literal"&gt;0x00 - 0xff&lt;/tt&gt; byte range to the U+0000 - U+00ff Unicode range,
the decoder cannot fail:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3.6 -q
&amp;gt;&amp;gt;&amp;gt; all(ord((b'%c' % byte).decode('iso-8859-1')) == byte for byte in range(256))
True
&amp;gt;&amp;gt;&amp;gt; all(ord(('%c' % char).encode('iso-8859-1')) == char for char in range(256))
True
&lt;/pre&gt;
&lt;p&gt;Guido van Rossum &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg74173"&gt;commented&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I will check in Victor's changes (with some edits).&lt;/p&gt;
&lt;p&gt;Together this means that the various &lt;strong&gt;suggested higher-level solutions&lt;/strong&gt;
(like returning path-like objects, or some kind of roudtripping
almost-but-not-quite-utf-8 encoding) &lt;strong&gt;can be implemented in pure Python&lt;/strong&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;October 2008, &lt;strong&gt;Martin v. Löwis&lt;/strong&gt; pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/04dc25c53728f5c2fe66d9e66af67da0c9b8959d"&gt;commit 04dc25c5&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Issue #3187: Add sys.setfilesystemencoding.
&lt;/pre&gt;
&lt;p&gt;Python 3.0 will be the first major release with this function.&lt;/p&gt;
&lt;p&gt;In retrospective, I see this function as asking developers and users to be
smart and choose the encoding themself.&lt;/p&gt;
&lt;p&gt;While the ISO-8859-1 encoding trick is tempting, we will see later that
&lt;tt class="docutils literal"&gt;setfilesystemencoding()&lt;/tt&gt; is broken by design and so cannot be used in
practice.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="what-if-getting-the-locale-encoding-fails"&gt;
&lt;h2&gt;What if getting the locale encoding fails?&lt;/h2&gt;
&lt;p&gt;May 2010, I reported &lt;a class="reference external" href="https://bugs.python.org/issue8610"&gt;bpo-8610&lt;/a&gt;,
&amp;quot;Python3/POSIX: errors if file system encoding is None&amp;quot;:&lt;/p&gt;
&lt;blockquote&gt;
On POSIX (but not on Mac OS X), Python3 calls get_codeset() to get the file
system encoding. If this function fails, sys.getfilesystemencoding()
returns None.&lt;/blockquote&gt;
&lt;p&gt;I pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/b744ba1d14c5487576c95d0311e357b707600b47"&gt;commit b744ba1d&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Issue #8610: Load file system codec at startup, and &lt;strong&gt;display a fatal error
on failure&lt;/strong&gt;. &lt;strong&gt;Set the file system encoding to utf-8&lt;/strong&gt; (instead of None)
&lt;strong&gt;if getting the locale encoding failed&lt;/strong&gt;, or if nl_langinfo(CODESET)
function is missing.&lt;/blockquote&gt;
&lt;p&gt;This change &lt;strong&gt;adds the function initfsencoding()&lt;/strong&gt;: logic to initialize the
filesystem encoding.&lt;/p&gt;
&lt;p&gt;In practice, Python already used UTF-8 when the filesystem encoding was set to
&lt;tt class="docutils literal"&gt;None&lt;/tt&gt;, but this change makes the default more obvious. The change also makes
the error case better defined: Python exits immediately with a fatal error.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="support-locale-encodings-different-than-utf-8"&gt;
&lt;h2&gt;Support locale encodings different than UTF-8&lt;/h2&gt;
&lt;p&gt;My biggest Unicode project in Python 3 was to &lt;strong&gt;fix the encoding&lt;/strong&gt; in all
corners of the standard library. This task kept me busy between Python 3.0 and
Python 3.4, at least.&lt;/p&gt;
&lt;p&gt;May 2010, I created &lt;a class="reference external" href="https://bugs.python.org/issue8611"&gt;bpo-8611&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;Python3 is unable to start&lt;/strong&gt; (bootstrap failure) on a POSIX system &lt;strong&gt;if
the locale encoding is different than utf8 and the Python path&lt;/strong&gt; (standard
library path where the encoding module is stored) &lt;strong&gt;contains a non-ASCII
character&lt;/strong&gt;. (Windows and Mac OS X are not affected by this issue because
the file system encoding is hardcoded.)&lt;/blockquote&gt;
&lt;p&gt;For example, &lt;a class="reference external" href="https://bugs.python.org/issue8242"&gt;bpo-8242&lt;/a&gt; &amp;quot;Improve support
of PEP 383 (surrogates) in Python3&amp;quot; is a meta issue tracking multiple issues:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue7606"&gt;bpo-7606&lt;/a&gt;:
test_xmlrpc fails with non-ascii path&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8092"&gt;bpo-8092&lt;/a&gt;:
utf8, backslashreplace and surrogates&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8383"&gt;bpo-8383&lt;/a&gt;:
pickle is unable to encode unicode surrogates&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8390"&gt;bpo-8390&lt;/a&gt;:
tarfile: use surrogates for undecode fields&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8391"&gt;bpo-8391&lt;/a&gt;:
os.execvpe() doesn't support surrogates in env&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8393"&gt;bpo-8393&lt;/a&gt;:
subprocess: support undecodable current working directory on POSIX OS&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8394"&gt;bpo-8394&lt;/a&gt;:
ctypes.dlopen() doesn't support surrogates&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8412"&gt;bpo-8412&lt;/a&gt;:
os.system() doesn't support surrogates nor bytes&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8467"&gt;bpo-8467&lt;/a&gt;:
subprocess: surrogates of the error message (Python implementation on non-Windows)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8468"&gt;bpo-8468&lt;/a&gt;:
bz2: support surrogates in filename, and bytes/bytearray filename&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8477"&gt;bpo-8477&lt;/a&gt;:
_ssl: support surrogates in filenames, and bytes/bytearray filenames&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8485"&gt;bpo-8485&lt;/a&gt;:
Don't accept bytearray as filenames, or simplify the API&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I fixed all these issues, and reported most of them.&lt;/p&gt;
&lt;p&gt;October 2010, finally, five months later, I succeeded to close the issue!&lt;/p&gt;
&lt;blockquote&gt;
Starting at r85691, the full test suite of Python 3.2 pass with ASCII,
ISO-8859-1 and UTF-8 locale encodings in a non-ascii directory.
&lt;strong&gt;The work on this issue is done.&lt;/strong&gt;&lt;/blockquote&gt;
&lt;p&gt;At that time, I didn't know that it will take me a few more years to really fix
&lt;strong&gt;all&lt;/strong&gt; encoding issues. For example, it will take me &lt;strong&gt;3 years&lt;/strong&gt; to modify the
core of the import machinery to pass filenames as Unicode on Windows: &lt;a class="reference external" href="https://bugs.python.org/issue3080"&gt;bpo-3080&lt;/a&gt; &lt;strong&gt;Full unicode import system&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="add-pythonfsencoding-environment-variable"&gt;
&lt;h2&gt;Add PYTHONFSENCODING environment variable&lt;/h2&gt;
&lt;p&gt;May 2010, while discussing how to fix &lt;a class="reference external" href="https://bugs.python.org/issue8610"&gt;bpo-8610&lt;/a&gt; &amp;quot;Python3/POSIX: errors if file system
encoding is None&amp;quot;, I asked what is the best encoding if reading the locale
encoding fails. As a follow-up, &lt;strong&gt;Marc-Andre Lemburg&lt;/strong&gt; created &lt;a class="reference external" href="https://bugs.python.org/issue8622"&gt;bpo-8622&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;As discussed on issue8610, we need a way to &lt;strong&gt;override the automatic
detection of the file system encoding&lt;/strong&gt; - for much the same reasons we also
do for the I/O encoding: the detection mechanism isn't fail-safe.&lt;/p&gt;
&lt;p&gt;We should add a new environment variable with the same functionality as
&lt;tt class="docutils literal"&gt;PYTHONIOENCODING&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PYTHONFSENCODING: Encoding[:errors] used for file system.
&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;I implemented the idea since I liked it. August 2010, I pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/94908bbc1503df830d1d615e7b57744ae1b41079"&gt;commit
94908bbc&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Issue #8622: Add &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt; environment variable to override the
filesystem encoding.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;initfsencoding()&lt;/tt&gt; displays also a better error message
if &lt;tt class="docutils literal"&gt;get_codeset()&lt;/tt&gt; failed.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="remove-sys-setfilesystemencoding"&gt;
&lt;h2&gt;Remove sys.setfilesystemencoding()&lt;/h2&gt;
&lt;p&gt;August 2010, just after adding &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt;, I opened &lt;a class="reference external" href="https://bugs.python.org/issue9632"&gt;bpo-9632&lt;/a&gt; to remove the
&lt;tt class="docutils literal"&gt;sys.setfilesystemencoding()&lt;/tt&gt; function:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;sys.setfilesystemencoding()&lt;/tt&gt; function is &lt;strong&gt;dangerous&lt;/strong&gt; because it
introduces a lot of inconsistencies: this function is &lt;strong&gt;unable to reencode
all filenames&lt;/strong&gt; of all objects (eg. Python is unable to find filenames in
user objects or 3rd party libraries). Eg. if you change the filesystem from
utf8 to ascii, it will not be possible to use existing non-ascii (unicode)
filenames: they will raise UnicodeEncodeError.&lt;/p&gt;
&lt;p&gt;As &lt;tt class="docutils literal"&gt;sys.setdefaultencoding()&lt;/tt&gt; in Python2, I think that
&lt;tt class="docutils literal"&gt;sys.setfilesystemencoding()&lt;/tt&gt; is the &lt;strong&gt;root of evil&lt;/strong&gt; :-)
&lt;strong&gt;PYTHONFSENCODING&lt;/strong&gt; (issue #8622) &lt;strong&gt;is the right solution&lt;/strong&gt; to set the
filesysteme encoding.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Marc-Andre Lemburg&lt;/strong&gt; complained that applications embedding Python may want
to set the encoding used by Python. I proposed to use the &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt;
environment variable as a workaround, even if it was not the best option.&lt;/p&gt;
&lt;p&gt;One month later, I pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/5b519e02016ea3a51f784dee70eead3be4ab1aff"&gt;commit 5b519e02&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Issue #9632: Remove &lt;tt class="docutils literal"&gt;sys.setfilesystemencoding()&lt;/tt&gt; function: use
&lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt; environment variable to set the filesystem encoding at
Python startup.  &lt;tt class="docutils literal"&gt;sys.setfilesystemencoding()&lt;/tt&gt; created inconsistencies
because it was unable to reencode all filenames of all objects.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="reencode-filenames-when-setting-the-filesystem-encoding"&gt;
&lt;h2&gt;Reencode filenames when setting the filesystem encoding&lt;/h2&gt;
&lt;p&gt;August 2010, I created &lt;a class="reference external" href="https://bugs.python.org/issue9630"&gt;bpo-9630&lt;/a&gt;:
&amp;quot;Reencode filenames when setting the filesystem encoding&amp;quot;.&lt;/p&gt;
&lt;p&gt;Since the beginning of 2010, I identified a design flaw in the Python
initialization. Python starts by &lt;strong&gt;decoding strings from the default encoding
UTF-8&lt;/strong&gt;. Later, Python reads the locale encoding and loads the Python codec of
this encoding. Then Python &lt;strong&gt;decodes string from the locale encoding&lt;/strong&gt;.
Problem: if the locale encoding is not UTF-8, &lt;strong&gt;encoding strings decoded from
UTF-8 to the locale encoding can fail&lt;/strong&gt; in different ways.&lt;/p&gt;
&lt;p&gt;I wrote a patch to &amp;quot;reencode&amp;quot; filenames of all module and code objects once the
filesystem encoding is set, in &lt;tt class="docutils literal"&gt;initfsencoding()&lt;/tt&gt;,&lt;/p&gt;
&lt;p&gt;When I wrote the patch, I knew that it was an &lt;strong&gt;ugly hack and not the proper
design&lt;/strong&gt;. I proposed to try to avoid importing any Python module before the Python
codec of the locale encoding is loaded, but there was a pratical issue. Python
only has builtin implementation (written in C) of the most popular encodings
like ASCII and UTF-8. Some encodings like ISO-8859-15 are only implemented in
Python.&lt;/p&gt;
&lt;p&gt;I also proposed to &amp;quot;unload all modules, clear all caches and delete all code
objects&amp;quot; after setting the filesystem encoding. This option would be very
inefficient and make Python startup slower, whereas Python 3 startup was already
way slower than Python 2 startup.&lt;/p&gt;
&lt;p&gt;September 2010, I pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/c39211f51e377919952b139c46e295800cbc2a8d"&gt;commit c39211f5&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Issue #9630: Redecode filenames when setting the filesystem encoding&lt;/p&gt;
&lt;p&gt;Redecode the filenames of:&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;all modules: __file__ and __path__ attributes&lt;/li&gt;
&lt;li&gt;all code objects: co_filename attribute&lt;/li&gt;
&lt;li&gt;sys.path&lt;/li&gt;
&lt;li&gt;sys.meta_path&lt;/li&gt;
&lt;li&gt;sys.executable&lt;/li&gt;
&lt;li&gt;sys.path_importer_cache (keys)&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;Keep weak references to all code objects until &lt;tt class="docutils literal"&gt;initfsencoding()&lt;/tt&gt; is
called, to be able to redecode co_filename attribute of all code objects.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The list of weak references to code objects really looks like a hack and I
disliked it, but I failed to find a better way to fix Python startup.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pythonfsencoding-dead-end"&gt;
&lt;h2&gt;PYTHONFSENCODING dead end&lt;/h2&gt;
&lt;p&gt;Even with my latest big and ugly &amp;quot;redecode filenames when setting the
filesystem encoding&amp;quot; fix, there were &lt;strong&gt;issues when the filesystem encoding was
different than the locale encoding&lt;/strong&gt;. I identified 4 bugs:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue9992"&gt;bpo-9992&lt;/a&gt;, &lt;tt class="docutils literal"&gt;sys.argv&lt;/tt&gt;: decoded from the &lt;strong&gt;locale&lt;/strong&gt; encoding, but subprocess encodes process arguments to the &lt;strong&gt;filesystem&lt;/strong&gt; encoding&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue10014"&gt;bpo-10014&lt;/a&gt;, &lt;tt class="docutils literal"&gt;sys.path&lt;/tt&gt;: decoded from the &lt;strong&gt;locale&lt;/strong&gt; encoding, but import encodes paths to the &lt;strong&gt;filesystem&lt;/strong&gt; encoding&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue10039"&gt;bpo-10039&lt;/a&gt;, the script name: read on the command line
(ex: &lt;tt class="docutils literal"&gt;python script.py&lt;/tt&gt;) which is decoded from the locale encoding, whereas
it is used to fill &lt;tt class="docutils literal"&gt;sys.path[0]&lt;/tt&gt; and import encodes paths to the
&lt;strong&gt;filesystem&lt;/strong&gt; encoding.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue9988"&gt;bpo-9988&lt;/a&gt;, &lt;tt class="docutils literal"&gt;PYTHONWARNINGS&lt;/tt&gt; environment variable: decoded from the
&lt;strong&gt;locale&lt;/strong&gt; encoding, but &lt;tt class="docutils literal"&gt;subprocess&lt;/tt&gt; encodes environment variables to the
&lt;strong&gt;filesystem&lt;/strong&gt; encoding.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;October 2010, I wrote an email to the python-dev list: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2010-October/104509.html"&gt;Inconsistencies if
locale and filesystem encodings are different&lt;/a&gt;. I
proposed two solutions:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;(a) use the same encoding to encode and decode values (it can be different
for each issue).&lt;/li&gt;
&lt;li&gt;(b) &lt;strong&gt;remove PYTHONFSENCODING variable&lt;/strong&gt; and raise an error if locale and
filesystem encodings are different (ensure that both encodings are the same).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Marc-Andre Lemburg&lt;/strong&gt; &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2010-October/104511.html"&gt;replied&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;You have to differentiate between the meaning of a file system
encoding and the locale:&lt;/p&gt;
&lt;p&gt;A file system encoding defines how the applications interact
with the file system.&lt;/p&gt;
&lt;p&gt;A locale defines how the user expects to interact with the
application.&lt;/p&gt;
&lt;p&gt;It is well possible that the two are different. Mac OS X is
just one example. Another common example is having a Unix
account using the C locale (=ASCII) while working on a UTF-8
file system.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This email is a good example of dilemma we had when having to choose &lt;strong&gt;one&lt;/strong&gt;
encoding. There is a big temptation to use multiple encodings, but at the end,
&lt;strong&gt;data are not isolated&lt;/strong&gt;. A filename can be found in command line arguments
(&lt;tt class="docutils literal"&gt;python3 script.py file.txt&lt;/tt&gt;), in environment variables
(&lt;tt class="docutils literal"&gt;LOG_FILE=log.txt&lt;/tt&gt;), in file content (ex: &lt;tt class="docutils literal"&gt;Makefile&lt;/tt&gt; or a configuration
file), etc. Using multiple encodings does not work in practice.&lt;/p&gt;
&lt;img alt="Dead end" src="https://vstinner.github.io/images/dead_end.jpg" /&gt;
&lt;/div&gt;
&lt;div class="section" id="remove-pythonfsencoding"&gt;
&lt;h2&gt;Remove PYTHONFSENCODING&lt;/h2&gt;
&lt;p&gt;September 2010, I reported &lt;a class="reference external" href="https://bugs.python.org/issue9992"&gt;bpo-9992&lt;/a&gt;:
Command-line arguments are not correctly decoded if locale and fileystem
encodings are different.&lt;/p&gt;
&lt;p&gt;I proposed a patch to use the &lt;strong&gt;locale encoding&lt;/strong&gt; to decode and encode command
line arguments, rather than using the &lt;strong&gt;filesystem encoding&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Martin v. Löwis&lt;/strong&gt; proposed to use the &lt;strong&gt;locale encoding&lt;/strong&gt; for the command
line arguments, environment variables and all filenames. &lt;a class="reference external" href="https://bugs.python.org/issue9992#msg118352"&gt;My summary&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;You mean that we should use the following encoding:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Mac OS X: UTF-8&lt;/li&gt;
&lt;li&gt;Windows: unicode for command line/env, mbcs to decode filenames&lt;/li&gt;
&lt;li&gt;others OSes: &lt;strong&gt;locale encoding&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To do that, we have to:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&amp;quot;others OSes&amp;quot;: &lt;strong&gt;delete the PYTHONFSENCODING variable&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Mac OS X: use UTF-8 to decode the command line arguments (we can use
&lt;tt class="docutils literal"&gt;PyUnicode_DecodeUTF8()&lt;/tt&gt; + &lt;tt class="docutils literal"&gt;PyUnicode_AsWideCharString()&lt;/tt&gt; before
Python is initialized)&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;October 2010, I pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/8f6b6b0cc3febd15e33a96bd31dcb3cbef2ad1ac"&gt;commit 8f6b6b0c&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Issue #9992: Remove PYTHONFSENCODING environment variable.&lt;/blockquote&gt;
&lt;p&gt;Two days later, I pushed an important change to &lt;strong&gt;use the locale encoding&lt;/strong&gt; and
remove the ugly &lt;tt class="docutils literal"&gt;redecode_filenames()&lt;/tt&gt; hack, &lt;a class="reference external" href="https://github.com/python/cpython/commit/f3170ccef8809e4a3f82fe9f82dc7a4a486c28c1"&gt;commit f3170cce&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Use locale encoding if &lt;tt class="docutils literal"&gt;Py_FileSystemDefaultEncoding&lt;/tt&gt; is not set&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PyUnicode_EncodeFSDefault()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;PyUnicode_DecodeFSDefaultAndSize()&lt;/tt&gt;
and &lt;tt class="docutils literal"&gt;PyUnicode_DecodeFSDefault()&lt;/tt&gt; use the locale encoding instead of
UTF-8 if &lt;tt class="docutils literal"&gt;Py_FileSystemDefaultEncoding&lt;/tt&gt; is &lt;tt class="docutils literal"&gt;NULL&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;redecode_filenames()&lt;/tt&gt; functions and &lt;tt class="docutils literal"&gt;_Py_code_object_list&lt;/tt&gt; (issue #9630)
are no more needed: remove them&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;This change has been made possible by enhancements of
&lt;tt class="docutils literal"&gt;PyUnicode_EncodeFSDefault()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;PyUnicode_DecodeFSDefaultAndSize()&lt;/tt&gt;.
Previously, &lt;strong&gt;these functions used UTF-8&lt;/strong&gt; before the filesystem was set. With
my change, these functions &lt;strong&gt;now use the C implementation of the locale
encoding&lt;/strong&gt;: use &lt;tt class="docutils literal"&gt;mbstowcs()&lt;/tt&gt; to decode and &lt;tt class="docutils literal"&gt;wcstombs()&lt;/tt&gt; to encode.  In
practice, the code is more complex because Python uses the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt;
error handler.&lt;/p&gt;
&lt;p&gt;Using the C implementation of the locale encoding fixed a lot of &amp;quot;bootstrap&amp;quot;
issues of the Python initialization. It works because &lt;strong&gt;the Python codec of the
locale encoding is 100% compatible with the C implementation&lt;/strong&gt; of the locale
codec.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="encodings-used-by-python-3-2"&gt;
&lt;h2&gt;Encodings used by Python 3.2&lt;/h2&gt;
&lt;p&gt;February 2011, Python 3.2 has been released. Summary of the used filesystem
encodings:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;strong&gt;ANSI code page&lt;/strong&gt; on Windows;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;UTF-8&lt;/strong&gt; on macOS;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;locale encoding&lt;/strong&gt; on other platforms.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note: UTF-8 is used if the &lt;tt class="docutils literal"&gt;nl_langinfo(CODESET)&lt;/tt&gt; function is not available.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="force-ascii-encoding-on-freebsd-and-solaris"&gt;
&lt;h2&gt;Force ASCII encoding on FreeBSD and Solaris&lt;/h2&gt;
&lt;p&gt;November 2012, I created &lt;a class="reference external" href="https://bugs.python.org/issue16455"&gt;bpo-16455&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;On FreeBSD and OpenIndiana, &lt;tt class="docutils literal"&gt;sys.getfilesystemencoding()&lt;/tt&gt; returns
&lt;tt class="docutils literal"&gt;'ascii'&lt;/tt&gt; when the locale is not set, whereas the locale encoding is
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;ISO-8859-1&lt;/span&gt;&lt;/tt&gt; in practice.&lt;/p&gt;
&lt;p&gt;This inconsistency causes different issues.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;December 2012, I pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/d45c7f8d74d30de0a558b10e04541b861428b7c1"&gt;commit d45c7f8d&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Issue #16455: On FreeBSD and Solaris, if the locale is C, the
ASCII/surrogateescape codec is now used, instead of the locale encoding, to
decode the command line arguments. This change fixes inconsistencies with
os.fsencode() and os.fsdecode() because these operating systems announces
an ASCII locale encoding, whereas the ISO-8859-1 encoding is used in
practice.&lt;/blockquote&gt;
&lt;p&gt;Extract of the main comment:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Workaround FreeBSD and OpenIndiana locale encoding issue with the C locale.
On these operating systems, &lt;strong&gt;nl_langinfo(CODESET) announces an alias of
the ASCII encoding, whereas mbstowcs() and wcstombs() functions use the
ISO-8859-1 encoding&lt;/strong&gt;. The problem is that os.fsencode() and
&lt;tt class="docutils literal"&gt;os.fsdecode()&lt;/tt&gt; use &lt;tt class="docutils literal"&gt;locale.getpreferredencoding()&lt;/tt&gt; codec. For example,
if command line arguments are decoded by &lt;tt class="docutils literal"&gt;mbstowcs()&lt;/tt&gt; and encoded back by
&lt;tt class="docutils literal"&gt;os.fsencode()&lt;/tt&gt;, we get a &lt;tt class="docutils literal"&gt;UnicodeEncodeError&lt;/tt&gt; instead of retrieving
the original byte string.&lt;/p&gt;
&lt;p&gt;The workaround is enabled if &lt;tt class="docutils literal"&gt;setlocale(LC_CTYPE, NULL)&lt;/tt&gt; returns &lt;tt class="docutils literal"&gt;&amp;quot;C&amp;quot;&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;nl_langinfo(CODESET)&lt;/tt&gt; announces &lt;tt class="docutils literal"&gt;&amp;quot;ascii&amp;quot;&lt;/tt&gt; (or an alias to ASCII), and
at least one byte in range 0x80-0xff can be decoded from the locale
encoding. The workaround is also enabled on error, for example if getting
the locale failed.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Python 3.4 will be the first major release getting fix (March 2014), but I also
backported the change to Python 3.2 and 3.3 branches.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;It took 6 years&lt;/strong&gt; to fix Python to use the best Python filesystem encoding.&lt;/p&gt;
&lt;p&gt;Python 3.0 mostly uses UTF-8 everywhere, but it was not a deliberate choice and
it caused many issues when the locale encoding was not UTF-8. Python 3.1 got
the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler (PEP 383) which reduced Unicode errors.&lt;/p&gt;
&lt;p&gt;October 2008, &lt;strong&gt;Martin v. Löwis&lt;/strong&gt; added &lt;tt class="docutils literal"&gt;sys.setfilesystemencoding()&lt;/tt&gt; to
Python 3.0.&lt;/p&gt;
&lt;p&gt;August 2010, I added a new &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt; environment variable,
&lt;strong&gt;Marc-Andre Lemburg&lt;/strong&gt;'s idea.&lt;/p&gt;
&lt;p&gt;September 2010, I removed the &lt;tt class="docutils literal"&gt;sys.setfilesystemencoding()&lt;/tt&gt; function because
it creates mojibake by design. I also pushed an ugly change to reencode
filenames to fix many &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt; bugs.&lt;/p&gt;
&lt;p&gt;October 2010, I fixed all tests when Python lives in a non-ASCII directory:
first milestone of supporting locale encodings different than UTF-8. I also
removed the &lt;tt class="docutils literal"&gt;PYTHONFSENCODING&lt;/tt&gt; environment variable after a long discussion.
Moreover, I pushed the most important Python 3.2 change: &lt;strong&gt;Python now uses the
locale encoding as the filesystem encoding&lt;/strong&gt;. This change fixed many issues.&lt;/p&gt;
&lt;p&gt;December 2012, I forced the filesystem encoding to ASCII on FreeBSD and Solaris
when the announced locale encoding is wrong.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category><category term="unicode"></category></entry><entry><title>Python 3.1 surrogateescape error handler (PEP 383)</title><link href="https://vstinner.github.io/pep-383.html" rel="alternate"></link><published>2018-03-15T18:00:00+01:00</published><updated>2018-03-15T18:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-15:/pep-383.html</id><summary type="html">&lt;p&gt;In my previous article, I wrote that &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; ignored silently
undecodable filenames in Python 3.0 and that lying on the real content of a
directory looks like a very bad idea.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Martin v. Löwis&lt;/strong&gt; found a very smart solution to this problem: the
&lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This …&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;In my previous article, I wrote that &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; ignored silently
undecodable filenames in Python 3.0 and that lying on the real content of a
directory looks like a very bad idea.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Martin v. Löwis&lt;/strong&gt; found a very smart solution to this problem: the
&lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This article is the second in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:&lt;/strong&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;ol class="first arabic"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html"&gt;Python 3.0 listdir() Bug on Undecodable Filenames&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="2"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/pep-383.html"&gt;Python 3.1 surrogateescape error handler (PEP 383)&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="3"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html"&gt;Python 3.2 Painful History of the Filesystem Encoding&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="4"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html"&gt;Python 3.6 now uses UTF-8 on Windows&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="5"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/posix-locale.html"&gt;Python 3.7 and the POSIX locale&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="6"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html"&gt;Python 3.7 UTF-8 Mode&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="first-attempt-to-propose-the-solution"&gt;
&lt;h2&gt;First attempt to propose the solution&lt;/h2&gt;
&lt;p&gt;September 2008, &lt;a class="reference external" href="https://bugs.python.org/issue3187"&gt;bpo-3187&lt;/a&gt;: While
solutions to fix &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; were discussed, &lt;strong&gt;Martin v. Löwis&lt;/strong&gt;
&lt;a class="reference external" href="https://bugs.python.org/issue3187#msg73992"&gt;proposed a different approach&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I'd like to propose yet another approach: make sure that &lt;strong&gt;conversion&lt;/strong&gt;
according to the file system encoding &lt;strong&gt;always succeeds&lt;/strong&gt;. &lt;strong&gt;If an
unconvertable byte is detected, map it into some private-use character.&lt;/strong&gt;
To reduce the chance of conflict with other people's private-use
characters, we can use some of the plane 15 private-use characters, e.g.
map byte 0xPQ to U+F30PQ (in two-byte Unicode mode, this would result in
a surrogate pair).&lt;/p&gt;
&lt;p&gt;This would make all file names accessible to all text processing
(including glob and friends); UI display would typically either report
an encoding error, or arrange for some replacement glyph to be shown.&lt;/p&gt;
&lt;p&gt;There are certain variations of the approach possible, in case there is
objection to a specific detail.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;He amended this proposal:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;James Knight&lt;/strong&gt; points out that UTF-8b can be used to give unambiguous
round-tripping of characters in a UTF-8 locale. So I would like to amend my
previous proposal:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;for a non-UTF-8 encoding, use private-use characters for roundtripping&lt;/li&gt;
&lt;li&gt;if the locale's charset is UTF-8, use UTF-8b as the file system encoding.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;But Martin's smart idea was lost&lt;/strong&gt; in the middle of long discussion.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://github.com/loewis"&gt;&lt;img alt="Martin v. Löwis" src="https://vstinner.github.io/images/martin_von_loewis.jpg" /&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-383"&gt;
&lt;h2&gt;PEP 383&lt;/h2&gt;
&lt;p&gt;April 2009, Martin v. Löwis proposed again his idea, now as the well defined
&lt;a class="reference external" href="http://www.python.org/dev/peps/pep-0383"&gt;PEP 383&lt;/a&gt;: &lt;strong&gt;Non-decodable Bytes in System Character Interfaces&lt;/strong&gt;. He &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2009-April/088919.html"&gt;posted
his PEP to python-dev&lt;/a&gt; for
comments.&lt;/p&gt;
&lt;p&gt;Abstract:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;File names, environment variables, and command line arguments are defined
as being character data in POSIX; the C APIs however allow passing
arbitrary bytes - whether these conform to a certain encoding or not.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This PEP proposes a means of dealing with such irregularities by embedding
the bytes in character strings in such a way that allows recreation of the
original byte string.&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; encoding is based on &lt;strong&gt;Markus Kuhn&lt;/strong&gt;'s idea that he
called &lt;strong&gt;UTF-8b&lt;/strong&gt;. Undecodable bytes in range &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;0x80-0xff&lt;/span&gt;&lt;/tt&gt; are mapped as
Unicode surrogate characters: range &lt;tt class="docutils literal"&gt;U+DC80&lt;/tt&gt; - &lt;tt class="docutils literal"&gt;U+DCFF&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;gt;&amp;gt;&amp;gt; b'nonascii\xff'.decode('ascii')
UnicodeDecodeError: 'ascii' codec can't decode byte 0xff (...)
&amp;gt;&amp;gt;&amp;gt; b'nonascii\xff'.decode('ascii', 'surrogateescape')
'nonascii\udcff'
&amp;gt;&amp;gt;&amp;gt; 'nonascii\udcff'.encode('ascii', 'surrogateescape')
b'nonascii\xff'
&lt;/pre&gt;
&lt;p&gt;Using the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler, &lt;strong&gt;decoding cannot fail&lt;/strong&gt;.  For
example, &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; no longer ignores silently undecodable filenames,
since all filenames became decodable with any encoding. Moreover, encoding
filenames with &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; returns the original bytes unchanged.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2009-April/089278.html"&gt;The PEP was accepted&lt;/a&gt; by
&lt;strong&gt;Guido van Rossum&lt;/strong&gt; in less than one week!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="implementation"&gt;
&lt;h2&gt;Implementation&lt;/h2&gt;
&lt;p&gt;May 2009, Martin v. Löwis opened the &lt;a class="reference external" href="https://bugs.python.org/issue5915"&gt;bpo-5915&lt;/a&gt; to get a review on his implementation.&lt;/p&gt;
&lt;p&gt;Two days later, after &lt;strong&gt;Benjamin Peterson&lt;/strong&gt; and &lt;strong&gt;Antoine Pitrou&lt;/strong&gt; reviews,
Martin pushed the &lt;a class="reference external" href="https://github.com/python/cpython/commit/011e8420339245f9b55d41082ec6036f2f83a182"&gt;commit 011e8420&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Issue #5915: Implement PEP 383, Non-decodable Bytes
in System Character Interfaces.&lt;/blockquote&gt;
&lt;p&gt;Five days later, Martin renamed his &amp;quot;utf8b&amp;quot; error handler to its final name
&lt;strong&gt;surrogateescape&lt;/strong&gt;, &lt;a class="reference external" href="https://github.com/python/cpython/commit/43c57785d3319249c03c3fa46c9df42a8ccd3e52"&gt;commit 43c57785&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Rename utf8b error handler to surrogateescape.&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Python 3.1&lt;/strong&gt; will be the first release getting the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error
handler.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;In Python 3.0, &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; ignored silently undecodable filenames which
was not ideal.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Martin v. Löwis&lt;/strong&gt; proposed to apply &lt;strong&gt;Markus Kuhn&lt;/strong&gt;'s idea called &lt;strong&gt;UTF-8b&lt;/strong&gt;
in Python as a new &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler.&lt;/p&gt;
&lt;p&gt;Martin's PEP was approved in less than one week and implemented a few days
later.&lt;/p&gt;
&lt;p&gt;Using the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler, decoding cannot fail:
&lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; no longer ignores silently undecodable filenames.
Moreover, encoding filenames with &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; returns the original
bytes unchanged.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt; error handler fixed a lot of old and very complex
Unicode issues on Unix. It is still widely used in Python 3.6 to &lt;strong&gt;not annoy
users with Unicode errors&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category><category term="unicode"></category></entry><entry><title>Python 3.0 listdir() Bug on Undecodable Filenames</title><link href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html" rel="alternate"></link><published>2018-03-09T13:00:00+01:00</published><updated>2018-03-09T13:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-09:/python30-listdir-undecodable-filenames.html</id><summary type="html">&lt;p&gt;Ten years ago, when Python 3.0 final was released, &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt;
&lt;strong&gt;ignored silently undecodable filenames&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3.0
&amp;gt;&amp;gt;&amp;gt; os.mkdir(b'x')
&amp;gt;&amp;gt;&amp;gt; open(b'x/nonascii\xff', 'w').close()
&amp;gt;&amp;gt;&amp;gt; os.listdir('x')
[]
&lt;/pre&gt;
&lt;p&gt;You had to use bytes to see all filenames:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;gt;&amp;gt;&amp;gt; os.listdir(b'x')
[b'nonascii\xff']
&lt;/pre&gt;
&lt;p&gt;If the locale is POSIX …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Ten years ago, when Python 3.0 final was released, &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt;
&lt;strong&gt;ignored silently undecodable filenames&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3.0
&amp;gt;&amp;gt;&amp;gt; os.mkdir(b'x')
&amp;gt;&amp;gt;&amp;gt; open(b'x/nonascii\xff', 'w').close()
&amp;gt;&amp;gt;&amp;gt; os.listdir('x')
[]
&lt;/pre&gt;
&lt;p&gt;You had to use bytes to see all filenames:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;gt;&amp;gt;&amp;gt; os.listdir(b'x')
[b'nonascii\xff']
&lt;/pre&gt;
&lt;p&gt;If the locale is POSIX or C, listdir() ignored silently all non-ASCII
filenames.  Hopefully, &lt;tt class="docutils literal"&gt;os.listdir()&lt;/tt&gt; accepts &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;, right? In fact, 4
months before the 3.0 final release, it was not the case.&lt;/p&gt;
&lt;p&gt;Lying on the real content of a directory looks like a very bad idea. Well,
there is a rationale behind this design. Let me tell you this story which is
now 10 years old.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This article is the first in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:&lt;/strong&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;ol class="first arabic"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html"&gt;Python 3.0 listdir() Bug on Undecodable Filenames&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="2"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/pep-383.html"&gt;Python 3.1 surrogateescape error handler (PEP 383)&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="3"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html"&gt;Python 3.2 Painful History of the Filesystem Encoding&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="4"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html"&gt;Python 3.6 now uses UTF-8 on Windows&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="5"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/posix-locale.html"&gt;Python 3.7 and the POSIX locale&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol class="first arabic" start="6"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html"&gt;Python 3.7 UTF-8 Mode&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="the-os-walk-bug"&gt;
&lt;h2&gt;The os.walk() bug&lt;/h2&gt;
&lt;a class="reference external image-reference" href="http://www.dailymail.co.uk/news/article-3592525/Classic-crashes-Incredible-black-white-photos-chaos-roads-early-days-automobile-beautiful-vintage-motors-smashing-trees-careering-canals-plummeting-bridges.html"&gt;&lt;img alt="Boston Herald-Traveler photographer Leslie Jones had an eye for a dramatic scene, including when this seven-tonne dump truck plunged through the Warren Avenue bridge, in Boston" src="https://vstinner.github.io/images/car_accident_hole.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue3187"&gt;bpo-3187&lt;/a&gt;, june 2008: &lt;strong&gt;Helmut
Jarausch&lt;/strong&gt; tested the &lt;strong&gt;first beta release of Python 3.0&lt;/strong&gt; and reported a bug
on &lt;tt class="docutils literal"&gt;os.walk()&lt;/tt&gt; when he tried to walk into his home directory:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Traceback (most recent call last):
  File &amp;quot;WalkBug.py&amp;quot;, line 5, in &amp;lt;module&amp;gt;
    for Dir, SubDirs, Files in os.walk('/home/jarausch') :
  File &amp;quot;/usr/local/lib/python3.0/os.py&amp;quot;, line 278, in walk
    for x in walk(path, topdown, onerror, followlinks):
  File &amp;quot;/usr/local/lib/python3.0/os.py&amp;quot;, line 268, in walk
    if isdir(join(top, name)):
  File &amp;quot;/usr/local/lib/python3.0/posixpath.py&amp;quot;, line 64, in join
    if b.startswith('/'):
TypeError: expected an object with the buffer interface
&lt;/pre&gt;
&lt;p&gt;In Python 3.0b1, &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; returned undecodable filenames as
&lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;. The caller must be prepared to get filenames as two types: &lt;tt class="docutils literal"&gt;str&lt;/tt&gt;
and &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;: it wasn't the case for &lt;tt class="docutils literal"&gt;os.walk()&lt;/tt&gt; which failed with a
&lt;tt class="docutils literal"&gt;TypeError&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;At the first look, the bug seems trivial to fix. In fact, many solutions were
proposed, it will take 4 months and 79 messages to fix the bug&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="i-proposed-a-new-filename-class"&gt;
&lt;h2&gt;I proposed a new Filename class&lt;/h2&gt;
&lt;p&gt;August 2008, &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg71612"&gt;my first comment proposed&lt;/a&gt; to use a custom &amp;quot;Filename&amp;quot; type
to store the original &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; filename, but also gives a Unicode view of the
filename, in a single object, using an hypothetical &lt;tt class="docutils literal"&gt;myformat()&lt;/tt&gt; function:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
class Filename:
    def __init__(self, orig):
        self.as_bytes = orig
        self.as_str = myformat(orig)
    def __str__(self):
        return self.as_str
    def __bytes__(self):
        return self.as_bytes
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Antoine Pitrou&lt;/strong&gt; suggested to inherit from &lt;tt class="docutils literal"&gt;str&lt;/tt&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I agree that logically it's the right solution. It's also the most
invasive. If that class is &lt;strong&gt;made a subclass of str&lt;/strong&gt;, however, existing
code shouldn't break more than it currently does.&lt;/blockquote&gt;
&lt;p&gt;I preferred to inherit from &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; for pratical reasons. Antoine noted that
the native type for filenames on Windows is &lt;tt class="docutils literal"&gt;str&lt;/tt&gt;, and so inheriting from
&lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; can be an issue on Windows.&lt;/p&gt;
&lt;p&gt;Anyway, &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg71749"&gt;Guido van Rossum disliked the idea&lt;/a&gt; (comment on InvalidFilename, a
variant of the class):&lt;/p&gt;
&lt;blockquote&gt;
I'm not interested in the InvalidFilename class; it's an API complification
that might seem right for your situation but &lt;strong&gt;will hinder most other
people&lt;/strong&gt;.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="guido-van-rossum-proposed-to-use-replace-error-handler"&gt;
&lt;h2&gt;Guido van Rossum proposed to use replace error handler&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Guido van Rossum&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg71655"&gt;proposed to use the replace error handler&lt;/a&gt; to prevent decoding error. For
example, &lt;tt class="docutils literal"&gt;b'nonascii\xff'&lt;/tt&gt; is decoded as &lt;tt class="docutils literal"&gt;'nonascii�'&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;The problem is that this filename cannot be used to read the file content using
&lt;tt class="docutils literal"&gt;open()&lt;/tt&gt; or to remove the file using &lt;tt class="docutils literal"&gt;os.unlink()&lt;/tt&gt;, since the operating
system doesn't know the Unicode filename containing the &amp;quot;�&amp;quot; character.&lt;/p&gt;
&lt;p&gt;An important property is that &lt;strong&gt;encoding back the Unicode filename to bytes
must return the same original bytes filename&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="defer-the-choice-to-the-caller-pass-a-callback"&gt;
&lt;h2&gt;Defer the choice to the caller: pass a callback&lt;/h2&gt;
&lt;p&gt;As no obvious choice arised, &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg71680"&gt;I proposed to use a callback to handle
undecodable filenames&lt;/a&gt;.
Pseudo-code:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def listdir(path, fallback_decoder=default_fallback_decoder):
    charset = sys.getfilesystemcharset()
    dir_fd = opendir(path)
    try:
        for bytesname in readdir(dir_fd):
            try:
                name = str(bytesname, charset)
            exept UnicodeDecodeError:
                name = fallback_decoder(bytesname)
            yield name
    finally:
        closedir(dir_fd)
&lt;/pre&gt;
&lt;p&gt;The default behaviour is to raise an exception on decoding error:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def default_fallback_decoder(name):
   raise
&lt;/pre&gt;
&lt;p&gt;Example of callback returning the raw bytes string unchanged (Python 3.0 beta1
behaviour):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def return_undecodable_unchanged(name):
   return name
&lt;/pre&gt;
&lt;p&gt;Example to use a custom filename class:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
class Filename:
   ...

def filename_decoder(name):
   return Filename(name)
&lt;/pre&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue3187#msg71699"&gt;Guido also disliked my callback idea&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
The callback variant is &lt;strong&gt;too complex&lt;/strong&gt;; you could &lt;strong&gt;write it yourself by
using os.listdir() with a bytes argument&lt;/strong&gt;.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="emit-a-warning-on-undecodable-filename"&gt;
&lt;h2&gt;Emit a warning on undecodable filename&lt;/h2&gt;
&lt;a class="reference external image-reference" href="http://www.unicode.org/"&gt;&lt;img alt="Warning: venoumous snakes" src="https://vstinner.github.io/images/warning_venomous_snakes.png" /&gt;&lt;/a&gt;
&lt;p&gt;As ignoring undecodable filenames in &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; slowly became the most
popular option, &lt;strong&gt;Benjamin Peterson&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg71700"&gt;proposed to emit a warning&lt;/a&gt; if a filename cannot be decoded,
to ease debugging:&lt;/p&gt;
&lt;blockquote&gt;
(...) I don't like the idea of silently losing the contents of a directory.
That's asking for difficult to discover bugs. Could Python emit a warning
in this case?&lt;/blockquote&gt;
&lt;p&gt;Guido van Rossum &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg71705"&gt;liked the idea&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
This may be the best compromise yet.&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Amaury Forgeot d'Arc&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg73535"&gt;asked&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Does the warning warn multiple times? IIRC the default behaviour is to warn
once.&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Benjamin Peterson&lt;/strong&gt; &lt;a class="reference external" href="https://bugs.python.org/issue3187#msg73535"&gt;replied&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;Making a warning happen more than once is tricky because it requires
messing with the warnings filter.&lt;/strong&gt; This of course takes away some of the
user's control which is one of the main reasons for using the Python
warning system in the first place.&lt;/blockquote&gt;
&lt;p&gt;Because of this issue, the warning idea was abandonned.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="support-bytes-and-fix-os-listdir"&gt;
&lt;h2&gt;Support bytes and fix os.listdir()&lt;/h2&gt;
&lt;p&gt;Guido repeated that the best workaround is to pass filenames as &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;,
which is the native type for filenames on Unix, but most functions only
accepted filenames as &lt;tt class="docutils literal"&gt;str&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I started to write multiple patches to support passing filenames as &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;posix_path_bytes.patch&lt;/tt&gt;: enhance &lt;tt class="docutils literal"&gt;posixpath.join()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;io_byte_filename.patch&lt;/tt&gt;: enhance &lt;tt class="docutils literal"&gt;open()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;fnmatch_bytes.patch&lt;/tt&gt;: enhance &lt;tt class="docutils literal"&gt;fnmatch.filter()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;glob1_bytes.patch&lt;/tt&gt;: enhance &lt;tt class="docutils literal"&gt;glob.glob()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;getcwd_bytes.patch&lt;/tt&gt;: &lt;tt class="docutils literal"&gt;os.getcwd()&lt;/tt&gt; returns bytes if unicode conversion fails&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;merge_os_getcwd_getcwdu.patch&lt;/tt&gt;: Remove &lt;tt class="docutils literal"&gt;os.getcwdu()&lt;/tt&gt;;
&lt;tt class="docutils literal"&gt;os.getcwd(bytes=True)&lt;/tt&gt; returns bytes&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os_getcwdb.patch&lt;/tt&gt;: Fix &lt;tt class="docutils literal"&gt;os.getcwd()&lt;/tt&gt; by using &lt;tt class="docutils literal"&gt;PyUnicode_Decode()&lt;/tt&gt; and
add &lt;tt class="docutils literal"&gt;os.getcwdb()&lt;/tt&gt; which returns &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Guido van Rossum created a &lt;a class="reference external" href="https://codereview.appspot.com/3055"&gt;review on my combined patches&lt;/a&gt;. Then I also combined my patches into a
single &lt;tt class="docutils literal"&gt;python3_bytes_filename.patch&lt;/tt&gt; file.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;After one month of development, 6 versions of the combined patch, Guido
commited my big change&lt;/strong&gt; as the &lt;a class="reference external" href="https://github.com/python/cpython/commit/f0af3e30db9475ab68bcb1f1ce0b5581e214df76"&gt;commit f0af3e30&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit f0af3e30db9475ab68bcb1f1ce0b5581e214df76
Author: Guido van Rossum &amp;lt;guido&amp;#64;python.org&amp;gt;
Date:   Thu Oct 2 18:55:37 2008 +0000

    Issue #3187: Better support for &amp;quot;undecodable&amp;quot; filenames.  Code by Victor
    Stinner, with small tweaks by GvR.

 Lib/fnmatch.py                |  27 ++++---
 Lib/genericpath.py            |   5 +-
 Lib/glob.py                   |  17 +++--
 Lib/io.py                     |  15 ++--
 Lib/posixpath.py              | 171 +++++++++++++++++++++++++++++++-----------
 Lib/test/test_fnmatch.py      |   9 +++
 Lib/test/test_posix.py        |   2 +-
 Lib/test/test_posixpath.py    | 150 ++++++++++++++++++++++++++++++++----
 Lib/test/test_unicode_file.py |   6 +-
 Misc/NEWS                     |  10 ++-
 Modules/posixmodule.c         |  90 +++++++++-------------
 11 files changed, 358 insertions(+), 144 deletions(-)
&lt;/pre&gt;
&lt;p&gt;My change:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Modify &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; to &lt;strong&gt;ignore silently undecodable filenames&lt;/strong&gt;,
instead of returning them as &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Add &lt;tt class="docutils literal"&gt;os.getcwdb()&lt;/tt&gt; function: similar to &lt;tt class="docutils literal"&gt;os.getcwd()&lt;/tt&gt; but returns the
current working directory as &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Support &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; paths:&lt;ul&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;fnmatch.filter()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;glob.glob1()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;glob.iglob()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;open()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.isabs()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.issep()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.join()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.split()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.splitext()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.basename()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.dirname()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.splitdrive()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.ismount()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.expanduser()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.expandvars()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.normpath()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.abspath()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;os.path.realpath()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="more-bytes-patches"&gt;
&lt;h2&gt;More bytes patches&lt;/h2&gt;
&lt;p&gt;I looked if other functions accepted passing filenames as &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; and... I
was disappointed. It took me some years to fix the full Python standard
library. Example of issues between 2008 and 2010:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue4035"&gt;bpo-4035&lt;/a&gt;: Support bytes in &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;os.exec*()&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue4036"&gt;bpo-4036&lt;/a&gt;: Support bytes in &lt;tt class="docutils literal"&gt;subprocess.Popen()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8513"&gt;bpo-8513&lt;/a&gt;: &lt;tt class="docutils literal"&gt;subprocess&lt;/tt&gt;: support bytes program name (POSIX)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8514"&gt;bpo-8514&lt;/a&gt;: Add &lt;tt class="docutils literal"&gt;fsencode()&lt;/tt&gt; functions to os module&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8603"&gt;bpo-8603&lt;/a&gt;: Create a bytes version of &lt;tt class="docutils literal"&gt;os.environ&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;getenvb()&lt;/tt&gt; -- Add &lt;tt class="docutils literal"&gt;os.environb&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8412"&gt;bpo-8412&lt;/a&gt;: &lt;tt class="docutils literal"&gt;os.system()&lt;/tt&gt; doesn't support surrogates nor bytes&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8468"&gt;bpo-8468&lt;/a&gt;: &lt;tt class="docutils literal"&gt;bz2&lt;/tt&gt; module: support surrogates in filename, and bytes/bytearray filename&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8477"&gt;bpo-8477&lt;/a&gt;: &lt;tt class="docutils literal"&gt;ssl&lt;/tt&gt; module: support surrogates in filenames, and bytes/bytearray filenames&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8640"&gt;bpo-8640&lt;/a&gt;: &lt;tt class="docutils literal"&gt;subprocess:&lt;/tt&gt; canonicalize env to bytes on Unix (Python3)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue8776"&gt;bpo-8776&lt;/a&gt;: Bytes version of &lt;tt class="docutils literal"&gt;sys.argv&lt;/tt&gt; (REJECTED)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;At the first look, &lt;strong&gt;Helmut Jarausch&lt;/strong&gt;'s &lt;tt class="docutils literal"&gt;os.walk()&lt;/tt&gt; bug looked trivial to
fix.&lt;/p&gt;
&lt;p&gt;I proposed a &lt;strong&gt;new Filename class&lt;/strong&gt; storing filenames as &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;str&lt;/tt&gt;,
but Guido van Rossum rejected the idea because this API complification
would &lt;em&gt;hinder most people&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Guido van Rossum proposed to &lt;strong&gt;use the replace error handler&lt;/strong&gt;, but decoded
filenames were not recognized by the operating system making them useless for
most cases.&lt;/p&gt;
&lt;p&gt;I proposed to &lt;strong&gt;use callback to handle undecodable filenames&lt;/strong&gt;, but Guido van
Rossum also rejected this idea because it was too complex and could be written
using os.listdir() with a bytes argument.&lt;/p&gt;
&lt;p&gt;Benjamin Peterson proposed to &lt;strong&gt;emit a warning&lt;/strong&gt; when a filename cannot be
decoded, but the idea was abandonned because of the warnings filters complexity
to emit the warning multiple times.&lt;/p&gt;
&lt;p&gt;I wrote a big change modifying &lt;tt class="docutils literal"&gt;os.listdir()&lt;/tt&gt; to ignore silently undecodable
filenames, but also modify a lot of functions to also accept filenames as
&lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;.  I made further changes the following years to fix the full Python
standard library to accept &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;While it &amp;quot;only&amp;quot; took 4 months to fix the &lt;tt class="docutils literal"&gt;os.listdir(str)&lt;/tt&gt; issue, &lt;strong&gt;this kind
of bugs will keep me busy the next 10 years&lt;/strong&gt; (2008-2018)...&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;This article is the first in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system.&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category><category term="unicode"></category></entry><entry><title>How I fixed a very old GIL race condition in Python 3.7</title><link href="https://vstinner.github.io/python37-gil-change.html" rel="alternate"></link><published>2018-03-08T10:00:00+01:00</published><updated>2018-03-08T10:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-08:/python37-gil-change.html</id><summary type="html">&lt;p&gt;&lt;strong&gt;It took me 4 years to fix a nasty bug in the famous Python GIL&lt;/strong&gt; (Global
Interpreter Lock), one of the most critical part of Python. I had to dig the
Git history to find a &lt;strong&gt;change made 26 years ago&lt;/strong&gt; by &lt;strong&gt;Guido van Rossum&lt;/strong&gt;: at
this time, &lt;em&gt;threads were …&lt;/em&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;strong&gt;It took me 4 years to fix a nasty bug in the famous Python GIL&lt;/strong&gt; (Global
Interpreter Lock), one of the most critical part of Python. I had to dig the
Git history to find a &lt;strong&gt;change made 26 years ago&lt;/strong&gt; by &lt;strong&gt;Guido van Rossum&lt;/strong&gt;: at
this time, &lt;em&gt;threads were something esoteric&lt;/em&gt;. Let me tell you my story.&lt;/p&gt;
&lt;div class="section" id="fatal-python-error-caused-by-a-c-thread-and-the-gil"&gt;
&lt;h2&gt;Fatal Python error caused by a C thread and the GIL&lt;/h2&gt;
&lt;p&gt;In March 2014, &lt;strong&gt;Steve Dower&lt;/strong&gt; reported the bug &lt;a class="reference external" href="https://bugs.python.org/issue20891"&gt;bpo-20891&lt;/a&gt; when a &amp;quot;C thread&amp;quot; uses the Python C
API:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In Python 3.4rc3, calling &lt;tt class="docutils literal"&gt;PyGILState_Ensure()&lt;/tt&gt; from a thread that was
not created by Python and without any calls to &lt;tt class="docutils literal"&gt;PyEval_InitThreads()&lt;/tt&gt;
will cause a fatal exit:&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;Fatal Python error: take_gil: NULL tstate&lt;/tt&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;My first comment:&lt;/p&gt;
&lt;blockquote&gt;
IMO it's a bug in &lt;tt class="docutils literal"&gt;PyEval_InitThreads()&lt;/tt&gt;.&lt;/blockquote&gt;
&lt;a class="reference external image-reference" href="https://twitter.com/kwinkunks/status/619496450834087938"&gt;&lt;img alt="Release the GIL!" src="https://vstinner.github.io/images/release_the_gil.png" /&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div class="section" id="pygilstate-ensure-fix"&gt;
&lt;h2&gt;PyGILState_Ensure() fix&lt;/h2&gt;
&lt;p&gt;I forgot the bug during 2 years. In March 2016, I modified Steve's test
program to make it compatible with Linux (the test was written for Windows). I
succeeded to reproduce the bug on my computer and I wrote a fix for
&lt;tt class="docutils literal"&gt;PyGILState_Ensure()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;One year later, november 2017, &lt;strong&gt;Marcin Kasperski&lt;/strong&gt; asked:&lt;/p&gt;
&lt;blockquote&gt;
Is this fix released? I can't find it in the changelog…&lt;/blockquote&gt;
&lt;p&gt;Oops, again, I completely forgot this issue! This time, not only I &lt;strong&gt;applied my
PyGILState_Ensure() fix&lt;/strong&gt;, but I also wrote the &lt;strong&gt;unit test&lt;/strong&gt;
&lt;tt class="docutils literal"&gt;test_embed.test_bpo20891()&lt;/tt&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Ok, the bug is now fixed in Python 2.7, 3.6 and master (future 3.7). On 3.6
and master, the fix comes with an unit test.&lt;/blockquote&gt;
&lt;p&gt;My fix for the master branch, commit &lt;a class="reference external" href="https://github.com/python/cpython/commit/b4d1e1f7c1af6ae33f0e371576c8bcafedb099db"&gt;b4d1e1f7&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-20891: Fix PyGILState_Ensure() (#4650)

When PyGILState_Ensure() is called in a non-Python thread before
PyEval_InitThreads(), only call PyEval_InitThreads() after calling
PyThreadState_New() to fix a crash.

Add an unit test in test_embed.
&lt;/pre&gt;
&lt;p&gt;And I closed the issue &lt;a class="reference external" href="https://bugs.python.org/issue20891"&gt;bpo-20891&lt;/a&gt;...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="random-crash-of-the-test-on-macos"&gt;
&lt;h2&gt;Random crash of the test on macOS&lt;/h2&gt;
&lt;p&gt;Everything was fine... but one week later, I noticed &lt;strong&gt;random&lt;/strong&gt; crashes on
macOS buildbots on my newly added unit test. I succeeded to reproduce the bug
manually, example of crash at the 3rd run:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
macbook:master haypo$ while true; do ./Programs/_testembed bpo20891 ||break; date; done
Lun  4 déc 2017 12:46:34 CET
Lun  4 déc 2017 12:46:34 CET
Lun  4 déc 2017 12:46:34 CET
Fatal Python error: PyEval_SaveThread: NULL tstate

Current thread 0x00007fffa5dff3c0 (most recent call first):
Abort trap: 6
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;test_embed.test_bpo20891()&lt;/tt&gt; on macOS showed a race condition in
&lt;tt class="docutils literal"&gt;PyGILState_Ensure()&lt;/tt&gt;: the creation of the GIL lock itself... was not
protected by a lock! Adding a new lock to check if Python currently has the GIL
lock doesn't make sense...&lt;/p&gt;
&lt;p&gt;I proposed an incomplete fix for &lt;tt class="docutils literal"&gt;PyThread_start_new_thread()&lt;/tt&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I found a working fix: call &lt;tt class="docutils literal"&gt;PyEval_InitThreads()&lt;/tt&gt; in
&lt;tt class="docutils literal"&gt;PyThread_start_new_thread()&lt;/tt&gt;. So the GIL is created as soon as a second
thread is spawned. The GIL cannot be created anymore while two threads are
running. At least, with the &lt;tt class="docutils literal"&gt;python&lt;/tt&gt; binary. It doesn't fix the issue if
a thread is not spawned by Python, but this thread calls
&lt;tt class="docutils literal"&gt;PyGILState_Ensure()&lt;/tt&gt;.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="why-not-always-create-the-gil"&gt;
&lt;h2&gt;Why not always create the GIL?&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Antoine Pitrou&lt;/strong&gt; asked a simple question:&lt;/p&gt;
&lt;blockquote&gt;
Why not &lt;em&gt;always&lt;/em&gt; call &lt;tt class="docutils literal"&gt;PyEval_InitThreads()&lt;/tt&gt; at interpreter
initialization? Are there any downsides?&lt;/blockquote&gt;
&lt;p&gt;Thanks to &lt;tt class="docutils literal"&gt;git blame&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;git log&lt;/tt&gt;, I found the origin of the code
creating the GIL &amp;quot;on demand&amp;quot;, &lt;strong&gt;a change made 26 years ago&lt;/strong&gt;!&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 1984f1e1c6306d4e8073c28d2395638f80ea509b
Author: Guido van Rossum &amp;lt;guido&amp;#64;python.org&amp;gt;
Date:   Tue Aug 4 12:41:02 1992 +0000

    * Makefile adapted to changes below.
    * split pythonmain.c in two: most stuff goes to pythonrun.c, in the library.
    * new optional built-in threadmodule.c, build upon Sjoerd's thread.{c,h}.
    * new module from Sjoerd: mmmodule.c (dynamically loaded).
    * new module from Sjoerd: sv (svgen.py, svmodule.c.proto).
    * new files thread.{c,h} (from Sjoerd).
    * new xxmodule.c (example only).
    * myselect.h: bzero -&amp;gt; memset
    * select.c: bzero -&amp;gt; memset; removed global variable

(...)

+void
+init_save_thread()
+{
+#ifdef USE_THREAD
+       if (interpreter_lock)
+               fatal(&amp;quot;2nd call to init_save_thread&amp;quot;);
+       interpreter_lock = allocate_lock();
+       acquire_lock(interpreter_lock, 1);
+#endif
+}
+#endif
&lt;/pre&gt;
&lt;p&gt;My guess was that the intent of dynamically created GIL is to reduce the
&amp;quot;overhead&amp;quot; of the GIL for applications only using a single Python thread (never
spawn a new Python thread).&lt;/p&gt;
&lt;p&gt;Luckily, &lt;strong&gt;Guido van Rossum&lt;/strong&gt; was around and was able to elaborate the
rationale:&lt;/p&gt;
&lt;blockquote&gt;
Yeah, the original reasoning was that &lt;strong&gt;threads were something esoteric and
not used by most code&lt;/strong&gt;, and at the time we definitely felt that &lt;strong&gt;always
using the GIL would cause a (tiny) slowdown&lt;/strong&gt; and &lt;strong&gt;increase the risk of
crashes&lt;/strong&gt; due to bugs in the GIL code. I'd be happy to learn that we no
longer need to worry about this and &lt;strong&gt;can just always initialize it&lt;/strong&gt;.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="second-fix-for-py-initialize-proposed"&gt;
&lt;h2&gt;Second fix for Py_Initialize() proposed&lt;/h2&gt;
&lt;p&gt;I proposed a &lt;strong&gt;second fix&lt;/strong&gt; for &lt;tt class="docutils literal"&gt;Py_Initialize()&lt;/tt&gt; to always create the GIL as
soon as Python starts, and no longer &amp;quot;on demand&amp;quot;, to prevent any risk of a race
condition:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
+    /* Create the GIL */
+    PyEval_InitThreads();
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Nick Coghlan&lt;/strong&gt; asked if I could you run my patch through the performance
benchmarks. I ran &lt;a class="reference external" href="http://pyperformance.readthedocs.io/"&gt;pyperformance&lt;/a&gt; on my &lt;a class="reference external" href="https://github.com/python/cpython/pull/4700/"&gt;PR 4700&lt;/a&gt;. Differences of at least 5%:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
haypo&amp;#64;speed-python$ python3 -m perf compare_to \
    2017-12-18_12-29-master-bd6ec4d79e85.json.gz \
    2017-12-18_12-29-master-bd6ec4d79e85-patch-4700.json.gz \
    --table --min-speed=5

+----------------------+--------------------------------------+-------------------------------------------------+
| Benchmark            | 2017-12-18_12-29-master-bd6ec4d79e85 | 2017-12-18_12-29-master-bd6ec4d79e85-patch-4700 |
+======================+======================================+=================================================+
| pathlib              | 41.8 ms                              | 44.3 ms: 1.06x slower (+6%)                     |
+----------------------+--------------------------------------+-------------------------------------------------+
| scimark_monte_carlo  | 197 ms                               | 210 ms: 1.07x slower (+7%)                      |
+----------------------+--------------------------------------+-------------------------------------------------+
| spectral_norm        | 243 ms                               | 269 ms: 1.11x slower (+11%)                     |
+----------------------+--------------------------------------+-------------------------------------------------+
| sqlite_synth         | 7.30 us                              | 8.13 us: 1.11x slower (+11%)                    |
+----------------------+--------------------------------------+-------------------------------------------------+
| unpickle_pure_python | 707 us                               | 796 us: 1.13x slower (+13%)                     |
+----------------------+--------------------------------------+-------------------------------------------------+

Not significant (55): 2to3; chameleon; chaos; (...)
&lt;/pre&gt;
&lt;p&gt;Oh, 5 benchmarks were slower. Performance regressions are not welcome in
Python: we are working hard on &lt;a class="reference external" href="https://lwn.net/Articles/725114/"&gt;making Python faster&lt;/a&gt;!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="skip-the-failing-test-before-christmas"&gt;
&lt;h2&gt;Skip the failing test before Christmas&lt;/h2&gt;
&lt;p&gt;I didn't expect that 5 benchmarks would be slower. It required further
investigation, but I didn't have time for that and I was too shy or ashame to
take the responsibility of pushing a performance regression.&lt;/p&gt;
&lt;p&gt;Before the christmas holiday, no decision was taken whereas
&lt;tt class="docutils literal"&gt;test_embed.test_bpo20891()&lt;/tt&gt; was still failing randomly on macOS buildbots.
I &lt;strong&gt;was not confortable to touch a critical part of Python&lt;/strong&gt;, its GIL, just
before leaving for two weeks. So I decided to skip &lt;tt class="docutils literal"&gt;test_bpo20891()&lt;/tt&gt; until
I'm back.&lt;/p&gt;
&lt;p&gt;No gift for you, Python 3.7.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://drawception.com/panel/drawing/0teL3336/charlie-brown-sad-about-small-christmas-tree/"&gt;&lt;img alt="Sad Christmas tree" src="https://vstinner.github.io/images/sad_christmas_tree.png" /&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div class="section" id="new-benchmark-run-and-second-fix-applied-to-master"&gt;
&lt;h2&gt;New benchmark run and second fix applied to master&lt;/h2&gt;
&lt;p&gt;At the end of january 2018, I ran again the 5 benchmarks made slower by my PR.
I ran these benchmarks manually on my laptop using CPU isolation:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
vstinner&amp;#64;apu$ python3 -m perf compare_to ref.json patch.json --table
Not significant (5): unpickle_pure_python; sqlite_synth; spectral_norm; pathlib; scimark_monte_carlo
&lt;/pre&gt;
&lt;p&gt;Ok, it confirms that my second fix has &lt;strong&gt;no significant impact on
performances&lt;/strong&gt; according to the &lt;a class="reference external" href="http://pyperformance.readthedocs.io/"&gt;Python &amp;quot;performance&amp;quot; benchmark suite&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I decided to &lt;strong&gt;push my fix&lt;/strong&gt; to the master branch, commit &lt;a class="reference external" href="https://github.com/python/cpython/commit/2914bb32e2adf8dff77c0ca58b33201bc94e398c"&gt;2914bb32&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-20891: Py_Initialize() now creates the GIL (#4700)

The GIL is no longer created &amp;quot;on demand&amp;quot; to fix a race condition when
PyGILState_Ensure() is called in a non-Python thread.
&lt;/pre&gt;
&lt;p&gt;Then I reenabled &lt;tt class="docutils literal"&gt;test_embed.test_bpo20891()&lt;/tt&gt; on the master branch.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="no-second-fix-for-python-2-7-and-3-6-sorry"&gt;
&lt;h2&gt;No second fix for Python 2.7 and 3.6, sorry!&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Antoine Pitrou&lt;/strong&gt; considered that backport for Python 3.6 &lt;a class="reference external" href="https://github.com/python/cpython/pull/5421#issuecomment-361214537"&gt;should not be
merged&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
I don't think so. People can already call &lt;tt class="docutils literal"&gt;PyEval_InitThreads()&lt;/tt&gt;.&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Guido van Rossum&lt;/strong&gt; didn't want to backport this change neither. So I only
removed &lt;tt class="docutils literal"&gt;test_embed.test_bpo20891()&lt;/tt&gt; from the 3.6 branch.&lt;/p&gt;
&lt;p&gt;I didn't apply my second fix to Python 2.7 neither for the same reason.
Moreover, Python 2.7 has no unit test, since it was too difficult to backport
it.&lt;/p&gt;
&lt;p&gt;At least, Python 2.7 and 3.6 got my first &lt;tt class="docutils literal"&gt;PyGILState_Ensure()&lt;/tt&gt; fix.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Python still has some race conditions in corner cases. Such bug was found in
the creation of the GIL when a C thread starts using the Python API. I pushed a
first fix, but a new and different race condition was found on macOS.&lt;/p&gt;
&lt;p&gt;I had to dig into the very old history (1992) of the Python GIL. Luckily,
&lt;strong&gt;Guido van Rossum&lt;/strong&gt; was also able to elaborate the rationale.&lt;/p&gt;
&lt;p&gt;After a glitch in benchmarks, we agreed to modify Python 3.7 to always create
the GIL, instead of creating the GIL &amp;quot;on demand&amp;quot;. The change has no significant
impact on performances.&lt;/p&gt;
&lt;p&gt;It was also decided to leave Python 2.7 and 3.6 unchanged, to prevent any risk
of regression: continue to create the GIL &amp;quot;on demand&amp;quot;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;It took me 4 years to fix a nasty bug in the famous Python GIL.&lt;/strong&gt; I am never
confortable when touching such &lt;strong&gt;critical part&lt;/strong&gt; of Python. I am now happy that
the bug is behind us: it's now fully fixed in the future Python 3.7!&lt;/p&gt;
&lt;p&gt;See &lt;a class="reference external" href="https://bugs.python.org/issue20891"&gt;bpo-20891&lt;/a&gt; for the full story.
Thanks to all developers who helped me to fix this bug!&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>Python 3.7 nanoseconds</title><link href="https://vstinner.github.io/python37-pep-564-nanoseconds.html" rel="alternate"></link><published>2018-03-06T16:30:00+01:00</published><updated>2018-03-06T16:30:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-06:/python37-pep-564-nanoseconds.html</id><summary type="html">&lt;p&gt;Thanks to my &lt;a class="reference external" href="https://vstinner.github.io/python37-perf-counter-nanoseconds.html"&gt;latest change on time.perf_counter()&lt;/a&gt;, all Python 3.7 clocks now use
nanoseconds as integer internally. It became possible to propose again my old
idea of getting time as nanoseconds at Python level and so I wrote a new
&lt;a class="reference external" href="http://www.python.org/dev/peps/pep-0564"&gt;PEP 564&lt;/a&gt; &amp;quot;Add new time functions with nanosecond …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Thanks to my &lt;a class="reference external" href="https://vstinner.github.io/python37-perf-counter-nanoseconds.html"&gt;latest change on time.perf_counter()&lt;/a&gt;, all Python 3.7 clocks now use
nanoseconds as integer internally. It became possible to propose again my old
idea of getting time as nanoseconds at Python level and so I wrote a new
&lt;a class="reference external" href="http://www.python.org/dev/peps/pep-0564"&gt;PEP 564&lt;/a&gt; &amp;quot;Add new time functions with nanosecond resolution&amp;quot;. While the PEP
was discussed, I also deprecated &lt;tt class="docutils literal"&gt;time.clock()&lt;/tt&gt; and removed
&lt;tt class="docutils literal"&gt;os.stat_float_times()&lt;/tt&gt;.&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/dkalo/2909921582/"&gt;&lt;img alt="Old clock" src="https://vstinner.github.io/images/clock.jpg" /&gt;&lt;/a&gt;
&lt;div class="section" id="time-clock"&gt;
&lt;h2&gt;time.clock()&lt;/h2&gt;
&lt;p&gt;Since I wrote the &lt;a class="reference external" href="http://www.python.org/dev/peps/pep-0418"&gt;PEP 418&lt;/a&gt; &amp;quot;Add monotonic time, performance counter, and
process time functions&amp;quot; in 2012, I dislike &lt;tt class="docutils literal"&gt;time.clock()&lt;/tt&gt;. This clock is not
portable: on Windows it mesures wall-clock, whereas it measures CPU time on
Unix. Extract of &lt;a class="reference external" href="https://docs.python.org/dev/library/time.html#time.clock"&gt;time.clock() documentation&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;em&gt;Deprecated since version 3.3: The behaviour of this function depends on
the platform: use perf_counter() or process_time() instead, depending on
your requirements, to have a well defined behaviour.&lt;/em&gt;&lt;/blockquote&gt;
&lt;p&gt;My PEP 418 deprecated &lt;tt class="docutils literal"&gt;time.clock()&lt;/tt&gt; in the documentation. In &lt;a class="reference external" href="https://bugs.python.org/issue31803"&gt;bpo-31803&lt;/a&gt;, I modified &lt;tt class="docutils literal"&gt;time.clock()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;time.get_clock_info('clock')&lt;/span&gt;&lt;/tt&gt; to also emit a &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt; warning.
I replaced &lt;tt class="docutils literal"&gt;time.clock()&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt; in tests and demos. I
also removed &lt;tt class="docutils literal"&gt;hasattr(time, 'monotonic')&lt;/tt&gt; in &lt;tt class="docutils literal"&gt;test_time&lt;/tt&gt; since
&lt;tt class="docutils literal"&gt;time.monotonic()&lt;/tt&gt; is always available since Python 3.5.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="os-stat-float-times"&gt;
&lt;h2&gt;os.stat_float_times()&lt;/h2&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;os.stat_float_times()&lt;/tt&gt; function was introduced in Python 2.3 to get file
modification times with sub-second resolution (commit &lt;a class="reference external" href="https://github.com/python/cpython/commit/f607bdaa77475ec8c94614414dc2cecf8fd1ca0a"&gt;f607bdaa&lt;/a&gt;),
the default was still to get time as seconds (integer). The function was
introduced to get a smooth transition to time as floating point number, to keep
the backward compatibility with Python 2.2.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;os.stat()&lt;/tt&gt; was modified to return time as float by default in Python 2.5
(commit &lt;a class="reference external" href="https://github.com/python/cpython/commit/fe33d0ba87f5468b50f939724b303969711f3be5"&gt;fe33d0ba&lt;/a&gt;).
Python 2.5 was released 11 years ago, I consider that people had enough time to
migrate their code to float time :-) I modified &lt;tt class="docutils literal"&gt;os.stat_float_times()&lt;/tt&gt; in
Python 3.1 to emit a &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt; warning (commit &lt;a class="reference external" href="https://github.com/python/cpython/commit/034d0aa2171688c40cee1a723ddcdb85bbce31e8"&gt;034d0aa2&lt;/a&gt;
of &lt;a class="reference external" href="https://bugs.python.org/issue14711"&gt;bpo-14711&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;Finally, I removed &lt;tt class="docutils literal"&gt;os.stat_float_times()&lt;/tt&gt; in Python 3.7: &lt;a class="reference external" href="https://bugs.python.org/issue31827"&gt;bpo-31827&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Serhiy Storchaka proposed to also remove last three items from
&lt;tt class="docutils literal"&gt;os.stat_result&lt;/tt&gt;. For example, &lt;tt class="docutils literal"&gt;stat_result[stat.ST_MTIME]&lt;/tt&gt; could be
replaced with &lt;tt class="docutils literal"&gt;stat_result.st_time&lt;/tt&gt;.  But I tried to remove these items and
it broke the &lt;tt class="docutils literal"&gt;logging&lt;/tt&gt; module, so I decided to leave it unchanged.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-564-time-time-ns"&gt;
&lt;h2&gt;PEP 564: time.time_ns()&lt;/h2&gt;
&lt;p&gt;Six years ago (2012), I wrote the &lt;a class="reference external" href="http://www.python.org/dev/peps/pep-0410"&gt;PEP 410&lt;/a&gt; &amp;quot;Use decimal.Decimal type for
timestamps&amp;quot; which proposes a large and complex change in all Python functions
returning time to support nanosecond resolution using the &lt;tt class="docutils literal"&gt;decimal.Decimal&lt;/tt&gt;
type.  The PEP was &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2012-February/116837.html"&gt;rejected for different reasons&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Since all clock now use nanoseconds internally in Python 3.7, I proposed a new
&lt;a class="reference external" href="http://www.python.org/dev/peps/pep-0564"&gt;PEP 564&lt;/a&gt; &amp;quot;Add new time functions with nanosecond resolution&amp;quot;. Abstract:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Add six new &amp;quot;nanosecond&amp;quot; variants of existing functions to the &lt;tt class="docutils literal"&gt;time&lt;/tt&gt;
module: &lt;tt class="docutils literal"&gt;clock_gettime_ns()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;clock_settime_ns()&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;monotonic_ns()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;perf_counter_ns()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;process_time_ns()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;time_ns()&lt;/tt&gt;.  While similar to the existing functions without the
&lt;tt class="docutils literal"&gt;_ns&lt;/tt&gt; suffix, they provide nanosecond resolution: they return a number of
nanoseconds as a Python &lt;tt class="docutils literal"&gt;int&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;time.time_ns()&lt;/tt&gt; resolution is 3 times better than the &lt;tt class="docutils literal"&gt;time.time()&lt;/tt&gt;
resolution on Linux and Windows.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;People were now convinced by the need for nanosecond resolution, so I
added an &amp;quot;Issues caused by precision loss&amp;quot; section with 2 examples:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Example 1: measure time delta in long-running process&lt;/li&gt;
&lt;li&gt;Example 2: compare times with different resolution&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As for my previous PEP 410, many people proposed many alternatives recorded in
the PEP: sub-nanosecond resolution, modifying &lt;tt class="docutils literal"&gt;time.time()&lt;/tt&gt; result type,
different types, different API, a new module, etc.&lt;/p&gt;
&lt;p&gt;Hopefully for me, Guido van Rossum quickly approved my PEP for Python 3.7!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="implementaton-of-the-pep-564"&gt;
&lt;h2&gt;Implementaton of the PEP 564&lt;/h2&gt;
&lt;p&gt;I implemented my PEP 564 in &lt;a class="reference external" href="https://bugs.python.org/issue31784"&gt;bpo-31784&lt;/a&gt;
with the commit &lt;a class="reference external" href="https://github.com/python/cpython/commit/c29b585fd4b5a91d17fc5dd41d86edff28a30da3"&gt;c29b585f&lt;/a&gt;.
I added 6 new time functions:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;time.clock_gettime_ns()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;time.clock_settime_ns()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;time.monotonic_ns()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;time.perf_counter_ns()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;time.process_time_ns()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;time.time_ns()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3.7
Python 3.7.0b2+ (heads/3.7:31e2b76f7b, Mar  6 2018, 15:31:29)
[GCC 7.2.1 20170915 (Red Hat 7.2.1-2)] on linux
&amp;gt;&amp;gt;&amp;gt; import time
&amp;gt;&amp;gt;&amp;gt; time.time()
1520354387.7663522
&amp;gt;&amp;gt;&amp;gt; time.time_ns()
1520354388319257562
&lt;/pre&gt;
&lt;p&gt;I also added tests on &lt;tt class="docutils literal"&gt;os.times()&lt;/tt&gt; in &lt;tt class="docutils literal"&gt;test_os&lt;/tt&gt;, previously the function
wasn't tested at all!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I added 6 new functions to get time with a nanosecond resolution like
&lt;tt class="docutils literal"&gt;time.time_ns()&lt;/tt&gt; with my approved &lt;a class="reference external" href="http://www.python.org/dev/peps/pep-0564"&gt;PEP 564&lt;/a&gt;. I also modified
&lt;tt class="docutils literal"&gt;time.clock()&lt;/tt&gt; to emit a &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt; and I removed the legacy
&lt;tt class="docutils literal"&gt;os.stat_float_times()&lt;/tt&gt; function.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>Python 3.7 perf_counter() nanoseconds</title><link href="https://vstinner.github.io/python37-perf-counter-nanoseconds.html" rel="alternate"></link><published>2018-03-06T15:00:00+01:00</published><updated>2018-03-06T15:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2018-03-06:/python37-perf-counter-nanoseconds.html</id><summary type="html">&lt;p&gt;Since 2012, I have been trying to convert all Python clocks to use internally
nanoseconds. The last clock which still used floating point internally was
&lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt;. INADA Naoki's new importtime tool was an opportunity
for me to have a new look on a tricky integer overflow issue.&lt;/p&gt;
&lt;div class="section" id="modify-importtime-to-use-time-perf-counter-clock"&gt;
&lt;h2&gt;Modify importtime …&lt;/h2&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;Since 2012, I have been trying to convert all Python clocks to use internally
nanoseconds. The last clock which still used floating point internally was
&lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt;. INADA Naoki's new importtime tool was an opportunity
for me to have a new look on a tricky integer overflow issue.&lt;/p&gt;
&lt;div class="section" id="modify-importtime-to-use-time-perf-counter-clock"&gt;
&lt;h2&gt;Modify importtime to use time.perf_counter() clock&lt;/h2&gt;
&lt;p&gt;INADA Naoki added to Python 3.7 a new cool &lt;a class="reference external" href="https://docs.python.org/dev/using/cmdline.html#id5"&gt;-X importtime&lt;/a&gt; command line option to
analyze the Python import performance. This tool can be used optimize the
startup time of your application. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
vstinner&amp;#64;apu$ ./python -X importtime -c pass
import time: self [us] | cumulative | imported package
(...)
import time:       901 |       1902 | io
import time:       374 |        374 |       _stat
import time:       663 |       1037 |     stat
import time:       617 |        617 |       genericpath
import time:       877 |       1493 |     posixpath
import time:      3840 |       3840 |     _collections_abc
import time:      2106 |       8474 |   os
import time:       674 |        674 |   _sitebuiltins
import time:       922 |        922 |   sitecustomize
import time:       598 |        598 |   usercustomize
import time:      1444 |      12110 | site
&lt;/pre&gt;
&lt;p&gt;Read Naoki's article &lt;a class="reference external" href="https://dev.to/methane/how-to-speed-up-python-application-startup-time-nkf"&gt;How to speed up Python application startup time&lt;/a&gt;
(Jan 19, 2018) for a concrete analysis of &lt;tt class="docutils literal"&gt;pipenv&lt;/tt&gt; performance.&lt;/p&gt;
&lt;p&gt;Naoki chose to use the &lt;tt class="docutils literal"&gt;time.monotonic()&lt;/tt&gt; clock internally to measure elapsed
time. On Windows, this clock (&lt;tt class="docutils literal"&gt;GetTickCount64()&lt;/tt&gt; function) has a resolution
around 15.6 ms, whereas most Python imports take less than 10 ms, and so most
numbers are just zeros. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
f:\dev\3x&amp;gt;python -X importtime -c &amp;quot;import idlelib.pyshell&amp;quot;
Running Debug|Win32 interpreter...
import time: self [us] | cumulative | imported package
import time:         0 |          0 |     _codecs
import time:         0 |          0 |   codecs
import time:         0 |          0 |   encodings.aliases
import time:     15000 |      15000 | encodings
import time:         0 |          0 | encodings.utf_8
import time:         0 |          0 | _signal
import time:         0 |          0 | encodings.latin_1
import time:         0 |          0 |     _weakrefset
import time:         0 |          0 |   abc
import time:         0 |          0 | io
import time:         0 |          0 |       _stat
(...)
&lt;/pre&gt;
&lt;p&gt;In &lt;a class="reference external" href="https://bugs.python.org/issue31415"&gt;bpo-31415&lt;/a&gt;, I fixed the issue by
adding a new C function &lt;tt class="docutils literal"&gt;_PyTime_GetPerfCounter()&lt;/tt&gt; to access the
&lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt; clock at the C level and I modified &amp;quot;importtime&amp;quot; to use
it.&lt;/p&gt;
&lt;p&gt;Problem solved! ... almost...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="double-integer-float-conversions"&gt;
&lt;h2&gt;Double integer-float conversions&lt;/h2&gt;
&lt;p&gt;My commit &lt;a class="reference external" href="https://github.com/python/cpython/commit/a997c7b434631f51e00191acea2ba6097691e859"&gt;a997c7b4&lt;/a&gt;
of &lt;a class="reference external" href="https://bugs.python.org/issue31415"&gt;bpo-31415&lt;/a&gt; adding
&lt;tt class="docutils literal"&gt;_PyTime_GetPerfCounter()&lt;/tt&gt; moved the C code from &lt;tt class="docutils literal"&gt;Modules/timemodule.c&lt;/tt&gt; to
&lt;tt class="docutils literal"&gt;Python/pytime.c&lt;/tt&gt;, but also changed the internal type storing time from
floatting point number (C &lt;tt class="docutils literal"&gt;double&lt;/tt&gt;) to integer number (&lt;tt class="docutils literal"&gt;_PyTyime_t&lt;/tt&gt; which
is &lt;tt class="docutils literal"&gt;int64_t&lt;/tt&gt; in practice).&lt;/p&gt;
&lt;p&gt;The drawback of this change is that &lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt; now converts
&lt;tt class="docutils literal"&gt;QueryPerformanceCounter() / QueryPerformanceFrequency()&lt;/tt&gt; float into a
&lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt; (integer) and then back to a float, and these conversions cause a
precision loss. I computed that the conversions start to loose precision
starting after a single second with &lt;tt class="docutils literal"&gt;QueryPerformanceFrequency()&lt;/tt&gt; equals to
&lt;tt class="docutils literal"&gt;3,579,545&lt;/tt&gt; (3.6 MHz).&lt;/p&gt;
&lt;p&gt;To fix the precision loss, I modified again &lt;tt class="docutils literal"&gt;time.clock()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt; to not use &lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt; anymore, only double.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="grumpy-victor"&gt;
&lt;h2&gt;Grumpy Victor&lt;/h2&gt;
&lt;img alt="Grumpy" src="https://vstinner.github.io/images/grumpy.jpg" /&gt;
&lt;p&gt;My change to replace &lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;double&lt;/tt&gt; made me grumpy. I have been
trying to convert all Python clocks to &lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt; since 6 years (2012).&lt;/p&gt;
&lt;p&gt;Being blocked by a single clock made me grumpy, especially because the issue
is specific to the Windows implementation. The Linux implementation of
&lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt; uses &lt;tt class="docutils literal"&gt;clock_gettime()&lt;/tt&gt; which directly returns
nanoseconds as integers, no division needed to get time as &lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I looked at the clock sources in the Linux kernel source code:
&lt;a class="reference external" href="https://github.com/torvalds/linux/blob/master/kernel/time/clocksource.c"&gt;kernel/time/clocksource.c&lt;/a&gt;.
Linux clocks only use integers and support nanosecond resolution. I'm always
impressed by the quality of the Linux kernel source code, the code is
straightforward C code. If Linux is able to use integers for various kinds of
clocks, I should be able to use integers for my specific Windows
implementations of &lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt;, no?&lt;/p&gt;
&lt;p&gt;In practice, the &lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt; is a number of nanoseconds, so the computation
is:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
(QueryPerformanceCounter() * 1_000_000_000) / QueryPerformanceFrequency()
&lt;/pre&gt;
&lt;p&gt;where &lt;tt class="docutils literal"&gt;1_000_000_000&lt;/tt&gt; is the number of nanoseconds in one second. &lt;strong&gt;The problem
is preventing integer overflow&lt;/strong&gt; on the first part, using &lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt; which is
&lt;tt class="docutils literal"&gt;int64_t&lt;/tt&gt; in practice:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
QueryPerformanceCounter() * 1_000_000_000
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="some-maths-to-avoid-the-precision-loss"&gt;
&lt;h2&gt;Some maths to avoid the precision loss&lt;/h2&gt;
&lt;p&gt;Using a pencil, a sheet of paper and some maths, I found a solution!&lt;/p&gt;
&lt;pre class="literal-block"&gt;
(a * b) / q == (a / q) * b + ((a % q) * b) / q
&lt;/pre&gt;
&lt;img alt="Math rocks" src="https://vstinner.github.io/images/math_rocks.jpg" /&gt;
&lt;p&gt;This prevents the risk of integer overflow. C implementation:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Py_LOCAL_INLINE(_PyTime_t)
_PyTime_MulDiv(_PyTime_t ticks, _PyTime_t mul, _PyTime_t div)
{
    _PyTime_t intpart, remaining;
    /* Compute (ticks * mul / div) in two parts to prevent integer overflow:
       compute integer part, and then the remaining part.

       (ticks * mul) / div == (ticks / div) * mul + (ticks % div) * mul / div

       The caller must ensure that &amp;quot;(div - 1) * mul&amp;quot; cannot overflow. */
    intpart = ticks / div;
    ticks %= div;
    remaining = ticks * mul;
    remaining /= div;
    return intpart * mul + remaining;
}
&lt;/pre&gt;
&lt;p&gt;Simplified Windows implementation of perf_counter():&lt;/p&gt;
&lt;pre class="literal-block"&gt;
_PyTime_t win_perf_counter(void)
{
    LARGE_INTEGER freq;
    LONGLONG frequency;
    LARGE_INTEGER now;
    LONGLONG ticksll;
    _PyTime_t ticks;

    (void)QueryPerformanceFrequency(&amp;amp;freq);
    frequency = freq.QuadPart;

    QueryPerformanceCounter(&amp;amp;now);
    ticksll = now.QuadPart;
    ticks = (_PyTime_t)ticksll;

    return _PyTime_MulDiv(ticks, SEC_TO_NS, (_PyTime_t)frequency);
}
&lt;/pre&gt;
&lt;p&gt;On Windows, I added the following sanity checks to make sure that integer
overflows cannot occur:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/* Check that frequency can be casted to _PyTime_t.

   Make also sure that (ticks * SEC_TO_NS) cannot overflow in
   _PyTime_MulDiv(), with ticks &amp;lt; frequency.

   Known QueryPerformanceFrequency() values:

   * 10,000,000 (10 MHz): 100 ns resolution
   * 3,579,545 Hz (3.6 MHz): 279 ns resolution

   None of these frequencies can overflow with 64-bit _PyTime_t, but
   check for overflow, just in case. */
if (frequency &amp;gt; _PyTime_MAX
    || frequency &amp;gt; (LONGLONG)_PyTime_MAX / (LONGLONG)SEC_TO_NS) {
    PyErr_SetString(PyExc_OverflowError,
                    &amp;quot;QueryPerformanceFrequency is too large&amp;quot;);
    return -1;
}
&lt;/pre&gt;
&lt;p&gt;Since I also modified the macOS implementation of &lt;tt class="docutils literal"&gt;time.monotonic()&lt;/tt&gt; to use
&lt;tt class="docutils literal"&gt;_PyTime_MulDiv()&lt;/tt&gt;, I also added this check for macOS:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/* Make sure that (ticks * timebase.numer) cannot overflow in
   _PyTime_MulDiv(), with ticks &amp;lt; timebase.denom.

   Known time bases:

   * always (1, 1) on Intel
   * (1000000000, 33333335) or (1000000000, 25000000) on PowerPC

   None of these time bases can overflow with 64-bit _PyTime_t, but
   check for overflow, just in case. */
if ((_PyTime_t)timebase.numer &amp;gt; _PyTime_MAX / (_PyTime_t)timebase.denom) {
    PyErr_SetString(PyExc_OverflowError,
                    &amp;quot;mach_timebase_info is too large&amp;quot;);
    return -1;
}
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="pytime-c-source-code"&gt;
&lt;h2&gt;pytime.c source code&lt;/h2&gt;
&lt;p&gt;If you are curious, the full code lives at &lt;a class="reference external" href="https://github.com/python/cpython/blob/master/Python/pytime.c"&gt;Python/pytime.c&lt;/a&gt; and is
currently around 1,100 lines of C code.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;INADA Naoki's importtime tool was using &lt;tt class="docutils literal"&gt;time.monotonic()&lt;/tt&gt; clock which failed
to measure short import times on Windows. I modified it to use
&lt;tt class="docutils literal"&gt;time.perf_counter()&lt;/tt&gt; internally to get better precision on Windows.  I
identified a precision loss caused by my internal &lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt; type to store
time as nanoseconds. Thanks to maths, I succeeded to use nanoseconds and
prevent any risk of integer overflow.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2017 Q3: Part 3 (funny bugs)</title><link href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html" rel="alternate"></link><published>2017-10-19T16:00:00+02:00</published><updated>2017-10-19T16:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-10-19:/contrib-cpython-2017q3-part3.html</id><summary type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q3
(july, august, september), Part 3 (funny bugs).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html"&gt;My contributions to CPython during 2017 Q3: Part 2 (dangling
threads)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Summary:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;FreeBSD bug: minor() device regression&lt;/li&gt;
&lt;li&gt;regrtest snowball effect when hunting memory leaks&lt;/li&gt;
&lt;li&gt;Bugfixes&lt;/li&gt;
&lt;li&gt;Other Changes&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="freebsd-bug-minor-device-regression"&gt;
&lt;h2&gt;FreeBSD bug: minor() device regression&lt;/h2&gt;
&lt;a class="reference external image-reference" href="https://www.freebsd.org/"&gt;&lt;img alt="Logo of the FreeBSD project" src="https://vstinner.github.io/images/freebsd.png" /&gt;&lt;/a&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31044"&gt;bpo-31044&lt;/a&gt;: The …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q3
(july, august, september), Part 3 (funny bugs).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html"&gt;My contributions to CPython during 2017 Q3: Part 2 (dangling
threads)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Summary:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;FreeBSD bug: minor() device regression&lt;/li&gt;
&lt;li&gt;regrtest snowball effect when hunting memory leaks&lt;/li&gt;
&lt;li&gt;Bugfixes&lt;/li&gt;
&lt;li&gt;Other Changes&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="freebsd-bug-minor-device-regression"&gt;
&lt;h2&gt;FreeBSD bug: minor() device regression&lt;/h2&gt;
&lt;a class="reference external image-reference" href="https://www.freebsd.org/"&gt;&lt;img alt="Logo of the FreeBSD project" src="https://vstinner.github.io/images/freebsd.png" /&gt;&lt;/a&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31044"&gt;bpo-31044&lt;/a&gt;: The test_makedev() of
test_posix started to fail in the build 632 (Wed Jul 26 10:47:01 2017) of AMD64
FreeBSD CURRENT. The test failed on Debug, but also Non-Debug buildbots, in
master and 3.6 branches. It looks more like a change on the buildbot, maybe a
FreeBSD upgrade?&lt;/p&gt;
&lt;p&gt;Thanks to &lt;strong&gt;koobs&lt;/strong&gt;, I have a SSH access to the buildbot. I was able to
reproduce the bug manually. I noticed that minor() truncates most significant
bits.&lt;/p&gt;
&lt;p&gt;I continued my analysis and I found that, at May 23, the FreeBSD &lt;tt class="docutils literal"&gt;dev_t&lt;/tt&gt; type
changed from 32 bits to 64 bits in the kernel, but the &lt;tt class="docutils literal"&gt;minor()&lt;/tt&gt; userland
function was not updated.&lt;/p&gt;
&lt;p&gt;I reported a bug to FreeBSD: &lt;a class="reference external" href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=221048"&gt;Bug 221048 - minor() truncates device number to
32 bits, whereas dev_t type was extended to 64 bits&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In the meanwhile, I skipped test_posix.test_makedev() on FreeBSD if &lt;tt class="docutils literal"&gt;dev_t&lt;/tt&gt;
is larger than 32-bit.&lt;/p&gt;
&lt;p&gt;Hopefully, the FreeBSD bug was quickly fixed!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="regrtest-snowball-effect-when-hunting-memory-leaks"&gt;
&lt;h2&gt;regrtest snowball effect when hunting memory leaks&lt;/h2&gt;
&lt;p&gt;While trying to fix all reference leaks on the new Windows and Linux &amp;quot;Refleaks&amp;quot;
buildbots, I reported the bug &lt;a class="reference external" href="https://bugs.python.org/issue31217"&gt;bpo-31217&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
test_code leaked [1, 1, 1] memory blocks, sum=3
&lt;/pre&gt;
&lt;p&gt;Two weeks after reporting the bug, I was able to reproduce the bug, but &lt;strong&gt;only
with Python compiled in 32-bit mode&lt;/strong&gt;. Strange.&lt;/p&gt;
&lt;p&gt;I spent one day to understand the bug. I removed as much as possible while
making sure that I can still reproduce the bug. At the end, I wrote &lt;a class="reference external" href="https://bugs.python.org/file47114/leak2.py"&gt;leak2.py&lt;/a&gt; which reproduces the bug with a
single import: &lt;tt class="docutils literal"&gt;import sys&lt;/tt&gt;. Even if the script is only 86 lines long, I was
still unable to understand the bug.&lt;/p&gt;
&lt;p&gt;My first hypothesis:&lt;/p&gt;
&lt;blockquote&gt;
It seems like the &amp;quot;leak&amp;quot; is the call to &lt;tt class="docutils literal"&gt;sys.getallocatedblocks()&lt;/tt&gt; which
creates a new integer, and the integer is kept alive between two loop
iterations.&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Antoine Pitrou&lt;/strong&gt; rejected it:&lt;/p&gt;
&lt;blockquote&gt;
I doubt it. If that was the case, the reference count would increase as
well.&lt;/blockquote&gt;
&lt;p&gt;It was Antoine Pitrou who understood the bug:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Ahah.
Actually, it's quite simple :-) On 64-bit Python:

&amp;gt;&amp;gt;&amp;gt; id(82914 - 82913) == id(1)
True

On 32-bit Python:

&amp;gt;&amp;gt;&amp;gt; id(82914 - 82913) == id(1)
False

So the first non-zero alloc_delta really has a snowball effect, as it
creates new memory block which will produce a non-zero alloc_delta on the
next run, etc.
&lt;/pre&gt;
&lt;p&gt;I implemented Antoine's idea to fix the bug, &lt;a class="reference external" href="https://github.com/python/cpython/commit/6c2feabc5dac2f3049b15134669e9ad5af573193"&gt;commit&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Use a pool of integer objects to prevent false alarm when checking for
memory block leaks. Fill the pool with values in -1000..1000 which
are the most common (reference, memory block, file descriptor)
differences.

Co-Authored-By: Antoine Pitrou &amp;lt;pitrou&amp;#64;free.fr&amp;gt;
&lt;/pre&gt;
&lt;p&gt;The bug is probably as old as the code hunting memory leaks.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="bugfixes"&gt;
&lt;h2&gt;Bugfixes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30891"&gt;bpo-30891&lt;/a&gt;: Second fix for
importlib &lt;tt class="docutils literal"&gt;_find_and_load()&lt;/tt&gt; to handle correctly parallelism with threads.
Call &lt;tt class="docutils literal"&gt;sys.modules.get()&lt;/tt&gt; in the &lt;tt class="docutils literal"&gt;with _ModuleLockManager(name):&lt;/tt&gt; block to
protect the dictionary key with the module lock and use an atomic get to
prevent race conditions.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31019"&gt;bpo-31019&lt;/a&gt;:
&lt;tt class="docutils literal"&gt;multiprocessing.Process.is_alive()&lt;/tt&gt; now removes the process from the
&lt;tt class="docutils literal"&gt;_children set&lt;/tt&gt; if the process completed. The change prevents leaking
&amp;quot;dangling&amp;quot; processes.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31326"&gt;bpo-31326&lt;/a&gt;, &lt;tt class="docutils literal"&gt;concurrent.futures&lt;/tt&gt;:
&lt;tt class="docutils literal"&gt;ProcessPoolExecutor.shutdown()&lt;/tt&gt; now explicitly closes the call queue.
Moreover, &lt;tt class="docutils literal"&gt;shutdown(wait=True)&lt;/tt&gt; now also joins the call queue thread, to
prevent leaking a dangling thread.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31170"&gt;bpo-31170&lt;/a&gt;: Update libexpat from
2.2.3 to 2.2.4: fix copying of partial characters for UTF-8 input (&lt;a class="reference external" href="https://github.com/libexpat/libexpat/issues/115"&gt;libexpat
bug 115&lt;/a&gt;). Later, I also
wrote non-regression tests for this bug (libexpat doesn't have any test
for this bug).&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31499"&gt;bpo-31499&lt;/a&gt;, &lt;tt class="docutils literal"&gt;xml.etree&lt;/tt&gt;:
&lt;tt class="docutils literal"&gt;xmlparser_gc_clear()&lt;/tt&gt; now sets self.parser to &lt;tt class="docutils literal"&gt;NULL&lt;/tt&gt; to prevent a crash
in &lt;tt class="docutils literal"&gt;xmlparser_dealloc()&lt;/tt&gt; if &lt;tt class="docutils literal"&gt;xmlparser_gc_clear()&lt;/tt&gt; was called previously
by the garbage collector, because the parser was part of a reference cycle.
Fix co-written with &lt;strong&gt;Serhiy Storchaka&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30892"&gt;bpo-30892&lt;/a&gt;: Fix &lt;tt class="docutils literal"&gt;_elementtree&lt;/tt&gt;
module initialization (accelerator of &lt;tt class="docutils literal"&gt;xml.etree&lt;/tt&gt;), handle correctly
&lt;tt class="docutils literal"&gt;getattr(copy, 'deepcopy')&lt;/tt&gt; failure to not fail with an assertion error.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="other-changes"&gt;
&lt;h2&gt;Other Changes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30866"&gt;bpo-30866&lt;/a&gt;: Add _testcapi.stack_pointer(). I used it to write the &amp;quot;Stack
consumption&amp;quot; section of a previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q1.html"&gt;My contributions to CPython
during 2017 Q1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;_ssl_: Fix compiler warning. Cast Py_buffer.len (Py_ssize_t, signed) to
size_t (unsigned) to prevent the &amp;quot;comparison between signed and unsigned
integer expressions&amp;quot; warning.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30486"&gt;bpo-30486&lt;/a&gt;: Make cell_set_contents() symbol private. Don't export the
&lt;tt class="docutils literal"&gt;cell_set_contents()&lt;/tt&gt; symbol in the C API.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2017 Q3: Part 2 (dangling threads)</title><link href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html" rel="alternate"></link><published>2017-10-19T15:00:00+02:00</published><updated>2017-10-19T15:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-10-19:/contrib-cpython-2017q3-part2.html</id><summary type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q3
(july, august, september), Part 2: &amp;quot;Dangling threads&amp;quot;.&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html"&gt;My contributions to CPython during 2017 Q3: Part 1&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next reports:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html"&gt;My contributions to CPython during 2017 Q3: Part 3 (funny bugs)&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Summary:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Bugfixes: Reference cycles&lt;/li&gt;
&lt;li&gt;socketserver leaking threads and processes&lt;ul&gt;
&lt;li&gt;test_logging random bug …&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q3
(july, august, september), Part 2: &amp;quot;Dangling threads&amp;quot;.&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html"&gt;My contributions to CPython during 2017 Q3: Part 1&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next reports:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html"&gt;My contributions to CPython during 2017 Q3: Part 3 (funny bugs)&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Summary:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Bugfixes: Reference cycles&lt;/li&gt;
&lt;li&gt;socketserver leaking threads and processes&lt;ul&gt;
&lt;li&gt;test_logging random bug&lt;/li&gt;
&lt;li&gt;Skip failing tests&lt;/li&gt;
&lt;li&gt;Fix socketserver for processes&lt;/li&gt;
&lt;li&gt;Fix socketserver for threads&lt;/li&gt;
&lt;li&gt;Issue not done yet&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Environment altered and dangling threads&lt;ul&gt;
&lt;li&gt;Environment changed&lt;/li&gt;
&lt;li&gt;test.support and regrtest enhancements&lt;/li&gt;
&lt;li&gt;multiprocessing bug fixes&lt;/li&gt;
&lt;li&gt;concurrent.futures bug fixes&lt;/li&gt;
&lt;li&gt;test_threading and test_thread&lt;/li&gt;
&lt;li&gt;Other fixes&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="bugfixes-reference-cycles"&gt;
&lt;h2&gt;Bugfixes: Reference cycles&lt;/h2&gt;
&lt;p&gt;While fixing &amp;quot;dangling threads&amp;quot; (see below), I found and fixed 4 reference
cycles which caused memory leaks and objects to live longer than expected. I
was surprised that the bug in the common &lt;tt class="docutils literal"&gt;socket.create_connection()&lt;/tt&gt;
function was not noticed before! So my work on dangling threads was useful!&lt;/p&gt;
&lt;p&gt;The typical pattern of such reference cycle is:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def func():
    err = None
    try:
        do_something()
    except Exception as exc:
        err = exc
    if err is not None:
        handle_error(exc)
    # the exception is stored in the 'err' variable

func()
# surprise, surprise, the exception is still alive at this point!
&lt;/pre&gt;
&lt;p&gt;Or the variant:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def func():
    try:
        do_something()
    except Exception as exc:
        exc_info = sys.exc_info()
        handle_error(exc_info)
    # the exception is stored in the 'exc_info' variable

func()
# surprise, surprise, the exception is still alive at this point!
&lt;/pre&gt;
&lt;p&gt;It's not easy to spot the bug, the bug is subtle. An exception object in Python
3 has a &lt;tt class="docutils literal"&gt;__traceback__&lt;/tt&gt; attribute which contains frames. If a frame stores
the exception in a variable, like &lt;tt class="docutils literal"&gt;err&lt;/tt&gt; in the first example, or &lt;tt class="docutils literal"&gt;exc_info&lt;/tt&gt;
in the second example, a cycle exists between the exception and frames. In this
case, the exception, the traceback, the frames, &lt;strong&gt;and all variables of all
frames are kept alive&lt;/strong&gt; by the reference cycle, &lt;strong&gt;until the cycle is break by
the garbage collector&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;The problem is that the garbage collector is only called infrequently, so the
cycle may stay alive for a long time.&lt;/p&gt;
&lt;p&gt;Sometimes, the reference cycle is even more subtle than the simple examples
above.&lt;/p&gt;
&lt;p&gt;Fixed reference cycles:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;,
&lt;tt class="docutils literal"&gt;socket.create_connection()&lt;/tt&gt;: Fix reference cycle.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31247"&gt;bpo-31247&lt;/a&gt;: &lt;tt class="docutils literal"&gt;xmlrpc.server&lt;/tt&gt; now explicitly breaks reference cycles when using
&lt;tt class="docutils literal"&gt;sys.exc_info()&lt;/tt&gt; in code handling exceptions.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31249"&gt;bpo-31249&lt;/a&gt;, &lt;tt class="docutils literal"&gt;concurrent.futures&lt;/tt&gt;:
&lt;tt class="docutils literal"&gt;WorkItem.run()&lt;/tt&gt; used by ThreadPoolExecutor now explicitly breaks a
reference cycle between an exception object and the &lt;tt class="docutils literal"&gt;WorkItem&lt;/tt&gt; object.
&lt;tt class="docutils literal"&gt;ThreadPoolExecutor.shutdown()&lt;/tt&gt; now also clears its threads set.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31238"&gt;bpo-31238&lt;/a&gt;: &lt;tt class="docutils literal"&gt;pydoc&lt;/tt&gt;:
&lt;tt class="docutils literal"&gt;ServerThread.stop()&lt;/tt&gt; now joins itself to wait until
&lt;tt class="docutils literal"&gt;DocServer.serve_until_quit()&lt;/tt&gt; completes and then explicitly sets its
docserver attribute to None to break a reference cycle. This change was made
to fix &lt;tt class="docutils literal"&gt;test_doc&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31323"&gt;bpo-31323&lt;/a&gt;: Fix reference leak in
test_ssl. Store exceptions as string rather than object to prevent reference
cycles which cause leaking dangling threads.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I also started a discussion on reference cycles caused by exceptions:
&lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-September/149586.html"&gt;[Python-Dev] Evil reference cycles caused Exception.__traceback__&lt;/a&gt;.
Sadly, no action was taken, no obvious solution was found.&lt;/p&gt;
&lt;p&gt;I found the &lt;tt class="docutils literal"&gt;socket.create_connection()&lt;/tt&gt; reference cycle because of an
unrelated change in test.support:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bpo-29639: change test.support.HOST to &amp;quot;localhost&amp;quot;
&lt;/pre&gt;
&lt;p&gt;Read &lt;a class="reference external" href="https://bugs.python.org/issue29639#msg302087"&gt;my message&lt;/a&gt; on bpo-29639
for the full story. Extract:&lt;/p&gt;
&lt;blockquote&gt;
Modifying support.HOST to &amp;quot;localhost&amp;quot; triggered a reference cycle!?&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="socketserver-leaking-threads-and-processes"&gt;
&lt;h2&gt;socketserver leaking threads and processes&lt;/h2&gt;
&lt;div class="section" id="test-logging-random-bug"&gt;
&lt;h3&gt;test_logging random bug&lt;/h3&gt;
&lt;p&gt;This story starts at July, 3, with test_logging failing randomly on FreeBSD,
&lt;a class="reference external" href="https://bugs.python.org/issue30830"&gt;bpo-30830&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
test_output (test.test_logging.HTTPHandlerTest) ... ok
Warning -- threading_cleanup() failed to cleanup -1 threads after 3 sec (count: 0, dangling: 1)
&lt;/pre&gt;
&lt;p&gt;I failed to reproduce the bug on my FreeBSD VM, nor on Linux. The bug only
occurred on one specific FreeBSD buildbot. I even got access to the buildbot...
and I still failed to reproduce the bug! I tried to run test_logging multiple
times in parallel, increase the system load, etc. I felt disappointed. I used
my &lt;tt class="docutils literal"&gt;system_load.py&lt;/tt&gt; script which spawns Python processes running &lt;tt class="docutils literal"&gt;while 1:
pass&lt;/tt&gt; to stress the CPU.&lt;/p&gt;
&lt;p&gt;After one month, I succeeded to reproduce the bug by running two commands in
parallel.&lt;/p&gt;
&lt;p&gt;Command 1 to trigger the bug:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
./python -m test -v test_logging \
    --fail-env-changed \
    --forever \
    -m test.test_logging.DatagramHandlerTest.test_output \
    -m test.test_logging.ConfigDictTest.test_listen_config_10_ok \
    -m test.test_logging.SocketHandlerTest.test_output
&lt;/pre&gt;
&lt;p&gt;Command 2 to stress the system:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
./python -m test -j4
&lt;/pre&gt;
&lt;p&gt;It seems like the Python test suite is a very good tool to stress a system to
trigger a race condition!&lt;/p&gt;
&lt;p&gt;Finally, I was able to identify the bug:&lt;/p&gt;
&lt;blockquote&gt;
The problem is that &lt;tt class="docutils literal"&gt;socketserver.ThreadingMixIn&lt;/tt&gt; spawns threads without
waiting for their completion in server_close().&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="skip-failing-tests"&gt;
&lt;h3&gt;Skip failing tests&lt;/h3&gt;
&lt;p&gt;To stabilize the buildbots and to be able to work on other bugs, I decided to
first skip all tests using &lt;tt class="docutils literal"&gt;socketserver.ThreadingMixIn&lt;/tt&gt; until this class was
fixed to prevent &amp;quot;dangling threads&amp;quot;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-socketserver-for-processes"&gt;
&lt;h3&gt;Fix socketserver for processes&lt;/h3&gt;
&lt;p&gt;While trying to see how to fix &lt;tt class="docutils literal"&gt;socketserver.ThreadingMixIn&lt;/tt&gt;, I understood
that &lt;a class="reference external" href="https://bugs.python.org/issue31151"&gt;bpo-31151&lt;/a&gt; was a similar bug in
the &lt;tt class="docutils literal"&gt;socketserver&lt;/tt&gt; module but for processes:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
test_ForkingUDPServer (test.test_socketserver.SocketServerTest) ... creating server
(...)
Warning -- reap_children() reaped child process 18281
&lt;/pre&gt;
&lt;p&gt;My analysis:&lt;/p&gt;
&lt;blockquote&gt;
The problem is that &lt;tt class="docutils literal"&gt;socketserver.ForkinMixin&lt;/tt&gt; doesn't wait until all
children completes. It only calls &lt;tt class="docutils literal"&gt;os.waitpid()&lt;/tt&gt; in non-blocking module
(using &lt;tt class="docutils literal"&gt;os.WNOHANG&lt;/tt&gt;) after each loop iteration. If a child process
completes after the last call to &lt;tt class="docutils literal"&gt;ForkingMixIn.collect_children()&lt;/tt&gt;, the
server leaks zombie processes.&lt;/blockquote&gt;
&lt;p&gt;I fixed &lt;tt class="docutils literal"&gt;socketserver.ForkingMixIn&lt;/tt&gt; by modifying the &lt;tt class="docutils literal"&gt;server_close()&lt;/tt&gt;
method to &lt;strong&gt;block&lt;/strong&gt; until all child processes complete: &lt;a class="reference external" href="https://github.com/python/cpython/commit/aa8ec34ad52bb3b274ce91169e1bc4a598655049"&gt;commit&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Just after pushing my fix, I understood that my fix changed the
&lt;tt class="docutils literal"&gt;ForkingMixIn&lt;/tt&gt; behaviour. I wrote an email to ask if it's the good behaviour
or if a change was needed: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-August/148826.html"&gt;[Python-Dev] socketserver ForkingMixin waiting for
child processes&lt;/a&gt;.
The answer is that not everybody wants this behaviour. Sadly, I didn't have
time yet to let the user chooses the behaviour.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-socketserver-for-threads"&gt;
&lt;h3&gt;Fix socketserver for threads&lt;/h3&gt;
&lt;p&gt;Fixing &lt;tt class="docutils literal"&gt;socketserver.ForkinMixin&lt;/tt&gt; was simple because the code already tracked
the (identifier of) child processes and already had code to wait for child
completion.&lt;/p&gt;
&lt;p&gt;Fixing &lt;tt class="docutils literal"&gt;socketserver.ThreadingMixIn&lt;/tt&gt; (&lt;a class="reference external" href="https://bugs.python.org/issue31233"&gt;bpo-31233&lt;/a&gt;) was more complicated since it didn't
keep track of spawned threads.&lt;/p&gt;
&lt;p&gt;I chose to keep a list of &lt;tt class="docutils literal"&gt;threading.Thread&lt;/tt&gt; objects, but only for
non-daemonic threads. &lt;tt class="docutils literal"&gt;socketserver.ThreadingMixIn.server_close()&lt;/tt&gt; now joins
all threads: &lt;a class="reference external" href="https://github.com/python/cpython/commit/b8f4163da30e16c7cd58fe04f4b17e38d53cd57e"&gt;commit&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="issue-not-done-yet"&gt;
&lt;h3&gt;Issue not done yet&lt;/h3&gt;
&lt;p&gt;As I wrote above, the &lt;tt class="docutils literal"&gt;socketserver&lt;/tt&gt; still needs to be reworked to let the
user decides if the server must gracefully wait for child completion or not.
Maybe expose also a method to explicitly wait for children, maybe with a
timeout?&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="environment-altered-and-dangling-threads"&gt;
&lt;h2&gt;Environment altered and dangling threads&lt;/h2&gt;
&lt;p&gt;This part kept me busy for the whole quarter. While trying to fix &amp;quot;all bugs&amp;quot;, I
looked at two specific &amp;quot;environment changes&amp;quot;: &amp;quot;dangling threads&amp;quot; and &amp;quot;zombie
processes&amp;quot;. A dangling thread comes from a test spawning a thread but doesn't
proper &amp;quot;clean&amp;quot; the thread.&lt;/p&gt;
&lt;p&gt;Leaking threads or processes is a very bad side effect since it is likely to
cause random bugs in following tests.&lt;/p&gt;
&lt;p&gt;At the beginning, I expected that only 2 or 3 bugs should be fixed. At the end,
it was closer to 100 bugs. I don't regret, I'm now sure that I made the Python
test suite more reliable, and this work allowed me to catch &lt;strong&gt;and fix&lt;/strong&gt; old
reference cycles bugs (see above).&lt;/p&gt;
&lt;div class="section" id="environment-changed"&gt;
&lt;h3&gt;Environment changed&lt;/h3&gt;
&lt;p&gt;To detect bugs, I modified Travis CI jobs, AppVeyor and buildbots to run tests
with &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--fail-env-changed&lt;/span&gt;&lt;/tt&gt;. With this option, if a test alters the
environment, the full test suite is marked as failed with &amp;quot;ENV_CHANGED&amp;quot;.&lt;/p&gt;
&lt;p&gt;I also fixed &lt;tt class="docutils literal"&gt;python3 &lt;span class="pre"&gt;-m&lt;/span&gt; test &lt;span class="pre"&gt;--fail-env-changed&lt;/span&gt; &lt;span class="pre"&gt;--forever&lt;/span&gt;&lt;/tt&gt; in &lt;a class="reference external" href="https://bugs.python.org/issue30764"&gt;bpo-30764&lt;/a&gt;: --forever now stops if a test alters
the environment.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="test-support-and-regrtest-enhancements"&gt;
&lt;h3&gt;test.support and regrtest enhancements&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30845"&gt;bpo-30845&lt;/a&gt;: reap_children() now logs
warnings.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;support.reap_children()&lt;/tt&gt; now sets environment_altered to &lt;tt class="docutils literal"&gt;True&lt;/tt&gt; if a
test leaked a zombie process, to detect bugs using &lt;tt class="docutils literal"&gt;python3 &lt;span class="pre"&gt;-m&lt;/span&gt; test
&lt;span class="pre"&gt;--fail-env-changed&lt;/span&gt;&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;regrtest: count also &amp;quot;env changed&amp;quot; tests as failed tests in the test
progress.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;:
&lt;tt class="docutils literal"&gt;support.threading_cleanup()&lt;/tt&gt; now emits a warning immediately if there are
threads running in the background, to be able to catch bugs more easily.
Previously, the warning was only emitted if the function failed to cleanup
these threads after 1 second.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: Add
&lt;tt class="docutils literal"&gt;test.support.wait_threads_exit()&lt;/tt&gt;. Use &lt;tt class="docutils literal"&gt;_thread.count()&lt;/tt&gt; to wait until
threads exit. The new context manager prevents the &amp;quot;dangling thread&amp;quot; warning.
Add also &lt;tt class="docutils literal"&gt;support.join_thread()&lt;/tt&gt; helper: joins a thread but raises an
AssertionError if the thread is still alive after &lt;em&gt;timeout&lt;/em&gt; seconds.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="multiprocessing-bug-fixes"&gt;
&lt;h3&gt;multiprocessing bug fixes&lt;/h3&gt;
&lt;p&gt;The multiprocessing module is very complex. multiprocessing tests are failing
randomly for years, but nobody seems able to fix them. I can only hope that my
following fixes will help to make these tests more reliable.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;multiprocessing.Queue.join_thread() now waits until the thread
completes, even if the thread was started by the same process which
created the queue.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue26762"&gt;bpo-26762&lt;/a&gt;: Avoid daemon processes in _test_multiprocessing. test_level() of
_test_multiprocessing._TestLogging now uses regular processes rather than
daemon processes to prevent zombi processes (to not &amp;quot;leak&amp;quot; processes).&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue26762"&gt;bpo-26762&lt;/a&gt;: Fix more dangling processes and threads in test_multiprocessing.
Queue: call close() followed by join_thread(). Process: call join() or
self.addCleanup(p.join).&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue26762"&gt;bpo-26762&lt;/a&gt;: test_multiprocessing now detects dangling processes and threads
per test case classes.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue26762"&gt;bpo-26762&lt;/a&gt;: test_multiprocessing close more queues. Close explicitly queues to
make sure that we don't leave dangling threads. test_queue_in_process():
remove unused queue. test_access() joins also the process to fix a random
warning.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue26762"&gt;bpo-26762&lt;/a&gt;: _test_multiprocessing now marks the test as ENV_CHANGED on
dangling process or thread.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31069"&gt;bpo-31069&lt;/a&gt;, Fix a warning about dangling processes in test_rapid_restart() of
_test_multiprocessing: join the process.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;, test_multiprocessing:
Give 30 seconds to join_process(), instead of 5 or 10 seconds, to wait until
the process completes.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="concurrent-futures-bug-fixes"&gt;
&lt;h3&gt;concurrent.futures bug fixes&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30845"&gt;bpo-30845&lt;/a&gt;: Enhance test_concurrent_futures cleanup. Make sure that tests
don't leak threads nor processes. Clear explicitly the reference to the
executor to make sure that it's destroyed.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31249"&gt;bpo-31249&lt;/a&gt;: test_concurrent_futures checks dangling threads. Add a
BaseTestCase class to test_concurrent_futures to check for dangling threads
and processes on all tests, not only tests using ExecutorMixin.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31249"&gt;bpo-31249&lt;/a&gt;: Fix test_concurrent_futures dangling thread.
ProcessPoolShutdownTest.test_del_shutdown() now closes the call queue and
joins its thread, to prevent leaking a dangling thread.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="test-threading-and-test-thread"&gt;
&lt;h3&gt;test_threading and test_thread&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: test_threaded_import: fix
test_side_effect_import().  Don't leak the module into sys.modules. Avoid
also dangling threads.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;:
test_thread.test_forkinthread() now waits until the thread completes.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: Try to fix the
threading_cleanup() warning in test.lock_tests: wait a little bit longer to
give time to the threads to complete. Warning seen on test_thread and
test_importlib.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: Join threads in test_threading. Call thread.join() to prevent the
&amp;quot;dangling thread&amp;quot; warning.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: Join timers in
test_threading. Call the .join() method of threading.Timer timers to prevent
the threading_cleanup() warning.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="other-fixes"&gt;
&lt;h3&gt;Other fixes&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;test_urllib2_localnet: clear server variable. Set the server attribute to
None in cleanup to avoid dangling threads.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30818"&gt;bpo-30818&lt;/a&gt;: test_ftplib calls asyncore.close_all(). Always clear asyncore
socket map using asyncore.close_all(ignore_all=True) in tearDown() method.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30908"&gt;bpo-30908&lt;/a&gt;: Fix dangling thread in test_os.TestSendfile. tearDown() now clears
explicitly the self.server variable to make sure that the thread is
completely cleared when tearDownClass() checks if all threads have been
cleaned up.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31067"&gt;bpo-31067&lt;/a&gt;: test_subprocess now also calls reap_children() in tearDown(), not
only on setUp().&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31160"&gt;bpo-31160&lt;/a&gt;: Fix test_builtin for zombie process. PtyTests.run_child() now calls
os.waitpid() to read the exit status of the child process to avoid creating
zombie process and leaking processes in the background.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31160"&gt;bpo-31160&lt;/a&gt;: Fix test_random for zombie process. TestModule.test_after_fork()
now calls os.waitpid() to read the exit status of the child process to avoid
creating a zombie process.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31160"&gt;bpo-31160&lt;/a&gt;: test_tempfile: TestRandomNameSequence.test_process_awareness() now
calls os.waitpid() to avoid leaking a zombie process.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: fork_wait.py tests now joins threads, to not leak running threads
in the background.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30830"&gt;bpo-30830&lt;/a&gt;: test_logging uses threading_setup/cleanup. Replace
&amp;#64;support.reap_threads on some methods with support.threading_setup() in
setUp() and support.threading_cleanup() in tearDown() in BaseTest.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: test_httpservers joins the server thread.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31250"&gt;bpo-31250&lt;/a&gt;, test_asyncio: fix dangling threads. Explicitly call
shutdown(wait=True) on executors to wait until all threads complete to
prevent side effects between tests. Fix test_loop_self_reading_exception():
don't mock loop.close().  Previously, the original close() method was called
rather than the mock, because how set_event_loop() registered loop.close().&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: Explicitly clear the server attribute in test_ftplib and
test_poplib to prevent dangling thread. Clear also self.server_thread
attribute in TestTimeouts.tearDown().&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: Join threads in tests. Call thread.join() on threads to prevent
the &amp;quot;dangling threads&amp;quot; warning.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: Join threads in test_hashlib: use thread.join() to wait until the
parallel hash tasks complete rather than using events. Calling thread.join()
prevent &amp;quot;dangling thread&amp;quot; warnings.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31234"&gt;bpo-31234&lt;/a&gt;: Join threads in test_queue. Call thread.join() to prevent the
&amp;quot;dangling thread&amp;quot; warning.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Next report:&lt;/strong&gt; &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html"&gt;My contributions to CPython during 2017 Q3: Part 3 (funny
bugs)&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2017 Q3: Part 1</title><link href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html" rel="alternate"></link><published>2017-10-18T15:00:00+02:00</published><updated>2017-10-18T15:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-10-18:/contrib-cpython-2017q3-part1.html</id><summary type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q3
(july, august, september), Part 1.&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html"&gt;My contributions to CPython during 2017 Q2 (part1)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next reports:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html"&gt;My contributions to CPython during 2017 Q3: Part 2 (dangling
threads)&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html"&gt;My contributions to CPython during 2017 Q3: Part 3 (funny bugs)&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Summary:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Statistics&lt;/li&gt;
&lt;li&gt;Security fixes …&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q3
(july, august, september), Part 1.&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html"&gt;My contributions to CPython during 2017 Q2 (part1)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next reports:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html"&gt;My contributions to CPython during 2017 Q3: Part 2 (dangling
threads)&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part3.html"&gt;My contributions to CPython during 2017 Q3: Part 3 (funny bugs)&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Summary:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Statistics&lt;/li&gt;
&lt;li&gt;Security fixes&lt;/li&gt;
&lt;li&gt;Enhancement: socket.close() now ignores ECONNRESET&lt;/li&gt;
&lt;li&gt;Removal of the macOS job of Travis CI&lt;/li&gt;
&lt;li&gt;New test.pythoninfo utility&lt;/li&gt;
&lt;li&gt;Revert commits if buildbots are broken&lt;/li&gt;
&lt;li&gt;Fix the Python test suite&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="statistics"&gt;
&lt;h2&gt;Statistics&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
# All branches
$ git log --after=2017-06-30 --before=2017-10-01 --reverse --branches='*' --author=Stinner|grep '^commit ' -c
209

# Master branch only
$ git log --after=2017-06-30 --before=2017-10-01 --reverse --author=Stinner origin/master|grep '^commit ' -c
97
&lt;/pre&gt;
&lt;p&gt;Statistics: I pushed &lt;strong&gt;97&lt;/strong&gt; commits in the master branch on a &lt;strong&gt;total of 209
commits&lt;/strong&gt;, remaining: 112 commits in the other branches (backports, fixes
specific to Python 2.7, security fixes in Python 3.3 and 3.4, etc.)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="security-fixes"&gt;
&lt;h2&gt;Security fixes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30947"&gt;bpo-30947&lt;/a&gt;: Update libexpat from 2.2.1 to 2.2.3. Fix applied to master, 3.6,
3.5, 3.4, 3.3 and 2.7 branches! Expat 2.2.2 and 2.2.3 fixed multiple security
vulnerabilities.
&lt;a class="reference external" href="http://python-security.readthedocs.io/vuln/expat_2.2.3.html"&gt;http://python-security.readthedocs.io/vuln/expat_2.2.3.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Fix whichmodule() of _pickle: : _PyUnicode_FromId() can return NULL, replace
Py_INCREF() with Py_XINCREF(). Fix coverity report: CID 1417269.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30860"&gt;bpo-30860&lt;/a&gt;: &lt;tt class="docutils literal"&gt;_PyMem_Initialize()&lt;/tt&gt; contains code which is never executed.
Replace the runtime check with a build assertion. Fix Coverity CID 1417587.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;See also my &lt;a class="reference external" href="http://python-security.readthedocs.io/"&gt;python-security website&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="enhancement-socket-close-now-ignores-econnreset"&gt;
&lt;h2&gt;Enhancement: socket.close() now ignores ECONNRESET&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30319"&gt;bpo-30319&lt;/a&gt;: socket.close() now ignores ECONNRESET. Previously, many network
tests failed randomly with ConnectionResetError on socket.close().&lt;/p&gt;
&lt;p&gt;Patching all functions calling socket.close() would require a lot of work, and
it was surprising to get a &amp;quot;connection reset&amp;quot; when closing a socket.&lt;/p&gt;
&lt;p&gt;Who cares that the peer closed the connection, since we are already closing
it!?&lt;/p&gt;
&lt;p&gt;Note: socket.close() was modified in Python 3.6 to raise OSError on failure
(&lt;a class="reference external" href="https://bugs.python.org/issue26685"&gt;bpo-26685&lt;/a&gt;).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="removal-of-the-macos-job-of-travis-ci"&gt;
&lt;h2&gt;Removal of the macOS job of Travis CI&lt;/h2&gt;
&lt;a class="reference external image-reference" href="https://travis-ci.org/"&gt;&lt;img alt="call_method microbenchmark" class="align-right" src="https://vstinner.github.io/images/travis-ci.png" /&gt;&lt;/a&gt;
&lt;p&gt;While the Linux jobs of Travis CI usually takes 15 minutes, up to 30 minutes in
the worst case, the macOS job of Travis CI regulary took longer than 30
minutes, sometimes longer than 1 hour.&lt;/p&gt;
&lt;p&gt;While the macOS job was optional, sometimes it gone mad and prevented a PR to
be merged. Cancelling the job marked Travis CI as failed on a PR, so it was
still not possible to merge the PR, whereas, again, the job is marked as
optional (&amp;quot;Allowed Failure&amp;quot;).&lt;/p&gt;
&lt;p&gt;Moreover, when the macOS job failed, the failure was not reported on the PR,
since the job was marked as optional. The only way to notify a failure was to
go to Travis CI and wait at least 30 minutes (whereas the Linux jobs already
completed and it was already possible merge a PR...).&lt;/p&gt;
&lt;p&gt;I sent a first mail in June: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-committers/2017-June/004661.html"&gt;[python-committers] macOS Travis CI job became
mandatory?&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;In september, we decided to remove the macOS job during the CPython sprint at
Instagram (see my previous &lt;a class="reference external" href="https://vstinner.github.io/new-python-c-api.html"&gt;New C API&lt;/a&gt;
article), to not slowdown our development speed (&lt;a class="reference external" href="https://bugs.python.org/issue31355"&gt;bpo-31355&lt;/a&gt;). I sent another
email to announce the change: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-committers/2017-September/004824.html"&gt;[python-committers] Travis CI: macOS is now
blocking -- remove macOS from Travis CI?&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;After the sprint, it was decided to not add again the macOS job, since we have
3 macOS buildbots. It's enough to detect regressions specific to macOS.&lt;/p&gt;
&lt;p&gt;After the removal of the macOS end, at the end of september, Travis CI
published an article about the bad performances of their macOS fleet: &lt;a class="reference external" href="https://blog.travis-ci.com/2017-09-22-macos-update"&gt;Updating
Our macOS Open Source Offering&lt;/a&gt;. Sadly, the article
confirms that the situation is not going to evolve quickly.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-test-pythoninfo-utility"&gt;
&lt;h2&gt;New test.pythoninfo utility&lt;/h2&gt;
&lt;p&gt;To understand the &amp;quot;Segfault when readline history is more then 2 * history
size&amp;quot; crash of &lt;a class="reference external" href="https://bugs.python.org/issue29854"&gt;bpo-29854&lt;/a&gt;, I modified
&lt;tt class="docutils literal"&gt;test_readline&lt;/tt&gt; to log libreadline  versions.  I also added
&lt;tt class="docutils literal"&gt;readline._READLINE_LIBRARY_VERSION&lt;/tt&gt;. My colleague &lt;strong&gt;Nir Soffer&lt;/strong&gt; wrote the
final readline fix: skip the test on old readline versions.&lt;/p&gt;
&lt;p&gt;As a follow-up of this issue, I added a new &lt;tt class="docutils literal"&gt;test.pythoninfo&lt;/tt&gt; program to log
many information to debug Python tests (&lt;a class="reference external" href="https://bugs.python.org/issue30871"&gt;bpo-30871&lt;/a&gt;). pythoninfo is now run on
Travis CI, AppVeyor and buildbots.&lt;/p&gt;
&lt;p&gt;Example of output:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test.pythoninfo
(...)
_decimal.__libmpdec_version__: 2.4.2
expat.EXPAT_VERSION: expat_2.2.4
gdb_version: GNU gdb (GDB) Fedora 8.0.1-26.fc26
locale.encoding: UTF-8
os.cpu_count: 4
(...)
time.timezone: -3600
time.tzname: ('CET', 'CEST')
tkinter.TCL_VERSION: 8.6
tkinter.TK_VERSION: 8.6
tkinter.info_patchlevel: 8.6.6
zlib.ZLIB_RUNTIME_VERSION: 1.2.11
zlib.ZLIB_VERSION: 1.2.11
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;test.pythoninfo&lt;/tt&gt; can be easily extended to log more information, without
polluting the output of the Python test suite which is already too verbose and
very long.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="revert-commits-if-buildbots-are-broken"&gt;
&lt;h2&gt;Revert commits if buildbots are broken&lt;/h2&gt;
&lt;p&gt;Thanks to my work done last months on the Python test suite, the buildbots are
now very reliable. When a buildbot fails, it becomes very likely that it's a
real regression, and not a random failure caused by a bug in the Python test
suite.&lt;/p&gt;
&lt;p&gt;I proposed a new rule: &lt;strong&gt;revert a change if it breaks builbots and the but
cannot be fixed easily&lt;/strong&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;So I would like to set a new rule: if I'm unable to fix buildbots
failures caused by a recent change quickly (say, in less than 2
hours), I propose to revert the change.&lt;/p&gt;
&lt;p&gt;It doesn't mean that the commit is bad and must not be merged ever.
No. It would just mean that we need time to work on fixing the issue,
and it shouldn't impact other pending changes, to keep a sane master
branch.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a class="reference external" href="https://mail.python.org/pipermail/python-committers/2017-June/004588.html"&gt;[python-committers] Revert changes which break too many buildbots&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="test-datetime"&gt;
&lt;h3&gt;test_datetime&lt;/h3&gt;
&lt;p&gt;The first revert was an enhancement of test_datetime, &lt;a class="reference external" href="https://bugs.python.org/issue30822"&gt;bpo-30822&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 98b6bc3bf72532b784a1c1fa76eaa6026a663e44
Author: Utkarsh Upadhyay &amp;lt;mail&amp;#64;musicallyut.in&amp;gt;
Date:   Sun Jul 2 14:46:04 2017 +0200

    bpo-30822: Fix testing of datetime module. (#2530)

    Only C implementation was tested.
&lt;/pre&gt;
&lt;p&gt;I wrote an email to announce the revert: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-committers/2017-July/004673.html"&gt;[python-committers] Revert changes
which break too many buildbots&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It took 15 days to decide how to fix properly the issue (exclude &lt;tt class="docutils literal"&gt;tzdata&lt;/tt&gt;
from test resources). I don't regret my revert, since having broken buildbots
for 15 days would be very annoying.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-gdb-py-fix"&gt;
&lt;h3&gt;python-gdb.py fix&lt;/h3&gt;
&lt;p&gt;I also reverted this commit of &lt;a class="reference external" href="https://bugs.python.org/issue30983"&gt;bpo-30983&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
commit 2e0f4db114424a00354eab889ba8f7334a2ab8f0
Author: Bruno &amp;quot;Polaco&amp;quot; Penteado &amp;lt;polaco&amp;#64;gmail.com&amp;gt;
Date:   Mon Aug 14 23:14:17 2017 +0100

    bpo-30983: eval frame rename in pep 0523 broke gdb's python extension (#2803)

    pep 0523 renames PyEval_EvalFrameEx to _PyEval_EvalFrameDefault while the gdb python extension only looks for PyEval_EvalFrameEx to understand if it is dealing with a frame.

    Final effect is that attaching gdb to a python3.6 process doesnt resolve python objects. Eg. py-list and py-bt dont work properly.

    This patch fixes that. Tested locally on python3.6
&lt;/pre&gt;
&lt;p&gt;My comment on the issue:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I chose to revert the change because I don't have the bandwidth right now
to investigate why the change broke test_gdb.&lt;/p&gt;
&lt;p&gt;I'm surprised that a change affecting python-gdb.py wasn't properly tested
manually using test_gdb.py :-( I understand that Travis CI doesn't have gdb
and/or that the test pass in some cases?&lt;/p&gt;
&lt;p&gt;The revert only gives us more time to design the proper solution.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Hopefully, a new fixed commit was pushed 4 days later and this one didn't break
buildbots!&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-the-python-test-suite"&gt;
&lt;h2&gt;Fix the Python test suite&lt;/h2&gt;
&lt;p&gt;As usual, I spent a significant part of my time to fix bugs in the Python test
suite to make it more reliable and more &amp;quot;usable&amp;quot;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30822"&gt;bpo-30822&lt;/a&gt;: Exclude &lt;tt class="docutils literal"&gt;tzdata&lt;/tt&gt; from &lt;tt class="docutils literal"&gt;regrtest &lt;span class="pre"&gt;--all&lt;/span&gt;&lt;/tt&gt;. When running the test suite
using &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--use=all&lt;/span&gt;&lt;/tt&gt; / &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-u&lt;/span&gt; all&lt;/tt&gt;, exclude &lt;tt class="docutils literal"&gt;tzdata&lt;/tt&gt; since it makes
test_datetime too slow (15-20 min on some buildbots, just this single test
file) which then times out on some buildbots. &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-u&lt;/span&gt; tzdata&lt;/tt&gt; must now be
enabled explicitly.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30188"&gt;bpo-30188&lt;/a&gt;, test_nntplib: Catch also
ssl.SSLEOFError in NetworkedNNTPTests.setUpClass(), not only EOFError.
(&lt;em&gt;Sadly, test_nntplib still fails randomly with EOFError or SSLEOFError...&lt;/em&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31009"&gt;bpo-31009&lt;/a&gt;: Fix
&lt;tt class="docutils literal"&gt;support.fd_count()&lt;/tt&gt; on Windows. Call &lt;tt class="docutils literal"&gt;msvcrt.CrtSetReportMode()&lt;/tt&gt; to not
kill the process nor log any error on stderr on os.dup(fd) if the file
descriptor is invalid.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31034"&gt;bpo-31034&lt;/a&gt;: Reliable signal handler for test_asyncio. Don't rely on the
current SIGHUP signal handler, make sure that it's set to the &amp;quot;default&amp;quot;
signal handler: SIG_DFL. A colleague reported me that the Python test suite
hangs on running test_subprocess_send_signal() of test_asyncio. After
analysing the issue, it seems like the test hangs because the RPM package
builder ignores SIGHUP.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31028"&gt;bpo-31028&lt;/a&gt;: Fix test_pydoc when run
directly. Fix &lt;tt class="docutils literal"&gt;get_pydoc_link()&lt;/tt&gt;: get the absolute path to &lt;tt class="docutils literal"&gt;__file__&lt;/tt&gt; to
prevent relative directories.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31066"&gt;bpo-31066&lt;/a&gt;: Fix
&lt;tt class="docutils literal"&gt;test_httpservers.test_last_modified()&lt;/tt&gt;. Write the temporary file on disk
and then get its modification time.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31173"&gt;bpo-31173&lt;/a&gt;: Rewrite WSTOPSIG test of test_subprocess.&lt;/p&gt;
&lt;p&gt;The current &lt;tt class="docutils literal"&gt;test_child_terminated_in_stopped_state()&lt;/tt&gt; function test creates a
child process which calls &lt;tt class="docutils literal"&gt;ptrace(PTRACE_TRACEME, 0, 0)&lt;/tt&gt; and then crash
(SIGSEGV). The problem is that calling &lt;tt class="docutils literal"&gt;os.waitpid()&lt;/tt&gt; in the parent process is
not enough to close the process: the child process remains alive and so the
unit test leaks a child process in a strange state. Closing the child process
requires non-trivial code, maybe platform specific.&lt;/p&gt;
&lt;p&gt;Remove the functional test and replaces it with an unit test which mocks
&lt;tt class="docutils literal"&gt;os.waitpid()&lt;/tt&gt; using a new &lt;tt class="docutils literal"&gt;_testcapi.W_STOPCODE()&lt;/tt&gt; function to test the
&lt;tt class="docutils literal"&gt;WIFSTOPPED()&lt;/tt&gt; path.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31008"&gt;bpo-31008&lt;/a&gt;: Fix asyncio
test_wait_for_handle on Windows, tolerate a difference of 50 ms.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31235"&gt;bpo-31235&lt;/a&gt;: Fix ResourceWarning in
test_logging: always close all asyncore dispatchers (ignoring errors if any).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue30121"&gt;bpo-30121&lt;/a&gt;: Add test_subprocess.test_nonexisting_with_pipes(). Test the Popen
failure when Popen was created with pipes. Create also NONEXISTING_CMD
variable in test_subprocess.py.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31250"&gt;bpo-31250&lt;/a&gt;, test_asyncio: fix EventLoopTestsMixin.tearDown(). Call
doCleanups() to close the loop after calling executor.shutdown(wait=True).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;test_ssl: Implement timeout in ssl_io_loop(). The timeout parameter was not
used.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31448"&gt;bpo-31448&lt;/a&gt;, test_poplib: Call POP3.close(), don't close close directly the
sock attribute to fix a ResourceWarning.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;os.test_utime_current(): tolerate 50 ms delta.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31135"&gt;bpo-31135&lt;/a&gt;: ttk: fix LabeledScale and OptionMenu destroy() method. Call the
parent destroy() method even if the used attribute doesn't exist. The
LabeledScale.destroy() method now also explicitly clears label and scale
attributes to help the garbage collector to destroy all widgets.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;&lt;a class="reference external" href="https://bugs.python.org/issue31479"&gt;bpo-31479&lt;/a&gt;: Always reset the signal alarm in tests. Use
the &lt;tt class="docutils literal"&gt;try: ... finally: signal.signal(0)&lt;/tt&gt; pattern to make sure that tests
don't &amp;quot;leak&amp;quot; a pending fatal signal alarm. Move some signal.alarm() calls
into the try block.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Next report:&lt;/strong&gt; &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part2.html"&gt;My contributions to CPython during 2017 Q3: Part 2 (dangling
threads)&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>Python Security</title><link href="https://vstinner.github.io/python-security.html" rel="alternate"></link><published>2017-09-15T22:00:00+02:00</published><updated>2017-09-15T22:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-09-15:/python-security.html</id><summary type="html">&lt;p&gt;I am working on the Python security for years, but I never wrote anything about
that. Let's fix this!&lt;/p&gt;
&lt;div class="section" id="psrt"&gt;
&lt;h2&gt;PSRT&lt;/h2&gt;
&lt;p&gt;I am part of the Python Security Response Team (PSRT): I get emails sent to
&lt;a class="reference external" href="mailto:security&amp;#64;python.org"&gt;security&amp;#64;python.org&lt;/a&gt;. I try to analyze each report to validate that the bug
is …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;I am working on the Python security for years, but I never wrote anything about
that. Let's fix this!&lt;/p&gt;
&lt;div class="section" id="psrt"&gt;
&lt;h2&gt;PSRT&lt;/h2&gt;
&lt;p&gt;I am part of the Python Security Response Team (PSRT): I get emails sent to
&lt;a class="reference external" href="mailto:security&amp;#64;python.org"&gt;security&amp;#64;python.org&lt;/a&gt;. I try to analyze each report to validate that the bug
is reproductible, find impacted Python versions and start to discuss how to fix
the vulnerability. In some cases, the reported issue is not a security
vulnerability, is not related to CPython, or sometimes is already fixed.  We
also get reports about CPython, but also the web sites and other projects
related to Python.&lt;/p&gt;
&lt;p&gt;Warning: I don't represent the PSRT, I speak for my own!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="vulnerabilities-sent-to-psrt"&gt;
&lt;h2&gt;Vulnerabilities sent to PSRT&lt;/h2&gt;
&lt;p&gt;In this article, I will focus on vulnerabilities impacting CPython: the C and
Python code of CPython core and the standard library.&lt;/p&gt;
&lt;p&gt;When vulnerabilities are obvious bugs, they are quickly fixed. Done.&lt;/p&gt;
&lt;p&gt;But it's not uncommon that fixing a vulnerability impacts the backward
compatibility which is a major concern of CPython core developers. There is
also a risk of rejecting legit input data because the added checks are too
strict. We have to be very careful and so fixing vulnerabilities can take
weeks, if not months in the worst case.&lt;/p&gt;
&lt;p&gt;While CPython has few active core developers, the PSRT has even lesser active
members to handle incoming reports. We are volunteers, so please be kind and
patient...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="example-of-a-complex-fix"&gt;
&lt;h2&gt;Example of a complex fix&lt;/h2&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://python-security.readthedocs.io/vuln/urllib_ftp_protocol_stream_injection.html"&gt;urllib FTP protocol stream injection&lt;/a&gt;
vulnerability was reported to the PSRT at 2016-01-15. The fix was only merged
at 2017-07-26.&lt;/p&gt;
&lt;p&gt;First, it was not obvious how the vulnerability can be exploited, nor if it
should be fixed.&lt;/p&gt;
&lt;p&gt;Then it was not obvious if the vulnerability should be fixed in the urllib
module or in the ftplib module.&lt;/p&gt;
&lt;p&gt;Even if the bug was public, it didn't get much attention. Since I don't know
well how the urllib module, I wrote an email to the python-dev mailing
list: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-July/148699.html"&gt;Need help to fix urllib(.parse) vulnerabilities&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I proposed a fix for the urllib module: &lt;a class="reference external" href="https://bugs.python.org/issue30713"&gt;Reject newline character (U+000A) in
URLs in urllib.parse&lt;/a&gt;. But it was
rejected, since it was the wrong approach and my checks were too strict in many
cases (rejected legit requests).&lt;/p&gt;
&lt;p&gt;The final fix rejects &lt;tt class="docutils literal"&gt;\b&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;\r&lt;/tt&gt; newline characters in the putline()
method of the ftplib module.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="track-known-and-fixed-cpython-vulnerabilities"&gt;
&lt;h2&gt;Track known and fixed CPython vulnerabilities&lt;/h2&gt;
&lt;p&gt;Currently, not least that six branches still get security fixes!&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Python 2.7&lt;/li&gt;
&lt;li&gt;Python 3.3&lt;/li&gt;
&lt;li&gt;Python 3.4&lt;/li&gt;
&lt;li&gt;Python 3.5&lt;/li&gt;
&lt;li&gt;Python 3.6&lt;/li&gt;
&lt;li&gt;master: the development branch&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Last year, I added a table to the Python developer guide to help me to track
the status of each branch: see the &lt;a class="reference external" href="https://devguide.python.org/#status-of-python-branches"&gt;Status of Python branches&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This year, I created a tool to help me to track known CPython vulnerabilities:
&lt;a class="reference external" href="https://github.com/vstinner/python-security"&gt;python-security project&lt;/a&gt; (hosted
at GitHub). The &lt;a class="reference external" href="https://github.com/vstinner/python-security/blob/master/vulnerabilities.yaml"&gt;vulnerabilities.yaml file&lt;/a&gt;
is a YAML file with one section per vulnerability. Each vulnerability has
a title, link to the Python bug, disclosure date, reported date, commits, etc.&lt;/p&gt;
&lt;p&gt;The tool gets the date of commits and the Git tags which contains the commit
to infer the first Python versions of each branch which contain the fix. It
also build a timeline to help to understand how the vulnerability was handled.&lt;/p&gt;
&lt;p&gt;I also wanted to be more transparent on how we handle vulnerabilities and our
velocity to fix them.&lt;/p&gt;
&lt;p&gt;Honestly, I was disappointed that it took so long to fix some vulnerabilities
in the past. Hopefully, it seems like we are more reactive nowadays!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="example-of-a-fixed-vulnerability"&gt;
&lt;h2&gt;Example of a fixed vulnerability&lt;/h2&gt;
&lt;p&gt;Example: &lt;a class="reference external" href="https://python-security.readthedocs.io/vuln/cve-2016-5699_http_header_injection.html"&gt;CVE-2016-5699: HTTP header injection&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Right now, Python 3.3 is still vulnerable (my fix was commited, I am now
waiting Python 3.3.7 which is coming at the end of september).&lt;/p&gt;
&lt;p&gt;Since the vulnerability was reported, it took 108 days to merge the fix, 72
more days (total 180 days) for the first release including the fix (Python
2.7.10).&lt;/p&gt;
&lt;p&gt;Sadly, the PSRT doesn't compute a severity of vulnerabilities yet.&lt;/p&gt;
&lt;p&gt;Hopefully, for this vulnerability, web frameworks were able to workaround the
vulnerability by input sanitization.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="backport-all-fixes"&gt;
&lt;h2&gt;Backport all fixes&lt;/h2&gt;
&lt;p&gt;Last months, I backported fixes to the six branches which still accept security
fixes, to respect the contract with our users: we are doing our best to protect
you!&lt;/p&gt;
&lt;p&gt;The good news is that with Python 2.7.14 and Python 3.3.7 releases scheduled
this month, all major security vulnerabilities will be fixed in all maintained
Python branches!&lt;/p&gt;
&lt;p&gt;Some fixes were not backported on purpose. For example, the &lt;a class="reference external" href="https://python-security.readthedocs.io/vuln/cve-2013-7040_hash_not_properly_randomized.html#cve-2013-7040-hash-not-properly-randomized"&gt;CVE-2013-7040:
Hash not properly randomized&lt;/a&gt;
vulnerability requires to change the hash algorithm and we decided to not touch
Python 2.7 and 3.3 for backward compatibility reasons (don't break code relying
on the exact hash function). The issue was fixed in Python 3.4 by using the
SipHash hash algorithm which uses a hash secret (generated randomly by Python
at startup).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-security-documentation"&gt;
&lt;h2&gt;Python security documentation&lt;/h2&gt;
&lt;p&gt;Last months, I also started to collect random notes about the Python security.&lt;/p&gt;
&lt;p&gt;Explore my &lt;a class="reference external" href="https://python-security.readthedocs.io/"&gt;python-security.readthedocs.io&lt;/a&gt; documentation and send me feedback!&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="security"></category><category term="python"></category></entry><entry><title>A New C API for CPython</title><link href="https://vstinner.github.io/new-python-c-api.html" rel="alternate"></link><published>2017-09-07T18:00:00+02:00</published><updated>2017-09-07T18:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-09-07:/new-python-c-api.html</id><summary type="html">&lt;p&gt;I am currently at a CPython sprint 2017 at Facebook. We are discussing my idea
of writing a new C API for CPython hiding implementation details and replacing
macros with function calls.&lt;/p&gt;
&lt;img alt="CPython sprint at Facebook, september 2017" src="https://vstinner.github.io/images/cpython_sprint_sept2017.jpg" /&gt;
&lt;p&gt;This article tries to explain why the CPython C API needs to &lt;strong&gt;evolve&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="section" id="c-api-prevents-further-optimizations"&gt;
&lt;h2&gt;C API prevents further optimizations …&lt;/h2&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;I am currently at a CPython sprint 2017 at Facebook. We are discussing my idea
of writing a new C API for CPython hiding implementation details and replacing
macros with function calls.&lt;/p&gt;
&lt;img alt="CPython sprint at Facebook, september 2017" src="https://vstinner.github.io/images/cpython_sprint_sept2017.jpg" /&gt;
&lt;p&gt;This article tries to explain why the CPython C API needs to &lt;strong&gt;evolve&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="section" id="c-api-prevents-further-optimizations"&gt;
&lt;h2&gt;C API prevents further optimizations&lt;/h2&gt;
&lt;p&gt;The CPython &lt;tt class="docutils literal"&gt;PyListObject&lt;/tt&gt; type uses an array of &lt;tt class="docutils literal"&gt;PyObject*&lt;/tt&gt; objects. PyPy
is able to use a C array of integers if the list only contains small integers.
CPython cannot because PyList_GET_ITEM(list, index) is implemented as a macro:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
#define PyList_GET_ITEM(op, i) ((PyListObject *)op)-&amp;gt;ob_item[i]
&lt;/pre&gt;
&lt;p&gt;The macro relies on the &lt;tt class="docutils literal"&gt;PyListObject&lt;/tt&gt; structure:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
typedef struct {
    PyVarObject ob_base;
    PyObject **ob_item;   // &amp;lt;-- pointer to real data
    Py_ssize_t allocated;
} PyListObject;

typedef struct {
    PyObject ob_base;
    Py_ssize_t ob_size; /* Number of items in variable part */
} PyVarObject;

typedef struct _object {
    Py_ssize_t ob_refcnt;
    struct _typeobject *ob_type;
} PyObject;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="api-and-abi"&gt;
&lt;h2&gt;API and ABI&lt;/h2&gt;
&lt;p&gt;Compiling C extension code using &lt;tt class="docutils literal"&gt;PyList_GET_ITEM()&lt;/tt&gt; produces machine code
accessing &lt;tt class="docutils literal"&gt;PyListObject&lt;/tt&gt; members. Something like (C pseudo code):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PyObject **items;
PyObject *item;
items = (PyObject **)(((char*)list) + 24);
item = items[i];
&lt;/pre&gt;
&lt;p&gt;The offset 24 is hardcoded in the C extension object file: the &lt;strong&gt;API&lt;/strong&gt;
(&lt;strong&gt;programming&lt;/strong&gt; interface) becomes the &lt;strong&gt;ABI&lt;/strong&gt; (&lt;strong&gt;binary&lt;/strong&gt; interface).&lt;/p&gt;
&lt;p&gt;But debug builds use a different memory layout:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
typedef struct _object {
    struct _object *_ob_next;   // &amp;lt;--- two new fields are added
    struct _object *_ob_prev;   // &amp;lt;--- for debug purpose
    Py_ssize_t ob_refcnt;
    struct _typeobject *ob_type;
} PyObject;
&lt;/pre&gt;
&lt;p&gt;The machine code becomes something like:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
items = (PyObject **)(((char*)op) + 40);
item = items[i];
&lt;/pre&gt;
&lt;p&gt;The offset changes from 24 to 40 (+16, two pointers of 8 bytes).&lt;/p&gt;
&lt;p&gt;C extensions have to be recompiled to work on Python compiled in debug mode.&lt;/p&gt;
&lt;p&gt;Another example is Python 2.7 which uses a different ABI for UTF-16 and UCS-4
Unicode string: the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--with-wide-unicode&lt;/span&gt;&lt;/tt&gt; configure option.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="stable-abi"&gt;
&lt;h2&gt;Stable ABI&lt;/h2&gt;
&lt;p&gt;If the machine code doesn't use the offset, it would be able to only compile C
extensions once.&lt;/p&gt;
&lt;p&gt;A solution is to replace PyList_GET_ITEM() &lt;strong&gt;macro&lt;/strong&gt; with a &lt;strong&gt;function&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PyObject* PyList_GET_ITEM(PyObject *list, Py_ssize_t index);
&lt;/pre&gt;
&lt;p&gt;defined as:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PyObject* PyList_GET_ITEM(PyObject *list, Py_ssize_t index)
{
    return ((PyListObject *)list)-&amp;gt;ob_item[i];
}
&lt;/pre&gt;
&lt;p&gt;The machine code becomes a &lt;strong&gt;function call&lt;/strong&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PyObject *item;
item = PyList_GET_ITEM(list, index);
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="specialized-list-for-small-integers"&gt;
&lt;h2&gt;Specialized list for small integers&lt;/h2&gt;
&lt;p&gt;If C extension objects don't access structure members anymore, it becomes
possible to modify the memory layout.&lt;/p&gt;
&lt;p&gt;For example, it's possible to design a specialized implementation of
&lt;tt class="docutils literal"&gt;PyListObject&lt;/tt&gt; for small integers:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
typedef struct {
    PyVarObject ob_base;
    int use_small_int;
    PyObject **pyobject_array;
    int32_t *small_int_array;   // &amp;lt;-- new compact C array for integers
    Py_ssize_t allocated;
} PyListObject;

PyObject* PyList_GET_ITEM(PyObject *op, Py_ssize_t index)
{
    PyListObject *list = (PyListObject *)op;
    if (list-&amp;gt;use_small_int) {
        int32_t item = list-&amp;gt;small_int_array[index];
        /* create a new object at each call */
        return PyLong_FromLong(item);
    }
    else {
        return list-&amp;gt;pyobject_array[index];
    }
}
&lt;/pre&gt;
&lt;p&gt;It's just an example to show that it becomes possible to modify PyObject
structures. I'm not sure that it's useful in practice.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="multiple-python-runtimes"&gt;
&lt;h2&gt;Multiple Python &amp;quot;runtimes&amp;quot;&lt;/h2&gt;
&lt;p&gt;Assuming that all used C extensions use the new stable ABI, we can now imagine
multiple specialized Python runtimes installed in parallel, instead of a single
runtime:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;python3.7: regular/legacy CPython, backward compatible&lt;/li&gt;
&lt;li&gt;python3.7-dbg: runtime checks to ease debug&lt;/li&gt;
&lt;li&gt;fasterpython3.7: use specialized list&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;python3&lt;/tt&gt; runtime would remain &lt;strong&gt;fully&lt;/strong&gt; compatible since it would use
the old C API with macros and full structures. So by default, everything will
continue to work.&lt;/p&gt;
&lt;p&gt;But the other runtimes require that all imported C extensions were compiled
with the new C API.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;python3.7-dbg&lt;/span&gt;&lt;/tt&gt; adds more checks tested at runtime. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PyObject* PyList_GET_ITEM(PyObject *list, Py_ssize_t index)
{
    assert(PyList_Check(list));
    assert(0 &amp;lt;= index &amp;amp;&amp;amp; index &amp;lt; Py_SIZE(list));
    return ((PyListObject *)list)-&amp;gt;ob_item[i];
}
&lt;/pre&gt;
&lt;p&gt;Currently, some Linux distributions provide a &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;python3-dbg&lt;/span&gt;&lt;/tt&gt; binary, but may
not provide &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-dbg&lt;/span&gt;&lt;/tt&gt; binary packages of all C extensions. So all C extensions
have to be recompiled manually which is quite painful (need to install build
dependencies, wait until everthing is recompiled, etc.).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="experiment-optimizations"&gt;
&lt;h2&gt;Experiment optimizations&lt;/h2&gt;
&lt;p&gt;With the new C API, it becomes possible to implement a new class of
optimizations.&lt;/p&gt;
&lt;div class="section" id="tagged-pointer"&gt;
&lt;h3&gt;Tagged pointer&lt;/h3&gt;
&lt;p&gt;Store small integers directly into the pointer value. Reduce the memory usage,
avoid expensive unboxing-boxing.&lt;/p&gt;
&lt;p&gt;See &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Tagged_pointer"&gt;Wikipedia: Tagged pointer&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="no-garbage-collector-gc-at-all"&gt;
&lt;h3&gt;No garbage collector (GC) at all&lt;/h3&gt;
&lt;p&gt;Python runtime without GC at all. Remove the following header from objects
tracked by the GC:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
struct {
    union _gc_head *gc_next;
    union _gc_head *gc_prev;
    Py_ssize_t gc_refs;
} PyGC_Head;
&lt;/pre&gt;
&lt;p&gt;It would remove 24 bytes per object tracked by the GC.&lt;/p&gt;
&lt;p&gt;For comparison, the smallest Python object is &amp;quot;object()&amp;quot; which only takes 16
bytes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="tracing-garbage-collector-without-reference-counting"&gt;
&lt;h3&gt;Tracing garbage collector without reference counting&lt;/h3&gt;
&lt;p&gt;This idea is really the most complex and most experimental idea, but IMHO it's
required to &amp;quot;unlock&amp;quot; Python performances.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Write a new API to keep track of pointers:&lt;ul&gt;
&lt;li&gt;Declare a variable storing a &lt;tt class="docutils literal"&gt;PyObject*&lt;/tt&gt; object&lt;/li&gt;
&lt;li&gt;Set a pointer&lt;/li&gt;
&lt;li&gt;Maybe also read a pointer?&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Modify C extensions to use this new API&lt;/li&gt;
&lt;li&gt;Implement a tracing garbage collector which can move objects in memory
to compact memory&lt;/li&gt;
&lt;li&gt;Remove reference counting&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It even seems possible to implement a tracing garbage collector &lt;strong&gt;and&lt;/strong&gt; use
reference counting. But I'm not an expert in this area, need to dig the topic.&lt;/p&gt;
&lt;p&gt;Questions:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Is it possible to fix all C extensions to use the new API? Should be an
opt-in option in a first stage.&lt;/li&gt;
&lt;li&gt;Is it possible to emulate Py_INCREF/DECREF API, for backward compatibility,
using an hash table which maintains a reference counter outside &lt;tt class="docutils literal"&gt;PyObject&lt;/tt&gt;?&lt;/li&gt;
&lt;li&gt;Do we need to fix all C extensions?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Read also &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Tracing_garbage_collection"&gt;Wikipedia: Tracing garbage collection&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="gilectomy"&gt;
&lt;h3&gt;Gilectomy&lt;/h3&gt;
&lt;p&gt;Abstracting the ABI allows to customize the runtime for Gilectomy needs, to be
able to reemove the GIL.&lt;/p&gt;
&lt;p&gt;Removing reference counting would make Gilectomy much simpler.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="optimization"></category><category term="cpython"></category><category term="c-api"></category></entry><entry><title>My contributions to CPython during 2017 Q2 (part 3)</title><link href="https://vstinner.github.io/contrib-cpython-2017q2-part3.html" rel="alternate"></link><published>2017-07-13T17:00:00+02:00</published><updated>2017-07-13T17:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-07-13:/contrib-cpython-2017q2-part3.html</id><summary type="html">&lt;p&gt;This is the third part of my contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q2 (april, may, june):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Security&lt;/li&gt;
&lt;li&gt;Trick bug: Clang 4.0, dtoa and strict aliasing&lt;/li&gt;
&lt;li&gt;sigwaitinfo() race condition in test_eintr&lt;/li&gt;
&lt;li&gt;FreeBSD test_subprocess core dump&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous reports:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html"&gt;My contributions to CPython during 2017 Q2 (part 1)&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part2.html"&gt;My contributions to CPython …&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;p&gt;This is the third part of my contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q2 (april, may, june):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Security&lt;/li&gt;
&lt;li&gt;Trick bug: Clang 4.0, dtoa and strict aliasing&lt;/li&gt;
&lt;li&gt;sigwaitinfo() race condition in test_eintr&lt;/li&gt;
&lt;li&gt;FreeBSD test_subprocess core dump&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous reports:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html"&gt;My contributions to CPython during 2017 Q2 (part 1)&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part2.html"&gt;My contributions to CPython during 2017 Q2 (part 2)&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Next report:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html"&gt;My contributions to CPython during 2017 Q3: Part 1&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="security"&gt;
&lt;h2&gt;Security&lt;/h2&gt;
&lt;div class="section" id="backport-fixes"&gt;
&lt;h3&gt;Backport fixes&lt;/h3&gt;
&lt;p&gt;I am trying to fix all known security fixes in the 6 maintained Python
branches: 2.7, 3.3, 3.4, 3.5, 3.6 and master.&lt;/p&gt;
&lt;p&gt;I created the &lt;a class="reference external" href="http://python-security.readthedocs.io/"&gt;python-security.readthedocs.io&lt;/a&gt; website to track these
vulnerabilities, especially which Python versions are fixed, to identifiy
missing backports.&lt;/p&gt;
&lt;p&gt;Python 2.7, 3.5, 3.6 and master are quite good, I am still working on
backporting fixes into 3.4 and 3.3. Larry Hastings merged my 3.4 backports and
other security fixes, and scheduled a new 3.4.7 release next weeks. Later, I
will try to fix Python 3.3 as well, before its end-of-life, scheduled for the
end of september.&lt;/p&gt;
&lt;p&gt;See the &lt;a class="reference external" href="https://docs.python.org/devguide/#status-of-python-branches"&gt;Status of Python branches&lt;/a&gt; in the
devguide.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="libexpat-2-2"&gt;
&lt;h3&gt;libexpat 2.2&lt;/h3&gt;
&lt;p&gt;Python embeds a copy of libexpat to ease Python compilation on Windows and
macOS. It means that we have to remind to upgrade it at each libexpat release.
It is especially important when security vulerabilities are fixed in libexpat.&lt;/p&gt;
&lt;p&gt;libexpat 2.2 was released at 2016-06-21 and it contains such fixes for
vulnerabilities, see: &lt;a class="reference external" href="http://python-security.readthedocs.io/vuln/cve-2016-0718_expat_2.2_bug_537.html"&gt;CVE-2016-0718: expat 2.2, bug #537&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Sadly, it took us a few months to upgrade libexpat. I wrote a short shell
script to easily upgrade libexpat: recreate the &lt;tt class="docutils literal"&gt;Modules/expat/&lt;/tt&gt; directory
from a libexpat tarball.&lt;/p&gt;
&lt;p&gt;My commit:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;bpo-29591: Upgrade Modules/expat to libexpat 2.2 (#2164)&lt;/p&gt;
&lt;p&gt;Remove the configuration (&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Modules/expat/*config.h&lt;/span&gt;&lt;/tt&gt;) of unsupported
platforms: Amiga, MacOS Classic on PPC32, Open Watcom.&lt;/p&gt;
&lt;p&gt;Remove XML_HAS_SET_HASH_SALT define: it became useless since our local
expat copy was upgrade to expat 2.1 (it's now expat 2.2.0).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I upgraded libexpat to 2.2 in Pytohn 2.7, 3.4, 3.5, 3.6 and master branches.
I still have a pending pull request for 3.3.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="libexpat-2-2-1"&gt;
&lt;h3&gt;libexpat 2.2.1&lt;/h3&gt;
&lt;p&gt;Just after I finally upgraded our libexpat copy to 2.2.0... libexpat 2.2.1 was
released with new security fixes!  See &lt;a class="reference external" href="http://python-security.readthedocs.io/vuln/cve-2017-9233_expat_2.2.1.html"&gt;CVE-2017-9233: Expat 2.2.1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Again, I upgraded libexpat to 2.2.1 in all branches (pending: 3.3), see
bpo-30694. My commit:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Upgrade expat copy from 2.2.0 to 2.2.1 to get fixes
of multiple security vulnerabilities including:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;CVE-2017-9233 (External entity infinite loop DoS),&lt;/li&gt;
&lt;li&gt;CVE-2016-9063 (Integer overflow, re-fix),&lt;/li&gt;
&lt;li&gt;CVE-2016-0718 (Fix regression bugs from 2.2.0's fix to CVE-2016-0718)&lt;/li&gt;
&lt;li&gt;CVE-2012-0876 (Counter hash flooding with SipHash).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note: the CVE-2016-5300 (Use os-specific entropy sources like getrandom)
doesn't impact Python, since Python already gets entropy from the OS to set
the expat secret using &lt;tt class="docutils literal"&gt;XML_SetHashSalt()&lt;/tt&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="urllib-splithost-vulnerability"&gt;
&lt;h3&gt;urllib splithost() vulnerability&lt;/h3&gt;
&lt;p&gt;Vulnerability: &lt;a class="reference external" href="http://python-security.readthedocs.io/vuln/bpo-30500_urllib_connects_to_a_wrong_host.html"&gt;bpo-30500: urllib connects to a wrong host&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;While it was quick to confirm the vulnerability, it was tricky to decide how to
properly &lt;strong&gt;fix it without breaking backward compatibility&lt;/strong&gt;. We had too few
unit tests, and no obvious definition of the &lt;em&gt;expected&lt;/em&gt; behaviour. I
contributed to the discussed and to polish the fix:&lt;/p&gt;
&lt;p&gt;bpo-30500 commit:&lt;/p&gt;
&lt;blockquote&gt;
Fix urllib.parse.splithost() to correctly parse fragments. For example,
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;splithost('//127.0.0.1#&amp;#64;evil.com/')&lt;/span&gt;&lt;/tt&gt; now correctly returns the
&lt;tt class="docutils literal"&gt;127.0.0.1&lt;/tt&gt; host, instead of treating &lt;tt class="docutils literal"&gt;&amp;#64;evil.com&lt;/tt&gt; as the host in an
authentification (&lt;tt class="docutils literal"&gt;login&amp;#64;host&lt;/tt&gt;).&lt;/blockquote&gt;
&lt;p&gt;Fix applied to master, 3.6, 3.5, 3.4 and 2.7; pending pull request for 3.3.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="travis-ci"&gt;
&lt;h3&gt;Travis CI&lt;/h3&gt;
&lt;p&gt;I also wrote a pull request to enable Travis CI and AppVeyor CI on Python 3.3
and 3.4 branches, to test security on CI. These changes are complex and not
merged yet, but I am now confident that the CI will be enabled on 3.4!&lt;/p&gt;
&lt;p&gt;My PR for Python 3.4: &lt;a class="reference external" href="https://github.com/python/cpython/pull/2475"&gt;[3.4] Backport CI config from master&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="tricky-bug-clang-4-0-dtoa-and-strict-aliasing"&gt;
&lt;h2&gt;Tricky bug: Clang 4.0, dtoa and strict aliasing&lt;/h2&gt;
&lt;p&gt;Aha, another funny story about compilers: bpo-30104.&lt;/p&gt;
&lt;p&gt;I noticed that the following tests started to fail on the &amp;quot;AMD64 FreeBSD
CURRENT Debug 3.x&amp;quot; buildbot:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;test_cmath&lt;/li&gt;
&lt;li&gt;test_float&lt;/li&gt;
&lt;li&gt;test_json&lt;/li&gt;
&lt;li&gt;test_marshal&lt;/li&gt;
&lt;li&gt;test_math&lt;/li&gt;
&lt;li&gt;test_statistics&lt;/li&gt;
&lt;li&gt;test_strtod&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;First, I bet on a libc change on FreeBSD. Then, I found that test_strtod fails
on FreeBSD using clang 4.0, but pass on FreeBSD using clang 3.8.&lt;/p&gt;
&lt;p&gt;I started to bisect the code on Linux using a subset of &lt;tt class="docutils literal"&gt;Python/dtoa.c&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Start (integrated in CPython code base): 2,876 lines&lt;/li&gt;
&lt;li&gt;dtoa2.c (standalone): 2,865 lines&lt;/li&gt;
&lt;li&gt;dtoa5.c: 50 lines&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Extract of dtoa5.c:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
typedef union { double d; uint32_t L[2]; } U;

struct Bigint { int wds; };

static double
ratio(struct Bigint *a)
{
    U da, db;
    int k, ka, kb;
    double r;

    da.d = 1.682;
    ka = 6;
    db.d = 1.0;
    kb = 5;
    k = ka - kb + 32 * (a-&amp;gt;wds - 12);
    printf(&amp;quot;k=%i\n&amp;quot;, k);

    if (k &amp;gt; 0)
        da.L[1] += k * 0x100000;
    else {
        k = -k;
        db.L[1] += k * 0x100000;
    }
    r = da.d / db.d;
    /* r == 3.364 */
    return r;
}
&lt;/pre&gt;
&lt;p&gt;Even if I had a very short C code (50 lines) reproducing the bug, I was still
unable to understand the bug. I read many articles about aliasing, and I still
don't understand fully the bug... I suggest you these two good articles:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://cellperformance.beyond3d.com/articles/2006/06/understanding-strict-aliasing.html"&gt;Understanding Strict Aliasing&lt;/a&gt;
(Mike Acton, June 1, 2006)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://cellperformance.beyond3d.com/articles/2006/05/demystifying-the-restrict-keyword.html"&gt;Demystifying The Restrict Keyword&lt;/a&gt;
(Mike Acton, May 29, 2006)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Anyway, I wanted to report the bug to clang (LLVM), but the LLVM bug tracker was
migrating and I was unable to subscribe to get an account!&lt;/p&gt;
&lt;p&gt;In the meanwhile, &lt;strong&gt;Dimitry Andric&lt;/strong&gt;, a FreeBSD developer, told me that he got
&lt;em&gt;exactly&lt;/em&gt; the same clang 4.0 issue with &amp;quot;dtoa.c&amp;quot; in the &lt;em&gt;julia&lt;/em&gt; programming
language. Two months before I saw the same bug, he already reported the bug to
FreeBSD: &lt;a class="reference external" href="https://bugs.freebsd.org/216770"&gt;lang/julia: fails to build with clang 4.0&lt;/a&gt;, and to clang: &lt;a class="reference external" href="https://bugs.llvm.org//show_bug.cgi?id=31928"&gt;After r280351: if/else
blocks incorrectly optimized away?&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The &amp;quot;problem&amp;quot; is that clang
developers disagree that it's a bug. In short, the discussion was around the C
standard: does clang respect C aliasing rules or not? At the end, clang
developers consider that they are right to optimize. To summarize:&lt;/p&gt;
&lt;blockquote&gt;
It's a bug in the code, not in the compiler&lt;/blockquote&gt;
&lt;p&gt;So I made a first change to use the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-fno-strict-aliasing&lt;/span&gt;&lt;/tt&gt; flag when Python
is compiled with clang:&lt;/p&gt;
&lt;blockquote&gt;
Python/dtoa.c is not compiled correctly with clang 4.0 and
optimization level -O2 or higher, because of an aliasing issue on
the double/ULong[2] union.&lt;/blockquote&gt;
&lt;p&gt;But this change can make Python slower when compiled on clang, so I was asked
to only compile &lt;tt class="docutils literal"&gt;Python/dtoa.c&lt;/tt&gt; with this flag:&lt;/p&gt;
&lt;blockquote&gt;
On clang, only compile dtoa.c with -fno-strict-aliasing, use strict
aliasing to compile all other C files.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="sigwaitinfo-race-condition-in-test-eintr"&gt;
&lt;h2&gt;sigwaitinfo() race condition in test_eintr&lt;/h2&gt;
&lt;div class="section" id="the-tricky-test-eintr"&gt;
&lt;h3&gt;The tricky test_eintr&lt;/h3&gt;
&lt;p&gt;When I wrote and implemented the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0475/"&gt;PEP 475, Retry system calls failing with
EINTR&lt;/a&gt;, I didn't expect so many
annoying bugs of the newly written &lt;tt class="docutils literal"&gt;test_eintr&lt;/tt&gt; unit test. This test calls
system calls while sending signals every 100 ms. Usually the test tries to
block on a system call during at least 200 ms, to make sure that the syscall
was interrupted at least once by a signal, to check that Python correctly
retries the interrupted system call.&lt;/p&gt;
&lt;p&gt;Since the PEP was implemented, I already fixed many race conditions in
&lt;tt class="docutils literal"&gt;test_eintr&lt;/tt&gt;, but there was still a race condition on the &lt;tt class="docutils literal"&gt;sigwaitinfo()&lt;/tt&gt;
unit test. &lt;em&gt;Sometimes&lt;/em&gt; on a &lt;em&gt;few specific buildbots&lt;/em&gt; (FreeBSD), the test fails
randomly.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="first-attempt"&gt;
&lt;h3&gt;First attempt&lt;/h3&gt;
&lt;p&gt;My first attempt was the &lt;a class="reference external" href="http://bugs.python.org/issue25277"&gt;bpo-25277&lt;/a&gt;,
opened at 2015-09-30. I added faulthandler to dump tracebacks if a test hangs
longer than 10 minutes. Then I changed the sleep from 200 ms to 2 seconds in
the &lt;tt class="docutils literal"&gt;sigwaitinfo()&lt;/tt&gt; test... just to make the bug less likely, but using a
longer sleep doesn't fix the root issue.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="second-attempt"&gt;
&lt;h3&gt;Second attempt&lt;/h3&gt;
&lt;p&gt;My second attempt was the &lt;a class="reference external" href="http://bugs.python.org/issue25868"&gt;bpo-25868&lt;/a&gt;,
opened at 2015-12-15. I added a pipe to &amp;quot;synchronize the parent and the child
processes&amp;quot;, to try to make the sigwaitinfo() test a little bit more reliable. I
also reduced the sleep from 2 seconds to 100 ms.&lt;/p&gt;
&lt;p&gt;7 minutes after my fix, &lt;strong&gt;Martin Panter&lt;/strong&gt; wrote:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;With the pipe, there is still a potential race after the parent writes to
the pipe and before sigwaitinfo() is invoked, versus the child sleep()
call.&lt;/p&gt;
&lt;p&gt;What do you think of my suggestion to block the signal? Then (in theory) it
should be robust, rather than relying on timing.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I replied that I wasn't sure that sigwaitinfo() EINTR error was still tested if
we make his proposed change.&lt;/p&gt;
&lt;p&gt;One month later, Martin wrote a patch but I was unable to take a decision on
his change. In september 2016, Martin noticed a new test failure on the FreeBSD
9 buildbot.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="third-attempt"&gt;
&lt;h3&gt;Third attempt&lt;/h3&gt;
&lt;p&gt;My third attempt is the bpo-30320, opened at 2017-05-09. This time, I really
wanted to fix &lt;em&gt;all&lt;/em&gt; buildbot random failures. Since I was now able to reproduce
the bug on my FreeBSD VM, I was able to write a fix but also to check that:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;sigwaitinfo() and sigtimedwait() fail with EINTR and Python automatically
restarts the interrupted syscall&lt;/li&gt;
&lt;li&gt;I hacked the test file to only run the sigwaitinfo() and sigtimedwait() unit
tests. Running the test in a loop doesn't fail: I ran the test during 5
minutes in 10 shells (tests running 10 times in parallel) =&amp;gt; no failure, the
race condition seems to be gone.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So I &lt;a class="reference external" href="https://github.com/python/cpython/commit/211a392cc15f9a7b1b8ce65d8f6c9f8237d1b77f"&gt;pushed my fix&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;bpo-30320: test_eintr now uses pthread_sigmask()&lt;/p&gt;
&lt;p&gt;Rewrite sigwaitinfo() and sigtimedwait() unit tests for EINTR using
pthread_sigmask() to fix a race condition between the child and the
parent process.&lt;/p&gt;
&lt;p&gt;Remove the pipe which was used as a weak workaround against the race
condition.&lt;/p&gt;
&lt;p&gt;sigtimedwait() is now tested with a child process sending a signal
instead of testing the timeout feature which is more unstable
(especially regarding to clock resolution depending on the platform).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;To be honest, I wasn't really confident, when I pushed my fix, that blocking
the waited signal is the proper fix.&lt;/p&gt;
&lt;p&gt;So it took &lt;strong&gt;1 year and 8 months&lt;/strong&gt; to really find and fix the root bug.&lt;/p&gt;
&lt;p&gt;Sadly, while I was working on dozens of other bugs, I completely lost track of
Martin's patch, even if I opened the bpo-25868. Sorry Martin for forgotting to
review your patch! But when you wrote it, I was unable to test that
sigwaitinfo() was still failing with EINTR.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="freebsd-test-subprocess-core-dump"&gt;
&lt;h2&gt;FreeBSD test_subprocess core dump&lt;/h2&gt;
&lt;p&gt;bpo-30448: During one month, some FreeBSD buildbots was emitting this warning
which started to annoy me, since I was trying to fix &lt;em&gt;all&lt;/em&gt; buildbots warnings:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Warning -- files was modified by test_subprocess
  Before: []
  After:  ['python.core']
&lt;/pre&gt;
&lt;p&gt;I tried and failed to reproduce the warning on my FreeBSD 11 VM. I also asked a
friend to reproduce the bug, but he also failed. I was developping my
&lt;tt class="docutils literal"&gt;test.bisect&lt;/tt&gt; tool and I wanted to get access to a machine to reproduce the
bug!&lt;/p&gt;
&lt;p&gt;Later, &lt;strong&gt;Kubilay Kocak&lt;/strong&gt; aka &lt;em&gt;koobs&lt;/em&gt; gave me access to his FreeBSD buildbots
and in a few seconds with my new test.bisect tool, I identified that the
&lt;tt class="docutils literal"&gt;test_child_terminated_in_stopped_state()&lt;/tt&gt; test triggers a deliberate crash,
but doesn't disable core dump creation. The fix is simple, use
&lt;tt class="docutils literal"&gt;test.support.SuppressCrashReport&lt;/tt&gt; context manager. Thanks &lt;em&gt;koobs&lt;/em&gt; for the
access!&lt;/p&gt;
&lt;p&gt;Maybe only FreeBSD 10 and older dump a core on this specific test, not FreeBSD
11. I don't know why. The test is special, it tests a process which crashs
while being traced with &lt;tt class="docutils literal"&gt;ptrace()&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2017 Q2 (part 2)</title><link href="https://vstinner.github.io/contrib-cpython-2017q2-part2.html" rel="alternate"></link><published>2017-07-13T16:30:00+02:00</published><updated>2017-07-13T16:30:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-07-13:/contrib-cpython-2017q2-part2.html</id><summary type="html">&lt;p&gt;This is the second part of my contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q2 (april, may, june):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Mentoring&lt;/li&gt;
&lt;li&gt;Reference and memory leaks&lt;/li&gt;
&lt;li&gt;Contributions&lt;/li&gt;
&lt;li&gt;Enhancements&lt;/li&gt;
&lt;li&gt;Bugfixes&lt;/li&gt;
&lt;li&gt;Stars of the CPython GitHub project&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html"&gt;My contributions to CPython during 2017 Q2 (part 1)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part3.html"&gt;My contributions to CPython during 2017 Q2 …&lt;/a&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is the second part of my contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q2 (april, may, june):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Mentoring&lt;/li&gt;
&lt;li&gt;Reference and memory leaks&lt;/li&gt;
&lt;li&gt;Contributions&lt;/li&gt;
&lt;li&gt;Enhancements&lt;/li&gt;
&lt;li&gt;Bugfixes&lt;/li&gt;
&lt;li&gt;Stars of the CPython GitHub project&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html"&gt;My contributions to CPython during 2017 Q2 (part 1)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part3.html"&gt;My contributions to CPython during 2017 Q2 (part 3)&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="mentoring"&gt;
&lt;h2&gt;Mentoring&lt;/h2&gt;
&lt;p&gt;During this quarter, I tried to mark &amp;quot;easy&amp;quot; issues using a &amp;quot;[EASY]&amp;quot; tag in
their title and the &amp;quot;easy&amp;quot; or &amp;quot;easy C&amp;quot; keyword. I announced these issues on the
&lt;a class="reference external" href="https://www.python.org/dev/core-mentorship/"&gt;core-mentorship mailing list&lt;/a&gt;.
I asked core developers to not fix these easy issues, but rather explain how to
fix them. In each issue, I described how fix these issues.&lt;/p&gt;
&lt;p&gt;It was a success since all easy issues were fixed quickly, usually the PR was
merged in less than 24 hours after I created the issue!&lt;/p&gt;
&lt;p&gt;I mentored &lt;strong&gt;Stéphane Wirtel&lt;/strong&gt; and &lt;strong&gt;Louie Lu&lt;/strong&gt; to fix issues (easy or not).
During this quarter, Stéphane Wirtel got &lt;strong&gt;5 commits&lt;/strong&gt; merged into master (on a
&lt;strong&gt;total of 11 commits&lt;/strong&gt;), and Louie lu got &lt;strong&gt;6 commits&lt;/strong&gt; merged into master (on
a &lt;strong&gt;total of 10 commits&lt;/strong&gt;).&lt;/p&gt;
&lt;p&gt;They helped me to fix reference leaks spotted by the new Refleaks buildbots.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="reference-and-memory-leaks"&gt;
&lt;h2&gt;Reference and memory leaks&lt;/h2&gt;
&lt;p&gt;Zachary Ware installed a Gentoo and a Windows buildbots running the Python test
suite with &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--huntrleaks&lt;/span&gt;&lt;/tt&gt; to detect reference and memory leaks.&lt;/p&gt;
&lt;p&gt;I worked hard with others, especially Stéphane Wirtel and Louie Lu, to fix
&lt;em&gt;all&lt;/em&gt; reference leaks and memory leaks in Python 2.7, 3.5, 3.6 and master.
Right now, there is no more leaks on Windows! For Gentoo, the buildbot is
currently offline, but I am confident that all leaks also fixed.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;bpo-30598: _PySys_EndInit() now duplicates warnoptions. Fix a reference leak
in subinterpreters, like test_callbacks_leak() of test_atexit. warnoptions is
a list used to pass options from the command line to the sys module
constructor. Before this change, the list was shared by multiple interpreter
which is not the expected behaviour. Each interpreter should have their own
independent mutable world. This change duplicates the list in each
interpreter. So each interpreter owns its own list, so each interpreter can
clear its own list.&lt;/li&gt;
&lt;li&gt;bpo-30601: Fix a refleak in WindowsConsoleIO. Fix a reference leak in
_io._WindowsConsoleIO: PyUnicode_FSDecoder() always initialize decodedname
when it succeed and it doesn't clear input decodedname object.&lt;/li&gt;
&lt;li&gt;bpo-30599: Fix test_threaded_import reference leak. Mock
os.register_at_fork() when importing the random module, since this function
doesn't allow to unregister callbacks and so leaked memory.&lt;/li&gt;
&lt;li&gt;2.7: _tkinter: Fix refleak in getint(). PyNumber_Int() creates a new reference:
need to decrement result reference counter.&lt;/li&gt;
&lt;li&gt;bpo-30635: Fix refleak in test_c_locale_coercion. When checking for reference
leaks, test_c_locale_coercion is run multiple times and so
_LocaleCoercionTargetsTestCase.setUpClass() is called multiple times.
setUpClass() appends new value at each call, so it looks like a reference
leak. Moving the setup from setUpClass() to setUpModule() avoids this,
eliminating the false alarm.&lt;/li&gt;
&lt;li&gt;bpo-30602: Fix refleak in os.spawnve(). When os.spawnve() fails while
handling arguments, free correctly argvlist: pass lastarg+1 rather than
lastarg to free_string_array() to also free the first item.&lt;/li&gt;
&lt;li&gt;bpo-30602: Fix refleak in os.spawnv(). When os.spawnv() fails while handling
arguments, free correctly argvlist: pass lastarg+1 rather than lastarg to
free_string_array() to also free the first item.&lt;/li&gt;
&lt;li&gt;Fix ref cycles in TestCase.assertRaises(). bpo-23890:
unittest.TestCase.assertRaises() now manually breaks a reference cycle to not
keep objects alive longer than expected.&lt;/li&gt;
&lt;li&gt;Python 2.7: bpo-30675: Fix refleak hunting in regrtest. regrtest now warms up
caches: create explicitly all internal singletons which are created on demand
to prevent false positives when checking for reference leaks.&lt;/li&gt;
&lt;li&gt;_winconsoleio: Fix memory leak. Fix memory leak when _winconsoleio tries to
open a non-console file: free the name buffer.&lt;/li&gt;
&lt;li&gt;bpo-30813: Fix unittest when hunting refleaks. bpo-11798, bpo-16662,
bpo-16935, bpo-30813: Skip
test_discover_with_module_that_raises_SkipTest_on_import() and
test_discover_with_init_module_that_raises_SkipTest_on_import() of
test_unittest when hunting reference leaks using regrtest.&lt;/li&gt;
&lt;li&gt;bpo-30704, bpo-30604: Fix memleak in code_dealloc(): Free also
co_extra-&amp;gt;ce_extras, not only co_extra. XXX Serhiy rewrote the structure in
master to use a single memory block, implemented my idea.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="python-3-5-regrtest-fix"&gt;
&lt;h3&gt;Python 3.5 regrtest fix&lt;/h3&gt;
&lt;p&gt;bpo-30675, Fix the multiprocessing code in regrtest:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Rewrite code to pass &lt;tt class="docutils literal"&gt;slaveargs&lt;/tt&gt; from the master process to worker
processes: reuse the same code of the Python master branch.&lt;/li&gt;
&lt;li&gt;Move code to initialize tests in a new &lt;tt class="docutils literal"&gt;setup_tests()&lt;/tt&gt; function,
similar change was done in the master branch.&lt;/li&gt;
&lt;li&gt;In a worker process, call &lt;tt class="docutils literal"&gt;setup_tests()&lt;/tt&gt; with the namespace built
from &lt;tt class="docutils literal"&gt;slaveargs&lt;/tt&gt; to initialize correctly tests.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Before this change, &lt;tt class="docutils literal"&gt;warm_caches()&lt;/tt&gt; was not called in worker processes
because the setup was done before rebuilding the namespace from &lt;tt class="docutils literal"&gt;slaveargs&lt;/tt&gt;.
As a consequence, the &lt;tt class="docutils literal"&gt;huntrleaks&lt;/tt&gt; feature was unstable. For example,
&lt;tt class="docutils literal"&gt;test_zipfile&lt;/tt&gt; reported randomly false positive on reference leaks.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="false-positives"&gt;
&lt;h3&gt;False positives&lt;/h3&gt;
&lt;p&gt;bpo-30776: reduce regrtest -R false positives (#2422)&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Change the regrtest --huntrleaks checker to decide if a test file
leaks or not. Require that each run leaks at least 1 reference.&lt;/li&gt;
&lt;li&gt;Warmup runs are now completely ignored: ignored in the checker test
and not used anymore to compute the sum.&lt;/li&gt;
&lt;li&gt;Add an unit test for a reference leak.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example of reference differences previously considered a failure
(leak) and now considered as success (success, no leak):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
[3, 0, 0]
[0, 1, 0]
[8, -8, 1]
&lt;/pre&gt;
&lt;p&gt;The same change was done to check for memory leaks.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="contributions"&gt;
&lt;h2&gt;Contributions&lt;/h2&gt;
&lt;p&gt;This quarter, I helped to merge two contributions:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;bpo-9850: Deprecate the macpath module. Co-Authored-By: &lt;strong&gt;Chi Hsuan Yen&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;bpo-30595: Fix multiprocessing.Queue.get(timeout).
multiprocessing.Queue.get() with a timeout now polls its reader in
non-blocking mode if it succeeded to aquire the lock but the acquire took
longer than the timeout. Co-Authored-By: &lt;strong&gt;Grzegorz Grzywacz&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="enhancements"&gt;
&lt;h2&gt;Enhancements&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;bpo-30265: support.unlink() now only ignores ENOENT and ENOTDIR, instead of
ignoring all OSError exception.&lt;/li&gt;
&lt;li&gt;bpo-30054: Expose tracemalloc C API: make PyTraceMalloc_Track() and
PyTraceMalloc_Untrack() functions public. numpy is able to use
tracemalloc since numpy 1.13.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="bugfixes"&gt;
&lt;h2&gt;Bugfixes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;bpo-30125: On Windows, faulthandler.disable() now removes the exception
handler installed by faulthandler.enable().&lt;/li&gt;
&lt;li&gt;bpo-30284: Fix regrtest for out of tree build. Use a build/ directory in the
build directory, not in the source directory, since the source directory may
be read-only and must not be modified. Fallback on the source directory if
the build directory is not available (missing &amp;quot;abs_builddir&amp;quot; sysconfig
variable).&lt;/li&gt;
&lt;li&gt;test_locale now ignores the DeprecationWarning, don't fail anymore if test
run with &lt;tt class="docutils literal"&gt;python3 &lt;span class="pre"&gt;-Werror&lt;/span&gt;&lt;/tt&gt;. Fix also deprecation message: add a space.&lt;/li&gt;
&lt;li&gt;Fix a compiler warnings on AIX: only define get_zone() and get_gmtoff() if
needed.&lt;/li&gt;
&lt;li&gt;Fix a compiler warning in tmtotuple(): use the &lt;tt class="docutils literal"&gt;time_t&lt;/tt&gt; type for the
&lt;tt class="docutils literal"&gt;gmtoff&lt;/tt&gt; parameter.&lt;/li&gt;
&lt;li&gt;bpo-30264: ExpatParser closes the source on error. ExpatParser.parse() of
xml.sax.xmlreader now always closes the source: close the file object or the
urllib object if source is a string (not an open file-like object). The
change fixes a ResourceWarning on parsing error. Add
test_parse_close_source() unit test.&lt;/li&gt;
&lt;li&gt;Fix SyntaxWarning on importing test_inspect. Fix the following warning when
test_inspect.py is compiled to test_inspect.pyc:
&lt;tt class="docutils literal"&gt;SyntaxWarning: tuple parameter unpacking has been removed in 3.x&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;bpo-30418: On Windows, subprocess.Popen.communicate() now also ignore EINVAL
on stdin.write(): ignore also EINVAL if the child process is still running
but closed the pipe.&lt;/li&gt;
&lt;li&gt;bpo-30257: _bsddb: Fix newDBObject(). Don't set cursorSetReturnsNone to
DEFAULT_CURSOR_SET_RETURNS_NONE anymore if self-&amp;gt;myenvobj is set.
Fix a GCC warning on the strange indentation.&lt;/li&gt;
&lt;li&gt;bpo-30231: Remove skipped test_imaplib tests. The public cyrus.andrew.cmu.edu
IMAP server (port 993) doesn't accept TLS connection using our self-signed
x509 certificate. Remove the two tests which are already skipped. Write a new
test_certfile_arg_warn() unit test for the certfile deprecation warning.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="stars-of-the-cpython-github-project"&gt;
&lt;h2&gt;Stars of the CPython GitHub project&lt;/h2&gt;
&lt;p&gt;At June 30, I wrote &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-June/148523.html"&gt;an email to python-dev&lt;/a&gt; about
&lt;a class="reference external" href="https://github.com/showcases/programming-languages"&gt;GitHub showcase of hosted programming languages&lt;/a&gt;: Python is only #11 with
8,539 stars, behind PHP and Ruby! I suggested to &amp;quot;like&amp;quot; (&amp;quot;star&amp;quot;?) the &lt;a class="reference external" href="https://github.com/python/cpython/"&gt;CPython
project on GitHub&lt;/a&gt; if you like the Python
programming language!&lt;/p&gt;
&lt;p&gt;Four days later, &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-July/148548.html"&gt;we got +2,389 new stars (8,539 =&amp;gt; 10,928)&lt;/a&gt;, thank
you! Python moved from the 11th place to the 9th, before Elixir and Julia.&lt;/p&gt;
&lt;p&gt;Ben Hoyt &lt;a class="reference external" href="https://www.reddit.com/r/Python/comments/6kg4w0/cpython_recently_moved_to_github_star_the_project/"&gt;posted it on reddit.com/r/Python&lt;/a&gt;,
where it got a bit of traction. Terry Jan Reedy also &lt;a class="reference external" href="https://mail.python.org/pipermail/python-list/2017-July/723476.html"&gt;posted it on python-list&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Screenshot at 2017-07-13 showing Ruby, PHP and CPython:&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://github.com/showcases/programming-languages"&gt;&lt;img alt="GitHub showcase: Programming languages" src="https://vstinner.github.io/images/github_cpython_stars.png" /&gt;&lt;/a&gt;
&lt;p&gt;CPython now has 11,512 stars, only 861 stars behind PHP ;-)&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2017 Q2 (part 1)</title><link href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html" rel="alternate"></link><published>2017-07-13T16:00:00+02:00</published><updated>2017-07-13T16:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-07-13:/contrib-cpython-2017q2-part1.html</id><summary type="html">&lt;p&gt;This is the first part of my contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q2 (april, may, june):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Statistics&lt;/li&gt;
&lt;li&gt;Buidbots and test.bisect&lt;/li&gt;
&lt;li&gt;Python 3.6.0 regression&lt;/li&gt;
&lt;li&gt;struct.Struct.format type&lt;/li&gt;
&lt;li&gt;Optimization: one less syscall per open() call&lt;/li&gt;
&lt;li&gt;make regen-all&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q1.html"&gt;My contributions to CPython during 2017 Q1&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next reports …&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is the first part of my contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q2 (april, may, june):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Statistics&lt;/li&gt;
&lt;li&gt;Buidbots and test.bisect&lt;/li&gt;
&lt;li&gt;Python 3.6.0 regression&lt;/li&gt;
&lt;li&gt;struct.Struct.format type&lt;/li&gt;
&lt;li&gt;Optimization: one less syscall per open() call&lt;/li&gt;
&lt;li&gt;make regen-all&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q1.html"&gt;My contributions to CPython during 2017 Q1&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next reports:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part2.html"&gt;My contributions to CPython during 2017 Q2 (part 2)&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part3.html"&gt;My contributions to CPython during 2017 Q2 (part 3)&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html"&gt;My contributions to CPython during 2017 Q3: Part 1&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Next parts&lt;/p&gt;
&lt;div class="section" id="statistics"&gt;
&lt;h2&gt;Statistics&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
# All branches
$ git log --after=2017-03-31 --before=2017-06-30 --reverse --branches='*' --author=Stinner &amp;gt; 2017Q2
$ grep '^commit ' 2017Q2|wc -l
222

# Master branch only
$ git log --after=2017-03-31 --before=2017-06-30 --reverse --author=Stinner origin/master|grep '^commit '|wc -l
85
&lt;/pre&gt;
&lt;p&gt;Statistics: &lt;strong&gt;85&lt;/strong&gt; commits in the master branch, a &lt;strong&gt;total of 222 commits&lt;/strong&gt;:
most (but not all) of the remaining 137 commits are cherry-picked backports to
2.7, 3.5 and 3.6 branches.&lt;/p&gt;
&lt;p&gt;Note: I didn't use &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--no-merges&lt;/span&gt;&lt;/tt&gt; since we don't use merge anymore, but &lt;tt class="docutils literal"&gt;git
&lt;span class="pre"&gt;cherry-pick&lt;/span&gt; &lt;span class="pre"&gt;-x&lt;/span&gt;&lt;/tt&gt;, to &lt;em&gt;backport&lt;/em&gt; fixes. Before GitHub, we used &lt;strong&gt;forwardport&lt;/strong&gt;
with Mercurial merges (ex: commit into 3.6, then merge into master).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="buildbots-and-test-bisect"&gt;
&lt;h2&gt;Buildbots and test.bisect&lt;/h2&gt;
&lt;p&gt;Since this article became way too long, I splitted it into sub-articles:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python-test-bisect.html"&gt;New Python test.bisect tool&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/python-buildbots-2017q2.html"&gt;Work on Python buildbots, 2017 Q2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-6-0-regression"&gt;
&lt;h2&gt;Python 3.6.0 regression&lt;/h2&gt;
&lt;p&gt;I am ashamed, I introduced a tricky regression in Pyton 3.6.0 with my work on
FASTCALL optimizations :-( A special way to call C builtin functions was broken:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
from datetime import datetime
next(iter(datetime.now, None))
&lt;/pre&gt;
&lt;p&gt;This code raises a &lt;tt class="docutils literal"&gt;StopIteration&lt;/tt&gt; exception instead of formatting the
current date and time.&lt;/p&gt;
&lt;p&gt;It's even worse. I was aware of the bug, it was already fixed it in master, but
I just forgot to backport my fix: bpo-30524, fix _PyStack_UnpackDict().&lt;/p&gt;
&lt;p&gt;To prevent regressions, I wrote exhaustive unit tests on the 3 FASTCALL
functions, commit: &lt;a class="reference external" href="https://github.com/python/cpython/commit/3b5cf85edc188345668f987c824a2acb338a7816"&gt;bpo-30524: Write unit tests for FASTCALL&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="struct-struct-format-type"&gt;
&lt;h2&gt;struct.Struct.format type&lt;/h2&gt;
&lt;p&gt;Sometimes, fixing a bug can take longer than expected. In March 2014, &lt;strong&gt;Zbyszek
Jędrzejewski-Szmek&lt;/strong&gt; reported a bug on the &lt;tt class="docutils literal"&gt;format&lt;/tt&gt; attribute of the
&lt;tt class="docutils literal"&gt;struct.Struct&lt;/tt&gt; class: this attribute type is bytes, whereas a Unicode string
(str) was expected.&lt;/p&gt;
&lt;p&gt;I proposed to &amp;quot;just&amp;quot; change the attribute type in December 2014, but it was an
incompatible change which would break the backward compatibility. &lt;strong&gt;Martin
Panter&lt;/strong&gt; agreed and wrote a patch. &lt;strong&gt;Serhiy Storchaka&lt;/strong&gt; asked to discuss such
incompatible change on python-dev, but then nothing happened during longer
than...  2 years!&lt;/p&gt;
&lt;p&gt;In March 2017, I converted the old Martin's patch into a new GitHub pull
request. &lt;strong&gt;Serhiy&lt;/strong&gt; asked again to write to python-dev, so I wrote:
&lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-March/147688.html"&gt;Issue #21071: change struct.Struct.format type from bytes to str&lt;/a&gt;. And...
I got zero answer.&lt;/p&gt;
&lt;p&gt;Well, I didn't expect any, since it's a trivial change, and I don't expect that
anyone rely on the exact &lt;tt class="docutils literal"&gt;format&lt;/tt&gt; attribute type.  Moreover, the
&lt;tt class="docutils literal"&gt;struct.Struct&lt;/tt&gt; constructor already accepts bytes and str types. If the
attribute is passed to the constructor: it just works.&lt;/p&gt;
&lt;p&gt;In June 2017, Serhiy Storchaka replied to my email: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-June/148360.html"&gt;If nobody opposed to this
change it will be made in short time.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Since nobody replied, again, I just merged my pull request. So it took &lt;strong&gt;3
years and 3 months&lt;/strong&gt; to change the type of an uncommon attribute :-)&lt;/p&gt;
&lt;p&gt;Note: I never used this attribute... Before reading this issue, I didn't even
know that the &lt;tt class="docutils literal"&gt;struct&lt;/tt&gt; module has a &lt;tt class="docutils literal"&gt;struct.Struct&lt;/tt&gt; type...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="optimization-one-less-syscall-per-open-call"&gt;
&lt;h2&gt;Optimization: one less syscall per open() call&lt;/h2&gt;
&lt;p&gt;In bpo-30228, I modified FileIO.seek() and FileIO.tell() methods to now set the
internal seekable attribute to avoid one &lt;tt class="docutils literal"&gt;fstat()&lt;/tt&gt; syscall per Python open()
call in buffered or text mode.&lt;/p&gt;
&lt;p&gt;The seekable property is now also more reliable since its value is
set correctly on memory allocation failure.&lt;/p&gt;
&lt;p&gt;I still have a second pending pull request to remove one more &lt;tt class="docutils literal"&gt;fstat()&lt;/tt&gt;
syscall: &lt;a class="reference external" href="https://github.com/python/cpython/pull/1385"&gt;bpo-30228: TextIOWrapper uses abs_pos, not tell()&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="make-regen-all"&gt;
&lt;h2&gt;make regen-all&lt;/h2&gt;
&lt;p&gt;I started to look at bpo-23404, because the Python compilation failed on the
&amp;quot;AMD64 FreeBSD 9.x 3.x&amp;quot; buildbot when trying to regenerate the
&lt;tt class="docutils literal"&gt;Include/opcode.h&lt;/tt&gt; file.&lt;/p&gt;
&lt;div class="section" id="old-broken-make-touch"&gt;
&lt;h3&gt;Old broken make touch&lt;/h3&gt;
&lt;p&gt;We had a &lt;tt class="docutils literal"&gt;make touch&lt;/tt&gt; command to workaround this file timestamp issue, but
the command uses Mercurial, whereas Python migrated to Git last february. The
buildobt &amp;quot;touch&amp;quot; step was removed because &lt;tt class="docutils literal"&gt;make touch&lt;/tt&gt; was broken.&lt;/p&gt;
&lt;p&gt;I was always annoyed by the Makefile which wants to regenerate generated files
because of wrong file modification time, whereas the generated files were
already up to date.&lt;/p&gt;
&lt;p&gt;The bug annoyed me on OpenIndiana where &amp;quot;make touch&amp;quot; didn't work beause the
operating system only provides Python 2.6 and Mercurial didn't work on this
version.&lt;/p&gt;
&lt;p&gt;The bug also annoyed me on FreeBSD which has no &amp;quot;python&amp;quot; command, only
&amp;quot;python2.7&amp;quot;, and so required manual steps.&lt;/p&gt;
&lt;p&gt;The bug was also a pain point when trying to cross-compile Python.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-shiny-make-regen-all"&gt;
&lt;h3&gt;New shiny make regen-all&lt;/h3&gt;
&lt;p&gt;I decided to rewrite the Makefile to not regenerate generated files based on
the file modification time anymore. Instead, I added a new &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;regen-all&lt;/span&gt;&lt;/tt&gt;
command to regenerate explicitly all generated files. Basically, I replaced
&lt;tt class="docutils literal"&gt;make touch&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;regen-all&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Add a new &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;regen-all&lt;/span&gt;&lt;/tt&gt; command to rebuild all generated files&lt;/li&gt;
&lt;li&gt;Add subcommands to only generate specific files:&lt;ul&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;regen-ast&lt;/span&gt;&lt;/tt&gt;: Include/Python-ast.h and Python/Python-ast.c&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;regen-grammar&lt;/span&gt;&lt;/tt&gt;: Include/graminit.h and Python/graminit.c&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;regen-importlib&lt;/span&gt;&lt;/tt&gt;: Python/importlib_external.h and Python/importlib.h&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;regen-opcode&lt;/span&gt;&lt;/tt&gt;: Include/opcode.h&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;regen-opcode-targets&lt;/span&gt;&lt;/tt&gt;: Python/opcode_targets.h&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;regen-typeslots&lt;/span&gt;&lt;/tt&gt;: Objects/typeslots.inc&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Rename &lt;tt class="docutils literal"&gt;PYTHON_FOR_GEN&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;PYTHON_FOR_REGEN&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;pgen is now only built by &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;regen-grammar&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Add &lt;tt class="docutils literal"&gt;$(srcdir)/&lt;/tt&gt; prefix to paths to source files to handle correctly
compilation outside the source directory&lt;/li&gt;
&lt;li&gt;Remove &lt;tt class="docutils literal"&gt;make touch&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;Tools/hg/hgtouch.py&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;.hgtouch&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note: By default, &lt;tt class="docutils literal"&gt;$(PYTHON_FOR_REGEN)&lt;/tt&gt; is no more used nor needed by &amp;quot;make&amp;quot;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>Work on Python buildbots, 2017 Q2</title><link href="https://vstinner.github.io/python-buildbots-2017q2.html" rel="alternate"></link><published>2017-07-13T09:00:00+02:00</published><updated>2017-07-13T09:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-07-13:/python-buildbots-2017q2.html</id><summary type="html">&lt;p&gt;I spent the last 6 months on working on buildbots: reduce the failure rate,
send email notitication on failure, fix random bugs, detect more bugs using
warnings, backport fixes to older branches, etc. I decided to fix &lt;em&gt;all&lt;/em&gt;
buildbots issues: fix all warnings and all unstable tests!&lt;/p&gt;
&lt;p&gt;The good news …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I spent the last 6 months on working on buildbots: reduce the failure rate,
send email notitication on failure, fix random bugs, detect more bugs using
warnings, backport fixes to older branches, etc. I decided to fix &lt;em&gt;all&lt;/em&gt;
buildbots issues: fix all warnings and all unstable tests!&lt;/p&gt;
&lt;p&gt;The good news is that I made great progress, I fixed most random failures. A
random fail now became the exception rather than the norm. Some issues were not
bugs in tests, but real race conditions in the code. It's always good to fix
unlikely race conditions before users hit them on production!&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Introduction: Python Buildbots&lt;/li&gt;
&lt;li&gt;Orange Is The New Color&lt;/li&gt;
&lt;li&gt;New buildbot-status Mailing List&lt;/li&gt;
&lt;li&gt;Hardware issues&lt;ul&gt;
&lt;li&gt;The vacuum cleaner&lt;/li&gt;
&lt;li&gt;The memory stick&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Warnings&lt;/li&gt;
&lt;li&gt;regrtest&lt;/li&gt;
&lt;li&gt;Bug fixes&lt;/li&gt;
&lt;li&gt;Python 2.7&lt;/li&gt;
&lt;li&gt;Buildbot reports to python-dev&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="introduction-python-buildbots"&gt;
&lt;h2&gt;Introduction: Python Buildbots&lt;/h2&gt;
&lt;p&gt;CPython is running a &lt;a class="reference external" href="https://buildbot.net/"&gt;Buildbot&lt;/a&gt; server for continuous
integration, but tests are run as post-commit: see &lt;a class="reference external" href="https://www.python.org/dev/buildbot/"&gt;Python buildbots&lt;/a&gt;. CPython is tested by a wide range of
buildbot slaves:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;6 operating systems:&lt;ul&gt;
&lt;li&gt;Linux (Debian, Ubuntu, Gentoo, RHEL, SLES)&lt;/li&gt;
&lt;li&gt;Windows (7, 8, 8.1 and 10)&lt;/li&gt;
&lt;li&gt;macOS (Tiger, El Capitain, Sierra)&lt;/li&gt;
&lt;li&gt;FreeBSD (9, 10, CURRENT)&lt;/li&gt;
&lt;li&gt;AIX&lt;/li&gt;
&lt;li&gt;OpenIndiana (currently offline)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;5 CPU architectures:&lt;ul&gt;
&lt;li&gt;ARMv7&lt;/li&gt;
&lt;li&gt;x86 (Intel 32 bit)&lt;/li&gt;
&lt;li&gt;x86-64 aka &amp;quot;AMD64&amp;quot; (Intel 64-bit)&lt;/li&gt;
&lt;li&gt;PPC64, PPC64LE&lt;/li&gt;
&lt;li&gt;s390x&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;3 C compilers:&lt;ul&gt;
&lt;li&gt;GCC&lt;/li&gt;
&lt;li&gt;Clang (FreeBSD, macOS)&lt;/li&gt;
&lt;li&gt;Visual Studio (Windows)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There are different kinds of tests:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Python test suite: the most common check&lt;/li&gt;
&lt;li&gt;Docs: check that the documentation can be build and doesn't contain warnings&lt;/li&gt;
&lt;li&gt;Refleaks: check for reference leaks and memory leaks, run the Python test
suite with the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--huntrleaks&lt;/span&gt;&lt;/tt&gt; option&lt;/li&gt;
&lt;li&gt;DMG: Build the macOS installer with the
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Mac/BuildScript/build-installer.py&lt;/span&gt;&lt;/tt&gt; script&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Python is tested in different configurations:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Debug: &lt;tt class="docutils literal"&gt;./configure &lt;span class="pre"&gt;--with-pydebug&lt;/span&gt;&lt;/tt&gt;, the most common configuration&lt;/li&gt;
&lt;li&gt;Non-debug: release mode, with compiler optimizations&lt;/li&gt;
&lt;li&gt;PGO: Profiled Guided Optimization, &lt;tt class="docutils literal"&gt;./configure &lt;span class="pre"&gt;--enable-optimizations&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Installed: &lt;tt class="docutils literal"&gt;./configure &lt;span class="pre"&gt;--prefix=XXX&lt;/span&gt; &amp;amp;&amp;amp; make install&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Shared library (libpython): &lt;tt class="docutils literal"&gt;./configure &lt;span class="pre"&gt;--enable-shared&lt;/span&gt;&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Currently, 4 branches are tested:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;master&lt;/tt&gt;: called &amp;quot;3.x&amp;quot; on buildbots&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;3.6&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;3.5&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;2.7&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There is also &lt;tt class="docutils literal"&gt;custom&lt;/tt&gt;, a special branch used by core developers for testing
patches.&lt;/p&gt;
&lt;p&gt;The buildbot configuration can be found in the &lt;a class="reference external" href="https://github.com/python/buildmaster-config/"&gt;buildmaster-config project&lt;/a&gt; (start with the
&lt;tt class="docutils literal"&gt;master/master.cfg&lt;/tt&gt; file).&lt;/p&gt;
&lt;p&gt;Note: Thanks to the migration to GitHub, Pull Requests are now tested on Linux,
Windows and macOS by Travis CI and AppVeyor. It's the first time in the CPython
development history that we have automated pre-commit tests!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="orange-is-the-new-color"&gt;
&lt;h2&gt;Orange Is The New Color&lt;/h2&gt;
&lt;p&gt;A buildbot now becomes orange when tests contain warnings.&lt;/p&gt;
&lt;p&gt;My first change was to modify the buildbot configuration to extract warnings
from the raw test output to create a new &amp;quot;warnings&amp;quot; report, to more easily
detect warnings and tests failing randomly (test fail then pass when re-run).&lt;/p&gt;
&lt;p&gt;Example of orange build, x86-64 El Capitain 3.x:&lt;/p&gt;
&lt;img alt="Buildbot: orange build" src="https://vstinner.github.io/images/buildbot_orange.png" /&gt;
&lt;p&gt;Extract of the current &lt;tt class="docutils literal"&gt;master/custom/steps.py&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
class Test(BaseTest):
    # Regular expression used to catch warnings, errors and bugs
    warningPattern = (
        # regrtest saved_test_environment warning:
        # Warning -- files was modified by test_distutils
        # test.support &amp;#64;reap_threads:
        # Warning -- threading_cleanup() failed to cleanup ...
        r&amp;quot;Warning -- &amp;quot;,
        # Py_FatalError() call
        r&amp;quot;Fatal Python error:&amp;quot;,
        # PyErr_WriteUnraisable() exception: usually, error in
        # garbage collector or destructor
        r&amp;quot;Exception ignored in:&amp;quot;,
        # faulthandler_exc_handler(): Windows exception handler installed with
        # AddVectoredExceptionHandler() by faulthandler.enable()
        r&amp;quot;Windows fatal exception:&amp;quot;,
        # Resource warning: unclosed file, socket, etc.
        # NOTE: match the &amp;quot;ResourceWarning&amp;quot; anywhere, not only at the start
        r&amp;quot;ResourceWarning&amp;quot;,
        # regrtest: At least one test failed. Log a warning even if the test
        # passed on the second try, to notify that a test is unstable.
        r'Re-running failed tests in verbose mode',
        # Re-running test 'test_multiprocessing_fork' in verbose mode
        r'Re-running test .* in verbose mode',
        # Thread last resort exception handler in t_bootstrap()
        r'Unhandled exception in thread started by ',
        # test_os leaked [6, 6, 6] memory blocks, sum=18,
        r'test_[^ ]+ leaked ',
    )
    # Use &amp;quot;.*&amp;quot; prefix to search the regex anywhere since stdout is mixed
    # with stderr, so warnings are not always written at the start
    # of a line. The log consumer calls warningPattern.match(line)
    warningPattern = r&amp;quot;.*(?:%s)&amp;quot; % &amp;quot;|&amp;quot;.join(warningPattern)
    warningPattern = re.compile(warningPattern)

    # if tests have warnings, mark the overall build as WARNINGS (orange)
    warnOnWarnings = True
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="new-buildbot-status-mailing-list"&gt;
&lt;h2&gt;New buildbot-status Mailing List&lt;/h2&gt;
&lt;p&gt;To check buildbots, previously I had to analyze manually the huge &amp;quot;waterfall&amp;quot;
view of four Python branches: 2.7, 3.5, 3.6 and master (&amp;quot;3.x&amp;quot;).&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://buildbot.python.org/all/waterfall?category=3.x.stable&amp;amp;category=3.x.unstable"&gt;Python master (&amp;quot;3.x&amp;quot;)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://buildbot.python.org/all/waterfall?category=3.6.stable&amp;amp;category=3.6.unstable"&gt;Python 3.6&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://buildbot.python.org/all/waterfall?category=3.5.stable&amp;amp;category=3.5.unstable"&gt;Python 3.5&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://buildbot.python.org/all/waterfall?category=2.7.stable&amp;amp;category=2.7.unstable"&gt;Python 2.7&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example of typical buildbot waterfall:&lt;/p&gt;
&lt;a class="reference external image-reference" href="http://buildbot.python.org/all/waterfall?category=3.x.stable&amp;amp;category=3.x.unstable"&gt;&lt;img alt="Buildbot waterfall" src="https://vstinner.github.io/images/buildbot_waterfall.png" /&gt;&lt;/a&gt;
&lt;p&gt;The screenshot is obviously truncated since the webpage is giant: I have to
scroll in all directions... It's not convenient to check the status of all
builds, detect random failures, etc.&lt;/p&gt;
&lt;p&gt;We also have an IRC bot reporting buildbot failures: when a green (success) or
orange (warning) buildbot becomes red (failure). I wanted to have the same
thing, but by email. Technically, it's trivial to enable email notification,
but I never did it because buildbots were simply too unstable: most failures
were not related to the newly tested changes.&lt;/p&gt;
&lt;p&gt;But I decided to fix &lt;em&gt;all&lt;/em&gt; buildbots issues, so I enabled email notification
(&lt;a class="reference external" href="https://bugs.python.org/issue30325"&gt;bpo-30325&lt;/a&gt;). Since May 2017,
buildbots are now sending notifications to a new &lt;a class="reference external" href="https://mail.python.org/mm3/mailman3/lists/buildbot-status.python.org/"&gt;buildbot-status mailing list&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I use the mailing list to check if the failure is known or not: I try to answer
to all failure notification emails. If the failure is known, I copy the link to
the issue. Otherwise, I create a new issue and then copy the link to the new
issue.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="hardware-issues"&gt;
&lt;h2&gt;Hardware issues&lt;/h2&gt;
&lt;p&gt;Unit tests versus real life :-) (or &amp;quot;software versus hardware&amp;quot;)&lt;/p&gt;
&lt;div class="section" id="the-vacuum-cleaner"&gt;
&lt;h3&gt;The vacuum cleaner&lt;/h3&gt;
&lt;p&gt;Fixing buildbot issues can be boring sometimes, so let's start with a funny
bug. At June 25, Nick Coghlan wrote to the &lt;a class="reference external" href="https://mail.python.org/mailman/listinfo/python-buildbots"&gt;python-buildbots&lt;/a&gt; mailing list:&lt;/p&gt;
&lt;blockquote&gt;
It looks like the FreeBSD buildbots had an outage a little while ago,
and the FreeBSD 10 one may need a nudge to get back online (the
FreeBSD Current one looks like it came back automatically).&lt;/blockquote&gt;
&lt;p&gt;The reason is unexpected :-) &lt;a class="reference external" href="https://mail.python.org/pipermail/python-buildbots/2017-June/000122.html"&gt;Kubilay Kocak, owner of the buildbot, answered&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
Vacuum cleaner tripped RCD pulling too much current from the same circuit
as heater was running on. Buildbot worker host on same circuit.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="the-memory-stick"&gt;
&lt;h3&gt;The memory stick&lt;/h3&gt;
&lt;p&gt;I opened at least 50 issues to report random buildbot failures. In the middle
of these issues, you can find &lt;a class="reference external" href="http://bugs.python.org/issue30371"&gt;bpo-30371&lt;/a&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
http://buildbot.python.org/all/builders/AMD64%20Windows7%20SP1%203.x/builds/436/steps/test/logs/stdio

======================================================================
FAIL: test_long_lines (test.test_email.test_email.TestFeedParsers)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &amp;quot;C:\buildbot.python.org\3.x.kloth-win64\build\lib\test\test_email\test_email.py&amp;quot;, line 3526, in test_long_lines
    self.assertEqual(m.get_payload(), 'x'*M*N)
AssertionError: 'xxxx[17103482 chars]xxxxxzxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx[2896464 chars]xxxx' != 'xxxx[17103482 chars]xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx[2896464 chars]xxxx'

Notice the &amp;quot;z&amp;quot; in &amp;quot;...xxxxxz...&amp;quot;.
&lt;/pre&gt;
&lt;p&gt;and:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
New fail, same buildbot:

======================================================================
FAIL: test_long_lines (test.test_email.test_email.TestFeedParsers)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &amp;quot;C:\buildbot.python.org\3.x.kloth-win64\build\lib\test\test_email\test_email.py&amp;quot;, line 3534, in test_long_lines
    self.assertEqual(m.items(), [('a', ''), ('b', 'x'*M*N)])
AssertionError: Lists differ: [('a'[1845894 chars]xxxxxzxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx[18154072 chars]xx')] != [('a'[1845894 chars]xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx[18154072 chars]xx')]

First differing element 1:
('b',[1845882 chars]xxxxxzxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx[18154071 chars]xxx')
('b',[1845882 chars]xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx[18154071 chars]xxx')

  [('a', ''),
   ('b',


Don't click on http://buildbot.python.org/all/builders/AMD64%20Windows7%20SP1%203.x/builds/439/steps/test/logs/stdio
: the log contains lines of 2 MB which make my Firefox super slow :-)
&lt;/pre&gt;
&lt;p&gt;Jeremy Kloth, owner the buildbot, answered:&lt;/p&gt;
&lt;blockquote&gt;
Watch this space, but I'm pretty sure that it is (was) bad memory.&lt;/blockquote&gt;
&lt;p&gt;He fixed the issue:&lt;/p&gt;
&lt;blockquote&gt;
That's the real problem, I'm not &lt;em&gt;sure&lt;/em&gt; it's the memory, but it does have
the symptoms. And that is why my buildbot was down earlier, I was
attempting to determine the bad stick and replace it.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="warnings"&gt;
&lt;h2&gt;Warnings&lt;/h2&gt;
&lt;p&gt;To fix test warnings, I enhanced the test suite to report more information when
a warning is emitted and to ease detection of failures.&lt;/p&gt;
&lt;p&gt;A major change is the new &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--fail-env-changed&lt;/span&gt;&lt;/tt&gt; option I added to regrtest
(bpo-30764): make tests fail if the &amp;quot;environment&amp;quot; is changed. This option is
now used on buildbots, Travis CI and AppVeyor, but only for the &lt;em&gt;master&lt;/em&gt; branch
yet.&lt;/p&gt;
&lt;p&gt;Other changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The &amp;#64;reap_threads decorator and the threading_cleanup() function of
test.support now log a warning if they fail to clenaup threads. The log may
help to debug such other warning seen on the AMD64 FreeBSD CURRENT Non-Debug
3.x buildbot: &amp;quot;Warning -- threading._dangling was modified by test_logging&amp;quot;.&lt;/li&gt;
&lt;li&gt;threading_cleanup() failure marks test as ENV_CHANGED. If threading_cleanup()
fails to cleanup threads, set a a new support.environment_altered flag to
true, flag uses by save_env which is used by regrtest to check if a test
altered the environment. At the end, the test file fails with ENV_CHANGED
instead of SUCCESS, to report that it altered the environment.&lt;/li&gt;
&lt;li&gt;regrtest: always show before/after values of modified environment.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I backported all these changes to the 2.7, 3.5 and 3.6 branches to make sure
that warnings are fixed in all maintained branches.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="regrtest"&gt;
&lt;h2&gt;regrtest&lt;/h2&gt;
&lt;p&gt;As usual, I spent time our specialized test runner, regrtest:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;bpo-30263: regrtest: log system load and the number of CPUs. I tried to find
a relationship between race conditions and the system load. I failed to
find any obvious correlation yet, but I still consider that the system load
is useful.&lt;/li&gt;
&lt;li&gt;bpo-27103: regrtest disables -W if -R (reference hunting) is used. Workaround
for a regrtest bug.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But the most complex task was to backport &lt;em&gt;all&lt;/em&gt; regrtest features and
enhancements from master to regrtest of 3.6, 3.5 and then 2.7 branches.&lt;/p&gt;
&lt;p&gt;In Python 3.6, I rewrote regrtest.py file to split it into smaller files a in
new Lib/test/libregrtest/ library, so it was painful to backport changes to 3.5
(bpo-30383) which still uses the single regrtest.py file.&lt;/p&gt;
&lt;p&gt;In Python 2.7 (bpo-30283), it is even worse. Lib/test/regrtest.py uses the old
&lt;tt class="docutils literal"&gt;getopt&lt;/tt&gt; module to parse the command line instead of the new &lt;tt class="docutils literal"&gt;argparse&lt;/tt&gt;
used in 3.5 and newer. But I succeeded to backport all features and
enhancements from master!&lt;/p&gt;
&lt;p&gt;Python 2.7, 3.5, 3.6 and master now have almost the same CLI for &lt;tt class="docutils literal"&gt;python &lt;span class="pre"&gt;-m&lt;/span&gt;
test&lt;/tt&gt;, almost the same features (except of one or two missing feature), and
should provide the same level of information on failures and warnings.&lt;/p&gt;
&lt;p&gt;By the way, the new &lt;tt class="docutils literal"&gt;test.bisect&lt;/tt&gt; tool is now also available in all these
branches. See my &lt;a class="reference external" href="https://vstinner.github.io/python-test-bisect.html"&gt;New Python test.bisect tool&lt;/a&gt; article.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="bug-fixes"&gt;
&lt;h2&gt;Bug fixes&lt;/h2&gt;
&lt;p&gt;As expected, the longest section here is the list of changes I wrote to fix all
buildbot failures and warnings:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;bpo-29972: Skip tests known to fail on AIX. See &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-April/147748.html"&gt;[Python-Dev] Fix or drop AIX
buildbot?&lt;/a&gt;
email.&lt;/li&gt;
&lt;li&gt;bpo-29925: Skip test_uuid1_safe() on OS X Tiger&lt;/li&gt;
&lt;li&gt;Fix and optimize test_asyncore.test_quick_connect(). Don't use addCleanup() in
test_quick_connect() because it keeps the Thread object alive and so
&amp;#64;reap_threads times out after 1 second. &amp;quot;./python -m test -v
test_asyncore -m test_quick_connect&amp;quot; now takes 185 ms, instead of 11 seconds.&lt;/li&gt;
&lt;li&gt;bpo-30106: Fix test_asyncore.test_quick_connect(). test_quick_connect() runs
a thread up to 50 seconds, whereas the socket is connected in 0.2 second and
then the thread is expected to end in less than 3 second. On Linux, the
thread ends quickly because select() seems to always return quickly. On
FreeBSD, sometimes select() fails with timeout and so the thread runs much
longer than expected. Fix the thread timeout to fix a race condition in the
test.&lt;/li&gt;
&lt;li&gt;bpo-30106: Fix tearDown() of test_asyncore. Call asyncore.close_all() with
ignore_all=True in the tearDown() method of the test_asyncore base test case.
It prevents keeping alive sockets in asyncore.socket_map if close()
fails with an unexpected error.&lt;/li&gt;
&lt;li&gt;bpo-30108: Restore sys.path in test_site. Add setUpModule() and
tearDownModule() functions to test_site to save/restore sys.path at the
module level to prevent warning if the user site directory is created, since
site.addsitedir() modifies sys.path.&lt;/li&gt;
&lt;li&gt;bpo-30107: test_io doesn't dump a core file on an expected crash anymore.
test_io has two unit tests which trigger a deadlock:
test_daemon_threads_shutdown_stdout_deadlock() and
test_daemon_threads_shutdown_stderr_deadlock(). These tests call
Py_FatalError() if the expected bug is triggered which calls abort(). Use
test.support.SuppressCrashReport to prevent the creation on a core dump, to
fix the warning:
&lt;tt class="docutils literal"&gt;Warning &lt;span class="pre"&gt;--&lt;/span&gt; files was modified by test_io &lt;span class="pre"&gt;(...)&lt;/span&gt; After: ['python.core']&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;bpo-30125: Disable faulthandler to run test_SEH() of test_ctypes to prevent
the following log with a traceback:
&lt;tt class="docutils literal"&gt;Windows fatal exception: access violation&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;bpo-30131: test_logging cleans up threads using &amp;#64;support.reap_threads.&lt;/li&gt;
&lt;li&gt;bpo-30132: BuildExtTestCase of test_distutils now uses support.temp_cwd() in
setUp() to remove files created in the current working directory by
BuildExtTestCase unit tests.&lt;/li&gt;
&lt;li&gt;bpo-30107: On macOS, test.support.SuppressCrashReport now redirects
/usr/bin/defaults command stderr into a pipe to not pollute stderr. It fixes
a test_io.test_daemon_threads_shutdown_stderr_deadlock() failure when the
CrashReporter domain doesn't exists.&lt;/li&gt;
&lt;li&gt;bpo-30175: Skip client cert tests of test_imaplib. The IMAP server
cyrus.andrew.cmu.edu doesn't accept our randomly generated client x509
certificate anymore.&lt;/li&gt;
&lt;li&gt;bpo-30175: test_nntplib fails randomly with EOFError in NetworkedNNTPTests.setUpClass():
catch EOFError to skip tests in that case.&lt;/li&gt;
&lt;li&gt;bpo-30199: AsyncoreEchoServer of test_ssl now calls
asyncore.close_all(ignore_all=True) to ensure that asyncore.socket_map is
cleared once the test completes, even if ConnectionHandler was not correctly
unregistered. Fix the following warning:
&lt;tt class="docutils literal"&gt;Warning &lt;span class="pre"&gt;--&lt;/span&gt; asyncore.socket_map was modified by test_ssl&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Fix test_ftplib warning if IPv6 is not available. DummyFTPServer now calls
del_channel() on bind() error to prevent the following warning in
TestIPv6Environment.setUpClass():
&lt;tt class="docutils literal"&gt;Warning &lt;span class="pre"&gt;--&lt;/span&gt; asyncore.socket_map was modified by test_ftplib&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;bpo-30329: Catch Windows error 10022 on shutdown(). Catch the Windows socket
WSAEINVAL error (code 10022) in imaplib and poplib on shutdown(SHUT_RDWR): An
invalid operation was attempted. This error occurs sometimes on SSL
connections.&lt;/li&gt;
&lt;li&gt;bpo-30357: test_thread now uses threading_cleanup(). test_thread: setUp() now
uses support.threading_setup() and support.threading_cleanup() to wait until
threads complete to avoid random side effects on following tests.
Co-Authored-By: &lt;strong&gt;Grzegorz Grzywacz&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;bpo-30339: test_multiprocessing_main_handling timeout.
test_multiprocessing_main_handling: increase the test_source timeout from 10
seconds to 60 seconds, since the test fails randomly on busy buildbots.
Sadly, this change wasn't enough to fix buildbots.&lt;/li&gt;
&lt;li&gt;bpo-30387: Fix warning in test_threading. test_is_alive_after_fork() now
joins directly the thread to avoid the following warning added by bpo-30357:
&amp;quot;Warning -- threading_cleanup() failed to cleanup 0 threads after 2 sec
(count: 0, dangling: 21)&amp;quot;. Use also a different exit code to catch generic
exit code 1.&lt;/li&gt;
&lt;li&gt;bpo-30649: On Windows, test_os now tolerates a delta of 50 ms instead of 20
ms in test_utime_current() and test_utime_current_old(). On other platforms,
reduce the delta from 20 ms to 10 ms. PPC64 Fedora 3.x buildbot requires at
least a delta of 14 ms.&lt;/li&gt;
&lt;li&gt;bpo-30595: test_queue_feeder_donot_stop_onexc() of _test_multiprocessing now
uses a timeout of 1 second on Queue.get(), instead of 0.1 second, for slow
buildbots.&lt;/li&gt;
&lt;li&gt;bpo-30764, bpo-29335: test_child_terminated_in_stopped_state() of
test_subprocess now uses support.SuppressCrashReport() to prevent the
creation of a core dump on FreeBSD.&lt;/li&gt;
&lt;li&gt;bpo-30280: TestBaseSelectorEventLoop of
test.test_asyncio.test_selector_events now correctly closes the event loop:
cleanup its executor to not leak threads: don't override the close() method
of the event loop, only override the_close_self_pipe() method. asyncio base
TestCase now uses threading_setup() and threading_cleanup() of test.support
to cleanup threads.&lt;/li&gt;
&lt;li&gt;bpo-26568, bpo-30812: Fix test_showwarnmsg_missing(): restore the attribute
after removing it.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id2"&gt;
&lt;h2&gt;Python 2.7&lt;/h2&gt;
&lt;p&gt;I wanted to fix &lt;em&gt;all&lt;/em&gt; buildbot issues of &lt;em&gt;all&lt;/em&gt; branches including 2.7, whereas
I didn't touch much the Python 2.7 code base last months (last years???). The
first six months of 2017, I backported dozens of commits from master to 2.7!&lt;/p&gt;
&lt;p&gt;For example, I added AppVeyor on 2.7: a Windows CI for GitHub!&lt;/p&gt;
&lt;p&gt;On Windows we support multiple versions of Visual Studio. I use Visual Studio
2008, whereas most 2.7 Windows buildbots use Visual Studio 2010 or newer.  I
fixed sysconfig.is_python_build() if Python is built with Visual Studio 2008
(VS 9.0) (bpo-30342).&lt;/p&gt;
&lt;p&gt;Other Python 2.7 changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Fix &amp;quot;make tags&amp;quot; command.&lt;/li&gt;
&lt;li&gt;bpo-30764: support.SuppressCrashReport backported to 2.7 and &amp;quot;ported&amp;quot; to
Windows.  Add Windows support to test.support.SuppressCrashReport: call
SetErrorMode() and CrtSetReportMode(). _testcapi: add CrtSetReportMode() and
CrtSetReportFile() functions and CRT_xxx and CRTDBG_xxx constants needed by
SuppressCrashReport.&lt;/li&gt;
&lt;li&gt;bpo-30705: Fix test_regrtest.test_crashed(). Add test.support._crash_python()
which triggers a crash but uses test.support.SuppressCrashReport() to prevent
a crash report from popping up. Modify
test_child_terminated_in_stopped_state() of test_subprocess and
test_crashed() of test_regrtest to use _crash_python().&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I also backported many fixes wrote by other developers, including old fixes up
to 8 years old!&lt;/p&gt;
&lt;p&gt;Usually, &lt;strong&gt;finding&lt;/strong&gt; the proper fix takes much more time than the cherry-pick
itself which is usually straighforward (no conflict, nothing to do). I am
always impressed that Git is able to detect that a file was renamed between
Python 2 and Python 3, and applies cleanly the change!&lt;/p&gt;
&lt;p&gt;Example of backports from master to 2.7:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;bpo-6393: Fix locale.getprerredencoding() on macOS. Python crashes on OSX
when &lt;tt class="docutils literal"&gt;$LANG&lt;/tt&gt; is set to some (but not all) invalid values due to an invalid
result from nl_langinfo(). Fix written in &lt;strong&gt;September 2009&lt;/strong&gt; (8 years ago)!&lt;/li&gt;
&lt;li&gt;bpo-15526: test_startfile changes the cwd. Try to fix test_startfile's
inability to clean up after itself in time. Patch by &lt;strong&gt;Jeremy Kloth&lt;/strong&gt;.
Fix the following support.rmtree() error while trying to remove the temporary
working directory used by Python tests:
&amp;quot;WindowsError: [Error 32] The process cannot access the file because it is
being used by another process: ...&amp;quot;.
Original commit written in &lt;strong&gt;September 2012&lt;/strong&gt;!&lt;/li&gt;
&lt;li&gt;bpo-11790: Fix sporadic failures in
test_multiprocessing.WithProcessesTestCondition.
Fixed written in &lt;strong&gt;April 2011&lt;/strong&gt;. This backported commit was tricky to
identify!&lt;/li&gt;
&lt;li&gt;bpo-8799, fix test_threading: Reduce timing sensitivity of condition test by
explicitly.  delaying the main thread so that it doesn't race ahead of the
workers.  Fix written in &lt;strong&gt;Nov 2013&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;test_distutils: Use EnvironGuard on InstallTestCase, UtilTestCase, and
BuildExtTestCase  to prevent the following warning:
&lt;tt class="docutils literal"&gt;Warning &lt;span class="pre"&gt;--&lt;/span&gt; os.environ was modified by test_distutils&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Fix test_multprocessing: Relax test timing (bpo-29861) to avoid sporadic
failures.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="buildbot-reports-to-python-dev"&gt;
&lt;h2&gt;Buildbot reports to python-dev&lt;/h2&gt;
&lt;p&gt;I also wrote 3 reports to the Python-Dev mailing list:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;May 3: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-May/147838.html"&gt;Status of Python buildbots&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;June 8: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-June/148271.html"&gt;Buildbot report, june 2017&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;June 29: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-June/148511.html"&gt;Buildbot report (almost July)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>New Python test.bisect tool</title><link href="https://vstinner.github.io/python-test-bisect.html" rel="alternate"></link><published>2017-07-12T15:00:00+02:00</published><updated>2017-07-12T15:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-07-12:/python-test-bisect.html</id><summary type="html">&lt;p&gt;This article tells the story of the new CPython &lt;tt class="docutils literal"&gt;test.bisect&lt;/tt&gt; tool to
identify failing tests in the CPython test suite.&lt;/p&gt;
&lt;div class="section" id="modify-manually-a-test-file"&gt;
&lt;h2&gt;Modify manually a test file&lt;/h2&gt;
&lt;p&gt;I am fixing reference leaks since many years. When the test file contains more
than 200 tests and is longer than 5,000 lines …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;This article tells the story of the new CPython &lt;tt class="docutils literal"&gt;test.bisect&lt;/tt&gt; tool to
identify failing tests in the CPython test suite.&lt;/p&gt;
&lt;div class="section" id="modify-manually-a-test-file"&gt;
&lt;h2&gt;Modify manually a test file&lt;/h2&gt;
&lt;p&gt;I am fixing reference leaks since many years. When the test file contains more
than 200 tests and is longer than 5,000 lines, it's just not possible to spot a
reference leak. Each time, I modified the long test file and actually &lt;em&gt;removes&lt;/em&gt;
enough code until the file becomes short enough so I can read it.&lt;/p&gt;
&lt;p&gt;This method &lt;em&gt;works&lt;/em&gt;, but it usually took me 20 to 30 minutes, and so it was
common that I made mistakes... and usually had to restart from the start...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="first-failed-attempt"&gt;
&lt;h2&gt;First failed attempt&lt;/h2&gt;
&lt;p&gt;In october 2014, while fixing &lt;a class="reference external" href="http://bugs.python.org/issue22588#msg228905"&gt;yet another reference leak in test_capi&lt;/a&gt;, &lt;strong&gt;Xavier de Gaye&lt;/strong&gt; was
surprised that I identified quickly the leak and wanted to want how I
proceeded. I explained my method removing code, but I also asked for a tool.&lt;/p&gt;
&lt;p&gt;Xavier created bpo-22607 at 2014-10-11 and wrote a patch based on an integer
range to run a subset of tests and did something special on the &lt;tt class="docutils literal"&gt;subTest()&lt;/tt&gt;
context manager. But &lt;strong&gt;Georg Brandl&lt;/strong&gt; wasn't convinced by this approach and...
I forgot this issue.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-design-list-tests-run-a-subset"&gt;
&lt;h2&gt;New design: list tests, run a subset&lt;/h2&gt;
&lt;p&gt;During this quarter, I had to fix dozens of reference leaks but also tests
failing with &amp;quot;environment changed&amp;quot;: one test method modified &amp;quot;something&amp;quot;. It
was really painful to identify each time the failing test.&lt;/p&gt;
&lt;p&gt;So I created bpo-29512 at 2017-02-09 to ask again the same tool. Technically, I
just wanted to run a subset of tests.&lt;/p&gt;
&lt;p&gt;While working on OpenStack, I enjoyed the &lt;tt class="docutils literal"&gt;testr&lt;/tt&gt; tool, a test runner able to
list tests and to run a subset of tests. &lt;tt class="docutils literal"&gt;testr&lt;/tt&gt; also provides a bisection
tool to identify a subset of tests enough to reproduce a bug. The subset can
contain more than a single test. Sometimes you need to run two tests
sequentially to trigger a specific bug, and it's usually long and boring to
identify manually these two tests.&lt;/p&gt;
&lt;p&gt;I proposed a similar design for my bisection tool. Start by listing all tests,
and then:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;create a pure &lt;em&gt;random&lt;/em&gt; sample of tests: subset with half the size of the
current test set&lt;/li&gt;
&lt;li&gt;If tests still fail, use the subset as the new set. Otherwise, throw the
subset.&lt;/li&gt;
&lt;li&gt;Loop until the subset is small enough or the process run longer than 100
iterations.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="regrtest-list-cases"&gt;
&lt;h2&gt;regrtest --list-cases&lt;/h2&gt;
&lt;p&gt;To list tests, I created bpo-30523 and wrote a patch for the unittest module.
Modifying unittest didn't work well with doctests and the command line
interface (CLI) didn't work as I wanted. I proposed to modify regrtest instead
of unittest.&lt;/p&gt;
&lt;p&gt;I proposed to &lt;strong&gt;Louie Lu&lt;/strong&gt; to implement my new idea. I was impressed that he
implemented it so quickly and that it worked so well! I just asked him to not
exclude doctest test cases, since these test cases were working as expected!  I
quickly merged his modified patch which adds the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--list-cases&lt;/span&gt;&lt;/tt&gt; option to
regrtest.&lt;/p&gt;
&lt;p&gt;Note: regrtest already had a &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--list-tests&lt;/span&gt;&lt;/tt&gt; which lists test &lt;em&gt;files&lt;/em&gt;, whereas
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--list-cases&lt;/span&gt;&lt;/tt&gt; lists test &lt;em&gt;methods&lt;/em&gt; and doctests.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="regrtest-matchfile"&gt;
&lt;h2&gt;regrtest --matchfile&lt;/h2&gt;
&lt;p&gt;I created bpo-30540 to add a --matchfile option to regrtest. regrtest already
had a --match option, but it was only possible to use the option once, and I
wanted to use a text files for my list of tests.&lt;/p&gt;
&lt;p&gt;Again, I was surprised that it was so simple to implement the feature. By the
way, I modified regrtest --match to allow to specific the option multiple
times, to run multiple tests instead of a single one.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-test-bisect-tool"&gt;
&lt;h2&gt;New test.bisect tool&lt;/h2&gt;
&lt;p&gt;Since I had the two key features: &lt;tt class="docutils literal"&gt;regrtest &lt;span class="pre"&gt;--list-cases&lt;/span&gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;regrtest
&lt;span class="pre"&gt;--matchfile&lt;/span&gt;&lt;/tt&gt;, it became trivial to implement the bisection tool. I wrote a
first prototype. The &amp;quot;prototype&amp;quot; worked much better than expected.&lt;/p&gt;
&lt;p&gt;My first version required a text file listing test cases. I modified it to run
automatically the new &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--list-cases&lt;/span&gt;&lt;/tt&gt; command.&lt;/p&gt;
&lt;p&gt;I extended the tool to not only track reference leaks, but also &amp;quot;environment
changed&amp;quot; failures like finding a test which creates a file but doesn't remove
it.&lt;/p&gt;
&lt;p&gt;I was asked to add this tool in the Python stdlib, so I added it as
&lt;tt class="docutils literal"&gt;Lib/test/bisect.py&lt;/tt&gt; to use it with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
python3 -m test.bisect ...
&lt;/pre&gt;
&lt;p&gt;The test.bisect CLI is similar to the test CLI on purpose.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="reference-leak-example"&gt;
&lt;h2&gt;Reference leak example&lt;/h2&gt;
&lt;p&gt;I modified &lt;tt class="docutils literal"&gt;test_access()&lt;/tt&gt; of test_os to add manually a reference leak:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test -R 3:3 test_os
(...)
test_os leaked [1, 1, 1] references, sum=3
test_os leaked [1, 1, 1] memory blocks, sum=3
test_os failed in 33 sec
(...)
&lt;/pre&gt;
&lt;p&gt;Just replace &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-m&lt;/span&gt; test&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-m&lt;/span&gt; test.bisect&lt;/tt&gt; in the command, and you get
the guilty method:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m test.bisect -R 3:3 test_os
Start bisection with 257 tests
Test arguments: -R 3:3 test_os
Bisection will stop when getting 1 or less tests (-n/--max-tests option), or after 100 iterations (-N/--max-iter option)

[+] Iteration 1: run 128 tests/257

+ /home/haypo/prog/python/master/python -m test --matchfile /tmp/tmpvbraed7h -R 3:3 test_os
(...)
Tests succeeded: skip this subtest, try a new subbset

[+] Iteration 2: run 128 tests/257

+ /home/haypo/prog/python/master/python -m test --matchfile /tmp/tmpcjqtzgfe -R 3:3 test_os
(...)
Tests failed: use this new subtest

[+] Iteration 3: run 64 tests/128
(...)
[+] Iteration 15: run 1 tests/2
(...)

Tests (1):
* test.test_os.FileTests.test_access

Bisection completed in 16 iterations and 0:03:10
&lt;/pre&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;test.bisect&lt;/tt&gt; command found the bug I introduced:
&lt;tt class="docutils literal"&gt;test.test_os.FileTests.test_access&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;The command takes a few minutes, but I don't care of its performance as soon as
its fully automated! If you use the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-o&lt;/span&gt; file&lt;/tt&gt; option, each time the tool is
able to reduce the size of the test set, it writes the new list of tests on
disk. So even if the tool crashs or fails to find a single failure test, it
already helps!&lt;/p&gt;
&lt;p&gt;I am now very happy that &lt;tt class="docutils literal"&gt;test.bisect&lt;/tt&gt; works better than I expected. So I
backported it to 2.7, 3.5, 3.6 and master branches, since I want to fix &lt;em&gt;all&lt;/em&gt;
buildbot failures on &lt;em&gt;all&lt;/em&gt; maintained branches.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="environment-changed-example"&gt;
&lt;h2&gt;Environment changed example&lt;/h2&gt;
&lt;p&gt;While running the previous example, I noticed the following warning:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
&lt;/pre&gt;
&lt;p&gt;Using the new &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--fail-env-changed&lt;/span&gt;&lt;/tt&gt; option, it is now posible to check which
test of test_os emits such warning:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
haypo&amp;#64;selma$ ./python -m test.bisect --fail-env-changed -R 3:3 test_os
(...)

Tests (1):
* test.test_os.TestSendfile.test_keywords

Bisection completed in 14 iterations and 0:03:27
&lt;/pre&gt;
&lt;p&gt;I never trust anything, so let's confirm the bug:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
haypo&amp;#64;selma$ ./python -m test --fail-env-changed -R 3:3 test_os -m test.test_os.TestSendfile.test_keywords
Run tests sequentially
0:00:00 load avg: 0.33 [1/1] test_os
Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
beginning 6 repetitions
123456
Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.
Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.
test_os failed (env changed)

1 test altered the execution environment:
    test_os

Total duration: 21 sec
Tests result: ENV CHANGED
&lt;/pre&gt;
&lt;p&gt;Ok right, there is something wrong with test_keywords(). I just opened
the &lt;a class="reference external" href="http://bugs.python.org/issue30908"&gt;bpo-30908&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category><category term="tests"></category></entry><entry><title>My contributions to CPython during 2017 Q1</title><link href="https://vstinner.github.io/contrib-cpython-2017q1.html" rel="alternate"></link><published>2017-07-05T12:00:00+02:00</published><updated>2017-07-05T12:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-07-05:/contrib-cpython-2017q1.html</id><summary type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q1
(january, februrary, march):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Statistics&lt;/li&gt;
&lt;li&gt;Optimization&lt;/li&gt;
&lt;li&gt;Tricky bug&lt;/li&gt;
&lt;li&gt;FASTCALL optimizations&lt;/li&gt;
&lt;li&gt;Stack consumption&lt;/li&gt;
&lt;li&gt;Contributions&lt;/li&gt;
&lt;li&gt;os.urandom() and getrandom()&lt;/li&gt;
&lt;li&gt;Migration to GitHub&lt;/li&gt;
&lt;li&gt;Enhancements&lt;/li&gt;
&lt;li&gt;Security&lt;/li&gt;
&lt;li&gt;regrtest&lt;/li&gt;
&lt;li&gt;Bugfixes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q4.html"&gt;My contributions to CPython during 2016 Q4&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html"&gt;My contributions to
CPython during 2017 Q2 (part 1 …&lt;/a&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2017 Q1
(january, februrary, march):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Statistics&lt;/li&gt;
&lt;li&gt;Optimization&lt;/li&gt;
&lt;li&gt;Tricky bug&lt;/li&gt;
&lt;li&gt;FASTCALL optimizations&lt;/li&gt;
&lt;li&gt;Stack consumption&lt;/li&gt;
&lt;li&gt;Contributions&lt;/li&gt;
&lt;li&gt;os.urandom() and getrandom()&lt;/li&gt;
&lt;li&gt;Migration to GitHub&lt;/li&gt;
&lt;li&gt;Enhancements&lt;/li&gt;
&lt;li&gt;Security&lt;/li&gt;
&lt;li&gt;regrtest&lt;/li&gt;
&lt;li&gt;Bugfixes&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q4.html"&gt;My contributions to CPython during 2016 Q4&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html"&gt;My contributions to
CPython during 2017 Q2 (part 1)&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="statistics"&gt;
&lt;h2&gt;Statistics&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
# All commits
$ git log --after=2016-12-31 --before=2017-04-01 --reverse --branches='*' --author=Stinner &amp;gt; 2017Q1
$ grep '^commit ' 2017Q1|wc -l
121

# Exclude merges
$ git log --no-merges --after=2016-12-31 --before=2017-04-01 --reverse --branches='*' --author=Stinner|grep '^commit '|wc -l
105

# master branch (excluding merges)
$ git log --no-merges --after=2016-12-31 --before=2017-04-01 --reverse --author=Stinner origin/master|grep '^commit '|wc -l
98

# Only merges
$ git log --merges --after=2016-12-31 --before=2017-04-01 --reverse --branches='*' --author=Stinner|grep '^commit '|wc -l
16
&lt;/pre&gt;
&lt;p&gt;Statistics: &lt;strong&gt;98&lt;/strong&gt; commits in the master branch, 16 merge commits (done using
Mercurial before the migration to GitHub, and then converted to Git), and 7
other commits (likely backports), total: &lt;strong&gt;121&lt;/strong&gt; commits.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="optimization"&gt;
&lt;h2&gt;Optimization&lt;/h2&gt;
&lt;p&gt;With the work done in 2016 on FASTCALL, it became much easier to optimize code
by using the new FASTCALL API.&lt;/p&gt;
&lt;div class="section" id="python-slots"&gt;
&lt;h3&gt;Python slots&lt;/h3&gt;
&lt;p&gt;Issue #29507: I worked with &lt;strong&gt;INADA Naoki&lt;/strong&gt; to continue the work he did with
&lt;strong&gt;Yury Selivanov&lt;/strong&gt; on optimizing method calls. We optimized &amp;quot;slots&amp;quot; implemented
in Python. Slots is an internal optimization to call &amp;quot;dunder&amp;quot; methods like
&lt;tt class="docutils literal"&gt;__getitem__()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;For Python methods, get the unbound Python function and prepend arguments with
&lt;em&gt;self&lt;/em&gt;, rather than calling the descriptor which creates a temporary
PyMethodObject.&lt;/p&gt;
&lt;p&gt;Add a new _PyObject_FastCall_Prepend() function used to call the unbound Python
method with &lt;em&gt;self&lt;/em&gt;. It avoids the creation of a temporary tuple to pass
positional arguments.&lt;/p&gt;
&lt;p&gt;Avoiding a temporary PyMethodObject and a temporary tuple makes Python slots up
to &lt;strong&gt;1.46x faster&lt;/strong&gt;. Microbenchmark on a &lt;tt class="docutils literal"&gt;__getitem__()&lt;/tt&gt; method implemented
in Python:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Median +- std dev: 121 ns +- 5 ns -&amp;gt; 82.8 ns +- 1.0 ns: 1.46x faster (-31%)
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="struct-module"&gt;
&lt;h3&gt;struct module&lt;/h3&gt;
&lt;p&gt;In the issue #29300, &lt;strong&gt;Serhiy Storchaka&lt;/strong&gt; and me converted most methods in the
C &lt;tt class="docutils literal"&gt;_struct&lt;/tt&gt; module to Argument Clinic to make them use the FASTCALL calling
convention. Using METH_FASTCALL avoids the creation of temporary tuple to pass
positional arguments and so is faster. For example, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;struct.pack(&amp;quot;i&amp;quot;,&lt;/span&gt; 1)&lt;/tt&gt;
becomes &lt;strong&gt;1.56x faster&lt;/strong&gt; (-36%):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python -m perf timeit \
    -s 'import struct; pack=struct.pack' 'pack(&amp;quot;i&amp;quot;, 1)' \
    --compare-to=../default-ref/python
Median +- std dev: 119 ns +- 1 ns -&amp;gt; 76.8 ns +- 0.4 ns: 1.56x faster (-36%)
Significant (t=295.91)
&lt;/pre&gt;
&lt;p&gt;The difference is only &lt;tt class="docutils literal"&gt;42.2 ns&lt;/tt&gt;, but since the function only takes &lt;tt class="docutils literal"&gt;76.8
ns&lt;/tt&gt;, the difference is significant. The speedup can also be explained by more
efficient functions used to parse arguments. The new functions now use a cache
on the format string.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="deque-module"&gt;
&lt;h3&gt;deque module&lt;/h3&gt;
&lt;p&gt;Similar change in the deque module, I modified the index(), insert() and
rotate() methods to use METH_FASTCALL. Speedup:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;d.index(): &lt;strong&gt;1.24x faster&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;d.rotate(1): 1.24x faster&lt;/li&gt;
&lt;li&gt;d.insert(): 1.18x faster&lt;/li&gt;
&lt;li&gt;d.rotate(): 1.10x faster&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="tricky-bug"&gt;
&lt;h2&gt;Tricky bug&lt;/h2&gt;
&lt;div class="section" id="test-exceptions-test-unraisable"&gt;
&lt;h3&gt;test_exceptions.test_unraisable()&lt;/h3&gt;
&lt;p&gt;The optimization on Python slots (issue #29507) caused a regression in the
test_unraisable() unit test of test_exceptions.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;test_unraisable()&lt;/tt&gt; method expects that &lt;tt class="docutils literal"&gt;PyErr_WriteUnraisable(method)&lt;/tt&gt;
fails on &lt;tt class="docutils literal"&gt;repr(method)&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Before the change, &lt;tt class="docutils literal"&gt;slot_tp_finalize()&lt;/tt&gt; called
&lt;tt class="docutils literal"&gt;PyErr_WriteUnraisable()&lt;/tt&gt; with a PyMethodObject. In this case,
&lt;tt class="docutils literal"&gt;repr(method)&lt;/tt&gt; calls &lt;tt class="docutils literal"&gt;repr(self)&lt;/tt&gt; which is &lt;tt class="docutils literal"&gt;BrokenRepr.__repr__()&lt;/tt&gt; and
the calls raises a new exception.&lt;/p&gt;
&lt;p&gt;After the change, &lt;tt class="docutils literal"&gt;slot_tp_finalize()&lt;/tt&gt; uses an unbound method:
&lt;tt class="docutils literal"&gt;repr()&lt;/tt&gt; is called on a regular &lt;tt class="docutils literal"&gt;__del__()&lt;/tt&gt; method which doesn't call
&lt;tt class="docutils literal"&gt;repr(self)&lt;/tt&gt; and so &lt;tt class="docutils literal"&gt;repr()&lt;/tt&gt; doesn't fail anymore.&lt;/p&gt;
&lt;p&gt;The fix is to remove the BrokenRepr unit test, since
&lt;tt class="docutils literal"&gt;PyErr_WriteUnraisable()&lt;/tt&gt; doesn't call &lt;tt class="docutils literal"&gt;__repr__()&lt;/tt&gt; anymore.&lt;/p&gt;
&lt;p&gt;The removed test was really implementation specific, and my optimization
&amp;quot;fixed&amp;quot; the bug or &amp;quot;broke&amp;quot; the test. It's hard to say :-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="unittest-assertraises-reference-cycle"&gt;
&lt;h3&gt;unittest assertRaises() reference cycle&lt;/h3&gt;
&lt;p&gt;At April 2015, &lt;strong&gt;Vjacheslav Fyodorov&lt;/strong&gt; reported a reference cycle in the
assertRaises() method of the unittest module: bpo-23890.&lt;/p&gt;
&lt;p&gt;When the context manager API of the &lt;tt class="docutils literal"&gt;assertRaises()&lt;/tt&gt; method is used, the
context manager returns an object which contains the exception. So the
exception is kept alive longer than usual.&lt;/p&gt;
&lt;p&gt;Python 3 exceptions now store traceback objects which contain local variables.
If a function stores the current exception in a local variable and the frame of
this function is part of the traceback, we get a reference cycle:&lt;/p&gt;
&lt;blockquote&gt;
exception -&amp;gt; traceback &amp;gt; frame -&amp;gt; variable -&amp;gt; exception&lt;/blockquote&gt;
&lt;p&gt;I fixed the reference cycle by manually clearing local variables. Example of
change of my commit:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
try:
    return context.handle('assertRaises', args, kwargs)
finally:
    # bpo-23890: manually break a reference cycle
    context = None
&lt;/pre&gt;
&lt;p&gt;It's not the first time that I fixed such reference cycle in the unit test
module. My previous fix was the issue #19880. Fix a reference leak in
unittest.TestCase. Explicitly break reference cycles between frames and the
&lt;tt class="docutils literal"&gt;_Outcome&lt;/tt&gt; instance: commit &lt;a class="reference external" href="https://github.com/python/cpython/commit/031bd532c48cf20a9cbf438bdae75dde49e36c51"&gt;031bd532&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="fastcall-optimizations"&gt;
&lt;h2&gt;FASTCALL optimizations&lt;/h2&gt;
&lt;p&gt;FASTCALL is my project to avoid temporary tuple to pass positional arguments
and avoid temporary dictionary to pass keyword arguments when calling a
function. It optimizes function calls in general.&lt;/p&gt;
&lt;p&gt;I continued work on FASTCALL to optimize code further and use FASTCALL in more
cases.&lt;/p&gt;
&lt;div class="section" id="recursion-depth"&gt;
&lt;h3&gt;Recursion depth&lt;/h3&gt;
&lt;p&gt;In the issue #29306, I fixed the usage of Py_EnterRecursiveCall() to account
correctly the recursion depth, to fix the code responsible to prevent C stack
overflow:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;*PyCFunction_*Call*()&lt;/span&gt;&lt;/tt&gt; functions now call &lt;tt class="docutils literal"&gt;Py_EnterRecursiveCall()&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PyObject_Call()&lt;/tt&gt; now calls directly &lt;tt class="docutils literal"&gt;_PyFunction_FastCallDict()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;PyCFunction_Call()&lt;/tt&gt; to avoid calling &lt;tt class="docutils literal"&gt;Py_EnterRecursiveCall()&lt;/tt&gt; twice per
function call&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="support-position-arguments"&gt;
&lt;h3&gt;Support position arguments&lt;/h3&gt;
&lt;p&gt;The issue #29286 enhanced Argument Clinic to use FASTCALL for functions which
only accept positional arguments:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Rename _PyArg_ParseStack to _PyArg_ParseStackAndKeywords&lt;/li&gt;
&lt;li&gt;Add _PyArg_ParseStack() helper function&lt;/li&gt;
&lt;li&gt;Add _PyArg_NoStackKeywords() helper function.&lt;/li&gt;
&lt;li&gt;Add _PyArg_UnpackStack() function helper&lt;/li&gt;
&lt;li&gt;Argument Clinic: Use METH_FASTCALL calling convention instead of METH_VARARGS
to parse position arguments and to parse &amp;quot;boring&amp;quot; position arguments.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="functions-converted-to-fastcall"&gt;
&lt;h3&gt;Functions converted to FASTCALL&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;_hashopenssl module&lt;/li&gt;
&lt;li&gt;collections.OrderedDict methods (some of them, not all)&lt;/li&gt;
&lt;li&gt;__build_class__(), getattr(), next() and sorted() builtin functions&lt;/li&gt;
&lt;li&gt;type_prepare() C function, used in type constructor&lt;/li&gt;
&lt;li&gt;dict.get() and dict.setdefault() now use Argument Clinic. The signature of
docstrings is also enhanced. For example, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;get(...)&lt;/span&gt;&lt;/tt&gt; becomes
&lt;tt class="docutils literal"&gt;get(self, key, default=None, /)&lt;/tt&gt;. Add also a note explaining why
dict_update() doesn't use METH_FASTCALL.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="optimizations"&gt;
&lt;h3&gt;Optimizations&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #28839: Optimize function_call(), now simply calls
_PyFunction_FastCallDict() which is more efficient (fast paths for the common
case, optimized code object and no keyword argument).&lt;/li&gt;
&lt;li&gt;Issue #28839: Optimize _PyFunction_FastCallDict() when kwargs is an empty
dictionary, avoid the creation of an useless empty tuple.&lt;/li&gt;
&lt;li&gt;Issue #29259: Write fast path in _PyCFunction_FastCallKeywords() for
METH_FASTCALL, avoid the creation of a temporary dictionary for keyword
arguments.&lt;/li&gt;
&lt;li&gt;Issue #29259, #29263. methoddescr_call() creates a PyCFunction object, call
it and the destroy it. Add a new _PyMethodDef_RawFastCallDict() method to
avoid the temporary PyCFunction object.&lt;/li&gt;
&lt;li&gt;PyCFunction_Call() now calls _PyCFunction_FastCallDict()&lt;/li&gt;
&lt;li&gt;bpo-29735: Optimize partial_call(): avoid tuple. Add _PyObject_HasFastCall().
Fix also a performance regression in partial_call() if the callable doesn't
support FASTCALL.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="bugfixes"&gt;
&lt;h3&gt;Bugfixes&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #29286: _PyStack_UnpackDict() now returns -1 on error. Change
_PyStack_UnpackDict() prototype to be able to notify of failure when args is
NULL.&lt;/li&gt;
&lt;li&gt;Fix PyCFunction_Call() performance issue. Issue #29259, #29465:
PyCFunction_Call() doesn't create anymore a redundant tuple to pass
positional arguments for METH_VARARGS. Add a new cfunction_call()
subfunction.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="objects-call-c-file"&gt;
&lt;h3&gt;Objects/call.c file&lt;/h3&gt;
&lt;p&gt;The issue #29465 moved all C functions &amp;quot;calling functions&amp;quot; to a new
Objects/call.c file. Moving all functions at the same place should help to keep
the code consistent. It might also help the compiler to inline code more
easily, or maybe help to cache more machine code in CPU instruction cache.&lt;/p&gt;
&lt;p&gt;This change was made during the GitHub migration. Since the change is big
(modify many &lt;tt class="docutils literal"&gt;.c&lt;/tt&gt; files), I got many conflicts and it was annoying to rebase
it. I am now happy to get this &lt;tt class="docutils literal"&gt;call.c&lt;/tt&gt; file, it already helped me :-)&lt;/p&gt;
&lt;p&gt;Having &lt;tt class="docutils literal"&gt;call.c&lt;/tt&gt; also helps to keep helper functions need their callers, and
prevent to expose them in the C API, even if they are exposed as private
functions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="don-t-optimize-keywords"&gt;
&lt;h3&gt;Don't optimize keywords&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Document that _PyFunction_FastCallDict() must copy kwargs. Issue #29318:
Caller and callee functions must not share the dictionary: kwargs must be
copied.&lt;/li&gt;
&lt;li&gt;Document why functools.partial() must copy kwargs. Add a comment to prevent
further attempts to avoid a copy for optimization.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="stack-consumption"&gt;
&lt;h2&gt;Stack consumption&lt;/h2&gt;
&lt;p&gt;A FASTCALL micro-optimization was blocked by Serhiy Storchaka because it
increased the C stack consumption. In the past, I never analyzed the C stack
consumption. Since I wanted to get this micro-optimization merged, I tried to
reduce the consumption.&lt;/p&gt;
&lt;p&gt;At the beginning, I wrote a function to &lt;strong&gt;measure&lt;/strong&gt; the C stack consumption in
a reliable way. It took me a few iterations.&lt;/p&gt;
&lt;p&gt;Table showing the C stack consumption in bytes, and the difference compared to
Python 3.5 (last release before I started working on FASTCALL):&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="27%" /&gt;
&lt;col width="22%" /&gt;
&lt;col width="7%" /&gt;
&lt;col width="22%" /&gt;
&lt;col width="22%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Function&lt;/th&gt;
&lt;th class="head"&gt;2.7&lt;/th&gt;
&lt;th class="head"&gt;3.5&lt;/th&gt;
&lt;th class="head"&gt;3.6&lt;/th&gt;
&lt;th class="head"&gt;3.7&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;test_python_call&lt;/td&gt;
&lt;td&gt;1,360 (&lt;strong&gt;+352&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;1,008&lt;/td&gt;
&lt;td&gt;1,120 (&lt;strong&gt;+112&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;960 (&lt;strong&gt;-48&lt;/strong&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;test_python_getitem&lt;/td&gt;
&lt;td&gt;1,408 (&lt;strong&gt;+288&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;1,120&lt;/td&gt;
&lt;td&gt;1,168 (&lt;strong&gt;+48&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;880 (&lt;strong&gt;-240&lt;/strong&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;test_python_iterator&lt;/td&gt;
&lt;td&gt;1,424 (&lt;strong&gt;+192&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;1,232&lt;/td&gt;
&lt;td&gt;1,200 (&lt;strong&gt;-32&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;1,024 (&lt;strong&gt;-208&lt;/strong&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;Total&lt;/td&gt;
&lt;td&gt;4,192 (&lt;strong&gt;+832&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;3,360&lt;/td&gt;
&lt;td&gt;3,488 (&lt;strong&gt;+128&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;2,864 (&lt;strong&gt;-496&lt;/strong&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Table showing the number of function calls before a stack overflow,
and the difference compared to Python 3.5:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="24%" /&gt;
&lt;col width="23%" /&gt;
&lt;col width="7%" /&gt;
&lt;col width="23%" /&gt;
&lt;col width="23%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Function&lt;/th&gt;
&lt;th class="head"&gt;2.7&lt;/th&gt;
&lt;th class="head"&gt;3.5&lt;/th&gt;
&lt;th class="head"&gt;3.6&lt;/th&gt;
&lt;th class="head"&gt;3.7&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;test_python_call&lt;/td&gt;
&lt;td&gt;6,161 (&lt;strong&gt;-2,153&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;8,314&lt;/td&gt;
&lt;td&gt;7,482 (&lt;strong&gt;-832&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;8,729 (&lt;strong&gt;+415&lt;/strong&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;test_python_getitem&lt;/td&gt;
&lt;td&gt;5,951 (&lt;strong&gt;-1,531&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;7,482&lt;/td&gt;
&lt;td&gt;7,174 (&lt;strong&gt;-308&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;9,522 (&lt;strong&gt;+2,040&lt;/strong&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;test_python_iterator&lt;/td&gt;
&lt;td&gt;5,885 (&lt;strong&gt;-916&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;6,801&lt;/td&gt;
&lt;td&gt;6,983 (&lt;strong&gt;+182&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;8,184 (&lt;strong&gt;+1,383&lt;/strong&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;Total&lt;/td&gt;
&lt;td&gt;17,997 (&lt;strong&gt;-4600&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;22,597&lt;/td&gt;
&lt;td&gt;21,639 (&lt;strong&gt;-958&lt;/strong&gt;)&lt;/td&gt;
&lt;td&gt;26,435 (&lt;strong&gt;+3,838&lt;/strong&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Python 3.7 is the best of 2.7, 3.5, 3.6 and 3.7: lowest stack consumption and
maximum number of calls (before a stack overflow) ;-)&lt;/p&gt;
&lt;p&gt;Changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;call_method() now uses _PyObject_FastCall(). Issue #29233: Replace the
inefficient _PyObject_VaCallFunctionObjArgs() with _PyObject_FastCall() in
call_method() and call_maybe().&lt;/li&gt;
&lt;li&gt;Issue #29227: Inline call_function() into _PyEval_EvalFrameDefault() using
Py_LOCAL_INLINE to reduce the stack consumption.&lt;/li&gt;
&lt;li&gt;Issue #29234: Inlining _PyStack_AsTuple() into callers increases their stack
consumption, Disable inlining to optimize the stack consumption. Add
_Py_NO_INLINE: use __attribute__((noinline)) of GCC and Clang.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="contributions"&gt;
&lt;h2&gt;Contributions&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #28961: Fix unittest.mock._Call helper: don't ignore the name parameter
anymore. Patch written by &lt;strong&gt;Jiajun Huang&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Prohibit implicit C function declarations. Issue #27659: use
-Werror=implicit-function-declaration when possible (GCC and Clang, but it
depends on the compiler version). Patch written by &lt;strong&gt;Chi Hsuan Yen&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="os-urandom-and-getrandom"&gt;
&lt;h2&gt;os.urandom() and getrandom()&lt;/h2&gt;
&lt;p&gt;As usual, I had fun with os.urandom() in this quarter (see my previous article
on urandom: &lt;a class="reference external" href="https://vstinner.github.io/pep-524-os-urandom-blocking.html"&gt;PEP 524: os.urandom() now blocks on Linux in Python 3.6&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;The glibc developers succeeded to implement a function getrandom() in glibc
2.25 (February 2017) to expose the &amp;quot;new&amp;quot; Linux getrandom() syscall which was
introduced in Linux 3.17 (August 2014). Read the LWN article: &lt;a class="reference external" href="https://lwn.net/Articles/711013/"&gt;The long road to
getrandom() in glibc&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I created the issue #29157 because my os.urandom() implementation wasn't ready
for the addition of a getrandom() function on Linux. My implementation using
the getrandom() function didn't handle the ENOSYS error (syscall not
supported), when Python is compiled on a recent kernel and glibc, but run on an
older kernel and glibc.&lt;/p&gt;
&lt;p&gt;I rewrote the code to prefer getrandom() over getentropy():&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;dev_urandom() now calls py_getentropy(). Prepare the fallback to support
getentropy() failure and falls back on reading from /dev/urandom.&lt;/li&gt;
&lt;li&gt;Simplify dev_urandom(). pyurandom() is now responsible to call getentropy()
or getrandom(). Enhance also dev_urandom() and pyurandom() documentation.&lt;/li&gt;
&lt;li&gt;getrandom() is now preferred over getentropy(). The glibc 2.24 now implements
getentropy() on Linux using the getrandom() syscall.  But getentropy()
doesn't support non-blocking mode. Since getrandom() is tried first, it's not
more needed to explicitly exclude getentropy() on Solaris. Replace:
&amp;quot;if defined(HAVE_GETENTROPY) &amp;amp;&amp;amp; !defined(sun)&amp;quot;
with &amp;quot;if defined(HAVE_GETENTROPY)&amp;quot;&lt;/li&gt;
&lt;li&gt;Enhance py_getrandom() documentation. py_getentropy() now supports ENOSYS,
EPERM &amp;amp; EINTR&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;IMHO the main enhancement was the documentation (comments) of the code. The
main function pyrandom() now has this long comment:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Read random bytes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Return 0 on success&lt;/li&gt;
&lt;li&gt;Raise an exception (if raise is non-zero) and return -1 on error&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Used sources of entropy ordered by preference, preferred source first:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;CryptGenRandom() on Windows&lt;/li&gt;
&lt;li&gt;getrandom() function (ex: Linux and Solaris): call py_getrandom()&lt;/li&gt;
&lt;li&gt;getentropy() function (ex: OpenBSD): call py_getentropy()&lt;/li&gt;
&lt;li&gt;/dev/urandom device&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Read from the /dev/urandom device if getrandom() or getentropy() function
is not available or does not work.&lt;/p&gt;
&lt;p&gt;Prefer getrandom() over getentropy() because getrandom() supports blocking
and non-blocking mode: see the PEP 524. Python requires non-blocking RNG at
startup to initialize its hash secret, but os.urandom() must block until the
system urandom is initialized (at least on Linux 3.17 and newer).&lt;/p&gt;
&lt;p&gt;Prefer getrandom() and getentropy() over reading directly /dev/urandom
because these functions don't need file descriptors and so avoid ENFILE or
EMFILE errors (too many open files): see the issue #18756.&lt;/p&gt;
&lt;p&gt;Only the getrandom() function supports non-blocking mode.&lt;/p&gt;
&lt;p&gt;Only use RNG running in the kernel. They are more secure because it is
harder to get the internal state of a RNG running in the kernel land than a
RNG running in the user land. The kernel has a direct access to the hardware
and has access to hardware RNG, they are used as entropy sources.&lt;/p&gt;
&lt;p&gt;Note: the OpenSSL RAND_pseudo_bytes() function does not automatically reseed
its RNG on fork(), two child processes (with the same pid) generate the same
random numbers: see issue #18747. Kernel RNGs don't have this issue,
they have access to good quality entropy sources.&lt;/p&gt;
&lt;p&gt;If raise is zero:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Don't raise an exception on error&lt;/li&gt;
&lt;li&gt;Don't call the Python signal handler (don't call PyErr_CheckSignals()) if
a function fails with EINTR: retry directly the interrupted function&lt;/li&gt;
&lt;li&gt;Don't release the GIL to call functions.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="migration-to-github"&gt;
&lt;h2&gt;Migration to GitHub&lt;/h2&gt;
&lt;p&gt;In February 2017, the Mercurial repository was converted to Git and the
development of CPython moved to GitHub at &lt;a class="reference external" href="https://github.com/python/cpython/"&gt;https://github.com/python/cpython/&lt;/a&gt;. I
helped to polish the migration in early days:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Rename README to README.rst and enhance formatting&lt;/li&gt;
&lt;li&gt;bpo-29527: Don't treat warnings as error in Travis docs job&lt;/li&gt;
&lt;li&gt;Travis CI: run rstlint.py in the docs job. Currently,
&lt;a class="reference external" href="http://buildbot.python.org/all/buildslaves/ware-docs"&gt;http://buildbot.python.org/all/buildslaves/ware-docs&lt;/a&gt; buildbot is only run as
post-commit. For example, bpo-29521 (PR#41) introduced two warnings,
unnotified by the Travis CI docs job. Modify the docs job to run
toosl/rstlint.py. Fix also the two minor warnings which causes the buildbot
slave to fail. Doc/Makefile: set PYTHON to python3.&lt;/li&gt;
&lt;li&gt;Add Travis CI and Codecov badges to README.&lt;/li&gt;
&lt;li&gt;Exclude myself from mention-bot. I made changes in almost all CPython files
last 5 years, so mention-bot asks me to review basically all pull requests. I
simply don't have the bandwidth to review everything, sorry! I prefer to
select myself which PR I want to follow.&lt;/li&gt;
&lt;li&gt;bpo-27425: Add .gitattributes, fix Windows tests. Mark binary files as binay
in .gitattributes to not translate newline characters in Git repositories on
Windows.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="enhancements"&gt;
&lt;h2&gt;Enhancements&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #29259: python-gdb.py now also looks for PyCFunction in the current
frame, not only in the older frame. python-gdb.py now also supports
method-wrapper (wrapperobject) objects (Issue #29367).&lt;/li&gt;
&lt;li&gt;Issue #26273: Document the new TCP_USER_TIMEOUT and TCP_CONGESTION constants&lt;/li&gt;
&lt;li&gt;bpo-29919: Remove unused imports found by pyflakes. Make also minor PEP8
coding style fixes on modified imports.&lt;/li&gt;
&lt;li&gt;bpo-29887: Test normalization now fails if download fails; fix also a
ResourceWarning.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="security"&gt;
&lt;h2&gt;Security&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Backport for Python 3.4. Issues #27850 and #27766: Remove 3DES from ssl
default cipher list and add ChaCha20 Poly1305. See the &lt;a class="reference external" href="http://python-security.readthedocs.io/vuln/cve-2016-2183_sweet32_attack_des_3des.html"&gt;CVE-2016-2183:
Sweet32 attack (DES, 3DES)&lt;/a&gt;
vulnerability.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="regrtest"&gt;
&lt;h2&gt;regrtest&lt;/h2&gt;
&lt;p&gt;regrtest is the runner of the Python test suite. Changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;regrtest: don't fail immediately if a child does crash. Issue #29362: Catch a
crash of a worker process as a normal failure and continue to run next tests.
It allows to get the usual test summary: single line result (OK/FAIL), total
duration, etc.&lt;/li&gt;
&lt;li&gt;Fix regrtest -j0 -R output: write also dots into stderr, instead of stdout.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;Bugfixes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #29140: Fix hash(datetime.time). Fix time_hash() function: replace
DATE_xxx() macros with TIME_xxx() macros. Before, the hash function used a
wrong value for microseconds if fold is set (equal to 1).&lt;/li&gt;
&lt;li&gt;Issue #29174, #26741: Fix subprocess.Popen.__del__() on Python shutdown.
subprocess.Popen.__del__() now keeps a strong reference to warnings.warn()
function. The change allows to log the warning late at Python finalization.
Before the warning was ignored or logged an error instead of the warning.&lt;/li&gt;
&lt;li&gt;Issue #25591: Fix test_imaplib if the module ssl is missing.&lt;/li&gt;
&lt;li&gt;Fix script_helper.run_python_until_end(): copy the &lt;tt class="docutils literal"&gt;SYSTEMROOT&lt;/tt&gt; environment
variable.  Windows requires at least the SYSTEMROOT environment variable to
start Python. If run_python_until_end() doesn't copy SYSTEMROOT, the
function always fail on Windows.&lt;/li&gt;
&lt;li&gt;Fix datetime.fromtimestamp(): check bounds. Issue #29100: Fix
datetime.fromtimestamp() regression introduced in Python 3.6.0: check minimum
and maximum years.&lt;/li&gt;
&lt;li&gt;Fix test_datetime on system with 32-bit time_t. Issue #29100: Catch
OverflowError in the new test_timestamp_limits() test.&lt;/li&gt;
&lt;li&gt;Fix test_datetime on Windows. Issue #29100: On Windows,
datetime.datetime.fromtimestamp(min_ts) fails with an OSError in
test_timestamp_limits().&lt;/li&gt;
&lt;li&gt;bpo-29176: Fix the name of the _curses.window class. Set name to
&lt;tt class="docutils literal"&gt;_curses.window&lt;/tt&gt; instead of &lt;tt class="docutils literal"&gt;_curses.curses window&lt;/tt&gt; with a space!?&lt;/li&gt;
&lt;li&gt;bpo-29619: os.stat() and os.DirEntry.inodeo() now convert inode (st_ino)
using unsigned integers to support very large inodes (larger than 2^31).&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>speed.python.org results: March 2017</title><link href="https://vstinner.github.io/speed-python-org-march-2017.html" rel="alternate"></link><published>2017-03-29T00:40:00+02:00</published><updated>2017-03-29T00:40:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-03-29:/speed-python-org-march-2017.html</id><summary type="html">&lt;p&gt;In feburary 2017, CPython from Bitbucket with Mercurial moved to GitHub with
Git: read &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-February/147381.html"&gt;[Python-Dev] CPython is now on GitHub&lt;/a&gt; by
Brett Cannon.&lt;/p&gt;
&lt;p&gt;In 2016, I worked on speed.python.org to automate running benchmarks and make
benchmarks more stable. At the end, I had a single command to:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;tune …&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;p&gt;In feburary 2017, CPython from Bitbucket with Mercurial moved to GitHub with
Git: read &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-February/147381.html"&gt;[Python-Dev] CPython is now on GitHub&lt;/a&gt; by
Brett Cannon.&lt;/p&gt;
&lt;p&gt;In 2016, I worked on speed.python.org to automate running benchmarks and make
benchmarks more stable. At the end, I had a single command to:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;tune the system for benchmarks&lt;/li&gt;
&lt;li&gt;compile CPython using LTO+PGO&lt;/li&gt;
&lt;li&gt;install CPython&lt;/li&gt;
&lt;li&gt;install performance&lt;/li&gt;
&lt;li&gt;run performance&lt;/li&gt;
&lt;li&gt;upload results&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;But my tools were written for Mercurial and speed.python.org uses Mercurial
revisions as keys for changes. Since the CPython repository was converted to
Git, I have to remove all old results and run again old benchmarks. But before
removing everyhing, I took screenshots of the most interesting pages. It would
prefer to keep a copy of all data, but it would require to write new tools
and I am not motivated to do that.&lt;/p&gt;
&lt;div class="section" id="python-3-7-compared-to-python-2-7"&gt;
&lt;h2&gt;Python 3.7 compared to Python 2.7&lt;/h2&gt;
&lt;p&gt;Benchmarks where Python 3.7 is &lt;strong&gt;faster&lt;/strong&gt; than Python 2.7:&lt;/p&gt;
&lt;img alt="python37_faster_py27" src="https://vstinner.github.io/images/speed2017/python37_faster_py27.png" /&gt;
&lt;p&gt;Benchmarks where Python 3.7 is &lt;strong&gt;slower&lt;/strong&gt; than Python 2.7:&lt;/p&gt;
&lt;img alt="python37_slower_py27" src="https://vstinner.github.io/images/speed2017/python37_slower_py27.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="significant-optimizations"&gt;
&lt;h2&gt;Significant optimizations&lt;/h2&gt;
&lt;p&gt;CPython became regulary faster in 2016 on the following benchmarks.&lt;/p&gt;
&lt;p&gt;call_method, the main optimized was &lt;a class="reference external" href="https://bugs.python.org/issue26110"&gt;Speedup method calls 1.2x&lt;/a&gt;:&lt;/p&gt;
&lt;img alt="call_method" src="https://vstinner.github.io/images/speed2017/call_method.png" /&gt;
&lt;p&gt;float:&lt;/p&gt;
&lt;img alt="float" src="https://vstinner.github.io/images/speed2017/float.png" /&gt;
&lt;p&gt;hexiom:&lt;/p&gt;
&lt;img alt="hexiom" src="https://vstinner.github.io/images/speed2017/hexiom.png" /&gt;
&lt;p&gt;nqueens:&lt;/p&gt;
&lt;img alt="nqueens" src="https://vstinner.github.io/images/speed2017/nqueens.png" /&gt;
&lt;p&gt;pickle_list, something happened near September 2016:&lt;/p&gt;
&lt;img alt="pickle_list" src="https://vstinner.github.io/images/speed2017/pickle_list.png" /&gt;
&lt;p&gt;richards:&lt;/p&gt;
&lt;img alt="richards" src="https://vstinner.github.io/images/speed2017/richards.png" /&gt;
&lt;p&gt;scimark_lu, I like the latest dot!&lt;/p&gt;
&lt;img alt="scimark_lu" src="https://vstinner.github.io/images/speed2017/scimark_lu.png" /&gt;
&lt;p&gt;scimark_sor:&lt;/p&gt;
&lt;img alt="scimark_sor" src="https://vstinner.github.io/images/speed2017/scimark_sor.png" /&gt;
&lt;p&gt;sympy_sum:&lt;/p&gt;
&lt;img alt="sympy_sum" src="https://vstinner.github.io/images/speed2017/sympy_sum.png" /&gt;
&lt;p&gt;telco is one of the most impressive, it became regulary faster:&lt;/p&gt;
&lt;img alt="telco" src="https://vstinner.github.io/images/speed2017/telco.png" /&gt;
&lt;p&gt;unpickle_list, something happened between March and May 2016:&lt;/p&gt;
&lt;img alt="unpickle_list" src="https://vstinner.github.io/images/speed2017/unpickle_list.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="the-enum-change"&gt;
&lt;h2&gt;The enum change&lt;/h2&gt;
&lt;p&gt;One change related to the &lt;tt class="docutils literal"&gt;enum&lt;/tt&gt; module had significant impact on the two
following benchmarks.&lt;/p&gt;
&lt;p&gt;python_startup:&lt;/p&gt;
&lt;img alt="python_startup" src="https://vstinner.github.io/images/speed2017/python_startup.png" /&gt;
&lt;p&gt;See &amp;quot;Python startup performance regression&amp;quot; section of &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q4.html"&gt;My contributions to
CPython during 2016 Q4&lt;/a&gt; for the
explanation on changes around September 2016.&lt;/p&gt;
&lt;p&gt;regex_compile became 1.2x slower (312 ms =&amp;gt; 376 ms: +20%) because constants
of the &lt;tt class="docutils literal"&gt;re&lt;/tt&gt; module became &lt;tt class="docutils literal"&gt;enum&lt;/tt&gt; objects: see &lt;a class="reference external" href="http://bugs.python.org/issue28082"&gt;convert re flags to (much
friendlier) IntFlag constants (issue #28082)&lt;/a&gt;.&lt;/p&gt;
&lt;img alt="regex_compile" src="https://vstinner.github.io/images/speed2017/regex_compile.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="benchmarks-became-stable"&gt;
&lt;h2&gt;Benchmarks became stable&lt;/h2&gt;
&lt;p&gt;The following benchmarks are microbenchmarks which are impacted by many
external factors. It's hard to get stable results. I'm happy to see that
results are stable. I would say very stable compared to results when I started
to work on the project!&lt;/p&gt;
&lt;p&gt;call_simple:&lt;/p&gt;
&lt;img alt="call_simple" src="https://vstinner.github.io/images/speed2017/call_simple.png" /&gt;
&lt;p&gt;spectral_norm:&lt;/p&gt;
&lt;img alt="spectral_norm" src="https://vstinner.github.io/images/speed2017/spectral_norm.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="straight-line"&gt;
&lt;h2&gt;Straight line&lt;/h2&gt;
&lt;p&gt;It seems like no optimization had a significant impact on the following
benchmarks. You can also see that benchmarks became stable, so it's easier to
detect performance regression or significant optimization.&lt;/p&gt;
&lt;p&gt;dulwich_log:&lt;/p&gt;
&lt;img alt="dulwich_log" src="https://vstinner.github.io/images/speed2017/dulwich_log.png" /&gt;
&lt;p&gt;pidigits:&lt;/p&gt;
&lt;img alt="pidigits" src="https://vstinner.github.io/images/speed2017/pidigits.png" /&gt;
&lt;p&gt;sqlite_synth:&lt;/p&gt;
&lt;img alt="sqlite_synth" src="https://vstinner.github.io/images/speed2017/sqlite_synth.png" /&gt;
&lt;p&gt;Apart something around April 2016, tornado_http result is stable:&lt;/p&gt;
&lt;img alt="tornado_http" src="https://vstinner.github.io/images/speed2017/tornado_http.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="unstable-benchmarks"&gt;
&lt;h2&gt;Unstable benchmarks&lt;/h2&gt;
&lt;p&gt;After months of efforts to make everything stable, some benchmarks are still
unstable, even if temporary spikes are lower than before. See &lt;a class="reference external" href="https://vstinner.github.io/analysis-python-performance-issue.html"&gt;Analysis of a
Python performance issue&lt;/a&gt;
to see the size of previous tempoary performance spikes.&lt;/p&gt;
&lt;p&gt;regex_v8:&lt;/p&gt;
&lt;img alt="regex_v8" src="https://vstinner.github.io/images/speed2017/regex_v8.png" /&gt;
&lt;p&gt;scimark_sparse_mat_mult:&lt;/p&gt;
&lt;img alt="scimark_sparse_mat_mult" src="https://vstinner.github.io/images/speed2017/scimark_sparse_mat_mult.png" /&gt;
&lt;p&gt;unpickle_pure_python:&lt;/p&gt;
&lt;img alt="unpickle_pure_python" src="https://vstinner.github.io/images/speed2017/unpickle_pure_python.png" /&gt;
&lt;/div&gt;
&lt;div class="section" id="boring-results"&gt;
&lt;h2&gt;Boring results&lt;/h2&gt;
&lt;p&gt;There is nothing interesting to say on the following benchmark results.&lt;/p&gt;
&lt;p&gt;2to3:&lt;/p&gt;
&lt;img alt="2to3" src="https://vstinner.github.io/images/speed2017/2to3.png" /&gt;
&lt;p&gt;crypto_pyaes:&lt;/p&gt;
&lt;img alt="crypto_pyaes" src="https://vstinner.github.io/images/speed2017/crypto_pyaes.png" /&gt;
&lt;p&gt;deltablue:&lt;/p&gt;
&lt;img alt="deltablue" src="https://vstinner.github.io/images/speed2017/deltablue.png" /&gt;
&lt;p&gt;logging_silent:&lt;/p&gt;
&lt;img alt="logging_silent" src="https://vstinner.github.io/images/speed2017/logging_silent.png" /&gt;
&lt;p&gt;mako:&lt;/p&gt;
&lt;img alt="mako" src="https://vstinner.github.io/images/speed2017/mako.png" /&gt;
&lt;p&gt;xml_etree_process:&lt;/p&gt;
&lt;img alt="xml_etree_process" src="https://vstinner.github.io/images/speed2017/xml_etree_process.png" /&gt;
&lt;p&gt;xml_etre_iterparse:&lt;/p&gt;
&lt;img alt="xml_etre_iterparse" src="https://vstinner.github.io/images/speed2017/xml_etre_iterparse.png" /&gt;
&lt;/div&gt;
</content><category term="benchmark"></category><category term="benchmark"></category></entry><entry><title>FASTCALL issues</title><link href="https://vstinner.github.io/fastcall-issues.html" rel="alternate"></link><published>2017-02-25T00:00:00+01:00</published><updated>2017-02-25T00:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-25:/fastcall-issues.html</id><summary type="html">&lt;p&gt;Here is the raw list of the 46 CPython issues I opended between 2016-04-21 and
2017-02-10 to implement my FASTCALL optimization. Most issues created in 2016
are already part of Python 3.6.0, some are already merged into the future
Python 3.7, the few remaining issues are still …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Here is the raw list of the 46 CPython issues I opended between 2016-04-21 and
2017-02-10 to implement my FASTCALL optimization. Most issues created in 2016
are already part of Python 3.6.0, some are already merged into the future
Python 3.7, the few remaining issues are still open.&lt;/p&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;27 FASTCALL issues&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2016-04-21: &lt;a class="reference external" href="http://bugs.python.org/issue26814"&gt;[WIP] Add a new _PyObject_FastCall() function which avoids the creation of a tuple or dict for arguments&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-05-26: &lt;a class="reference external" href="http://bugs.python.org/issue27128"&gt;Add _PyObject_FastCall()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-08-20: &lt;a class="reference external" href="http://bugs.python.org/issue27809"&gt;Add _PyFunction_FastCallDict(): fast call with keyword arguments as a dict&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-08-20: &lt;a class="reference external" href="http://bugs.python.org/issue27810"&gt;Add METH_FASTCALL: new calling convention for C functions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-08-22: &lt;a class="reference external" href="http://bugs.python.org/issue27830"&gt;Add _PyObject_FastCallKeywords(): avoid the creation of a temporary dictionary for keyword arguments&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-08-23: &lt;a class="reference external" href="http://bugs.python.org/issue27840"&gt;functools.partial: don't copy keywoard arguments in partial_call()?&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2016-08-23: &lt;a class="reference external" href="http://bugs.python.org/issue27841"&gt;Use fast call in method_call() and slot_tp_new()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-08-23: &lt;a class="reference external" href="http://bugs.python.org/issue27845"&gt;Optimize update_keyword_args() function&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-11-22: &lt;a class="reference external" href="http://bugs.python.org/issue28770"&gt;Update python-gdb.py for fastcalls&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-11-30: &lt;a class="reference external" href="http://bugs.python.org/issue28839"&gt;_PyFunction_FastCallDict(): replace PyTuple_New() with PyMem_Malloc()&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2016-12-02: &lt;a class="reference external" href="http://bugs.python.org/issue28855"&gt;Compiler warnings in _PyObject_CallArg1()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-12-02: &lt;a class="reference external" href="http://bugs.python.org/issue28858"&gt;Fastcall uses more C stack&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-12-09: &lt;a class="reference external" href="http://bugs.python.org/issue28915"&gt;Modify PyObject_CallFunction() to use fast call internally&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-10: &lt;a class="reference external" href="http://bugs.python.org/issue29227"&gt;Reduce C stack consumption in function calls&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-10: &lt;a class="reference external" href="http://bugs.python.org/issue29233"&gt;call_method(): call _PyObject_FastCall() rather than _PyObject_VaCallFunctionObjArgs()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-11: &lt;a class="reference external" href="http://bugs.python.org/issue29234"&gt;Disable inlining of _PyStack_AsTuple() to reduce the stack consumption&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-13: &lt;a class="reference external" href="http://bugs.python.org/issue29259"&gt;Add tp_fastcall to PyTypeObject: support FASTCALL calling convention for all callable objects&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2017-01-13: &lt;a class="reference external" href="http://bugs.python.org/issue29263"&gt;Implement LOAD_METHOD/CALL_METHOD for C functions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-18: &lt;a class="reference external" href="http://bugs.python.org/issue29306"&gt;Check usage of Py_EnterRecursiveCall() and Py_LeaveRecursiveCall() in new FASTCALL functions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-19: &lt;a class="reference external" href="http://bugs.python.org/issue29318"&gt;Optimize _PyFunction_FastCallDict() for **kwargs&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2017-01-24: &lt;a class="reference external" href="http://bugs.python.org/issue29358"&gt;Add tp_fastnew and tp_fastinit to PyTypeObject, 15-20% faster object instanciation&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2017-01-24: &lt;a class="reference external" href="http://bugs.python.org/issue29360"&gt;_PyStack_AsDict(): Don't check if all keys are strings nor if keys are unique&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-25: &lt;a class="reference external" href="http://bugs.python.org/issue29367"&gt;python-gdb: display wrapper_call()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-02-05: &lt;a class="reference external" href="http://bugs.python.org/issue29451"&gt;Use _PyArg_Parser for _PyArg_ParseStack(): support positional only arguments&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-02-06: &lt;a class="reference external" href="http://bugs.python.org/issue29465"&gt;Modify _PyObject_FastCall() to reduce stack consumption&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-02-09: &lt;a class="reference external" href="http://bugs.python.org/issue29507"&gt;Use FASTCALL in call_method() to avoid temporary tuple&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-02-10: &lt;a class="reference external" href="http://bugs.python.org/issue29524"&gt;Move functions to call objects into a new Objects/call.c file&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="issues-converting-functions-to-fastcall"&gt;
&lt;h2&gt;3 issues converting functions to FASTCALL&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2017-01-16: &lt;a class="reference external" href="http://bugs.python.org/issue29286"&gt;Use METH_FASTCALL in str methods&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-18: &lt;a class="reference external" href="http://bugs.python.org/issue29312"&gt;Use FASTCALL in dict.update()&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2017-02-05: &lt;a class="reference external" href="http://bugs.python.org/issue29452"&gt;Use FASTCALL for collections.deque methods: index, insert, rotate&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="argument-clinic-issues"&gt;
&lt;h2&gt;6 Argument Clinic issues&lt;/h2&gt;
&lt;p&gt;Converting code to Argument Clinic converts METH_VARARGS methods to
METH_FASTCALL.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2017-01-16: &lt;a class="reference external" href="http://bugs.python.org/issue29289"&gt;Convert OrderedDict methods to Argument Clinic&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-17: &lt;a class="reference external" href="http://bugs.python.org/issue29299"&gt;Argument Clinic: Fix signature of optional positional-only arguments&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-17: &lt;a class="reference external" href="http://bugs.python.org/issue29300"&gt;Modify the _struct module to use FASTCALL and Argument Clinic&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-17: &lt;a class="reference external" href="http://bugs.python.org/issue29301"&gt;decimal: Use FASTCALL and/or Argument Clinic&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-01-18: &lt;a class="reference external" href="http://bugs.python.org/issue29311"&gt;Argument Clinic: convert dict methods&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-02-02: &lt;a class="reference external" href="http://bugs.python.org/issue29419"&gt;Argument Clinic: inline PyArg_UnpackTuple and PyArg_ParseStack(AndKeyword)?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="other-optimization-issues"&gt;
&lt;h2&gt;10 other optimization issues&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;2016-08-24: &lt;a class="reference external" href="http://bugs.python.org/issue27848"&gt;C function calls: use Py_ssize_t rather than C int for number of arguments&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-09-07: &lt;a class="reference external" href="http://bugs.python.org/issue28004"&gt;Optimize bytes.join(sequence)&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2016-11-05: &lt;a class="reference external" href="http://bugs.python.org/issue28618"&gt;Decorate hot functions using __attribute__((hot)) to optimize Python&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-11-07: &lt;a class="reference external" href="http://bugs.python.org/issue28637"&gt;Python startup performance regression&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-11-25: &lt;a class="reference external" href="http://bugs.python.org/issue28800"&gt;Add RETURN_NONE bytecode instruction&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2016-11-25: &lt;a class="reference external" href="http://bugs.python.org/issue28799"&gt;Drop CALL_PROFILE special build?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2016-12-09: &lt;a class="reference external" href="http://bugs.python.org/issue28924"&gt;Inline PyEval_EvalFrameEx() in callers&lt;/a&gt; [&lt;strong&gt;REJECTED&lt;/strong&gt;]&lt;/li&gt;
&lt;li&gt;2016-12-15: &lt;a class="reference external" href="http://bugs.python.org/issue28977"&gt;Document PyObject_CallFunction() special case more explicitly&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-02-06: &lt;a class="reference external" href="http://bugs.python.org/issue29461"&gt;Experiment usage of likely/unlikely in CPython core&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;2017-02-08: &lt;a class="reference external" href="http://bugs.python.org/issue29502"&gt;Should PyObject_Call() call the profiler on C functions, use C_TRACE() macro?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="fastcall"></category><category term="optimization"></category><category term="cpython"></category></entry><entry><title>FASTCALL microbenchmarks</title><link href="https://vstinner.github.io/fastcall-microbenchmarks.html" rel="alternate"></link><published>2017-02-24T22:00:00+01:00</published><updated>2017-02-24T22:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-24:/fastcall-microbenchmarks.html</id><summary type="html">&lt;p&gt;For my FASTCALL project (CPython optimization avoiding temporary tuples and
dictionaries to pass arguments), I wrote many short microbenchmarks. I grouped
them into a new Git repository: &lt;a class="reference external" href="https://github.com/vstinner/pymicrobench"&gt;pymicrobench&lt;/a&gt;.  Benchmark results are required by
CPython developers to prove that an optimization is worth it. It's not uncommon
that I abandon a …&lt;/p&gt;</summary><content type="html">&lt;p&gt;For my FASTCALL project (CPython optimization avoiding temporary tuples and
dictionaries to pass arguments), I wrote many short microbenchmarks. I grouped
them into a new Git repository: &lt;a class="reference external" href="https://github.com/vstinner/pymicrobench"&gt;pymicrobench&lt;/a&gt;.  Benchmark results are required by
CPython developers to prove that an optimization is worth it. It's not uncommon
that I abandon a change because the speedup is not significant, makes CPython
slower, or because the change is too complex. Last 12 months, I counted that I
abandonned 9 optimization issues, rejected for different reasons, on a total of
46 optimization issues.&lt;/p&gt;
&lt;p&gt;This article gives Python 3.7 results of these microbenchmarks compared to
Python 3.5 (before FASTCALL). I ignored 3 microbenchmarks which are between 2%
and 5% slower: the code was not optimized and the result is not signifiant
(less than 10% on a &lt;em&gt;microbenchmark&lt;/em&gt; is not significant).&lt;/p&gt;
&lt;p&gt;On results below, the speedup is between 1.11x faster (-10%) and 1.92x faster
(-48%). It's not easy to isolate the speedup of only FASTCALL. Since Python
3.5, Python 3.7 got many other optimizations.&lt;/p&gt;
&lt;p&gt;Using FASTCALL gives a speedup around 20 ns: measured on a patch to use
FASTCALL.  It's not a lot, but many builtin functions take less than 100 ns, so
20 ns is significant in practice! Avoiding a tuple to pass positional arguments
is interesting, but FASTCALL also allows further internal optimizations.&lt;/p&gt;
&lt;p&gt;Microbenchmark on calling builtin functions:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="53%" /&gt;
&lt;col width="11%" /&gt;
&lt;col width="36%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Benchmark&lt;/th&gt;
&lt;th class="head"&gt;3.5&lt;/th&gt;
&lt;th class="head"&gt;3.7&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;struct.pack(&amp;quot;i&amp;quot;, 1)&lt;/td&gt;
&lt;td&gt;105 ns&lt;/td&gt;
&lt;td&gt;77.6 ns: 1.36x faster (-26%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;getattr(1, &amp;quot;real&amp;quot;)&lt;/td&gt;
&lt;td&gt;79.4 ns&lt;/td&gt;
&lt;td&gt;64.4 ns: 1.23x faster (-19%)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Microbenchmark on calling methods of builtin types:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="53%" /&gt;
&lt;col width="11%" /&gt;
&lt;col width="36%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Benchmark&lt;/th&gt;
&lt;th class="head"&gt;3.5&lt;/th&gt;
&lt;th class="head"&gt;3.7&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;{1: 2}.get(7, None)&lt;/td&gt;
&lt;td&gt;84.9 ns&lt;/td&gt;
&lt;td&gt;61.6 ns: 1.38x faster (-27%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;collections.deque([None]).index(None)&lt;/td&gt;
&lt;td&gt;116 ns&lt;/td&gt;
&lt;td&gt;87.0 ns: 1.33x faster (-25%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;{1: 2}.get(1)&lt;/td&gt;
&lt;td&gt;79.4 ns&lt;/td&gt;
&lt;td&gt;59.6 ns: 1.33x faster (-25%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&amp;quot;a&amp;quot;.replace(&amp;quot;x&amp;quot;, &amp;quot;y&amp;quot;)&lt;/td&gt;
&lt;td&gt;134 ns&lt;/td&gt;
&lt;td&gt;101 ns: 1.33x faster (-25%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;b&amp;quot;&amp;quot;.decode()&lt;/td&gt;
&lt;td&gt;71.5 ns&lt;/td&gt;
&lt;td&gt;54.5 ns: 1.31x faster (-24%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;b&amp;quot;&amp;quot;.decode(&amp;quot;ascii&amp;quot;)&lt;/td&gt;
&lt;td&gt;99.1 ns&lt;/td&gt;
&lt;td&gt;75.7 ns: 1.31x faster (-24%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;collections.deque.rotate(1)&lt;/td&gt;
&lt;td&gt;106 ns&lt;/td&gt;
&lt;td&gt;82.8 ns: 1.28x faster (-22%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;collections.deque.insert()&lt;/td&gt;
&lt;td&gt;778 ns&lt;/td&gt;
&lt;td&gt;608 ns: 1.28x faster (-22%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;b&amp;quot;&amp;quot;.join((b&amp;quot;hello&amp;quot;, b&amp;quot;world&amp;quot;) * 100)&lt;/td&gt;
&lt;td&gt;4.02 us&lt;/td&gt;
&lt;td&gt;3.32 us: 1.21x faster (-17%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;[0].count(0)&lt;/td&gt;
&lt;td&gt;53.9 ns&lt;/td&gt;
&lt;td&gt;46.3 ns: 1.16x faster (-14%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;collections.deque.rotate()&lt;/td&gt;
&lt;td&gt;72.6 ns&lt;/td&gt;
&lt;td&gt;63.1 ns: 1.15x faster (-13%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;b&amp;quot;&amp;quot;.join((b&amp;quot;hello&amp;quot;, b&amp;quot;world&amp;quot;))&lt;/td&gt;
&lt;td&gt;102 ns&lt;/td&gt;
&lt;td&gt;89.8 ns: 1.13x faster (-12%)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Microbenchmark on builtin functions calling Python functions (callbacks):&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="53%" /&gt;
&lt;col width="11%" /&gt;
&lt;col width="36%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Benchmark&lt;/th&gt;
&lt;th class="head"&gt;3.5&lt;/th&gt;
&lt;th class="head"&gt;3.7&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;map(lambda x: x, list(range(1000)))&lt;/td&gt;
&lt;td&gt;76.1 us&lt;/td&gt;
&lt;td&gt;61.1 us: 1.25x faster (-20%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;sorted(list(range(1000)), key=lambda x: x)&lt;/td&gt;
&lt;td&gt;90.2 us&lt;/td&gt;
&lt;td&gt;78.2 us: 1.15x faster (-13%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;filter(lambda x: x, list(range(1000)))&lt;/td&gt;
&lt;td&gt;81.8 us&lt;/td&gt;
&lt;td&gt;73.4 us: 1.11x faster (-10%)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Microbenchmark on calling slots (&lt;tt class="docutils literal"&gt;__getitem__&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;__init__&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;__int__&lt;/tt&gt;)
implemented in Python:&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="53%" /&gt;
&lt;col width="11%" /&gt;
&lt;col width="36%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Benchmark&lt;/th&gt;
&lt;th class="head"&gt;3.5&lt;/th&gt;
&lt;th class="head"&gt;3.7&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;Python __getitem__: obj[0]&lt;/td&gt;
&lt;td&gt;167 ns&lt;/td&gt;
&lt;td&gt;87.0 ns: 1.92x faster (-48%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;call_pyinit_kw1&lt;/td&gt;
&lt;td&gt;348 ns&lt;/td&gt;
&lt;td&gt;240 ns: 1.45x faster (-31%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;call_pyinit_kw5&lt;/td&gt;
&lt;td&gt;564 ns&lt;/td&gt;
&lt;td&gt;401 ns: 1.41x faster (-29%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;call_pyinit_kw10&lt;/td&gt;
&lt;td&gt;960 ns&lt;/td&gt;
&lt;td&gt;734 ns: 1.31x faster (-24%)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;Python __int__: int(obj)&lt;/td&gt;
&lt;td&gt;241 ns&lt;/td&gt;
&lt;td&gt;207 ns: 1.16x faster (-14%)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Microbenchmark on calling a method descriptor (static method):&lt;/p&gt;
&lt;table border="1" class="docutils"&gt;
&lt;colgroup&gt;
&lt;col width="53%" /&gt;
&lt;col width="11%" /&gt;
&lt;col width="36%" /&gt;
&lt;/colgroup&gt;
&lt;thead valign="bottom"&gt;
&lt;tr&gt;&lt;th class="head"&gt;Benchmark&lt;/th&gt;
&lt;th class="head"&gt;3.5&lt;/th&gt;
&lt;th class="head"&gt;3.7&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody valign="top"&gt;
&lt;tr&gt;&lt;td&gt;int.to_bytes(1, 4, &amp;quot;little&amp;quot;)&lt;/td&gt;
&lt;td&gt;177 ns&lt;/td&gt;
&lt;td&gt;103 ns: 1.72x faster (-42%)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Benchmarks were run on &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;speed-python&lt;/span&gt;&lt;/tt&gt;, server used to run CPython benchmarks.&lt;/p&gt;
</content><category term="python"></category><category term="fastcall"></category><category term="optimization"></category><category term="cpython"></category></entry><entry><title>The start of the FASTCALL project</title><link href="https://vstinner.github.io/start-fastcall-project.html" rel="alternate"></link><published>2017-02-16T17:00:00+01:00</published><updated>2017-02-16T17:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-16:/start-fastcall-project.html</id><summary type="html">&lt;div class="section" id="false-start"&gt;
&lt;h2&gt;False start&lt;/h2&gt;
&lt;p&gt;In April 2016, I experimented a Python change to avoid temporary tuple to call
functions. Builtin functions were between 20 and 50% faster!&lt;/p&gt;
&lt;p&gt;Sadly, some benchmarks were randomy slower. It will take me four months to
understand why!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="work-on-benchmarks"&gt;
&lt;h2&gt;Work on benchmarks&lt;/h2&gt;
&lt;p&gt;During four months, I worked on making …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;div class="section" id="false-start"&gt;
&lt;h2&gt;False start&lt;/h2&gt;
&lt;p&gt;In April 2016, I experimented a Python change to avoid temporary tuple to call
functions. Builtin functions were between 20 and 50% faster!&lt;/p&gt;
&lt;p&gt;Sadly, some benchmarks were randomy slower. It will take me four months to
understand why!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="work-on-benchmarks"&gt;
&lt;h2&gt;Work on benchmarks&lt;/h2&gt;
&lt;p&gt;During four months, I worked on making benchmarks more stable. See my previous
blog posts:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-system.html"&gt;My journey to stable benchmark, part 1 (system)&lt;/a&gt; (May 21, 2016)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-deadcode.html"&gt;My journey to stable benchmark, part 2 (deadcode)&lt;/a&gt; (May 22, 2016)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-average.html"&gt;My journey to stable benchmark, part 3 (average)&lt;/a&gt; (May 23, 2016)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/perf-visualize-system-noise-with-cpu-isolation.html"&gt;Visualize the system noise using perf and CPU isolation&lt;/a&gt; (June 16, 2016)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/intel-cpus.html"&gt;Intel CPUs: P-state, C-state, Turbo Boost, CPU frequency, etc.&lt;/a&gt; (July 15, 2015)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/intel-cpus-part2.html"&gt;Intel CPUs (part 2): Turbo Boost, temperature, frequency and Pstate C0 bug&lt;/a&gt;
(September 23, 2016)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vstinner.github.io/analysis-python-performance-issue.html"&gt;Analysis of a Python performance issue&lt;/a&gt;
(November 19, 2016)&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;See my talk &lt;a class="reference external" href="https://fosdem.org/2017/schedule/event/python_stable_benchmark/"&gt;How to run a stable benchmark&lt;/a&gt; that I gave
at FOSDEM 2017 (Brussels, Belgium): slides + video. I listed all the issues
that I had to get reliable benchmarks.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="ask-for-permission"&gt;
&lt;h2&gt;Ask for permission&lt;/h2&gt;
&lt;p&gt;August 2016, I
confirmed that my change didn't introduce any slowndown. So I asked for the
permission on the python-dev mailing list to start pushing changes: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-August/145793.html"&gt;New
calling convention to avoid temporarily tuples when calling functions&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Guido van Rossum asked me for benchmark results:&lt;/p&gt;
&lt;blockquote&gt;
But is there a performance improvement?&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="benchmark-results"&gt;
&lt;h2&gt;Benchmark results&lt;/h2&gt;
&lt;p&gt;On micro-benchmarks, FASTCALL is much faster:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;getattr(1, &amp;quot;real&amp;quot;)&lt;/tt&gt; becomes &lt;strong&gt;44%&lt;/strong&gt; faster&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;list(filter(lambda x: x, &lt;span class="pre"&gt;list(range(1000))))&lt;/span&gt;&lt;/tt&gt; becomes &lt;strong&gt;31%&lt;/strong&gt; faster&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;namedtuple.attr&lt;/tt&gt; (read the attribute) becomes &lt;strong&gt;23%&lt;/strong&gt; faster&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Full results:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue26814#msg263999"&gt;FASTCALL compared to Python 3.6 (default branch)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://bugs.python.org/issue26814#msg264003"&gt;2.7 / 3.4 / 3.5 / 3.6 / 3.6 FASTCALL comparison&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;On the &lt;a class="reference external" href="https://bugs.python.org/issue26814#msg266359"&gt;CPython benchmark suite&lt;/a&gt;, I also saw many faster
benchmarks:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;pickle_list: &lt;strong&gt;1.29x faster&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;etree_generate: &lt;strong&gt;1.22x faster&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;pickle_dict: &lt;strong&gt;1.19x faster&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;etree_process: &lt;strong&gt;1.16x faster&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;mako_v2: &lt;strong&gt;1.13x faster&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;telco: &lt;strong&gt;1.09x faster&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="replies-to-my-email"&gt;
&lt;h2&gt;Replies to my email&lt;/h2&gt;
&lt;p&gt;I got two very positive replies, so I understood that it was ok.&lt;/p&gt;
&lt;p&gt;Brett Canon:&lt;/p&gt;
&lt;blockquote&gt;
I just wanted to say I'm excited about this and I'm glad someone is taking
advantage of what Argument Clinic allows for and what I know Larry had
initially hoped AC would make happen!&lt;/blockquote&gt;
&lt;p&gt;Yury Selivanov:&lt;/p&gt;
&lt;blockquote&gt;
Exceptional results, congrats Victor. Will be happy to help with code
review.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="real-start"&gt;
&lt;h2&gt;Real start&lt;/h2&gt;
&lt;p&gt;That's how the FASTCALL began for real! I started to push a long serie of
patches adding new private functions and then modify code to call these new
functions.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="fastcall"></category><category term="optimization"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2016 Q4</title><link href="https://vstinner.github.io/contrib-cpython-2016q4.html" rel="alternate"></link><published>2017-02-16T11:00:00+01:00</published><updated>2017-02-16T11:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-16:/contrib-cpython-2016q4.html</id><summary type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2016 Q4
(october, november, december):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2016-10-01&amp;quot;):date(&amp;quot;2016-12-31&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 105 non-merge commits + 31 merge commits (total: 136 commits).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q3.html"&gt;My contributions to CPython during 2016 Q3&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q1.html"&gt;My contributions to
CPython during 2017 Q1&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Table of …&lt;/p&gt;</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2016 Q4
(october, november, december):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2016-10-01&amp;quot;):date(&amp;quot;2016-12-31&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 105 non-merge commits + 31 merge commits (total: 136 commits).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q3.html"&gt;My contributions to CPython during 2016 Q3&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q1.html"&gt;My contributions to
CPython during 2017 Q1&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Table of Contents:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Python startup performance regression&lt;/li&gt;
&lt;li&gt;Optimizations&lt;/li&gt;
&lt;li&gt;Code placement and __attribute__((hot))&lt;/li&gt;
&lt;li&gt;Interesting bug: duplicated filters when tests reload the warnings module&lt;/li&gt;
&lt;li&gt;Contributions&lt;/li&gt;
&lt;li&gt;regrtest&lt;/li&gt;
&lt;li&gt;Other changes&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="python-startup-performance-regression"&gt;
&lt;h2&gt;Python startup performance regression&lt;/h2&gt;
&lt;div class="section" id="regresion"&gt;
&lt;h3&gt;Regresion&lt;/h3&gt;
&lt;p&gt;My work on tracking Python performances started to become useful :-) I
identified a performance slowdown on the &lt;tt class="docutils literal"&gt;bm_python_startup&lt;/tt&gt; benchmark
(average time to start Python).&lt;/p&gt;
&lt;p&gt;Before September 2016, the start took around &lt;strong&gt;17.9 ms&lt;/strong&gt;. At September 15,
after the  &lt;a class="reference external" href="https://vstinner.github.io/cpython-sprint-2016.html"&gt;CPython sprint&lt;/a&gt;, it was
better: &lt;strong&gt;13.4 ms&lt;/strong&gt;. But suddenly, at september 19, it became much worse:
&lt;strong&gt;22.8 ms&lt;/strong&gt;. What happened?&lt;/p&gt;
&lt;p&gt;Timeline of Python startup performance on speed.python.org:&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://speed.python.org/timeline/#/?exe=5&amp;amp;ben=python_startup&amp;amp;env=1&amp;amp;revs=50&amp;amp;equid=off&amp;amp;quarts=on&amp;amp;extr=on"&gt;&lt;img alt="Timeline of Python startup performance" src="https://vstinner.github.io/images/python_startup_regression.png" /&gt;&lt;/a&gt;
&lt;p&gt;I looked at commits between September 15 and September 19, and I quickly
identified the commit of the &lt;a class="reference external" href="http://bugs.python.org/issue28082"&gt;convert re flags to (much
friendlier) IntFlag constants (issue #28082)&lt;/a&gt;. The &lt;tt class="docutils literal"&gt;re&lt;/tt&gt; module now imports the
&lt;tt class="docutils literal"&gt;enum&lt;/tt&gt; module to get a better representation for their flags.  Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ ./python
Python 3.7.0a0
&amp;gt;&amp;gt;&amp;gt; import re; re.M
&amp;lt;RegexFlag.MULTILINE: 8&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="revert"&gt;
&lt;h3&gt;Revert&lt;/h3&gt;
&lt;p&gt;At November 7, I opened the issue #28637 to propose to revert the commit to get
back better Python startup performance. The revert was approved by Guido van
Rossum, so I pushed it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="better-fix"&gt;
&lt;h3&gt;Better fix&lt;/h3&gt;
&lt;p&gt;I also noticed that the &lt;tt class="docutils literal"&gt;re&lt;/tt&gt; module is not imported by default if Python is
installed or if Python is run from its source code directory. The &lt;tt class="docutils literal"&gt;re&lt;/tt&gt; module
is only imported by default if Python is installed in a virtual environment.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Serhiy Storchaka&lt;/strong&gt; proposed a change to not import &lt;tt class="docutils literal"&gt;re&lt;/tt&gt; anymore in the
&lt;tt class="docutils literal"&gt;site&lt;/tt&gt; module when Python runs into a virutal environment. Since the benefit
was obvious (avoid an import at startup) and simple, it was quickly merged.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="restore-reverted-enum-change"&gt;
&lt;h3&gt;Restore reverted enum change&lt;/h3&gt;
&lt;p&gt;Since using &lt;tt class="docutils literal"&gt;enum&lt;/tt&gt; in &lt;tt class="docutils literal"&gt;re&lt;/tt&gt; has no more impact on Python startup
performance by default, the &lt;tt class="docutils literal"&gt;enum&lt;/tt&gt; change was restored at November 14.&lt;/p&gt;
&lt;p&gt;Sadly, the &lt;tt class="docutils literal"&gt;enum&lt;/tt&gt; change still have an impact on performance:
&lt;tt class="docutils literal"&gt;re.compile()&lt;/tt&gt; became 1.2x slower (312 ms =&amp;gt; 376 ms: +20%).&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://speed.python.org/timeline/#/?exe=5&amp;amp;ben=regex_compile&amp;amp;env=1&amp;amp;revs=50&amp;amp;equid=off&amp;amp;quarts=on&amp;amp;extr=on"&gt;&lt;img alt="Timeline of re.compile() performance" src="https://vstinner.github.io/images/regex_compile_perf.png" /&gt;&lt;/a&gt;
&lt;p&gt;I think that it's ok since it is very easy to use precompiled regular
expressions in an application: store and reuse the result of &lt;tt class="docutils literal"&gt;re.compile()&lt;/tt&gt;,
instead of calling directly &lt;tt class="docutils literal"&gt;re.match()&lt;/tt&gt; for example.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="optimizations"&gt;
&lt;h2&gt;Optimizations&lt;/h2&gt;
&lt;div class="section" id="fastcall"&gt;
&lt;h3&gt;FASTCALL&lt;/h3&gt;
&lt;p&gt;Same than 2016 Q3: I pushed a &lt;em&gt;lot&lt;/em&gt; of changes for FASTCALL optimizations, but
I will write a dedicated article later.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="no-int-int-micro-optimization-thank-you"&gt;
&lt;h3&gt;No int+int micro-optimization, thank you&lt;/h3&gt;
&lt;p&gt;After 2 years of benchmarking and a huge effort of making Python benchmarks more
reliable and stable, I decided to close the issue #21955 &amp;quot;ceval.c: implement
fast path for integers with a single digit&amp;quot; as REJECTED. It became clear to me
that such micro-optimization has no effect on non-trivial code, but only on
specially crafted micro-benchmarks. I added a comment in the C code to prevent
further optimizations attempts:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/* NOTE(haypo): Please don't try to micro-optimize int+int on
   CPython using bytecode, it is simply worthless.
   See http://bugs.python.org/issue21955 and
   http://bugs.python.org/issue10044 for the discussion. In short,
   no patch shown any impact on a realistic benchmark, only a minor
   speedup on microbenchmarks. */
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="timeit"&gt;
&lt;h3&gt;timeit&lt;/h3&gt;
&lt;p&gt;I enhanced the &lt;tt class="docutils literal"&gt;timeit&lt;/tt&gt; benchmark module to make it more reliable (issue
#28240):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Autorange now starts with a single loop iteration instead of 10. For example,
&lt;tt class="docutils literal"&gt;python3 &lt;span class="pre"&gt;-m&lt;/span&gt; timeit &lt;span class="pre"&gt;-s&lt;/span&gt; 'import time' 'time.sleep(1)'&lt;/tt&gt; now only takes 4
seconds instead of 40 seconds.&lt;/li&gt;
&lt;li&gt;Repeat the benchmarks 5 times by default, instead of only 3, to make
benchmarks more reliable.&lt;/li&gt;
&lt;li&gt;Remove &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-c/--clock&lt;/span&gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-t/--time&lt;/span&gt;&lt;/tt&gt; command line options which were
deprecated since Python 3.3.&lt;/li&gt;
&lt;li&gt;Add &lt;tt class="docutils literal"&gt;nsec&lt;/tt&gt; (nanosecond) unit to format timings&lt;/li&gt;
&lt;li&gt;Enhance formatting of raw timings in verbose mode. Add newlines to the output
for readability.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="micro-optimizations"&gt;
&lt;h3&gt;Micro-optimizations&lt;/h3&gt;
&lt;p&gt;I also pushed two minor micro-optimizations:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Use &lt;tt class="docutils literal"&gt;PyThreadState_GET()&lt;/tt&gt; macro in performance critical code.
&lt;tt class="docutils literal"&gt;_PyThreadState_UncheckedGet()&lt;/tt&gt; calls are not inlined as expected, even
when using &lt;tt class="docutils literal"&gt;gcc &lt;span class="pre"&gt;-O3&lt;/span&gt;&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Modify &lt;tt class="docutils literal"&gt;type_setattro()&lt;/tt&gt; to call directly
&lt;tt class="docutils literal"&gt;_PyObject_GenericSetAttrWithDict()&lt;/tt&gt; instead of
&lt;tt class="docutils literal"&gt;PyObject_GenericSetAttr()&lt;/tt&gt;. &lt;tt class="docutils literal"&gt;PyObject_GenericSetAttr()&lt;/tt&gt; is a thin
wrapper to &lt;tt class="docutils literal"&gt;_PyObject_GenericSetAttrWithDict()&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="code-placement-and-attribute-hot"&gt;
&lt;h2&gt;Code placement and __attribute__((hot))&lt;/h2&gt;
&lt;p&gt;On &lt;a class="reference external" href="https://speed.python.org/"&gt;speed.python.org&lt;/a&gt;, I still noticed random
performance slowdowns on the evil &lt;tt class="docutils literal"&gt;call_simple&lt;/tt&gt; benchmark. This benchmark is
a &lt;em&gt;micro&lt;/em&gt;-benchmark measuring the performance of a single Python function call,
it is CPU-bound and very small and so impact by CPU caches. I was bitten again
by significant performance slowdown only caused by code placement.&lt;/p&gt;
&lt;p&gt;It wasn't possible to use &lt;em&gt;Profiled Guided Optimization&lt;/em&gt; (PGO) on the benchmark
runner, since it used Ubuntu 14.04 and GCC crashed with an &amp;quot;internal error&amp;quot;.&lt;/p&gt;
&lt;p&gt;So I tried something different: mark &amp;quot;hot functions&amp;quot; with
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;__attribute__((hot))&lt;/span&gt;&lt;/tt&gt;. It's a GCC and Clang attribute helping code
placements: &amp;quot;hot functions&amp;quot; are moved to a dedicated ELF section and so are
closer in memory, and the compiler tries to optimize these functions even more.&lt;/p&gt;
&lt;p&gt;The following functions are considered as hot according to statistics collected
by Linux &lt;tt class="docutils literal"&gt;perf record&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;perf report&lt;/tt&gt; commands:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;_PyEval_EvalFrameDefault()&lt;/li&gt;
&lt;li&gt;call_function()&lt;/li&gt;
&lt;li&gt;_PyFunction_FastCall()&lt;/li&gt;
&lt;li&gt;PyFrame_New()&lt;/li&gt;
&lt;li&gt;frame_dealloc()&lt;/li&gt;
&lt;li&gt;PyErr_Occurred()&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I added a &lt;tt class="docutils literal"&gt;_Py_HOT_FUNCTION&lt;/tt&gt; macro which uses &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;__attribute__((hot))&lt;/span&gt;&lt;/tt&gt; and
used &lt;tt class="docutils literal"&gt;_Py_HOT_FUNCTION&lt;/tt&gt; on these functions (issue #28618).&lt;/p&gt;
&lt;p&gt;Read also my previous blog article &lt;a class="reference external" href="https://vstinner.github.io/analysis-python-performance-issue.html"&gt;Analysis of a Python performance issue&lt;/a&gt; for a deeper analysis.&lt;/p&gt;
&lt;p&gt;Sadly, after I wrote this blog post and after more analysis of &lt;tt class="docutils literal"&gt;call_simple&lt;/tt&gt;
benchmark results, I saw that &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;__attribute__((hot))&lt;/span&gt;&lt;/tt&gt; wasn't enough. I still
had random major performance slowdown.&lt;/p&gt;
&lt;p&gt;I dediced to upgrade the performance runner to Ubuntu 16.04. It was dangerous
because nobody has access to the physical server, so it may takes weeks to
repair it if I did a mistake. Hopefully, the upgrade gone smoothly and I was
able to run again all benchmarks using PGO. As expected, using PGO+LTO,
benchmark results are more stable!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="interesting-bug-duplicated-filters-when-tests-reload-the-warnings-module"&gt;
&lt;h2&gt;Interesting bug: duplicated filters when tests reload the warnings module&lt;/h2&gt;
&lt;p&gt;Python test suite has an old bug: the issue #18383 opened in July 2013.
Sometimes, the test suite emits the following warning:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
[247/375] test_warnings
Warning -- warnings.filters was modified by test_warnings
&lt;/pre&gt;
&lt;p&gt;Since it's only a warning and it only occurs in the Python test suite, it was a
low priority and took 3 years to be fixed! It also took time to find the right
design to fix the root cause.&lt;/p&gt;
&lt;div class="section" id="duplicated-filters"&gt;
&lt;h3&gt;Duplicated filters&lt;/h3&gt;
&lt;p&gt;test_warnings imports the &lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; module 3 times:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
import warnings as original_warnings   # Python
py_warnings = support.import_fresh_module('warnings', blocked=['_warnings'])  # Python
c_warnings = support.import_fresh_module('warnings', fresh=['_warnings'])   # C
&lt;/pre&gt;
&lt;p&gt;The Python &lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; module (&lt;tt class="docutils literal"&gt;Lib/warnings.py&lt;/tt&gt;) installs warning filters
when the module is loaded:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
_processoptions(sys.warnoptions)
&lt;/pre&gt;
&lt;p&gt;where &lt;tt class="docutils literal"&gt;sys.warnoptions&lt;/tt&gt; contains the value of the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-W&lt;/span&gt;&lt;/tt&gt; command line option.&lt;/p&gt;
&lt;p&gt;If the Python module is loaded more than once, filters are duplicated.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="first-fix-use-the-right-module"&gt;
&lt;h3&gt;First fix: use the right module&lt;/h3&gt;
&lt;p&gt;I pushed a first fix in september 2015.&lt;/p&gt;
&lt;p&gt;Fix test_warnings: don't modify warnings.filters. BaseTest now ensures that
unittest.TestCase.assertWarns() uses the same warnings module than
warnings.catch_warnings(). Otherwise, warnings.catch_warnings() will be unable
to remove the added filter.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="second-fix-don-t-add-duplicated-filters"&gt;
&lt;h3&gt;Second fix: don't add duplicated filters&lt;/h3&gt;
&lt;p&gt;Issue #18383: the first patch was proposed by &lt;strong&gt;Florent Xicluna&lt;/strong&gt; in 2013: save
the length of filters, and remove newly added filters after &lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt;
modules are reloaded by &lt;tt class="docutils literal"&gt;test_warnings&lt;/tt&gt;. December 2014, &lt;strong&gt;Serhiy Storchaka&lt;/strong&gt;
reviewed the patch: he didn't like this &lt;em&gt;workaround&lt;/em&gt;, he would like to fix the
&lt;em&gt;root cause&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;March 2015, &lt;strong&gt;Alex Shkop&lt;/strong&gt; proposed a patch which avoids to add duplicated
filters.&lt;/p&gt;
&lt;p&gt;September 2015, &lt;strong&gt;Martin Panter&lt;/strong&gt; proposed to try to save/restore filters on
the C warnings module. I proposed something similar in the issue #26742. But
this solution has the same flaw that Florent's idea: it's only a workaround.&lt;/p&gt;
&lt;p&gt;Martin also proposed add a private flag to say that filters were already set to
not try to add again same filters.&lt;/p&gt;
&lt;p&gt;Finally, in may 2016, Martin updated Alex's patch avoiding duplicated filters
and pushed it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="third-fix"&gt;
&lt;h3&gt;Third fix&lt;/h3&gt;
&lt;p&gt;The filter comparisons wasn't perfect. A filter can be made of a precompiled
regular expression, whereas these objects don't implement comparison.&lt;/p&gt;
&lt;p&gt;November 2016, I opened the issue #28727 to propose to implement rich
comparison for &lt;tt class="docutils literal"&gt;_sre.SRE_Pattern&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;My first patch didn't implement &lt;tt class="docutils literal"&gt;hash()&lt;/tt&gt; and had different bugs. It took me
almost one week and 6 versions to write complete unit tests and handle all
cases: support bytes and Unicode and handle regular expression flags.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Serhiy Storchaka&lt;/strong&gt; found bugs and helps me to write the implementation.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="contributions"&gt;
&lt;h2&gt;Contributions&lt;/h2&gt;
&lt;p&gt;As usual, I reviewed and pushed changes written by other contributors:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #27896: Allow passing sphinx options to Doc/Makefile. Patch written by
&lt;strong&gt;Julien Palard&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #28476: Reuse math.factorial() in test_random.
Patch written by &lt;strong&gt;Francisco Couzo&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #28479: Fix reST syntax in windows.rst. Patch written by &lt;strong&gt;Julien Palard&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #26273: Add new constants: &lt;tt class="docutils literal"&gt;socket.TCP_CONGESTION&lt;/tt&gt; (Linux 2.6.13) and
&lt;tt class="docutils literal"&gt;socket.TCP_USER_TIMEOUT&lt;/tt&gt; (Linux 2.6.37).
Patch written by &lt;strong&gt;Omar Sandoval&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #28979: Fix What's New in Python 3.6: compact dict is not faster, but
only more compact. Patch written by &lt;strong&gt;Brendan Donegan&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #28147: Fix a memory leak in split-table dictionaries: &lt;tt class="docutils literal"&gt;setattr()&lt;/tt&gt;
must not convert combined table into split table.
Patch written by &lt;strong&gt;INADA Naoki&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #29109: Enhance tracemalloc documentation:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Wrong parameter name, 'group_by' instead of 'key_type'&lt;/li&gt;
&lt;li&gt;Don't round up numbers when explaining the examples. If they exactly match
what can be read in the script output, it is to easier to understand
(4.8 MiB vs 4855 KiB)&lt;/li&gt;
&lt;li&gt;Fix incorrect method link that was pointing to another module&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Patch written by &lt;strong&gt;Loic Pefferkorn&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="regrtest"&gt;
&lt;h2&gt;regrtest&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;regrtest &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--fromfile&lt;/span&gt;&lt;/tt&gt; now accepts a list of filenames, not only a list of
&lt;em&gt;test&lt;/em&gt; names.&lt;/li&gt;
&lt;li&gt;Issue #28409: regrtest: fix the parser of command line arguments.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="other-changes"&gt;
&lt;h2&gt;Other changes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Fix &lt;tt class="docutils literal"&gt;_Py_normalize_encoding()&lt;/tt&gt; function: It was not exactly the same than
Python &lt;tt class="docutils literal"&gt;encodings.normalize_encoding()&lt;/tt&gt;: the C function now also converts
to lowercase.&lt;/li&gt;
&lt;li&gt;Issue #28256: Cleanup &lt;tt class="docutils literal"&gt;_math.c&lt;/tt&gt;: only define fallback implementations when
needed. It avoids producing deadcode when the system provides required math
functions, and so enhance the code coverage.&lt;/li&gt;
&lt;li&gt;_csv: use &lt;tt class="docutils literal"&gt;_PyLong_AsInt()&lt;/tt&gt; to simplify the code, the function checks for
the limits of the C &lt;tt class="docutils literal"&gt;int&lt;/tt&gt; type.&lt;/li&gt;
&lt;li&gt;Issue #28544: Fix &lt;tt class="docutils literal"&gt;_asynciomodule.c&lt;/tt&gt; on Windows. &lt;tt class="docutils literal"&gt;PyType_Ready()&lt;/tt&gt; sets
the reference to &lt;tt class="docutils literal"&gt;&amp;amp;PyType_Type&lt;/tt&gt;. &lt;tt class="docutils literal"&gt;&amp;amp;PyType_Type&lt;/tt&gt; address cannot be
resolved at compilation time (not on Windows?).&lt;/li&gt;
&lt;li&gt;Issue #28082: Add basic unit tests on the new &lt;tt class="docutils literal"&gt;re&lt;/tt&gt; enums.&lt;/li&gt;
&lt;li&gt;Issue #28691: Fix &lt;tt class="docutils literal"&gt;warn_invalid_escape_sequence()&lt;/tt&gt;: handle correctly
&lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt; raised as an exception. First clear the current
exception to replace the &lt;tt class="docutils literal"&gt;DeprecationWarning&lt;/tt&gt; exception with a
&lt;tt class="docutils literal"&gt;SyntaxError&lt;/tt&gt; exception. Unit test written by &lt;strong&gt;Serhiy Storchaka&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #28023: Fix python-gdb.py on old GDB versions. Replace
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;int(value.address)+offset&lt;/span&gt;&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;value.cast(unsigned &lt;span class="pre"&gt;char*)+offset&lt;/span&gt;&lt;/tt&gt;.
It seems like &lt;tt class="docutils literal"&gt;int(value.address)&lt;/tt&gt; fails on old GDB versions.&lt;/li&gt;
&lt;li&gt;Issue #28765: &lt;tt class="docutils literal"&gt;_sre.compile()&lt;/tt&gt; now checks the type of &lt;tt class="docutils literal"&gt;groupindex&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;indexgroup&lt;/tt&gt; arguments. &lt;tt class="docutils literal"&gt;groupindex&lt;/tt&gt; must a dictionary and &lt;tt class="docutils literal"&gt;indexgroup&lt;/tt&gt;
must be a tuple.  Previously, &lt;tt class="docutils literal"&gt;indexgroup&lt;/tt&gt; was a list. Use a tuple to
reduce the memory usage.&lt;/li&gt;
&lt;li&gt;Issue #28782: Fix a bug in the implementation &lt;tt class="docutils literal"&gt;yield from&lt;/tt&gt;
(fix &lt;tt class="docutils literal"&gt;_PyGen_yf()&lt;/tt&gt; function). Fix the test checking if the next instruction
is &lt;tt class="docutils literal"&gt;YIELD_FROM&lt;/tt&gt;.  Regression introduced by the new &amp;quot;WordCode&amp;quot; bytecode
(issue #26647). Fix reviewed by &lt;strong&gt;Serhiy Storchaka&lt;/strong&gt; and &lt;strong&gt;Yury Selivanov&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #28792: Remove aliases from &lt;tt class="docutils literal"&gt;_bisect&lt;/tt&gt;. Remove aliases from the C
module.  Always implement &lt;tt class="docutils literal"&gt;bisect()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;insort()&lt;/tt&gt; aliases in
&lt;tt class="docutils literal"&gt;bisect.py&lt;/tt&gt;.  Remove also the &lt;tt class="docutils literal"&gt;# backward compatibility&lt;/tt&gt; comment: there
is no plan to deprecate nor remove these aliases. When keys are equal, it
makes sense to use &lt;tt class="docutils literal"&gt;bisect.bisect()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;bisect.insort()&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Fix a &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; in &lt;tt class="docutils literal"&gt;generate_opcode_h.py&lt;/tt&gt;. Use a context manager
to close the Python file. Replace also &lt;tt class="docutils literal"&gt;open()&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;tokenize.open()&lt;/tt&gt; to
handle coding cookie of &lt;tt class="docutils literal"&gt;Lib/opcode.py&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Issue #28740: Add &lt;tt class="docutils literal"&gt;sys.getandroidapilevel()&lt;/tt&gt; function: return the build
time API version of Android as an integer. Function only available on
Android. The availability of this function can be tested to check if Python
is running on Android.&lt;/li&gt;
&lt;li&gt;Issue #28152: Fix &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-Wunreachable-code&lt;/span&gt;&lt;/tt&gt; warnings on Clang.&lt;ul&gt;
&lt;li&gt;Don't declare dead code when the code is compiled with Clang.&lt;/li&gt;
&lt;li&gt;Replace C &lt;tt class="docutils literal"&gt;if()&lt;/tt&gt; with precompiler &lt;tt class="docutils literal"&gt;#if&lt;/tt&gt; to fix a warning on dead code
when using Clang.&lt;/li&gt;
&lt;li&gt;Replace &lt;tt class="docutils literal"&gt;0&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;(0)&lt;/tt&gt; to ignore a compiler warning about dead code on
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;((int)(SEM_VALUE_MAX)&lt;/span&gt; &amp;lt; 0)&lt;/tt&gt;: &lt;tt class="docutils literal"&gt;SEM_VALUE_MAX&lt;/tt&gt; is not negative on Linux.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Issue #28835: Fix a regression introduced in &lt;tt class="docutils literal"&gt;warnings.catch_warnings()&lt;/tt&gt;:
call &lt;tt class="docutils literal"&gt;warnings.showwarning()&lt;/tt&gt; if it was overriden inside the context
manager.&lt;/li&gt;
&lt;li&gt;Issue #28915: Replace &lt;tt class="docutils literal"&gt;int&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;Py_ssize_t&lt;/tt&gt; in &lt;tt class="docutils literal"&gt;modsupport&lt;/tt&gt;.
&lt;tt class="docutils literal"&gt;Py_ssize_t&lt;/tt&gt; type is better for indexes. The compiler might emit more
efficient code for &lt;tt class="docutils literal"&gt;i++&lt;/tt&gt;. &lt;tt class="docutils literal"&gt;Py_ssize_t&lt;/tt&gt; is the type of a PyTuple index for
example. Replace also &lt;tt class="docutils literal"&gt;int endchar&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;char endchar&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Initialize variables to fix compiler warnings. Warnings seen on the &amp;quot;AMD64
Debian PGO 3.x&amp;quot; buildbot. Warnings are false positive, but variable
initialization should not harm performances.&lt;/li&gt;
&lt;li&gt;Remove useless variable initialization. Don't initialize variables which are
not used before they are assigned.&lt;/li&gt;
&lt;li&gt;Issue #28838: Cleanup &lt;tt class="docutils literal"&gt;abstract.h&lt;/tt&gt;. Rewrite all comments to use the same style
than other Python header files: comment functions &lt;em&gt;before&lt;/em&gt; their declaration,
no newline between the comment and the declaration. Reformat some comments,
add newlines, to make them easier to read. Quote argument like 'arg' to
mention an argument in a comment.&lt;/li&gt;
&lt;li&gt;Issue #28838: &lt;tt class="docutils literal"&gt;abstract.h&lt;/tt&gt;: remove long outdated comment. The documentation
of the Python C API is more complete and more up to date than this old
comment. Removal suggested by &lt;strong&gt;Antoine Pitrou&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;python-gdb.py: catch &lt;tt class="docutils literal"&gt;gdb.error&lt;/tt&gt; on &lt;tt class="docutils literal"&gt;gdb.selected_frame()&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Issue #28383: &lt;tt class="docutils literal"&gt;__hash__&lt;/tt&gt; documentation recommends naive XOR to combine, but
this is suboptimal. Update the documentation to suggest to reuse the
&lt;tt class="docutils literal"&gt;hash()&lt;/tt&gt; function on a tuple, with an example.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2016 Q3</title><link href="https://vstinner.github.io/contrib-cpython-2016q3.html" rel="alternate"></link><published>2017-02-14T19:00:00+01:00</published><updated>2017-02-14T19:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-14:/contrib-cpython-2016q3.html</id><summary type="html">&lt;p class="first last"&gt;My contributions to CPython during 2016 Q3&lt;/p&gt;
</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2016 Q3
(july, august, september):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2016-07-01&amp;quot;):date(&amp;quot;2016-09-30&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 161 non-merge commits + 29 merge commits (total: 190 commits).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q2.html"&gt;My contributions to CPython during 2016 Q2&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q4.html"&gt;My contributions to
CPython during 2016 Q4&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Table of Contents:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Two new core developers&lt;/li&gt;
&lt;li&gt;CPython sprint, September, in California&lt;/li&gt;
&lt;li&gt;PEP 524: Make os.urandom() blocking on Linux&lt;/li&gt;
&lt;li&gt;PEP 509: private dictionary version&lt;/li&gt;
&lt;li&gt;FASTCALL: optimization avoiding temporary tuple to call functions&lt;/li&gt;
&lt;li&gt;More efficient CALL_FUNCTION bytecode&lt;/li&gt;
&lt;li&gt;Work on optimization&lt;/li&gt;
&lt;li&gt;Interesting bug: hidden resource warnings&lt;/li&gt;
&lt;li&gt;Contributions&lt;/li&gt;
&lt;li&gt;Bugfixes&lt;/li&gt;
&lt;li&gt;regrtest changes&lt;/li&gt;
&lt;li&gt;Tests changes&lt;/li&gt;
&lt;li&gt;Other changes&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="two-new-core-developers"&gt;
&lt;h2&gt;Two new core developers&lt;/h2&gt;
&lt;p&gt;New core developers is the result of the productive third 2016 quarter.&lt;/p&gt;
&lt;p&gt;At september 25, 2016, Yury Selivanov proposed to give &lt;a class="reference external" href="https://mail.python.org/pipermail/python-committers/2016-September/004013.html"&gt;commit privileges for
INADA Naoki&lt;/a&gt;.
Naoki became a core developer the day after!&lt;/p&gt;
&lt;p&gt;At november 14, 2016, I proposed to &lt;a class="reference external" href="https://mail.python.org/pipermail/python-committers/2016-November/004045.html"&gt;promote Xiang Zhang as a core developer&lt;/a&gt;.
One week later, he also became a core developer! I mentored him during one
month, and later let him push directly changes.&lt;/p&gt;
&lt;p&gt;Most Python core developers are men coming from North America and Europe.
INADA Naoki comes from Japan and Xiang Zhang comes from China: more core
developers from Asia, we increased the diversity of Python core developers!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="cpython-sprint-september-in-california"&gt;
&lt;h2&gt;CPython sprint, September, in California&lt;/h2&gt;
&lt;p&gt;I was invited at my first CPython sprint in September! Five days, September
5-9, at Instagram office in California, USA. I reviewed a lot of changes and
pushed many new features! Read my previous blog post: &lt;a class="reference external" href="https://vstinner.github.io/cpython-sprint-2016.html"&gt;CPython sprint,
september 2016&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-524-make-os-urandom-blocking-on-linux"&gt;
&lt;h2&gt;PEP 524: Make os.urandom() blocking on Linux&lt;/h2&gt;
&lt;p&gt;I pushed the implementation my PEP 524: read my previous blog post: &lt;a class="reference external" href="https://vstinner.github.io/pep-524-os-urandom-blocking.html"&gt;PEP 524:
os.urandom() now blocks on Linux in Python 3.6&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-509-private-dictionary-version"&gt;
&lt;h2&gt;PEP 509: private dictionary version&lt;/h2&gt;
&lt;p&gt;Another enhancement from my &lt;a class="reference external" href="http://faster-cpython.readthedocs.io/fat_python.html"&gt;FAT Python&lt;/a&gt; project: my &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0509/"&gt;PEP 509:
Add a private version to dict&lt;/a&gt; was
approved at the CPython sprint by Guido van Rossum.&lt;/p&gt;
&lt;p&gt;The dictionary version is used by FAT Python to check quickly if a variable was
modified in a Python namespace. Technically, a Python namespace is a regular
dictionary.&lt;/p&gt;
&lt;p&gt;Using the feedback from the python-ideas mailing list on the first version of
my PEP, I made further changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Use 64-bit unsigned integers on 32-bit system: &amp;quot;A risk of an integer overflow
every 584 years is acceptable.&amp;quot; Using 32-bit, an overflow occurs every 4
seconds!&lt;/li&gt;
&lt;li&gt;Don't expose the version at Python level to prevent users writing
optimizations based on it in Python. Reading the dictionary version in Python
is as slow as a dictionary lookup, wheras the version is usually used to
avoid a &amp;quot;slow&amp;quot; dictionary lookup. The version is only accessible at the C
level.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;While my experimental FAT Python static optimizer didn't convince Guido, Yury
Selivanov wrote yet another cache for global variables using the dictionary
version: &lt;a class="reference external" href="http://bugs.python.org/issue28158"&gt;Implement LOAD_GLOBAL opcode cache&lt;/a&gt; (sadly, not merged yet).&lt;/p&gt;
&lt;p&gt;I added the private version to the builtin dict type with the issue #26058. The
global dictionary version is incremented at each dictionary creation and at
each dictionary change, and each dictionary has its own version as well.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fastcall-optimization-avoiding-temporary-tuple-to-call-functions"&gt;
&lt;h2&gt;FASTCALL: optimization avoiding temporary tuple to call functions&lt;/h2&gt;
&lt;p&gt;Thanks to my work on making Python benchmarks more stable, I confirmed that my
FASTCALL patches don't introduce performance regressions, and make Python
faster in some specific cases.&lt;/p&gt;
&lt;p&gt;I started to push FASTCALL changes. It will take me 6 months to push most
changes to enable fully FASTCALL &amp;quot;everywhere&amp;quot; in the code base and to finish
the implementation.&lt;/p&gt;
&lt;p&gt;Following blog posts will describe FASTCALL changes, its history and
performance enhancements. Spoiler: Python 3.6 is fast!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="more-efficient-call-function-bytecode"&gt;
&lt;h2&gt;More efficient CALL_FUNCTION bytecode&lt;/h2&gt;
&lt;p&gt;I reviewed and merged Demur Rumed's patch to make the CALL_FUNCTION opcodes
more efficient. Demur implemented the design proposed by Serhiy Storchaka.
Serhiy Storchaka also reviewied the implementation with me.&lt;/p&gt;
&lt;p&gt;Issue #27213: Rework CALL_FUNCTION* opcodes to produce shorter and more
efficient bytecode:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;CALL_FUNCTION&lt;/tt&gt; now only accepts positional arguments&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;CALL_FUNCTION_KW&lt;/tt&gt; accepts positional arguments and keyword arguments,
keys of keyword arguments are packed into a constant tuple.&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;CALL_FUNCTION_EX&lt;/tt&gt; is the most generic opcode: it expects a tuple and a
dict for positional and keyword arguments.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;CALL_FUNCTION_VAR&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;CALL_FUNCTION_VAR_KW&lt;/tt&gt; opcodes have been removed.&lt;/p&gt;
&lt;p&gt;Demur Rumed also implemented &amp;quot;Wordcode&amp;quot;, a new bytecode format using fixed
units of 16-bit: 8-bit opcode with 8-bit argument. Wordcode was merged in May
2016, see &lt;a class="reference external" href="http://bugs.python.org/issue26647"&gt;issue #26647: ceval: use Wordcode, 16-bit bytecode&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;All instructions have an argument: opcodes without argument use the argument
&lt;tt class="docutils literal"&gt;0&lt;/tt&gt;. It allowed to remove the following conditional code in the very hot code
of &lt;tt class="docutils literal"&gt;Python/ceval.c&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if (HAS_ARG(opcode))
    oparg = NEXTARG();
&lt;/pre&gt;
&lt;p&gt;The bytecode is now fetched using 16-bit words, instead of loading one or two
8-bit words per instruction.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="work-on-optimization"&gt;
&lt;h2&gt;Work on optimization&lt;/h2&gt;
&lt;p&gt;I continued with work on the &lt;a class="reference external" href="https://github.com/python/performance"&gt;performance&lt;/a&gt; Python benchmark suite. The suite
works on CPython and PyPy, but it's maybe not fine tuned for PyPy yet.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #27938: Add a fast-path for us-ascii encoding&lt;/li&gt;
&lt;li&gt;Issue #15369: Remove the (old version of) pybench microbenchmark. Please use
the new &amp;quot;performance&amp;quot; benchmark suite which includes a more recent version of
pybench.&lt;/li&gt;
&lt;li&gt;Issue #15369. Remove old and unreliable pystone microbenchmark. Please use
the new &amp;quot;performance&amp;quot; benchmark suite which is much more reliable.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="interesting-bug-hidden-resource-warnings"&gt;
&lt;h2&gt;Interesting bug: hidden resource warnings&lt;/h2&gt;
&lt;p&gt;At 2016-08-22, I started to investigate why &amp;quot;Warning -- xxx was modfied by
test_xxx&amp;quot; warnings were not logged on some buildbots (issue #27829).&lt;/p&gt;
&lt;p&gt;I modified the code logging the warning to flush immediatly stderr:
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;print(...,&lt;/span&gt; flush=True)&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;19 days later, I tried to remove a quiet flag &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-q&lt;/span&gt;&lt;/tt&gt; on the Windows build...
but it was a mistake, this flag doesn't mean quiet in the modified batch script
:-)&lt;/p&gt;
&lt;p&gt;13 days later, I finally understood that the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-W&lt;/span&gt;&lt;/tt&gt; option of regrtest was
eating stderr if the test pass but the environment was modified.&lt;/p&gt;
&lt;p&gt;I fixed regrtest to log stderr in all cases, except if the test pass! It should
now be easier to fix &amp;quot;environment changed&amp;quot; warnings emitted by regrtest.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="contributions"&gt;
&lt;h2&gt;Contributions&lt;/h2&gt;
&lt;p&gt;As usual, I reviewed and pushed changes written by other contributors:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #27350: I reviewed and pushed the implementation of compact
dictionaries preserving insertion order. This resulted in dictionaries using
20% to 25% less memory when compared to Python 3.5. The implementation was
written by &lt;strong&gt;INADA Naoki&lt;/strong&gt;, based on the PyPy implementation, with a design
by Raymond Hettinger.&lt;/li&gt;
&lt;li&gt;&amp;quot;make tags&amp;quot;: remove &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-t&lt;/span&gt;&lt;/tt&gt; option of &lt;tt class="docutils literal"&gt;ctags&lt;/tt&gt;. The option was kept for
backward compatibility, but it was completly removed recently. Patch written
by &lt;strong&gt;Stéphane Wirtel&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #27558: Fix a &lt;tt class="docutils literal"&gt;SystemError&lt;/tt&gt; in the implementation of &amp;quot;raise&amp;quot; statement.
In a brand new thread, raise a RuntimeError since there is no active
exception to reraise. Patch written by &lt;strong&gt;Xiang Zhang&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #28120: Fix &lt;tt class="docutils literal"&gt;dict.pop()&lt;/tt&gt; for splitted dictionary when trying to remove a
&amp;quot;pending key&amp;quot;: a key not yet inserted in split-table. Patch by &lt;strong&gt;Xiang
Zhang&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="bugfixes"&gt;
&lt;h2&gt;Bugfixes&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;socket: Fix &lt;tt class="docutils literal"&gt;internal_select()&lt;/tt&gt; function. Bug found by &lt;strong&gt;Pavel Belikov&lt;/strong&gt;
(&amp;quot;Fragment N1&amp;quot;): &lt;a class="reference external" href="http://www.viva64.com/en/b/0414/#ID0ECDAE"&gt;http://www.viva64.com/en/b/0414/#ID0ECDAE&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;socket: use INVALID_SOCKET.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Replace &lt;tt class="docutils literal"&gt;fd = &lt;span class="pre"&gt;-1&lt;/span&gt;&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;fd = INVALID_SOCKET&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Replace &lt;tt class="docutils literal"&gt;fd &amp;lt; 0&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;fd == INVALID_SOCKET&lt;/tt&gt;:
SOCKET_T is unsigned on Windows&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Bug found by Pavel Belikov (&amp;quot;Fragment N1&amp;quot;):
&lt;a class="reference external" href="http://www.viva64.com/en/b/0414/#ID0ECDAE"&gt;http://www.viva64.com/en/b/0414/#ID0ECDAE&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #11048: ctypes, fix &lt;tt class="docutils literal"&gt;CThunkObject_new()&lt;/tt&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Initialize restype and flags fields to fix a crash when Python runs on a
read-only file system&lt;/li&gt;
&lt;li&gt;Use &lt;tt class="docutils literal"&gt;Py_ssize_t&lt;/tt&gt; type rather than &lt;tt class="docutils literal"&gt;int&lt;/tt&gt; for the &lt;tt class="docutils literal"&gt;i&lt;/tt&gt; iterator variable&lt;/li&gt;
&lt;li&gt;Reorder assignements to be able to more easily check if all fields are
initialized&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Initial patch written by &lt;strong&gt;Marcin Bachry&lt;/strong&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #27744: socket: Fix memory leak in &lt;tt class="docutils literal"&gt;sendmsg()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;sendmsg_afalg()&lt;/tt&gt;.  Release &lt;tt class="docutils literal"&gt;msg.msg_iov&lt;/tt&gt; memory block. Release memory
on &lt;tt class="docutils literal"&gt;PyMem_Malloc(controllen)&lt;/tt&gt; failure&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #27866: ssl: Fix refleak in &lt;tt class="docutils literal"&gt;cipher_to_dict()&lt;/tt&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #28077: Fix dict type, &lt;tt class="docutils literal"&gt;find_empty_slot()&lt;/tt&gt; only supports combined
dictionaries.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #28200: Fix memory leak in &lt;tt class="docutils literal"&gt;path_converter()&lt;/tt&gt;. Replace
&lt;tt class="docutils literal"&gt;PyUnicode_AsWideCharString()&lt;/tt&gt; &lt;tt class="docutils literal"&gt;with PyUnicode_AsUnicodeAndSize()&lt;/tt&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #27955: Catch permission error (&lt;tt class="docutils literal"&gt;EPERM&lt;/tt&gt;) in &lt;tt class="docutils literal"&gt;py_getrandom()&lt;/tt&gt;.
Fallback on reading from the &lt;tt class="docutils literal"&gt;/dev/urandom&lt;/tt&gt; device when the &lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt;
syscall fails with &lt;tt class="docutils literal"&gt;EPERM&lt;/tt&gt;, for example if blocked by SECCOMP.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #27778: Fix a memory leak in &lt;tt class="docutils literal"&gt;os.getrandom()&lt;/tt&gt; when the
&lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; is interrupted by a signal and a signal handler raises a
Python exception.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #28233: Fix &lt;tt class="docutils literal"&gt;PyUnicode_FromFormatV()&lt;/tt&gt; error handling. Fix a memory
leak if the format string contains a non-ASCII character: destroy the unicode
writer.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="regrtest-changes"&gt;
&lt;h2&gt;regrtest changes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;regrtest: rename &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--slow&lt;/span&gt;&lt;/tt&gt; option to &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--slowest&lt;/span&gt;&lt;/tt&gt; (to get same option name
than the &lt;tt class="docutils literal"&gt;testr&lt;/tt&gt; tool). Thanks to optparse, --slow syntax still works ;-)
Add --slowest option to buildbots. Display the top 10 slowest tests.&lt;/li&gt;
&lt;li&gt;regrtest: nicer output for durations. Use milliseconds and minutes units, not
only seconds.&lt;/li&gt;
&lt;li&gt;regrtest: Add a summary of the tests at the end of tests output:
&amp;quot;Tests result: xxx&amp;quot;. It was sometimes hard to check quickly if tests
succeeded, failed or something bad happened.&lt;/li&gt;
&lt;li&gt;regrtest: accept options after test names. For example, &lt;tt class="docutils literal"&gt;./python &lt;span class="pre"&gt;-m&lt;/span&gt; test
test_os &lt;span class="pre"&gt;-v&lt;/span&gt;&lt;/tt&gt; runs &lt;tt class="docutils literal"&gt;test_os&lt;/tt&gt; in verbose mode. Before, regrtest tried to run
a test called &amp;quot;-v&amp;quot;!&lt;/li&gt;
&lt;li&gt;Issue #28195: Fix &lt;tt class="docutils literal"&gt;test_huntrleaks_fd_leak()&lt;/tt&gt; of test_regrtest. Don't expect
the fd leak message to be on a specific line number, just make sure that the
line is present in the output.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example of a recent (2017-02-15) successful test run, truncated output:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
...
0:08:20 [403/404] test_codecs passed
0:08:21 [404/404] test_threading passed
391 tests OK.

10 slowest tests:
- test_multiprocessing_spawn: 1 min 24 sec
- test_concurrent_futures: 1 min 3 sec
- test_multiprocessing_forkserver: 60 sec
...

13 tests skipped:
    test_devpoll test_ioctl test_kqueue ...

Total duration: 8 min 22 sec
Tests result: SUCCESS
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="tests-changes"&gt;
&lt;h2&gt;Tests changes&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;script_helper: kill the subprocess on error. If Popen.communicate() raises an
exception, kill the child process to not leave a running child process in
background and maybe create a zombi process. This change fixes a
ResourceWarning in Python 3.6 when unit tests are interrupted by CTRL+c.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #27181: Skip test_statistics tests known to fail until a fix is found.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #18401: Fix test_pdb if $HOME is not set. HOME is not set on Windows
for example.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;test_eintr: Fix &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; warnings&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Buildbot: give 20 minute per test file. It seems like at least 2 buildbots
need more than 15 minutes per test file.  Example with &amp;quot;AMD64 Snow Leop 3.x&amp;quot;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
10 slowest tests:
- test_tools: 14 min 40 sec
- test_tokenize: 11 min 57 sec
- test_datetime: 11 min 25 sec
- ...
&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #28176: test_asynico: fix test_sock_connect_sock_write_race(), increase
the timeout from 10 seconds to 60 seconds.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="other-changes"&gt;
&lt;h2&gt;Other changes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #22624: Python 3 now requires the &lt;tt class="docutils literal"&gt;clock()&lt;/tt&gt; function to build to
simplify the C code.&lt;/li&gt;
&lt;li&gt;Issue #27404: tag security related changes with the &amp;quot;[Security]&amp;quot; prefix in
the changelog Misc/NEWS.&lt;/li&gt;
&lt;li&gt;Issue #27776: &lt;tt class="docutils literal"&gt;dev_urandom(raise=0)&lt;/tt&gt; now closes the file descriptor on error&lt;/li&gt;
&lt;li&gt;Issue #27128, #18295: Use &lt;tt class="docutils literal"&gt;Py_ssize_t&lt;/tt&gt; in &lt;tt class="docutils literal"&gt;_PyEval_EvalCodeWithName()&lt;/tt&gt;.
Replace &lt;tt class="docutils literal"&gt;int&lt;/tt&gt; type with &lt;tt class="docutils literal"&gt;Py_ssize_t&lt;/tt&gt; for index variables used for
positional arguments.  It should help to avoid integer overflow and help to
emit better machine code for &lt;tt class="docutils literal"&gt;i++&lt;/tt&gt; (no trap needed for overflow). Make also
the &lt;tt class="docutils literal"&gt;total_args&lt;/tt&gt; variable constant.&lt;/li&gt;
&lt;li&gt;Fix &amp;quot;make tags&amp;quot;: set locale to C to call sort. vim expects that the tags file
is sorted using english collation, so it fails if the locale is french for
example. Use LC_ALL=C to force english sorting order. Issue #27726.&lt;/li&gt;
&lt;li&gt;Issue #27698: Add &lt;tt class="docutils literal"&gt;socketpair&lt;/tt&gt; function to &lt;tt class="docutils literal"&gt;socket.__all__&lt;/tt&gt; on Windows&lt;/li&gt;
&lt;li&gt;Issue #27786: Simplify (optimize?) PyLongObject private function &lt;tt class="docutils literal"&gt;x_sub()&lt;/tt&gt;:
the &lt;tt class="docutils literal"&gt;z&lt;/tt&gt; variable is known to be a new object which cannot be shared,
&lt;tt class="docutils literal"&gt;Py_SIZE()&lt;/tt&gt; can be used directly to negate the number.&lt;/li&gt;
&lt;li&gt;Fix a clang warning in grammar.c. Clang is smarter than GCC and emits a
warning for dead code on a function declared with
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;__attribute__((__noreturn__))&lt;/span&gt;&lt;/tt&gt; (the &lt;tt class="docutils literal"&gt;Py_FatalError()&lt;/tt&gt; function in this
case).&lt;/li&gt;
&lt;li&gt;Issue #28114: Add unit tests on &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;os.spawn*()&lt;/span&gt;&lt;/tt&gt; to prepare to fix a crash
with bytes environment.&lt;/li&gt;
&lt;li&gt;Issue #28127: Add &lt;tt class="docutils literal"&gt;_PyDict_CheckConsistency()&lt;/tt&gt;: function checking that a
dictionary remains consistent after any change. By default, only basic
attributes are tested, table content is not checked because the impact on
Python performance is too important. &lt;tt class="docutils literal"&gt;DEBUG_PYDICT&lt;/tt&gt; must be defined (ex:
&lt;tt class="docutils literal"&gt;gcc &lt;span class="pre"&gt;-D&lt;/span&gt; DEBUG_PYDICT&lt;/tt&gt;) to check also dictionaries content.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>CPython sprint, september 2016</title><link href="https://vstinner.github.io/cpython-sprint-2016.html" rel="alternate"></link><published>2017-02-14T18:00:00+01:00</published><updated>2017-02-14T18:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-14:/cpython-sprint-2016.html</id><summary type="html">&lt;p&gt;I was invited at my first CPython sprint in September! Five days, September
5-9, at Instagram office in California, USA. The sprint was sponsored by
Instagram, Microsoft, and the PSF.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;First little game:&lt;/strong&gt; Many happy faces, but &lt;em&gt;Where is Victor?&lt;/em&gt;&lt;/p&gt;
&lt;a class="reference external image-reference" href="http://blog.python.org/2016/09/python-core-development-sprint-2016-36.html"&gt;&lt;img alt="CPython developers at the Facebook sprint" src="https://vstinner.github.io/images/cpython_sprint_2016_photo.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;IMHO it was the most productive CPython week ever :-) Having …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I was invited at my first CPython sprint in September! Five days, September
5-9, at Instagram office in California, USA. The sprint was sponsored by
Instagram, Microsoft, and the PSF.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;First little game:&lt;/strong&gt; Many happy faces, but &lt;em&gt;Where is Victor?&lt;/em&gt;&lt;/p&gt;
&lt;a class="reference external image-reference" href="http://blog.python.org/2016/09/python-core-development-sprint-2016-36.html"&gt;&lt;img alt="CPython developers at the Facebook sprint" src="https://vstinner.github.io/images/cpython_sprint_2016_photo.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;IMHO it was the most productive CPython week ever :-) Having Guido van Rossum
in a room helped to get many PEPs accepted. Having a lot of highly skilled
reviewers in the same room helped to get many new features and many PEP
implementations merged much faster than usual.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Second little game:&lt;/strong&gt; try to spot the sprint on the CPython commit statistics of
the last 12 months (Feb, 2016-Feb, 2017) ;-)&lt;/p&gt;
&lt;a class="reference external image-reference" href="https://github.com/python/cpython/graphs/commit-activity"&gt;&lt;img alt="CPython commits statistics" src="https://vstinner.github.io/images/cpython_sprint_2016_commits.png" /&gt;&lt;/a&gt;
&lt;div class="section" id="compact-dict"&gt;
&lt;h2&gt;Compact dict&lt;/h2&gt;
&lt;p&gt;Issue #27350: I reviewed and pushed the &amp;quot;compact dict&amp;quot; implementation which
makes Python dictionaries ordered (by insertion order) by default. It reduces
the memory usage of dictionaries betwen 20% and 25%.&lt;/p&gt;
&lt;p&gt;The implementation was written by INADA Naoki, based on the PyPy
implementation, with a design by Raymond Hettinger.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fastcall"&gt;
&lt;h2&gt;FASTCALL&lt;/h2&gt;
&lt;p&gt;&amp;quot;Fast calls&amp;quot;: Python 3.6 has a new private C API and a new METH_FASTCALL
calling convention which avoids temporary tuple for positional arguments and
avoids temporary dictionary for keyword arguments. Changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Add a new C calling convention: METH_FASTCALL&lt;/li&gt;
&lt;li&gt;Add _PyArg_ParseStack() function&lt;/li&gt;
&lt;li&gt;Add _PyCFunction_FastCallKeywords() function: issue #27810&lt;/li&gt;
&lt;li&gt;Add _PyObject_FastCallKeywords() function: issue #27830&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="more-efficient-call-function-bytecode"&gt;
&lt;h2&gt;More efficient CALL_FUNCTION bytecode&lt;/h2&gt;
&lt;p&gt;I reviewed and pushed: &amp;quot;Rework CALL_FUNCTION* opcodes to produce shorter and
more efficient bytecode&amp;quot; (issue #27213).&lt;/p&gt;
&lt;p&gt;Patch writen by Demur Rumed, design by Serhiy Storchaka, reviewed by Serhiy
Storchaka and me.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-509-add-a-private-version-to-dict"&gt;
&lt;h2&gt;PEP 509: Add a private version to dict&lt;/h2&gt;
&lt;p&gt;Guido approved my PEP 509 &amp;quot;Add a new private version to the builtin dict type&amp;quot;.&lt;/p&gt;
&lt;p&gt;I pushed the implementation.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pep-524-make-os-urandom-blocking-on-linux"&gt;
&lt;h2&gt;PEP 524: Make os.urandom() blocking on Linux&lt;/h2&gt;
&lt;p&gt;I pushed the implementation of my PEP 524: &amp;quot;Make os.urandom() blocking on
Linux&amp;quot;.&lt;/p&gt;
&lt;p&gt;Issue #27776: The os.urandom() function does now block on Linux 3.17 and newer
until the system urandom entropy pool is initialized to increase the security.&lt;/p&gt;
&lt;p&gt;Read my previous blog post for the painful story behind the PEP:
&lt;a class="reference external" href="https://vstinner.github.io/pep-524-os-urandom-blocking.html"&gt;PEP 524: os.urandom() now blocks on Linux&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="asynchronous-pep-525-and-530"&gt;
&lt;h2&gt;Asynchronous PEP 525 and 530&lt;/h2&gt;
&lt;p&gt;Guido van Rossum approved two PEPs of Yury Selivanov:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;PEP 525: Asynchronous Generators&lt;/li&gt;
&lt;li&gt;PEP 530: Asynchronous Comprehensions&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I reviewed the huge C implementation with Yury on my side :-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="unicode-escape-codec-optimization"&gt;
&lt;h2&gt;unicode_escape codec optimization&lt;/h2&gt;
&lt;p&gt;I reviewed and pushed &amp;quot;Optimize unicode_escape and raw_unicode_escape&amp;quot; (the
isue #16334), patch written by Serhiy Storchaka.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-6-bugfixes"&gt;
&lt;h2&gt;Python 3.6 bugfixes&lt;/h2&gt;
&lt;p&gt;I happily found many issues including a major one: regular list-comprehension
were completely broken :-)&lt;/p&gt;
&lt;p&gt;Another minor issue: SyntaxError didn't reported the correct line number in a
specific case.&lt;/p&gt;
&lt;p&gt;Don't worry, Yury fixed both ;-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="official-sprint-report"&gt;
&lt;h2&gt;Official sprint report&lt;/h2&gt;
&lt;p&gt;Read also the official report: &lt;a class="reference external" href="http://blog.python.org/2016/09/python-core-development-sprint-2016-36.html"&gt;Python Core Development Sprint 2016: 3.6 and
beyond!&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>PEP 524: os.urandom() now blocks on Linux in Python 3.6</title><link href="https://vstinner.github.io/pep-524-os-urandom-blocking.html" rel="alternate"></link><published>2017-02-14T12:00:00+01:00</published><updated>2017-02-14T12:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-14:/pep-524-os-urandom-blocking.html</id><summary type="html">&lt;div class="section" id="getrandom-avoids-file-descriptors"&gt;
&lt;h2&gt;getrandom() avoids file descriptors&lt;/h2&gt;
&lt;p&gt;Last years, I'm making sometimes enhancements in the Python code used to
generate random numbers, the C implementation of &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt;. My main two
changes were to use the new &lt;tt class="docutils literal"&gt;getentropy()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; functions when
available on Linux, Solaris, OpenBSD, etc.&lt;/p&gt;
&lt;p&gt;In 2013, &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; opened …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;div class="section" id="getrandom-avoids-file-descriptors"&gt;
&lt;h2&gt;getrandom() avoids file descriptors&lt;/h2&gt;
&lt;p&gt;Last years, I'm making sometimes enhancements in the Python code used to
generate random numbers, the C implementation of &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt;. My main two
changes were to use the new &lt;tt class="docutils literal"&gt;getentropy()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; functions when
available on Linux, Solaris, OpenBSD, etc.&lt;/p&gt;
&lt;p&gt;In 2013, &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; opened a file descriptor to read from
&lt;tt class="docutils literal"&gt;/dev/urandom&lt;/tt&gt; and then closed it. It was decided to use a single private
file descriptor and keep it open to prevent &lt;tt class="docutils literal"&gt;EMFILE&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;ENFILE&lt;/tt&gt; errors
(too many open files) under high system loads with many threads: see the issue
#18756.&lt;/p&gt;
&lt;p&gt;The private file descriptor introduced a backward incompatible change in badly
written programs. The code was modified to call &lt;tt class="docutils literal"&gt;fstat()&lt;/tt&gt; to check if the
file descriptor was closed and then replaced with a different file descriptor
(but same number): check if &lt;tt class="docutils literal"&gt;st_dev&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;st_ino&lt;/tt&gt; attributes changed.&lt;/p&gt;
&lt;p&gt;In 2014, the new Linux kernel 3.17 added a new &lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; syscall which
gives access to random bytes without having to handle a file descriptor. I
modified &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; to call &lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; to avoid file descriptors,
but a different issue appeared.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="getrandom-hangs-at-system-startup"&gt;
&lt;h2&gt;getrandom() hangs at system startup&lt;/h2&gt;
&lt;p&gt;On embedded devices and virtual machines, Python 3.5 started to hang at
startup.&lt;/p&gt;
&lt;p&gt;On Debian, a systemd script used Python to compute a MD5 checksum, but Python
was blocked during its initialization. Other users reported that Python blocked
on importing the &lt;tt class="docutils literal"&gt;random&lt;/tt&gt; module, sometimes imported indirectly by a
different module.&lt;/p&gt;
&lt;p&gt;Python was blocked on the &lt;tt class="docutils literal"&gt;getrandom(0)&lt;/tt&gt; syscall, waiting until the system
collected enough entropy to initialize the urandom pool. It took longer than 90
seconds, so systemd killed the service with a timeout. As a consequence, the
system boot takes longer than 90 seconds or can even fail!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-python-startup"&gt;
&lt;h2&gt;Fix Python startup&lt;/h2&gt;
&lt;p&gt;The fix was obvious: call &lt;tt class="docutils literal"&gt;getrandom(GRND_NONBLOCK)&lt;/tt&gt; which fails immediately
if the call would block, and fall back on reading from &lt;tt class="docutils literal"&gt;/dev/urandom&lt;/tt&gt; which
doesn't block even if the entropy pool is not initialized yet.&lt;/p&gt;
&lt;p&gt;Quickly, our security experts complained that falling back on &lt;tt class="docutils literal"&gt;/dev/urandom&lt;/tt&gt;
makes Python less secure. When the fall back path is taken, &lt;tt class="docutils literal"&gt;/dev/urandom&lt;/tt&gt;
returns random number not suitable for security purpose (initialized with low
entropy), wheras &lt;a class="reference external" href="https://docs.python.org/dev/library/os.html#os.urandom"&gt;os.urandom() documenation&lt;/a&gt; says: &amp;quot;The returned
data should be unpredictable enough for cryptographic applications&amp;quot; (and
&amp;quot;though its exact quality depends on the OS implementation.&amp;quot;).&lt;/p&gt;
&lt;p&gt;Calling &lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; in blocking mode for &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; makes Python more
secure, but it doesn't fix the startup bug.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="discussion-storm"&gt;
&lt;h2&gt;Discussion storm&lt;/h2&gt;
&lt;p&gt;The proposed change started a huge rain of messages. More than 200 messages,
maybe even more than 500 messages, on the bug tracker and python-dev mailing
list. Everyone became a security expert and wanted to give his/her very
important opinion, without listening to other arguments.&lt;/p&gt;
&lt;p&gt;Two Python security experts left the discussion.&lt;/p&gt;
&lt;p&gt;I also ignored new messages. I simply had not enough time to read all of them,
and the discussion tone made me angry.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-mailing-list-and-two-new-peps"&gt;
&lt;h2&gt;New mailing list and two new PEPs&lt;/h2&gt;
&lt;p&gt;A new &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;security-sig&lt;/span&gt;&lt;/tt&gt; mailing list, subtitled &amp;quot;os.urandom rehab clinic&amp;quot;, was
created just to take a decision on &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt;!&lt;/p&gt;
&lt;p&gt;Nick Coghlan wrote the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0522/"&gt;PEP 522: Allow BlockingIOError in security sensitive
APIs&lt;/a&gt;. Basically: he considers
that there is no good default behaviour when &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; would block, so
raise an exception to let users decide.&lt;/p&gt;
&lt;p&gt;I wrote  &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0524/"&gt;PEP 524: Make os.urandom() blocking on Linux&lt;/a&gt;. My PEP proposes to make
&lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; blocking, &lt;em&gt;but&lt;/em&gt; also modify Python startup to fall back on
non-blocking RNG to initialize the secret hash seed and the &lt;tt class="docutils literal"&gt;random&lt;/tt&gt; module
(which is &lt;em&gt;not&lt;/em&gt; sensitive for security, except of &lt;tt class="docutils literal"&gt;random.SystemRandom&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;Nick's PEP describes an important use case: be able to check if
&lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; would block. Instead of adding a flag to &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt;,
I chose to expose the low-level C
&lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; function as a new Python &lt;tt class="docutils literal"&gt;os.getrandom()&lt;/tt&gt; function. Calling
&lt;tt class="docutils literal"&gt;os.getrandom(1, os.GRND_NONBLOCK)&lt;/tt&gt; raises a &lt;tt class="docutils literal"&gt;BlockingIOError&lt;/tt&gt; exception,
as Nick proposed for &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt;, so it's possible to decide what to do in
this case.&lt;/p&gt;
&lt;p&gt;While both PEPs are valid, IMHO my PEP was &lt;em&gt;less&lt;/em&gt; backward incompatible,
simpler and maybe closer to what users &lt;em&gt;expect&lt;/em&gt;. The &amp;quot;os.urandom() would block&amp;quot;
case is a special case with my PEP, but my PEP allows to decide what to do in
that case (thanks to &lt;tt class="docutils literal"&gt;os.getrandom()&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;Guido van Rossum approved my PEP and rejected Nick's PEP. I worked with Nick to
implement my PEP.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-6-changes"&gt;
&lt;h2&gt;Python 3.6 changes&lt;/h2&gt;
&lt;p&gt;I added a new &lt;tt class="docutils literal"&gt;os.getrandom()&lt;/tt&gt; function: expose the Linux
&lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; syscall (issue #27778). I also added the two getrandom() flags:
&lt;tt class="docutils literal"&gt;os.GRND_NONBLOCK&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;os.GRND_RANDOM&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I modified &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; to block on Linux: call &lt;tt class="docutils literal"&gt;getrandom(0)&lt;/tt&gt;
instead of &lt;tt class="docutils literal"&gt;getrandom(GRND_NONBLOCK)&lt;/tt&gt; (issue #27776).&lt;/p&gt;
&lt;p&gt;I also added a private &lt;tt class="docutils literal"&gt;_PyOS_URandomNonblock()&lt;/tt&gt; function used to initialize
the hash secret and used by &lt;tt class="docutils literal"&gt;random.Random.seed()&lt;/tt&gt; (used to initialize the
&lt;tt class="docutils literal"&gt;random&lt;/tt&gt; module).&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; function now blocks in Python 3.6 on Linux 3.17 and newer
until the system urandom entropy pool is initialized to increase the security.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="read-also-lwn-articles"&gt;
&lt;h2&gt;Read also LWN articles&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://lwn.net/Articles/606141/"&gt;A system call for random numbers: getrandom()&lt;/a&gt; (July 2014)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://lwn.net/Articles/693189/"&gt;Python's os.urandom() in the absence of entropy&lt;/a&gt; (July 2016) -- this story&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://lwn.net/Articles/711013/"&gt;The long road to getrandom() in glibc&lt;/a&gt; (January 2017)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category><category term="security"></category></entry><entry><title>My contributions to CPython during 2016 Q2</title><link href="https://vstinner.github.io/contrib-cpython-2016q2.html" rel="alternate"></link><published>2017-02-12T18:00:00+01:00</published><updated>2017-02-12T18:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-12:/contrib-cpython-2016q2.html</id><summary type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2016 Q2
(april, may, june):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2016-04-01&amp;quot;):date(&amp;quot;2016-06-30&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 52 non-merge commits + 22 merge commits (total: 74 commits).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q1.html"&gt;My contributions to CPython during 2016 Q1&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q3.html"&gt;My contributions to
CPython during 2016 Q3&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="start-of-my-work-on-optimization"&gt;
&lt;h2&gt;Start of …&lt;/h2&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2016 Q2
(april, may, june):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2016-04-01&amp;quot;):date(&amp;quot;2016-06-30&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 52 non-merge commits + 22 merge commits (total: 74 commits).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q1.html"&gt;My contributions to CPython during 2016 Q1&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q3.html"&gt;My contributions to
CPython during 2016 Q3&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="start-of-my-work-on-optimization"&gt;
&lt;h2&gt;Start of my work on optimization&lt;/h2&gt;
&lt;p&gt;During 2016 Q2, I started to spend more time on optimizing CPython.&lt;/p&gt;
&lt;p&gt;I experimented a change on CPython: a new FASTCALL calling convention to avoid
the creation of a temporary tuple to pass positional argulments: &lt;a class="reference external" href="http://bugs.python.org/issue26814"&gt;issue26814&lt;/a&gt;. Early results were really good: calling
builtin functions became between 20% and 50% faster!&lt;/p&gt;
&lt;p&gt;Quickly, my optimization work was blocked by unreliable benchmarks. I spent the
rest of the year 2016 analyzing benchmarks and making benchmarks more stable.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="subprocess-now-emits-resourcewarning"&gt;
&lt;h2&gt;subprocess now emits ResourceWarning&lt;/h2&gt;
&lt;p&gt;subprocess.Popen destructor now emits a ResourceWarning warning if the child
process is still running (issue #26741). The warning helps to track and fix
zombi processes. I updated asyncio to prevent a false ResourceWarning (warning
whereas the child process completed): asyncio now copies the child process exit
status to the internal Popen object.&lt;/p&gt;
&lt;p&gt;I also fixed the POSIX implementation of subprocess.Popen._execute_child(): it
now sets the returncode attribute from the child process exit status when exec
failed.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="security-fix-potential-shell-injections-in-ctypes-util"&gt;
&lt;h2&gt;Security: fix potential shell injections in ctypes.util&lt;/h2&gt;
&lt;p&gt;I rewrote methods of the ctypes.util module using &lt;tt class="docutils literal"&gt;os.popen()&lt;/tt&gt;. I replaced
&lt;tt class="docutils literal"&gt;os.popen()&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;subprocess.Popen&lt;/tt&gt; without shell (issue #22636) to fix a
class of security vulneratiblity, &amp;quot;shell injection&amp;quot; (inject arbitrary shell
commands to take the control of a computer).&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;os.popen()&lt;/tt&gt; function uses a shell, so there is a risk if the command
line arguments are not properly escaped for shell. Using &lt;tt class="docutils literal"&gt;subproces.Popen&lt;/tt&gt;
without shell fixes completely the risk.&lt;/p&gt;
&lt;p&gt;Note: the &lt;tt class="docutils literal"&gt;ctypes&lt;/tt&gt; is generally not considered as &amp;quot;safe&amp;quot;, but it doesn't harm
to make it more secure ;-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="optimization-pymem-malloc-now-uses-pymalloc"&gt;
&lt;h2&gt;Optimization: PyMem_Malloc() now uses pymalloc&lt;/h2&gt;
&lt;p&gt;PyMem_Malloc() now uses the fast Python &amp;quot;pymalloc&amp;quot; memory allocator which is
optimized for small objects with a short lifetime (issue #26249). The change
makes some benchmarks up to 4% faster.&lt;/p&gt;
&lt;p&gt;This change was possible thanks to the whole preparation work I did in the 2016
Q1, especially the new GIL check in memory allocator debug hooks and the new
&lt;tt class="docutils literal"&gt;PYTHONMALLOC=debug&lt;/tt&gt; environment variable enabling these hooks on a Python
compiled in released mode.&lt;/p&gt;
&lt;p&gt;I tested lxml, Pillow, cryptography and numpy before pushing the change,
as asked by Marc-Andre Lemburg. All these projects work with the change, except
of numpy. I wrote a fix for numpy: &lt;a class="reference external" href="https://github.com/numpy/numpy/pull/7404"&gt;Use PyMem_RawMalloc on Python 3.4 and newer&lt;/a&gt;, merged one month later (my first
contribution to numy!).&lt;/p&gt;
&lt;p&gt;The change indirectly helped to identify and fix a memory leak in the
&lt;tt class="docutils literal"&gt;formatfloat()&lt;/tt&gt; function used to format bytes strings: &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;b&amp;quot;%f&amp;quot;&lt;/span&gt; % 1.2&lt;/tt&gt; (issue
#25349, #26249).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="optimization"&gt;
&lt;h2&gt;Optimization&lt;/h2&gt;
&lt;p&gt;Issue #27056: Optimize pickle.load() and pickle.loads(), up to 10% faster to
deserialize a lot of small objects. I found this optimization using Linux perf
on Python compiled with PGO. My change implements manually the optimization if
Python is not compiled with PGO.&lt;/p&gt;
&lt;p&gt;Issue #26770: When &lt;tt class="docutils literal"&gt;set_inheritable()&lt;/tt&gt; is implemented with &lt;tt class="docutils literal"&gt;fcntl()&lt;/tt&gt;, don't
call &lt;tt class="docutils literal"&gt;fcntl()&lt;/tt&gt; twice if the &lt;tt class="docutils literal"&gt;FD_CLOEXEC&lt;/tt&gt; flag is already set to the
requested value. Linux uses &lt;tt class="docutils literal"&gt;ioctl()&lt;/tt&gt; and so always only need a single
syscall.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="changes"&gt;
&lt;h2&gt;Changes&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #26716: Replace IOError with OSError in fcntl documentation, IOError is
a deprecated alias to OSError since Python 3.3.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #26639: Replace the deprecated &lt;tt class="docutils literal"&gt;imp&lt;/tt&gt; module with the &lt;tt class="docutils literal"&gt;importlib&lt;/tt&gt;
module in &lt;tt class="docutils literal"&gt;Tools/i18n/pygettext.py&lt;/tt&gt;. Remove &lt;tt class="docutils literal"&gt;_get_modpkg_path()&lt;/tt&gt;,
replaced with &lt;tt class="docutils literal"&gt;importlib.util.find_spec()&lt;/tt&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #26735: Fix os.urandom() on Solaris 11.3 and newer when reading more
than 1024 bytes: call getrandom() multiple times with a limit of 1024 bytes
per call.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;configure: fix &lt;tt class="docutils literal"&gt;HAVE_GETRANDOM_SYSCALL&lt;/tt&gt; check, syscall() function requires
&lt;tt class="docutils literal"&gt;#include &amp;lt;unistd.h&amp;gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #26766: Fix _PyBytesWriter_Finish(). Return a bytearray object when
bytearray is requested and when the small buffer is used. Fix also
test_bytes: bytearray%args must return a bytearray type.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #26777: Fix random failure of test_asyncio.test_timeout_disable() on
the &amp;quot;AMD64 FreeBSD 9.x 3.5&amp;quot; buildbot:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
File &amp;quot;.../Lib/test/test_asyncio/test_tasks.py&amp;quot;, line 2398, in go
  self.assertTrue(0.09 &amp;lt; dt &amp;lt; 0.11, dt)
AssertionError: False is not true : 0.11902812402695417
&lt;/pre&gt;
&lt;p&gt;Replace &lt;tt class="docutils literal"&gt;&amp;lt; 0.11&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;&amp;lt; 0.15&lt;/tt&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Backport test_gdb fix for s390x buildbots to Python 3.5.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Cleanup import.c: replace &lt;tt class="docutils literal"&gt;PyUnicode_RPartition()&lt;/tt&gt; with
&lt;tt class="docutils literal"&gt;PyUnicode_FindChar()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;PyUnicode_Substring()&lt;/tt&gt; to avoid the creation
of a temporary tuple. Use &lt;tt class="docutils literal"&gt;PyUnicode_FromFormat()&lt;/tt&gt; to build a string and
avoid the single_dot ('.') singleton.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;regrtest now uses subprocesses when the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-j1&lt;/span&gt;&lt;/tt&gt; command line option is used:
each test file runs in a fresh child process. Before, the -j1 option was
ignored. &lt;tt class="docutils literal"&gt;Tools/buildbot/test.bat&lt;/tt&gt; script now uses -j1 by default to run
each test file in fresh child process.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;regrtest: display test result (passed, failed, ...) after each test
completion. In multiprocessing mode: always display the result. In sequential
mode: only display the result if the test did not pass&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p class="first"&gt;Issue #27278: Fix &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; implementation using &lt;tt class="docutils literal"&gt;getrandom()&lt;/tt&gt; on
Linux. Truncate size to &lt;tt class="docutils literal"&gt;INT_MAX&lt;/tt&gt; and loop until we collected enough random
bytes, instead of casting a directly &lt;tt class="docutils literal"&gt;Py_ssize_t&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;int&lt;/tt&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="contributions"&gt;
&lt;h2&gt;Contributions&lt;/h2&gt;
&lt;p&gt;I also pushed a few changes written by other contributors.&lt;/p&gt;
&lt;p&gt;Issue #26839: &lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; doesn't block on Linux anymore. On Linux,
&lt;tt class="docutils literal"&gt;os.urandom()&lt;/tt&gt; now calls getrandom() with &lt;tt class="docutils literal"&gt;GRND_NONBLOCK&lt;/tt&gt; to fall back on
reading &lt;tt class="docutils literal"&gt;/dev/urandom&lt;/tt&gt; if the urandom entropy pool is not initialized yet.
Patch written by &lt;strong&gt;Colm Buckley&lt;/strong&gt;. This issue started a huge annoying discussion
around random number generation on the bug tracker and the python-dev mailing
list.  I later wrote the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0524/"&gt;PEP 524: Make os.urandom() blocking on Linux&lt;/a&gt; to fix the issue!&lt;/p&gt;
&lt;p&gt;Other changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #26647: Cleanup opcode: simplify code to build &lt;tt class="docutils literal"&gt;opcode.opname&lt;/tt&gt;. Patch
written by &lt;strong&gt;Demur Rumed&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #26647: Cleanup modulefinder: use &lt;tt class="docutils literal"&gt;dis.opmap[name]&lt;/tt&gt; rather than
&lt;tt class="docutils literal"&gt;dis.opname.index(name)&lt;/tt&gt;. Patch written by &lt;strong&gt;Demur Rumed&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #26801: Fix error handling in &lt;tt class="docutils literal"&gt;shutil.get_terminal_size()&lt;/tt&gt;: catch
AttributeError instead of NameError. Skip the functional test of test_shutil
using the &lt;tt class="docutils literal"&gt;stty size&lt;/tt&gt; command if the &lt;tt class="docutils literal"&gt;os.get_terminal_size()&lt;/tt&gt; function is
missing. Patch written by &lt;strong&gt;Emanuel Barry&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #26802: Optimize function calls only using unpacking like
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;func(*tuple)&lt;/span&gt;&lt;/tt&gt; (no other positional argument, no keyword argument): avoid
copying the tuple. Patch written by &lt;strong&gt;Joe Jevnik&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #21668: Add missing libm dependency in setup.py: link audioop,
_datetime, _ctypes_test modules to libm, except on Mac OS X. Patch written by
&lt;strong&gt;Chi Hsuan Yen&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #26799: Fix python-gdb.py: don't get C types at startup, only on
demand. The C types can change if python-gdb.py is loaded before loading the
Python executable in gdb. Patch written by &lt;strong&gt;Thomas Ilsche&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #27057: Fix os.set_inheritable() on Android, ioctl() is blocked by
SELinux and fails with EACCESS. The function now falls back to fcntl(). Patch
written by &lt;strong&gt;Michał Bednarski&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #26647: Fix typo in test_grammar. Patch written by &lt;strong&gt;Demur Rumed&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2016 Q1</title><link href="https://vstinner.github.io/contrib-cpython-2016q1.html" rel="alternate"></link><published>2017-02-09T17:00:00+01:00</published><updated>2017-02-09T17:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2017-02-09:/contrib-cpython-2016q1.html</id><summary type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2016 Q1
(january, februrary, march):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2016-01-01&amp;quot;):date(&amp;quot;2016-03-31&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 196 non-merge commits + 33 merge commits (total: 229 commits).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2015q4.html"&gt;My contributions to CPython during 2015 Q4&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q2.html"&gt;My contributions to
CPython during 2016 Q2&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="summary"&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;p&gt;Since …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2016 Q1
(january, februrary, march):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2016-01-01&amp;quot;):date(&amp;quot;2016-03-31&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 196 non-merge commits + 33 merge commits (total: 229 commits).&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2015q4.html"&gt;My contributions to CPython during 2015 Q4&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q2.html"&gt;My contributions to
CPython during 2016 Q2&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="summary"&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;p&gt;Since this report is much longer than I expected, here are the highlights:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Python 8: no pep8, no chocolate!&lt;/li&gt;
&lt;li&gt;AST enhancements coming from FAT Python&lt;/li&gt;
&lt;li&gt;faulthandler now catchs Windows fatal exceptions&lt;/li&gt;
&lt;li&gt;New PYTHONMALLOC environment variable&lt;/li&gt;
&lt;li&gt;tracemalloc: new C API and support multiple address spaces&lt;/li&gt;
&lt;li&gt;ResourceWarning warnings now come with a traceback&lt;/li&gt;
&lt;li&gt;PyMem_Malloc() now fails if the GIL is not held&lt;/li&gt;
&lt;li&gt;Interesting bug: reentrant flag in tracemalloc&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="python-8-no-pep8-no-chocolate"&gt;
&lt;h2&gt;Python 8: no pep8, no chocolate!&lt;/h2&gt;
&lt;p&gt;I prepared an April Fool: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-March/143603.html"&gt;[Python-Dev] The next major Python version will be
Python 8&lt;/a&gt; :-)&lt;/p&gt;
&lt;p&gt;I increased Python version to 8, added the &lt;tt class="docutils literal"&gt;pep8&lt;/tt&gt; module and modified
&lt;tt class="docutils literal"&gt;importlib&lt;/tt&gt; to raise an &lt;tt class="docutils literal"&gt;ImportError&lt;/tt&gt; if a module is not PEP8-compliant!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="ast-enhancements-coming-from-fat-python"&gt;
&lt;h2&gt;AST enhancements coming from FAT Python&lt;/h2&gt;
&lt;p&gt;Changes coming from my &lt;a class="reference external" href="http://faster-cpython.readthedocs.io/fat_python.html"&gt;FAT Python&lt;/a&gt; (AST optimizer, run
ahead of time):&lt;/p&gt;
&lt;p&gt;The compiler now ignores constant statements like &lt;tt class="docutils literal"&gt;b'bytes'&lt;/tt&gt; (issue #26204).
I had to replace constant statement with expressions to prepare the change (ex:
replace &lt;tt class="docutils literal"&gt;b'bytes'&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;x = b'bytes'&lt;/tt&gt;). First, the compiler emited a
&lt;tt class="docutils literal"&gt;SyntaxWarning&lt;/tt&gt;, but it was quickly decided to let linters to emit such
warnings to not annoy users: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-February/143163.html"&gt;read the thread on python-dev&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Example, Python 3.5:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;gt;&amp;gt;&amp;gt; def f():
...  b'bytes'
...
&amp;gt;&amp;gt;&amp;gt; import dis; dis.dis(f)
  2           0 LOAD_CONST               1 (b'bytes')
              3 POP_TOP
              4 LOAD_CONST               0 (None)
              7 RETURN_VALUE
&lt;/pre&gt;
&lt;p&gt;Python 3.6:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;gt;&amp;gt;&amp;gt; def f():
...  b'bytes'
...
&amp;gt;&amp;gt;&amp;gt; import dis; dis.dis(f)
  1           0 LOAD_CONST               0 (None)
              2 RETURN_VALUE
&lt;/pre&gt;
&lt;p&gt;Other changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #26107: The format of the co_lnotab attribute of code objects changes
to support negative line number delta. It allows AST optimizers to move
instructions without breaking Python tracebacks. Change needed by the loop
unrolling optimization of FAT Python.&lt;/li&gt;
&lt;li&gt;Issue #26146: Add a new kind of AST node: &lt;tt class="docutils literal"&gt;ast.Constant&lt;/tt&gt;. It can be used by
external AST optimizers like FAT Python, but the compiler does not emit
directly such node. Update code to accept ast.Constant instead of ast.Num
and/or ast.Str.&lt;/li&gt;
&lt;li&gt;Issue #26146: &lt;tt class="docutils literal"&gt;marshal.loads()&lt;/tt&gt; now uses the empty frozenset singleton. It
fixes a test failure in FAT Python and reduces the memory footprint.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="faulthandler-now-catchs-windows-fatal-exceptions"&gt;
&lt;h2&gt;faulthandler now catchs Windows fatal exceptions&lt;/h2&gt;
&lt;p&gt;I enhanced the faulthandler.enable() function on Windows to set a
handler for Windows fatal exceptions using &lt;tt class="docutils literal"&gt;AddVectoredExceptionHandler()&lt;/tt&gt;
(issue #23848).&lt;/p&gt;
&lt;p&gt;Windows exceptions are the native way to handle fatal errors on Windows,
whereas UNIX signals SIGSEGV, SIGFPE and SIGABRT are &amp;quot;emulated&amp;quot; on top of that.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-pythonmalloc-environment-variable"&gt;
&lt;h2&gt;New PYTHONMALLOC environment variable&lt;/h2&gt;
&lt;p&gt;I added a new &lt;tt class="docutils literal"&gt;PYTHONMALLOC&lt;/tt&gt; environment variable (issue #26516) to set the
Python memory allocators.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;PYTHONMALLOC=debug&lt;/tt&gt; enables debug hooks on a Python compiled in release
mode, whereas Python 3.5 requires to recompile Python in debug mode. These
hooks implements various checks:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Detect &lt;strong&gt;buffer underflow&lt;/strong&gt;: write before the start of the buffer&lt;/li&gt;
&lt;li&gt;Detect &lt;strong&gt;buffer overflow&lt;/strong&gt;: write after the end of the buffer&lt;/li&gt;
&lt;li&gt;Detect API violations, ex: &lt;tt class="docutils literal"&gt;PyObject_Free()&lt;/tt&gt; called on a buffer
allocated by &lt;tt class="docutils literal"&gt;PyMem_Malloc()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;Check if the GIL is held when allocator functions of PYMEM_DOMAIN_OBJ (ex:
&lt;tt class="docutils literal"&gt;PyObject_Malloc()&lt;/tt&gt;) and PYMEM_DOMAIN_MEM (ex: &lt;tt class="docutils literal"&gt;PyMem_Malloc()&lt;/tt&gt;) domains
are called&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Moreover, logging a fatal memory error now uses the tracemalloc module to get
the traceback where a memory block was allocated. Example of a buffer overflow
using &lt;tt class="docutils literal"&gt;python3.6 &lt;span class="pre"&gt;-X&lt;/span&gt; tracemalloc=5&lt;/tt&gt; (store 5 frames in traces):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Debug memory block at address p=0x7fbcd41666f8: API 'o'
    4 bytes originally requested
    The 7 pad bytes at p-7 are FORBIDDENBYTE, as expected.
    The 8 pad bytes at tail=0x7fbcd41666fc are not all FORBIDDENBYTE (0xfb):
        at tail+0: 0x02 *** OUCH
        at tail+1: 0xfb
        at tail+2: 0xfb
        ...
    The block was made by call #1233329 to debug malloc/realloc.
    Data at p: 1a 2b 30 00

Memory block allocated at (most recent call first):
  File &amp;quot;test/test_bytes.py&amp;quot;, line 323
  File &amp;quot;unittest/case.py&amp;quot;, line 600
  ...

Fatal Python error: bad trailing pad byte

Current thread 0x00007fbcdbd32700 (most recent call first):
  File &amp;quot;test/test_bytes.py&amp;quot;, line 323 in test_hex
  File &amp;quot;unittest/case.py&amp;quot;, line 600 in run
  ...
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;PYTHONMALLOC=malloc&lt;/tt&gt; forces the usage of the system &lt;tt class="docutils literal"&gt;malloc()&lt;/tt&gt; allocator.
This option can be used with Valgrind. Without this option, Valgrind emits tons
of false alarms in the Python &lt;tt class="docutils literal"&gt;pymalloc&lt;/tt&gt; memory allocator.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="tracemalloc-new-c-api-and-support-multiple-address-spaces"&gt;
&lt;h2&gt;tracemalloc: new C API and support multiple address spaces&lt;/h2&gt;
&lt;p&gt;Antoine Pitrou and Nathaniel Smith asked me to enhance the tracemalloc module:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Add a C API to be able to manually track/untrack memory blocks, to track
the memory allocated by custom memory allocators. For example, numpy uses
allocators with a specific memory alignment for SIMD instructions.&lt;/li&gt;
&lt;li&gt;Support tracking memory of different address spaces. For example, central
(CPU) memory and GPU memory for numpy.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="section" id="support-multiple-address-spaces"&gt;
&lt;h3&gt;Support multiple address spaces&lt;/h3&gt;
&lt;p&gt;I made deep changes in the &lt;tt class="docutils literal"&gt;hashtable.c&lt;/tt&gt; code (simple C implementation of an
hash table used by &lt;tt class="docutils literal"&gt;_tracemalloc&lt;/tt&gt;) to support keys of a variable size (issue
#26588), instead of using an hardcoded &lt;tt class="docutils literal"&gt;void *&lt;/tt&gt; size. It allows to support
keys larger than &lt;tt class="docutils literal"&gt;sizeof(void*)&lt;/tt&gt;, but also to use &lt;em&gt;less&lt;/em&gt; memory for keys
smaller than &lt;tt class="docutils literal"&gt;sizeof(void*)&lt;/tt&gt; (ex: &lt;tt class="docutils literal"&gt;int&lt;/tt&gt; keys).&lt;/p&gt;
&lt;p&gt;Then I extended the C &lt;tt class="docutils literal"&gt;_tracemalloc&lt;/tt&gt; module and the Python &lt;tt class="docutils literal"&gt;tracemalloc&lt;/tt&gt; to
add a new &lt;tt class="docutils literal"&gt;domain&lt;/tt&gt; attribute to traces: add &lt;tt class="docutils literal"&gt;Trace.domain&lt;/tt&gt; attribute and
&lt;tt class="docutils literal"&gt;tracemalloc.DomainFilter&lt;/tt&gt; class.&lt;/p&gt;
&lt;p&gt;The final step was to optimize the memory footprint of _tracemalloc. Start with
compact keys (&lt;tt class="docutils literal"&gt;Py_uintptr_t&lt;/tt&gt; type) and only switch to &lt;tt class="docutils literal"&gt;pointer_t&lt;/tt&gt; keys when
the first memory block with a non-zero domain is tracked (when one more one
address space is used). So the &lt;tt class="docutils literal"&gt;_tracemalloc&lt;/tt&gt; memory usage doesn't change by
default in Python 3.6!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="c-api"&gt;
&lt;h3&gt;C API&lt;/h3&gt;
&lt;p&gt;I added a private C API (issue #26530):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
int _PyTraceMalloc_Track(_PyTraceMalloc_domain_t domain, Py_uintptr_t ptr, size_t size);
int _PyTraceMalloc_Untrack(_PyTraceMalloc_domain_t domain, Py_uintptr_t ptr);
&lt;/pre&gt;
&lt;p&gt;I waited for Antoine and Nathaniel feedback on this API, but the API remains
private in Python 3.6 since none reviewed it.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="resourcewarning-warnings-now-come-with-a-traceback"&gt;
&lt;h2&gt;ResourceWarning warnings now come with a traceback&lt;/h2&gt;
&lt;div class="section" id="final-result"&gt;
&lt;h3&gt;Final result&lt;/h3&gt;
&lt;p&gt;Before going to explain the long development of the feature, let's see an
example of the final result! Example with the script &lt;tt class="docutils literal"&gt;example.py&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
import warnings

def func():
    return open(__file__)

f = func()
f = None
&lt;/pre&gt;
&lt;p&gt;Output of the command &lt;tt class="docutils literal"&gt;python3.6 &lt;span class="pre"&gt;-Wd&lt;/span&gt; &lt;span class="pre"&gt;-X&lt;/span&gt; tracemalloc=5 example.py&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
example.py:7: ResourceWarning: unclosed file &amp;lt;_io.TextIOWrapper name='example.py' mode='r' encoding='UTF-8'&amp;gt;
  f = None
Object allocated at (most recent call first):
  File &amp;quot;example.py&amp;quot;, lineno 4
    return open(__file__)
  File &amp;quot;example.py&amp;quot;, lineno 6
    f = func()
&lt;/pre&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;Object allocated at &lt;span class="pre"&gt;(...)&lt;/span&gt;&lt;/tt&gt; part is the new feature ;-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="add-source-parameter-to-warnings"&gt;
&lt;h3&gt;Add source parameter to warnings&lt;/h3&gt;
&lt;p&gt;Python 3 logs &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; warnings when a resource is not closed
properly to help developers to handle resources correctly. The problem is that
the warning is only logged when the object is destroy, which can occur far from
the object creation and can occur on a line unrelated to the object because of
the garbage collector.&lt;/p&gt;
&lt;p&gt;I added a new &lt;tt class="docutils literal"&gt;tracemalloc&lt;/tt&gt; module to Python 3.4 which has an interesting
&lt;tt class="docutils literal"&gt;tracemalloc.get_object_traceback()&lt;/tt&gt; function. If tracemalloc traced the
allocation of an object, it is able to provide later the traceback where the
object was allocated.&lt;/p&gt;
&lt;p&gt;I wanted to modify the &lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; module to call
&lt;tt class="docutils literal"&gt;get_object_traceback()&lt;/tt&gt;, but I noticed that it wasn't possible
to easily extend the &lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; API because this module allows to override
&lt;tt class="docutils literal"&gt;showwarning()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;formatwarning()&lt;/tt&gt; functions and these
functions have a fixed number of parameters. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def showwarning(message, category, filename, lineno, file=None, line=None):
    ...
&lt;/pre&gt;
&lt;p&gt;With the issue #26568, I added new  &lt;tt class="docutils literal"&gt;_showwarnmsg()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;_formatwarnmsg()&lt;/tt&gt;
functions to the warnings module which get a &lt;tt class="docutils literal"&gt;warnings.WarningMessage&lt;/tt&gt; object
instead of a list of parameters:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def _showwarnmsg(msg):
    ...
&lt;/pre&gt;
&lt;p&gt;I added a &lt;tt class="docutils literal"&gt;source&lt;/tt&gt; attribute to &lt;tt class="docutils literal"&gt;warnings.WarningMessage&lt;/tt&gt; (issue #26567)
and a new optional &lt;tt class="docutils literal"&gt;source&lt;/tt&gt; parameter to &lt;tt class="docutils literal"&gt;warnings.warn()&lt;/tt&gt; (issue #26604):
the leaked resource object. I modified &lt;tt class="docutils literal"&gt;_formatwarnmsg()&lt;/tt&gt; to log the
traceback where resource was allocated, if available.&lt;/p&gt;
&lt;p&gt;The tricky part was to fix corner cases when the following functions of the
&lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; module are overriden:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;formatwarning()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;showwarning()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;_formatwarnmsg()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;_showwarnmsg()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="set-the-source-parameter"&gt;
&lt;h3&gt;Set the source parameter&lt;/h3&gt;
&lt;p&gt;I started to modify modules to set the source parameter when logging
&lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; warnings.&lt;/p&gt;
&lt;p&gt;The easy part was to modify &lt;tt class="docutils literal"&gt;asyncore&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;asyncio&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;_pyio&lt;/tt&gt; modules to
set the &lt;tt class="docutils literal"&gt;source&lt;/tt&gt; parameter. These modules are implemented in Python, the
change was just to add &lt;tt class="docutils literal"&gt;source=self&lt;/tt&gt;. Example of &lt;tt class="docutils literal"&gt;asyncio&lt;/tt&gt; destructor:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def __del__(self):
    if not self.is_closed():
        warnings.warn(&amp;quot;unclosed event loop %r&amp;quot; % self, ResourceWarning,
                      source=self)
        if not self.is_running():
            self.close()
&lt;/pre&gt;
&lt;p&gt;Note: The warning is logged before the resource is closed to provide more
information in &lt;tt class="docutils literal"&gt;repr()&lt;/tt&gt;. Many objects clear most information in their
&lt;tt class="docutils literal"&gt;close()&lt;/tt&gt; method.&lt;/p&gt;
&lt;p&gt;Modifying C modules was more tricky than expected. I had to implement
&amp;quot;finalizers&amp;quot; (&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0442/"&gt;PEP 432: Safe object finalization&lt;/a&gt;) for the &lt;tt class="docutils literal"&gt;_socket.socket&lt;/tt&gt; type
(issue #26590) and for the &lt;tt class="docutils literal"&gt;os.scandir()&lt;/tt&gt; iterator (issue #26603).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="more-reliable-warnings"&gt;
&lt;h3&gt;More reliable warnings&lt;/h3&gt;
&lt;p&gt;The Python shutdown process is complex, and some Python functions are broken
during the shutdown. I enhanced the warnings module to handle nicely these
failures and try to log warnings anyway.&lt;/p&gt;
&lt;p&gt;I modified &lt;tt class="docutils literal"&gt;warnings.formatwarning()&lt;/tt&gt; to catch &lt;tt class="docutils literal"&gt;linecache.getline()&lt;/tt&gt;
failures on formatting the traceback.&lt;/p&gt;
&lt;p&gt;Logging the resource traceback is complex, so I only implemented it in Python.
Python tries to use the Python &lt;tt class="docutils literal"&gt;warnings&lt;/tt&gt; module if it was imported, or falls
back on the C &lt;tt class="docutils literal"&gt;_warnings&lt;/tt&gt; module. To get the resource traceback at Python
shutdown, I modified the C module to try to import the Python warning:
&lt;tt class="docutils literal"&gt;_warnings.warn_explicit()&lt;/tt&gt; now tries to import the Python warnings module if
the source parameter is set to be able to log the traceback where the source
was allocated (issue #26592).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-resourcewarning-warnings"&gt;
&lt;h3&gt;Fix ResourceWarning warnings&lt;/h3&gt;
&lt;p&gt;Since it became easy to debug these warnings, I fixed some of them in the
Python test suite:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #26620: Fix ResourceWarning in test_urllib2_localnet. Use context
manager on urllib objects and use self.addCleanup() to cleanup resources even
if a test is interrupted with CTRL+c&lt;/li&gt;
&lt;li&gt;Issue #25654: multiprocessing: open file with &lt;tt class="docutils literal"&gt;closefd=False&lt;/tt&gt; to avoid
ResourceWarning. _test_multiprocessing: open file with &lt;tt class="docutils literal"&gt;O_EXCL&lt;/tt&gt; to detect
bugs in tests (if a previous test forgot to remove TESTFN).
&lt;tt class="docutils literal"&gt;test_sys_exit()&lt;/tt&gt;: remove TESTFN after each loop iteration&lt;/li&gt;
&lt;li&gt;Fix &lt;tt class="docutils literal"&gt;ResourceWarning&lt;/tt&gt; in test_unittest when interrupted&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="pymem-malloc-now-fails-if-the-gil-is-not-held"&gt;
&lt;h2&gt;PyMem_Malloc() now fails if the GIL is not held&lt;/h2&gt;
&lt;p&gt;Since using the mall object allocator (&lt;tt class="docutils literal"&gt;pymalloc)&lt;/tt&gt;) for dictionary key
storage showed speedup for the dict type (issue #23601), I proposed to
generalize the change, use &lt;tt class="docutils literal"&gt;pymalloc&lt;/tt&gt; for &lt;tt class="docutils literal"&gt;PyMem_Malloc()&lt;/tt&gt;: &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2016-February/143084.html"&gt;[Python-Dev]
Modify PyMem_Malloc to use pymalloc for performance&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The main issue was that the change means that &lt;tt class="docutils literal"&gt;PyMem_Malloc()&lt;/tt&gt; now requires
to hold the GIL, whereas it didn't before since it called directly
&lt;tt class="docutils literal"&gt;malloc()&lt;/tt&gt;.&lt;/p&gt;
&lt;div class="section" id="check-if-the-gil-is-held"&gt;
&lt;h3&gt;Check if the GIL is held&lt;/h3&gt;
&lt;p&gt;CPython has a &lt;tt class="docutils literal"&gt;PyGILState_Check()&lt;/tt&gt; function to check if the GIL is held.
Problem: the function doesn't work with subinterpreters: see issues #10915 and
#15751.&lt;/p&gt;
&lt;p&gt;I added an internal flag to &lt;tt class="docutils literal"&gt;PyGILState_Check()&lt;/tt&gt; (issue #26558) to skip the
test. The flag value is false at startup, set to true once the GIL is fully
initialized (Python initialization), set to false again when the GIL is
destroyed (Python finalization). The flag is also set to false when the first
subinterpreter is created.&lt;/p&gt;
&lt;p&gt;This hack works around &lt;tt class="docutils literal"&gt;PyGILState_Check()&lt;/tt&gt; limitations allowing to call
&lt;cite&gt;PyGILState_Check()`&lt;/cite&gt; anytime to debug more bugs earlier.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;_Py_dup()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;_Py_fstat()&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;_Py_read()&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;_Py_write()&lt;/tt&gt; are
low-level helper functions for system functions, but these functions require
the GIL to be held.  Thanks to the &lt;tt class="docutils literal"&gt;PyGILState_Check()&lt;/tt&gt; enhancement, it
became possible to check the GIL using an assertion.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pymem-malloc-and-gil"&gt;
&lt;h3&gt;PyMem_Malloc() and GIL&lt;/h3&gt;
&lt;p&gt;Issue #26563: Debug hooks on Python memory allocators now raise a fatal error
if memory allocator functions like PyMem_Malloc() and PyMem_Malloc() are called
without holding the GIL.&lt;/p&gt;
&lt;p&gt;The change spotted two bugs which I fixed:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #26563: Replace PyMem_Malloc() with PyMem_RawMalloc() in the Windows
implementation of os.stat(), the code is called without holding the
GIL.&lt;/li&gt;
&lt;li&gt;Issue #26563: Fix usage of PyMem_Malloc() in overlapped.c. Replace
PyMem_Malloc() with PyMem_RawFree() since PostToQueueCallback() calls
PyMem_Free() in a new C thread which doesn't hold the GIL.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I wasn't able to switch &lt;tt class="docutils literal"&gt;PyMem_Malloc()&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;pymalloc&lt;/tt&gt; in this quarter,
since it took more a lot of time to implement requested checks and test third
party modules.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fatal-error-and-faulthandler"&gt;
&lt;h3&gt;Fatal error and faulthandler&lt;/h3&gt;
&lt;p&gt;I enhanced the faulthandler module to work in non-Python threads (issue
#26563). I fixed &lt;tt class="docutils literal"&gt;Py_FatalError()&lt;/tt&gt; if called without holding the GIL: don't
try to print the current exception, nor try to flush stdout and stderr: only
dump the traceback of Python threads.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="interesting-bug-reentrant-flag-in-tracemalloc"&gt;
&lt;h2&gt;Interesting bug: reentrant flag in tracemalloc&lt;/h2&gt;
&lt;p&gt;A bug annoyed me a lot: a random assertion error related to a reentrant flag in
the _tracemalloc module.&lt;/p&gt;
&lt;p&gt;Story starting in the &lt;a class="reference external" href="http://bugs.python.org/issue26588#msg262125"&gt;middle of the issue #26588 (2016-03-21)&lt;/a&gt;. While working on issue #26588,
&amp;quot;_tracemalloc: add support for multiple address spaces (domains)&amp;quot;, I noticed an
assertion failure in set_reentrant(), a helper function to set a &lt;em&gt;Thread Local
Storage&lt;/em&gt; (TLS), on a buildbot:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
python: ./Modules/_tracemalloc.c:195: set_reentrant:
    Assertion `PyThread_get_key_value(tracemalloc_reentrant_key) == ((PyObject *) &amp;amp;_Py_TrueStruct)' failed.
&lt;/pre&gt;
&lt;p&gt;I was unable to reproduce the bug on my Fedora 23 (AMD64). After changes on my
patch, I pushed it the day after, but the assertion failed again. I added
assertions and debug informations. More failures, an interesting one on Windows
which uses a single process.&lt;/p&gt;
&lt;p&gt;I added an assertion in tracemalloc_init() to ensure that the reeentrant flag
is set at the end of the function. The reentrant flag was no more set at
tracemalloc_start() entry for an unknown reason. I changed the module
initialization to no call tracemalloc_init() anymore, it's only called on
tracemalloc.start().&lt;/p&gt;
&lt;p&gt;&amp;quot;The bug was seen on 5 buildbots yet: PPC Fedora, AMD64 Debian, s390x RHEL,
AMD64 Windows, x86 Ubuntu.&amp;quot;&lt;/p&gt;
&lt;p&gt;I finally understood and fixed the bug with the &lt;a class="reference external" href="https://hg.python.org/cpython/rev/af1c1149784a"&gt;change af1c1149784a&lt;/a&gt;: tracemalloc_start() and
tracemalloc_stop() don't clear/set the reentrant flag anymore.&lt;/p&gt;
&lt;p&gt;The problem was that I expected that tracemalloc_init() and tracemalloc_start()
functions would always be called in the same thread, whereas it occurred that
tracemalloc_init() was called in thread A when the tracemalloc module is
imported, whereas tracemalloc_start() was called in thread B.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="other-commits"&gt;
&lt;h2&gt;Other commits&lt;/h2&gt;
&lt;div class="section" id="enhancements"&gt;
&lt;h3&gt;Enhancements&lt;/h3&gt;
&lt;p&gt;The developers of the &lt;tt class="docutils literal"&gt;vmprof&lt;/tt&gt; profiler asked me to expose the atomic
variable &lt;tt class="docutils literal"&gt;_PyThreadState_Current&lt;/tt&gt;. The private variable was removed from
Python 3.5.1 API because the implementation of atomic variables depends on the
compiler, compiler options, etc. and so caused compilation issues. I added a
new private &lt;tt class="docutils literal"&gt;_PyThreadState_UncheckedGet()&lt;/tt&gt; function (issue #26154) which
gets the value of the variable without exposing its implementation.&lt;/p&gt;
&lt;p&gt;Other enhancements:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #26099: The site module now writes an error into stderr if
sitecustomize module can be imported but executing the module raise an
ImportError. Same change for usercustomize.&lt;/li&gt;
&lt;li&gt;Issue #26516: Enhance Python memory allocators documentation. Add link to
PYTHONMALLOCSTATS environment variable. Add parameters to PyMem macros like
PyMem_MALLOC().&lt;/li&gt;
&lt;li&gt;Issue #26569: Fix pyclbr.readmodule() and pyclbr.readmodule_ex() to support
importing packages.&lt;/li&gt;
&lt;li&gt;Issue #26564, #26516, #26563: Enhance documentation on memory allocator debug
hooks.&lt;/li&gt;
&lt;li&gt;doctest now supports packages. Issue #26641: doctest.DocFileTest and
doctest.testfile() now support packages (module splitted into multiple
directories) for the package parameter.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="bugfixes"&gt;
&lt;h3&gt;Bugfixes&lt;/h3&gt;
&lt;p&gt;Issue #25843: When compiling code, don't merge constants if they are equal but
have a different types. For example, &lt;tt class="docutils literal"&gt;f1, f2 = lambda: 1, lambda: 1.0&lt;/tt&gt; is now
correctly compiled to two different functions: &lt;tt class="docutils literal"&gt;f1()&lt;/tt&gt; returns &lt;tt class="docutils literal"&gt;1&lt;/tt&gt; (int) and
&lt;tt class="docutils literal"&gt;f2()&lt;/tt&gt; returns &lt;tt class="docutils literal"&gt;1.0&lt;/tt&gt; (int), even if 1 and 1.0 are equal.&lt;/p&gt;
&lt;p&gt;Other fixes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #26101: Fix test_compilepath() of test_compileall. Exclude Lib/test/
from sys.path in test_compilepath(). The directory contains invalid Python
files like Lib/test/badsyntax_pep3120.py, whereas the test ensures that all
files can be compiled.&lt;/li&gt;
&lt;li&gt;Issue #24520: Replace fpgetmask() with fedisableexcept(). On FreeBSD,
fpgetmask() was deprecated long time ago.  fedisableexcept() is now
preferred.&lt;/li&gt;
&lt;li&gt;Issue #26161: Use Py_uintptr_t instead of void* for atomic pointers in
pyatomic.h. Use atomic_uintptr_t when &amp;lt;stdatomic.h&amp;gt; is used. Using void*
causes compilation warnings depending on which implementation of atomic types
is used.&lt;/li&gt;
&lt;li&gt;Issue #26637: The importlib module now emits an ImportError rather than a
TypeError if __import__() is tried during the Python shutdown process but
sys.path is already cleared (set to None).&lt;/li&gt;
&lt;li&gt;doctest: fix _module_relative_path() error message. Write the module name
rather than &amp;lt;module&amp;gt; in the error message, if module has no __file__
attribute (ex: package).&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="fix-type-downcasts-on-windows-64-bit"&gt;
&lt;h3&gt;Fix type downcasts on Windows 64-bit&lt;/h3&gt;
&lt;p&gt;In my spare time, I'm trying to fix a few compiler warnings on Windows 64-bit
where the C &lt;tt class="docutils literal"&gt;long&lt;/tt&gt; type is only 32-bit, whereas pointers are &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;64-bit&lt;/span&gt;&lt;/tt&gt; long:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;posix_getcwd(): limit to INT_MAX on Windows. It's more to fix a compiler
warning during compilation, I don't think that Windows support current
working directories larger than 2 GB :-)&lt;/li&gt;
&lt;li&gt;_pickle: Fix load_counted_tuple(), use Py_ssize_t for size. Fix a warning on
Windows 64-bit.&lt;/li&gt;
&lt;li&gt;getpathp.c: fix compiler warning, wcsnlen_s() result type is size_t.&lt;/li&gt;
&lt;li&gt;compiler.c: fix compiler warnings on Windows&lt;/li&gt;
&lt;li&gt;_msi.c: try to fix compiler warnings&lt;/li&gt;
&lt;li&gt;longobject.c: fix compilation warning on Windows 64-bit. We know that
Py_SIZE(b) is -1 or 1 an so fits into the sdigit type.&lt;/li&gt;
&lt;li&gt;On Windows, socket.setsockopt() now raises an OverflowError if the socket
option is larger than INT_MAX bytes.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="unicode-bugfixes"&gt;
&lt;h3&gt;Unicode bugfixes&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #26227: On Windows, getnameinfo(), gethostbyaddr() and
gethostbyname_ex() functions of the socket module now decode the hostname
from the ANSI code page rather than UTF-8.&lt;/li&gt;
&lt;li&gt;Issue #26217: Unicode resize_compact() must set wstr_length to 0 after
freeing the wstr string. Otherwise, an assertion fails in
_PyUnicode_CheckConsistency().&lt;/li&gt;
&lt;li&gt;Issue #26464: Fix str.translate() when string is ASCII and first replacements
removes characters, but next replacements use a non-ASCII character or a
string longer than 1 character. Regression introduced in Python 3.5.0.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="buildbot-tests"&gt;
&lt;h3&gt;Buildbot, tests&lt;/h3&gt;
&lt;p&gt;Just to give you an idea of the work required to keep a working CI, here is the
list of changes I maded in a single quarter to make tests and Python buildbots
more reliable.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #26610: Skip test_venv.test_with_pip() if ctypes miss&lt;/li&gt;
&lt;li&gt;test_asyncio: fix test_timeout_time(). Accept time delta up to 0.12 second,
instead of 0.11, for the &amp;quot;AMD64 FreeBSD 9.x&amp;quot; buildbot slave.&lt;/li&gt;
&lt;li&gt;Issue #13305: Always test datetime.datetime.strftime(&amp;quot;%4Y&amp;quot;) for years &amp;lt; 1900.
Change quickly reverted, strftime(&amp;quot;%4Y&amp;quot;) fails on most platforms.&lt;/li&gt;
&lt;li&gt;Issue #17758: Skip test_site if site.USER_SITE directory doesn't exist and
cannot be created.&lt;/li&gt;
&lt;li&gt;Fix test_venv on FreeBSD buildbot. Ignore pip warning in
test_venv.test_with_venv().&lt;/li&gt;
&lt;li&gt;Issue #26566: Rewrite test_signal.InterProcessSignalTests. Don't use
os.fork() with a subprocess to not inherit existing signal handlers or
threads: start from a fresh process. Use a timeout of 10 seconds to wait for
the signal instead of 1 second&lt;/li&gt;
&lt;li&gt;Issue #26538: regrtest: Fix module.__path__. libregrtest: Fix setup_tests()
to keep module.__path__ type (_NamespacePath), don't convert to a list.
Add _NamespacePath.__setitem__() method to importlib._bootstrap_external.&lt;/li&gt;
&lt;li&gt;regrtest: add time to output. Timestamps should help to debug slow buildbots,
and timeout and hang on buildbots.&lt;/li&gt;
&lt;li&gt;regrtest: add timeout to main process when using -jN. libregrtest: add a
watchdog to run_tests_multiprocess() using faulthandler.dump_traceback_later().&lt;/li&gt;
&lt;li&gt;Makefile: change default value of TESTTIMEOUT from 1 hour to 15 min.
The whole test suite takes 6 minutes on my laptop. It takes less than 30
minutes on most buildbots. The TESTTIMEOUT is the timeout for a single test
file.&lt;/li&gt;
&lt;li&gt;Buildbots: change also Windows timeout from 1 hour to 15 min&lt;/li&gt;
&lt;li&gt;regrtest: display test duration in sequential mode. Only display duration if
a test takes more than 30 seconds.&lt;/li&gt;
&lt;li&gt;Issue #18787: Try to fix test_spwd on OpenIndiana. Try to get the &amp;quot;root&amp;quot;
entry which should exist on all UNIX instead of &amp;quot;bin&amp;quot; which doesn't exist on
OpenIndiana.&lt;/li&gt;
&lt;li&gt;regrtest: fix --fromfile feature. Update code for the name regrtest output
format. Enhance also test_regrtest test on --fromfile&lt;/li&gt;
&lt;li&gt;regrtest: mention if tests run sequentially or in parallel&lt;/li&gt;
&lt;li&gt;regrtest: when parallel tests are interrupted, display progress&lt;/li&gt;
&lt;li&gt;support.temp_dir(): call support.rmtree() instead of shutil.rmtree(). Try
harder to remove directories on Windows.&lt;/li&gt;
&lt;li&gt;rt.bat: use -m test instead of Libtestregrtest.py&lt;/li&gt;
&lt;li&gt;Refactor regrtest.&lt;/li&gt;
&lt;li&gt;Fix test_warnings.test_improper_option(). test_warnings: only run
test_improper_option() and test_warnings_bootstrap() once. The unit test
doesn't depend on self.module.&lt;/li&gt;
&lt;li&gt;Fix test_os.test_symlink(): remove created symlink.&lt;/li&gt;
&lt;li&gt;Issue #26643: Add missing shutil resources to regrtest.py&lt;/li&gt;
&lt;li&gt;test_urllibnet: set timeout on test_fileno(). Use the default timeout of 30
seconds to avoid blocking forever.&lt;/li&gt;
&lt;li&gt;Issue #26295: When using &amp;quot;python3 -m test --testdir=TESTDIR&amp;quot;, regrtest
doesn't add &amp;quot;test.&amp;quot; prefix to test module names. regrtest also prepends
testdir to sys.path.&lt;/li&gt;
&lt;li&gt;Issue #26295: test_regrtest now uses a temporary directory&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="contributions"&gt;
&lt;h3&gt;Contributions&lt;/h3&gt;
&lt;p&gt;I also pushed a few changes written by other contributors:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #25907: Use {% trans %} tags in HTML templates to ease the translation
of the documentation. The tag comes from Jinja templating system, used by
Sphinx. Patch written by &lt;strong&gt;Julien Palard&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #26248: Enhance os.scandir() doc, patch written by Ben Hoyt:&lt;/li&gt;
&lt;li&gt;Fix error message in asyncio.selector_events. Patch written by &lt;strong&gt;Carlo
Beccarini&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #16851: Fix inspect.ismethod() doc, return also True if object is an
unbound method. Patch written by &lt;strong&gt;Anna Koroliuk&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #26574: Optimize bytes.replace(b'', b'.') and bytearray.replace(b'', b'.'):
up to 80% faster. Patch written by &lt;strong&gt;Josh Snider&lt;/strong&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>Analysis of a Python performance issue</title><link href="https://vstinner.github.io/analysis-python-performance-issue.html" rel="alternate"></link><published>2016-11-19T00:30:00+01:00</published><updated>2016-11-19T00:30:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-11-19:/analysis-python-performance-issue.html</id><summary type="html">&lt;p&gt;I am working on the CPython benchmark suite (&lt;a class="reference external" href="https://github.com/python/performance"&gt;performance&lt;/a&gt;) and I run the benchmark suite to
upload results to &lt;a class="reference external" href="http://speed.python.org/"&gt;speed.python.org&lt;/a&gt;. While
analying results, I noticed a temporary peak on the &lt;tt class="docutils literal"&gt;call_method&lt;/tt&gt;
benchmark at October 19th:&lt;/p&gt;
&lt;img alt="call_method microbenchmark" src="https://vstinner.github.io/images/call_method.png" /&gt;
&lt;p&gt;The graphic shows the performance of the &lt;tt class="docutils literal"&gt;call_method&lt;/tt&gt; microbenchmark between
Feb 29, 2016 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I am working on the CPython benchmark suite (&lt;a class="reference external" href="https://github.com/python/performance"&gt;performance&lt;/a&gt;) and I run the benchmark suite to
upload results to &lt;a class="reference external" href="http://speed.python.org/"&gt;speed.python.org&lt;/a&gt;. While
analying results, I noticed a temporary peak on the &lt;tt class="docutils literal"&gt;call_method&lt;/tt&gt;
benchmark at October 19th:&lt;/p&gt;
&lt;img alt="call_method microbenchmark" src="https://vstinner.github.io/images/call_method.png" /&gt;
&lt;p&gt;The graphic shows the performance of the &lt;tt class="docutils literal"&gt;call_method&lt;/tt&gt; microbenchmark between
Feb 29, 2016 and November 17, 2016 on the &lt;tt class="docutils literal"&gt;default&lt;/tt&gt; branch of CPython. The average
is around 17.2 ms, whereas the peak is at 29.0 ms: &lt;strong&gt;68% slower&lt;/strong&gt;!&lt;/p&gt;
&lt;p&gt;The server has two &amp;quot;Intel(R) Xeon(R) CPU X5680  &amp;#64; 3.33GHz&amp;quot; CPUs, total: 24
logical cores (12 physical cores with HyperThreading). This CPU was launched in
2010 and based on the &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Gulftown"&gt;Westmere-EP microarchitecture&lt;/a&gt;. Westmere-EP is based on Westmere,
which is the 32 nm shrink of the Nehalem microarchitecture.&lt;/p&gt;
&lt;div class="section" id="reproduce-results"&gt;
&lt;h2&gt;Reproduce results&lt;/h2&gt;
&lt;p&gt;Before going too far, the first step is to validate that results are
reproductible: reboot the computer, recompile Python, run again the benchmark.&lt;/p&gt;
&lt;p&gt;Instead of running the full benchmark suite, install Python, ..., we will run
directly the benchmark manually using the Python freshly built in its source
code directory.&lt;/p&gt;
&lt;p&gt;Interesting dots on the graphic (can be seen at speed.python.org, not on the
screenshot):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;678fe178da0d, Oct 09, 17.0 ms: &amp;quot;Fast&amp;quot;&lt;/li&gt;
&lt;li&gt;1ce50f7027c1, Oct 19, 28.9 ms: &amp;quot;Slow&amp;quot;&lt;/li&gt;
&lt;li&gt;36af3566b67a, Nov 3, 16.9 ms: Fast again&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I use the following directories:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;~/perf: GitHub haypo/perf project&lt;/li&gt;
&lt;li&gt;~/performance: GitHub python/performance project&lt;/li&gt;
&lt;li&gt;~/cpython: Mercurial CPython repository&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Tune the system for benchmarks:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo python3 -m perf system tune
&lt;/pre&gt;
&lt;p&gt;Note: all &lt;tt class="docutils literal"&gt;system&lt;/tt&gt; commands in this article are optional. They help to reduce
the operating system jitter (make benchmarks more reliablee).&lt;/p&gt;
&lt;p&gt;Fast:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ hg up -C -r 678fe178da0d
$ ./configure --with-lto -C &amp;amp;&amp;amp; make clean &amp;amp;&amp;amp; make
$ mv python python-fast
$ PYTHONPATH=~/perf ./python-fast ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --fast
call_method: Median +- std dev: 17.0 ms +- 0.1 ms
&lt;/pre&gt;
&lt;p&gt;Slow:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ hg up -C -r 1ce50f7027c1
$ ./configure --with-lto -C &amp;amp;&amp;amp; make clean &amp;amp;&amp;amp; make
$ mv python python-slow
$ PYTHONPATH=~/perf ./python-slow ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --fast
call_method: Median +- std dev: 29.3 ms +- 0.9 ms
&lt;/pre&gt;
&lt;p&gt;We reproduced the significant benchmark result: 17 ms =&amp;gt; 29 ms.&lt;/p&gt;
&lt;p&gt;I use &lt;tt class="docutils literal"&gt;./configure&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;make clean&lt;/tt&gt; instead of incremental compilation,
&lt;tt class="docutils literal"&gt;make&lt;/tt&gt; command, to avoid compilation errors, and to avoid potential side
effects only caused by the incremental compilation.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="analysis-with-the-linux-perf-tool"&gt;
&lt;h2&gt;Analysis with the Linux perf tool&lt;/h2&gt;
&lt;p&gt;To collect perf events, we will run the benchmark with &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--worker&lt;/span&gt;&lt;/tt&gt; to run a
single process and with &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-w0&lt;/span&gt; &lt;span class="pre"&gt;-n100&lt;/span&gt;&lt;/tt&gt; to run the benchmark long enough: 100
samples means at least 10 seconds (a single sample takes at least 100 ms).&lt;/p&gt;
&lt;p&gt;First, reset the system configuration to reset the Linux perf configuration:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo python3 -m perf system reset
&lt;/pre&gt;
&lt;p&gt;Note: &lt;tt class="docutils literal"&gt;python3 &lt;span class="pre"&gt;-m&lt;/span&gt; perf system tune&lt;/tt&gt; reduces the sampling rate of Linux perf
to reduce operating system jitter.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="perf-stat"&gt;
&lt;h2&gt;perf stat&lt;/h2&gt;
&lt;p&gt;Command to get general statistics on the benchmark:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ perf stat ./python-slow ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --worker -v -w0 -n100
&lt;/pre&gt;
&lt;p&gt;&amp;quot;Fast&amp;quot; results:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Performance counter stats for ./python-fast:

      3773.585194 task-clock (msec)         #    0.998 CPUs utilized
              369 context-switches          #    0.098 K/sec
                0 cpu-migrations            #    0.000 K/sec
            8,300 page-faults               #    0.002 M/sec
   12,981,234,867 cycles                    #    3.440 GHz                     [83.27%]
    1,460,980,720 stalled-cycles-frontend   #   11.25% frontend cycles idle    [83.36%]
      435,806,788 stalled-cycles-backend    #    3.36% backend  cycles idle    [66.72%]
   29,982,530,201 instructions              #    2.31  insns per cycle
                                            #    0.05  stalled cycles per insn [83.40%]
    5,613,631,616 branches                  # 1487.612 M/sec                   [83.40%]
       16,006,564 branch-misses             #    0.29% of all branches         [83.27%]

      3.780064486 seconds time elapsed
&lt;/pre&gt;
&lt;p&gt;&amp;quot;Slow&amp;quot; results:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Performance counter stats for ./python-slow:

      5906.239860 task-clock (msec)         #    0.998 CPUs utilized
              556 context-switches          #    0.094 K/sec
                0 cpu-migrations            #    0.000 K/sec
            8,393 page-faults               #    0.001 M/sec
   20,651,474,102 cycles                    #    3.497 GHz                     [83.36%]
    8,480,803,345 stalled-cycles-frontend   #   41.07% frontend cycles idle    [83.37%]
    4,247,826,420 stalled-cycles-backend    #   20.57% backend  cycles idle    [66.64%]
   30,011,465,614 instructions              #    1.45  insns per cycle
                                            #    0.28  stalled cycles per insn [83.32%]
    5,612,485,730 branches                  #  950.264 M/sec                   [83.36%]
       13,584,136 branch-misses             #    0.24% of all branches         [83.29%]

      5.915402403 seconds time elapsed
&lt;/pre&gt;
&lt;p&gt;Significant differences, Fast =&amp;gt; Slow:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Instruction per cycle: 2.31 =&amp;gt; 1.45&lt;/li&gt;
&lt;li&gt;stalled-cycles-frontend: &lt;strong&gt;11.25% =&amp;gt; 41.07%&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;stalled-cycles-backend: &lt;strong&gt;3.36% =&amp;gt; 20.57%&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The increase of stalled cycles is interesting. Since the code is supposed to be
identical, it probably means that fetching instructions is slower. It sounds
like an issue with CPU caches.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="statistics-on-the-cpu-l1-instruction-cache"&gt;
&lt;h2&gt;Statistics on the CPU L1 instruction cache&lt;/h2&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;perf list&lt;/tt&gt; command can be used to get the name of events collecting
statistics on the CPU L1 instruction cache:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ perf list | grep L1
  L1-icache-loads                                    [Hardware cache event]
  L1-icache-load-misses                              [Hardware cache event]
  (...)
&lt;/pre&gt;
&lt;p&gt;Collect statistics on the CPU L1 instruction cache:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PYTHONPATH=~/perf perf stat -e L1-icache-loads,L1-icache-load-misses ./python-slow ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --worker -w0 -n10
&lt;/pre&gt;
&lt;p&gt;&amp;quot;Fast&amp;quot; statistics:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Performance counter stats for './python-fast (...)':

   10,134,106,571 L1-icache-loads
       10,917,606 L1-icache-load-misses     #    0.11% of all L1-icache hits

      3.775067668 seconds time elapsed
&lt;/pre&gt;
&lt;p&gt;&amp;quot;Slow&amp;quot; statistics:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Performance counter stats for './python-slow (...)':

   10,753,371,258 L1-icache-loads
      848,511,308 L1-icache-load-misses     #    7.89% of all L1-icache hits

      6.020490449 seconds time elapsed
&lt;/pre&gt;
&lt;p&gt;Cache misses on the L1 cache: &lt;strong&gt;0.1%&lt;/strong&gt; (Fast) =&amp;gt; &lt;strong&gt;8.0%&lt;/strong&gt; (Slow).&lt;/p&gt;
&lt;p&gt;The slow Python has &lt;strong&gt;71.7x more L1 cache misses&lt;/strong&gt; than the fast Python! It can
explain the significant performance drop.&lt;/p&gt;
&lt;div class="section" id="perf-report"&gt;
&lt;h3&gt;perf report&lt;/h3&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;perf record&lt;/tt&gt; command can be used to collect statistics on the functions
where the benchmark spends most of its time. Commands:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PYTHONPATH=~/perf perf record ./python ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --worker -v -w0 -n100
perf report
&lt;/pre&gt;
&lt;p&gt;Output:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
40.27%  python  python              [.] _PyEval_EvalFrameDefault
10.30%  python  python              [.] call_function
10.21%  python  python              [.] PyFrame_New
 8.56%  python  python              [.] frame_dealloc
 5.51%  python  python              [.] PyObject_GenericGetAttr
 (...)
&lt;/pre&gt;
&lt;p&gt;More than 64% of the time is spent in these 5 functions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="system-tune"&gt;
&lt;h3&gt;system tune&lt;/h3&gt;
&lt;p&gt;To run benchmark, tune again the system for benchmarks:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo python3 -m perf system tune
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="hg-bisect"&gt;
&lt;h2&gt;hg bisect&lt;/h2&gt;
&lt;p&gt;To find the revision which introduces the performance slowdown, we use a
shell script to automate the bisection of the Mercurial history.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;cmd.sh&lt;/tt&gt; script checking if a revision is fast or slow:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
set -e -x
./configure --with-lto -C &amp;amp;&amp;amp; make clean &amp;amp;&amp;amp; make
rm -f json
PYTHONPATH=~/perf ./python ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --worker -o json -v
PYTHONPATH=~/perf python3 cmd.py json
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;cmd.sh&lt;/tt&gt; uses the following &lt;tt class="docutils literal"&gt;cmd.py&lt;/tt&gt; script which checks if the benchmark
is slow: if it takes longer than 23 ms (average between 17 ans 29 ms):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
import perf, sys
bench = perf.Benchmark.load('json')
bad = (29 + 17) / 2.0
ms = bench.median() * 1e3
if ms &amp;gt;= bad:
    print(&amp;quot;BAD! %.1f ms &amp;gt;= %.1f ms&amp;quot; % (ms, bad))
    sys.exit(1)
else:
    print(&amp;quot;good: %.1f ms &amp;lt; %.1f ms&amp;quot; % (ms, bad))
&lt;/pre&gt;
&lt;p&gt;In the bisection, &amp;quot;good&amp;quot; means &amp;quot;fast&amp;quot; (17 ms), whereas &amp;quot;bad&amp;quot; means &amp;quot;slow&amp;quot; (29
ms).  The peak, revision 1ce50f7027c1, is used as the first &amp;quot;bad&amp;quot; revision. The
previous fast revision before the peak is 678fe178da0d, our first &amp;quot;good&amp;quot;
revision.&lt;/p&gt;
&lt;p&gt;Commands to identify the first revision which introduced the slowdown:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg bisect --reset
hg bisect -b 1ce50f7027c1
hg bisect -g 678fe178da0d
time hg bisect -c ./cmd.sh
&lt;/pre&gt;
&lt;p&gt;3 min 52 sec later:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
The first bad revision is:
changeset:   104531:83877018ef97
parent:      104528:ce85a1f129e3
parent:      104530:2d352bf2b228
user:        Serhiy Storchaka &amp;lt;storchaka&amp;#64;gmail.com&amp;gt;
date:        Tue Oct 18 13:27:54 2016 +0300
files:       Misc/NEWS
description:
Issue #23782: Fixed possible memory leak in _PyTraceback_Add() and exception
loss in PyTraceBack_Here().
&lt;/pre&gt;
&lt;p&gt;Thank you &lt;tt class="docutils literal"&gt;hg bisect&lt;/tt&gt;! I love this tool.&lt;/p&gt;
&lt;p&gt;Even if I trust &lt;tt class="docutils literal"&gt;hg bisect&lt;/tt&gt;, I don't trust benchmarks, so I recheck manually:&lt;/p&gt;
&lt;p&gt;Slow:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ hg up -C -r 83877018ef97
$ ./configure --with-lto -C &amp;amp;&amp;amp; make clean &amp;amp;&amp;amp; make
$ PYTHONPATH=~/perf ./python ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --fast
call_method: Median +- std dev: 29.4 ms +- 1.8 ms
&lt;/pre&gt;
&lt;p&gt;Use &lt;tt class="docutils literal"&gt;hg parents&lt;/tt&gt; to get the latest fast revision:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ hg parents -r 83877018ef97
changeset:   104528:ce85a1f129e3
(...)

changeset:   104530:2d352bf2b228
branch:      3.6
(...)
&lt;/pre&gt;
&lt;p&gt;Check the parent:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ hg up -C -r ce85a1f129e3
$ ./configure --with-lto -C &amp;amp;&amp;amp; make clean &amp;amp;&amp;amp; make
$ PYTHONPATH=~/perf ./python ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --fast
call_method: Median +- std dev: 17.1 ms +- 0.1 ms
&lt;/pre&gt;
&lt;p&gt;The revision ce85a1f129e3 is fast and the following revision 83877018ef97 is
slow. &lt;strong&gt;The revision 83877018ef97 introduced the slowdown&lt;/strong&gt;.  We found it!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="analysis-of-the-revision-introducing-the-slowdown"&gt;
&lt;h2&gt;Analysis of the revision introducing the slowdown&lt;/h2&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://hg.python.org/cpython/rev/83877018ef97/"&gt;revision 83877018ef97&lt;/a&gt;
changes two files: Misc/NEWS and Python/traceback.c. The NEWS file is only
documentation and so must not impact performances.  Python/traceback.c is part
of the C code and so is more interesting.&lt;/p&gt;
&lt;p&gt;The commit only changes two C functions: &lt;tt class="docutils literal"&gt;PyTraceBack_Here()&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;_PyTraceback_Add()&lt;/tt&gt;, but &lt;tt class="docutils literal"&gt;perf report&lt;/tt&gt; didn't show these functions as &amp;quot;hot&amp;quot;.
In fact, these functions are never called by the benchmark.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The commit doesn't touch the C code used in the benchmark.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Unrelated C change impacting performances reminds me my previous &lt;a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-deadcode.html"&gt;deadcode
horror story&lt;/a&gt;. The performance
difference is probably caused by &lt;strong&gt;&amp;quot;code placement&amp;quot;&lt;/strong&gt;: &lt;tt class="docutils literal"&gt;perf stat&lt;/tt&gt; showed a
significant increase of the cache miss rate on the L1 instruction cache.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="use-gcc-attribute-hot"&gt;
&lt;h2&gt;Use GCC __attribute__((hot))&lt;/h2&gt;
&lt;p&gt;Using PGO compilation was the solution for deadcode, but PGO doesn't work on
Ubuntu 14.04 (the OS used by the benchmark server, speed-python) and PGO seems
to make benchmarks less reliable.&lt;/p&gt;
&lt;p&gt;I wanted to try something else: mark hot functions using the GCC
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;__attribute__((hot))&lt;/span&gt;&lt;/tt&gt; attribute. PGO compilation does this automatically.&lt;/p&gt;
&lt;p&gt;This attribute only has an impact on the code placement: where functions are
loaded in memory. The flag declares functions in the &lt;tt class="docutils literal"&gt;.text.hot&lt;/tt&gt; ELF section
rather than the &lt;tt class="docutils literal"&gt;.text&lt;/tt&gt; ELF section. Grouping hot functions in the same
functions helps to reduce the distance between functions and so enhance the
usage of CPU caches.&lt;/p&gt;
&lt;p&gt;I wrote and then pushed a patch in the &lt;a class="reference external" href="http://bugs.python.org/issue28618"&gt;issue #28618&lt;/a&gt;: &amp;quot;Decorate hot functions using
__attribute__((hot)) to optimize Python&amp;quot;.&lt;/p&gt;
&lt;p&gt;The patch marks 6 functions as hot:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;_PyEval_EvalFrameDefault()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;call_function()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;_PyFunction_FastCall()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PyFrame_New()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;frame_dealloc()&lt;/tt&gt;&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;PyErr_Occurred()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let's try the patch:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ hg up -C -r 83877018ef97
$ wget https://hg.python.org/cpython/raw-rev/59b91b4e9506 -O patch
$ patch -p1 &amp;lt; patch
$ ./configure --with-lto -C &amp;amp;&amp;amp; make clean &amp;amp;&amp;amp; make
$ PYTHONPATH=~/perf ./python ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --fast
call_method: Median +- std dev: 16.7 ms +- 0.3 ms
&lt;/pre&gt;
&lt;p&gt;It's easy to make mistakes and benchmarks are always suprising, so let's retry
without the patch:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ hg up -C -r 83877018ef97
$ ./configure --with-lto -C &amp;amp;&amp;amp; make clean &amp;amp;&amp;amp; make
$ PYTHONPATH=~/perf ./python ~/performance/performance/benchmarks/bm_call_method.py --inherit-environ=PYTHONPATH --fast
call_method: Median +- std dev: 29.3 ms +- 0.6 ms
&lt;/pre&gt;
&lt;p&gt;The check confirms that the GCC attribute fixed the issue!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;On modern Intel CPUs, the code placement can have a major impact on the
performance of microbenchmarks.&lt;/p&gt;
&lt;p&gt;The GCC &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;__attribute__((hot))&lt;/span&gt;&lt;/tt&gt; attribute can be used manually to make &amp;quot;hot
functions&amp;quot; close in memory to enhance the usage of CPU caches.&lt;/p&gt;
&lt;p&gt;To know more about the impact of code placement, see the very good talk of Zia
Ansari (Intel) at the LLVM Developers' Meeting 2016: &lt;a class="reference external" href="https://llvmdevelopersmeetingbay2016.sched.org/event/8YzY/causes-of-performance-instability-due-to-code-placement-in-x86"&gt;Causes of Performance
Swings Due to Code Placement in IA&lt;/a&gt;.
He describes well &amp;quot;performance swings&amp;quot; like the one described in this article
and explains how CPUs work internally and how code placement impacts CPU
performances.&lt;/p&gt;
&lt;/div&gt;
</content><category term="benchmark"></category><category term="optimization"></category><category term="benchmark"></category></entry><entry><title>Intel CPUs (part 2): Turbo Boost, temperature, frequency and Pstate C0 bug</title><link href="https://vstinner.github.io/intel-cpus-part2.html" rel="alternate"></link><published>2016-09-23T23:00:00+02:00</published><updated>2016-09-23T23:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-09-23:/intel-cpus-part2.html</id><summary type="html">&lt;p class="first last"&gt;Intel CPUs (part 2): Turbo Boost, temperature, frequency and Pstate C0 bug&lt;/p&gt;
</summary><content type="html">&lt;p&gt;My first article &lt;a class="reference external" href="https://vstinner.github.io/intel-cpus.html"&gt;Intel CPUs&lt;/a&gt; is a general
introduction on modern CPU technologies having an impact on benchmarks.&lt;/p&gt;
&lt;p&gt;This second article is much more concrete with numbers and a concrete bug
having a major impact on benchmarks: a benchmark suddenly becomes 2x faster!&lt;/p&gt;
&lt;p&gt;I will tell you how I first noticed the bug, which tests I ran to analyze the
issue, how I found commands to reproduce the bug, and finally how I identified
the bug.&lt;/p&gt;
&lt;div class="section" id="glitch-in-benchmarks"&gt;
&lt;h2&gt;&amp;quot;Glitch&amp;quot; in benchmarks&lt;/h2&gt;
&lt;p&gt;Last week I ran a benchmark to check if enabling Profile Guided Optimization
(PGO) when compiling Python makes benchmark results less stable. I recompiled
Python 5 times, and after each compilation I ran a benchmark. I tested
different commands and options to compile Python. Everything was fine until
the last benchmark of the last compilation. &lt;strong&gt;The benchmark suddenly became 2
times faster.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Hopefully, my perf module collects a lot of metadata. I was able to analyze
in depth what happened.&lt;/p&gt;
&lt;p&gt;The &amp;quot;glitch&amp;quot; occurred in a benchmark having 400 runs (benchmark run in 400
different processes), between the run 105 (20.3 ms) and the run 106
(11.0 ms).&lt;/p&gt;
&lt;p&gt;I noticed that the CPU temperature was between 69°C and 72°C until the run 105,
and then decreased to from 69°C to 58°C.&lt;/p&gt;
&lt;p&gt;The system load slowly increased from 1.25 up to 1.62 around the run 108 and
then slowly decreased to 1.00.&lt;/p&gt;
&lt;p&gt;The system was not idle while the benchmark was running. I was working on the
PC too! But according to timestamps, it seems like the glitch was close to when
I stopped working. When I stopped working, I closed all applications (except of
the benchmark running in background) and turned of my two monitors.&lt;/p&gt;
&lt;p&gt;Well, at this point, it's hard to correlate for sure an event with the major
performance change.&lt;/p&gt;
&lt;p&gt;So I started to analyze different factors affecting CPUs and benchmarks: Turbo
Boost, CPU temperature and CPU frequency.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="impact-of-turbo-boost-on-benchmarks"&gt;
&lt;h2&gt;Impact of Turbo Boost on benchmarks&lt;/h2&gt;
&lt;p&gt;Without Turbo Boost, the maximum frequency of the &amp;quot;Intel(R) Core(TM) i7-3520M
CPU &amp;#64; 2.90GHz&amp;quot; of my laptop is 2.9 GHz. With Turbo Boost, the maximum
frequency is 3.6 GHz if only one core is active, or 3.4 GHz otherwise:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ sudo cpupower frequency-info
  ...
  boost state support:
    Supported: yes
    Active: yes
    3400 MHz max turbo 4 active cores
    3400 MHz max turbo 3 active cores
    3400 MHz max turbo 2 active cores
    3600 MHz max turbo 1 active cores
&lt;/pre&gt;
&lt;p&gt;I ran the bm_call_simple.py microbenchmark (CPU-bound) of performance 0.2.2.&lt;/p&gt;
&lt;p&gt;Turbo Boost disabled:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;1 physical CPU active: 2.9 GHz, Median +- std dev: 14.6 ms +- 0.3 ms&lt;/li&gt;
&lt;li&gt;2 physical CPU active: 2.9 GHz, Median +- std dev: 14.7 ms +- 0.5 ms&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Turbo Boost enabled:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;1 physical CPU active: 3.6 GHz, Median +- std dev: 11.8 ms +- 0.3 ms&lt;/li&gt;
&lt;li&gt;2 physical CPU active: 3.4 GHz, Median +- std dev: 12.4 ms +- 0.1 ms&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;The maximum performance boost is 19% faster&lt;/strong&gt; (14.6 ms =&amp;gt; 11.8 ms), the
minimum boost if 15% faster (14.6 ms =&amp;gt; 12.4 ms).&lt;/p&gt;
&lt;p&gt;Hum, I don't think that Turbo Boost can explain the bug.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="impact-of-the-cpu-temperature-on-benchmarks"&gt;
&lt;h2&gt;Impact of the CPU temperature on benchmarks&lt;/h2&gt;
&lt;p&gt;The CPU temperature is mentionned in Intel Turbo Boost documentation as a
factor used to decide which P-state will be used. I always wanted to check how
the CPU temperature impacts its performance.&lt;/p&gt;
&lt;div class="section" id="burn-the-cpu-of-my-desktop-pc"&gt;
&lt;h3&gt;Burn the CPU of my desktop PC&lt;/h3&gt;
&lt;p&gt;CPU of my desktop PC: &amp;quot;Intel(R) Core(TM) i7-2600 CPU &amp;#64; 3.40GHz&amp;quot;.&lt;/p&gt;
&lt;p&gt;I used my &lt;a class="reference external" href="https://github.com/vstinner/misc/blob/master/bin/system_load.py"&gt;system_load.py script&lt;/a&gt; to generate a
system load higher than 10.&lt;/p&gt;
&lt;p&gt;When the fan is cooling correctly the CPU, all CPU run at 3.4 GHz (Turbo Boost
was disabled) and the CPU temperature is 66°C.&lt;/p&gt;
&lt;p&gt;I used a simple sheet of paper to block the fan of my CPU. Yeah, I really
wanted to &lt;a class="reference external" href="https://www.youtube.com/watch?v=Xf0VuRG7MN4"&gt;burn my CPU&lt;/a&gt;! More
seriously, I checked the CPU temperature every second using the &lt;tt class="docutils literal"&gt;sensors&lt;/tt&gt;
command and was prepared to unblock the fan if sometimes gone wrong.&lt;/p&gt;
&lt;img alt="Sheet of paper blocking the CPU fan" src="https://vstinner.github.io/images/paper_blocks_cpu_fan.jpg" /&gt;
&lt;p&gt;After one minute, the CPU reached 97°C. I expected a system crash, smoke or
something worse, but I was disappointed. &lt;strong&gt;At 97°C, I was still able to use my
computer as everything was fine. The CPU was slowly down automatically to the
minimum CPU frequency: 1533 MHz&lt;/strong&gt; according to turbostat (the minimum frequency
of this CPU is 1.6 GHz).&lt;/p&gt;
&lt;p&gt;When I unblocked the fan, the temperature decreased quickly to go back to its
previous state (62°C) and the CPU frequency quickly increased to 3.4 GHz as
well.&lt;/p&gt;
&lt;p&gt;My Intel CPU is really impressive! I didn't expect such very efficient
protection against overheating!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="burn-my-laptop-cpu"&gt;
&lt;h3&gt;Burn my laptop CPU&lt;/h3&gt;
&lt;p&gt;I used my system_load.py script to get a system load over 200. I also opened 4
tabs in Firefox playing Youtube videos to stress also the GPU which is
integrated into the CPU (IGP) on such laptop.&lt;/p&gt;
&lt;img alt="Stress test playing Youtube videos in Firefox, CPU at 102°" src="https://vstinner.github.io/images/burn_cpu_firefox.jpg" /&gt;
&lt;p&gt;With such crazy stress test, the CPU temperature was &amp;quot;only&amp;quot; 83°C.&lt;/p&gt;
&lt;p&gt;Using a simple tissue, I closed the air hole used by the CPU fan. &lt;strong&gt;When the
CPU temperature increased from 100°C to 101°C, the CPU frequency started slowly
to decrease from 3391 MHz to 3077 MHz&lt;/strong&gt; (with steps between 10 MHz and 50 MHz
every second, or something like that).&lt;/p&gt;
&lt;p&gt;When pushing hard the tissue and waiting longer than 5 minutes, the CPU
temperature increased up to 102°C, but the CPU frequency was only decreased
from 3.4 GHz (Turbo Mode with 4 active logical CPUs) to 3.1 GHz.&lt;/p&gt;
&lt;p&gt;The maximum frequency is 2.9 GHz. Frequencies higher than 2.9 GHz means that
the Turbo Mode was enabled! It means that &lt;strong&gt;even with overheating, the CPU is
still fine and able to &amp;quot;overclock&amp;quot; itself!&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Again, I was disapointed. With a CPU at 102°C, my laptop was still super fast
and reactive.  It seems like mobile CPUs handle even better overheating than
desktop CPUs (which is not something suprising at all).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="impact-of-the-cpu-frequency-on-benchmarks"&gt;
&lt;h2&gt;Impact of the CPU frequency on benchmarks&lt;/h2&gt;
&lt;p&gt;I ran the bm_call_simple.py microbenchmark (CPU-bound) of performance 0.2.2
on my desktop PC.&lt;/p&gt;
&lt;p&gt;Command to set the frequency of CPU 0 to the minimum frequency (1.6 GHz):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_min_freq|sudo tee  /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
1600000
&lt;/pre&gt;
&lt;p&gt;Command to set the frequency of CPU 0 to the maximum frequency (3.4 GHz):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq|sudo tee  /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
3400000
&lt;/pre&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;CPU running at 1.6 GHz (min freq): Median +- std dev: 27.7 ms +- 0.7 ms&lt;/li&gt;
&lt;li&gt;CPU running at 3.4 GHz (min freq): Median +- std dev: 12.9 ms +- 0.2 ms&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The impact of the CPU frequency is quite obvious: &lt;strong&gt;when the CPU frequency is
doubled, the performance is also doubled&lt;/strong&gt;. The benchmark is 53% faster (27.7
ms =&amp;gt; 12.9 ms).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="bug-reproduced-and-then-identified-in-the-linux-cpu-driver"&gt;
&lt;h2&gt;Bug reproduced and then identified in the Linux CPU driver&lt;/h2&gt;
&lt;p&gt;Two days ago, I ran a very simple &amp;quot;timeit&amp;quot; microbenchmark to try to bisect a
performance regression in Python 3.6 on &lt;tt class="docutils literal"&gt;functools.partial&lt;/tt&gt;. Again, suddenly,
the microbenchmark became 2x faster!&lt;/p&gt;
&lt;p&gt;But this time, I found something: I noticed that running or stopping &lt;tt class="docutils literal"&gt;cpupower
monitor&lt;/tt&gt; and/or &lt;tt class="docutils literal"&gt;turbostat&lt;/tt&gt; can &amp;quot;enable&amp;quot; or &amp;quot;disable&amp;quot; the bug.&lt;/p&gt;
&lt;p&gt;After a lot of tests, I understood that running the benchmark with turbostat
&amp;quot;disables&amp;quot; the bug, whereas running &amp;quot;cpupower monitor&amp;quot; while running a
benchmark enables the bug.&lt;/p&gt;
&lt;p&gt;I reported the bug in the Fedora bug tracker, on the component kernel:
&lt;a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1378529"&gt;intel_pstate C0 bug on isolated CPUs with the performance governor and
NOHZ_FULL&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It seems like the bug is related to CPU isolation and NOHZ_FULL. The NOHZ_FULL
option is able to fully disable the scheduler clock interruption  on isolated
CPUs. I understood the the &lt;tt class="docutils literal"&gt;intel_pstate&lt;/tt&gt; driver uses a callback on the
scheduler to update the Pstate of the CPU. According to an Intel engineer, the
&lt;tt class="docutils literal"&gt;intel_pstate&lt;/tt&gt; driver was never tested with CPU isolation.&lt;/p&gt;
&lt;p&gt;The issue is not fully analyzed yet, but at least I succeeded to write a list
of commands to reproduce it with a success rate of 100% :-) Moreover, the Intel
engineer suggested to add an extra parameter to the Linux kernel command
(&lt;tt class="docutils literal"&gt;rcu_nocbs=3,7&lt;/tt&gt;) line which works around the issue.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;This article describes how I found and then identified a bug in the Linux
driver of my CPU.&lt;/p&gt;
&lt;p&gt;Summary:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The maximum speedup of Turbo Boost is 20%&lt;/li&gt;
&lt;li&gt;Overheating on a dekstop PC can decrease the CPU frequency to its minimum
(half of the maximum in my case) which imply a slowdown of 50%&lt;/li&gt;
&lt;li&gt;A bug in the Linux CPU driver changes suddenly the CPU frequency from its
minimum to maximum (or the opposite) which means a speedup of 50%
(or slowdown of 50%)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;To get stable benchmarks, the safest fix for all these issues is probably to
set the CPU frequency of the CPUs used by benchmarks to the minimum.&lt;/strong&gt;
It seems like nothing can reduce the frequency of a CPU below its minimum.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;When running benchmarks, raw timings and CPU performance don't matter. Only
comparisons between benchmark results and stable performances matter.&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="benchmark"></category><category term="optimization"></category><category term="benchmark"></category><category term="cpu"></category></entry><entry><title>Intel CPUs: P-state, C-state, Turbo Boost, CPU frequency, etc.</title><link href="https://vstinner.github.io/intel-cpus.html" rel="alternate"></link><published>2016-07-15T12:00:00+02:00</published><updated>2016-07-15T12:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-07-15:/intel-cpus.html</id><summary type="html">&lt;p class="first last"&gt;Intel CPUs: Hyper-threading, Turbo Boost, CPU frequency, etc.&lt;/p&gt;
</summary><content type="html">&lt;p&gt;Ten years ago, most computers were desktop computers designed for best
performances and their CPU frequency was fixed. Nowadays, most devices are
embedded and use &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Low-power_electronics"&gt;low power consumption&lt;/a&gt; processors like ARM
CPUs. The power consumption now matters more than performance peaks.&lt;/p&gt;
&lt;p&gt;Intel CPUs evolved from a single core to multiple physical cores in the same
&lt;a class="reference external" href="https://en.wikipedia.org/wiki/CPU_socket"&gt;package&lt;/a&gt; and got new features:
&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Hyper-threading"&gt;Hyper-threading&lt;/a&gt; to run two
threads on the same physical core and &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Intel_Turbo_Boost"&gt;Turbo Boost&lt;/a&gt; to maximum performances.
CPU cores can be completely turned off (CPU HALT, frequency of 0) temporarily to
reduce the power consumption, and the frequency of cores changes regulary
depending on many factors like the workload and temperature. The power
consumption is now an important part in the design of modern CPUs.&lt;/p&gt;
&lt;p&gt;Warning! This article is a summary of what I learnt last weeks from random
articles. It may be full of mistakes, don't hesitate to report them, so I can
enhance the article! It's hard to find simple articles explaining performances
of modern Intel CPUs, so I tried to write mine.&lt;/p&gt;
&lt;div class="section" id="tools-used-in-this-article"&gt;
&lt;h2&gt;Tools used in this article&lt;/h2&gt;
&lt;p&gt;This article mentions various tools. Commands to install them on Fedora 24:&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;dnf install &lt;span class="pre"&gt;-y&lt;/span&gt; &lt;span class="pre"&gt;util-linux&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;lscpu&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;dnf install &lt;span class="pre"&gt;-y&lt;/span&gt; &lt;span class="pre"&gt;kernel-tools&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://linux.die.net/man/1/cpupower"&gt;cpupower&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;turbostat&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;sudo dnf install &lt;span class="pre"&gt;-y&lt;/span&gt; &lt;span class="pre"&gt;msr-tools&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;rdmsr&lt;/li&gt;
&lt;li&gt;wrmsr&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Other interesting tools, not used in this article: i7z (sadly no more
maintained), lshw, dmidecode, sensors.&lt;/p&gt;
&lt;p&gt;The sensors tool is supposed to report the current CPU voltage, but it doesn't
provide this information on my computers. At least, it gives the temperature of
different components, but also the speed of fans.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="example-of-intel-cpus"&gt;
&lt;h2&gt;Example of Intel CPUs&lt;/h2&gt;
&lt;div class="section" id="my-laptop-cpu-proc-cpuinfo"&gt;
&lt;h3&gt;My laptop CPU: /proc/cpuinfo&lt;/h3&gt;
&lt;p&gt;On Linux, the most common way to retrieve information on the CPU is to read
&lt;tt class="docutils literal"&gt;/proc/cpuinfo&lt;/tt&gt;. Example on my laptop:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ cat /proc/cpuinfo
processor  : 0
vendor_id  : GenuineIntel
model name : Intel(R) Core(TM) i7-3520M CPU &amp;#64; 2.90GHz
cpu MHz    : 1200.214
...

processor  : 1
vendor_id  : GenuineIntel
model name : Intel(R) Core(TM) i7-3520M CPU &amp;#64; 2.90GHz
cpu MHz    : 3299.882
...
&lt;/pre&gt;
&lt;p&gt;&amp;quot;i7-3520M&amp;quot; CPU is a model designed for Mobile Platforms (see the &amp;quot;M&amp;quot; suffix).
It was built in 2012 and is the third generation of the Intel i7
microarchitecture: &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Ivy_Bridge_(microarchitecture)"&gt;Ivy Bridge&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The CPU has two physical cores, I disabled HyperThreading in the BIOS.&lt;/p&gt;
&lt;p&gt;The first strange thing is that the CPU announces &amp;quot;2.90 GHz&amp;quot; but Linux reports
1.2 GHz on the first core, and 3.3 GHz on the second core. 3.3 GHz is greater
than 2.9 GHz!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="my-desktop-cpu-cpu-topology-with-lscpu"&gt;
&lt;h3&gt;My desktop CPU: CPU topology with lscpu&lt;/h3&gt;
&lt;p&gt;cpuinfo:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
smithers$ cat /proc/cpuinfo
processor   : 0
physical id : 0
core id     : 0
...
model name  : Intel(R) Core(TM) i7-2600 CPU &amp;#64; 3.40GHz
cpu cores   : 4
...

processor   : 1
physical id : 0
core id     : 1
...

(...)

processor   : 7
physical id : 0
core id     : 3
...
&lt;/pre&gt;
&lt;p&gt;The CPU i7-2600 is the 2nd generation: &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Sandy_Bridge"&gt;Sandy Bridge microarchitecture&lt;/a&gt;. There are 8 logical cores and 4
physical cores (so with Hyper-threading).&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;lscpu&lt;/tt&gt; renders a short table which helps to understand the CPU topology:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
smithers$ lscpu -a -e
CPU NODE SOCKET CORE L1d:L1i:L2:L3 ONLINE MAXMHZ    MINMHZ
0   0    0      0    0:0:0:0       yes    3800.0000 1600.0000
1   0    0      1    1:1:1:0       yes    3800.0000 1600.0000
2   0    0      2    2:2:2:0       yes    3800.0000 1600.0000
3   0    0      3    3:3:3:0       yes    3800.0000 1600.0000
4   0    0      0    0:0:0:0       yes    3800.0000 1600.0000
5   0    0      1    1:1:1:0       yes    3800.0000 1600.0000
6   0    0      2    2:2:2:0       yes    3800.0000 1600.0000
7   0    0      3    3:3:3:0       yes    3800.0000 1600.0000
&lt;/pre&gt;
&lt;p&gt;There are 8 logical CPUs (&lt;tt class="docutils literal"&gt;CPU &lt;span class="pre"&gt;0..7&lt;/span&gt;&lt;/tt&gt;), all on the same node (&lt;tt class="docutils literal"&gt;NODE 0&lt;/tt&gt;) and
the same socket (&lt;tt class="docutils literal"&gt;SOCKET 0&lt;/tt&gt;).  There are only 4 physical cores (&lt;tt class="docutils literal"&gt;CORE
&lt;span class="pre"&gt;0..3&lt;/span&gt;&lt;/tt&gt;). For example, the physical core &lt;tt class="docutils literal"&gt;2&lt;/tt&gt; is made of the two logical CPUs:
&lt;tt class="docutils literal"&gt;2&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;6&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Using the &lt;tt class="docutils literal"&gt;L1d:L1i:L2:L3&lt;/tt&gt; column, we can see that each pair of two logical
cores share the same physical core caches for levels 1 (L1 data, L1
instruction) and 2 (L2).  All physical cores share the same cache level 3 (L3).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="p-states"&gt;
&lt;h2&gt;P-states&lt;/h2&gt;
&lt;p&gt;A new CPU driver &lt;tt class="docutils literal"&gt;intel_pstate&lt;/tt&gt; was added to the Linux kernel 3.9 (April
2009). First, it only supported SandyBridge CPUs (2nd generation), Linux 3.10
extended it to Ivybridge generation CPUs (3rd gen), and so on and so forth.&lt;/p&gt;
&lt;p&gt;This driver supports recent features and thermal control of modern Intel CPUs.
Its name comes from P-states.&lt;/p&gt;
&lt;p&gt;The processor P-state is the capability of running the processor at different
voltage and/or frequency levels. Generally, P0 is the highest state resulting
in maximum performance, while P1, P2, and so on, will save power but at some
penalty to CPU performance.&lt;/p&gt;
&lt;p&gt;It is possible to force the legacy CPU driver (&lt;tt class="docutils literal"&gt;acpi_cpufreq&lt;/tt&gt;) using
&lt;tt class="docutils literal"&gt;intel_pstate=disable&lt;/tt&gt; option in the kernel command line.&lt;/p&gt;
&lt;p&gt;See also:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.kernel.org/doc/Documentation/cpu-freq/intel-pstate.txt"&gt;Documentation of the intel-pstate driver&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://plus.google.com/+ArjanvandeVen/posts/dLn9T4ehywL"&gt;Some basics on CPU P states on Intel processors&lt;/a&gt; (2013) by Arjan
van de Ven (Intel)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://events.linuxfoundation.org/sites/events/files/slides/LinuxConEurope_2015.pdf"&gt;Balancing Power and Performance in the Linux Kernel&lt;/a&gt;
talk at LinuxCon Europe 2015 by Kristen Accardi (Intel)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://software.intel.com/en-us/blogs/2008/05/29/what-exactly-is-a-p-state-pt-1"&gt;What exactly is a P-state? (Pt. 1)&lt;/a&gt;
(2008) by Taylor K. (Intel)&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="idle-states-c-states"&gt;
&lt;h2&gt;Idle states: C-states&lt;/h2&gt;
&lt;p&gt;C-states are idle power saving states, in contrast to P-states, which are
execution power saving states.&lt;/p&gt;
&lt;p&gt;During a P-state, the processor is still executing instructions, whereas during
a C-state (other than C0), the processor is idle, meaning that nothing is
executing.&lt;/p&gt;
&lt;p&gt;C-states:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;C0 is the operational state, meaning that the CPU is doing useful work&lt;/li&gt;
&lt;li&gt;C1 is the first idle state&lt;/li&gt;
&lt;li&gt;C2 is the second idle state: The external I/O Controller Hub blocks
interrupts to the processor.&lt;/li&gt;
&lt;li&gt;etc.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;When a logical processor is idle (C-state except of C0), its frequency is
typically 0 (HALT).&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;cpupower &lt;span class="pre"&gt;idle-info&lt;/span&gt;&lt;/tt&gt; command lists supported C-states:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ cpupower idle-info
CPUidle driver: intel_idle
CPUidle governor: menu
analyzing CPU 0:

Number of idle states: 6
Available idle states: POLL C1-IVB C1E-IVB C3-IVB C6-IVB C7-IVB
...
&lt;/pre&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;cpupower monitor&lt;/tt&gt; shows statistics on C-states:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
smithers$ sudo cpupower monitor -m Idle_Stats
    |Idle_Stats
CPU | POLL | C1-S | C1E- | C3-S | C6-S
   0|  0,00|  0,19|  0,09|  0,58| 96,23
   4|  0,00|  0,00|  0,00|  0,00| 99,90
   1|  0,00|  2,34|  0,00|  0,00| 97,63
   5|  0,00|  0,00|  0,17|  0,00| 98,02
   2|  0,00|  0,00|  0,00|  0,00|  0,00
   6|  0,00|  0,00|  0,00|  0,00|  0,00
   3|  0,00|  0,00|  0,00|  0,00|  0,00
   7|  0,00|  0,00|  0,00|  0,00| 49,97
&lt;/pre&gt;
&lt;p&gt;See also: &lt;a class="reference external" href="https://software.intel.com/en-us/articles/power-management-states-p-states-c-states-and-package-c-states"&gt;Power Management States: P-States, C-States, and Package C-States&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h2&gt;Turbo Boost&lt;/h2&gt;
&lt;p&gt;In 2005, Intel introduced &lt;a class="reference external" href="https://en.wikipedia.org/wiki/SpeedStep"&gt;SpeedStep&lt;/a&gt;, a serie of dynamic frequency
scaling technologies to reduce the power consumption of laptop CPUs. Turbo
Boost is an enhancement of these technologies, now also used on desktop and
server CPUs.&lt;/p&gt;
&lt;p&gt;Turbo Boost allows to run one or many CPU cores to higher P-states than usual.
The maximum P-state is constrained by the following factors:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;The number of active cores (in C0 or C1 state)&lt;/li&gt;
&lt;li&gt;The estimated current consumption of the processor (Imax)&lt;/li&gt;
&lt;li&gt;The estimated power consumption (TDP - Thermal Design Power) of processor&lt;/li&gt;
&lt;li&gt;The temperature of the processor&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Example on my laptop:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ cat /proc/cpuinfo
model name : Intel(R) Core(TM) i7-3520M CPU &amp;#64; 2.90GHz
...

selma$ sudo cpupower frequency-info
analyzing CPU 0:
  driver: intel_pstate
  ...
  boost state support:
    Supported: yes
    Active: yes
    3400 MHz max turbo 4 active cores
    3400 MHz max turbo 3 active cores
    3400 MHz max turbo 2 active cores
    3600 MHz max turbo 1 active cores
&lt;/pre&gt;
&lt;p&gt;The CPU base frequency is 2.9 GHz. If more than one physical cores is &amp;quot;active&amp;quot;
(busy), their frequency can be increased up to 3.4 GHz. If only 1 physical core
is active, its frequency can be increased up to 3.6 GHz.&lt;/p&gt;
&lt;p&gt;In this example, Turbo Boost is supported and active.&lt;/p&gt;
&lt;p&gt;See also the &lt;a class="reference external" href="https://www.kernel.org/doc/Documentation/cpu-freq/boost.txt"&gt;Linux cpu-freq documentation on CPU boost&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="turbo-boost-msr"&gt;
&lt;h3&gt;Turbo Boost MSR&lt;/h3&gt;
&lt;p&gt;The bit 38 of the &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Model-specific_register"&gt;Model-specific register
(MSR)&lt;/a&gt; &lt;tt class="docutils literal"&gt;0x1a0&lt;/tt&gt; can
be used to check if the Turbo Boost is enabled:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ sudo rdmsr -f 38:38 0x1a0
0
&lt;/pre&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;0&lt;/tt&gt; means that Turbo Boost is enabled, whereas &lt;tt class="docutils literal"&gt;1&lt;/tt&gt; means disabled (no
turbo). (The &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-f&lt;/span&gt; 38:38&lt;/tt&gt; option asks to only display the bit 38.)&lt;/p&gt;
&lt;p&gt;If the command doesn't work, you may have to load the &lt;tt class="docutils literal"&gt;msr&lt;/tt&gt; kernel module:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo modprobe msr
&lt;/pre&gt;
&lt;p&gt;Note: I'm not sure that all Intel CPU uses the same MSR.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="intel-state-no-turbo"&gt;
&lt;h3&gt;intel_state/no_turbo&lt;/h3&gt;
&lt;p&gt;Turbo Boost can also be disabled at runtime in the &lt;tt class="docutils literal"&gt;intel_pstate&lt;/tt&gt; driver.&lt;/p&gt;
&lt;p&gt;Check if Turbo Boost is enabled:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ cat /sys/devices/system/cpu/intel_pstate/no_turbo
0
&lt;/pre&gt;
&lt;p&gt;where &lt;tt class="docutils literal"&gt;0&lt;/tt&gt; means that Turbo Boost is enabled. Disable Turbo Boost:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ echo 1|sudo tee /sys/devices/system/cpu/intel_pstate/no_turbo
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="cpu-flag-ida"&gt;
&lt;h3&gt;CPU flag &amp;quot;ida&amp;quot;&lt;/h3&gt;
&lt;p&gt;It looks like the Turbo Boost status (supported or not) can also be read by the
CPUID(6): &amp;quot;Thermal/Power Management&amp;quot;. It gives access to the flag &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Intel_Dynamic_Acceleration"&gt;Intel
Dynamic Acceleration (IDA)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;ida&lt;/tt&gt; flag can also be seen in CPU flags of &lt;tt class="docutils literal"&gt;/proc/cpuinfo&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="read-the-cpu-frequency"&gt;
&lt;h2&gt;Read the CPU frequency&lt;/h2&gt;
&lt;p&gt;General information using &lt;tt class="docutils literal"&gt;cpupower &lt;span class="pre"&gt;frequency-info&lt;/span&gt;&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ cpupower -c 0 frequency-info
analyzing CPU 0:
  driver: intel_pstate
  ...
  hardware limits: 1.20 GHz - 3.60 GHz
  ...
&lt;/pre&gt;
&lt;p&gt;The frequency of CPUs is between 1.2 GHz and 3.6 GHz (the base frequency is
2.9 GHz on this CPU).&lt;/p&gt;
&lt;div class="section" id="get-the-frequency-of-cpus-turbostat"&gt;
&lt;h3&gt;Get the frequency of CPUs: turbostat&lt;/h3&gt;
&lt;p&gt;It looks like the most reliable way to get a relialistic estimation of the CPUs
frequency is to use the tool &lt;tt class="docutils literal"&gt;turbostat&lt;/tt&gt;:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ sudo turbostat
     CPU Avg_MHz   Busy% Bzy_MHz TSC_MHz
       -     224    7.80    2878    2893
       0     448   15.59    2878    2893
       1       0    0.01    2762    2893
     CPU Avg_MHz   Busy% Bzy_MHz TSC_MHz
       -     139    5.65    2469    2893
       0     278   11.29    2469    2893
       1       0    0.01    2686    2893
    ...
&lt;/pre&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Avg_MHz&lt;/tt&gt;: average frequency, based on APERF&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Busy%&lt;/tt&gt;: CPU usage in percent&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;Bzy_MHz&lt;/tt&gt;: busy frequency, based on MPERF&lt;/li&gt;
&lt;li&gt;&lt;tt class="docutils literal"&gt;TSC_MHz&lt;/tt&gt;: fixed frequency, TSC stands for &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Time_Stamp_Counter"&gt;Time Stamp Counter&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;APERF (average) and MPERF (maximum) are MSR registers that can provide feedback
on current CPU frequency.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="other-tools-to-get-the-cpu-frequency"&gt;
&lt;h3&gt;Other tools to get the CPU frequency&lt;/h3&gt;
&lt;p&gt;It looks like the following tools are less reliable to estimate the CPU
frequency.&lt;/p&gt;
&lt;p&gt;cpuinfo:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ grep MHz /proc/cpuinfo
cpu MHz : 1372.289
cpu MHz : 3401.042
&lt;/pre&gt;
&lt;p&gt;In April 2016, Len Brown proposed a patch modifying cpuinfo to use APERF and
MPERF MSR to estimate the CPU frequency: &lt;a class="reference external" href="https://lkml.org/lkml/2016/4/1/7"&gt;x86: Calculate MHz using APERF/MPERF
for cpuinfo and scaling_cur_freq&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;tsc&lt;/tt&gt; clock source logs the CPU frequency in kernel logs:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ dmesg|grep 'MHz processor'
[    0.000000] tsc: Detected 2893.331 MHz processor
&lt;/pre&gt;
&lt;p&gt;cpupower frequency-info:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ for core in $(seq 0 1); do sudo cpupower -c $core frequency-info|grep 'current CPU'; done
  current CPU frequency: 3.48 GHz (asserted by call to hardware)
  current CPU frequency: 3.40 GHz (asserted by call to hardware)
&lt;/pre&gt;
&lt;p&gt;cpupower monitor:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
selma$ sudo cpupower monitor -m 'Mperf'
    |Mperf
CPU | C0   | Cx   | Freq
   0|  4.77| 95.23|  1924
   1|  0.01| 99.99|  1751
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Modern Intel CPUs use various technologies to provide best performances without
killing the power consumption. It became harder to monitor and understand CPU
performances, than with older CPUs, since the performance now depends on much
more factors.&lt;/p&gt;
&lt;p&gt;It also becomes common to get an integrated graphics processor (IGP) in the
same package, which makes the exact performance even more complex to predict,
since the IGP produces heat and so has an impact on the CPU P-state.&lt;/p&gt;
&lt;p&gt;I should also explain that P-state are &amp;quot;voted&amp;quot; between CPU cores, but I didn't
understand this part. I'm not sure that understanding the exact algorithm
matters much. I tried to not give too much information.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="annex-amt-and-the-me-power-management-coprocessor"&gt;
&lt;h2&gt;Annex: AMT and the ME (power management coprocessor)&lt;/h2&gt;
&lt;p&gt;Computers with Intel vPro technology includes &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Intel_Active_Management_Technology"&gt;Intel Active Management
Technology (AMT)&lt;/a&gt;: &amp;quot;hardware
and firmware technology for remote out-of-band management of personal
computers&amp;quot;. AMT has many features which includes power management.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Intel_Active_Management_Technology#Hardware"&gt;Management Engine (ME)&lt;/a&gt;
is the hardware part: an isolated and protected coprocessor, embedded as a
non-optional part in all current (as of 2015) Intel chipsets. The coprocessor
is a special 32-bit ARC microprocessor (RISC architecture) that's physically
located inside the PCH chipset (or MCH on older chipsets). The coprocessor can
for example be found on Intel MCH chipsets Q35 and Q45.&lt;/p&gt;
&lt;p&gt;See &lt;a class="reference external" href="https://boingboing.net/2016/06/15/intel-x86-processors-ship-with.html"&gt;Intel x86s hide another CPU that can take over your machine (you can't
audit it)&lt;/a&gt; for
more information on the coprocessor.&lt;/p&gt;
&lt;p&gt;More recently, the Intel Xeon Phi CPU (2016) also includes a coprocessor for
power management. I didn't understand if it is the same coprocessor or not.&lt;/p&gt;
&lt;/div&gt;
</content><category term="benchmark"></category><category term="optimization"></category><category term="benchmark"></category><category term="cpu"></category></entry><entry><title>Visualize the system noise using perf and CPU isolation</title><link href="https://vstinner.github.io/perf-visualize-system-noise-with-cpu-isolation.html" rel="alternate"></link><published>2016-06-16T13:30:00+02:00</published><updated>2016-06-16T13:30:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-06-16:/perf-visualize-system-noise-with-cpu-isolation.html</id><summary type="html">&lt;p&gt;I developed a new &lt;a class="reference external" href="http://perf.readthedocs.io/"&gt;perf module&lt;/a&gt; designed to run
stable benchmarks, give fine control on benchmark parameters and compute
statistics on results. With such tool, it becomes simple to &lt;em&gt;visualize&lt;/em&gt;
sources of noise. The CPU isolation will be used to visualize the system noise.
Running a benchmark on isolated CPUs …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I developed a new &lt;a class="reference external" href="http://perf.readthedocs.io/"&gt;perf module&lt;/a&gt; designed to run
stable benchmarks, give fine control on benchmark parameters and compute
statistics on results. With such tool, it becomes simple to &lt;em&gt;visualize&lt;/em&gt;
sources of noise. The CPU isolation will be used to visualize the system noise.
Running a benchmark on isolated CPUs isolates it from the system noise.&lt;/p&gt;
&lt;div class="section" id="isolate-cpus"&gt;
&lt;h2&gt;Isolate CPUs&lt;/h2&gt;
&lt;p&gt;My computer has 4 physical CPU cores. I isolated half of them using
&lt;tt class="docutils literal"&gt;isolcpus=2,3&lt;/tt&gt; parameter of the Linux kernel. I modified manually the command
line in GRUB to add this parameter.&lt;/p&gt;
&lt;p&gt;Check that CPUs are isolated:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/devices/system/cpu/isolated
2-3
&lt;/pre&gt;
&lt;p&gt;The CPU supports HyperThreading, but I disabled it in the BIOS.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="run-a-benchmark"&gt;
&lt;h2&gt;Run a benchmark&lt;/h2&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;perf&lt;/tt&gt; module automatically detects and uses isolated CPU cores. I will
use the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--affinity=0,1&lt;/span&gt;&lt;/tt&gt; option to force running the benchmark on the CPUs
which are not isolated.&lt;/p&gt;
&lt;p&gt;Microbenchmark with and without CPU isolation:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -m perf.timeit --json-file=timeit_isolcpus.json --verbose -s 'x=1; y=2' 'x+y'
Pin process to isolated CPUs: 2-3
.........................
Median +- std dev: 36.6 ns +- 0.1 ns (25 runs x 3 samples x 10^7 loops; 1 warmup)

$ python3 -m perf.timeit --affinity=0,1 --json-file=timeit_no_isolcpus.json --verbose -s 'x=1; y=2' 'x+y'
Pin process to CPUs: 0-1
.........................
Median +- std dev: 36.7 ns +- 1.3 ns (25 runs x 3 samples x 10^7 loops; 1 warmup)
&lt;/pre&gt;
&lt;p&gt;My computer was not 100% idle, I was using it while the benchmarks were
running.&lt;/p&gt;
&lt;p&gt;The median is almost the same (36.6 ns and 36.7 ns). The first major difference
is the standard deviation: it is much larger without CPU isolation: 0.1 ns =&amp;gt;
1.3 ns (13x larger).&lt;/p&gt;
&lt;p&gt;Just in case, check manually CPU affinity in metadata:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -m perf show timeit_isolcpus.json --metadata | grep cpu
- cpu_affinity: 2-3 (isolated)
- cpu_count: 4
- cpu_model_name: Intel(R) Core(TM) i7-2600 CPU &amp;#64; 3.40GHz

$ python3 -m perf show timeit_no_isolcpus.json --metadata | grep cpu_affinity
- cpu_affinity: 0-1
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="statistics"&gt;
&lt;h2&gt;Statistics&lt;/h2&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;perf stats&lt;/tt&gt; command computes statistics on the distribution of samples:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -m perf stats timeit_isolcpus.json
Number of samples: 75

Minimum: 36.5 ns (-0.1%)
Median +- std dev: 36.6 ns +- 0.1 ns (36.5 ns .. 36.7 ns)
Maximum: 36.7 ns (+0.4%)

$ python3 -m perf stats timeit_no_isolcpus.json
Number of samples: 75

Minimum: 36.5 ns (-0.5%)
Median +- std dev: 36.7 ns +- 1.3 ns (35.4 ns .. 38.0 ns)
Maximum: 43.0 ns (+17.0%)
&lt;/pre&gt;
&lt;p&gt;The minimum is the same. The second major difference is the maximum: it is much
larger without CPU isolation: 36.7 ns (+0.4%) =&amp;gt; 43.0 ns (+17.0%).&lt;/p&gt;
&lt;p&gt;The difference between the maximum and the median is 63x larger without CPU
isolation: 0.1 ns (&lt;tt class="docutils literal"&gt;36.7 - 36.6&lt;/tt&gt;) =&amp;gt; 6.3 ns (&lt;tt class="docutils literal"&gt;43.0 - 36.7&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;Depending on the system load, a single sample of the microbenchmark is up to
17% slower (maximum of 43.0 ns with a median of 36.7 ns) without CPU isolation.
The difference is smaller with CPU isolation: only 0.4% slower (for the
maximum, and 0.1% faster for the minimum).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="histogram"&gt;
&lt;h2&gt;Histogram&lt;/h2&gt;
&lt;p&gt;Another way to analyze the distribution of samples is to render an histogram:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -m perf hist --bins=8 timeit_isolcpus.json timeit_no_isolcpus.json
[ timeit_isolcpus ]
36.1 ns: 75 ################################################
36.9 ns:  0 |
37.7 ns:  0 |
38.5 ns:  0 |
39.3 ns:  0 |
40.1 ns:  0 |
40.9 ns:  0 |
41.7 ns:  0 |
42.5 ns:  0 |

[ timeit_no_isolcpus ]
36.1 ns: 52 ################################################
36.9 ns: 13 ############
37.7 ns:  1 #
38.5 ns:  4 ####
39.3 ns:  2 ##
40.1 ns:  0 |
40.9 ns:  1 #
41.7 ns:  0 |
42.5 ns:  2 ##
&lt;/pre&gt;
&lt;p&gt;I choose the number of bars to get a small histogram and to get all samples of
the first benchmark on the same bar. With 8 bars, each bar is a range of 0.8
ns.&lt;/p&gt;
&lt;p&gt;The last major difference is the shape of these histogram. Without CPU
isolation, there is a &amp;quot;long tail&amp;quot; at the right of the median: &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Outlier"&gt;outliers&lt;/a&gt; in the range [37.7 ns; 42.5 ns].
The outliers come from the &amp;quot;noise&amp;quot; caused by the multitasking system.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;perf&lt;/tt&gt; module provides multiple tools to analyze the distribution of
benchmark samples. Three tools show a major difference without CPU isolation
compared to results with CPU isolation:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Standard deviation: 13x larger without isolation&lt;/li&gt;
&lt;li&gt;Maximum: difference to median 63x larger without isolation&lt;/li&gt;
&lt;li&gt;Shape of the histogram: long tail at the right of the median&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It explains why CPU isolation helps to make benchmarks more stable.&lt;/p&gt;
&lt;/div&gt;
</content><category term="benchmark"></category><category term="benchmark"></category></entry><entry><title>My journey to stable benchmark, part 3 (average)</title><link href="https://vstinner.github.io/journey-to-stable-benchmark-average.html" rel="alternate"></link><published>2016-05-23T23:00:00+02:00</published><updated>2016-05-23T23:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-05-23:/journey-to-stable-benchmark-average.html</id><summary type="html">&lt;p class="first last"&gt;My journey to stable benchmark, part 3 (average)&lt;/p&gt;
</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/stanzim/11100202065/"&gt;&lt;img alt="Fog" src="https://vstinner.github.io/images/fog.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;&lt;em&gt;Stable benchmarks are so close, but ...&lt;/em&gt;&lt;/p&gt;
&lt;div class="section" id="address-space-layout-randomization"&gt;
&lt;h2&gt;Address Space Layout Randomization&lt;/h2&gt;
&lt;p&gt;When I started to work on removing the noise of the system, I was told that
disabling &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Address_space_layout_randomization"&gt;Address Space Layout Randomization (ASLR)&lt;/a&gt; makes
benchmarks more stable.&lt;/p&gt;
&lt;p&gt;I followed this advice without trying to understand it. We will see in this
article that it was a bad idea, but I had to hit other issues to really
understand the root issue with disabling ASLR.&lt;/p&gt;
&lt;p&gt;Example of command to see the effect of ASLR, the first number of the output is
the start address of the heap memory:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python -c 'import os; os.system(&amp;quot;grep heap /proc/%s/maps&amp;quot; % os.getpid())'
55e6a716c000-55e6a7235000 rw-p 00000000 00:00 0                          [heap]
&lt;/pre&gt;
&lt;p&gt;Heap address of 3 runs with ASLR enabled (random):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;55e6a716c000&lt;/li&gt;
&lt;li&gt;561c218eb000&lt;/li&gt;
&lt;li&gt;55e6f628f000&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Disable ASLR:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo bash -c 'echo 0 &amp;gt;| /proc/sys/kernel/randomize_va_space'
&lt;/pre&gt;
&lt;p&gt;Heap addresses of 3 runs with ASLR disabled (all the same):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;555555756000&lt;/li&gt;
&lt;li&gt;555555756000&lt;/li&gt;
&lt;li&gt;555555756000&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Note: To reenable ASLR, it's better to use the value 2, the value 1 only
partially enables the feature:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sudo bash -c 'echo 2 &amp;gt;| /proc/sys/kernel/randomize_va_space'
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="python-randomized-hash-function"&gt;
&lt;h2&gt;Python randomized hash function&lt;/h2&gt;
&lt;p&gt;With &lt;a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-system.html"&gt;system tuning  (part 1)&lt;/a&gt;, a
&lt;a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-deadcode.html"&gt;Python compiled with PGO (part 2)&lt;/a&gt;
and ASLR disabled, I still I failed to get the same result when running
manually &lt;tt class="docutils literal"&gt;bm_call_simple.py&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;On Python 3, the hash function is now randomized by default: &lt;a class="reference external" href="http://bugs.python.org/issue13703"&gt;issue #13703&lt;/a&gt;. The problem is that for a
microbenchmark, the number of hash collisions of an &amp;quot;hot&amp;quot; dictionary has a
non-negligible impact on performances.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;PYTHONHASHSEED&lt;/tt&gt; environment variable can be used to get a fixed hash
function. Example with the patch:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ PYTHONHASHSEED=1 taskset -c 1 ./python bm_call_simple.py -n 1
0.198
$ PYTHONHASHSEED=2 taskset -c 1 ./python bm_call_simple.py -n 1
0.201
$ PYTHONHASHSEED=3 taskset -c 1 ./python bm_call_simple.py -n 1
0.207
$ PYTHONHASHSEED=4 taskset -c 1 ./python bm_call_simple.py -n 1
0.187
$ PYTHONHASHSEED=5 taskset -c 1 ./python bm_call_simple.py -n 1
0.180
&lt;/pre&gt;
&lt;p&gt;Timings of the reference python:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ PYTHONHASHSEED=1 taskset -c 1 ./ref_python bm_call_simple.py -n 1
0.204
$ PYTHONHASHSEED=2 taskset -c 1 ./ref_python bm_call_simple.py -n 1
0.206
$ PYTHONHASHSEED=3 taskset -c 1 ./ref_python bm_call_simple.py -n 1
0.195
$ PYTHONHASHSEED=4 taskset -c 1 ./ref_python bm_call_simple.py -n 1
0.192
$ PYTHONHASHSEED=5 taskset -c 1 ./ref_python bm_call_simple.py -n 1
0.187
&lt;/pre&gt;
&lt;p&gt;The minimums is 180 ms for the reference and 186 ms for the patch. The patched
Python is 3% faster, yeah!&lt;/p&gt;
&lt;p&gt;Wait. What if we only test PYTHONHASHSEED from 1 to 3? In this case, the
minimum is 195 ms for the reference and 198 ms for the patch. The patched
Python becomes 2% slower, oh no!&lt;/p&gt;
&lt;p&gt;Faster? Slower? Who is right?&lt;/p&gt;
&lt;p&gt;Maybe I should write a script to find a &lt;tt class="docutils literal"&gt;PYTHONHASHSEED&lt;/tt&gt; value for which my
patch is always faster :-)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="command-line-and-environment-variables"&gt;
&lt;h2&gt;Command line and environment variables&lt;/h2&gt;
&lt;p&gt;Well, let's say that we will use a fixed PYTHONHASHSEED value. Anyway, my
patch doesn't touch the hash function. So it doesn't matter.&lt;/p&gt;
&lt;p&gt;While running benchmarks, I noticed differences when running the benchmark from
a different directory:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cd /home/haypo/prog/python/fastcall
$ PYTHONHASHSEED=3 taskset -c 1 pgo/python ../benchmarks/performance/bm_call_simple.py -n 1
0.215

$ cd /home/haypo/prog/python/benchmarks
$ PYTHONHASHSEED=3 taskset -c 1 ../fastcall/pgo/python ../benchmarks/performance/bm_call_simple.py -n 1
0.203

$ cd /home/haypo/prog/python
$ PYTHONHASHSEED=3 taskset -c 1 fastcall/pgo/python benchmarks/performance/bm_call_simple.py -n 1
0.200
&lt;/pre&gt;
&lt;p&gt;In fact, a different command line is enough so get different results (added
arguments are ignored):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ PYTHONHASHSEED=3 taskset -c 1 ./python bm_call_simple.py -n 1
0.201
$ PYTHONHASHSEED=3 taskset -c 1 ./python bm_call_simple.py -n 1 arg1
0.198
$ PYTHONHASHSEED=3 taskset -c 1 ./python bm_call_simple.py -n 1 arg1 arg2 arg3
0.203
$ PYTHONHASHSEED=3 taskset -c 1 ./python bm_call_simple.py -n 1 arg1 arg2 arg3 arg4 arg5
0.206
$ PYTHONHASHSEED=3 taskset -c 1 ./python bm_call_simple.py -n 1 arg1 arg2 arg3 arg4 arg5 arg6
0.210
&lt;/pre&gt;
&lt;p&gt;I also noticed minor differences when the environment changes (added variables
are ignored):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py -n 1
0.201
$ taskset -c 1 env -i PYTHONHASHSEED=3 VAR1=1 VAR2=2 VAR3=3 VAR4=4 ./python bm_call_simple.py -n 1
0.202
$ taskset -c 1 env -i PYTHONHASHSEED=3 VAR1=1 VAR2=2 VAR3=3 VAR4=4 VAR5=5 ./python bm_call_simple.py -n 1
0.198
&lt;/pre&gt;
&lt;p&gt;Using &lt;tt class="docutils literal"&gt;strace&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;ltrace&lt;/tt&gt;, I saw the memory addresses are different when
something (command line, env var, etc.) changes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="average-and-standard-deviation"&gt;
&lt;h2&gt;Average and standard deviation&lt;/h2&gt;
&lt;p&gt;Basically, it looks like a lot of &amp;quot;external factors&amp;quot; have an impact on the
exact memory addresses, even if ASRL is disabled and PYTHONHASHSEED is set. I
started to think how to get &lt;em&gt;exactly&lt;/em&gt; the same command line, the same
environment (easy), the same current directory (easy), etc. The problem is that
it's just not possible to control all external factors (having an effect on the
exact memory addresses).&lt;/p&gt;
&lt;p&gt;Maybe I was plain wrong from the beginning and ASLR must be enabled,
as the default on Linux:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py
0.198
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py
0.202
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py
0.199
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py
0.207
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py
0.200
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py
0.201
&lt;/pre&gt;
&lt;p&gt;These results look &amp;quot;random&amp;quot;. Yes, they are. It's exactly the purpose of ASLR.&lt;/p&gt;
&lt;p&gt;But how can we compare performances if results are random? Take the minimum?&lt;/p&gt;
&lt;p&gt;No! You must never (ever again) use the minimum for benchmarking! Compute the
average and some statistics like the standard deviation:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3
Python 3.4.3
&amp;gt;&amp;gt;&amp;gt; timings=[0.198, 0.202, 0.199, 0.207, 0.200, 0.201]
&amp;gt;&amp;gt;&amp;gt; import statistics
&amp;gt;&amp;gt;&amp;gt; statistics.mean(timings)
0.2011666666666667
&amp;gt;&amp;gt;&amp;gt; statistics.stdev(timings)
0.0031885210782848245
&lt;/pre&gt;
&lt;p&gt;On this example, the average is 201 ms +/- 3 ms. IMHO the standard deviation is
quite small (reliable) which means that my benchmark is stable. To get a good
distribution, it's better to have many samples. It looks like at least 25
processes are needed. Each process tests a different memory layout and a
different hash function.&lt;/p&gt;
&lt;p&gt;Result of 5 runs, each run uses 25 processes (ASLR enabled, random hash
function):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Average: 205.2 ms +/- 3.0 ms (min: 201.1 ms, max: 214.9 ms)&lt;/li&gt;
&lt;li&gt;Average: 205.6 ms +/- 3.3 ms (min: 201.4 ms, max: 216.5 ms)&lt;/li&gt;
&lt;li&gt;Average: 206.0 ms +/- 3.9 ms (min: 201.1 ms, max: 215.3 ms)&lt;/li&gt;
&lt;li&gt;Average: 205.7 ms +/- 3.6 ms (min: 201.5 ms, max: 217.8 ms)&lt;/li&gt;
&lt;li&gt;Average: 206.4 ms +/- 3.5 ms (min: 201.9 ms, max: 214.9 ms)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;While memory layout and hash functions are random again, the result looks
&lt;em&gt;less&lt;/em&gt; random, and so more reliable, than before!&lt;/p&gt;
&lt;p&gt;With ASLR enabled, the effect of the environment variables, command line and
current directory is negligible on the (average) result.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-average-solves-issues-with-uniform-random-noises"&gt;
&lt;h2&gt;The average solves issues with uniform random noises&lt;/h2&gt;
&lt;p&gt;The user will run the application with default system settings which means
ASLR enabled and Python hash function randomized. Running a benchmark in one
specific environment is a mistake because it is not representative of the
performance in practice.&lt;/p&gt;
&lt;p&gt;Computing the average and standard deviation &amp;quot;fixes&amp;quot; the issue with hash
randomization. It's much better to use random hash functions and compute the
average, than using a fixed hash function (setting &lt;tt class="docutils literal"&gt;PYTHONHASHSEED&lt;/tt&gt; variable
to a value).&lt;/p&gt;
&lt;p&gt;Oh wow, already 3 big articles explaing how to get stable benchmarks. Please
tell me that it was the last one!  Nope, more is coming...&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="annex-why-only-n1"&gt;
&lt;h2&gt;Annex: why only -n1?&lt;/h2&gt;
&lt;p&gt;In this article, I ran &lt;tt class="docutils literal"&gt;bm_call_simple.py&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-n&lt;/span&gt; 1&lt;/tt&gt; with only run one
iteration.&lt;/p&gt;
&lt;p&gt;Usually, a single iteration is not reliable at all, at least 50 iterations are
needed. But thanks to system tuning, compilation with PGO, ASRL disabled and
&lt;tt class="docutils literal"&gt;PYTHONHASHSEED&lt;/tt&gt; set, a single iteration is enough.&lt;/p&gt;
&lt;p&gt;Example of 3 runs, each with 3 iterations:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py -n 3
0.201
0.201
0.201
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py -n 3
0.201
0.201
0.201
$ taskset -c 1 env -i PYTHONHASHSEED=3 ./python bm_call_simple.py -n 3
0.201
0.201
0.201
&lt;/pre&gt;
&lt;p&gt;Always the same timing!&lt;/p&gt;
&lt;/div&gt;
</content><category term="benchmark"></category><category term="optimization"></category><category term="benchmark"></category></entry><entry><title>My journey to stable benchmark, part 2 (deadcode)</title><link href="https://vstinner.github.io/journey-to-stable-benchmark-deadcode.html" rel="alternate"></link><published>2016-05-22T22:00:00+02:00</published><updated>2016-05-22T22:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-05-22:/journey-to-stable-benchmark-deadcode.html</id><summary type="html">&lt;p class="first last"&gt;My journey to stable benchmark, part 2 (deadcode)&lt;/p&gt;
</summary><content type="html">&lt;a class="reference external image-reference" href="https://www.flickr.com/photos/uw67/16875152403/"&gt;&lt;img alt="Snail" src="https://vstinner.github.io/images/snail.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;With &lt;a class="reference external" href="https://vstinner.github.io/journey-to-stable-benchmark-system.html"&gt;the system tuning (part 1)&lt;/a&gt;, I
expected to get very stable benchmarks and so I started to benchmark seriously
my &lt;a class="reference external" href="https://bugs.python.org/issue26814"&gt;FASTCALL branch&lt;/a&gt; of CPython (a new
calling convention avoiding temporary tuples).&lt;/p&gt;
&lt;p&gt;I was disappointed to get many slowdowns in the CPython benchmark suite. I
started to analyze why my change introduced performance regressions.&lt;/p&gt;
&lt;p&gt;I took my overall patch and slowly reverted more and more code to check which
changes introduced most of the slowdowns.&lt;/p&gt;
&lt;p&gt;I focused on the &lt;tt class="docutils literal"&gt;call_simple&lt;/tt&gt; benchmark which does only one thing: call
Python functions which do nothing.  Making Python function calls slower would
be a big and inacceptable mistake of my work.&lt;/p&gt;
&lt;div class="section" id="linux-perf"&gt;
&lt;h2&gt;Linux perf&lt;/h2&gt;
&lt;p&gt;I started to learn how to use the great &lt;a class="reference external" href="https://perf.wiki.kernel.org/index.php/Main_Page"&gt;Linux perf&lt;/a&gt; tool to analyze why
&lt;tt class="docutils literal"&gt;call_simple&lt;/tt&gt; was slower. I tried to find a major difference between my
reference python and the patched python.&lt;/p&gt;
&lt;p&gt;I analyzed cache misses on L1 instruction and data caches.  I analyzed stallen
CPU cycles. I analyzed all memory events, branch events, etc. Basically, I tried
all perf events and spent a lot of time to run benchmarks multiple times.&lt;/p&gt;
&lt;p&gt;By the way, I strongly suggest to use &lt;tt class="docutils literal"&gt;perf stat&lt;/tt&gt; using the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--repeat&lt;/span&gt;&lt;/tt&gt;
command line option to get an average on multiple runs and see the standard
deviation. It helps to get more reliable numbers. I even wrote a Python script
implementing &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;--repeat&lt;/span&gt;&lt;/tt&gt; (run perf multiple times, parse the output), before
seeing that it was already a builtin feature!&lt;/p&gt;
&lt;p&gt;Use &lt;tt class="docutils literal"&gt;perf list&lt;/tt&gt; to list all available (pre-defined) events.&lt;/p&gt;
&lt;p&gt;After many days, I decided to give up with perf.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="cachegrind"&gt;
&lt;h2&gt;Cachegrind&lt;/h2&gt;
&lt;a class="reference external image-reference" href="http://valgrind.org/"&gt;&lt;img alt="Logo of the Valgrind project" src="https://vstinner.github.io/images/valgrind.png" /&gt;&lt;/a&gt;
&lt;p&gt;&lt;a class="reference external" href="http://valgrind.org/"&gt;Valgrind&lt;/a&gt; is a great tool known to detect memory
leaks, but it also contains gems like the &lt;a class="reference external" href="http://valgrind.org/docs/manual/cg-manual.html"&gt;Cachegrind tool&lt;/a&gt; which &lt;em&gt;simulates&lt;/em&gt; the
CPU caches.&lt;/p&gt;
&lt;p&gt;I used Cachegrind with the nice &lt;a class="reference external" href="http://kcachegrind.sourceforge.net/"&gt;Kcachegrind GUI&lt;/a&gt;. Sadly, I also failed to see anything
obvious in cache misses between the reference python and the patched python.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="strace-and-ltrace"&gt;
&lt;h2&gt;strace and ltrace&lt;/h2&gt;
&lt;img alt="strace and ltrace" src="https://vstinner.github.io/images/strace_ltrace.png" /&gt;
&lt;p&gt;I also tried &lt;tt class="docutils literal"&gt;strace&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;ltrace&lt;/tt&gt; tools to try to see a difference in the
execution of the reference and the patched pythons. I saw different memory
addresses, but no major difference which can explain a difference of the
timing.&lt;/p&gt;
&lt;p&gt;Morever, the hotcode simply does not call any syscall nor library
function. It's pure CPU-bound code.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="compiler-options"&gt;
&lt;h2&gt;Compiler options&lt;/h2&gt;
&lt;a class="reference external image-reference" href="https://gcc.gnu.org/"&gt;&lt;img alt="GCC logo" class="align-right" src="https://vstinner.github.io/images/gcc.png" /&gt;&lt;/a&gt;
&lt;p&gt;I used &lt;a class="reference external" href="https://gcc.gnu.org/"&gt;GCC&lt;/a&gt; to build to code. Just in case, I tried
LLVM compiler, but it didn't &amp;quot;fix&amp;quot; the issue.&lt;/p&gt;
&lt;p&gt;I also tried different optimization levels: &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-O0&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-O1&lt;/span&gt;&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-O2&lt;/span&gt;&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-O3&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I read that the exact address of functions can have an impact on the CPU L1
cache: &lt;a class="reference external" href="https://stackoverflow.com/questions/19470873/why-does-gcc-generate-15-20-faster-code-if-i-optimize-for-size-instead-of-speed"&gt;Why does gcc generate 15-20% faster code if I optimize for size instead
of speed?&lt;/a&gt;.
I tried various values of the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-falign-functions=N&lt;/span&gt;&lt;/tt&gt; option (1, 2, 6, 12).&lt;/p&gt;
&lt;p&gt;I also tried &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-fomit-pointer&lt;/span&gt;&lt;/tt&gt; (omit frame pointer) to record the callgraph with &lt;tt class="docutils literal"&gt;perf record&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I also tried &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;-flto&lt;/span&gt;&lt;/tt&gt;: Link Time Optimization (LTO).&lt;/p&gt;
&lt;p&gt;These compiler options didn't fix the issue.&lt;/p&gt;
&lt;p&gt;The truth is out there.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;UPDATE:&lt;/strong&gt; See also &lt;a class="reference external" href="https://lwn.net/Articles/534735/"&gt;Rethinking optimization for size&lt;/a&gt; article on Linux Weekly News (LWN):
&lt;em&gt;&amp;quot;Such an option has obvious value if one is compiling for a
space-constrained environment like a small device. But it turns out that, in
some situations, optimizing for space can also produce faster code.&amp;quot;&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="when-cpython-performance-depends-on-dead-code"&gt;
&lt;h2&gt;When CPython performance depends on dead code&lt;/h2&gt;
&lt;p&gt;I continued to revert changes. At the end, my giant patch was reduced to very
few changes only adding code which was never called (at least, I was sure
that it was not called in the &lt;tt class="docutils literal"&gt;call_simple&lt;/tt&gt; benchmark).&lt;/p&gt;
&lt;p&gt;Let me rephase: &lt;em&gt;adding dead code&lt;/em&gt; makes Python slower. What?&lt;/p&gt;
&lt;p&gt;A colleague suggested me to remove the body (replace it with &lt;tt class="docutils literal"&gt;return;&lt;/tt&gt;) of
added function: the code became faster. Ok, now I'm completely lost. To be
clear, I don't expect that adding dead code would have &lt;em&gt;any&lt;/em&gt; impact on the
performance.&lt;/p&gt;
&lt;p&gt;My email &lt;a class="reference external" href="https://mail.python.org/pipermail/speed/2016-April/000341.html"&gt;When CPython performance depends on dead code...&lt;/a&gt; explains how
to reproduce the issue and contains many information.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="solution-pgo"&gt;
&lt;h2&gt;Solution: PGO&lt;/h2&gt;
&lt;p&gt;The solution is called Profiled Guided Optimization, &amp;quot;PGO&amp;quot;. Python build system
supports it in a single command: &lt;tt class="docutils literal"&gt;make &lt;span class="pre"&gt;profile-opt&lt;/span&gt;&lt;/tt&gt;. It profiles the
execution of the Python test suite.&lt;/p&gt;
&lt;p&gt;Using PGO, adding dead code has no more impact on the performance.&lt;/p&gt;
&lt;p&gt;With system tuning and PGO compilation, benchmarks must now be stable this
time, no? ... No, sorry, not yet. We will see more sources of noise in
following articles ;-)&lt;/p&gt;
&lt;/div&gt;
</content><category term="benchmark"></category><category term="optimization"></category><category term="benchmark"></category></entry><entry><title>My journey to stable benchmark, part 1 (system)</title><link href="https://vstinner.github.io/journey-to-stable-benchmark-system.html" rel="alternate"></link><published>2016-05-21T16:50:00+02:00</published><updated>2016-05-21T16:50:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-05-21:/journey-to-stable-benchmark-system.html</id><summary type="html">&lt;p class="first last"&gt;My journey to stable benchmark, part 1&lt;/p&gt;
</summary><content type="html">&lt;div class="section" id="background"&gt;
&lt;h2&gt;Background&lt;/h2&gt;
&lt;p&gt;In the CPython development, it became common to require the result of the
&lt;a class="reference external" href="https://hg.python.org/benchmarks"&gt;CPython benchmark suite&lt;/a&gt; (&amp;quot;The Grand
Unified Python Benchmark Suite&amp;quot;) to evaluate the effect of an optimization
patch. The minimum requirement is to not introduce performance regressions.&lt;/p&gt;
&lt;p&gt;I used the CPython benchmark suite and I had many bad surprises when trying to
analyze (understand) results. A change expected to be faster makes some
benchmarks slower without any obvious reason. At least, the change is expected
to be faster on some specific benchmarks, but have no impact on the other
benchmarks. The slowdown is usually between 5% and 10% slower. I am not
confortable with any kind of slowdown.&lt;/p&gt;
&lt;p&gt;Many benchmarks look unstable. The problem is to trust the overall report.
Some developers started to say that they learnt to ignore some benchmarks known
to be unstable.&lt;/p&gt;
&lt;p&gt;It's not the first time that I am totally disappointed by microbenchmark
results, so I decided to analyze completely the issue and go as deep as
possible to really understand the problem.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="how-to-get-stable-benchmarks-on-a-busy-linux-system"&gt;
&lt;h2&gt;How to get stable benchmarks on a busy Linux system&lt;/h2&gt;
&lt;p&gt;A common advice to get stable benchmark is to stay away the keyboard
(&amp;quot;freeze!&amp;quot;) and stop all other applications to only run one application, the
benchmark.&lt;/p&gt;
&lt;p&gt;Well, I'm working on a single computer and the full CPython benchmark suite
take up to 2 hours in rigorous mode. I just cannot stop working during 2 hours
to wait for the result of the benchmark. I like running benchmarks locally. It
is convenient to run benchmarks on the same computer used to develop.&lt;/p&gt;
&lt;p&gt;The goal here is to &amp;quot;remove the noise of the system&amp;quot;. Get the same result on a
busy system than an idle system. My simple &lt;a class="reference external" href="https://github.com/vstinner/misc/blob/master/bin/system_load.py"&gt;system_load.py&lt;/a&gt; program can be
used to increase the system load. For example, run &lt;tt class="docutils literal"&gt;system_load.py 10&lt;/tt&gt; in a
terminal to get at least a system load of 10 (busy system) and run the
benchmark in a different terminal. Use CTRL+c to stop &lt;tt class="docutils literal"&gt;system_load.py&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="cpu-isolation"&gt;
&lt;h2&gt;CPU isolation&lt;/h2&gt;
&lt;p&gt;In 2016, it is common to get a CPU with multiple physical cores. For example,
my Intel CPU has 4 physical cores and 8 logical cores thanks to
&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Hyper-threading"&gt;Hyper-Threading&lt;/a&gt;. It is
possible to configure the Linux kernel to not schedule processes on some CPUs
using the &amp;quot;CPU isolation&amp;quot; feature. It is the &lt;tt class="docutils literal"&gt;isolcpus&lt;/tt&gt; parameter of the
Linux command line, the value is a list of CPUs. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
isolcpus=2,3,6,7
&lt;/pre&gt;
&lt;p&gt;Check with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/devices/system/cpu/isolated
2-3,6-7
&lt;/pre&gt;
&lt;p&gt;If you have Hyper-Threading, you must isolate the two logicial cores of each
isolated physical core. You can use the &lt;tt class="docutils literal"&gt;lscpu &lt;span class="pre"&gt;--all&lt;/span&gt; &lt;span class="pre"&gt;--extended&lt;/span&gt;&lt;/tt&gt; command to
identify physical cores. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ lscpu -a -e
CPU NODE SOCKET CORE L1d:L1i:L2:L3 ONLINE MAXMHZ    MINMHZ
0   0    0      0    0:0:0:0       yes    5900,0000 1600,0000
1   0    0      1    1:1:1:0       yes    5900,0000 1600,0000
2   0    0      2    2:2:2:0       yes    5900,0000 1600,0000
3   0    0      3    3:3:3:0       yes    5900,0000 1600,0000
4   0    0      0    0:0:0:0       yes    5900,0000 1600,0000
5   0    0      1    1:1:1:0       yes    5900,0000 1600,0000
6   0    0      2    2:2:2:0       yes    5900,0000 1600,0000
7   0    0      3    3:3:3:0       yes    5900,0000 1600,0000
&lt;/pre&gt;
&lt;p&gt;The physical core &lt;tt class="docutils literal"&gt;0&lt;/tt&gt; (CORE column) is made of two logical cores (CPU
column): &lt;tt class="docutils literal"&gt;0&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;4&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="nohz-mode"&gt;
&lt;h2&gt;NOHZ mode&lt;/h2&gt;
&lt;p&gt;By default, the Linux kernel uses a scheduling-clock which interrupts the
running application &lt;tt class="docutils literal"&gt;HZ&lt;/tt&gt; times per second to run the scheduler. &lt;tt class="docutils literal"&gt;HZ&lt;/tt&gt; is
usually between 100 and 1000: time slice between 1 ms and 10 ms.&lt;/p&gt;
&lt;p&gt;Linux supports a &lt;a class="reference external" href="https://www.kernel.org/doc/Documentation/timers/NO_HZ.txt"&gt;NOHZ mode&lt;/a&gt; which is able to
disable the scheduling-clock when the system is idle to reduce the power
consumption. Linux 3.10 introduces a &lt;a class="reference external" href="https://lwn.net/Articles/549580/"&gt;full ticketless mode&lt;/a&gt;, NOHZ full, which is able to disable the
scheduling-clock when only one application is running on a CPU.&lt;/p&gt;
&lt;p&gt;NOHZ full is disabled by default. It can be enabled with the &lt;tt class="docutils literal"&gt;nohz_full&lt;/tt&gt;
parameter of the Linux command line, the value is a list of CPUs. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
nohz_full=2,3,6,7
&lt;/pre&gt;
&lt;p&gt;Check with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ cat /sys/devices/system/cpu/nohz_full
2-3,6-7
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="interrupts-irq"&gt;
&lt;h2&gt;Interrupts (IRQ)&lt;/h2&gt;
&lt;p&gt;The Linux kernel can also be configured to not run &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Interrupt_request_%28PC_architecture%29"&gt;interruptions (IRQ)&lt;/a&gt;
handlers on some CPUs using &lt;tt class="docutils literal"&gt;/proc/irq/default_smp_affinity&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;/proc/irq/&amp;lt;number&amp;gt;/smp_affinity&lt;/span&gt;&lt;/tt&gt; files. The value is not a list of CPUs but
a bitmask.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;/proc/interrupts&lt;/tt&gt; file can be read to see the number of interruptions
per CPU.&lt;/p&gt;
&lt;p&gt;Read the &lt;a class="reference external" href="https://www.kernel.org/doc/Documentation/IRQ-affinity.txt"&gt;Linux SMP IRQ affinity&lt;/a&gt; documentation.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="example-of-effect-of-cpu-isolation-on-a-microbenchmark"&gt;
&lt;h2&gt;Example of effect of CPU isolation on a microbenchmark&lt;/h2&gt;
&lt;p&gt;Example with Linux parameters:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
isolcpus=2,3,6,7 nohz_full=2,3,6,7
&lt;/pre&gt;
&lt;p&gt;Microbenchmark on an idle system (without CPU isolation):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -m timeit 'sum(range(10**7))'
10 loops, best of 3: 229 msec per loop
&lt;/pre&gt;
&lt;p&gt;Result on a busy system using &lt;tt class="docutils literal"&gt;system_load.py 10&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;find /&lt;/tt&gt; commands
running in other terminals:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -m timeit 'sum(range(10**7))'
10 loops, best of 3: 372 msec per loop
&lt;/pre&gt;
&lt;p&gt;The microbenchmark is 56% slower because of the high system load!&lt;/p&gt;
&lt;p&gt;Result on the same busy system but using isolated CPUs. The &lt;tt class="docutils literal"&gt;taskset&lt;/tt&gt; command
allows to pin an application to specific CPUs:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ taskset -c 1,3 python3 -m timeit 'sum(range(10**7))'
10 loops, best of 3: 230 msec per loop
&lt;/pre&gt;
&lt;p&gt;Just to check, new run without CPU isolation:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
$ python3 -m timeit 'sum(range(10**7))'
10 loops, best of 3: 357 msec per loop
&lt;/pre&gt;
&lt;p&gt;The result with CPU isolation on a busy system is the same than the result an
idle system! CPU isolation removes most of the noise of the system.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Great job Linux!&lt;/p&gt;
&lt;p&gt;Ok! Now, the benchmark is super stable, no? ...  Sorry, no, it's not stable yet.
I found a lot of other sources of &amp;quot;noise&amp;quot;.  We will see them in the following
articles ;-)&lt;/p&gt;
&lt;/div&gt;
</content><category term="benchmark"></category><category term="optimization"></category><category term="benchmark"></category></entry><entry><title>Status of Python 3 in OpenStack Mitaka</title><link href="https://vstinner.github.io/openstack_mitaka_python3.html" rel="alternate"></link><published>2016-03-02T14:00:00+01:00</published><updated>2016-03-02T14:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-03-02:/openstack_mitaka_python3.html</id><summary type="html">&lt;p class="first last"&gt;Status of Python 3 in OpenStack Mitaka&lt;/p&gt;
</summary><content type="html">&lt;p&gt;Now that most OpenStack services have reached feature freeze for the Mitaka
cycle (November 2015-April 2016), it's time to look back on the progress made
for Python 3 support.&lt;/p&gt;
&lt;p&gt;Previous status update: &lt;a class="reference external" href="http://techs.enovance.com/7807/python-3-status-openstack-liberty"&gt;Python 3 Status in OpenStack Liberty&lt;/a&gt;
(September 2015).&lt;/p&gt;
&lt;div class="section" id="services-ported-to-python-3"&gt;
&lt;h2&gt;Services ported to Python 3&lt;/h2&gt;
&lt;p&gt;13 services were ported to Python 3 during the Mitaka cycle:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Cinder&lt;/li&gt;
&lt;li&gt;Congress&lt;/li&gt;
&lt;li&gt;Designate&lt;/li&gt;
&lt;li&gt;Glance&lt;/li&gt;
&lt;li&gt;Heat&lt;/li&gt;
&lt;li&gt;Horizon&lt;/li&gt;
&lt;li&gt;Manila&lt;/li&gt;
&lt;li&gt;Mistral&lt;/li&gt;
&lt;li&gt;Octavia&lt;/li&gt;
&lt;li&gt;Searchlight&lt;/li&gt;
&lt;li&gt;Solum&lt;/li&gt;
&lt;li&gt;Watcher&lt;/li&gt;
&lt;li&gt;Zaqar&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Red Hat contributed to the Cinder, Designate, Glance and Horizon service
porting efforts.&lt;/p&gt;
&lt;p&gt;&amp;quot;Ported to Python 3&amp;quot; means that all unit tests pass on Python 3.4 which is
verified by a voting gate job. It is not enough to run applications in
production with Python 3. Integration and functional tests are not run on
Python 3 yet. See the section dedicated to these tests below.&lt;/p&gt;
&lt;p&gt;See the &lt;a class="reference external" href="https://wiki.openstack.org/wiki/Python3"&gt;Python 3 wiki page&lt;/a&gt; for the
current status of the OpenStack port to Python 3; especially the list of
services ported to Python 3.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="services-not-ported-yet"&gt;
&lt;h2&gt;Services not ported yet&lt;/h2&gt;
&lt;p&gt;It's become easier to list services which are not compatible with Python 3 than
listing services already ported to Python 3!&lt;/p&gt;
&lt;p&gt;9 services still need to be ported:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Work-in-progress:&lt;ul&gt;
&lt;li&gt;Magnum: 83% (959 unit tests/1,161)&lt;/li&gt;
&lt;li&gt;Cue: 81% (208 unit tests/257)&lt;/li&gt;
&lt;li&gt;Nova: 74% (10,859 unit tests/14,726)&lt;/li&gt;
&lt;li&gt;Barbican: 34% (392 unit tests/1168)&lt;/li&gt;
&lt;li&gt;Murano: 29% (133 unit tests/455)&lt;/li&gt;
&lt;li&gt;Keystone: 27% (1200 unit tests/4455)&lt;/li&gt;
&lt;li&gt;Swift: 0% (3 unit tests/4,435)&lt;/li&gt;
&lt;li&gt;Neutron-LBaaS: 0% (1 unit test/806)&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Port not started yet:&lt;ul&gt;
&lt;li&gt;Trove: no python34 gate&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Red Hat contributed Python 3 patches to Cue, Neutron-LBaaS, Swift and Trove
during the Mitaka cycle.&lt;/p&gt;
&lt;p&gt;Trove developers are ready to start the port at the beginning of the next cycle
(Newton). The py34 test environment was blocked by the MySQL-Python dependency (it
was not possible to build the test environment), but this dependency is now
skipped on Python 3. Later, it will be &lt;a class="reference external" href="https://review.openstack.org/#/c/225915/"&gt;replaced with PyMySQL&lt;/a&gt; on Python 2 and Python 3.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-issues-in-eventlet"&gt;
&lt;h2&gt;Python 3 issues in Eventlet&lt;/h2&gt;
&lt;p&gt;Four Python 3 issues were fixed in Eventlet:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/eventlet/eventlet/issues/295"&gt;Issue #295: Python 3: wsgi doesn't handle correctly partial write of
socket send() when using writelines()&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;PR #275: &lt;a class="reference external" href="https://github.com/eventlet/eventlet/pull/275"&gt;Issue #274: Fix GreenSocket.recv_into()&lt;/a&gt;.
Issue: &lt;a class="reference external" href="https://github.com/eventlet/eventlet/issues/274"&gt;On Python 3, sock.makefile('rb').readline() doesn't handle blocking
errors correctly&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;PR #257: &lt;a class="reference external" href="https://github.com/eventlet/eventlet/pull/257"&gt;Fix GreenFileIO.readall() for regular file&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/eventlet/eventlet/issues/248"&gt;Issue #248: eventlet.monkey_patch() on Python 3.4 makes stdout
non-blocking&lt;/a&gt;: pull
request &lt;a class="reference external" href="https://github.com/eventlet/eventlet/pull/250"&gt;Fix GreenFileIO.write()&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="next-milestone-functional-and-integration-tests"&gt;
&lt;h2&gt;Next Milestone: Functional and integration tests&lt;/h2&gt;
&lt;p&gt;The next major milestone will be to run functional and integration tests on
Python 3.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;functional tests are restricted to one component (ex: only Glance)&lt;/li&gt;
&lt;li&gt;integration tests, like Tempest, test the integration of multiple components&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It is now possible to install some packages on Python 3 in DevStack using
&lt;tt class="docutils literal"&gt;USE_PYTHON3&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;PYTHON3_VERSION&lt;/tt&gt; variables: &lt;a class="reference external" href="https://review.openstack.org/#/c/181165/"&gt;Enable optional Python 3
support&lt;/a&gt;. It means that it is
possible to run tests with some services running on Python 3, and the remaining
services on Python 2.&lt;/p&gt;
&lt;p&gt;The port to Python 3 of Glance, Heat and Neutron functional and integration
tests have already started.&lt;/p&gt;
&lt;p&gt;For Glance, 159 functional tests already pass on Python 3.4.&lt;/p&gt;
&lt;p&gt;Heat:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;project-config: &lt;a class="reference external" href="https://review.openstack.org/#/c/228194/"&gt;Add python34 integration test job for Heat&lt;/a&gt; (WIP)&lt;/li&gt;
&lt;li&gt;heat: &lt;a class="reference external" href="https://review.openstack.org/#/c/188033/"&gt;py34: integration tests&lt;/a&gt;
(WIP)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Neutron: the &lt;a class="reference external" href="https://review.openstack.org/#/c/231897/"&gt;Add the functional-py34 and dsvm-functional-py34 targets to
tox.ini&lt;/a&gt; change was merged, but a
gate job hasn't been added for it yet.&lt;/p&gt;
&lt;p&gt;Another pending project is to fix issues specific to Python 3.5, but the gate
doesn’t use Python 3.5 yet. There are some minor issues, probably easy to fix.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="how-to-port-remaining-code"&gt;
&lt;h2&gt;How to port remaining code?&lt;/h2&gt;
&lt;p&gt;The &lt;a class="reference external" href="https://wiki.openstack.org/wiki/Python3"&gt;Python 3 wiki page&lt;/a&gt; contains
a lot of information about adding Python 3 support to Python 2 code.&lt;/p&gt;
&lt;p&gt;Join us in the &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;#openstack-python3&lt;/span&gt;&lt;/tt&gt; IRC channel on Freenode to discuss
Python 3!&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="openstack"></category><category term="python3"></category></entry><entry><title>Fast _PyAccu, _PyUnicodeWriter and_PyBytesWriter APIs to produce strings in CPython</title><link href="https://vstinner.github.io/pybyteswriter.html" rel="alternate"></link><published>2016-03-01T16:00:00+01:00</published><updated>2016-03-01T16:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-03-01:/pybyteswriter.html</id><summary type="html">&lt;p class="first last"&gt;_PyBytesWriter API&lt;/p&gt;
</summary><content type="html">&lt;p&gt;This article described the _PyBytesWriter and _PyUnicodeWriter private APIs of
CPython. These APIs are design to optimize code producing strings when the
ouput size is not known in advance.&lt;/p&gt;
&lt;p&gt;I created the _PyUnicodeWriter API to reply to complains that Python 3 was much
slower than Python 2, especially with the new Unicode implementation (PEP 393).&lt;/p&gt;
&lt;div class="section" id="pyaccu-api"&gt;
&lt;h2&gt;_PyAccu API&lt;/h2&gt;
&lt;p&gt;Issue #12778: In 2011, Antoine Pitrou found a performance issue in the JSON
serializer when serializing many small objects: it used way too much memory for
temporary objects compared to the final output string.&lt;/p&gt;
&lt;p&gt;The JSON serializer used a list of strings and joined all strings at the end of
create a final output string. Pseudocode:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def serialize():
    pieces = [serialize(item) for item in self]
    return ''.join(pieces)
&lt;/pre&gt;
&lt;p&gt;Antoine introduced an accumulator compacting the temporary list of &amp;quot;small&amp;quot;
strings and put the result in a second list of &amp;quot;large&amp;quot; strings. At the end, the
list of &amp;quot;large&amp;quot; strings was also compacted to build the final output string.
Pseudo-code:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def serialize():
    small = []
    large = []
    for item in self:
        small.append(serialize(item))
        if len(small) &amp;gt; 10000:
            large.append(''.join(small))
            small.clear()
    if small
        large.append(''.join(small))
    return ''.join(large)
&lt;/pre&gt;
&lt;p&gt;The threshold of 10,000  strings is justified by this comment:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/* Each item in a list of unicode objects has an overhead (in 64-bit
 * builds) of:
 *   - 8 bytes for the list slot
 *   - 56 bytes for the header of the unicode object
 * that is, 64 bytes.  100000 such objects waste more than 6MB
 * compared to a single concatenated string.
 */
&lt;/pre&gt;
&lt;p&gt;Issue #12911: Antoine Pitrou found a similar performance issue in repr(list),
and so proposed to convert its accumular code into a new private _PyAccu API.
He added the _PyAccu API to Python 2.7.5 and 3.2.3. Title of te repr(list)
change: &amp;quot;Fix memory consumption when calculating the repr() of huge tuples or
lists&amp;quot;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-pyunicodewriter-api"&gt;
&lt;h2&gt;The _PyUnicodeWriter API&lt;/h2&gt;
&lt;div class="section" id="inefficient-implementation-of-the-pep-393"&gt;
&lt;h3&gt;Inefficient implementation of the PEP 393&lt;/h3&gt;
&lt;p&gt;In 2010, Python 3.3 got a completly new Unicode implementation, the Python type
&lt;tt class="docutils literal"&gt;str&lt;/tt&gt;, with the PEP 393. The implementation of the PEP was the topic of a
Google Summer of Code 2011 with the student Torsten Becker menthored by Martin
v. Löwis (author of the PEP). The project was successful: the PEP 393 was
implemented, it worked!&lt;/p&gt;
&lt;p&gt;The first implementation of the PEP 393 used a lot of 32-bit character buffers
(&lt;tt class="docutils literal"&gt;Py_UCS4&lt;/tt&gt;) which uses a lot of memory and requires expensive conversion to
8-bit (&lt;tt class="docutils literal"&gt;Py_UCS1&lt;/tt&gt;, ASCII and Latin1) or 16-bit (&lt;tt class="docutils literal"&gt;Py_UCS2&lt;/tt&gt;, BMP) characters.&lt;/p&gt;
&lt;p&gt;The new internal structures for Unicode strings are now very complex and
require to be smart when building a new string to avoid memory copies. I
created the _PyUnicodeWriter API to try to reduce expensive memory copies, and
even completly avoid memory copies in best cases.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="design-of-the-pyunicodewriter-api"&gt;
&lt;h3&gt;Design of the _PyUnicodeWriter API&lt;/h3&gt;
&lt;p&gt;According to benchmarks, creating a &lt;tt class="docutils literal"&gt;Py_UCS1*&lt;/tt&gt; buffer and then expand it
to &lt;tt class="docutils literal"&gt;Py_UCS2*&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;Py_UCS4*&lt;/tt&gt; is more efficient, since &lt;tt class="docutils literal"&gt;Py_UCS1*&lt;/tt&gt; is the
most common format.&lt;/p&gt;
&lt;p&gt;Python &lt;tt class="docutils literal"&gt;str&lt;/tt&gt; type is used for a wide range of usages. For example, it is used
for the name of variable names in the Python language itself. Variable names
are almost always ASCII.&lt;/p&gt;
&lt;p&gt;The worst case for _PyUnicodeWriter is when a long &lt;tt class="docutils literal"&gt;Py_UCS1*&lt;/tt&gt; buffer must be
converted to &lt;tt class="docutils literal"&gt;Py_UCS2*&lt;/tt&gt;, and then converted to &lt;tt class="docutils literal"&gt;Py_UCS4*&lt;/tt&gt;. Each conversion
is expensive: need to allocate a second memory block and convert characters to
the new format.&lt;/p&gt;
&lt;p&gt;_PyUnicodeWriter features:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Optional overallocation: overallocate the buffer by 50% on Windows and 25%
on Linux. The ratio changes depending on the OS, it is a raw heuristic to get
the best performances depending on the &lt;tt class="docutils literal"&gt;malloc()&lt;/tt&gt; memory allocator.&lt;/li&gt;
&lt;li&gt;The buffer can be a shared read-only string if the buffer was only created
from a single string. Micro-optimization for &lt;tt class="docutils literal"&gt;&amp;quot;%s&amp;quot; % str&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The API allows to disable overallocation before the last write. For example,
&lt;tt class="docutils literal"&gt;&amp;quot;%s%s&amp;quot; % ('abc', 'def')&lt;/tt&gt; disables the overallocation before writing
&lt;tt class="docutils literal"&gt;'def'&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;The _PyUnicodeWriter was introduced by the issue #14716 (change 7be716a47e9d):&lt;/p&gt;
&lt;blockquote&gt;
Close #14716: str.format() now uses the new &amp;quot;unicode writer&amp;quot; API instead
of the PyAccu API. For example, it makes str.format() from 25% to 30%
faster on Linux.&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="fast-path-for-ascii"&gt;
&lt;h3&gt;Fast-path for ASCII&lt;/h3&gt;
&lt;p&gt;The cool and &lt;em&gt;unexpected&lt;/em&gt; side-effect of the _PyUnicodeWriter is that many
intermediate operations got a fast-path for &lt;tt class="docutils literal"&gt;Py_UCS1*&lt;/tt&gt;, especially for ASCII
strings. For example, padding a number with spaces on &lt;tt class="docutils literal"&gt;'%10i' % 123&lt;/tt&gt; is
implemented with &lt;tt class="docutils literal"&gt;memset()&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;Formating a floating point number uses the &lt;tt class="docutils literal"&gt;PyOS_double_to_string()&lt;/tt&gt; function
which creates an ASCII buffer. If the writer buffer uses Py_UCS1, a
&lt;tt class="docutils literal"&gt;memcpy()&lt;/tt&gt; is enough to copy the formatted number.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="avoid-temporary-buffers"&gt;
&lt;h3&gt;Avoid temporary buffers&lt;/h3&gt;
&lt;p&gt;Since the beginning, I had the idea of avoiding temporary buffers thanks
to an unified API to handle a &amp;quot;Unicode buffer&amp;quot;. Slowly, I spread my changes
to all functions producing Unicode strings.&lt;/p&gt;
&lt;p&gt;The obvious target were &lt;tt class="docutils literal"&gt;str % args&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;str.format(args)&lt;/tt&gt;. Both
instructions use very different code, but it was possible to share a few
functions especially the code to format integers in bases 2 (binary), 8
(octal), 10 (decimal) and 16 (hexadecimal).&lt;/p&gt;
&lt;p&gt;The function formatting an integer computes the exact size of the output,
requests a number of characters and then write characters. The characters are
written directly in the writer buffer. No temporary memory block is needed
anymore, and moreover no Py_UCS conversion is need: &lt;tt class="docutils literal"&gt;_PyLong_Format()&lt;/tt&gt; writes
directly characters into the character format (PyUCS1, Py_UCS2 or Py_UCS4) of
the buffer.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="performance-compared-to-python-2"&gt;
&lt;h3&gt;Performance compared to Python 2&lt;/h3&gt;
&lt;p&gt;The PEP 393 uses a complex storage for strings, so the exact performances
now depends on the character set used in the benchmark. For benchmarks using
a character set different than ASCII, the result are more tricky to understand.&lt;/p&gt;
&lt;p&gt;To compare performances with Python 2, I focused my benchmarks on ASCII.  I
compared Python 3 str with Python 2 unicode, but also sometimes to Python 2 str
(bytes). On ASCII, Python 3.3 was as fast as Python 2, or even faster on some
very specific cases, but these cases are probably artificial and never seen in
real applications.&lt;/p&gt;
&lt;p&gt;In the best case, Python 3 str (Unicode) was faster than Python 2 bytes.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="pybyteswriter-api-first-try-big-fail"&gt;
&lt;h2&gt;_PyBytesWriter API: first try, big fail&lt;/h2&gt;
&lt;p&gt;Since Python was &lt;em&gt;much&lt;/em&gt; faster with _PyUnicodeWriter, I expected to get good
speedup with a similar API for bytes. The graal would be to share code for
bytes and Unicode (Spoiler alert! I reached this goal, but only for a single
function: format an integer to decimal).&lt;/p&gt;
&lt;p&gt;My first attempt of a _PyBytesWriter API was in 2013: &lt;a class="reference external" href="https://bugs.python.org/issue17742"&gt;Issue #17742: Add
_PyBytesWriter API&lt;/a&gt;. But quickly, I
noticed with microbenchmarks that my change made Python slower! I spent hours
to understand why GCC produced less efficient machine code. When I started to
dig the &amp;quot;strict aliasing&amp;quot; optimization issue, I realized that I reached a
deadend.&lt;/p&gt;
&lt;p&gt;Extract of the _PyBytesWriter structure:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
typedef struct {
    /* Current position in the buffer */
    char *str;

    /* Start of the buffer */
    char *start;

    /* End of the buffer */
    char *end;

    ...
} _PyBytesWriter;
&lt;/pre&gt;
&lt;p&gt;The problem is that GCC emited less efficient machine code for the C code (see
my &lt;a class="reference external" href="https://bugs.python.org/issue17742#msg187595"&gt;msg187595&lt;/a&gt;):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
while (collstart++&amp;lt;collend)
    *writer.str++ = '?';
&lt;/pre&gt;
&lt;p&gt;For the &lt;tt class="docutils literal"&gt;writer.str++&lt;/tt&gt; instruction, the new pointer value is written
immediatly in the structure. The pointer value is read again at each iteration.
So we have 1 LOAD and 1 STORE per iteration.&lt;/p&gt;
&lt;p&gt;GCC emits better code for the original C code:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
while (collstart++&amp;lt;collend)
    *str++ = '?';
&lt;/pre&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;str&lt;/tt&gt; variable is stored in a register and the new value of &lt;tt class="docutils literal"&gt;str&lt;/tt&gt; is
only written &lt;em&gt;once&lt;/em&gt;, at the end of loop (instead of writing it at each
iteration). The pointer value is &lt;em&gt;only read once&lt;/em&gt; before the loop. So we have 0
LOAD and 0 STORE (related to the pointer value) in the loop body.&lt;/p&gt;
&lt;p&gt;It looks like an aliasing issue, but I didn't find how to say to GCC that the
new value of &lt;tt class="docutils literal"&gt;writer.str&lt;/tt&gt; can be written only once at the end of the loop. I
tried the &lt;tt class="docutils literal"&gt;__restrict__&lt;/tt&gt; keyword: the LOAD (get the pointer value) was moved
out of the loop. But the STORE was still in the loop body.&lt;/p&gt;
&lt;p&gt;I wrote to gcc-help: &lt;a class="reference external" href="https://gcc.gnu.org/ml/gcc-help/2013-04/msg00192.html"&gt;Missed optimization when using a structure&lt;/a&gt;, but I didn't get any
reply. I just gave up.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pybyteswriter-api-new-try-the-good-one"&gt;
&lt;h2&gt;_PyBytesWriter API: new try, the good one&lt;/h2&gt;
&lt;p&gt;In 2015, I created the &lt;a class="reference external" href="https://bugs.python.org/issue25318"&gt;Issue #25318: Add _PyBytesWriter API to optimize
Unicode encoders&lt;/a&gt;. I redesigned the API
to avoid the aliasing issue.&lt;/p&gt;
&lt;p&gt;The new _PyBytesWriter doesn't contain the &lt;tt class="docutils literal"&gt;char*&lt;/tt&gt; pointers anymore: they are
now local variables in functions. Instead, functions of API requires two
parameters: the bytes writer and a &lt;tt class="docutils literal"&gt;char*&lt;/tt&gt; parameter. Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
PyObject * _PyBytesWriter_Finish(_PyBytesWriter *writer, char *str)
&lt;/pre&gt;
&lt;p&gt;The idea is to keep &lt;tt class="docutils literal"&gt;char*&lt;/tt&gt; pointers in functions to keep the most efficient
machine code in loops. The compiler doesn't have to compute complex aliasing
rules to decide if a CPU register can be used or not.&lt;/p&gt;
&lt;p&gt;_PyBytesWriter features:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Optional overallocation: overallocate the buffer by 25% on Windows and 50%
on Linux. Same idea than _PyUnicodeWriter.&lt;/li&gt;
&lt;li&gt;Support &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;bytearray&lt;/tt&gt; type as output format to avoid an expensive
memory copy from &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;bytearray&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Small buffer of 512 bytes allocated on the stack to avoid the need of a
buffer allocated on the heap, before creating the final
&lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt;/&lt;tt class="docutils literal"&gt;bytearray&lt;/tt&gt; object.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A _PyBytesWriter structure must always be allocated on the stack (to get fast
memory allocation of the smaller buffer).&lt;/p&gt;
&lt;p&gt;While _PyUnicodeWriter has a 5 functions and 1 macro to write a single
character, write strings, write a substring, etc. _PyBytesWriter has a single
_PyBytesWriter_WriteBytes() function to write a string, since all other writes
are done directly with regular C code on &lt;tt class="docutils literal"&gt;char*&lt;/tt&gt; pointers.&lt;/p&gt;
&lt;p&gt;The API itself doesn't make the code faster. Disabling overallocation on the
last write and the usage of the small buffer allocated on the stack may be
faster.&lt;/p&gt;
&lt;p&gt;In Python 3.6, I optimized error handlers on various codecs: ASCII, Latin1
and UTF-8. For example, the UTF-8 encoder is now up to 75 times as fast for
error handlers: &lt;tt class="docutils literal"&gt;ignore&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;replace&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;surrogatepass&lt;/tt&gt;. The &lt;tt class="docutils literal"&gt;bytes % int&lt;/tt&gt; instruction became between 30% and 50%
faster on a microbenchmark.&lt;/p&gt;
&lt;p&gt;Later, I replaced &lt;tt class="docutils literal"&gt;char*&lt;/tt&gt; type with &lt;tt class="docutils literal"&gt;void*&lt;/tt&gt; to avoid compiler warnings
in functions using &lt;tt class="docutils literal"&gt;Py_UCS1*&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;unsigned char*&lt;/tt&gt;, unsigned types.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2015 Q4</title><link href="https://vstinner.github.io/contrib-cpython-2015q4.html" rel="alternate"></link><published>2016-03-01T15:00:00+01:00</published><updated>2016-03-01T15:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-03-01:/contrib-cpython-2015q4.html</id><summary type="html">&lt;p class="first last"&gt;My contributions to CPython during 2015 Q4&lt;/p&gt;
</summary><content type="html">&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2015 Q4
(october, november, december):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2015-10-01&amp;quot;):date(&amp;quot;2015-12-31&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 100 non-merge commits + 25 merge commits (total: 125 commits).&lt;/p&gt;
&lt;p&gt;As usual, I pushed changes of various contributors and helped them to polish
their change.&lt;/p&gt;
&lt;p&gt;I fighted against a recursion error, a regression introduced by my recent work
on the Python test suite.&lt;/p&gt;
&lt;p&gt;I focused on optimizing the bytes type during this quarter. It started with the
issue #24870 opened by &lt;strong&gt;INADA Naoki&lt;/strong&gt; who works on PyMySQL: decoding bytes
using the surrogateescape error handler was the bottleneck of this benchmark.
For me, it was an opportunity for a new attempt to implement a fast &amp;quot;bytes
writer API&amp;quot;.&lt;/p&gt;
&lt;p&gt;I pushed my first change related to &lt;a class="reference external" href="http://faster-cpython.readthedocs.org/fat_python.html"&gt;FAT Python&lt;/a&gt;! Fix parser and AST:
fill lineno and col_offset of &amp;quot;arg&amp;quot; node when compiling AST from Python
objects.&lt;/p&gt;
&lt;p&gt;Previous report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2015q3.html"&gt;My contributions to CPython during 2015 Q3&lt;/a&gt;. Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q1.html"&gt;My contributions to
CPython during 2016 Q1&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="recursion-error"&gt;
&lt;h2&gt;Recursion error&lt;/h2&gt;
&lt;div class="section" id="the-bug-issue-25274"&gt;
&lt;h3&gt;The bug: issue #25274&lt;/h3&gt;
&lt;p&gt;During the previous quarter, I refactored Lib/test/regrtest.py huge file (1,600
lines) into a new Lib/test/libregrtest/ library (8 files). The problem is that
test_sys started to crash with &amp;quot;Fatal Python error: Cannot recover from stack
overflow&amp;quot; on test_recursionlimit_recovery(). The regression was introduced by a
change on regrtest which indirectly added one more Python frame in the code
executing test_sys.&lt;/p&gt;
&lt;p&gt;CPython has a limit on the depth of a call stack: &lt;tt class="docutils literal"&gt;sys.getrecursionlimit()&lt;/tt&gt;,
1000 by default. The limit is a weak protection against overflow of the C
stack. Weak because it only counts Python frames, intermediate C functions may
allocate a lot of memory on the stack.&lt;/p&gt;
&lt;p&gt;When we reach the limit, an &amp;quot;overflow&amp;quot; flag is set, but we still allow up to
limit+50 frames, because handling a RecursionError may need a few more frames.
The overflow flag is cleared when the stack level goes below a &amp;quot;low-water
mark&amp;quot;.&lt;/p&gt;
&lt;p&gt;After the regrtest change, test_recursionlimit_recovery() was called at stack
level 36. Before, it was called at level 35. The test triggers a RecursionError.
The problem is that we never goes again below the low-water mark, so the
overflow flag is never cleared.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-fix"&gt;
&lt;h3&gt;The fix&lt;/h3&gt;
&lt;p&gt;Another problem is that the function used to compute the &amp;quot;low-level mark&amp;quot; was
not monotonic:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if limit &amp;gt; 100:
    low_water_mark = limit - 50
else:
    low_water_mark = 3 * limit // 4
&lt;/pre&gt;
&lt;p&gt;The gap occurs near a limit of 100 frames:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;limit = 99 =&amp;gt; low_level_mark = 74&lt;/li&gt;
&lt;li&gt;limit = 100 =&amp;gt; low_level_mark = 75&lt;/li&gt;
&lt;li&gt;limit = 101 =&amp;gt; low_level_mark = 51&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The formula was replaced with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
if limit &amp;gt; 200:
    low_water_mark = limit - 50
else:
    low_water_mark = 3 * limit // 4
&lt;/pre&gt;
&lt;p&gt;The fix (&lt;a class="reference external" href="https://hg.python.org/cpython/rev/eb0c76442cee"&gt;change eb0c76442cee&lt;/a&gt;) modified the
&lt;tt class="docutils literal"&gt;sys.setrecursionlimit()&lt;/tt&gt; function to raise a &lt;tt class="docutils literal"&gt;RecursionError&lt;/tt&gt; exception if
the new limit is too low depending on the &lt;em&gt;current&lt;/em&gt; stack depth.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="optimizations"&gt;
&lt;h2&gt;Optimizations&lt;/h2&gt;
&lt;p&gt;As usual for performance, Serhiy Storchaka was very helpful on reviews, to run
independant benchmarks, etc.&lt;/p&gt;
&lt;p&gt;Optimizations on the &lt;tt class="docutils literal"&gt;bytes&lt;/tt&gt; type, ASCII, Latin1 and UTF-8 codecs:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #25318: Add _PyBytesWriter API. Add a new private API to optimize
Unicode encoders. It uses a small buffer of 512 bytes allocated on the stack
and supports configurable overallocation.&lt;/li&gt;
&lt;li&gt;Use _PyBytesWriter API for UCS1 (ASCII and Latin1) and UTF-8 encoders. Enable
overallocation for the UTF-8 encoder with error handlers.&lt;/li&gt;
&lt;li&gt;unicode_encode_ucs1(): initialize collend to collstart+1 to not check the
current character twice, we already know that it is not ASCII.&lt;/li&gt;
&lt;li&gt;Issue #25267: The UTF-8 encoder is now up to 75 times as fast for error
handlers: &lt;tt class="docutils literal"&gt;ignore&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;replace&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;surrogatepass&lt;/tt&gt;.
Patch co-written with &lt;strong&gt;Serhiy Storchaka&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;Issue #25301: The UTF-8 decoder is now up to 15 times as fast for error
handlers: &lt;tt class="docutils literal"&gt;ignore&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;replace&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Issue #25318: Optimize backslashreplace and xmlcharrefreplace error handlers
in UTF-8 encoder. Optimize also backslashreplace error handler for ASCII and
Latin1 encoders.&lt;/li&gt;
&lt;li&gt;Issue #25349: Optimize bytes % args using the new private _PyBytesWriter API&lt;/li&gt;
&lt;li&gt;Optimize error handlers of ASCII and Latin1 encoders when the replacement
string is pure ASCII: use _PyBytesWriter_WriteBytes(), don't check individual
character.&lt;/li&gt;
&lt;li&gt;Issue #25349: Optimize bytes % int. Formatting is between 30% and 50% faster
on a microbenchmark.&lt;/li&gt;
&lt;li&gt;Issue #25357: Add an optional newline paramer to binascii.b2a_base64().
base64.b64encode() uses it to avoid a memory copy.&lt;/li&gt;
&lt;li&gt;Issue #25353: Optimize unicode escape and raw unicode escape encoders: use
the new _PyBytesWriter API.&lt;/li&gt;
&lt;li&gt;Rewrite PyBytes_FromFormatV() using _PyBytesWriter API&lt;/li&gt;
&lt;li&gt;Issue #25399: Optimize bytearray % args. Most formatting operations are now
between 2.5 and 5 times faster.&lt;/li&gt;
&lt;li&gt;Issue #25401: Optimize bytes.fromhex() and bytearray.fromhex(): they are now
between 2x and 3.5x faster.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="changes"&gt;
&lt;h2&gt;Changes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #25003: On Solaris 11.3 or newer, os.urandom() now uses the getrandom()
function instead of the getentropy() function. The getentropy() function is
blocking to generate very good quality entropy, os.urandom() doesn't need
such high-quality entropy.&lt;/li&gt;
&lt;li&gt;Issue #22806: Add &lt;tt class="docutils literal"&gt;python &lt;span class="pre"&gt;-m&lt;/span&gt; test &lt;span class="pre"&gt;--list-tests&lt;/span&gt;&lt;/tt&gt; command to list tests.&lt;/li&gt;
&lt;li&gt;Issue #25670: Remove duplicate getattr() in ast.NodeTransformer&lt;/li&gt;
&lt;li&gt;Issue #25557: Refactor _PyDict_LoadGlobal(). Don't fallback to
PyDict_GetItemWithError() if the hash is unknown: compute the hash instead.
Add also comments to explain the _PyDict_LoadGlobal() optimization.&lt;/li&gt;
&lt;li&gt;Issue #25868: Try to make test_eintr.test_sigwaitinfo() more reliable
especially on slow buildbots&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="changes-specific-to-python-2-7"&gt;
&lt;h2&gt;Changes specific to Python 2.7&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Closes #25742: locale.setlocale() now accepts a Unicode string for its second
parameter.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="bugfixes"&gt;
&lt;h2&gt;Bugfixes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Fix regrtest --coverage on Windows&lt;/li&gt;
&lt;li&gt;Fix pytime on OpenBSD&lt;/li&gt;
&lt;li&gt;More fixes for test_eintr on FreeBSD&lt;/li&gt;
&lt;li&gt;Close #25373: Fix regrtest --slow with interrupted test&lt;/li&gt;
&lt;li&gt;Issue #25555: Fix parser and AST: fill lineno and col_offset of &amp;quot;arg&amp;quot; node
when compiling AST from Python objects. First contribution related
to FAT Python ;-)&lt;/li&gt;
&lt;li&gt;Issue #25696: Fix installation of Python on UNIX with make -j9.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>My contributions to CPython during 2015 Q3</title><link href="https://vstinner.github.io/contrib-cpython-2015q3.html" rel="alternate"></link><published>2016-02-18T01:00:00+01:00</published><updated>2016-02-18T01:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-02-18:/contrib-cpython-2015q3.html</id><summary type="html">&lt;p class="first last"&gt;My contributions to CPython during 2015 Q3&lt;/p&gt;
</summary><content type="html">&lt;p&gt;A few years ago, someone asked me: &amp;quot;Why do you contribute to CPython? Python is
perfect, there are no more bugs, right?&amp;quot;. The article list most of my
contributions to CPython during 2015 Q3 (july, august, september). It gives an
idea of which areas of Python are not perfect yet :-)&lt;/p&gt;
&lt;p&gt;My contributions to &lt;a class="reference external" href="https://www.python.org/"&gt;CPython&lt;/a&gt; during 2015 Q3
(july, august, september):&lt;/p&gt;
&lt;pre class="literal-block"&gt;
hg log -r 'date(&amp;quot;2015-07-01&amp;quot;):date(&amp;quot;2015-09-30&amp;quot;)' --no-merges -u Stinner
&lt;/pre&gt;
&lt;p&gt;Statistics: 153 non-merge commits + 75 merge commits (total: 228 commits).&lt;/p&gt;
&lt;p&gt;The major event in Python of this quarter was the release of Python 3.5.0.&lt;/p&gt;
&lt;p&gt;As usual, I helped various contributors to refine their changes and I pushed
their final changes.&lt;/p&gt;
&lt;p&gt;Next report: &lt;a class="reference external" href="https://vstinner.github.io/contrib-cpython-2015q4.html"&gt;My contributions to CPython during 2015 Q4&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="freebsd-kernel-bug"&gt;
&lt;h2&gt;FreeBSD kernel bug&lt;/h2&gt;
&lt;p&gt;It took me a while to polish the implementation of the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0475/"&gt;PEP 475 (retry syscall
on EINTR)&lt;/a&gt; especially its unit
test &lt;tt class="docutils literal"&gt;test_eintr&lt;/tt&gt;. The unit test is supposed to test Python, but as usual,
it also tests indirectly the operating system.&lt;/p&gt;
&lt;p&gt;I spent some days investigating a random hang on the FreeBSD buildbots: &lt;a class="reference external" href="https://bugs.python.org/issue25122"&gt;issue
#25122&lt;/a&gt;. I quickly found the guilty test
(test_eintr.test_open), but it took me a while to understand that it was a
kernel bug in the FIFO driver. Hopefully at the end, I was able to reproduce
the bug with a short C program in my FreeBSD VM. It is the best way to ask a
fix upstream.&lt;/p&gt;
&lt;p&gt;My &lt;a class="reference external" href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=203162"&gt;FreeBSD bug report #203162&lt;/a&gt; (&amp;quot;when close(fd)
on a fifo fails with EINTR, the file descriptor is not really closed&amp;quot;) was
quickly fixed. The FreeBSD team is reactive!&lt;/p&gt;
&lt;p&gt;I like free softwares because it's possible to investigate bugs deep in the
code, and it's usually quick to get a fix.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="timestamp-rounding-issue"&gt;
&lt;h2&gt;Timestamp rounding issue&lt;/h2&gt;
&lt;p&gt;Even if the &lt;a class="reference external" href="http://bugs.python.org/issue23517"&gt;issue #23517&lt;/a&gt; is well defined
and simple to fix, it took me days (weeks?) to understand exactly how
timestamps are supposed to be rounded and agree on the &amp;quot;right&amp;quot; rounding method.
Alexander Belopolsky reminded me the important property:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
(datetime(1970,1,1) + timedelta(seconds=t)) == datetime.utcfromtimestamp(t)
&lt;/pre&gt;
&lt;p&gt;Tim Peters helped me to understand why Python rounds to nearest with ties going
away from zero (ROUND_HALF_UP) in &lt;tt class="docutils literal"&gt;round(float)&lt;/tt&gt; and other functions. At
the first look, the rounding method doesn't look natural nor logical:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;gt;&amp;gt;&amp;gt; round(0.5)
0
&amp;gt;&amp;gt;&amp;gt; round(1.5)
2
&lt;/pre&gt;
&lt;p&gt;See my previous article on the _PyTime API for the long story of rounding
methods between Python 3.2 and Python 3.6: &lt;a class="reference external" href="https://vstinner.github.io/pytime.html"&gt;History of the Python private C API
_PyTime&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="enhancements"&gt;
&lt;h2&gt;Enhancements&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;type_call() now detect C bugs in type __new__() and __init__() methods.&lt;/li&gt;
&lt;li&gt;Issue #25220: Enhancements of the test runner: add more info when regrtest runs
tests in parallel, fix some features of regrtest, add functional tests to
test_regrtest.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="optimizations"&gt;
&lt;h2&gt;Optimizations&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Issue #25227: Optimize ASCII and latin1 encoders with the &lt;tt class="docutils literal"&gt;surrogateescape&lt;/tt&gt;
error handler: the encoders are now up to 3 times as fast.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="changes"&gt;
&lt;h2&gt;Changes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Polish the implementation of the PEP 475 (retry syscall on EINTR)&lt;/li&gt;
&lt;li&gt;Work on the &amp;quot;What's New in Python 3.5&amp;quot; document: add my changes
(PEP 475, socket timeout, os.urandom)&lt;/li&gt;
&lt;li&gt;Work on asyncio: fix ResourceWarning warnings, fixes specific to Windows&lt;/li&gt;
&lt;li&gt;test_time: rewrite rounding tests of the private pytime API&lt;/li&gt;
&lt;li&gt;Issue #24707: Remove an assertion in monotonic clock. Don't check anymore at
runtime that the monotonic clock doesn't go backward.  Yes, it happens! It
occurs sometimes each month on a Debian buildbot slave running in a VM.&lt;/li&gt;
&lt;li&gt;test_eintr: replace os.fork() with subprocess (fork+exec) to make the test
more reliable&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="changes-specific-to-python-2-7"&gt;
&lt;h2&gt;Changes specific to Python 2.7&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Backport python-gdb.py changes: enhance py-bt command&lt;/li&gt;
&lt;li&gt;Issue #23375: Fix test_py3kwarn for modules implemented in C&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="bug-fixes"&gt;
&lt;h2&gt;Bug fixes&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Closes #23247: Fix a crash in the StreamWriter.reset() of CJK codecs&lt;/li&gt;
&lt;li&gt;Issue #24732, #23834: Fix sock_accept_impl() on Windows. Regression of the
PEP 475 (retry syscall on EINTR)&lt;/li&gt;
&lt;li&gt;test_gdb: fix regex to parse the GDB version and fix ResourceWarning on error&lt;/li&gt;
&lt;li&gt;Fix test_warnings: don't modify warnings.filters to fix random failures of
the test.&lt;/li&gt;
&lt;li&gt;Issue #24891: Fix a race condition at Python startup if the file descriptor
of stdin (0), stdout (1) or stderr (2) is closed while Python is creating
sys.stdin, sys.stdout and sys.stderr objects.&lt;/li&gt;
&lt;li&gt;Issue #24684: socket.socket.getaddrinfo() now calls
PyUnicode_AsEncodedString() instead of calling the encode() method of the
host, to handle correctly custom string with an encode() method which doesn't
return a byte string. The encoder of the IDNA codec is now called directly
instead of calling the encode() method of the string.&lt;/li&gt;
&lt;li&gt;Issue #25118: Fix a regression of Python 3.5.0 in os.waitpid() on Windows.
Add an unit test on os.waitpid()&lt;/li&gt;
&lt;li&gt;Issue #25122: Fix test_eintr, kill child process on error&lt;/li&gt;
&lt;li&gt;Issue #25155: Add _PyTime_AsTimevalTime_t() function to fix a regression:
support again years after 2038.&lt;/li&gt;
&lt;li&gt;Issue #25150: Hide the private _Py_atomic_xxx symbols from the public
Python.h header to fix a compilation error with OpenMP. PyThreadState_GET()
becomes an alias to PyThreadState_Get() to avoid ABI incompatibilies.&lt;/li&gt;
&lt;li&gt;Issue #25003: On Solaris 11.3 or newer, os.urandom() now uses the getrandom()
function instead of the getentropy() function.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>History of the Python private C API _PyTime</title><link href="https://vstinner.github.io/pytime.html" rel="alternate"></link><published>2016-02-17T22:00:00+01:00</published><updated>2016-02-17T22:00:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-02-17:/pytime.html</id><summary type="html">&lt;p class="first last"&gt;History of the Python private C API _PyTime&lt;/p&gt;
</summary><content type="html">&lt;p&gt;I added functions to the private &amp;quot;pytime&amp;quot; library to convert timestamps from/to
various formats. I expected to spend a few days, at the end I spent 3 years
(2012-2015) on them!&lt;/p&gt;
&lt;div class="section" id="python-3-3"&gt;
&lt;h2&gt;Python 3.3&lt;/h2&gt;
&lt;p&gt;In 2012, I proposed the &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0410/"&gt;PEP 410 -- Use decimal.Decimal type for timestamps&lt;/a&gt; because storing timestamps as
floating point numbers looses precision. The PEP was rejected because it
modified many functions and had a bad API. At least, os.stat() got 3 new fields
(atime_ns, mtime_ns, ctime_ns): timestamps  as a number of nanoseconds
(&lt;tt class="docutils literal"&gt;int&lt;/tt&gt;).&lt;/p&gt;
&lt;p&gt;My &lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0418/"&gt;PEP 418 -- Add monotonic time, performance counter, and process time
functions&lt;/a&gt; was accepted, Python
3.3 got a new &lt;tt class="docutils literal"&gt;time.monotonic()&lt;/tt&gt; function (and a few others). Again, I spent
much more time than I expected on a problem which looked simple at the first
look.&lt;/p&gt;
&lt;p&gt;With the &lt;a class="reference external" href="http://bugs.python.org/issue14180"&gt;issue #14180&lt;/a&gt;, I added functions
to convert timestamps to the private &amp;quot;pytime&amp;quot; API to factorize the code of
various modules. Timestamps were rounded towards +infinity (ROUND_CEILING), but
it was not a deliberate choice.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-4"&gt;
&lt;h2&gt;Python 3.4&lt;/h2&gt;
&lt;p&gt;To fix correctly a performance issue in asyncio (&lt;a class="reference external" href="https://bugs.python.org/issue20311"&gt;issue20311&lt;/a&gt;), I added two rounding modes to the
pytime API: _PyTime_ROUND_DOWN (round towards zero), and _PyTime_ROUND_UP
(round away from zero). Polling for events (ex: using &lt;tt class="docutils literal"&gt;select.select()&lt;/tt&gt;) with
a non-zero timestamp must not call the underlying C level in non-blocking mode.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-5"&gt;
&lt;h2&gt;Python 3.5&lt;/h2&gt;
&lt;p&gt;When working on the &lt;a class="reference external" href="https://bugs.python.org/issue22117"&gt;issue #22117&lt;/a&gt;, I
noticed that the implementation of rounding methods was buggy for negative
timestamps. I replaced the _PyTime_ROUND_DOWN with _PyTime_ROUND_FLOOR (round
towards minus infinity), and _PyTime_ROUND_UP with _PyTime_ROUND_CEILING (round
towards infinity).&lt;/p&gt;
&lt;p&gt;This issue also introduced a new private &lt;tt class="docutils literal"&gt;_PyTime_t&lt;/tt&gt; type to support
nanosecond resolution.  The type is an opaque integer type to store timestamps.
In practice, it's a signed 64-bit integer. Since it's an integer, it's easy and
natural to compute the sum or differecence of two timestamps: &lt;tt class="docutils literal"&gt;t1 + t2&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;t2 - t1&lt;/tt&gt;. I added _PyTime_XXX() functions to create a timestamp and
_PyTime_AsXXX() functions to convert a timestamp to a different format.&lt;/p&gt;
&lt;p&gt;I had to keep three _PyTime_ObjectToXXX() functions for fromtimestamp() methods
of the datetime module. These methods must support extreme timestamps (year
1..9999), whereas _PyTime_t is &amp;quot;limited&amp;quot; to a delta of +/- 292 years (year
1678..2262).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-3-6"&gt;
&lt;h2&gt;Python 3.6&lt;/h2&gt;
&lt;p&gt;In 2015, the &lt;a class="reference external" href="http://bugs.python.org/issue23517"&gt;issue #23517&lt;/a&gt; reported that
Python 2 and Python 3 don't use the same rounding method in
datetime.datetime.fromtimestamp(): there was a difference of 1 microsecond.&lt;/p&gt;
&lt;p&gt;After a long discussion, I modified fromtimestamp() methods of the datetime
module to round to nearest with ties going away from zero (ROUND_HALF_UP), as
done in Python 2.7, as round() in all Python versions.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;It took me three years to stabilize the API and fix all issues. Well, I didn't
spend all my days on it, but it shows that handling time is not a simple issue.&lt;/p&gt;
&lt;p&gt;At the Python level, nothing changed, timestamps are still stored as float
(except of the 3 new fieleds of os.stat()).&lt;/p&gt;
&lt;p&gt;Python 3.5 only supports timezones with fixed offset, it does not support the
locale timestamp for example. Timezones are still an hot topic: the
&lt;a class="reference external" href="https://mail.python.org/mailman/listinfo/datetime-sig"&gt;datetime-sig mailing list&lt;/a&gt; was created to
enhance timezone support in Python.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="cpython"></category></entry><entry><title>Status of the FAT Python project, January 12, 2016</title><link href="https://vstinner.github.io/fat-python-status-janv12-2016.html" rel="alternate"></link><published>2016-01-12T13:42:00+01:00</published><updated>2016-01-12T13:42:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2016-01-12:/fat-python-status-janv12-2016.html</id><summary type="html">&lt;p class="first last"&gt;Status of the FAT Python project, January 12, 2016&lt;/p&gt;
</summary><content type="html">&lt;a class="reference external image-reference" href="http://faster-cpython.readthedocs.org/fat_python.html"&gt;&lt;img alt="FAT Python project" class="align-right" src="https://vstinner.github.io/images/fat_python.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Previous status: &lt;a class="reference external" href="https://vstinner.github.io/fat-python-status-nov26-2015.html"&gt;Status of the FAT Python project, November 26, 2015&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="summary"&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;New optimizations implemented:&lt;ul&gt;
&lt;li&gt;constant propagation&lt;/li&gt;
&lt;li&gt;constant folding&lt;/li&gt;
&lt;li&gt;dead code elimination&lt;/li&gt;
&lt;li&gt;simplify iterable&lt;/li&gt;
&lt;li&gt;replace builtin __debug__ variable with its value&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Major API refactoring to make the API more generic and reusable by other
projects, and maybe different use case.&lt;/li&gt;
&lt;li&gt;Work on 3 different Python Enhancement Proposals (PEP): API for pluggable
static optimizers and function specialization&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The two previously known major bugs, &amp;quot;Wrong Line Numbers (and Tracebacks)&amp;quot; and
&amp;quot;exec(code, dict)&amp;quot;, are now fixed.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-enhancement-proposals-pep"&gt;
&lt;h2&gt;Python Enhancement Proposals (PEP)&lt;/h2&gt;
&lt;p&gt;I proposed an API for to support function specialization and static optimizers.
I splitted changes in 3 different Python Enhancement Proposals (PEP):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0509/"&gt;PEP 509 - Add a private version to dict&lt;/a&gt;: &amp;quot;Add a new private version to
builtin &lt;tt class="docutils literal"&gt;dict&lt;/tt&gt; type, incremented at each change, to implement fast guards
on namespaces.&amp;quot;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0510/"&gt;PEP 510 - Specialize functions&lt;/a&gt;: &amp;quot;Add functions to the Python C
API to specialize pure Python functions: add specialized codes with guards.
It allows to implement static optimizers respecting the Python semantics.&amp;quot;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.python.org/dev/peps/pep-0511/"&gt;PEP 511 - API for AST transformers&lt;/a&gt;: &amp;quot;Propose an API to
support AST transformers.&amp;quot;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The PEP 509 was sent to the python-ideas mailing list for a first round, and
then to python-dev mailing list.  The PEP 510 was sent to python-ideas to a
first round. The last PEP was not published yet, I'm still working on it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="major-api-refactor"&gt;
&lt;h2&gt;Major API refactor&lt;/h2&gt;
&lt;p&gt;The API has been deeply refactored to write the Python Enhancement Proposals.&lt;/p&gt;
&lt;p&gt;First set of changes for function specialization (PEP 510):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;astoptimizer now adds &lt;tt class="docutils literal"&gt;import fat&lt;/tt&gt; to optimized code when specialization is
used&lt;/li&gt;
&lt;li&gt;Remove the function subtype: add directly the &lt;tt class="docutils literal"&gt;specialize()&lt;/tt&gt; method to
functions&lt;/li&gt;
&lt;li&gt;Add support of any callable object to &lt;tt class="docutils literal"&gt;func.specialize()&lt;/tt&gt;, not only code
object (bytecode)&lt;/li&gt;
&lt;li&gt;Create guard objects:&lt;ul&gt;
&lt;li&gt;fat.Guard&lt;/li&gt;
&lt;li&gt;fat.GuardArgType&lt;/li&gt;
&lt;li&gt;fat.GuardBuiltins&lt;/li&gt;
&lt;li&gt;fat.GuardDict&lt;/li&gt;
&lt;li&gt;fat.GuardFunc&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Add functions to create guards:&lt;ul&gt;
&lt;li&gt;fat.GuardGlobals&lt;/li&gt;
&lt;li&gt;fat.GuardTypeDict&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Move code.replace_consts() to fat.replace_consts()&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Second set of changes for AST transformers (PEP 511):&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Add sys.implementation.ast_transformers and sys.implementation.optim_tag&lt;/li&gt;
&lt;li&gt;Rename sys.asthook to sys.ast_transformers&lt;/li&gt;
&lt;li&gt;Add -X fat command line option to enable the FAT mode: register the
astoptimizer in AST transformers&lt;/li&gt;
&lt;li&gt;Replace -F command line option with -o OPTIM_TAG&lt;/li&gt;
&lt;li&gt;Remove sys.flags.fat (Python flag) and Py_FatPython (C variable)&lt;/li&gt;
&lt;li&gt;Rewrite how an AST transformer is registered&lt;/li&gt;
&lt;li&gt;importlib skips .py if optim_tag is not 'opt' and required AST transformers
are missing. Raise ImportError if the .pyc file is missing.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Third set of changes for dictionary versionning, updates after the first round
of the PEP 509 on python-ideas:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Remove dict.__version__ read-only property: the version is now only
accessible from the C API&lt;/li&gt;
&lt;li&gt;Change the type of the C field &lt;tt class="docutils literal"&gt;ma_version&lt;/tt&gt; from &lt;tt class="docutils literal"&gt;size_t&lt;/tt&gt; to &lt;tt class="docutils literal"&gt;unsigned
PY_INT64_T&lt;/tt&gt; to also use 64-bit unsigned integer on 32-bit platforms. The
risk of missing a change in a guard with a 32-bit version is too high,
whereas the risk with a 64-bit version is very very low.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Fourth set of changes for function specialization, updates after the first round
of the PEP 510 on python-ideas:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Remove func.specialize() and func.get_specialized() at the Python level,
replace them with C functions. Expose them again as fat.specialize(func, ...)
and fat.get_specialized(func)&lt;/li&gt;
&lt;li&gt;fat.get_specialized() now returns a list of tuples, instead of a list of dict&lt;/li&gt;
&lt;li&gt;Make fat.Guard type private: rename it to fat._Guard&lt;/li&gt;
&lt;li&gt;Add fat.PyGuard: toy to implement a guard in pure Python&lt;/li&gt;
&lt;li&gt;Guard C API: rename first_check to init and support reporting errors&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="change-log"&gt;
&lt;h2&gt;Change log&lt;/h2&gt;
&lt;p&gt;Detailed changes of the FAT Python between November 24, 2015 and January 12,
2016.&lt;/p&gt;
&lt;div class="section" id="end-of-november"&gt;
&lt;h3&gt;End of november&lt;/h3&gt;
&lt;p&gt;Major change:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Add a __version__ read-only property to dict, remove the verdict subtype of
dict. As a consequence, dictionary guards now hold a strong reference to the
dict value&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Minor changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Allocate dynamically memory for specialized code and guards, don't use fixed-size
arrays anymore&lt;/li&gt;
&lt;li&gt;astoptimizer: enhance scope detection&lt;/li&gt;
&lt;li&gt;optimize astoptimizer: don't copy a whole AST tree anymore with
copy.deepcopy(), only copy modified nodes.&lt;/li&gt;
&lt;li&gt;Add Config.max_constant_size&lt;/li&gt;
&lt;li&gt;Reenable checks on cell variables: allow cell variables if they are the same&lt;/li&gt;
&lt;li&gt;Reenable optimizations on methods calling super(), but never copy super()
builtin to constants. If super() is replaced with a string, the required free
variable (reference to the current class) is not created by the compiler&lt;/li&gt;
&lt;li&gt;Add PureBuiltin config&lt;/li&gt;
&lt;li&gt;NodeVisitor now calls generic_visit() before visit_XXX()&lt;/li&gt;
&lt;li&gt;Loop unrolling now also optimizes tuple iterators&lt;/li&gt;
&lt;li&gt;At the end of Python initialization, create a copy of the builtins dictionary
to be able later to detect if a builtin name was replaced.&lt;/li&gt;
&lt;li&gt;Implement collections.UserDict.__version__&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="december-first-half"&gt;
&lt;h3&gt;December (first half)&lt;/h3&gt;
&lt;p&gt;Major changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Implement 4 new optimizations:&lt;ul&gt;
&lt;li&gt;constant propagation&lt;/li&gt;
&lt;li&gt;constant folding&lt;/li&gt;
&lt;li&gt;replace builtin __debug__ variable with its value&lt;/li&gt;
&lt;li&gt;dead code elimination&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Add support of per module configuration using an __astoptimizer__ variable&lt;/li&gt;
&lt;li&gt;code.co_lnotab now supports negative line number delta.  Change the type of
line number delta in co_lnotab from unsigned 8-bit integer to signed 8-bit
integer. This change fixes almost all issues about line numbers.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Minor changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Change .pyc magic number to 3600&lt;/li&gt;
&lt;li&gt;Remove unused fat.specialized_method() function&lt;/li&gt;
&lt;li&gt;Remove Lib/fat.py, rename Modules/_fat.c to Modules/fat.c: fat module is now
only implemented in C&lt;/li&gt;
&lt;li&gt;Fix more tests of the Python test suite&lt;/li&gt;
&lt;li&gt;A builtin guard now adds a guard on globals. Ignore also the specialization
if globals()[name] already exists.&lt;/li&gt;
&lt;li&gt;Ignore duplicated guards&lt;/li&gt;
&lt;li&gt;Implement namespace following the control flow for constant propagation&lt;/li&gt;
&lt;li&gt;Config.max_int_bits becomes a simple integer&lt;/li&gt;
&lt;li&gt;Fix bytecode compilation for tuple constants. Don't merge (0, 0) and (0.0,
0.0) constants, they are different.&lt;/li&gt;
&lt;li&gt;Call more builtin functions&lt;/li&gt;
&lt;li&gt;Optimize the optimizer: write a metaclass to discover visitors when the class
is created, not when the class is instanciated&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="december-second-half"&gt;
&lt;h3&gt;December (second half)&lt;/h3&gt;
&lt;p&gt;Major changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Implement &amp;quot;simplify iterable&amp;quot; optimization. The loop unrolling optimization
now relies on it to replace &lt;tt class="docutils literal"&gt;range(n)&lt;/tt&gt;.&lt;/li&gt;
&lt;li&gt;Split the function optimization in two stages: first apply optimizations
which don't require specialization, then apply optimizations which
require specialization.&lt;/li&gt;
&lt;li&gt;Replace the builtin __fat__ variable with a new sys.flags.fat flag&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Minor changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Extend optimizations to optimize more cases (more builtins, more loop
unrolling, remove more dead code, etc.)&lt;/li&gt;
&lt;li&gt;Add Config.logger attribute. astoptimize logs into sys.stderr when Python is
started in verbose mode (python3 -v)&lt;/li&gt;
&lt;li&gt;Move func.patch_constants() to code.replace_consts()&lt;/li&gt;
&lt;li&gt;Enhance marshal to fix tests: call frozenset() to get the empty frozenset
singleton&lt;/li&gt;
&lt;li&gt;Don't remove code which must raise a SyntaxError. Don't remove code
containing the continue instruction.&lt;/li&gt;
&lt;li&gt;Restrict GlobalNonlocalVisitor to the current namespace&lt;/li&gt;
&lt;li&gt;Emit logs when optimizations are skipped&lt;/li&gt;
&lt;li&gt;Use some maths to avoid optimization pow() if result is an integer and will
be larger than the configuration. For example, don't optimize 2 ** (2**100).&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="january"&gt;
&lt;h3&gt;January&lt;/h3&gt;
&lt;p&gt;Major changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;astoptimizer now produces a single builtin guard with all names,
instead of a guard per name.&lt;/li&gt;
&lt;li&gt;Major API refactoring detailed in a dedicated section above&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Minor changes:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Start to write PEPs&lt;/li&gt;
&lt;li&gt;Dictionary guards now expect a list of names, instead of a single name, to
reduce the cost of guards.&lt;/li&gt;
&lt;li&gt;GuardFunc now uses a strong reference to the function, instead of a weak
reference to simplify the code&lt;/li&gt;
&lt;li&gt;Initialize dictionary version to 0&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="optimization"></category><category term="fatpython"></category></entry><entry><title>Status of the FAT Python project, November 26, 2015</title><link href="https://vstinner.github.io/fat-python-status-nov26-2015.html" rel="alternate"></link><published>2015-11-26T17:30:00+01:00</published><updated>2015-11-26T17:30:00+01:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2015-11-26:/fat-python-status-nov26-2015.html</id><summary type="html">&lt;p class="first last"&gt;Status of the FAT Python project, November 26, 2015&lt;/p&gt;
</summary><content type="html">&lt;a class="reference external image-reference" href="http://faster-cpython.readthedocs.org/fat_python.html"&gt;&lt;img alt="FAT Python project" class="align-right" src="https://vstinner.github.io/images/fat_python.jpg" /&gt;&lt;/a&gt;
&lt;p&gt;Previous status: [python-dev] &lt;a class="reference external" href="https://mail.python.org/pipermail/python-dev/2015-November/142113.html"&gt;Second milestone of FAT Python&lt;/a&gt;
(Nov 4, 2015).&lt;/p&gt;
&lt;div class="section" id="documentation"&gt;
&lt;h2&gt;Documentation&lt;/h2&gt;
&lt;p&gt;I combined the documentation of various optimizations projects into a single
documentation: &lt;a class="reference external" href="http://faster-cpython.readthedocs.org/"&gt;Faster CPython&lt;/a&gt;.
My previous optimizations projects:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://faster-cpython.readthedocs.org/old_ast_optimizer.html"&gt;&amp;quot;old&amp;quot; astoptimizer&lt;/a&gt; (now
replaced with a &amp;quot;new&amp;quot; astoptimizer included in the FAT Python)&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://faster-cpython.readthedocs.org/registervm.html"&gt;registervm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://faster-cpython.readthedocs.org/readonly.html"&gt;read-only Python&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The FAT Python project has its own page: &lt;a class="reference external" href="http://faster-cpython.readthedocs.org/fat_python.html"&gt;FAT Python project&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="copy-builtins-to-constants-optimization"&gt;
&lt;h2&gt;Copy builtins to constants optimization&lt;/h2&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;LOAD_GLOBAL&lt;/tt&gt; instruction is used to load a builtin function.  The
instruction requires two dictionary lookup: one in the global namespace (which
almost always fail) and then in the builtin namespaces.&lt;/p&gt;
&lt;p&gt;It's rare to replace builtins, so the idea here is to replace the dynamic
&lt;tt class="docutils literal"&gt;LOAD_GLOBAL&lt;/tt&gt; instruction with a static &lt;tt class="docutils literal"&gt;LOAD_CONST&lt;/tt&gt; instruction which
loads the function from a C array, a fast O(1) lookup.&lt;/p&gt;
&lt;p&gt;It is not possible to inject a builtin function during the compilation. Python
code objects are serialized by the marshal module which only support simple
types like integers, strings and tuples, not functions. The trick is to modify
the constants at runtime when the module is loaded. I added a new
&lt;tt class="docutils literal"&gt;patch_constants()&lt;/tt&gt; method to functions.&lt;/p&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def log(message):
    print(message)
&lt;/pre&gt;
&lt;p&gt;This function is specialized to:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def log(message):
    'LOAD_GLOBAL print'(message)
log.patch_constants({'LOAD_GLOBAL print': print})
&lt;/pre&gt;
&lt;p&gt;The specialized bytecode uses two guards on builtin and global namespaces to
disable the optimization if the builtin function is replaced.&lt;/p&gt;
&lt;p&gt;See &lt;a class="reference external" href="https://faster-cpython.readthedocs.org/fat_python.html#copy-builtin-functions-to-constants"&gt;Copy builtin functions to constants&lt;/a&gt;
for more information.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="loop-unrolling-optimization"&gt;
&lt;h2&gt;Loop unrolling optimization&lt;/h2&gt;
&lt;p&gt;A simple optimization is to &amp;quot;unroll&amp;quot; a loop to reduce the cost of loops. The
optimization generates assignement statements (for the loop index variable)
and duplicates the loop body.&lt;/p&gt;
&lt;p&gt;Example with a &lt;tt class="docutils literal"&gt;range()&lt;/tt&gt; iterator:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def func():
    for i in (1, 2, 3):
        print(i)
&lt;/pre&gt;
&lt;p&gt;The function is specialized to:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
def func():
    i = 1
    print(i)

    i = 2
    print(i)

    i = 3
    print(i)
&lt;/pre&gt;
&lt;p&gt;If the iterator uses the builtin &lt;tt class="docutils literal"&gt;range&lt;/tt&gt; function, two guards are
required on builtin and global namespaces.&lt;/p&gt;
&lt;p&gt;The optimization also handles tuple iterator. No guard is needed in this case
(the code is always optimized).&lt;/p&gt;
&lt;p&gt;See &lt;a class="reference external" href="https://faster-cpython.readthedocs.org/fat_python.html#loop-unrolling"&gt;Loop unrolling&lt;/a&gt;
for more information.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="lot-of-enhancements-of-the-ast-optimizer"&gt;
&lt;h2&gt;Lot of enhancements of the AST optimizer&lt;/h2&gt;
&lt;p&gt;New optimizations helped to find bugs in the &lt;a class="reference external" href="https://faster-cpython.readthedocs.org/new_ast_optimizer.html"&gt;AST optimizer&lt;/a&gt;. Many fixes
and various enhancements were done in the AST optimizer.&lt;/p&gt;
&lt;p&gt;The number of lines of code more than doubled: 500 to 1200 lines.&lt;/p&gt;
&lt;p&gt;Optimization: &lt;tt class="docutils literal"&gt;copy.deepcopy()&lt;/tt&gt; is no more used to duplicate a full tree. The
new &lt;tt class="docutils literal"&gt;NodeTransformer&lt;/tt&gt; class now only copies a single node, if at least one
field is modified.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;VariableVisitor&lt;/tt&gt; class which detects local and global variables was
heavily modified. It understands much more kinds of AST node: &lt;tt class="docutils literal"&gt;For&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;AugAssign&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;AsyncFunctionDef&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;ClassDef&lt;/tt&gt;, etc. It now also detects non-local
variables (&lt;tt class="docutils literal"&gt;nonlocal&lt;/tt&gt; keyword). The scope is now limited to the current
function, it doesn't enter inside nested &lt;tt class="docutils literal"&gt;DictComp&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;FunctionDef&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;Lambda&lt;/tt&gt;, etc. These nodes create a new separated namespace.&lt;/p&gt;
&lt;p&gt;The optimizer is now able to optimize a function without guards: it's needed to
unroll a loop using a tuple as iterator.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="known-bugs"&gt;
&lt;h2&gt;Known bugs&lt;/h2&gt;
&lt;p&gt;See the &lt;a class="reference external" href="https://hg.python.org/sandbox/fatpython/file/0d30dba5fa64/TODO.rst"&gt;TODO.rst file&lt;/a&gt; for
known bugs.&lt;/p&gt;
&lt;div class="section" id="wrong-line-numbers-and-tracebacks"&gt;
&lt;h3&gt;Wrong Line Numbers (and Tracebacks)&lt;/h3&gt;
&lt;p&gt;AST nodes have &lt;tt class="docutils literal"&gt;lineno&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;col_offset&lt;/tt&gt; fields, so an AST optimizer is not
&amp;quot;supposed&amp;quot; to break line numbers. In practice, line numbers, and so tracebacks,
are completly wrong in FAT mode. The problem is probably that AST optimizer can
copy and move instructions. Line numbers are no more motononic. CPython
probably don't handle this case (negative line delta).&lt;/p&gt;
&lt;p&gt;It should be possible to fix it, but right now I prefer to focus on new
optimizations and fix other bugs.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="exec-code-dict"&gt;
&lt;h3&gt;exec(code, dict)&lt;/h3&gt;
&lt;p&gt;In FAT mode, some optimizations require guards on the global namespace.
If &lt;tt class="docutils literal"&gt;exec()&lt;/tt&gt; if called with a Python &lt;tt class="docutils literal"&gt;dict&lt;/tt&gt; for globals, an exception
is raised because &lt;tt class="docutils literal"&gt;func.specialize()&lt;/tt&gt; requires a &lt;tt class="docutils literal"&gt;fat.verdict&lt;/tt&gt; for
globals.&lt;/p&gt;
&lt;p&gt;It's not possible to convert implicitly the &lt;tt class="docutils literal"&gt;dict&lt;/tt&gt; to a &lt;tt class="docutils literal"&gt;fat.verdict&lt;/tt&gt;,
because the &lt;tt class="docutils literal"&gt;dict&lt;/tt&gt; is expected to be mutated, and the guards be will on
&lt;tt class="docutils literal"&gt;fat.verdict&lt;/tt&gt; not on the original &lt;tt class="docutils literal"&gt;dict&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;I worked around the bug by creating manually a &lt;tt class="docutils literal"&gt;fat.verdict&lt;/tt&gt; in FAT mode,
instead of a &lt;tt class="docutils literal"&gt;dict&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;This bug will go avoid if the versionning feature is moved directly into
the builtin &lt;tt class="docutils literal"&gt;dict&lt;/tt&gt; type (and the &lt;tt class="docutils literal"&gt;fat.verdict&lt;/tt&gt; type is removed).&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="optimization"></category><category term="fatpython"></category></entry><entry><title>Port your Python 2 applications to Python 3 with sixer</title><link href="https://vstinner.github.io/python3-sixer.html" rel="alternate"></link><published>2015-06-16T15:00:00+02:00</published><updated>2015-06-16T15:00:00+02:00</updated><author><name>Victor Stinner</name></author><id>tag:vstinner.github.io,2015-06-16:/python3-sixer.html</id><summary type="html">&lt;p class="first last"&gt;Port your Python 2 applications to Python 3 with sixer&lt;/p&gt;
</summary><content type="html">&lt;div class="section" id="from-2to3-to-2to6"&gt;
&lt;h2&gt;From 2to3 to 2to6&lt;/h2&gt;
&lt;p&gt;When Python 3.0 was released, the official statement was to port your
application using &lt;a class="reference external" href="https://docs.python.org/3.5/library/2to3.html"&gt;2to3&lt;/a&gt; and
drop Python 2 support. It didn't work because you had to port all libraries
first. If a library drops Python 2 support, existing applications running on
Python 2 cannot use this library anymore.&lt;/p&gt;
&lt;p&gt;This chicken-and-egg issue was solved by the creation of the &lt;a class="reference external" href="https://pythonhosted.org/six/"&gt;six module&lt;/a&gt; by &lt;a class="reference external" href="https://benjamin.pe/"&gt;Benjamin Peterson&lt;/a&gt;. Thank you so much Benjamin! Using the six module, it
is possible to write a single code base working on Python 2 and Python 3.&lt;/p&gt;
&lt;p&gt;2to3 was hacked to create the &lt;a class="reference external" href="http://python-modernize.readthedocs.org/"&gt;modernize&lt;/a&gt; and &lt;a class="reference external" href="https://github.com/limodou/2to6"&gt;2to6&lt;/a&gt; projects to &lt;em&gt;add Python 3 support&lt;/em&gt; without
loosing Python 2 support. Problem solved!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="creation-of-the-sixer-tool"&gt;
&lt;h2&gt;Creation of the sixer tool&lt;/h2&gt;
&lt;p&gt;Problem solved? Well, not for my specific use case. I'm porting the huge
OpenStack project to Python 3. modernize and 2to6 modify a lot of things at
once, add unwanted changes (ex: add &lt;tt class="docutils literal"&gt;from __future__ import absolute_import&lt;/tt&gt;
at the top of each file), and don't respect the OpenStack coding style
(especially the &lt;a class="reference external" href="http://docs.openstack.org/developer/hacking/#imports"&gt;complex rules to sort and group Python imports&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;I wrote the &lt;a class="reference external" href="https://pypi.python.org/pypi/sixer"&gt;sixer&lt;/a&gt; project to
&lt;em&gt;generate&lt;/em&gt; patches for OpenStack. The problem is that OpenStack code changes
very quickly, so it's common to have to fix conflicts the day after submiting
a change. At the beginning, it took at least one week to get Python 3 changes
merged, whereas many changes are merged every day, so being able to regenerate
patches helped a lot.&lt;/p&gt;
&lt;p&gt;I created the &lt;a class="reference external" href="https://pypi.python.org/pypi/sixer"&gt;sixer&lt;/a&gt; tool using a list
of regular expressions to replace a pattern with another. For example, it
replaces &lt;tt class="docutils literal"&gt;dict.itervalues()&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;six.itervalues(dict)&lt;/tt&gt;. The code was
very simple.  The most difficult part was to respect the OpenStack coding
style for Python imports.&lt;/p&gt;
&lt;p&gt;sixer is a success since its creationg, it helped me to fix the all obvious
Python 3 issues: replace &lt;tt class="docutils literal"&gt;unicode(x)&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;six.text_type(x)&lt;/tt&gt;, replace
&lt;tt class="docutils literal"&gt;dict.itervalues()&lt;/tt&gt; with &lt;tt class="docutils literal"&gt;six.itervalues(dict)&lt;/tt&gt;, etc. These changes are
simple, but it's boring to have to modify manually many files. The OpenStack
Nova project has almost 1500 Python files for example.&lt;/p&gt;
&lt;p&gt;The development version of sixer supports the following operations:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;all&lt;/li&gt;
&lt;li&gt;basestring&lt;/li&gt;
&lt;li&gt;dict0&lt;/li&gt;
&lt;li&gt;dict_add&lt;/li&gt;
&lt;li&gt;iteritems&lt;/li&gt;
&lt;li&gt;iterkeys&lt;/li&gt;
&lt;li&gt;itertools&lt;/li&gt;
&lt;li&gt;itervalues&lt;/li&gt;
&lt;li&gt;long&lt;/li&gt;
&lt;li&gt;next&lt;/li&gt;
&lt;li&gt;raise&lt;/li&gt;
&lt;li&gt;six_moves&lt;/li&gt;
&lt;li&gt;stringio&lt;/li&gt;
&lt;li&gt;unicode&lt;/li&gt;
&lt;li&gt;urllib&lt;/li&gt;
&lt;li&gt;xrange&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="creation-of-the-sixer-test-suite"&gt;
&lt;h2&gt;Creation of the Sixer Test Suite&lt;/h2&gt;
&lt;p&gt;Slowly, I added more and more patterns to sixer. The code became too complex
to be able to check regressions manually, so I also started to write unit
tests. Now each operation has at least one unit test. Some complex operations
have four tests or more.&lt;/p&gt;
&lt;p&gt;At the beginning, tests called directly the Python function. It is fast and
convenient, but it failed to catch regressions on the command line program.
So I added tests running sixer has a blackbox: pass an input file and check
the output file. Then I added specific tests on the code parsing command line
options.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-new-all-operation"&gt;
&lt;h2&gt;The new &amp;quot;all&amp;quot; operation&lt;/h2&gt;
&lt;p&gt;At the beginning, I used sixer to generate a patch for a single pattern. For
example, replace &lt;tt class="docutils literal"&gt;unicode()&lt;/tt&gt; in a whole project.&lt;/p&gt;
&lt;p&gt;Later, I started to use it differently: I fixed all Python 3 issues at once,
but only in some selected files. I did that when we reached a minimum set of
tests which pass on Python 3 to have a green py34 check on Jenkins. Then we
ported tests one by one. It's better to write short patches, they are easier
and faster to review. And the review process is the bottlebeck of the
OpenStack development process.&lt;/p&gt;
&lt;p&gt;To fix all Python 3 at once, I added an &lt;tt class="docutils literal"&gt;all&lt;/tt&gt; operation which simply applies
sequentially each operation. So &lt;tt class="docutils literal"&gt;sixer&lt;/tt&gt; can now be used as &lt;tt class="docutils literal"&gt;modernize&lt;/tt&gt; and
&lt;tt class="docutils literal"&gt;2to6&lt;/tt&gt; to fix all Python 3 issues at once in a whole project.&lt;/p&gt;
&lt;p&gt;I also added the ability to pass filenames instead of having to pass a
directory to modify all files in all subdirectories.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-urllib-six-moves-and-stringio-operations"&gt;
&lt;h2&gt;New urllib, six_moves and stringio operations&lt;/h2&gt;
&lt;div class="section" id="urllib"&gt;
&lt;h3&gt;urllib&lt;/h3&gt;
&lt;p&gt;I tried to keep the sixer code simple. But some changes are boring to write,
like replacing &lt;tt class="docutils literal"&gt;urllib&lt;/tt&gt; imports &lt;tt class="docutils literal"&gt;six.moves.urllib&lt;/tt&gt; imports. Python 2 has 3
modules (&lt;tt class="docutils literal"&gt;urllib&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;urllib2&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;urlparse&lt;/tt&gt;), whereas Pytohn 3 uses a
single &lt;tt class="docutils literal"&gt;urllib&lt;/tt&gt; namespace with submodules (&lt;tt class="docutils literal"&gt;urllib.request&lt;/tt&gt;,
&lt;tt class="docutils literal"&gt;urllib.parse&lt;/tt&gt;, &lt;tt class="docutils literal"&gt;urllib.error&lt;/tt&gt;). Some Python 2 functions moved to one
submodule, whereas others moved to another submodules. It required to know
well the old and new layout.&lt;/p&gt;
&lt;p&gt;After loosing many hours to write manually patches for &lt;tt class="docutils literal"&gt;urllib&lt;/tt&gt;, I decided
to add a &lt;tt class="docutils literal"&gt;urllib&lt;/tt&gt; operation. In fact, it was so not long to implement it,
compared to the time taken to write patches manually.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="stringio"&gt;
&lt;h3&gt;stringio&lt;/h3&gt;
&lt;p&gt;Handling StringIO is also a little bit tricky because String.StringIO and
String.cStringIO don't have the same performance on Python 2. Producing
patches without killing performances require to pick the right module or
symbol from six: &lt;tt class="docutils literal"&gt;six.StringIO()&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;six.moves.cStringIO.StringIO&lt;/tt&gt; for
example.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="six-moves"&gt;
&lt;h3&gt;six_moves&lt;/h3&gt;
&lt;p&gt;The generic &lt;tt class="docutils literal"&gt;six_moves&lt;/tt&gt; operation replaces various Python 2 imports with
imports from &lt;tt class="docutils literal"&gt;six.moves&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;BaseHTTPServer&lt;/li&gt;
&lt;li&gt;ConfigParser&lt;/li&gt;
&lt;li&gt;Cookie&lt;/li&gt;
&lt;li&gt;HTMLParser&lt;/li&gt;
&lt;li&gt;Queue&lt;/li&gt;
&lt;li&gt;SimpleHTTPServer&lt;/li&gt;
&lt;li&gt;SimpleXMLRPCServer&lt;/li&gt;
&lt;li&gt;__builtin__&lt;/li&gt;
&lt;li&gt;cPickle&lt;/li&gt;
&lt;li&gt;cookielib&lt;/li&gt;
&lt;li&gt;htmlentitydefs&lt;/li&gt;
&lt;li&gt;httplib&lt;/li&gt;
&lt;li&gt;repr&lt;/li&gt;
&lt;li&gt;xmlrpclib&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="kiss-emit-warnings-instead-of-complex-implementation"&gt;
&lt;h2&gt;KISS: emit warnings instead of complex implementation&lt;/h2&gt;
&lt;p&gt;As I wrote, I tried to keep sixer simple (KISS principle: Keep It Simple,
Stupid). I'm also lazy, I didn't try to write a perfect tool. I don't want to
spend hours on the sixer project.&lt;/p&gt;
&lt;p&gt;When it was too tricky to make a decision or to implement a pattern, sixer
emits &amp;quot;warnings&amp;quot; instead. For example, a warning is emitted on
&lt;tt class="docutils literal"&gt;def next(self):&lt;/tt&gt; to remind that a &lt;tt class="docutils literal"&gt;__next__ = next&lt;/tt&gt; alias is probably
needed on this class for Python 3.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusion"&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;The sixer tool is incomplete and generates invalid changes. For example, it
replaces patterns in comments, docstrings and strings, whereas usually these
changes don't make sense. But I'm happy because the tool helped me a lot
for to port OpenStack, it saved me hours.&lt;/p&gt;
&lt;p&gt;I hope that the tool will now be useful to others! Don't hesitate to give me
feedback.&lt;/p&gt;
&lt;/div&gt;
</content><category term="python"></category><category term="python3"></category><category term="sixer"></category></entry></feed>
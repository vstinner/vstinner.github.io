<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>My contributions to CPython during 2016 Q2 â€” Victor Stinner blog 3</title>
	<meta name="description" content="Title: My contributions to CPython during 2016 Q2; Date: 2017-02-12; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">My contributions to CPython during 2016 Q2</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2017-02-12T18:00:00+01:00" itemprop="datePublished">Sun 12 February 2017</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/python.html" rel="category">python</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/cpython.html" rel="tag">cpython</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>My contributions to <a class="reference external" href="https://www.python.org/">CPython</a> during 2016 Q2
(april, may, june):</p>
<pre class="literal-block">
hg log -r 'date(&quot;2016-04-01&quot;):date(&quot;2016-06-30&quot;)' --no-merges -u Stinner
</pre>
<p>Statistics: 52 non-merge commits + 22 merge commits (total: 74 commits).</p>
<p>Previous report: <a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q1.html">My contributions to CPython during 2016 Q1</a>. Next report: <a class="reference external" href="https://vstinner.github.io/contrib-cpython-2016q3.html">My contributions to
CPython during 2016 Q3</a>.</p>
<div class="section" id="start-of-my-work-on-optimization">
<h2>Start of my work on optimization</h2>
<p>During 2016 Q2, I started to spend more time on optimizing CPython.</p>
<p>I experimented a change on CPython: a new FASTCALL calling convention to avoid
the creation of a temporary tuple to pass positional argulments: <a class="reference external" href="http://bugs.python.org/issue26814">issue26814</a>. Early results were really good: calling
builtin functions became between 20% and 50% faster!</p>
<p>Quickly, my optimization work was blocked by unreliable benchmarks. I spent the
rest of the year 2016 analyzing benchmarks and making benchmarks more stable.</p>
</div>
<div class="section" id="subprocess-now-emits-resourcewarning">
<h2>subprocess now emits ResourceWarning</h2>
<p>subprocess.Popen destructor now emits a ResourceWarning warning if the child
process is still running (issue #26741). The warning helps to track and fix
zombi processes. I updated asyncio to prevent a false ResourceWarning (warning
whereas the child process completed): asyncio now copies the child process exit
status to the internal Popen object.</p>
<p>I also fixed the POSIX implementation of subprocess.Popen._execute_child(): it
now sets the returncode attribute from the child process exit status when exec
failed.</p>
</div>
<div class="section" id="security-fix-potential-shell-injections-in-ctypes-util">
<h2>Security: fix potential shell injections in ctypes.util</h2>
<p>I rewrote methods of the ctypes.util module using <tt class="docutils literal">os.popen()</tt>. I replaced
<tt class="docutils literal">os.popen()</tt> with <tt class="docutils literal">subprocess.Popen</tt> without shell (issue #22636) to fix a
class of security vulneratiblity, &quot;shell injection&quot; (inject arbitrary shell
commands to take the control of a computer).</p>
<p>The <tt class="docutils literal">os.popen()</tt> function uses a shell, so there is a risk if the command
line arguments are not properly escaped for shell. Using <tt class="docutils literal">subproces.Popen</tt>
without shell fixes completely the risk.</p>
<p>Note: the <tt class="docutils literal">ctypes</tt> is generally not considered as &quot;safe&quot;, but it doesn't harm
to make it more secure ;-)</p>
</div>
<div class="section" id="optimization-pymem-malloc-now-uses-pymalloc">
<h2>Optimization: PyMem_Malloc() now uses pymalloc</h2>
<p>PyMem_Malloc() now uses the fast Python &quot;pymalloc&quot; memory allocator which is
optimized for small objects with a short lifetime (issue #26249). The change
makes some benchmarks up to 4% faster.</p>
<p>This change was possible thanks to the whole preparation work I did in the 2016
Q1, especially the new GIL check in memory allocator debug hooks and the new
<tt class="docutils literal">PYTHONMALLOC=debug</tt> environment variable enabling these hooks on a Python
compiled in released mode.</p>
<p>I tested lxml, Pillow, cryptography and numpy before pushing the change,
as asked by Marc-Andre Lemburg. All these projects work with the change, except
of numpy. I wrote a fix for numpy: <a class="reference external" href="https://github.com/numpy/numpy/pull/7404">Use PyMem_RawMalloc on Python 3.4 and newer</a>, merged one month later (my first
contribution to numy!).</p>
<p>The change indirectly helped to identify and fix a memory leak in the
<tt class="docutils literal">formatfloat()</tt> function used to format bytes strings: <tt class="docutils literal"><span class="pre">b&quot;%f&quot;</span> % 1.2</tt> (issue
#25349, #26249).</p>
</div>
<div class="section" id="optimization">
<h2>Optimization</h2>
<p>Issue #27056: Optimize pickle.load() and pickle.loads(), up to 10% faster to
deserialize a lot of small objects. I found this optimization using Linux perf
on Python compiled with PGO. My change implements manually the optimization if
Python is not compiled with PGO.</p>
<p>Issue #26770: When <tt class="docutils literal">set_inheritable()</tt> is implemented with <tt class="docutils literal">fcntl()</tt>, don't
call <tt class="docutils literal">fcntl()</tt> twice if the <tt class="docutils literal">FD_CLOEXEC</tt> flag is already set to the
requested value. Linux uses <tt class="docutils literal">ioctl()</tt> and so always only need a single
syscall.</p>
</div>
<div class="section" id="changes">
<h2>Changes</h2>
<ul>
<li><p class="first">Issue #26716: Replace IOError with OSError in fcntl documentation, IOError is
a deprecated alias to OSError since Python 3.3.</p>
</li>
<li><p class="first">Issue #26639: Replace the deprecated <tt class="docutils literal">imp</tt> module with the <tt class="docutils literal">importlib</tt>
module in <tt class="docutils literal">Tools/i18n/pygettext.py</tt>. Remove <tt class="docutils literal">_get_modpkg_path()</tt>,
replaced with <tt class="docutils literal">importlib.util.find_spec()</tt>.</p>
</li>
<li><p class="first">Issue #26735: Fix os.urandom() on Solaris 11.3 and newer when reading more
than 1024 bytes: call getrandom() multiple times with a limit of 1024 bytes
per call.</p>
</li>
<li><p class="first">configure: fix <tt class="docutils literal">HAVE_GETRANDOM_SYSCALL</tt> check, syscall() function requires
<tt class="docutils literal">#include &lt;unistd.h&gt;</tt>.</p>
</li>
<li><p class="first">Issue #26766: Fix _PyBytesWriter_Finish(). Return a bytearray object when
bytearray is requested and when the small buffer is used. Fix also
test_bytes: bytearray%args must return a bytearray type.</p>
</li>
<li><p class="first">Issue #26777: Fix random failure of test_asyncio.test_timeout_disable() on
the &quot;AMD64 FreeBSD 9.x 3.5&quot; buildbot:</p>
<pre class="literal-block">
File &quot;.../Lib/test/test_asyncio/test_tasks.py&quot;, line 2398, in go
  self.assertTrue(0.09 &lt; dt &lt; 0.11, dt)
AssertionError: False is not true : 0.11902812402695417
</pre>
<p>Replace <tt class="docutils literal">&lt; 0.11</tt> with <tt class="docutils literal">&lt; 0.15</tt>.</p>
</li>
<li><p class="first">Backport test_gdb fix for s390x buildbots to Python 3.5.</p>
</li>
<li><p class="first">Cleanup import.c: replace <tt class="docutils literal">PyUnicode_RPartition()</tt> with
<tt class="docutils literal">PyUnicode_FindChar()</tt> and <tt class="docutils literal">PyUnicode_Substring()</tt> to avoid the creation
of a temporary tuple. Use <tt class="docutils literal">PyUnicode_FromFormat()</tt> to build a string and
avoid the single_dot ('.') singleton.</p>
</li>
<li><p class="first">regrtest now uses subprocesses when the <tt class="docutils literal"><span class="pre">-j1</span></tt> command line option is used:
each test file runs in a fresh child process. Before, the -j1 option was
ignored. <tt class="docutils literal">Tools/buildbot/test.bat</tt> script now uses -j1 by default to run
each test file in fresh child process.</p>
</li>
<li><p class="first">regrtest: display test result (passed, failed, ...) after each test
completion. In multiprocessing mode: always display the result. In sequential
mode: only display the result if the test did not pass</p>
</li>
<li><p class="first">Issue #27278: Fix <tt class="docutils literal">os.urandom()</tt> implementation using <tt class="docutils literal">getrandom()</tt> on
Linux. Truncate size to <tt class="docutils literal">INT_MAX</tt> and loop until we collected enough random
bytes, instead of casting a directly <tt class="docutils literal">Py_ssize_t</tt> to <tt class="docutils literal">int</tt>.</p>
</li>
</ul>
</div>
<div class="section" id="contributions">
<h2>Contributions</h2>
<p>I also pushed a few changes written by other contributors.</p>
<p>Issue #26839: <tt class="docutils literal">os.urandom()</tt> doesn't block on Linux anymore. On Linux,
<tt class="docutils literal">os.urandom()</tt> now calls getrandom() with <tt class="docutils literal">GRND_NONBLOCK</tt> to fall back on
reading <tt class="docutils literal">/dev/urandom</tt> if the urandom entropy pool is not initialized yet.
Patch written by <strong>Colm Buckley</strong>. This issue started a huge annoying discussion
around random number generation on the bug tracker and the python-dev mailing
list.  I later wrote the <a class="reference external" href="https://www.python.org/dev/peps/pep-0524/">PEP 524: Make os.urandom() blocking on Linux</a> to fix the issue!</p>
<p>Other changes:</p>
<ul class="simple">
<li>Issue #26647: Cleanup opcode: simplify code to build <tt class="docutils literal">opcode.opname</tt>. Patch
written by <strong>Demur Rumed</strong>.</li>
<li>Issue #26647: Cleanup modulefinder: use <tt class="docutils literal">dis.opmap[name]</tt> rather than
<tt class="docutils literal">dis.opname.index(name)</tt>. Patch written by <strong>Demur Rumed</strong>.</li>
<li>Issue #26801: Fix error handling in <tt class="docutils literal">shutil.get_terminal_size()</tt>: catch
AttributeError instead of NameError. Skip the functional test of test_shutil
using the <tt class="docutils literal">stty size</tt> command if the <tt class="docutils literal">os.get_terminal_size()</tt> function is
missing. Patch written by <strong>Emanuel Barry</strong>.</li>
<li>Issue #26802: Optimize function calls only using unpacking like
<tt class="docutils literal"><span class="pre">func(*tuple)</span></tt> (no other positional argument, no keyword argument): avoid
copying the tuple. Patch written by <strong>Joe Jevnik</strong>.</li>
<li>Issue #21668: Add missing libm dependency in setup.py: link audioop,
_datetime, _ctypes_test modules to libm, except on Mac OS X. Patch written by
<strong>Chi Hsuan Yen</strong>.</li>
<li>Issue #26799: Fix python-gdb.py: don't get C types at startup, only on
demand. The C types can change if python-gdb.py is loaded before loading the
Python executable in gdb. Patch written by <strong>Thomas Ilsche</strong>.</li>
<li>Issue #27057: Fix os.set_inheritable() on Android, ioctl() is blocked by
SELinux and fails with EACCESS. The function now falls back to fcntl(). Patch
written by <strong>MichaÅ‚ Bednarski</strong>.</li>
<li>Issue #26647: Fix typo in test_grammar. Patch written by <strong>Demur Rumed</strong>.</li>
</ul>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (23)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>
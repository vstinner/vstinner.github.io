<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>My contributions to CPython during 2017 Q2 (part 3) â€” Victor Stinner blog 3</title>
	<meta name="description" content="Title: My contributions to CPython during 2017 Q2 (part 3); Date: 2017-07-13; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">My contributions to CPython during 2017 Q2 (part 3)</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2017-07-13T17:00:00+02:00" itemprop="datePublished">jeu. 13 juillet 2017</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/python.html" rel="category">python</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/cpython.html" rel="tag">cpython</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>This is the third part of my contributions to <a class="reference external" href="https://www.python.org/">CPython</a> during 2017 Q2 (april, may, june):</p>
<ul class="simple">
<li>Security</li>
<li>Trick bug: Clang 4.0, dtoa and strict aliasing</li>
<li>sigwaitinfo() race condition in test_eintr</li>
<li>FreeBSD test_subprocess core dump</li>
</ul>
<p>Previous reports:</p>
<ul class="simple">
<li><a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part1.html">My contributions to CPython during 2017 Q2 (part 1)</a>.</li>
<li><a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q2-part2.html">My contributions to CPython during 2017 Q2 (part 2)</a>.</li>
</ul>
<p>Next report:</p>
<ul class="simple">
<li><a class="reference external" href="https://vstinner.github.io/contrib-cpython-2017q3-part1.html">My contributions to CPython during 2017 Q3: Part 1</a>.</li>
</ul>
<div class="section" id="security">
<h2>Security</h2>
<div class="section" id="backport-fixes">
<h3>Backport fixes</h3>
<p>I am trying to fix all known security fixes in the 6 maintained Python
branches: 2.7, 3.3, 3.4, 3.5, 3.6 and master.</p>
<p>I created the <a class="reference external" href="http://python-security.readthedocs.io/">python-security.readthedocs.io</a> website to track these
vulnerabilities, especially which Python versions are fixed, to identifiy
missing backports.</p>
<p>Python 2.7, 3.5, 3.6 and master are quite good, I am still working on
backporting fixes into 3.4 and 3.3. Larry Hastings merged my 3.4 backports and
other security fixes, and scheduled a new 3.4.7 release next weeks. Later, I
will try to fix Python 3.3 as well, before its end-of-life, scheduled for the
end of september.</p>
<p>See the <a class="reference external" href="https://docs.python.org/devguide/#status-of-python-branches">Status of Python branches</a> in the
devguide.</p>
</div>
<div class="section" id="libexpat-2-2">
<h3>libexpat 2.2</h3>
<p>Python embeds a copy of libexpat to ease Python compilation on Windows and
macOS. It means that we have to remind to upgrade it at each libexpat release.
It is especially important when security vulerabilities are fixed in libexpat.</p>
<p>libexpat 2.2 was released at 2016-06-21 and it contains such fixes for
vulnerabilities, see: <a class="reference external" href="http://python-security.readthedocs.io/vuln/cve-2016-0718_expat_2.2_bug_537.html">CVE-2016-0718: expat 2.2, bug #537</a>.</p>
<p>Sadly, it took us a few months to upgrade libexpat. I wrote a short shell
script to easily upgrade libexpat: recreate the <tt class="docutils literal">Modules/expat/</tt> directory
from a libexpat tarball.</p>
<p>My commit:</p>
<blockquote>
<p>bpo-29591: Upgrade Modules/expat to libexpat 2.2 (#2164)</p>
<p>Remove the configuration (<tt class="docutils literal"><span class="pre">Modules/expat/*config.h</span></tt>) of unsupported
platforms: Amiga, MacOS Classic on PPC32, Open Watcom.</p>
<p>Remove XML_HAS_SET_HASH_SALT define: it became useless since our local
expat copy was upgrade to expat 2.1 (it's now expat 2.2.0).</p>
</blockquote>
<p>I upgraded libexpat to 2.2 in Pytohn 2.7, 3.4, 3.5, 3.6 and master branches.
I still have a pending pull request for 3.3.</p>
</div>
<div class="section" id="libexpat-2-2-1">
<h3>libexpat 2.2.1</h3>
<p>Just after I finally upgraded our libexpat copy to 2.2.0... libexpat 2.2.1 was
released with new security fixes!  See <a class="reference external" href="http://python-security.readthedocs.io/vuln/cve-2017-9233_expat_2.2.1.html">CVE-2017-9233: Expat 2.2.1</a></p>
<p>Again, I upgraded libexpat to 2.2.1 in all branches (pending: 3.3), see
bpo-30694. My commit:</p>
<blockquote>
<p>Upgrade expat copy from 2.2.0 to 2.2.1 to get fixes
of multiple security vulnerabilities including:</p>
<ul class="simple">
<li>CVE-2017-9233 (External entity infinite loop DoS),</li>
<li>CVE-2016-9063 (Integer overflow, re-fix),</li>
<li>CVE-2016-0718 (Fix regression bugs from 2.2.0's fix to CVE-2016-0718)</li>
<li>CVE-2012-0876 (Counter hash flooding with SipHash).</li>
</ul>
<p>Note: the CVE-2016-5300 (Use os-specific entropy sources like getrandom)
doesn't impact Python, since Python already gets entropy from the OS to set
the expat secret using <tt class="docutils literal">XML_SetHashSalt()</tt>.</p>
</blockquote>
</div>
<div class="section" id="urllib-splithost-vulnerability">
<h3>urllib splithost() vulnerability</h3>
<p>Vulnerability: <a class="reference external" href="http://python-security.readthedocs.io/vuln/bpo-30500_urllib_connects_to_a_wrong_host.html">bpo-30500: urllib connects to a wrong host</a>.</p>
<p>While it was quick to confirm the vulnerability, it was tricky to decide how to
properly <strong>fix it without breaking backward compatibility</strong>. We had too few
unit tests, and no obvious definition of the <em>expected</em> behaviour. I
contributed to the discussed and to polish the fix:</p>
<p>bpo-30500 commit:</p>
<blockquote>
Fix urllib.parse.splithost() to correctly parse fragments. For example,
<tt class="docutils literal"><span class="pre">splithost('//127.0.0.1#&#64;evil.com/')</span></tt> now correctly returns the
<tt class="docutils literal">127.0.0.1</tt> host, instead of treating <tt class="docutils literal">&#64;evil.com</tt> as the host in an
authentification (<tt class="docutils literal">login&#64;host</tt>).</blockquote>
<p>Fix applied to master, 3.6, 3.5, 3.4 and 2.7; pending pull request for 3.3.</p>
</div>
<div class="section" id="travis-ci">
<h3>Travis CI</h3>
<p>I also wrote a pull request to enable Travis CI and AppVeyor CI on Python 3.3
and 3.4 branches, to test security on CI. These changes are complex and not
merged yet, but I am now confident that the CI will be enabled on 3.4!</p>
<p>My PR for Python 3.4: <a class="reference external" href="https://github.com/python/cpython/pull/2475">[3.4] Backport CI config from master</a>.</p>
</div>
</div>
<div class="section" id="tricky-bug-clang-4-0-dtoa-and-strict-aliasing">
<h2>Tricky bug: Clang 4.0, dtoa and strict aliasing</h2>
<p>Aha, another funny story about compilers: bpo-30104.</p>
<p>I noticed that the following tests started to fail on the &quot;AMD64 FreeBSD
CURRENT Debug 3.x&quot; buildbot:</p>
<ul class="simple">
<li>test_cmath</li>
<li>test_float</li>
<li>test_json</li>
<li>test_marshal</li>
<li>test_math</li>
<li>test_statistics</li>
<li>test_strtod</li>
</ul>
<p>First, I bet on a libc change on FreeBSD. Then, I found that test_strtod fails
on FreeBSD using clang 4.0, but pass on FreeBSD using clang 3.8.</p>
<p>I started to bisect the code on Linux using a subset of <tt class="docutils literal">Python/dtoa.c</tt>:</p>
<ul class="simple">
<li>Start (integrated in CPython code base): 2,876 lines</li>
<li>dtoa2.c (standalone): 2,865 lines</li>
<li>dtoa5.c: 50 lines</li>
</ul>
<p>Extract of dtoa5.c:</p>
<pre class="literal-block">
typedef union { double d; uint32_t L[2]; } U;

struct Bigint { int wds; };

static double
ratio(struct Bigint *a)
{
    U da, db;
    int k, ka, kb;
    double r;

    da.d = 1.682;
    ka = 6;
    db.d = 1.0;
    kb = 5;
    k = ka - kb + 32 * (a-&gt;wds - 12);
    printf(&quot;k=%i\n&quot;, k);

    if (k &gt; 0)
        da.L[1] += k * 0x100000;
    else {
        k = -k;
        db.L[1] += k * 0x100000;
    }
    r = da.d / db.d;
    /* r == 3.364 */
    return r;
}
</pre>
<p>Even if I had a very short C code (50 lines) reproducing the bug, I was still
unable to understand the bug. I read many articles about aliasing, and I still
don't understand fully the bug... I suggest you these two good articles:</p>
<ul class="simple">
<li><a class="reference external" href="http://cellperformance.beyond3d.com/articles/2006/06/understanding-strict-aliasing.html">Understanding Strict Aliasing</a>
(Mike Acton, June 1, 2006)</li>
<li><a class="reference external" href="http://cellperformance.beyond3d.com/articles/2006/05/demystifying-the-restrict-keyword.html">Demystifying The Restrict Keyword</a>
(Mike Acton, May 29, 2006)</li>
</ul>
<p>Anyway, I wanted to report the bug to clang (LLVM), but the LLVM bug tracker was
migrating and I was unable to subscribe to get an account!</p>
<p>In the meanwhile, <strong>Dimitry Andric</strong>, a FreeBSD developer, told me that he got
<em>exactly</em> the same clang 4.0 issue with &quot;dtoa.c&quot; in the <em>julia</em> programming
language. Two months before I saw the same bug, he already reported the bug to
FreeBSD: <a class="reference external" href="https://bugs.freebsd.org/216770">lang/julia: fails to build with clang 4.0</a>, and to clang: <a class="reference external" href="https://bugs.llvm.org//show_bug.cgi?id=31928">After r280351: if/else
blocks incorrectly optimized away?</a>.</p>
<p>The &quot;problem&quot; is that clang
developers disagree that it's a bug. In short, the discussion was around the C
standard: does clang respect C aliasing rules or not? At the end, clang
developers consider that they are right to optimize. To summarize:</p>
<blockquote>
It's a bug in the code, not in the compiler</blockquote>
<p>So I made a first change to use the <tt class="docutils literal"><span class="pre">-fno-strict-aliasing</span></tt> flag when Python
is compiled with clang:</p>
<blockquote>
Python/dtoa.c is not compiled correctly with clang 4.0 and
optimization level -O2 or higher, because of an aliasing issue on
the double/ULong[2] union.</blockquote>
<p>But this change can make Python slower when compiled on clang, so I was asked
to only compile <tt class="docutils literal">Python/dtoa.c</tt> with this flag:</p>
<blockquote>
On clang, only compile dtoa.c with -fno-strict-aliasing, use strict
aliasing to compile all other C files.</blockquote>
</div>
<div class="section" id="sigwaitinfo-race-condition-in-test-eintr">
<h2>sigwaitinfo() race condition in test_eintr</h2>
<div class="section" id="the-tricky-test-eintr">
<h3>The tricky test_eintr</h3>
<p>When I wrote and implemented the <a class="reference external" href="https://www.python.org/dev/peps/pep-0475/">PEP 475, Retry system calls failing with
EINTR</a>, I didn't expect so many
annoying bugs of the newly written <tt class="docutils literal">test_eintr</tt> unit test. This test calls
system calls while sending signals every 100 ms. Usually the test tries to
block on a system call during at least 200 ms, to make sure that the syscall
was interrupted at least once by a signal, to check that Python correctly
retries the interrupted system call.</p>
<p>Since the PEP was implemented, I already fixed many race conditions in
<tt class="docutils literal">test_eintr</tt>, but there was still a race condition on the <tt class="docutils literal">sigwaitinfo()</tt>
unit test. <em>Sometimes</em> on a <em>few specific buildbots</em> (FreeBSD), the test fails
randomly.</p>
</div>
<div class="section" id="first-attempt">
<h3>First attempt</h3>
<p>My first attempt was the <a class="reference external" href="http://bugs.python.org/issue25277">bpo-25277</a>,
opened at 2015-09-30. I added faulthandler to dump tracebacks if a test hangs
longer than 10 minutes. Then I changed the sleep from 200 ms to 2 seconds in
the <tt class="docutils literal">sigwaitinfo()</tt> test... just to make the bug less likely, but using a
longer sleep doesn't fix the root issue.</p>
</div>
<div class="section" id="second-attempt">
<h3>Second attempt</h3>
<p>My second attempt was the <a class="reference external" href="http://bugs.python.org/issue25868">bpo-25868</a>,
opened at 2015-12-15. I added a pipe to &quot;synchronize the parent and the child
processes&quot;, to try to make the sigwaitinfo() test a little bit more reliable. I
also reduced the sleep from 2 seconds to 100 ms.</p>
<p>7 minutes after my fix, <strong>Martin Panter</strong> wrote:</p>
<blockquote>
<p>With the pipe, there is still a potential race after the parent writes to
the pipe and before sigwaitinfo() is invoked, versus the child sleep()
call.</p>
<p>What do you think of my suggestion to block the signal? Then (in theory) it
should be robust, rather than relying on timing.</p>
</blockquote>
<p>I replied that I wasn't sure that sigwaitinfo() EINTR error was still tested if
we make his proposed change.</p>
<p>One month later, Martin wrote a patch but I was unable to take a decision on
his change. In september 2016, Martin noticed a new test failure on the FreeBSD
9 buildbot.</p>
</div>
<div class="section" id="third-attempt">
<h3>Third attempt</h3>
<p>My third attempt is the bpo-30320, opened at 2017-05-09. This time, I really
wanted to fix <em>all</em> buildbot random failures. Since I was now able to reproduce
the bug on my FreeBSD VM, I was able to write a fix but also to check that:</p>
<ul class="simple">
<li>sigwaitinfo() and sigtimedwait() fail with EINTR and Python automatically
restarts the interrupted syscall</li>
<li>I hacked the test file to only run the sigwaitinfo() and sigtimedwait() unit
tests. Running the test in a loop doesn't fail: I ran the test during 5
minutes in 10 shells (tests running 10 times in parallel) =&gt; no failure, the
race condition seems to be gone.</li>
</ul>
<p>So I <a class="reference external" href="https://github.com/python/cpython/commit/211a392cc15f9a7b1b8ce65d8f6c9f8237d1b77f">pushed my fix</a>:</p>
<blockquote>
<p>bpo-30320: test_eintr now uses pthread_sigmask()</p>
<p>Rewrite sigwaitinfo() and sigtimedwait() unit tests for EINTR using
pthread_sigmask() to fix a race condition between the child and the
parent process.</p>
<p>Remove the pipe which was used as a weak workaround against the race
condition.</p>
<p>sigtimedwait() is now tested with a child process sending a signal
instead of testing the timeout feature which is more unstable
(especially regarding to clock resolution depending on the platform).</p>
</blockquote>
<p>To be honest, I wasn't really confident, when I pushed my fix, that blocking
the waited signal is the proper fix.</p>
<p>So it took <strong>1 year and 8 months</strong> to really find and fix the root bug.</p>
<p>Sadly, while I was working on dozens of other bugs, I completely lost track of
Martin's patch, even if I opened the bpo-25868. Sorry Martin for forgotting to
review your patch! But when you wrote it, I was unable to test that
sigwaitinfo() was still failing with EINTR.</p>
</div>
</div>
<div class="section" id="freebsd-test-subprocess-core-dump">
<h2>FreeBSD test_subprocess core dump</h2>
<p>bpo-30448: During one month, some FreeBSD buildbots was emitting this warning
which started to annoy me, since I was trying to fix <em>all</em> buildbots warnings:</p>
<pre class="literal-block">
Warning -- files was modified by test_subprocess
  Before: []
  After:  ['python.core']
</pre>
<p>I tried and failed to reproduce the warning on my FreeBSD 11 VM. I also asked a
friend to reproduce the bug, but he also failed. I was developping my
<tt class="docutils literal">test.bisect</tt> tool and I wanted to get access to a machine to reproduce the
bug!</p>
<p>Later, <strong>Kubilay Kocak</strong> aka <em>koobs</em> gave me access to his FreeBSD buildbots
and in a few seconds with my new test.bisect tool, I identified that the
<tt class="docutils literal">test_child_terminated_in_stopped_state()</tt> test triggers a deliberate crash,
but doesn't disable core dump creation. The fix is simple, use
<tt class="docutils literal">test.support.SuppressCrashReport</tt> context manager. Thanks <em>koobs</em> for the
access!</p>
<p>Maybe only FreeBSD 10 and older dump a core on this specific test, not FreeBSD
11. I don't know why. The test is special, it tests a process which crashs
while being traced with <tt class="docutils literal">ptrace()</tt>.</p>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (14)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>
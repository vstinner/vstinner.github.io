<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Python 3.7 and the POSIX locale â€” Victor Stinner blog 3</title>
	<meta name="description" content="Title: Python 3.7 and the POSIX locale; Date: 2018-03-23; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">Python 3.7 and the POSIX locale</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2018-03-23T13:00:00+01:00" itemprop="datePublished">ven. 23 mars 2018</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/python.html" rel="category">python</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/cpython.html" rel="tag">cpython</a>
		</span>
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/unicode.html" rel="tag">unicode</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><a class="reference external image-reference" href="https://www.flickr.com/photos/rj65/15010849568/"><img alt="Bee" src="https://vstinner.github.io/images/bee.jpg" /></a>
<p>During the childhood of Python 3, encodings issues were common, even on well
configured systems. Python used UTF-8 rather than the locale encoding, and so
commonly produced <a class="reference external" href="https://en.wikipedia.org/wiki/Mojibake">mojibake</a>. For
these reasons, when users complained about the Python behaviour with the POSIX
locale, bug reports were closed with a message like: &quot;your system is not
properly configured, please fix your locale&quot;.</p>
<p>I only started to make a shy change for the POSIX locale in Python 3.5 at the
end of 2013: use <tt class="docutils literal">surrogateescape</tt> for stdin and stdout. We will have to wait
for Nick Coghlan in 2017 for significant changes in Python 3.7.</p>
<p>This article explains the slow transition, <strong>six years</strong> since the first bug
report (2011) to the significant change (2017), from &quot;you must fix your locale&quot;
to &quot;maybe Python can do something for you&quot;.</p>
<p><strong>This article is the fifth in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:</strong></p>
<ul class="simple">
<li><ol class="first arabic">
<li><a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html">Python 3.0 listdir() Bug on Undecodable Filenames</a></li>
</ol>
</li>
<li><ol class="first arabic" start="2">
<li><a class="reference external" href="https://vstinner.github.io/pep-383.html">Python 3.1 surrogateescape error handler (PEP 383)</a></li>
</ol>
</li>
<li><ol class="first arabic" start="3">
<li><a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html">Python 3.2 Painful History of the Filesystem Encoding</a></li>
</ol>
</li>
<li><ol class="first arabic" start="4">
<li><a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html">Python 3.6 now uses UTF-8 on Windows</a></li>
</ol>
</li>
<li><ol class="first arabic" start="5">
<li><a class="reference external" href="https://vstinner.github.io/posix-locale.html">Python 3.7 and the POSIX locale</a></li>
</ol>
</li>
<li><ol class="first arabic" start="6">
<li><a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html">Python 3.7 UTF-8 Mode</a></li>
</ol>
</li>
</ul>
<div class="section" id="first-rejected-attempt-2011">
<h2>First rejected attempt, 2011</h2>
<p>December 2011, <strong>Martin Packman</strong>, a Bazaar developer, reported <a class="reference external" href="https://bugs.python.org/issue13643">bpo-13643</a> to propose to use UTF-8 in Python if the
locale encoding is ASCII:</p>
<blockquote>
<p>Currently when running Python on a non-OSX posix environment under either
the <strong>C locale</strong>, or with an invalid or missing locale, it's <strong>not possible
to operate using unicode filenames outside the ascii range</strong>. Using bytes
works, as does reading expecting unicode, using the surrogates hack.</p>
<p>This makes robustly working with non-ascii filenames on different platforms
needlessly annoying, given <strong>no modern nix should have problems just using
UTF-8 in these cases</strong>.</p>
<p>See the <a class="reference external" href="https://bugs.launchpad.net/bzr/+bug/794353">downstream bzr bug for more</a>.</p>
<p>One option is to <strong>just use UTF-8</strong> for encoding and decoding filenames
<strong>when otherwise ascii would be used</strong>. As a strict superset, this
shouldn't break too many existing assumptions, and <strong>it's unlikely that
non-UTF-8 filenames will accidentally be mangled due to a locale setting
blip.</strong> See the attached patch for this behaviour change. It does not
include a test currently, but it's possible to write one using subprocess
and overriden <tt class="docutils literal">LANG</tt> and <tt class="docutils literal">LC_ALL</tt> vars.</p>
</blockquote>
<p><a class="reference external" href="https://bugs.python.org/issue13643#msg149928">He added</a>:</p>
<blockquote>
<p>This is more about <strong>un-encodable filenames</strong>.</p>
<p>At the moment work with non-ascii filenames in Python robustly requires two
branches, one using unicode and one that encodes to bytestrings and deals
with the case where the name can't be represented in the declared
filesystem encoding.</p>
<p><strong>That may be something that just had to be lived with</strong>, but it's a little
annoying when even without a UTF-8 locale for a particular process, that's
what most systems will want on disk.</p>
</blockquote>
<p>At this time, I was still traumatised by the <tt class="docutils literal">PYTHONFSENCODING</tt> mess: using a
filesystem encoding different than the locale encoding caused many issues (see
<a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html">Python 3.2 Painful History of the Filesystem Encoding</a>). <a class="reference external" href="https://bugs.python.org/issue13643#msg149926">I wrote</a>:</p>
<blockquote>
It was already discussed: using a different encoding for filenames and for
other things is really not a good idea. (...)</blockquote>
<p>and <a class="reference external" href="https://bugs.python.org/issue13643#msg149927">I added</a>:</p>
<blockquote>
The right fix is to <strong>fix your locale, not Python</strong>.</blockquote>
<p>Antoine Pitrou <a class="reference external" href="https://bugs.python.org/issue13643#msg149949">suggested to fix the operating system, not Python</a>:</p>
<blockquote>
<p>So <strong>why don't these supposedly &quot;modern&quot; systems at least set the
appropriate environment variables</strong> for Python to infer the proper
character encoding?  (since these &quot;modern&quot; systems don't have a
well-defined encoding...)</p>
<p>Answer: because they are not modern at all, <strong>they are antiquated,
inadapted and obsolete pieces of software designed and written by clueless
Anglo-American people</strong>. Please report bugs against these systems. <strong>The
culprit is not Python, it's the Unix crap</strong> and the utterly clueless
attitude of its maintainers (&quot;filesystems are just bytes&quot;, yeah,
whatever...).</p>
</blockquote>
<p><strong>Martin Pool</strong> <a class="reference external" href="https://bugs.python.org/issue13643#msg149951">wrote</a>:</p>
<blockquote>
The standard encoding is UTF-8. Python shouldn't need to have a variable
set to tell it this.</blockquote>
<p><a class="reference external" href="https://bugs.python.org/issue13643#msg149952">Antoine replied</a>:</p>
<blockquote>
How so? I don't know of any Linux or Unix spec which says so.</blockquote>
<p>Four days and 34 messages later, <strong>Terry J. Reedy</strong>
<a class="reference external" href="https://bugs.python.org/issue13643#msg150204">closed the issue</a>:</p>
<blockquote>
<p>Martin, after reading most all of the <strong>unusually large sequence of
messages</strong>, I am closing this because <strong>three of the core developers</strong> with
the most experience in this area are <strong>dead-set against your proposal</strong>.</p>
<p>That does not make it 'wrong', but does mean that it will not be approved
and implemented without new data and more persuasive arguments than those
presented so far. I do not see that continued repetition of what has been
said so far will change anything.</p>
</blockquote>
<p>Getting many messages in short time is common when discussing Unicode issues
:-)</p>
<p>March 2011, <strong>Armin Ronacher</strong> and <strong>Carl Meyer</strong> reported a similar issue:
<a class="reference external" href="https://bugs.python.org/issue11574">bpo-11574</a> and <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2011-March/109361.html">[Python-Dev] Low-Level Encoding Behavior on Python 3</a>.  I
closed the issue as &quot;wont fixed&quot; in April 2012.</p>
</div>
<div class="section" id="second-attempt-2013">
<h2>Second attempt, 2013</h2>
<p>November 2013, <strong>Sworddragon</strong> reported <a class="reference external" href="https://bugs.python.org/issue19846">bpo-19846</a>: <tt class="docutils literal">LANG=C python3 <span class="pre">-c</span> <span class="pre">'print(&quot;\xe4&quot;)'</span></tt>
fails with an <tt class="docutils literal">UnicodeEncodeError</tt>.</p>
<p><strong>Antoine Pitrou</strong> wrote a patch to use UTF-8 when the locale encoding is
ASCII, same approach than the first attempt <a class="reference external" href="https://bugs.python.org/issue13643">bpo-13643</a>.</p>
<p><strong>The patch was incomplete and so caused many issues.</strong> Python used the C codec
of the locale encoding during Python initialization, and so Python had to use
the locale encoding as its filesystem encoding.</p>
<p>I listed all functions that should be modified to fix issues and get a fully
working solution. Nobody came up with a full implementation, likely because
<strong>too many changes were required</strong>.</p>
<p>One month and 66 messages (almost the double of the previous attempt) later,
again, <a class="reference external" href="https://bugs.python.org/issue19846#msg205675">I closed the issue</a>:</p>
<blockquote>
<p>I'm closing the issue as invalid, because <strong>Python 3 behaviour is correct</strong>
and must not be changed.</p>
<p>Standard streams (sys.stdin, sys.stdout, sys.stderr) uses the locale
encoding. (...) These encodings and error handlers can be overriden by the
<strong>PYTHONIOENCODING</strong>.</p>
</blockquote>
<p>My <a class="reference external" href="https://bugs.python.org/issue19846#msg205675">full long comment</a>
describes encodings used on each platform.</p>
</div>
<div class="section" id="use-surrogateescape-for-stdin-and-stdout-in-python-3-5">
<h2>Use surrogateescape for stdin and stdout in Python 3.5</h2>
<p>December 2013: Just after closing the second attempt <a class="reference external" href="https://bugs.python.org/issue19846">bpo-19846</a>, I created <a class="reference external" href="https://bugs.python.org/issue19977">bpo-19977</a> to propose to use the
<tt class="docutils literal">surrogateescape</tt> error handler in <tt class="docutils literal">sys.stdin</tt> and <tt class="docutils literal">sys.stdout</tt> for the
POSIX locale.</p>
<p><strong>R. David Murray</strong> <a class="reference external" href="https://bugs.python.org/issue19977#msg206131">disliked my idea</a>:</p>
<blockquote>
<p><strong>Reintroducing moji-bake intentionally doesn't sound like a particularly
good idea</strong>, wasn't that what python3 was supposed to help prevent?</p>
<p>It does seem like a <strong>utf-8 default is the Way of the Future</strong>. Or even the
present, most places.</p>
</blockquote>
<p>March 2014, since <strong>Serhiy Storchaka</strong> and <strong>Nick Coghlan</strong> supported my idea,
I pushed my <a class="reference external" href="https://github.com/python/cpython/commit/7143029d4360637aadbd7ddf386ea5c64fb83095">commit 7143029d</a>
in Python 3.5:</p>
<blockquote>
Issue #19977: When the <tt class="docutils literal">LC_TYPE</tt> locale is the POSIX locale (<tt class="docutils literal">C</tt>
locale), <tt class="docutils literal">sys.stdin</tt> and <tt class="docutils literal">sys.stdout</tt> are now using the
<tt class="docutils literal">surrogateescape</tt> error handler, instead of the <tt class="docutils literal">strict</tt> error handler.</blockquote>
<p>Previously, <strong>Python 3 was very strict on encodings</strong>, all core developers were
convinced to be able to force developers to fix their applications. This change
is one the <strong>first Python 3 change which can produce &quot;mojibake&quot; on purpose</strong>.</p>
<p><strong>Six years after the Python 3.0 release, we started to understand that while
developers can fix their code, we cannot ask users to fix their configuration
(&quot;fix their locale&quot;).</strong></p>
</div>
<div class="section" id="read-etc-locale-conf">
<h2>Read /etc/locale.conf?</h2>
<p>April 2014, <strong>Nick Coghlan</strong> created <a class="reference external" href="https://bugs.python.org/issue21368">bpo-21368</a>: &quot;Check for systemd locale on
startup if current locale is set to POSIX&quot;.</p>
<blockquote>
If a modern Linux system is using systemd as the process manager, then
there will likely be <strong>a &quot;/etc/locale.conf&quot; file</strong> providing settings like
LANG - due to problematic requirements in the POSIX specification, <strong>this
file</strong> (when available) is <strong>likely to be a better &quot;source of truth&quot;
regarding the system encoding</strong> than the environment where the interpreter
process is started, at least when the latter is claiming ASCII as the
default encoding.</blockquote>
<p><a class="reference external" href="https://bugs.python.org/issue21368#msg217328">I disliked the idea</a>:</p>
<blockquote>
I don't think that Python should read such configuration file. If you
consider that something is wrong here, <strong>please report the issue to the C
library</strong>.</blockquote>
<p>Since no consensus was found, no action was taken.</p>
</div>
<div class="section" id="misconfigured-locales-in-docker-images">
<h2>Misconfigured locales in Docker images</h2>
<p>September 2016: <strong>Jan Niklas Hasse</strong> opened <a class="reference external" href="https://bugs.python.org/issue28180">bpo-28180</a>, <strong>&quot;sys.getfilesystemencoding() should
default to utf-8&quot;</strong>.</p>
<blockquote>
<strong>Working with Docker I often end up with an environment where the locale
isn't correctly set.</strong> In these cases <strong>it would be great if
sys.getfilesystemencoding() could default to 'utf-8'</strong> instead of
<tt class="docutils literal">'ascii'</tt>, as it's the encoding of the future and ascii is a subset of it
anyway.</blockquote>
<p>December 2016, <strong>Jan Niklas Hasse</strong> <a class="reference external" href="https://bugs.python.org/issue28180#msg282972">mentioned</a> the <tt class="docutils literal"><span class="pre">C.UTF-8</span></tt> locale:</p>
<blockquote>
<p><a class="reference external" href="https://sourceware.org/glibc/wiki/Proposals/C.UTF-8#Defaults">glibc C.UTF-8 article</a> mentions
that <strong>C.UTF-8 should be glibc's default</strong>.</p>
<p>This bug report <a class="reference external" href="https://sourceware.org/bugzilla/show_bug.cgi?id=17318">also mentions Python</a>. It <strong>hasn't been
fixed yet</strong>, though :/</p>
</blockquote>
<p><strong>Marc-Andre Lemburg</strong> <a class="reference external" href="https://bugs.python.org/issue28180#msg282977">added</a>:</p>
<blockquote>
<p>If we just restrict this to the file system encoding (and not the whole
LANG setting), how about:</p>
<ul class="simple">
<li>default the file system encoding to 'utf-8' and use the surrogate escape
handler as default error handler</li>
<li>add a <tt class="docutils literal">PYTHONFSENCODING</tt> env var to set the file system encoding to
something else (*)</li>
</ul>
<p>(*) I believe we discussed this at some point already, but don't remember the outcome.</p>
</blockquote>
<p>The removed <tt class="docutils literal">PYTHONFSENCODING</tt> environment variable, using a filesystem
encoding different than the locale encoding, caused many issues: see <a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html">Python
3.2 Painful History of the Filesystem Encoding</a>.</p>
<p><strong>Nick Coghlan</strong> <cite>proposed to experiment using the C.UTF-8 locale</cite> in Fedora
26:</p>
<blockquote>
<p><strong>For Fedora 26,</strong> I'm going to explore the feasibility of patching our system
3.6 installation such that the python3 command itself (rather than the
shared library) <strong>checks for &quot;LC_CTYPE=C&quot;</strong> as almost the first thing it
does, and forcibly <strong>sets LANG and LC_ALL to C.UTF-8</strong> if it gets an answer
it doesn't like. If we're able to do that successfully in the more
constrained environment of a specific recent Fedora release, then I think
it will bode well for doing something similar by default in CPython 3.7</p>
<p><a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1404918">Downstream Fedora issue proposing the above idea for F26</a>.</p>
</blockquote>
<p>Fedora 26 integrated a downstream change in Python 3.6:
see <a class="reference external" href="https://fedoraproject.org/wiki/Releases/26/ChangeSet#Python_3_C.UTF-8_locale">Python 3 C.UTF-8 locale</a>.</p>
</div>
<div class="section" id="pep-538-coercing-the-c-locale-to-a-utf-8-based-locale">
<h2>PEP 538: Coercing the C locale to a UTF-8 based locale</h2>
<a class="reference external image-reference" href="http://www.curiousefficiency.org/"><img alt="Nick Coghlan" src="https://vstinner.github.io/images/nick_coghlan.jpg" /></a>
<p>December 2016, as a follow-up of <a class="reference external" href="https://bugs.python.org/issue28180">bpo-28180</a>, <strong>Nick Coghlan</strong> wrote the <a class="reference external" href="https://www.python.org/dev/peps/pep-0538/">PEP
538: Coercing the legacy C locale to a UTF-8 based locale</a> and <a class="reference external" href="https://mail.python.org/pipermail/python-ideas/2017-January/044130.html">posted it to python-ideas
list</a>
and <a class="reference external" href="https://mail.python.org/pipermail/linux-sig/2017-January/000014.html">to the linux-sig list</a>.</p>
<p>April 2017, Nick <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-April/147795.html">proposed</a>
<strong>INADA Naoki</strong> as the BDFL Delegate for his PEP. Guido <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-April/147796.html">accepted to delegate</a>.</p>
<p>May 2017, after 5 months of discussions and changes, INADA Naoki <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-May/148035.html">approved the
PEP</a>.</p>
<p>June 2017, <a class="reference external" href="https://bugs.python.org/issue28180">bpo-28180</a>: Nick Coghlan
pushed the <a class="reference external" href="https://github.com/python/cpython/commit/6ea4186de32d65b1f1dc1533b6312b798d300466">commit 6ea4186d</a>:</p>
<blockquote>
bpo-28180: Implementation for PEP 538 (#659)</blockquote>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>A first attempt to use a different encoding for the POSIX locale was rejected
in 2011. A second attempt was also rejected in 2013.</p>
<p>I modified Python 3.5 in 2014 to use the <tt class="docutils literal">surrogateescape</tt> error handler in
<tt class="docutils literal">stdin</tt> and <tt class="docutils literal">stdout</tt> for the POSIX locale. Six years after the Python 3.0
release, we started to understand that while developers can fix their code, we
cannot ask users to &quot;fix their locale&quot; (configure properly their locale).</p>
<p>In 2016, the problem occurred again with misconfigured locales in Docker
images.  In 2017, Nick Coghlan wrote the PEP 538 &quot;Coercing the legacy C locale
to a UTF-8 based locale&quot; which has been approved by INADA Naoki and implemented
in Python 3.7.</p>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (14)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Python 3.0 listdir() Bug on Undecodable Filenames — Victor Stinner blog 3</title>
	<meta name="description" content="Title: Python 3.0 listdir() Bug on Undecodable Filenames; Date: 2018-03-09; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">Python 3.0 listdir() Bug on Undecodable Filenames</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2018-03-09T13:00:00+01:00" itemprop="datePublished">ven. 09 mars 2018</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/python.html" rel="category">python</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/cpython.html" rel="tag">cpython</a>
		</span>
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/unicode.html" rel="tag">unicode</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>Ten years ago, when Python 3.0 final was released, <tt class="docutils literal">os.listdir(str)</tt>
<strong>ignored silently undecodable filenames</strong>:</p>
<pre class="literal-block">
$ python3.0
&gt;&gt;&gt; os.mkdir(b'x')
&gt;&gt;&gt; open(b'x/nonascii\xff', 'w').close()
&gt;&gt;&gt; os.listdir('x')
[]
</pre>
<p>You had to use bytes to see all filenames:</p>
<pre class="literal-block">
&gt;&gt;&gt; os.listdir(b'x')
[b'nonascii\xff']
</pre>
<p>If the locale is POSIX or C, listdir() ignored silently all non-ASCII
filenames.  Hopefully, <tt class="docutils literal">os.listdir()</tt> accepts <tt class="docutils literal">bytes</tt>, right? In fact, 4
months before the 3.0 final release, it was not the case.</p>
<p>Lying on the real content of a directory looks like a very bad idea. Well,
there is a rationale behind this design. Let me tell you this story which is
now 10 years old.</p>
<p><strong>This article is the first in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system:</strong></p>
<ul class="simple">
<li><ol class="first arabic">
<li><a class="reference external" href="https://vstinner.github.io/python30-listdir-undecodable-filenames.html">Python 3.0 listdir() Bug on Undecodable Filenames</a></li>
</ol>
</li>
<li><ol class="first arabic" start="2">
<li><a class="reference external" href="https://vstinner.github.io/pep-383.html">Python 3.1 surrogateescape error handler (PEP 383)</a></li>
</ol>
</li>
<li><ol class="first arabic" start="3">
<li><a class="reference external" href="https://vstinner.github.io/painful-history-python-filesystem-encoding.html">Python 3.2 Painful History of the Filesystem Encoding</a></li>
</ol>
</li>
<li><ol class="first arabic" start="4">
<li><a class="reference external" href="https://vstinner.github.io/python36-utf8-windows.html">Python 3.6 now uses UTF-8 on Windows</a></li>
</ol>
</li>
<li><ol class="first arabic" start="5">
<li><a class="reference external" href="https://vstinner.github.io/posix-locale.html">Python 3.7 and the POSIX locale</a></li>
</ol>
</li>
<li><ol class="first arabic" start="6">
<li><a class="reference external" href="https://vstinner.github.io/python37-new-utf8-mode.html">Python 3.7 UTF-8 Mode</a></li>
</ol>
</li>
</ul>
<div class="section" id="the-os-walk-bug">
<h2>The os.walk() bug</h2>
<a class="reference external image-reference" href="http://www.dailymail.co.uk/news/article-3592525/Classic-crashes-Incredible-black-white-photos-chaos-roads-early-days-automobile-beautiful-vintage-motors-smashing-trees-careering-canals-plummeting-bridges.html"><img alt="Boston Herald-Traveler photographer Leslie Jones had an eye for a dramatic scene, including when this seven-tonne dump truck plunged through the Warren Avenue bridge, in Boston" src="https://vstinner.github.io/images/car_accident_hole.jpg" /></a>
<p><a class="reference external" href="https://bugs.python.org/issue3187">bpo-3187</a>, june 2008: <strong>Helmut
Jarausch</strong> tested the <strong>first beta release of Python 3.0</strong> and reported a bug
on <tt class="docutils literal">os.walk()</tt> when he tried to walk into his home directory:</p>
<pre class="literal-block">
Traceback (most recent call last):
  File &quot;WalkBug.py&quot;, line 5, in &lt;module&gt;
    for Dir, SubDirs, Files in os.walk('/home/jarausch') :
  File &quot;/usr/local/lib/python3.0/os.py&quot;, line 278, in walk
    for x in walk(path, topdown, onerror, followlinks):
  File &quot;/usr/local/lib/python3.0/os.py&quot;, line 268, in walk
    if isdir(join(top, name)):
  File &quot;/usr/local/lib/python3.0/posixpath.py&quot;, line 64, in join
    if b.startswith('/'):
TypeError: expected an object with the buffer interface
</pre>
<p>In Python 3.0b1, <tt class="docutils literal">os.listdir(str)</tt> returned undecodable filenames as
<tt class="docutils literal">bytes</tt>. The caller must be prepared to get filenames as two types: <tt class="docutils literal">str</tt>
and <tt class="docutils literal">bytes</tt>: it wasn't the case for <tt class="docutils literal">os.walk()</tt> which failed with a
<tt class="docutils literal">TypeError</tt>.</p>
<p><strong>At the first look, the bug seems trivial to fix. In fact, many solutions were
proposed, it will take 4 months and 79 messages to fix the bug</strong>.</p>
</div>
<div class="section" id="i-proposed-a-new-filename-class">
<h2>I proposed a new Filename class</h2>
<p>August 2008, <a class="reference external" href="https://bugs.python.org/issue3187#msg71612">my first comment proposed</a> to use a custom &quot;Filename&quot; type
to store the original <tt class="docutils literal">bytes</tt> filename, but also gives a Unicode view of the
filename, in a single object, using an hypothetical <tt class="docutils literal">myformat()</tt> function:</p>
<pre class="literal-block">
class Filename:
    def __init__(self, orig):
        self.as_bytes = orig
        self.as_str = myformat(orig)
    def __str__(self):
        return self.as_str
    def __bytes__(self):
        return self.as_bytes
</pre>
<p><strong>Antoine Pitrou</strong> suggested to inherit from <tt class="docutils literal">str</tt>:</p>
<blockquote>
I agree that logically it's the right solution. It's also the most
invasive. If that class is <strong>made a subclass of str</strong>, however, existing
code shouldn't break more than it currently does.</blockquote>
<p>I preferred to inherit from <tt class="docutils literal">bytes</tt> for pratical reasons. Antoine noted that
the native type for filenames on Windows is <tt class="docutils literal">str</tt>, and so inheriting from
<tt class="docutils literal">bytes</tt> can be an issue on Windows.</p>
<p>Anyway, <a class="reference external" href="https://bugs.python.org/issue3187#msg71749">Guido van Rossum disliked the idea</a> (comment on InvalidFilename, a
variant of the class):</p>
<blockquote>
I'm not interested in the InvalidFilename class; it's an API complification
that might seem right for your situation but <strong>will hinder most other
people</strong>.</blockquote>
</div>
<div class="section" id="guido-van-rossum-proposed-to-use-replace-error-handler">
<h2>Guido van Rossum proposed to use replace error handler</h2>
<p><strong>Guido van Rossum</strong> <a class="reference external" href="https://bugs.python.org/issue3187#msg71655">proposed to use the replace error handler</a> to prevent decoding error. For
example, <tt class="docutils literal">b'nonascii\xff'</tt> is decoded as <tt class="docutils literal">'nonascii�'</tt>.</p>
<p>The problem is that this filename cannot be used to read the file content using
<tt class="docutils literal">open()</tt> or to remove the file using <tt class="docutils literal">os.unlink()</tt>, since the operating
system doesn't know the Unicode filename containing the &quot;�&quot; character.</p>
<p>An important property is that <strong>encoding back the Unicode filename to bytes
must return the same original bytes filename</strong>.</p>
</div>
<div class="section" id="defer-the-choice-to-the-caller-pass-a-callback">
<h2>Defer the choice to the caller: pass a callback</h2>
<p>As no obvious choice arised, <a class="reference external" href="https://bugs.python.org/issue3187#msg71680">I proposed to use a callback to handle
undecodable filenames</a>.
Pseudo-code:</p>
<pre class="literal-block">
def listdir(path, fallback_decoder=default_fallback_decoder):
    charset = sys.getfilesystemcharset()
    dir_fd = opendir(path)
    try:
        for bytesname in readdir(dir_fd):
            try:
                name = str(bytesname, charset)
            exept UnicodeDecodeError:
                name = fallback_decoder(bytesname)
            yield name
    finally:
        closedir(dir_fd)
</pre>
<p>The default behaviour is to raise an exception on decoding error:</p>
<pre class="literal-block">
def default_fallback_decoder(name):
   raise
</pre>
<p>Example of callback returning the raw bytes string unchanged (Python 3.0 beta1
behaviour):</p>
<pre class="literal-block">
def return_undecodable_unchanged(name):
   return name
</pre>
<p>Example to use a custom filename class:</p>
<pre class="literal-block">
class Filename:
   ...

def filename_decoder(name):
   return Filename(name)
</pre>
<p><a class="reference external" href="https://bugs.python.org/issue3187#msg71699">Guido also disliked my callback idea</a>:</p>
<blockquote>
The callback variant is <strong>too complex</strong>; you could <strong>write it yourself by
using os.listdir() with a bytes argument</strong>.</blockquote>
</div>
<div class="section" id="emit-a-warning-on-undecodable-filename">
<h2>Emit a warning on undecodable filename</h2>
<a class="reference external image-reference" href="http://www.unicode.org/"><img alt="Warning: venoumous snakes" src="https://vstinner.github.io/images/warning_venomous_snakes.png" /></a>
<p>As ignoring undecodable filenames in <tt class="docutils literal">os.listdir(str)</tt> slowly became the most
popular option, <strong>Benjamin Peterson</strong> <a class="reference external" href="https://bugs.python.org/issue3187#msg71700">proposed to emit a warning</a> if a filename cannot be decoded,
to ease debugging:</p>
<blockquote>
(...) I don't like the idea of silently losing the contents of a directory.
That's asking for difficult to discover bugs. Could Python emit a warning
in this case?</blockquote>
<p>Guido van Rossum <a class="reference external" href="https://bugs.python.org/issue3187#msg71705">liked the idea</a>:</p>
<blockquote>
This may be the best compromise yet.</blockquote>
<p><strong>Amaury Forgeot d'Arc</strong> <a class="reference external" href="https://bugs.python.org/issue3187#msg73535">asked</a>:</p>
<blockquote>
Does the warning warn multiple times? IIRC the default behaviour is to warn
once.</blockquote>
<p><strong>Benjamin Peterson</strong> <a class="reference external" href="https://bugs.python.org/issue3187#msg73535">replied</a>:</p>
<blockquote>
<strong>Making a warning happen more than once is tricky because it requires
messing with the warnings filter.</strong> This of course takes away some of the
user's control which is one of the main reasons for using the Python
warning system in the first place.</blockquote>
<p>Because of this issue, the warning idea was abandonned.</p>
</div>
<div class="section" id="support-bytes-and-fix-os-listdir">
<h2>Support bytes and fix os.listdir()</h2>
<p>Guido repeated that the best workaround is to pass filenames as <tt class="docutils literal">bytes</tt>,
which is the native type for filenames on Unix, but most functions only
accepted filenames as <tt class="docutils literal">str</tt>.</p>
<p>I started to write multiple patches to support passing filenames as <tt class="docutils literal">bytes</tt>:</p>
<ul class="simple">
<li><tt class="docutils literal">posix_path_bytes.patch</tt>: enhance <tt class="docutils literal">posixpath.join()</tt></li>
<li><tt class="docutils literal">io_byte_filename.patch</tt>: enhance <tt class="docutils literal">open()</tt></li>
<li><tt class="docutils literal">fnmatch_bytes.patch</tt>: enhance <tt class="docutils literal">fnmatch.filter()</tt></li>
<li><tt class="docutils literal">glob1_bytes.patch</tt>: enhance <tt class="docutils literal">glob.glob()</tt></li>
<li><tt class="docutils literal">getcwd_bytes.patch</tt>: <tt class="docutils literal">os.getcwd()</tt> returns bytes if unicode conversion fails</li>
<li><tt class="docutils literal">merge_os_getcwd_getcwdu.patch</tt>: Remove <tt class="docutils literal">os.getcwdu()</tt>;
<tt class="docutils literal">os.getcwd(bytes=True)</tt> returns bytes</li>
<li><tt class="docutils literal">os_getcwdb.patch</tt>: Fix <tt class="docutils literal">os.getcwd()</tt> by using <tt class="docutils literal">PyUnicode_Decode()</tt> and
add <tt class="docutils literal">os.getcwdb()</tt> which returns <tt class="docutils literal">bytes</tt></li>
</ul>
<p>Guido van Rossum created a <a class="reference external" href="https://codereview.appspot.com/3055">review on my combined patches</a>. Then I also combined my patches into a
single <tt class="docutils literal">python3_bytes_filename.patch</tt> file.</p>
<p><strong>After one month of development, 6 versions of the combined patch, Guido
commited my big change</strong> as the <a class="reference external" href="https://github.com/python/cpython/commit/f0af3e30db9475ab68bcb1f1ce0b5581e214df76">commit f0af3e30</a>:</p>
<pre class="literal-block">
commit f0af3e30db9475ab68bcb1f1ce0b5581e214df76
Author: Guido van Rossum &lt;guido&#64;python.org&gt;
Date:   Thu Oct 2 18:55:37 2008 +0000

    Issue #3187: Better support for &quot;undecodable&quot; filenames.  Code by Victor
    Stinner, with small tweaks by GvR.

 Lib/fnmatch.py                |  27 ++++---
 Lib/genericpath.py            |   5 +-
 Lib/glob.py                   |  17 +++--
 Lib/io.py                     |  15 ++--
 Lib/posixpath.py              | 171 +++++++++++++++++++++++++++++++-----------
 Lib/test/test_fnmatch.py      |   9 +++
 Lib/test/test_posix.py        |   2 +-
 Lib/test/test_posixpath.py    | 150 ++++++++++++++++++++++++++++++++----
 Lib/test/test_unicode_file.py |   6 +-
 Misc/NEWS                     |  10 ++-
 Modules/posixmodule.c         |  90 +++++++++-------------
 11 files changed, 358 insertions(+), 144 deletions(-)
</pre>
<p>My change:</p>
<ul class="simple">
<li>Modify <tt class="docutils literal">os.listdir(str)</tt> to <strong>ignore silently undecodable filenames</strong>,
instead of returning them as <tt class="docutils literal">bytes</tt></li>
<li>Add <tt class="docutils literal">os.getcwdb()</tt> function: similar to <tt class="docutils literal">os.getcwd()</tt> but returns the
current working directory as <tt class="docutils literal">bytes</tt>.</li>
<li>Support <tt class="docutils literal">bytes</tt> paths:<ul>
<li><tt class="docutils literal">fnmatch.filter()</tt></li>
<li><tt class="docutils literal">glob.glob1()</tt></li>
<li><tt class="docutils literal">glob.iglob()</tt></li>
<li><tt class="docutils literal">open()</tt></li>
<li><tt class="docutils literal">os.path.isabs()</tt></li>
<li><tt class="docutils literal">os.path.issep()</tt></li>
<li><tt class="docutils literal">os.path.join()</tt></li>
<li><tt class="docutils literal">os.path.split()</tt></li>
<li><tt class="docutils literal">os.path.splitext()</tt></li>
<li><tt class="docutils literal">os.path.basename()</tt></li>
<li><tt class="docutils literal">os.path.dirname()</tt></li>
<li><tt class="docutils literal">os.path.splitdrive()</tt></li>
<li><tt class="docutils literal">os.path.ismount()</tt></li>
<li><tt class="docutils literal">os.path.expanduser()</tt></li>
<li><tt class="docutils literal">os.path.expandvars()</tt></li>
<li><tt class="docutils literal">os.path.normpath()</tt></li>
<li><tt class="docutils literal">os.path.abspath()</tt></li>
<li><tt class="docutils literal">os.path.realpath()</tt></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="more-bytes-patches">
<h2>More bytes patches</h2>
<p>I looked if other functions accepted passing filenames as <tt class="docutils literal">bytes</tt> and... I
was disappointed. It took me some years to fix the full Python standard
library. Example of issues between 2008 and 2010:</p>
<ul class="simple">
<li><a class="reference external" href="https://bugs.python.org/issue4035">bpo-4035</a>: Support bytes in <tt class="docutils literal"><span class="pre">os.exec*()</span></tt></li>
<li><a class="reference external" href="https://bugs.python.org/issue4036">bpo-4036</a>: Support bytes in <tt class="docutils literal">subprocess.Popen()</tt></li>
<li><a class="reference external" href="https://bugs.python.org/issue8513">bpo-8513</a>: <tt class="docutils literal">subprocess</tt>: support bytes program name (POSIX)</li>
<li><a class="reference external" href="https://bugs.python.org/issue8514">bpo-8514</a>: Add <tt class="docutils literal">fsencode()</tt> functions to os module</li>
<li><a class="reference external" href="https://bugs.python.org/issue8603">bpo-8603</a>: Create a bytes version of <tt class="docutils literal">os.environ</tt> and <tt class="docutils literal">getenvb()</tt> -- Add <tt class="docutils literal">os.environb</tt></li>
<li><a class="reference external" href="https://bugs.python.org/issue8412">bpo-8412</a>: <tt class="docutils literal">os.system()</tt> doesn't support surrogates nor bytes</li>
<li><a class="reference external" href="https://bugs.python.org/issue8468">bpo-8468</a>: <tt class="docutils literal">bz2</tt> module: support surrogates in filename, and bytes/bytearray filename</li>
<li><a class="reference external" href="https://bugs.python.org/issue8477">bpo-8477</a>: <tt class="docutils literal">ssl</tt> module: support surrogates in filenames, and bytes/bytearray filenames</li>
<li><a class="reference external" href="https://bugs.python.org/issue8640">bpo-8640</a>: <tt class="docutils literal">subprocess:</tt> canonicalize env to bytes on Unix (Python3)</li>
<li><a class="reference external" href="https://bugs.python.org/issue8776">bpo-8776</a>: Bytes version of <tt class="docutils literal">sys.argv</tt> (REJECTED)</li>
</ul>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>At the first look, <strong>Helmut Jarausch</strong>'s <tt class="docutils literal">os.walk()</tt> bug looked trivial to
fix.</p>
<p>I proposed a <strong>new Filename class</strong> storing filenames as <tt class="docutils literal">bytes</tt> and <tt class="docutils literal">str</tt>,
but Guido van Rossum rejected the idea because this API complification
would <em>hinder most people</em>.</p>
<p>Guido van Rossum proposed to <strong>use the replace error handler</strong>, but decoded
filenames were not recognized by the operating system making them useless for
most cases.</p>
<p>I proposed to <strong>use callback to handle undecodable filenames</strong>, but Guido van
Rossum also rejected this idea because it was too complex and could be written
using os.listdir() with a bytes argument.</p>
<p>Benjamin Peterson proposed to <strong>emit a warning</strong> when a filename cannot be
decoded, but the idea was abandonned because of the warnings filters complexity
to emit the warning multiple times.</p>
<p>I wrote a big change modifying <tt class="docutils literal">os.listdir()</tt> to ignore silently undecodable
filenames, but also modify a lot of functions to also accept filenames as
<tt class="docutils literal">bytes</tt>.  I made further changes the following years to fix the full Python
standard library to accept <tt class="docutils literal">bytes</tt>.</p>
<p>While it &quot;only&quot; took 4 months to fix the <tt class="docutils literal">os.listdir(str)</tt> issue, <strong>this kind
of bugs will keep me busy the next 10 years</strong> (2008-2018)...</p>
<p><strong>This article is the first in a series of articles telling the history and
rationale of the Python 3 Unicode model for the operating system.</strong></p>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (13)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>
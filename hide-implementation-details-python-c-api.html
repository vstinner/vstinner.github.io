<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Hide implementation details from the Python C API — Victor Stinner blog 3</title>
	<meta name="description" content="Title: Hide implementation details from the Python C API; Date: 2020-12-25; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">Hide implementation details from the Python C API</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2020-12-25T22:00:00+01:00" itemprop="datePublished">ven. 25 décembre 2020</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/cpython.html" rel="category">cpython</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/optimization.html" rel="tag">optimization</a>
		</span>
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/cpython.html" rel="tag">cpython</a>
		</span>
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/c-api.html" rel="tag">c-api</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><img alt="My cat attacking the Python C API" src="https://vstinner.github.io/images/pepsie.jpg" />
<p>This article is the history of Python C API discussions over the last 4 years,
and the creation of C API projects: <a class="reference external" href="https://pythoncapi.readthedocs.io/">pythoncapi website</a>, <a class="reference external" href="https://github.com/pythoncapi/pythoncapi_compat">pythoncapi_compat.h header file</a> and <a class="reference external" href="https://hpy.readthedocs.io/">HPy (new clean C API)</a>. More and more people are aware of issues
caused by the C API and are working on solutions.</p>
<p>It took me a lot of iterations to find the right approach to evolve the C API
without breaking too many third-party extension modules. My first ideas were
based on two APIs with an opt-in option somehow. At the end, I decided to fix
directly the default API, and helped maintainers of extension modules to update
their projects for incompatible C API changes.</p>
<p>I wrote a <tt class="docutils literal">pythoncapi_compat.h</tt> header file which adds C API functions of
newer Python to old Python versions up to Python 2.7. I also wrote a
<tt class="docutils literal">upgrade_pythoncapi.py</tt> script to add Python 3.10 support to an extension
module without losing Python 2.7 support: the tool adds <tt class="docutils literal">#include
&quot;pythoncapi_compat.h&quot;</tt>. For example, it replaces <tt class="docutils literal">Py_TYPE(obj) = type</tt>
with <tt class="docutils literal">Py_SET_SIZE(obj, type)</tt>.</p>
<p>The photo: my cat attacking the Python C API.</p>
<div class="section" id="year-2016">
<h2>Year 2016</h2>
<p>Between 2016 and 2017, Larry Hastings worked on removing the GIL in a CPython
fork called &quot;The Gilectomy&quot;. He pushed the first commit in April 2016: <a class="reference external" href="https://github.com/larryhastings/gilectomy/commit/4a1a4ff49e34b9705608cad968f467af161dcf02">Removed
the GIL. Don't merge this!</a>
(&quot;Few programs work now&quot;). At EuroPython 2016, he gave the talk <a class="reference external" href="https://www.youtube.com/watch?v=fgWUwQVoLHo">Larry Hastings
- The Gilectomy</a> where he
explains that the current parallelism bottleneck is the CPython reference
counting which doesn't scale with the number of threads.</p>
<p>It was just another hint telling me that &quot;something&quot; should be done to make the
C API more abstract, move away from implementation details like reference
counting. PyPy also has performance issues with the C API for many years.</p>
</div>
<div class="section" id="year-2017">
<h2>Year 2017</h2>
<div class="section" id="may">
<h3>May</h3>
<p>In 2017, I discussed with Eric Snow who was working on subinterpreters. He had
to modify public structures, especially the <tt class="docutils literal">PyInterpreterState</tt> structure.
He created <tt class="docutils literal">Include/internal/</tt> subdirectory to create a new &quot;internal C API&quot;
which should not be exported. (Later, he moved the <tt class="docutils literal">PyInterpreterState</tt>
structure to the internal C API in Python 3.8.)</p>
<p>I started the discuss C API changes during the Python Language Summit
(PyCon US 2017): <a class="reference external" href="https://github.com/vstinner/conf/raw/master/2017-PyconUS/summit.pdf">&quot;Python performance&quot; slides (PDF)</a>:</p>
<ul class="simple">
<li>Split Include in sub-directories</li>
<li>Move towards a stable ABI by default</li>
</ul>
<p>See also the LWN article: <a class="reference external" href="https://lwn.net/Articles/723752/#723949">Keeping Python competitive</a> by Jake Edge.</p>
</div>
<div class="section" id="july-first-pep-draft">
<h3>July: first PEP draft</h3>
<p>I proposed the first PEP draft to python-ideas:
<a class="reference external" href="https://mail.python.org/archives/list/python-ideas&#64;python.org/thread/6XATDGWK4VBUQPRHCRLKQECTJIPBVNJQ/">PEP: Hide implementation details in the C API</a>.</p>
<p>The idea is to add an opt-in option to distutils to build an extension module
with a new C API, remove implementation details from the new C API, and maybe
later switch to the new C API by default.</p>
</div>
<div class="section" id="september">
<h3>September</h3>
<p>I discussed my C API change ideas at the CPython core dev sprint (at Instagram,
California).  The ideas were liked by most (if not all) core developers who are
fine with a minor performance slowdown (caused by replacing macros with
function calls). I wrote <a class="reference external" href="https://vstinner.github.io/new-python-c-api.html">A New C API for CPython</a> blog post about these
discussions.</p>
</div>
<div class="section" id="november">
<h3>November</h3>
<p>I proposed <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-November/150607.html">Make the stable API-ABI usable</a> on
the python-dev list. The idea is to add <tt class="docutils literal">PyTuple_GET_ITEM()</tt> (for example) to
the limited C API but declared as a function call. Later, if enough extension
modules are compatible with the extended limited C API, make it the default.</p>
</div>
</div>
<div class="section" id="year-2018">
<h2>Year 2018</h2>
<p>In July, I created the <a class="reference external" href="https://pythoncapi.readthedocs.io/">pythoncapi website</a> to collect issues of the current C
API, list things to avoid in new functions like borrowed references, and start
to design a new better C API.</p>
<p>In September, Antonio Cuni wrote <a class="reference external" href="https://morepypy.blogspot.com/2018/09/inside-cpyext-why-emulating-cpython-c.html">Inside cpyext: Why emulating CPython C API is
so Hard</a>
article.</p>
</div>
<div class="section" id="year-2019">
<h2>Year 2019</h2>
<p>In February, I sent <a class="reference external" href="https://mail.python.org/archives/list/capi-sig&#64;python.org/thread/WS6ATJWRUQZESGGYP3CCSVPF7OMPMNM6/">Update on CPython header files reorganization</a>
to the capi-sig list.</p>
<ul class="simple">
<li><tt class="docutils literal">Include/</tt>: limited C API</li>
<li><tt class="docutils literal">Include/cpython/</tt>: CPython C API</li>
<li><tt class="docutils literal">Include/internal/</tt>: CPython internal C API</li>
</ul>
<p>In March, I modified the Python debug build to make its ABI compatible with the
release build ABI:
<a class="reference external" href="https://docs.python.org/dev/whatsnew/3.8.html#debug-build-uses-the-same-abi-as-release-build">What’s New In Python 3.8: Debug build uses the same ABI as release build</a>.</p>
<p>In May, I gave a lightning talk <a class="reference external" href="https://github.com/vstinner/conf/blob/master/2019-Pycon/status_stable_api_abi.pdf">Status of the stable API and ABI in Python 3.8</a>,
at the Language Summit (during Pycon US 2019):</p>
<ul class="simple">
<li>Convert macros to static inline functions</li>
<li>Install the internal C API</li>
<li>Debug build now ABI compatible with the release build ABI</li>
<li>Getting rid of global variables</li>
</ul>
<p>By the way, see my <a class="reference external" href="https://vstinner.github.io/split-include-directory-python38.html">Split Include/ directory in Python 3.8</a> article: I converted many macros in
Python 3.8.</p>
<p>In July, the <a class="reference external" href="https://hpy.readthedocs.io/">HPy project</a> was created during
EuroPython at Basel. There was an informal meeting which included core
developers of PyPy (Antonio, Armin and Ronan), CPython (Victor Stinner and Mark
Shannon) and Cython (Stefan Behnel).</p>
<p>In December, Antonio, Armin and Ronan had a small internal sprint to kick-off
the development of HPy: <a class="reference external" href="https://morepypy.blogspot.com/2019/12/hpy-kick-off-sprint-report.html">HPy kick-off sprint report</a></p>
</div>
<div class="section" id="year-2020">
<h2>Year 2020</h2>
<div class="section" id="april">
<h3>April</h3>
<p>I proposed <a class="reference external" href="https://mail.python.org/archives/list/python-dev&#64;python.org/thread/HKM774XKU7DPJNLUTYHUB5U6VR6EQMJF/#TKHNENOXP6H34E73XGFOL2KKXSM4Z6T2">PEP: Modify the C API to hide implementation details</a>
on the python-dev list. The main idea is to provide a new optimized Python
runtime which is backward incompatible on purpose, and continue to ship the
regular runtime which is fully backward compatible.</p>
</div>
<div class="section" id="june">
<h3>June</h3>
<p>I wrote <a class="reference external" href="https://www.python.org/dev/peps/pep-0620/">PEP 620 -- Hide implementation details from the C API</a> and <a class="reference external" href="https://mail.python.org/archives/list/python-dev&#64;python.org/thread/HKM774XKU7DPJNLUTYHUB5U6VR6EQMJF/">proposed the PEP to
python-dev</a>.
This PEP is my 3rd attempt to fix the C API: I rewrote it from scratch. Python
now distributes a new <tt class="docutils literal">pythoncapi_compat.h</tt> header and a process is defined
to reduce the number of broken C extensions when introducing C API incompatible
changes listed in this PEP.</p>
<p>I created the <a class="reference external" href="https://github.com/pythoncapi/pythoncapi_compat">pythoncapi_compat project</a>: header file providing new
C API functions to old Python versions using static inline functions.</p>
</div>
<div class="section" id="december">
<h3>December</h3>
<p>I wrote a new <tt class="docutils literal">upgrade_pythoncapi.py</tt> script to add Python 3.10
support to an extension module without losing support with Python 2.7.  I sent
<a class="reference external" href="https://mail.python.org/archives/list/capi-sig&#64;python.org/thread/LFLXFMKMZ77UCDUFD5EQCONSAFFWJWOZ/">New script: add Python 3.10 support to your C extensions without losing Python
3.6 support</a>
to the capi-sig list.</p>
<p>The pythoncapi_compat project got its first users (bitarray, immutables,
python-zstandard)! It proves that the project is useful and needed.</p>
<p>I collaborated with the HPy project to create a manifesto explaining how the C
API prevents to optimize CPython and makes the CPython C API inefficient on
PyPy. It is still a draft.</p>
</div>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (19)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Graphics bugs in Firefox and GNOME — Victor Stinner blog 3</title>
	<meta name="description" content="Title: Graphics bugs in Firefox and GNOME; Date: 2019-10-10; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">Graphics bugs in Firefox and GNOME</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2019-10-10T17:00:00+02:00" itemprop="datePublished">jeu. 10 octobre 2019</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/linux.html" rel="category">linux</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/linux.html" rel="tag">linux</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>After explaining how to <a class="reference external" href="https://vstinner.github.io/debug-hybrid-graphics-issues-linux.html">Debug Hybrid Graphics issues on Linux</a>, here is the story of four graphics bugs
that I had in GNOME and Firefox on my Fedora 30 between May 2018 and September
2019: bugs in gnome-shell, Gtk, Firefox and mutter.</p>
<a class="reference external image-reference" href="https://www.flickr.com/photos/34298393&#64;N06/14488759356/"><img alt="Glitch" src="https://vstinner.github.io/images/glitch.jpg" /></a>
<div class="section" id="gnome-shell-freezes">
<h2>gnome-shell freezes</h2>
<p>In May 2018, six months after I got my Lenovo P50 laptop, gnome-shell was
&quot;sometimes&quot; freezing between 1 and 5 seconds. It was annoying because key
stokes created repeated keys writing &quot;helloooooooooooooooooooooo&quot; instead of
&quot;hello&quot; for example.</p>
<p>My colleagues led my to <tt class="docutils literal"><span class="pre">#fedora-desktop</span></tt> of the GIMP IRC server where I met
my colleague <strong>Jonas Ådahl</strong> (jadahl) who almost immediately identified my
issue! Extract of the IRC chat:</p>
<pre class="literal-block">
15:03 &lt;vstinner&gt; hello. i upgraded from F27 to F28, and it seems like I
    switched from Xorg to Wayland. sometimes, the desktop hangs a few
    milliseconds (less than 2 secondes)
15:03 &lt;vstinner&gt; bentiss told me that  &quot;libinput error: client bug: timer
    event7 keyboard: offset negative (-39ms)&quot; can occur when shell is too
    slow
15:04 &lt;vstinner&gt; journalctl shows me frenquently the bug
    https://gitlab.gnome.org/GNOME/gnome-shell/issues/1 &quot;Object
    Shell.GenericContainer (0x559e6bfddc60), has been already finalized.
    Impossible to get any property from it.&quot;
15:04 &lt;vstinner&gt; i also get &quot;Window manager warning: last_user_time
    (3093467) is greater than comparison timestamp (3093466).  This most
    likely represents a buggy client sending inaccurate timestamps in
    messages such as _NET_ACTIVE_WINDOW.  Trying to work around...&quot; errors
    in logs (from shell)
15:05 &lt;vstinner&gt; bentiss: ah, i also get &quot;libinput error: client bug: timer
    event7 trackpoint: offset negative (-352ms)&quot; errors
15:06 &lt;vstinner&gt; it's a recent laptop, Lenovo P50: 32 GB of RAM, 4 physical
    CPUs (8 threads) Intel(R) Core(TM) i7-6820HQ CPU &#64; 2.70GHz
15:06 &lt;vstinner&gt; so. what can i do to debug such performance issue? may it
    come from shell? what does it mean if shell is slow? can it be a GPU
    issue?  a javascript issue?
...
15:13 &lt;jadahl&gt; vstinner: whats your hardware? Do you have a hybrid gpu
    system?
15:13 &lt;jadahl&gt; ah, yes P50
15:14 &lt;jadahl&gt; vstinner: there is a branch on mutter upstream that fixes
    that issue. want to compile it to test?
</pre>
<p>Ten minutes after I asked my question, Jonas asked the right question: <strong>Do you
have a hybrid gpu system?</strong></p>
<p>I was able to workaround the issue by connecting my laptop to my TV using the
HDMI port:</p>
<pre class="literal-block">
15:22 &lt; jadahl&gt; for example, IIRC if you have a monitor connected to the
    HDMI, the issue will go away since the secondary GPU is always awake
    anyway
...
15:31 &lt; vstinner&gt; jadahl: i plugged a HDMI cable to my TV and it seems like
    the issue is gone
15:31 &lt; vstinner&gt; jadahl: impressive
</pre>
<p>When an external monitor is used (like a TV plugged on the HDMI port), my
NVIDIA GPU is always active which works around the bug I had in gnome-shell.</p>
<p>Jonas provided me a RPM package for Fedora including his work-in-progress fix:
<a class="reference external" href="https://gitlab.gnome.org/GNOME/mutter/merge_requests/106">Upload HW cursor sprite on-demand</a>. I confirmed that
this change fixed my bug. His mutter change has been merged upstream.</p>
</div>
<div class="section" id="firefox-crash-when-selecting-text">
<h2>Firefox crash when selecting text</h2>
<p>In March 2019, Firefox with Wayland crashed on <tt class="docutils literal">wl_abort()</tt> when selecting
more than 4000 characters in a <tt class="docutils literal">&lt;textarea&gt;</tt>. I found the bug in Gmail when
selecting the whole email text to remove it. Pressing <strong>CTRL + A</strong> or
Right-click + Select All <strong>crashed the whole Firefox process!</strong></p>
<p>I reported the bug to Firefox: <a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1539773">Firefox with Wayland crash on wl_abort() when
selecting more than 4000 characters in a &lt;textarea&gt;</a>.</p>
<p>Running gdb in Firefox caused me some troubles since it's a very large binary with
many libraries. I also read <a class="reference external" href="https://cgit.freedesktop.org/wayland/wayland-protocols/tree/unstable/text-input/text-input-unstable-v3.xml#n138">Wayland protocol specifications</a>.
I managed to analyze the bug and so I reported the bug to Gtk as well, <a class="reference external" href="https://gitlab.gnome.org/GNOME/gtk/issues/1783">On
Wayland, notify_surrounding_text() crash on wl_abort() if text is longer than
4000 bytes</a>:</p>
<blockquote>
According to gdb, <tt class="docutils literal">wl_proxy_marshal_array_constructor_versioned()</tt> calls
<tt class="docutils literal">wl_abort()</tt> because the buffer is too short. It seems like
<tt class="docutils literal">wl_buffer_put()</tt> fails with <tt class="docutils literal">E2BIG</tt>.</blockquote>
<p>Quickly, I identified that <strong>my Gtk bug has already been fixed 3 months before
by Carlos Garnacho</strong> (<a class="reference external" href="https://gitlab.gnome.org/GNOME/gtk/merge_requests/438">imwayland: Respect maximum length of 4000 Bytes on
strings being sent</a>)
and <strong>the fix is part of gtk-3.24.3</strong> (&quot;wayland: Respect length limits in text
protocol&quot; says &quot;Overview of Changes in GTK+ 3.24.3&quot;).</p>
<p>I requested to upgrade Gtk in Fedora. But it was not possible since the newer
version changed the theme. I was asked to cherry-pick the fix and that's what I
did: <a class="reference external" href="https://src.fedoraproject.org/rpms/gtk3/pull-request/5">imwayland: Respect maximum length of 4000 Bytes on strings</a>.</p>
<p>My PR was merged and a new package was built. I tested it and confirmed that it
fixed the crash: <a class="reference external" href="ttps://bodhi.fedoraproject.org/updates/FEDORA-2019-d67ec97b0b">FEDORA-2019-d67ec97b0b</a>. Soon, the
package was pushed to the public Fedora package repository.</p>
<p><strong>That's the cool part about open source: if you have the skills to hack the
code, you can fix an annoying which is affecting you!</strong></p>
</div>
<div class="section" id="firefox-wayland-window-partially-or-not-updated-when-switching-between-two-tabs">
<h2>Firefox: [Wayland] Window partially or not updated when switching between two tabs</h2>
<div class="section" id="analyze-the-bug">
<h3>Analyze the bug</h3>
<p>In September 2019, after a large system upgrade (install 6 packages, upgrade
234 packages, remove 5 packages), Firefox started to not update the window
content sometimes when I switched from one tab to another. Example:</p>
<img alt="Firefox bug of window partially updated" src="https://vstinner.github.io/images/firefox_bug_1.jpg" />
<p>It took me a few hours to analyze the bug to be able to produce an useful bug
report.</p>
<p>I followed Fedora's guide <a class="reference external" href="https://fedoraproject.org/wiki/How_to_debug_Firefox_problems">How to debug Firefox problems</a> advices.</p>
<p>First, I tried to <strong>understand which GPU driver is used</strong>. I finished by
blacklisting the nouveau driver in the Linux kernel, to ensure that Firefox was
using my Intel IGP. I still reproduced the bug.</p>
<p>I <strong>disabled all Firefox extensions</strong>: bug reproduced.</p>
<p>Then I created a new Firefox profile and started Firefox in <strong>safe mode</strong>: bug
reproduced.</p>
<p>I tested the latest Firefox binary from mozilla.org (Firefox 69.0): bug
reproduced.</p>
<p>Finally, <strong>I tested Firefox Nightly</strong> from mozilla.org (Firefox 71.0a1): bug
reproduced.</p>
<p>Ok, it was enough data to produce an interesting bug report. I reported
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1580152">[Wayland] Window partially or not updated when switching between two tabs</a> to Firefox.</p>
</div>
<div class="section" id="identify-the-regression-using-fedora-packages">
<h3>Identify the regression using Fedora packages</h3>
<p>Then I looked at <tt class="docutils literal">/var/log/dnf.log</tt> and I tried to identify which package
update could explain the regression.</p>
<p>I downgraded <strong>gtk3</strong>-3.24.11-1.fc30.x86_64 to gtk3.x86_64 3.24.10-1.fc30: bug
reproduced.</p>
<p>I rebooted on oldest available <strong>Linux kernel</strong>, version 5.2.8-200.fc30.x86_64:
bug reproduced. I checked journalctl logs to check which Linux version I was
running whhen the bug was first seen: Linux 5.2.9-200.fc30.x86_64.</p>
<p>I don't know why, but <strong>downgrading Firefox was only my 3rd test</strong>.</p>
<p>I downgraded firefox-69.0-2.fc30.x86_64 to firefox-68.0.2-1.fc30.x86_64: the
bug is gone! Ok, so <strong>the regression comes from the Firefox package</strong>, and it
was introduced between package versions 68.0.2-1.fc30 and 69.0-2.fc30.</p>
<p>On IRC, I met my colleague <strong>Martin Stránský</strong> who package Firefox for Fedora.
He told me that he is aware of my bug and may have a fix for my bug. Great!</p>
<p>Only 9 days later, <strong>Martin Stránský</strong> fix has been merged in Firefox upstream,
released in Firefox Nightly, and a new package has been shipped in Fedora 30!
Thanks Martin for your efficiency!</p>
<p>The final Firefox change is quite large and intrusive: <a class="reference external" href="https://hg.mozilla.org/releases/mozilla-beta/rev/3281a617f22b">[Wayland] Fix rendering
glitches on wayland</a></p>
</div>
</div>
<div class="section" id="xwayland-crash-in-xwl-glamor-gbm-create-pixmap">
<h2>Xwayland crash in xwl_glamor_gbm_create_pixmap()</h2>
<p>In September 2019, while I was debugging the previous Firefox bug, I started my
IRC client hexchat.  Suddently, <strong>Xwayland crashed which closed my whole Gnome
session</strong>!  I was testing various GPU configurations to analyze the Firefox
bug.</p>
<p>ABRT managed to rebuild an useless traceback and identified an existing bug
report. It added my coment to <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1729200#c20">[abrt] xorg-x11-server-Xwayland:
OsLookupColor(): Segmentation fault at address 0x28</a> report.</p>
<p>At July 26, 2019 (1 month before I got the bug), <strong>Olivier Fourdan</strong> added <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1729200#c9">an
interesting comment</a>:</p>
<blockquote>
<tt class="docutils literal">glamor_get_modifiers+0x767</tt> is <tt class="docutils literal">xwl_glamor_gbm_create_pixmap()</tt> so this
is the same as <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1729925">bug 1729925</a> fixed upstream with
<a class="reference external" href="https://gitlab.freedesktop.org/xorg/xserver/merge_requests/242">xwayland: Do not free a NULL GBM bo</a>.</blockquote>
<p>So in fact, my bug was already fixed by <strong>Olivier Fourdan</strong> in Xwayland
upstream, but the fix didn't land into Fedora yet.</p>
</div>
<div class="section" id="thanks">
<h2>Thanks!</h2>
<p>I would like to thank the following developers who fixed my Fedora 30. What a
coincidence, all four are my collagues! It seems like Red Hat is investing in
the Linux desktop :-)</p>
<p><a class="reference external" href="https://blogs.gnome.org/carlosg/">Carlos Garnacho</a> (Red Hat).</p>
<a class="reference external image-reference" href="https://www.flickr.com/photos/183829480&#64;N06/48623543091/in/pool-14662216&#64;N23/"><img alt="Carlos Garnacho" src="https://vstinner.github.io/images/carlos_garnacho.jpg" /></a>
<p><a class="reference external" href="https://gitlab.gnome.org/jadahl">Jonas Ådahl</a> (Red Hat).</p>
<a class="reference external image-reference" href="https://www.flickr.com/photos/183829480&#64;N06/48623189663/in/pool-14662216&#64;N23/"><img alt="Jonas Ådahl" src="https://vstinner.github.io/images/jonas_adahl.jpg" /></a>
<p><a class="reference external" href="http://people.redhat.com/stransky/">Martin Stránský</a> (Red Hat).</p>
<a class="reference external image-reference" href="http://people.redhat.com/stransky/"><img alt="Martin Stránský" src="https://vstinner.github.io/images/mstransky.jpg" /></a>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Olivier_Fourdan">Olivier Fourdan</a> (Red Hat).</p>
<a class="reference external image-reference" href="https://en.wikipedia.org/wiki/Olivier_Fourdan"><img alt="Olivier Fourdan" src="https://vstinner.github.io/images/olivier_fourdan.jpg" /></a>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (16)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>
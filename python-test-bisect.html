<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>New Python test.bisect tool â€” Victor Stinner blog 3</title>
	<meta name="description" content="Title: New Python test.bisect tool; Date: 2017-07-12; Author: Victor Stinner">
	<meta name="author" content="Victor Stinner">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://vstinner.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://vstinner.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://vstinner.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://vstinner.github.io/">Victor Stinner blog 3</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">New Python test.bisect tool</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Victor Stinner</h4>
		</span>
		<time datetime="2017-07-12T15:00:00+02:00" itemprop="datePublished">Wed 12 July 2017</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://vstinner.github.io/category/python.html" rel="category">python</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/cpython.html" rel="tag">cpython</a>
		</span>
		<span itemprop="keywords">
			<a href="https://vstinner.github.io/tag/tests.html" rel="tag">tests</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>This article tells the story of the new CPython <tt class="docutils literal">test.bisect</tt> tool to
identify failing tests in the CPython test suite.</p>
<div class="section" id="modify-manually-a-test-file">
<h2>Modify manually a test file</h2>
<p>I am fixing reference leaks since many years. When the test file contains more
than 200 tests and is longer than 5,000 lines, it's just not possible to spot a
reference leak. Each time, I modified the long test file and actually <em>removes</em>
enough code until the file becomes short enough so I can read it.</p>
<p>This method <em>works</em>, but it usually took me 20 to 30 minutes, and so it was
common that I made mistakes... and usually had to restart from the start...</p>
</div>
<div class="section" id="first-failed-attempt">
<h2>First failed attempt</h2>
<p>In october 2014, while fixing <a class="reference external" href="http://bugs.python.org/issue22588#msg228905">yet another reference leak in test_capi</a>, <strong>Xavier de Gaye</strong> was
surprised that I identified quickly the leak and wanted to want how I
proceeded. I explained my method removing code, but I also asked for a tool.</p>
<p>Xavier created bpo-22607 at 2014-10-11 and wrote a patch based on an integer
range to run a subset of tests and did something special on the <tt class="docutils literal">subTest()</tt>
context manager. But <strong>Georg Brandl</strong> wasn't convinced by this approach and...
I forgot this issue.</p>
</div>
<div class="section" id="new-design-list-tests-run-a-subset">
<h2>New design: list tests, run a subset</h2>
<p>During this quarter, I had to fix dozens of reference leaks but also tests
failing with &quot;environment changed&quot;: one test method modified &quot;something&quot;. It
was really painful to identify each time the failing test.</p>
<p>So I created bpo-29512 at 2017-02-09 to ask again the same tool. Technically, I
just wanted to run a subset of tests.</p>
<p>While working on OpenStack, I enjoyed the <tt class="docutils literal">testr</tt> tool, a test runner able to
list tests and to run a subset of tests. <tt class="docutils literal">testr</tt> also provides a bisection
tool to identify a subset of tests enough to reproduce a bug. The subset can
contain more than a single test. Sometimes you need to run two tests
sequentially to trigger a specific bug, and it's usually long and boring to
identify manually these two tests.</p>
<p>I proposed a similar design for my bisection tool. Start by listing all tests,
and then:</p>
<ul class="simple">
<li>create a pure <em>random</em> sample of tests: subset with half the size of the
current test set</li>
<li>If tests still fail, use the subset as the new set. Otherwise, throw the
subset.</li>
<li>Loop until the subset is small enough or the process run longer than 100
iterations.</li>
</ul>
</div>
<div class="section" id="regrtest-list-cases">
<h2>regrtest --list-cases</h2>
<p>To list tests, I created bpo-30523 and wrote a patch for the unittest module.
Modifying unittest didn't work well with doctests and the command line
interface (CLI) didn't work as I wanted. I proposed to modify regrtest instead
of unittest.</p>
<p>I proposed to <strong>Louie Lu</strong> to implement my new idea. I was impressed that he
implemented it so quickly and that it worked so well! I just asked him to not
exclude doctest test cases, since these test cases were working as expected!  I
quickly merged his modified patch which adds the <tt class="docutils literal"><span class="pre">--list-cases</span></tt> option to
regrtest.</p>
<p>Note: regrtest already had a <tt class="docutils literal"><span class="pre">--list-tests</span></tt> which lists test <em>files</em>, whereas
<tt class="docutils literal"><span class="pre">--list-cases</span></tt> lists test <em>methods</em> and doctests.</p>
</div>
<div class="section" id="regrtest-matchfile">
<h2>regrtest --matchfile</h2>
<p>I created bpo-30540 to add a --matchfile option to regrtest. regrtest already
had a --match option, but it was only possible to use the option once, and I
wanted to use a text files for my list of tests.</p>
<p>Again, I was surprised that it was so simple to implement the feature. By the
way, I modified regrtest --match to allow to specific the option multiple
times, to run multiple tests instead of a single one.</p>
</div>
<div class="section" id="new-test-bisect-tool">
<h2>New test.bisect tool</h2>
<p>Since I had the two key features: <tt class="docutils literal">regrtest <span class="pre">--list-cases</span></tt> and <tt class="docutils literal">regrtest
<span class="pre">--matchfile</span></tt>, it became trivial to implement the bisection tool. I wrote a
first prototype. The &quot;prototype&quot; worked much better than expected.</p>
<p>My first version required a text file listing test cases. I modified it to run
automatically the new <tt class="docutils literal"><span class="pre">--list-cases</span></tt> command.</p>
<p>I extended the tool to not only track reference leaks, but also &quot;environment
changed&quot; failures like finding a test which creates a file but doesn't remove
it.</p>
<p>I was asked to add this tool in the Python stdlib, so I added it as
<tt class="docutils literal">Lib/test/bisect.py</tt> to use it with:</p>
<pre class="literal-block">
python3 -m test.bisect ...
</pre>
<p>The test.bisect CLI is similar to the test CLI on purpose.</p>
</div>
<div class="section" id="reference-leak-example">
<h2>Reference leak example</h2>
<p>I modified <tt class="docutils literal">test_access()</tt> of test_os to add manually a reference leak:</p>
<pre class="literal-block">
$ ./python -m test -R 3:3 test_os
(...)
test_os leaked [1, 1, 1] references, sum=3
test_os leaked [1, 1, 1] memory blocks, sum=3
test_os failed in 33 sec
(...)
</pre>
<p>Just replace <tt class="docutils literal"><span class="pre">-m</span> test</tt> with <tt class="docutils literal"><span class="pre">-m</span> test.bisect</tt> in the command, and you get
the guilty method:</p>
<pre class="literal-block">
$ ./python -m test.bisect -R 3:3 test_os
Start bisection with 257 tests
Test arguments: -R 3:3 test_os
Bisection will stop when getting 1 or less tests (-n/--max-tests option), or after 100 iterations (-N/--max-iter option)

[+] Iteration 1: run 128 tests/257

+ /home/haypo/prog/python/master/python -m test --matchfile /tmp/tmpvbraed7h -R 3:3 test_os
(...)
Tests succeeded: skip this subtest, try a new subbset

[+] Iteration 2: run 128 tests/257

+ /home/haypo/prog/python/master/python -m test --matchfile /tmp/tmpcjqtzgfe -R 3:3 test_os
(...)
Tests failed: use this new subtest

[+] Iteration 3: run 64 tests/128
(...)
[+] Iteration 15: run 1 tests/2
(...)

Tests (1):
* test.test_os.FileTests.test_access

Bisection completed in 16 iterations and 0:03:10
</pre>
<p>The <tt class="docutils literal">test.bisect</tt> command found the bug I introduced:
<tt class="docutils literal">test.test_os.FileTests.test_access</tt>.</p>
<p>The command takes a few minutes, but I don't care of its performance as soon as
its fully automated! If you use the <tt class="docutils literal"><span class="pre">-o</span> file</tt> option, each time the tool is
able to reduce the size of the test set, it writes the new list of tests on
disk. So even if the tool crashs or fails to find a single failure test, it
already helps!</p>
<p>I am now very happy that <tt class="docutils literal">test.bisect</tt> works better than I expected. So I
backported it to 2.7, 3.5, 3.6 and master branches, since I want to fix <em>all</em>
buildbot failures on <em>all</em> maintained branches.</p>
</div>
<div class="section" id="environment-changed-example">
<h2>Environment changed example</h2>
<p>While running the previous example, I noticed the following warning:</p>
<pre class="literal-block">
Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
</pre>
<p>Using the new <tt class="docutils literal"><span class="pre">--fail-env-changed</span></tt> option, it is now posible to check which
test of test_os emits such warning:</p>
<pre class="literal-block">
haypo&#64;selma$ ./python -m test.bisect --fail-env-changed -R 3:3 test_os
(...)

Tests (1):
* test.test_os.TestSendfile.test_keywords

Bisection completed in 14 iterations and 0:03:27
</pre>
<p>I never trust anything, so let's confirm the bug:</p>
<pre class="literal-block">
haypo&#64;selma$ ./python -m test --fail-env-changed -R 3:3 test_os -m test.test_os.TestSendfile.test_keywords
Run tests sequentially
0:00:00 load avg: 0.33 [1/1] test_os
Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
beginning 6 repetitions
123456
Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.
Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.Warning -- threading_cleanup() failed to cleanup 0 threads after 3 sec (count: 0, dangling: 2)
.
test_os failed (env changed)

1 test altered the execution environment:
    test_os

Total duration: 21 sec
Tests result: ENV CHANGED
</pre>
<p>Ok right, there is something wrong with test_keywords(). I just opened
the <a class="reference external" href="http://bugs.python.org/issue30908">bpo-30908</a>.</p>
</div>
</div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io">Victor Stinner blog 3</a></li>
							<li><a href="https://vstinner.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://twitter.com/VictorStinner">Follow @VictorStinner on Twitter</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://vstinner.github.io/category/benchmark.html">benchmark (8)</a></li>
							<li><a href="https://vstinner.github.io/category/cpython.html">cpython (23)</a></li>
							<li><a href="https://vstinner.github.io/category/linux.html">linux (2)</a></li>
							<li><a href="https://vstinner.github.io/category/python.html">python (41)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://vstinner.readthedocs.org/">Victor Stinner's Notes</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Victor Stinner 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>